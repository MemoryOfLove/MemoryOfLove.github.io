<!DOCTYPE html><html lang="zh-CN"><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-VNNQ4XB5X6"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-VNNQ4XB5X6")</script><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="blog" href="http://jluyeyu.com/rss.xml"><link rel="alternate" type="application/atom+xml" title="blog" href="http://jluyeyu.com/atom.xml"><link rel="alternate" type="application/json" title="blog" href="http://jluyeyu.com/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="ns3"><link rel="canonical" href="http://jluyeyu.com/ns3/11.ns3%20wifi%E6%A8%A1%E5%9D%97%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"><title>11.ns3 wifi 模块流程源码解析 - ns3 | jluyeyu = blog</title><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/katex@0/dist/katex.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="loading-box"><div class="car"><div class="strike"></div><div class="strike strike2"></div><div class="strike strike3"></div><div class="strike strike4"></div><div class="strike strike5"></div><div class="car-detail spoiler"></div><div class="car-detail back"></div><div class="car-detail center"></div><div class="car-detail center1"></div><div class="car-detail front"></div><div class="car-detail wheel"></div><div class="car-detail wheel wheel2"></div></div><div class="text"><span>Loading</span><span class="dots">...</span></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">11.ns3 wifi 模块流程源码解析</h1><div class="meta"><span class="item" title="创建时间：2022-11-08 14:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2022-11-08T14:00:00+08:00">2022-11-08</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>44k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>40 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">jluyeyu</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/3b386ae3affb92bf1cd0542648e24fc5.jpg"></li><li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/2aabaeb8aca379b991071d1c41632741.jpg"></li><li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/f885d5531d4b21d05f954f61b036adc0.jpg"></li><li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/471188138f7f9597f65d16889f1ade0e.jpg"></li><li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/4c0b0c164bd2511ebcbfec05cd2a7b58.jpg"></li><li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/dfd09dea1d70c93080a0c2bce3143a54.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/ns3/" itemprop="item" rel="index" title="分类于 ns3"><span itemprop="name">ns3</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://jluyeyu.com/ns3/11.ns3%20wifi%E6%A8%A1%E5%9D%97%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="jluyeyu"><meta itemprop="description" content=", "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="blog"></span><div class="body md" itemprop="articleBody"><h2 id="11ns3-wifi模块流程源码解析"><a class="anchor" href="#11ns3-wifi模块流程源码解析">#</a> 11.ns3 wifi 模块流程源码解析</h2><p>在本节中，将从源码的角度解析 <code>ns3</code> 的 <code>wifi</code> 模块，包括一个 <code>packet</code> 是如何从一台主机的 <code>WifiNetDevice</code> 到另一台主机的 <code>WifiNetDevice</code> 。</p><p>PS:</p><ol><li><p>本节很长，而且很枯燥，但是对扩展 <code>ns3</code> 功能，了解 <code>ns3</code> 流程非常有帮助，请耐心观看。</p></li><li><p>本节的源码来自于 <code>ns3.32</code> , 不同版本之间有一些差异，但大致流程差不多，可以互相参考。</p></li></ol><h3 id="发送过程源码分析"><a class="anchor" href="#发送过程源码分析">#</a> 发送过程源码分析</h3><p>首先从发送 <code>packet</code> 开始</p><p><code>src/wifi/model/wifi-net-device.cc</code> ,</p><p><code>WifiNetDevice::send</code> 函数</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">bool</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">WifiNetDevice</span><span class="token double-colon punctuation">::</span><span class="token function">Send</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>Packet<span class="token operator">></span> packet<span class="token punctuation">,</span> <span class="token keyword">const</span> Address<span class="token operator">&amp;</span> dest<span class="token punctuation">,</span> <span class="token keyword">uint16_t</span> protocolNumber<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> packet <span class="token operator">&lt;&lt;</span> dest <span class="token operator">&lt;&lt;</span> protocolNumber<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span><span class="token class-name">Mac48Address</span><span class="token double-colon punctuation">::</span><span class="token function">IsMatchingType</span> <span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  Mac48Address realTo <span class="token operator">=</span> <span class="token class-name">Mac48Address</span><span class="token double-colon punctuation">::</span><span class="token function">ConvertFrom</span> <span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  LlcSnapHeader llc<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  llc<span class="token punctuation">.</span><span class="token function">SetType</span> <span class="token punctuation">(</span>protocolNumber<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  packet<span class="token operator">-></span><span class="token function">AddHeader</span> <span class="token punctuation">(</span>llc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  m_mac<span class="token operator">-></span><span class="token function">NotifyTx</span> <span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  m_mac<span class="token operator">-></span><span class="token function">Enqueue</span> <span class="token punctuation">(</span>packet<span class="token punctuation">,</span> realTo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>m_mac</code> 参数的类型是 <code>Ptr&lt;WifiMac&gt;</code> ， <code>NotifyTx</code> 方法是 <code>Trace</code> 追踪发送的数据包， <code>Enqueue</code> 方法将 <code>packet</code> 加入队列。</p><p>接下来就是 <code>WifiMac::Enqueue</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">Enqueue</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>Packet<span class="token operator">></span> packet<span class="token punctuation">,</span> Mac48Address to<span class="token punctuation">,</span> Mac48Address from<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>这是 <code>WiFiMac::Enqueue</code> 方法的声明，是一个纯虚函数，子类必须实现这个方法。</p><p><code>WiFiMac</code> 的子类有：</p><p><img data-src="http://static.jluyeyu.com/article_images/wifiMac%E7%9A%84%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB.jpg" alt="WifiMac继承关系"></p><p>接下来我们分别看一下这些子类的 <code>Enqueue</code> 分别都做了什么。</p><p><code>RegularWifiMac::Enqueue</code> 期望子类重写该方法，无实质的内容。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">RegularWifiMac</span><span class="token double-colon punctuation">::</span><span class="token function">Enqueue</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>Packet<span class="token operator">></span> packet<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                         Mac48Address to<span class="token punctuation">,</span> Mac48Address from<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token comment">//We expect RegularWifiMac subclasses which do support forwarding (e.g.,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token comment">//AP) to override this method. Therefore, we throw a fatal error if</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token comment">//someone tries to invoke this method on a class which has not done</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token comment">//this.</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token function">NS_FATAL_ERROR</span> <span class="token punctuation">(</span><span class="token string">"This MAC entity ("</span> <span class="token operator">&lt;&lt;</span> <span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">GetAddress</span> <span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                                      <span class="token operator">&lt;&lt;</span> <span class="token string">") does not support Enqueue() with from address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>AdhocWifiMac::Enqueue</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">AdhocWifiMac</span><span class="token double-colon punctuation">::</span><span class="token function">Enqueue</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>Packet<span class="token operator">></span> packet<span class="token punctuation">,</span> Mac48Address to<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">GetQosSupported</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token comment">//Sanity check that the TID is valid</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>tid <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      m_edca<span class="token punctuation">[</span><span class="token function">QosUtilsMapTidToAc</span> <span class="token punctuation">(</span>tid<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">-></span><span class="token function">Queue</span> <span class="token punctuation">(</span>packet<span class="token punctuation">,</span> hdr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      m_txop<span class="token operator">-></span><span class="token function">Queue</span> <span class="token punctuation">(</span>packet<span class="token punctuation">,</span> hdr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>本段最核心的代码已经摘出</p><p>如果网络支持 <code>Qos</code> ，就会进入类 <code>QosTxop</code> 的 <code>Queue</code> 函数；<br>如果不支持 <code>Qos</code> ，就会进入 <code>Txop</code> 类的 <code>Queue</code> 函数。</p><p>而 <code>QosTxop</code> 继承自 <code>Txop</code> ，并且没有重写 <code>Queue</code> 方法</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * \brief Handle packet fragmentation and retransmissions for QoS data frames as well</pre></td></tr><tr><td data-num="3"></td><td><pre> * as MSDU aggregation (A-MSDU) and block ack sessions, for a given access class.</pre></td></tr><tr><td data-num="4"></td><td><pre> * \ingroup wifi</pre></td></tr><tr><td data-num="5"></td><td><pre> *</pre></td></tr><tr><td data-num="6"></td><td><pre> * This class implements the packet fragmentation and retransmission policy for</pre></td></tr><tr><td data-num="7"></td><td><pre> * QoS data frames. It uses the ns3::MacLow and ns3::ChannelAccessManager helper classes</pre></td></tr><tr><td data-num="8"></td><td><pre> * to respectively send packets and decide when to send them. Packets are stored</pre></td></tr><tr><td data-num="9"></td><td><pre> * in a ns3::WifiMacQueue until they can be sent.</pre></td></tr><tr><td data-num="10"></td><td><pre> *</pre></td></tr><tr><td data-num="11"></td><td><pre> * This queue contains packets for a particular access class.</pre></td></tr><tr><td data-num="12"></td><td><pre> * Possibles access classes are:</pre></td></tr><tr><td data-num="13"></td><td><pre> *   - AC_VO : voice, TID = 6,7</pre></td></tr><tr><td data-num="14"></td><td><pre> *   - AC_VI : video, TID = 4,5</pre></td></tr><tr><td data-num="15"></td><td><pre> *   - AC_BE : best-effort, TID = 0,3</pre></td></tr><tr><td data-num="16"></td><td><pre> *   - AC_BK : background, TID = 1,2</pre></td></tr><tr><td data-num="17"></td><td><pre> *</pre></td></tr><tr><td data-num="18"></td><td><pre> * This class also implements block ack sessions and MSDU aggregation (A-MSDU).</pre></td></tr><tr><td data-num="19"></td><td><pre> * If A-MSDU is enabled for that access class, it picks several packets from the</pre></td></tr><tr><td data-num="20"></td><td><pre> * queue instead of a single one and sends the aggregated packet to ns3::MacLow.</pre></td></tr><tr><td data-num="21"></td><td><pre> *</pre></td></tr><tr><td data-num="22"></td><td><pre> * The fragmentation policy currently implemented uses a simple</pre></td></tr><tr><td data-num="23"></td><td><pre> * threshold: any packet bigger than this threshold is fragmented</pre></td></tr><tr><td data-num="24"></td><td><pre> * in fragments whose size is smaller than the threshold.</pre></td></tr><tr><td data-num="25"></td><td><pre> *</pre></td></tr><tr><td data-num="26"></td><td><pre> * The retransmission policy is also very simple: every packet is</pre></td></tr><tr><td data-num="27"></td><td><pre> * retransmitted until it is either successfully transmitted or</pre></td></tr><tr><td data-num="28"></td><td><pre> * it has been retransmitted up until the SSRC or SLRC thresholds.</pre></td></tr><tr><td data-num="29"></td><td><pre> *</pre></td></tr><tr><td data-num="30"></td><td><pre> * The RTS/CTS policy is similar to the fragmentation policy: when</pre></td></tr><tr><td data-num="31"></td><td><pre> * a packet is bigger than a threshold, the RTS/CTS protocol is used.</pre></td></tr><tr><td data-num="32"></td><td><pre> */</pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">QosTxop</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Txop</span></span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>那么接下来就看 <code>Txop::Queue</code> 函数</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Txop</span><span class="token double-colon punctuation">::</span><span class="token function">Queue</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>Packet<span class="token operator">></span> packet<span class="token punctuation">,</span> <span class="token keyword">const</span> WifiMacHeader <span class="token operator">&amp;</span>hdr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> packet <span class="token operator">&lt;&lt;</span> <span class="token operator">&amp;</span>hdr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token comment">// remove the priority tag attached, if any</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  SocketPriorityTag priorityTag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  packet<span class="token operator">-></span><span class="token function">RemovePacketTag</span> <span class="token punctuation">(</span>priorityTag<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_channelAccessManager<span class="token operator">-></span><span class="token function">NeedBackoffUponAccess</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token function">GenerateBackoff</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  m_queue<span class="token operator">-></span><span class="token function">Enqueue</span> <span class="token punctuation">(</span><span class="token generic-function"><span class="token function">Create</span><span class="token generic class-name"><span class="token operator">&lt;</span>WifiMacQueueItem<span class="token operator">></span></span></span> <span class="token punctuation">(</span>packet<span class="token punctuation">,</span> hdr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token function">StartAccessIfNeeded</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>从该方法中可以看出， <code>packet</code> 加入队列， <code>m_queue</code> 的类型为 <code>Ptr&lt;WifiMacQueue&gt;</code> ，功能就是讲 <code>packet</code> 加入队列。 <code>StartAccessIfNeeded ()</code> ; 这一行代码就会判断当前信道空闲与否，随机回退值等。</p><p>接下来就是 <code>Txop::StartAccessIfNeeded</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Txop</span><span class="token double-colon punctuation">::</span><span class="token function">StartAccessIfNeeded</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_currentPacket <span class="token operator">==</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>m_queue<span class="token operator">-></span><span class="token function">IsEmpty</span> <span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">IsAccessRequested</span> <span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>m_low<span class="token operator">-></span><span class="token function">IsCfPeriod</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      m_channelAccessManager<span class="token operator">-></span><span class="token function">RequestAccess</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>m_currentPacket</code> 代表当前正在发送的 <code>packet</code> 。<br><code>m_queue</code> 就是 <code>packet</code> 队列。<br>这里主要就是做了判断，然后请求获取信道权限</p><p>接下来就是 <code>ChannelAccessManager::RequestAccess</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">ChannelAccessManager</span><span class="token double-colon punctuation">::</span><span class="token function">RequestAccess</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>Txop<span class="token operator">></span> txop<span class="token punctuation">,</span> <span class="token keyword">bool</span> isCfPeriod<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> txop<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_phy<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      m_phy<span class="token operator">-></span><span class="token function">NotifyChannelAccessRequested</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token comment">//Deny access if in sleep mode or off</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_sleeping <span class="token operator">||</span> m_off<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>isCfPeriod<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      txop<span class="token operator">-></span><span class="token function">NotifyAccessRequested</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      Time delay <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">MostRecent</span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token function">GetAccessGrantStart</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Now</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Now</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      m_accessTimeout <span class="token operator">=</span> <span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Schedule</span> <span class="token punctuation">(</span>delay<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ChannelAccessManager<span class="token double-colon punctuation">::</span>DoGrantPcfAccess<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> txop<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token comment">/*</span></pre></td></tr><tr><td data-num="22"></td><td><pre>   * EDCAF operations shall be performed at slot boundaries (Sec. 10.22.2.4 of 802.11-2016)</pre></td></tr><tr><td data-num="23"></td><td><pre>   */</pre></td></tr><tr><td data-num="24"></td><td><pre>  Time accessGrantStart <span class="token operator">=</span> <span class="token function">GetAccessGrantStart</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>txop<span class="token operator">-></span><span class="token function">GetAifsn</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">GetSlot</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>txop<span class="token operator">-></span><span class="token function">IsQosTxop</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> txop<span class="token operator">-></span><span class="token function">GetBackoffStart</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> accessGrantStart<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token comment">// The backoff start time reported by the EDCAF is more recent than the last</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      <span class="token comment">// time the medium was busy plus an AIFS, hence we need to align it to the</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token comment">// next slot boundary.</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      Time diff <span class="token operator">=</span> txop<span class="token operator">-></span><span class="token function">GetBackoffStart</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> accessGrantStart<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token keyword">uint32_t</span> nIntSlots <span class="token operator">=</span> <span class="token punctuation">(</span>diff <span class="token operator">/</span> <span class="token function">GetSlot</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetHigh</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      txop<span class="token operator">-></span><span class="token function">UpdateBackoffSlotsNow</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> accessGrantStart <span class="token operator">+</span> <span class="token punctuation">(</span>nIntSlots <span class="token operator">*</span> <span class="token function">GetSlot</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token function">UpdateBackoff</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span><span class="token operator">!</span>txop<span class="token operator">-></span><span class="token function">IsAccessRequested</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  txop<span class="token operator">-></span><span class="token function">NotifyAccessRequested</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token function">DoGrantDcfAccess</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token function">DoRestartAccessTimeoutIfNeeded</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这块的重点是 <code>ChannelAccessManager::DoGrantDcfAccess</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">ChannelAccessManager</span><span class="token double-colon punctuation">::</span><span class="token function">DoGrantDcfAccess</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">uint32_t</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span>Txops<span class="token double-colon punctuation">::</span>iterator i <span class="token operator">=</span> m_txops<span class="token punctuation">.</span><span class="token function">begin</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">!=</span> m_txops<span class="token punctuation">.</span><span class="token function">end</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      Ptr<span class="token operator">&lt;</span>Txop<span class="token operator">></span> txop <span class="token operator">=</span> <span class="token operator">*</span>i<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>txop<span class="token operator">-></span><span class="token function">IsAccessRequested</span> <span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>          <span class="token operator">&amp;&amp;</span> <span class="token function">GetBackoffEndFor</span> <span class="token punctuation">(</span>txop<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Now</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>          <span class="token comment">/**</span></pre></td></tr><tr><td data-num="13"></td><td><pre>           * This is the first Txop we find with an expired backoff and which</pre></td></tr><tr><td data-num="14"></td><td><pre>           * needs access to the medium. i.e., it has data to send.</pre></td></tr><tr><td data-num="15"></td><td><pre>           */</pre></td></tr><tr><td data-num="16"></td><td><pre>          <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"dcf "</span> <span class="token operator">&lt;&lt;</span> k <span class="token operator">&lt;&lt;</span> <span class="token string">" needs access. backoff expired. access granted. slots="</span> <span class="token operator">&lt;&lt;</span> txop<span class="token operator">-></span><span class="token function">GetBackoffSlots</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>          i<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">//go to the next item in the list.</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          k<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>          std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Ptr<span class="token operator">&lt;</span>Txop<span class="token operator">></span> <span class="token operator">></span> internalCollisionTxops<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>          <span class="token keyword">for</span> <span class="token punctuation">(</span>Txops<span class="token double-colon punctuation">::</span>iterator j <span class="token operator">=</span> i<span class="token punctuation">;</span> j <span class="token operator">!=</span> m_txops<span class="token punctuation">.</span><span class="token function">end</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">,</span> k<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>              Ptr<span class="token operator">&lt;</span>Txop<span class="token operator">></span> otherTxop <span class="token operator">=</span> <span class="token operator">*</span>j<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>              <span class="token keyword">if</span> <span class="token punctuation">(</span>otherTxop<span class="token operator">-></span><span class="token function">IsAccessRequested</span> <span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                  <span class="token operator">&amp;&amp;</span> <span class="token function">GetBackoffEndFor</span> <span class="token punctuation">(</span>otherTxop<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Now</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                  <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"dcf "</span> <span class="token operator">&lt;&lt;</span> k <span class="token operator">&lt;&lt;</span> <span class="token string">" needs access. backoff expired. internal collision. slots="</span> <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                                otherTxop<span class="token operator">-></span><span class="token function">GetBackoffSlots</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                  <span class="token comment">/**</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                   * all other Txops with a lower priority whose backoff</pre></td></tr><tr><td data-num="30"></td><td><pre>                   * has expired and which needed access to the medium</pre></td></tr><tr><td data-num="31"></td><td><pre>                   * must be notified that we did get an internal collision.</pre></td></tr><tr><td data-num="32"></td><td><pre>                   */</pre></td></tr><tr><td data-num="33"></td><td><pre>                  internalCollisionTxops<span class="token punctuation">.</span><span class="token function">push_back</span> <span class="token punctuation">(</span>otherTxop<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>          <span class="token comment">/**</span></pre></td></tr><tr><td data-num="38"></td><td><pre>           * Now, we notify all of these changes in one go. It is necessary to</pre></td></tr><tr><td data-num="39"></td><td><pre>           * perform first the calculations of which Txops are colliding and then</pre></td></tr><tr><td data-num="40"></td><td><pre>           * only apply the changes because applying the changes through notification</pre></td></tr><tr><td data-num="41"></td><td><pre>           * could change the global state of the manager, and, thus, could change</pre></td></tr><tr><td data-num="42"></td><td><pre>           * the result of the calculations.</pre></td></tr><tr><td data-num="43"></td><td><pre>           */</pre></td></tr><tr><td data-num="44"></td><td><pre>          txop<span class="token operator">-></span><span class="token function">NotifyAccessGranted</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> collidingTxop <span class="token operator">:</span> internalCollisionTxops<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>              collidingTxop<span class="token operator">-></span><span class="token function">NotifyInternalCollision</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>          <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>      i<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在该函数中，请求完权限后又跳回到  <code>Txop:NotifyAccessGranted</code> ;</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Txop</span><span class="token double-colon punctuation">::</span><span class="token function">NotifyAccessGranted</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>m_accessRequested<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  m_accessRequested <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_currentPacket <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>m_queue<span class="token operator">-></span><span class="token function">IsEmpty</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>          <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"queue empty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>          <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      Ptr<span class="token operator">&lt;</span>WifiMacQueueItem<span class="token operator">></span> item <span class="token operator">=</span> m_queue<span class="token operator">-></span><span class="token function">Dequeue</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>item <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      m_currentPacket <span class="token operator">=</span> item<span class="token operator">-></span><span class="token function">GetPacket</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      m_currentHdr <span class="token operator">=</span> item<span class="token operator">-></span><span class="token function">GetHeader</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>m_currentPacket <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token keyword">uint16_t</span> sequence <span class="token operator">=</span> m_txMiddle<span class="token operator">-></span><span class="token function">GetNextSequenceNumberFor</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>m_currentHdr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      m_currentHdr<span class="token punctuation">.</span><span class="token function">SetSequenceNumber</span> <span class="token punctuation">(</span>sequence<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      m_stationManager<span class="token operator">-></span><span class="token function">UpdateFragmentationThreshold</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      m_currentHdr<span class="token punctuation">.</span><span class="token function">SetFragmentNumber</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      m_currentHdr<span class="token punctuation">.</span><span class="token function">SetNoMoreFragments</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      m_currentHdr<span class="token punctuation">.</span><span class="token function">SetNoRetry</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      m_fragmentNumber <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"dequeued size="</span> <span class="token operator">&lt;&lt;</span> m_currentPacket<span class="token operator">-></span><span class="token function">GetSize</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                    <span class="token string">", to="</span> <span class="token operator">&lt;&lt;</span> m_currentHdr<span class="token punctuation">.</span><span class="token function">GetAddr1</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                    <span class="token string">", seq="</span> <span class="token operator">&lt;&lt;</span> m_currentHdr<span class="token punctuation">.</span><span class="token function">GetSequenceControl</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_currentHdr<span class="token punctuation">.</span><span class="token function">GetAddr1</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsGroup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      m_currentParams<span class="token punctuation">.</span><span class="token function">DisableRts</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      m_currentParams<span class="token punctuation">.</span><span class="token function">DisableAck</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      m_currentParams<span class="token punctuation">.</span><span class="token function">DisableNextData</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"tx broadcast"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token function">GetLow</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">StartTransmission</span> <span class="token punctuation">(</span><span class="token generic-function"><span class="token function">Create</span><span class="token generic class-name"><span class="token operator">&lt;</span>WifiMacQueueItem<span class="token operator">></span></span></span> <span class="token punctuation">(</span>m_currentPacket<span class="token punctuation">,</span> m_currentHdr<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                                    m_currentParams<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>      m_currentParams<span class="token punctuation">.</span><span class="token function">EnableAck</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">NeedFragmentation</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>          m_currentParams<span class="token punctuation">.</span><span class="token function">DisableRts</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>          WifiMacHeader hdr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>          Ptr<span class="token operator">&lt;</span>Packet<span class="token operator">></span> fragment <span class="token operator">=</span> <span class="token function">GetFragmentPacket</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>hdr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsLastFragment</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>              <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"fragmenting last fragment size="</span> <span class="token operator">&lt;&lt;</span> fragment<span class="token operator">-></span><span class="token function">GetSize</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>              m_currentParams<span class="token punctuation">.</span><span class="token function">DisableNextData</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>          <span class="token keyword">else</span></pre></td></tr><tr><td data-num="53"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>              <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"fragmenting size="</span> <span class="token operator">&lt;&lt;</span> fragment<span class="token operator">-></span><span class="token function">GetSize</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>              m_currentParams<span class="token punctuation">.</span><span class="token function">EnableNextData</span> <span class="token punctuation">(</span><span class="token function">GetNextFragmentSize</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>          <span class="token function">GetLow</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">StartTransmission</span> <span class="token punctuation">(</span><span class="token generic-function"><span class="token function">Create</span><span class="token generic class-name"><span class="token operator">&lt;</span>WifiMacQueueItem<span class="token operator">></span></span></span> <span class="token punctuation">(</span>fragment<span class="token punctuation">,</span> hdr<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                                        m_currentParams<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>      <span class="token keyword">else</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>          <span class="token keyword">uint32_t</span> size <span class="token operator">=</span> m_currentHdr<span class="token punctuation">.</span><span class="token function">GetSize</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> m_currentPacket<span class="token operator">-></span><span class="token function">GetSize</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> WIFI_MAC_FCS_LENGTH<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>m_stationManager<span class="token operator">-></span><span class="token function">NeedRts</span> <span class="token punctuation">(</span>m_currentHdr<span class="token punctuation">,</span> size<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>m_low<span class="token operator">-></span><span class="token function">IsCfPeriod</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="64"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>              m_currentParams<span class="token punctuation">.</span><span class="token function">EnableRts</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>          <span class="token keyword">else</span></pre></td></tr><tr><td data-num="68"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>              m_currentParams<span class="token punctuation">.</span><span class="token function">DisableRts</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>          m_currentParams<span class="token punctuation">.</span><span class="token function">DisableNextData</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>          <span class="token function">GetLow</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">StartTransmission</span> <span class="token punctuation">(</span><span class="token generic-function"><span class="token function">Create</span><span class="token generic class-name"><span class="token operator">&lt;</span>WifiMacQueueItem<span class="token operator">></span></span></span> <span class="token punctuation">(</span>m_currentPacket<span class="token punctuation">,</span> m_currentHdr<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="73"></td><td><pre>                                        m_currentParams<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>上面的代码会调用 <code>Low ()-&gt;StartTransmission</code> 方法。 <code>Low ()</code> 返回的是 <code>MacLow</code> 类对象。</p><p>所以下一步该调用的是 <code>MacLow::StartTransmission</code> 方法</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">MacLow</span><span class="token double-colon punctuation">::</span><span class="token function">StartTransmission</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>WifiMacQueueItem<span class="token operator">></span> mpdu<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                           MacLowTransmissionParameters params<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                           Ptr<span class="token operator">&lt;</span>Txop<span class="token operator">></span> txop<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>mpdu <span class="token operator">&lt;&lt;</span> params <span class="token operator">&lt;&lt;</span> txop<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_cfAckInfo<span class="token punctuation">.</span>expectCfAck<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_phy<span class="token operator">-></span><span class="token function">IsStateOff</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Cannot start TX because device is OFF"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token comment">/* m_currentPacket is not NULL because someone started</span></pre></td></tr><tr><td data-num="14"></td><td><pre>   * a transmission and was interrupted before one of:</pre></td></tr><tr><td data-num="15"></td><td><pre>   *   - ctsTimeout</pre></td></tr><tr><td data-num="16"></td><td><pre>   *   - sendDataAfterCTS</pre></td></tr><tr><td data-num="17"></td><td><pre>   * expired. This means that one of these timers is still</pre></td></tr><tr><td data-num="18"></td><td><pre>   * running. They are all cancelled below anyway by the</pre></td></tr><tr><td data-num="19"></td><td><pre>   * call to CancelAllEvents (because of at least one</pre></td></tr><tr><td data-num="20"></td><td><pre>   * of these two timers) which will trigger a call to the</pre></td></tr><tr><td data-num="21"></td><td><pre>   * previous listener's cancel method.</pre></td></tr><tr><td data-num="22"></td><td><pre>   *</pre></td></tr><tr><td data-num="23"></td><td><pre>   * This typically happens because the high-priority</pre></td></tr><tr><td data-num="24"></td><td><pre>   * QapScheduler has taken access to the channel from</pre></td></tr><tr><td data-num="25"></td><td><pre>   * one of the EDCA of the QAP.</pre></td></tr><tr><td data-num="26"></td><td><pre>   */</pre></td></tr><tr><td data-num="27"></td><td><pre>  m_currentPacket <span class="token operator">=</span> <span class="token generic-function"><span class="token function">Create</span><span class="token generic class-name"><span class="token operator">&lt;</span>WifiPsdu<span class="token operator">></span></span></span> <span class="token punctuation">(</span>mpdu<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token keyword">const</span> WifiMacHeader<span class="token operator">&amp;</span> hdr <span class="token operator">=</span> mpdu<span class="token operator">-></span><span class="token function">GetHeader</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token function">CancelAllEvents</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  m_currentTxop <span class="token operator">=</span> txop<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  m_txParams <span class="token operator">=</span> params<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>hdr<span class="token punctuation">.</span><span class="token function">IsCtl</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      m_currentTxVector <span class="token operator">=</span> <span class="token function">GetRtsTxVector</span> <span class="token punctuation">(</span>mpdu<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      m_currentTxVector <span class="token operator">=</span> <span class="token function">GetDataTxVector</span> <span class="token punctuation">(</span>mpdu<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token comment">/* The packet received by this function can be any of the following:</span></pre></td></tr><tr><td data-num="42"></td><td><pre>   * (a) a management frame dequeued from the Txop</pre></td></tr><tr><td data-num="43"></td><td><pre>   * (b) a non-QoS data frame dequeued from the Txop</pre></td></tr><tr><td data-num="44"></td><td><pre>   * (c) a non-group addressed QoS Data frame peeked or dequeued from a QosTxop</pre></td></tr><tr><td data-num="45"></td><td><pre>   * (d) a group addressed QoS data or DELBA Request frame dequeued from a QosTxop</pre></td></tr><tr><td data-num="46"></td><td><pre>   * (e) a BlockAckReq or ADDBA Request frame</pre></td></tr><tr><td data-num="47"></td><td><pre>   * (f) a fragment of non-QoS/QoS Data frame dequeued from the Txop/QosTxop</pre></td></tr><tr><td data-num="48"></td><td><pre>   */</pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>hdr<span class="token punctuation">.</span><span class="token function">IsQosData</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>hdr<span class="token punctuation">.</span><span class="token function">GetAddr1</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsGroup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre>      <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>hdr<span class="token punctuation">.</span><span class="token function">IsMoreFragments</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> hdr<span class="token punctuation">.</span><span class="token function">GetFragmentNumber</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>      <span class="token comment">// We get here if the received packet is a non-broadcast QoS data frame</span></pre></td></tr><tr><td data-num="53"></td><td><pre>      <span class="token keyword">uint8_t</span> tid <span class="token operator">=</span> hdr<span class="token punctuation">.</span><span class="token function">GetQosTid</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>      Ptr<span class="token operator">&lt;</span>QosTxop<span class="token operator">></span> qosTxop <span class="token operator">=</span> m_edca<span class="token punctuation">.</span><span class="token function">find</span> <span class="token punctuation">(</span><span class="token function">QosUtilsMapTidToAc</span> <span class="token punctuation">(</span>tid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-></span>second<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>      <span class="token comment">// if a TXOP limit exists, compute the remaining TXOP duration</span></pre></td></tr><tr><td data-num="57"></td><td><pre>      Time txopLimit <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token double-colon punctuation">::</span><span class="token function">Min</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>m_currentTxop<span class="token operator">-></span><span class="token function">GetTxopLimit</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsStrictlyPositive</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>          txopLimit <span class="token operator">=</span> m_currentTxop<span class="token operator">-></span><span class="token function">GetTxopRemaining</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">CalculateOverheadTxTime</span> <span class="token punctuation">(</span>mpdu<span class="token punctuation">,</span> m_txParams<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>          <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>txopLimit<span class="token punctuation">.</span><span class="token function">IsPositive</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>      <span class="token comment">// QosTxop may send us a peeked frame</span></pre></td></tr><tr><td data-num="65"></td><td><pre>      Ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> WifiMacQueueItem<span class="token operator">></span> tmp <span class="token operator">=</span> qosTxop<span class="token operator">-></span><span class="token function">PeekNextFrame</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>      <span class="token keyword">bool</span> isPeeked <span class="token operator">=</span> <span class="token punctuation">(</span>tmp <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> tmp<span class="token operator">-></span><span class="token function">GetPacket</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> mpdu<span class="token operator">-></span><span class="token function">GetPacket</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre>      Ptr<span class="token operator">&lt;</span>WifiMacQueueItem<span class="token operator">></span> newMpdu<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>      <span class="token comment">// If the frame has been peeked, dequeue it if it meets the size and duration constraints</span></pre></td></tr><tr><td data-num="70"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>isPeeked<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>          newMpdu <span class="token operator">=</span> qosTxop<span class="token operator">-></span><span class="token function">DequeuePeekedFrame</span> <span class="token punctuation">(</span>mpdu<span class="token punctuation">,</span> m_currentTxVector<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> txopLimit<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsWithinSizeAndTimeLimits</span> <span class="token punctuation">(</span>mpdu<span class="token punctuation">,</span> m_currentTxVector<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> txopLimit<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>          newMpdu <span class="token operator">=</span> mpdu<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="78"></td><td><pre></pre></td></tr><tr><td data-num="79"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>newMpdu <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="80"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>          <span class="token comment">// if the frame has been dequeued, then there is no BA agreement with the</span></pre></td></tr><tr><td data-num="82"></td><td><pre>          <span class="token comment">// receiver (otherwise the frame would have been peeked). Hence, the frame</span></pre></td></tr><tr><td data-num="83"></td><td><pre>          <span class="token comment">// has been sent under Normal Ack policy, not acknowledged and now retransmitted.</span></pre></td></tr><tr><td data-num="84"></td><td><pre>          <span class="token comment">// If we cannot send it now, let the QosTxop retransmit it again.</span></pre></td></tr><tr><td data-num="85"></td><td><pre>          <span class="token comment">// If the frame has been just peeked, reset the current packet at QosTxop.</span></pre></td></tr><tr><td data-num="86"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>isPeeked<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="87"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>              qosTxop<span class="token operator">-></span><span class="token function">UpdateCurrentPacket</span> <span class="token punctuation">(</span><span class="token generic-function"><span class="token function">Create</span><span class="token generic class-name"><span class="token operator">&lt;</span>WifiMacQueueItem<span class="token operator">></span></span></span> <span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token function">WifiMacHeader</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>          <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>      <span class="token comment">// Update the current packet at QosTxop, given that A-MSDU aggregation may have</span></pre></td></tr><tr><td data-num="93"></td><td><pre>      <span class="token comment">// been performed on the peeked frame</span></pre></td></tr><tr><td data-num="94"></td><td><pre>      qosTxop<span class="token operator">-></span><span class="token function">UpdateCurrentPacket</span> <span class="token punctuation">(</span>newMpdu<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre></pre></td></tr><tr><td data-num="96"></td><td><pre>      <span class="token comment">//Perform MPDU aggregation if possible</span></pre></td></tr><tr><td data-num="97"></td><td><pre>      std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Ptr<span class="token operator">&lt;</span>WifiMacQueueItem<span class="token operator">>></span> mpduList<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>m_mpduAggregator <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="99"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>          mpduList <span class="token operator">=</span> m_mpduAggregator<span class="token operator">-></span><span class="token function">GetNextAmpdu</span> <span class="token punctuation">(</span>newMpdu<span class="token punctuation">,</span> m_currentTxVector<span class="token punctuation">,</span> txopLimit<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="102"></td><td><pre></pre></td></tr><tr><td data-num="103"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>mpduList<span class="token punctuation">.</span><span class="token function">size</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="104"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>          m_currentPacket <span class="token operator">=</span> <span class="token generic-function"><span class="token function">Create</span><span class="token generic class-name"><span class="token operator">&lt;</span>WifiPsdu<span class="token operator">></span></span></span> <span class="token punctuation">(</span>mpduList<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre></pre></td></tr><tr><td data-num="107"></td><td><pre>          <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"tx unicast A-MPDU containing "</span> <span class="token operator">&lt;&lt;</span> mpduList<span class="token punctuation">.</span><span class="token function">size</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" MPDUs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>          qosTxop<span class="token operator">-></span><span class="token function">SetAmpduExist</span> <span class="token punctuation">(</span>hdr<span class="token punctuation">.</span><span class="token function">GetAddr1</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m_currentTxVector<span class="token punctuation">.</span><span class="token function">GetMode</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetModulationClass</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> WIFI_MOD_CLASS_VHT</pre></td></tr><tr><td data-num="111"></td><td><pre>               <span class="token operator">||</span> m_currentTxVector<span class="token punctuation">.</span><span class="token function">GetMode</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetModulationClass</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> WIFI_MOD_CLASS_HE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="112"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="113"></td><td><pre>          <span class="token comment">// VHT/HE single MPDU</span></pre></td></tr><tr><td data-num="114"></td><td><pre>          m_currentPacket <span class="token operator">=</span> <span class="token generic-function"><span class="token function">Create</span><span class="token generic class-name"><span class="token operator">&lt;</span>WifiPsdu<span class="token operator">></span></span></span> <span class="token punctuation">(</span>newMpdu<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="115"></td><td><pre></pre></td></tr><tr><td data-num="116"></td><td><pre>          <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"tx unicast S-MPDU with sequence number "</span> <span class="token operator">&lt;&lt;</span> hdr<span class="token punctuation">.</span><span class="token function">GetSequenceNumber</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>          qosTxop<span class="token operator">-></span><span class="token function">SetAmpduExist</span> <span class="token punctuation">(</span>hdr<span class="token punctuation">.</span><span class="token function">GetAddr1</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>      <span class="token keyword">else</span>  <span class="token comment">// HT</span></pre></td></tr><tr><td data-num="120"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>          m_currentPacket <span class="token operator">=</span> <span class="token generic-function"><span class="token function">Create</span><span class="token generic class-name"><span class="token operator">&lt;</span>WifiPsdu<span class="token operator">></span></span></span> <span class="token punctuation">(</span>newMpdu<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="123"></td><td><pre></pre></td></tr><tr><td data-num="124"></td><td><pre>      <span class="token comment">// A QoS Txop must have an installed ack policy selector</span></pre></td></tr><tr><td data-num="125"></td><td><pre>      <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>qosTxop<span class="token operator">-></span><span class="token function">GetAckPolicySelector</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="126"></td><td><pre>      qosTxop<span class="token operator">-></span><span class="token function">GetAckPolicySelector</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">UpdateTxParams</span> <span class="token punctuation">(</span>m_currentPacket<span class="token punctuation">,</span> m_txParams<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="127"></td><td><pre>      qosTxop<span class="token operator">-></span><span class="token function">GetAckPolicySelector</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">SetAckPolicy</span> <span class="token punctuation">(</span>m_currentPacket<span class="token punctuation">,</span> m_txParams<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="128"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="129"></td><td><pre></pre></td></tr><tr><td data-num="130"></td><td><pre>  <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"startTx size="</span> <span class="token operator">&lt;&lt;</span> m_currentPacket<span class="token operator">-></span><span class="token function">GetSize</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="131"></td><td><pre>                <span class="token string">", to="</span> <span class="token operator">&lt;&lt;</span> m_currentPacket<span class="token operator">-></span><span class="token function">GetAddr1</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">", txop="</span> <span class="token operator">&lt;&lt;</span> m_currentTxop<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="132"></td><td><pre></pre></td></tr><tr><td data-num="133"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_txParams<span class="token punctuation">.</span><span class="token function">MustSendRts</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="134"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="135"></td><td><pre>      <span class="token function">SendRtsForPacket</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="136"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="138"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="139"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m_ctsToSelfSupported <span class="token operator">||</span> m_stationManager<span class="token operator">-></span><span class="token function">GetUseNonErpProtection</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">NeedCtsToSelf</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="140"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="141"></td><td><pre>          <span class="token function">SendCtsToSelf</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="142"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="143"></td><td><pre>      <span class="token keyword">else</span></pre></td></tr><tr><td data-num="144"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="145"></td><td><pre>          <span class="token function">SendDataPacket</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="146"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="147"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="148"></td><td><pre></pre></td></tr><tr><td data-num="149"></td><td><pre>  <span class="token comment">/* When this method completes, either we have taken ownership of the medium or the device switched off in the meantime. */</span></pre></td></tr><tr><td data-num="150"></td><td><pre>  <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>m_phy<span class="token operator">-></span><span class="token function">IsStateTx</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> m_phy<span class="token operator">-></span><span class="token function">IsStateOff</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="151"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>一般情况下，三种发送：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">SendRtsForPacket</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 发送 RTS</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">SendCtsToSelf</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 发送 CTS</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">SendDataPacket</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 发送数据</span></pre></td></tr></table></figure><p><code>RTS/CTS</code> 众所周知，主要看一下 <code>SendDatePacket</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">MacLow</span><span class="token double-colon punctuation">::</span><span class="token function">SendDataPacket</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token function">ForwardDown</span> <span class="token punctuation">(</span>m_currentPacket<span class="token punctuation">,</span> m_currentTxVector<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>MacLow::ForwardDown</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">MacLow</span><span class="token double-colon punctuation">::</span><span class="token function">ForwardDown</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> WifiPsdu<span class="token operator">></span> psdu<span class="token punctuation">,</span> WifiTxVector txVector<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> psdu <span class="token operator">&lt;&lt;</span> txVector<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>psdu<span class="token operator">-></span><span class="token function">GetNMpdus</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">const</span> WifiMacHeader<span class="token operator">&amp;</span> hdr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>psdu<span class="token operator">-></span><span class="token function">begin</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetHeader</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"send "</span> <span class="token operator">&lt;&lt;</span> hdr<span class="token punctuation">.</span><span class="token function">GetTypeString</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                <span class="token string">", to="</span> <span class="token operator">&lt;&lt;</span> hdr<span class="token punctuation">.</span><span class="token function">GetAddr1</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                <span class="token string">", size="</span> <span class="token operator">&lt;&lt;</span> psdu<span class="token operator">-></span><span class="token function">GetSize</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                <span class="token string">", mode="</span> <span class="token operator">&lt;&lt;</span> txVector<span class="token punctuation">.</span><span class="token function">GetMode</span>  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                <span class="token string">", preamble="</span> <span class="token operator">&lt;&lt;</span> txVector<span class="token punctuation">.</span><span class="token function">GetPreambleType</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token string">", duration="</span> <span class="token operator">&lt;&lt;</span> hdr<span class="token punctuation">.</span><span class="token function">GetDuration</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                <span class="token string">", seq=0x"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>hex <span class="token operator">&lt;&lt;</span> hdr<span class="token punctuation">.</span><span class="token function">GetSequenceControl</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>dec<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>hdr<span class="token punctuation">.</span><span class="token function">IsCfPoll</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> m_stationManager<span class="token operator">-></span><span class="token function">GetPcfSupported</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Schedule</span> <span class="token punctuation">(</span><span class="token function">GetPifs</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> m_phy<span class="token operator">-></span><span class="token function">CalculateTxDuration</span> <span class="token punctuation">(</span>psdu<span class="token operator">-></span><span class="token function">GetSize</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> txVector<span class="token punctuation">,</span> m_phy<span class="token operator">-></span><span class="token function">GetPhyBand</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>MacLow<span class="token double-colon punctuation">::</span>CfPollTimeout<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>hdr<span class="token punctuation">.</span><span class="token function">IsBeacon</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> m_stationManager<span class="token operator">-></span><span class="token function">GetPcfSupported</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Now</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> m_lastBeacon <span class="token operator">+</span> m_beaconInterval<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>          m_cfpForeshortening <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Now</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> m_lastBeacon <span class="token operator">-</span> m_beaconInterval<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      m_lastBeacon <span class="token operator">=</span> <span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Now</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>hdr<span class="token punctuation">.</span><span class="token function">IsCfEnd</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> m_stationManager<span class="token operator">-></span><span class="token function">GetPcfSupported</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      m_cfpStart <span class="token operator">=</span> <span class="token function">NanoSeconds</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      m_cfpForeshortening <span class="token operator">=</span> <span class="token function">NanoSeconds</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      m_cfAckInfo<span class="token punctuation">.</span>appendCfAck <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      m_cfAckInfo<span class="token punctuation">.</span>expectCfAck <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsCfPeriod</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> hdr<span class="token punctuation">.</span><span class="token function">HasData</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      m_cfAckInfo<span class="token punctuation">.</span>expectCfAck <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>psdu<span class="token operator">-></span><span class="token function">IsSingle</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>      txVector<span class="token punctuation">.</span><span class="token function">SetAggregation</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>      <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Sending S-MPDU"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>psdu<span class="token operator">-></span><span class="token function">IsAggregate</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>      txVector<span class="token punctuation">.</span><span class="token function">SetAggregation</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>      <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Sending A-MPDU"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>      <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Sending non aggregate MPDU"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> mpdu <span class="token operator">:</span> <span class="token operator">*</span><span class="token function">PeekPointer</span> <span class="token punctuation">(</span>psdu<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>mpdu<span class="token operator">-></span><span class="token function">GetHeader</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsQosData</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>          <span class="token keyword">auto</span> edcaIt <span class="token operator">=</span> m_edca<span class="token punctuation">.</span><span class="token function">find</span> <span class="token punctuation">(</span><span class="token function">QosUtilsMapTidToAc</span> <span class="token punctuation">(</span>mpdu<span class="token operator">-></span><span class="token function">GetHeader</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetQosTid</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>          edcaIt<span class="token operator">-></span>second<span class="token operator">-></span><span class="token function">CompleteMpduTx</span> <span class="token punctuation">(</span>mpdu<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>  m_phy<span class="token operator">-></span><span class="token function">Send</span> <span class="token punctuation">(</span>psdu<span class="token punctuation">,</span> txVector<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>MacLow::ForwardDown</code> 会调用 <code>m_phy</code> 对象的 <code>SendPacket</code> 方法。</p><p><code>m_phy</code> 就是 <code>WifiPhy</code> 类型，代表物理层。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">WifiPhy</span><span class="token double-colon punctuation">::</span><span class="token function">Send</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> WifiPsdu<span class="token operator">></span> psdu<span class="token punctuation">,</span> WifiTxVector txVector<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>psdu <span class="token operator">&lt;&lt;</span> txVector<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token comment">/* Transmission can happen if:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   *  - we are syncing on a packet. It is the responsibility of the</pre></td></tr><tr><td data-num="7"></td><td><pre>   *    MAC layer to avoid doing this but the PHY does nothing to</pre></td></tr><tr><td data-num="8"></td><td><pre>   *    prevent it.</pre></td></tr><tr><td data-num="9"></td><td><pre>   *  - we are idle</pre></td></tr><tr><td data-num="10"></td><td><pre>   */</pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_state<span class="token operator">-></span><span class="token function">IsStateTx</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>m_state<span class="token operator">-></span><span class="token function">IsStateSwitching</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>m_endTxEvent<span class="token punctuation">.</span><span class="token function">IsExpired</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>txVector<span class="token punctuation">.</span><span class="token function">GetNss</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token function">GetMaxSupportedTxSpatialStreams</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token function">NS_FATAL_ERROR</span> <span class="token punctuation">(</span><span class="token string">"Unsupported number of spatial streams!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_state<span class="token operator">-></span><span class="token function">IsStateSleep</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Dropping packet because in sleep mode"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token function">NotifyTxDrop</span> <span class="token punctuation">(</span>psdu<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>  Time txDuration <span class="token operator">=</span> <span class="token function">CalculateTxDuration</span> <span class="token punctuation">(</span>psdu<span class="token operator">-></span><span class="token function">GetSize</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> txVector<span class="token punctuation">,</span> <span class="token function">GetPhyBand</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>txDuration<span class="token punctuation">.</span><span class="token function">IsStrictlyPositive</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m_currentEvent <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>m_currentEvent<span class="token operator">-></span><span class="token function">GetEndTime</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token punctuation">(</span><span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Now</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> m_state<span class="token operator">-></span><span class="token function">GetDelayUntilIdle</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      <span class="token comment">//that packet will be noise _after_ the transmission.</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token function">MaybeCcaBusyDuration</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_currentEvent <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token function">AbortCurrentReception</span> <span class="token punctuation">(</span>RECEPTION_ABORTED_BY_TX<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_powerRestricted<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>      <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Transmitting with power restriction"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>      <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Transmitting without power restriction"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_state<span class="token operator">-></span><span class="token function">GetState</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> WifiPhyState<span class="token double-colon punctuation">::</span>OFF<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>      <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Transmission canceled because device is OFF"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>  <span class="token keyword">double</span> txPowerW <span class="token operator">=</span> <span class="token function">DbmToW</span> <span class="token punctuation">(</span><span class="token function">GetTxPowerForTransmission</span> <span class="token punctuation">(</span>txVector<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">GetTxGain</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>  <span class="token function">NotifyTxBegin</span> <span class="token punctuation">(</span>psdu<span class="token punctuation">,</span> txPowerW<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token function">m_phyTxPsduBeginTrace</span> <span class="token punctuation">(</span>psdu<span class="token punctuation">,</span> txVector<span class="token punctuation">,</span> txPowerW<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>  <span class="token function">NotifyMonitorSniffTx</span> <span class="token punctuation">(</span>psdu<span class="token punctuation">,</span> <span class="token function">GetFrequency</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> txVector<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>  m_state<span class="token operator">-></span><span class="token function">SwitchToTx</span> <span class="token punctuation">(</span>txDuration<span class="token punctuation">,</span> psdu<span class="token operator">-></span><span class="token function">GetPacket</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">GetPowerDbm</span> <span class="token punctuation">(</span>txVector<span class="token punctuation">.</span><span class="token function">GetTxPowerLevel</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> txVector<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre></pre></td></tr><tr><td data-num="62"></td><td><pre>  Ptr<span class="token operator">&lt;</span>WifiPpdu<span class="token operator">></span> ppdu <span class="token operator">=</span> <span class="token generic-function"><span class="token function">Create</span><span class="token generic class-name"><span class="token operator">&lt;</span>WifiPpdu<span class="token operator">></span></span></span> <span class="token punctuation">(</span>psdu<span class="token punctuation">,</span> txVector<span class="token punctuation">,</span> txDuration<span class="token punctuation">,</span> <span class="token function">GetPhyBand</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_wifiRadioEnergyModel <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> m_wifiRadioEnergyModel<span class="token operator">-></span><span class="token function">GetMaximumTimeInState</span> <span class="token punctuation">(</span>WifiPhyState<span class="token double-colon punctuation">::</span>TX<span class="token punctuation">)</span> <span class="token operator">&lt;</span> txDuration<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>      ppdu<span class="token operator">-></span><span class="token function">SetTruncatedTx</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>  m_endTxEvent <span class="token operator">=</span> <span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Schedule</span> <span class="token punctuation">(</span>txDuration<span class="token punctuation">,</span> <span class="token operator">&amp;</span>WifiPhy<span class="token double-colon punctuation">::</span>NotifyTxEnd<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> psdu<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre>  <span class="token function">StartTx</span> <span class="token punctuation">(</span>ppdu<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre>  m_channelAccessRequested <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>  m_powerRestricted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在此函数中调用了 <code>WifiPhy::StartTx</code> 方法，该方法原型如下：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre>   * \param ppdu the PPDU to send</pre></td></tr><tr><td data-num="3"></td><td><pre>   */</pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">StartTx</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>WifiPpdu<span class="token operator">></span> ppdu<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>该函数是个虚函数具体实现是由其子类实现</p><p><img data-src="http://static.jluyeyu.com/article_images/wifiPhy%E7%9A%84%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB.jpg" alt="WifiPhy继承关系"></p><p>因此这里主要看一下 <code>YansWifiPhy</code> 的 <code>StartTx</code> 方法， <code>SpectrumWifiPhy</code> 也类似。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">YansWifiPhy</span><span class="token double-colon punctuation">::</span><span class="token function">StartTx</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>WifiPpdu<span class="token operator">></span> ppdu<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> ppdu<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  WifiTxVector txVector <span class="token operator">=</span> ppdu<span class="token operator">-></span><span class="token function">GetTxVector</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Start transmission: signal power before antenna gain="</span> <span class="token operator">&lt;&lt;</span> <span class="token function">GetPowerDbm</span> <span class="token punctuation">(</span>txVector<span class="token punctuation">.</span><span class="token function">GetTxPowerLevel</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"dBm"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  m_channel<span class="token operator">-></span><span class="token function">Send</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ppdu<span class="token punctuation">,</span> <span class="token function">GetTxPowerForTransmission</span> <span class="token punctuation">(</span>txVector<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">GetTxGain</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span><span class="token function">rtTx</span> <span class="token punctuation">(</span>txParams<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>都是调用 <code>Channel::send</code> 方法，因此对应的就是 <code>YansWifiChannel::Send</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">YansWifiChannel</span><span class="token double-colon punctuation">::</span><span class="token function">Send</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>YansWifiPhy<span class="token operator">></span> sender<span class="token punctuation">,</span> Ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> WifiPpdu<span class="token operator">></span> ppdu<span class="token punctuation">,</span> <span class="token keyword">double</span> txPowerDbm<span class="token punctuation">)</span> <span class="token keyword">const</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> sender <span class="token operator">&lt;&lt;</span> ppdu <span class="token operator">&lt;&lt;</span> txPowerDbm<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  Ptr<span class="token operator">&lt;</span>MobilityModel<span class="token operator">></span> senderMobility <span class="token operator">=</span> sender<span class="token operator">-></span><span class="token function">GetMobility</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>senderMobility <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span>PhyList<span class="token double-colon punctuation">::</span>const_iterator i <span class="token operator">=</span> m_phyList<span class="token punctuation">.</span><span class="token function">begin</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">!=</span> m_phyList<span class="token punctuation">.</span><span class="token function">end</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>sender <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token operator">*</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>          <span class="token comment">//For now don't account for inter channel interference nor channel bonding</span></pre></td></tr><tr><td data-num="12"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>i<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetChannelNumber</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> sender<span class="token operator">-></span><span class="token function">GetChannelNumber</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>              <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>          Ptr<span class="token operator">&lt;</span>MobilityModel<span class="token operator">></span> receiverMobility <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>i<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetMobility</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token generic-function"><span class="token function">GetObject</span><span class="token generic class-name"><span class="token operator">&lt;</span>MobilityModel<span class="token operator">></span></span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          Time delay <span class="token operator">=</span> m_delay<span class="token operator">-></span><span class="token function">GetDelay</span> <span class="token punctuation">(</span>senderMobility<span class="token punctuation">,</span> receiverMobility<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>          <span class="token keyword">double</span> rxPowerDbm <span class="token operator">=</span> m_loss<span class="token operator">-></span><span class="token function">CalcRxPower</span> <span class="token punctuation">(</span>txPowerDbm<span class="token punctuation">,</span> senderMobility<span class="token punctuation">,</span> receiverMobility<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>          <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"propagation: txPower="</span> <span class="token operator">&lt;&lt;</span> txPowerDbm <span class="token operator">&lt;&lt;</span> <span class="token string">"dbm, rxPower="</span> <span class="token operator">&lt;&lt;</span> rxPowerDbm <span class="token operator">&lt;&lt;</span> <span class="token string">"dbm, "</span> <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                        <span class="token string">"distance="</span> <span class="token operator">&lt;&lt;</span> senderMobility<span class="token operator">-></span><span class="token function">GetDistanceFrom</span> <span class="token punctuation">(</span>receiverMobility<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"m, delay="</span> <span class="token operator">&lt;&lt;</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>          Ptr<span class="token operator">&lt;</span>WifiPpdu<span class="token operator">></span> copy <span class="token operator">=</span> <span class="token function">Copy</span> <span class="token punctuation">(</span>ppdu<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>          Ptr<span class="token operator">&lt;</span>NetDevice<span class="token operator">></span> dstNetDevice <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>i<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetDevice</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>          <span class="token keyword">uint32_t</span> dstNode<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>dstNetDevice <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>              dstNode <span class="token operator">=</span> <span class="token number">0xffffffff</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>          <span class="token keyword">else</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>              dstNode <span class="token operator">=</span> dstNetDevice<span class="token operator">-></span><span class="token function">GetNode</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetId</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>          <span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">ScheduleWithContext</span> <span class="token punctuation">(</span>dstNode<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                                          delay<span class="token punctuation">,</span> <span class="token operator">&amp;</span>YansWifiChannel<span class="token double-colon punctuation">::</span>Receive<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                                          <span class="token punctuation">(</span><span class="token operator">*</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> copy<span class="token punctuation">,</span> rxPowerDbm<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在 <code>Send</code> 函数中，主要做了这样三件事</p><ol><li><p>计算时延 <code>delay</code></p></li><li><p>计算信号衰减</p></li><li><p>在 <code>delay</code> 后调用回调函数 <code>YansWifiChannel::Receive</code> 接收数据包。</p></li></ol><p>读到这里已经可以松一口气了，我们的发送过程已经结束了，让我们再回顾一下流程</p><h4 id="发送的流程图"><a class="anchor" href="#发送的流程图">#</a> 发送的流程图</h4><p><img data-src="http://static.jluyeyu.com/article_images/wifi%E6%A8%A1%E5%9D%97%E5%8F%91%E9%80%81%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg" alt="wifi模块发送流程图"></p><p>接下来就是从 <code>Channel</code> 再将数据传回 <code>WifiNetDevice</code> 。</p><h3 id="接收过程源码分析"><a class="anchor" href="#接收过程源码分析">#</a> 接收过程源码分析</h3><p>那么开始的起点，自然也还是从 <code>Channel</code> 的 <code>Recive</code> ，即 <code>YansWifiChannel::Receive</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">YansWifiChannel</span><span class="token double-colon punctuation">::</span><span class="token function">Receive</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>YansWifiPhy<span class="token operator">></span> phy<span class="token punctuation">,</span> Ptr<span class="token operator">&lt;</span>WifiPpdu<span class="token operator">></span> ppdu<span class="token punctuation">,</span> <span class="token keyword">double</span> rxPowerDbm<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span>phy <span class="token operator">&lt;&lt;</span> ppdu <span class="token operator">&lt;&lt;</span> rxPowerDbm<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token comment">// Do no further processing if signal is too weak</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token comment">// Current implementation assumes constant RX power over the PPDU duration</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rxPowerDbm <span class="token operator">+</span> phy<span class="token operator">-></span><span class="token function">GetRxGain</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> phy<span class="token operator">-></span><span class="token function">GetRxSensitivity</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token function">NS_LOG_INFO</span> <span class="token punctuation">(</span><span class="token string">"Received signal too weak to process: "</span> <span class="token operator">&lt;&lt;</span> rxPowerDbm <span class="token operator">&lt;&lt;</span> <span class="token string">" dBm"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  phy<span class="token operator">-></span><span class="token function">StartReceivePreamble</span> <span class="token punctuation">(</span>ppdu<span class="token punctuation">,</span> <span class="token function">DbmToW</span> <span class="token punctuation">(</span>rxPowerDbm <span class="token operator">+</span> phy<span class="token operator">-></span><span class="token function">GetRxGain</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>虽然这里调用的是 <code>YansWifiPhy::StartReceivePreamble</code> ，但是子类中不含该方法，所以实际调用的是</p><p>父类 <code>WifiPhy</code> 的方法</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">WifiPhy</span><span class="token double-colon punctuation">::</span><span class="token function">StartReceivePreamble</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>WifiPpdu<span class="token operator">></span> ppdu<span class="token punctuation">,</span> <span class="token keyword">double</span> rxPowerW<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>ppdu <span class="token operator">&lt;&lt;</span> rxPowerW<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  WifiTxVector txVector <span class="token operator">=</span> ppdu<span class="token operator">-></span><span class="token function">GetTxVector</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  Time rxDuration <span class="token operator">=</span> ppdu<span class="token operator">-></span><span class="token function">GetTxDuration</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  Ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> WifiPsdu<span class="token operator">></span> psdu <span class="token operator">=</span> ppdu<span class="token operator">-></span><span class="token function">GetPsdu</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  Ptr<span class="token operator">&lt;</span>Event<span class="token operator">></span> event <span class="token operator">=</span> m_interference<span class="token punctuation">.</span><span class="token function">Add</span> <span class="token punctuation">(</span>ppdu<span class="token punctuation">,</span> txVector<span class="token punctuation">,</span> rxDuration<span class="token punctuation">,</span> rxPowerW<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  Time endRx <span class="token operator">=</span> <span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Now</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> rxDuration<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_state<span class="token operator">-></span><span class="token function">GetState</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> WifiPhyState<span class="token double-colon punctuation">::</span>OFF<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Cannot start RX because device is OFF"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>endRx <span class="token operator">></span> <span class="token punctuation">(</span><span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Now</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> m_state<span class="token operator">-></span><span class="token function">GetDelayUntilIdle</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>          <span class="token function">MaybeCcaBusyDuration</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ppdu<span class="token operator">-></span><span class="token function">IsTruncatedTx</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Packet reception stopped because transmitter has been switched off"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>endRx <span class="token operator">></span> <span class="token punctuation">(</span><span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Now</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> m_state<span class="token operator">-></span><span class="token function">GetDelayUntilIdle</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>          <span class="token function">MaybeCcaBusyDuration</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>txVector<span class="token punctuation">.</span><span class="token function">GetModeInitialized</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token comment">//If SetRate method was not called above when filling in txVector, this means the PHY does support the rate indicated in PHY SIG headers</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"drop packet because of unsupported RX mode"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token function">NotifyRxDrop</span> <span class="token punctuation">(</span>psdu<span class="token punctuation">,</span> UNSUPPORTED_SETTINGS<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>endRx <span class="token operator">></span> <span class="token punctuation">(</span><span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Now</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> m_state<span class="token operator">-></span><span class="token function">GetDelayUntilIdle</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>          <span class="token function">MaybeCcaBusyDuration</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>m_state<span class="token operator">-></span><span class="token function">GetState</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token keyword">case</span> WifiPhyState<span class="token double-colon punctuation">::</span>SWITCHING<span class="token operator">:</span></pre></td></tr><tr><td data-num="46"></td><td><pre>      <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"drop packet because of channel switching"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>      <span class="token function">NotifyRxDrop</span> <span class="token punctuation">(</span>psdu<span class="token punctuation">,</span> CHANNEL_SWITCHING<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>      <span class="token comment">/*</span></pre></td></tr><tr><td data-num="49"></td><td><pre>       * Packets received on the upcoming channel are added to the event list</pre></td></tr><tr><td data-num="50"></td><td><pre>       * during the switching state. This way the medium can be correctly sensed</pre></td></tr><tr><td data-num="51"></td><td><pre>       * when the device listens to the channel for the first time after the</pre></td></tr><tr><td data-num="52"></td><td><pre>       * switching e.g. after channel switching, the channel may be sensed as</pre></td></tr><tr><td data-num="53"></td><td><pre>       * busy due to other devices' transmissions started before the end of</pre></td></tr><tr><td data-num="54"></td><td><pre>       * the switching.</pre></td></tr><tr><td data-num="55"></td><td><pre>       */</pre></td></tr><tr><td data-num="56"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>endRx <span class="token operator">></span> <span class="token punctuation">(</span><span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Now</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> m_state<span class="token operator">-></span><span class="token function">GetDelayUntilIdle</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>          <span class="token comment">//that packet will be noise _after_ the completion of the channel switching.</span></pre></td></tr><tr><td data-num="59"></td><td><pre>          <span class="token function">MaybeCcaBusyDuration</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token keyword">case</span> WifiPhyState<span class="token double-colon punctuation">::</span>RX<span class="token operator">:</span></pre></td></tr><tr><td data-num="63"></td><td><pre>      <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>m_currentEvent <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>m_frameCaptureModel <span class="token operator">!=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="65"></td><td><pre>          <span class="token operator">&amp;&amp;</span> m_frameCaptureModel<span class="token operator">-></span><span class="token function">IsInCaptureWindow</span> <span class="token punctuation">(</span>m_timeLastPreambleDetected<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="66"></td><td><pre>          <span class="token operator">&amp;&amp;</span> m_frameCaptureModel<span class="token operator">-></span><span class="token function">CaptureNewFrame</span> <span class="token punctuation">(</span>m_currentEvent<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>          <span class="token function">AbortCurrentReception</span> <span class="token punctuation">(</span>FRAME_CAPTURE_PACKET_SWITCH<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>          <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Switch to new packet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>          <span class="token function">StartRx</span> <span class="token punctuation">(</span>event<span class="token punctuation">,</span> rxPowerW<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>      <span class="token keyword">else</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>          <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Drop packet because already in Rx (power="</span> <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>                        rxPowerW <span class="token operator">&lt;&lt;</span> <span class="token string">"W)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>          <span class="token function">NotifyRxDrop</span> <span class="token punctuation">(</span>psdu<span class="token punctuation">,</span> RXING<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>endRx <span class="token operator">></span> <span class="token punctuation">(</span><span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Now</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> m_state<span class="token operator">-></span><span class="token function">GetDelayUntilIdle</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="78"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>              <span class="token comment">//that packet will be noise _after_ the reception of the currently-received packet.</span></pre></td></tr><tr><td data-num="80"></td><td><pre>              <span class="token function">MaybeCcaBusyDuration</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>    <span class="token keyword">case</span> WifiPhyState<span class="token double-colon punctuation">::</span>TX<span class="token operator">:</span></pre></td></tr><tr><td data-num="85"></td><td><pre>      <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Drop packet because already in Tx (power="</span> <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>                    rxPowerW <span class="token operator">&lt;&lt;</span> <span class="token string">"W)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>      <span class="token function">NotifyRxDrop</span> <span class="token punctuation">(</span>psdu<span class="token punctuation">,</span> TXING<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>endRx <span class="token operator">></span> <span class="token punctuation">(</span><span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Now</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> m_state<span class="token operator">-></span><span class="token function">GetDelayUntilIdle</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="89"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>          <span class="token comment">//that packet will be noise _after_ the transmission of the currently-transmitted packet.</span></pre></td></tr><tr><td data-num="91"></td><td><pre>          <span class="token function">MaybeCcaBusyDuration</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    <span class="token keyword">case</span> WifiPhyState<span class="token double-colon punctuation">::</span>CCA_BUSY<span class="token operator">:</span></pre></td></tr><tr><td data-num="95"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>m_currentEvent <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="96"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>m_frameCaptureModel <span class="token operator">!=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="98"></td><td><pre>              <span class="token operator">&amp;&amp;</span> m_frameCaptureModel<span class="token operator">-></span><span class="token function">IsInCaptureWindow</span> <span class="token punctuation">(</span>m_timeLastPreambleDetected<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="99"></td><td><pre>              <span class="token operator">&amp;&amp;</span> m_frameCaptureModel<span class="token operator">-></span><span class="token function">CaptureNewFrame</span> <span class="token punctuation">(</span>m_currentEvent<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="100"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>              <span class="token function">AbortCurrentReception</span> <span class="token punctuation">(</span>FRAME_CAPTURE_PACKET_SWITCH<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>              <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Switch to new packet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>              <span class="token function">StartRx</span> <span class="token punctuation">(</span>event<span class="token punctuation">,</span> rxPowerW<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>          <span class="token keyword">else</span></pre></td></tr><tr><td data-num="106"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>              <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Drop packet because already in Rx (power="</span> <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>                            rxPowerW <span class="token operator">&lt;&lt;</span> <span class="token string">"W)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>              <span class="token function">NotifyRxDrop</span> <span class="token punctuation">(</span>psdu<span class="token punctuation">,</span> RXING<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>              <span class="token keyword">if</span> <span class="token punctuation">(</span>endRx <span class="token operator">></span> <span class="token punctuation">(</span><span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Now</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> m_state<span class="token operator">-></span><span class="token function">GetDelayUntilIdle</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="111"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>                  <span class="token comment">//that packet will be noise _after_ the reception of the currently-received packet.</span></pre></td></tr><tr><td data-num="113"></td><td><pre>                  <span class="token function">MaybeCcaBusyDuration</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>      <span class="token keyword">else</span></pre></td></tr><tr><td data-num="118"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>          <span class="token function">StartRx</span> <span class="token punctuation">(</span>event<span class="token punctuation">,</span> rxPowerW<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>    <span class="token keyword">case</span> WifiPhyState<span class="token double-colon punctuation">::</span>IDLE<span class="token operator">:</span></pre></td></tr><tr><td data-num="123"></td><td><pre>      <span class="token function">StartRx</span> <span class="token punctuation">(</span>event<span class="token punctuation">,</span> rxPowerW<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="125"></td><td><pre>    <span class="token keyword">case</span> WifiPhyState<span class="token double-colon punctuation">::</span>SLEEP<span class="token operator">:</span></pre></td></tr><tr><td data-num="126"></td><td><pre>      <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Drop packet because in sleep mode"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="127"></td><td><pre>      <span class="token function">NotifyRxDrop</span> <span class="token punctuation">(</span>psdu<span class="token punctuation">,</span> SLEEPING<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="128"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>endRx <span class="token operator">></span> <span class="token punctuation">(</span><span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Now</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> m_state<span class="token operator">-></span><span class="token function">GetDelayUntilIdle</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="129"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="130"></td><td><pre>          <span class="token comment">//that packet will be noise _after_ the sleep period.</span></pre></td></tr><tr><td data-num="131"></td><td><pre>          <span class="token function">MaybeCcaBusyDuration</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="132"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="133"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>    <span class="token keyword">default</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="135"></td><td><pre>      <span class="token function">NS_FATAL_ERROR</span> <span class="token punctuation">(</span><span class="token string">"Invalid WifiPhy state."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="136"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="138"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>实际是根据 <code>Phy</code> 的状态采取不同的策略。</p><p>如果此时可以接收的话，下一步是 <code>WifiPhy::StartRx</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">WifiPhy</span><span class="token double-colon punctuation">::</span><span class="token function">StartRx</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>Event<span class="token operator">></span> event<span class="token punctuation">,</span> <span class="token keyword">double</span> rxPowerW<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>event <span class="token operator">&lt;&lt;</span> rxPowerW<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"sync to signal (power="</span> <span class="token operator">&lt;&lt;</span> rxPowerW <span class="token operator">&lt;&lt;</span> <span class="token string">"W)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  m_interference<span class="token punctuation">.</span><span class="token function">NotifyRxStart</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//We need to notify it now so that it starts recording events</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_endPreambleDetectionEvent<span class="token punctuation">.</span><span class="token function">IsRunning</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      Time startOfPreambleDuration <span class="token operator">=</span> <span class="token function">GetPreambleDetectionDuration</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      Time remainingRxDuration <span class="token operator">=</span> event<span class="token operator">-></span><span class="token function">GetDuration</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startOfPreambleDuration<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      m_endPreambleDetectionEvent <span class="token operator">=</span> <span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Schedule</span> <span class="token punctuation">(</span>startOfPreambleDuration<span class="token punctuation">,</span> <span class="token operator">&amp;</span>WifiPhy<span class="token double-colon punctuation">::</span>StartReceiveHeader<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m_frameCaptureModel <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>rxPowerW <span class="token operator">></span> m_currentEvent<span class="token operator">-></span><span class="token function">GetRxPowerW</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Received a stronger signal during preamble detection: drop current packet and switch to new packet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token function">NotifyRxDrop</span> <span class="token punctuation">(</span>m_currentEvent<span class="token operator">-></span><span class="token function">GetPsdu</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> PREAMBLE_DETECTION_PACKET_SWITCH<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      m_interference<span class="token punctuation">.</span><span class="token function">NotifyRxEnd</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      m_endPreambleDetectionEvent<span class="token punctuation">.</span><span class="token function">Cancel</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      m_interference<span class="token punctuation">.</span><span class="token function">NotifyRxStart</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      Time startOfPreambleDuration <span class="token operator">=</span> <span class="token function">GetPreambleDetectionDuration</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      Time remainingRxDuration <span class="token operator">=</span> event<span class="token operator">-></span><span class="token function">GetDuration</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startOfPreambleDuration<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      m_endPreambleDetectionEvent <span class="token operator">=</span> <span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Schedule</span> <span class="token punctuation">(</span>startOfPreambleDuration<span class="token punctuation">,</span> <span class="token operator">&amp;</span>WifiPhy<span class="token double-colon punctuation">::</span>StartReceiveHeader<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Drop packet because RX is already decoding preamble"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      <span class="token function">NotifyRxDrop</span> <span class="token punctuation">(</span>event<span class="token operator">-></span><span class="token function">GetPsdu</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> BUSY_DECODING_PREAMBLE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  m_currentEvent <span class="token operator">=</span> event<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>接下来是 <code>WifiPhy::StartReceiveHeader</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">WifiPhy</span><span class="token double-colon punctuation">::</span><span class="token function">StartReceiveHeader</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>Event<span class="token operator">></span> event<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IsStateRx</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>m_endPhyRxEvent<span class="token punctuation">.</span><span class="token function">IsExpired</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>m_currentEvent <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>event<span class="token operator">-></span><span class="token function">GetStartTime</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> m_currentEvent<span class="token operator">-></span><span class="token function">GetStartTime</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>event<span class="token operator">-></span><span class="token function">GetEndTime</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> m_currentEvent<span class="token operator">-></span><span class="token function">GetEndTime</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>  InterferenceHelper<span class="token double-colon punctuation">::</span>SnrPer snrPer <span class="token operator">=</span> m_interference<span class="token punctuation">.</span><span class="token function">CalculateNonHtPhyHeaderSnrPer</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token keyword">double</span> snr <span class="token operator">=</span> snrPer<span class="token punctuation">.</span>snr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"snr(dB)="</span> <span class="token operator">&lt;&lt;</span> <span class="token function">RatioToDb</span> <span class="token punctuation">(</span>snrPer<span class="token punctuation">.</span>snr<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">", per="</span> <span class="token operator">&lt;&lt;</span> snrPer<span class="token punctuation">.</span>per<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token function">NS_LOG_WARN</span> <span class="token punctuation">(</span><span class="token string">"snr(dB)="</span> <span class="token operator">&lt;&lt;</span> <span class="token function">RatioToDb</span> <span class="token punctuation">(</span>snrPer<span class="token punctuation">.</span>snr<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">", per="</span> <span class="token operator">&lt;&lt;</span> snrPer<span class="token punctuation">.</span>per<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_preambleDetectionModel <span class="token operator">||</span> <span class="token punctuation">(</span>m_preambleDetectionModel<span class="token operator">-></span><span class="token function">IsPreambleDetected</span> <span class="token punctuation">(</span>event<span class="token operator">-></span><span class="token function">GetRxPowerW</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> snr<span class="token punctuation">,</span> m_channelWidth<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token function">NotifyRxBegin</span> <span class="token punctuation">(</span>event<span class="token operator">-></span><span class="token function">GetPsdu</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>      m_timeLastPreambleDetected <span class="token operator">=</span> <span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Now</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      WifiTxVector txVector <span class="token operator">=</span> event<span class="token operator">-></span><span class="token function">GetTxVector</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>txVector<span class="token punctuation">.</span><span class="token function">GetMode</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetModulationClass</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> WIFI_MOD_CLASS_HT<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>txVector<span class="token punctuation">.</span><span class="token function">GetPreambleType</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> WIFI_PREAMBLE_HT_GF<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>          <span class="token comment">//No non-HT PHY header for HT GF</span></pre></td></tr><tr><td data-num="26"></td><td><pre>          Time remainingPreambleHeaderDuration <span class="token operator">=</span> <span class="token function">CalculatePhyPreambleAndHeaderDuration</span> <span class="token punctuation">(</span>txVector<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">GetPreambleDetectionDuration</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>          m_state<span class="token operator">-></span><span class="token function">SwitchMaybeToCcaBusy</span> <span class="token punctuation">(</span>remainingPreambleHeaderDuration<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>          m_endPhyRxEvent <span class="token operator">=</span> <span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Schedule</span> <span class="token punctuation">(</span>remainingPreambleHeaderDuration<span class="token punctuation">,</span> <span class="token operator">&amp;</span>WifiPhy<span class="token double-colon punctuation">::</span>StartReceivePayload<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token keyword">else</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>          <span class="token comment">//Schedule end of non-HT PHY header</span></pre></td></tr><tr><td data-num="33"></td><td><pre>          Time remainingPreambleAndNonHtHeaderDuration <span class="token operator">=</span> <span class="token function">GetPhyPreambleDuration</span> <span class="token punctuation">(</span>txVector<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">GetPhyHeaderDuration</span> <span class="token punctuation">(</span>txVector<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">GetPreambleDetectionDuration</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>          m_state<span class="token operator">-></span><span class="token function">SwitchMaybeToCcaBusy</span> <span class="token punctuation">(</span>remainingPreambleAndNonHtHeaderDuration<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>          m_endPhyRxEvent <span class="token operator">=</span> <span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Schedule</span> <span class="token punctuation">(</span>remainingPreambleAndNonHtHeaderDuration<span class="token punctuation">,</span> <span class="token operator">&amp;</span>WifiPhy<span class="token double-colon punctuation">::</span>ContinueReceiveHeader<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>      <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Drop packet because PHY preamble detection failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>      <span class="token function">NS_LOG_WARN</span> <span class="token punctuation">(</span><span class="token string">"Drop packet because PHY preamble detection failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>      <span class="token function">NotifyRxDrop</span> <span class="token punctuation">(</span>event<span class="token operator">-></span><span class="token function">GetPsdu</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> PREAMBLE_DETECT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>      m_interference<span class="token punctuation">.</span><span class="token function">NotifyRxEnd</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>      m_currentEvent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>      <span class="token comment">// Like CCA-SD, CCA-ED is governed by the 4μs CCA window to flag CCA-BUSY</span></pre></td></tr><tr><td data-num="47"></td><td><pre>      <span class="token comment">// for any received signal greater than the CCA-ED threshold.</span></pre></td></tr><tr><td data-num="48"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token operator">-></span><span class="token function">GetEndTime</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token punctuation">(</span><span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Now</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> m_state<span class="token operator">-></span><span class="token function">GetDelayUntilIdle</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>          <span class="token function">MaybeCcaBusyDuration</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>之后是 <code>WifiPhy::StartReceivePayload</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">WifiPhy</span><span class="token double-colon punctuation">::</span><span class="token function">StartReceivePayload</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>Event<span class="token operator">></span> event<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>m_endPhyRxEvent<span class="token punctuation">.</span><span class="token function">IsExpired</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>m_endRxEvent<span class="token punctuation">.</span><span class="token function">IsExpired</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  WifiTxVector txVector <span class="token operator">=</span> event<span class="token operator">-></span><span class="token function">GetTxVector</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  WifiMode txMode <span class="token operator">=</span> txVector<span class="token punctuation">.</span><span class="token function">GetMode</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">bool</span> canReceivePayload<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>txMode<span class="token punctuation">.</span><span class="token function">GetModulationClass</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> WIFI_MOD_CLASS_HT<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      InterferenceHelper<span class="token double-colon punctuation">::</span>SnrPer snrPer<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      snrPer <span class="token operator">=</span> m_interference<span class="token punctuation">.</span><span class="token function">CalculateHtPhyHeaderSnrPer</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"snr(dB)="</span> <span class="token operator">&lt;&lt;</span> <span class="token function">RatioToDb</span> <span class="token punctuation">(</span>snrPer<span class="token punctuation">.</span>snr<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">", per="</span> <span class="token operator">&lt;&lt;</span> snrPer<span class="token punctuation">.</span>per<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      canReceivePayload <span class="token operator">=</span> <span class="token punctuation">(</span>m_random<span class="token operator">-></span><span class="token function">GetValue</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> snrPer<span class="token punctuation">.</span>per<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token comment">//If we are here, this means non-HT PHY header was already successfully received</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      canReceivePayload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  Time payloadDuration <span class="token operator">=</span> event<span class="token operator">-></span><span class="token function">GetEndTime</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> event<span class="token operator">-></span><span class="token function">GetStartTime</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">CalculatePhyPreambleAndHeaderDuration</span> <span class="token punctuation">(</span>txVector<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>canReceivePayload<span class="token punctuation">)</span> <span class="token comment">//PHY reception succeeded</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>txVector<span class="token punctuation">.</span><span class="token function">GetNss</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token function">GetMaxSupportedRxSpatialStreams</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>          <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Packet reception could not be started because not enough RX antennas"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>          <span class="token function">NotifyRxDrop</span> <span class="token punctuation">(</span>event<span class="token operator">-></span><span class="token function">GetPsdu</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> UNSUPPORTED_SETTINGS<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>txVector<span class="token punctuation">.</span><span class="token function">GetChannelWidth</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>txVector<span class="token punctuation">.</span><span class="token function">GetChannelWidth</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token function">GetChannelWidth</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>          <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Packet reception could not be started because not enough channel width"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>          <span class="token function">NotifyRxDrop</span> <span class="token punctuation">(</span>event<span class="token operator">-></span><span class="token function">GetPsdu</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> UNSUPPORTED_SETTINGS<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IsModeSupported</span> <span class="token punctuation">(</span>txMode<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">IsMcsSupported</span> <span class="token punctuation">(</span>txMode<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>          <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Drop packet because it was sent using an unsupported mode ("</span> <span class="token operator">&lt;&lt;</span> txMode <span class="token operator">&lt;&lt;</span> <span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>          <span class="token function">NotifyRxDrop</span> <span class="token punctuation">(</span>event<span class="token operator">-></span><span class="token function">GetPsdu</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> UNSUPPORTED_SETTINGS<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>      <span class="token keyword">else</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>          m_statusPerMpdu<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token operator">-></span><span class="token function">GetPsdu</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetNMpdus</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>              <span class="token function">ScheduleEndOfMpdus</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>          m_state<span class="token operator">-></span><span class="token function">SwitchToRx</span> <span class="token punctuation">(</span>payloadDuration<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>          m_endRxEvent <span class="token operator">=</span> <span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Schedule</span> <span class="token punctuation">(</span>payloadDuration<span class="token punctuation">,</span> <span class="token operator">&amp;</span>WifiPhy<span class="token double-colon punctuation">::</span>EndReceive<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>          <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Receiving PSDU"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>          <span class="token function">m_phyRxPayloadBeginTrace</span> <span class="token punctuation">(</span>txVector<span class="token punctuation">,</span> payloadDuration<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//this callback (equivalent to PHY-RXSTART primitive) is triggered only if headers have been correctly decoded and that the mode within is supported</span></pre></td></tr><tr><td data-num="51"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>txMode<span class="token punctuation">.</span><span class="token function">GetModulationClass</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> WIFI_MOD_CLASS_HE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>              HePreambleParameters params<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>              params<span class="token punctuation">.</span>rssiW <span class="token operator">=</span> event<span class="token operator">-></span><span class="token function">GetRxPowerW</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>              params<span class="token punctuation">.</span>bssColor <span class="token operator">=</span> event<span class="token operator">-></span><span class="token function">GetTxVector</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetBssColor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>              <span class="token function">NotifyEndOfHePreamble</span> <span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>          <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>  <span class="token keyword">else</span> <span class="token comment">//PHY reception failed</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>      <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Drop packet because HT PHY header reception failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>      <span class="token function">NotifyRxDrop</span> <span class="token punctuation">(</span>event<span class="token operator">-></span><span class="token function">GetPsdu</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SIG_A_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>  m_endRxEvent <span class="token operator">=</span> <span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Schedule</span> <span class="token punctuation">(</span>payloadDuration<span class="token punctuation">,</span> <span class="token operator">&amp;</span>WifiPhy<span class="token double-colon punctuation">::</span>ResetReceive<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>然后结束后调用 <code>WifiPhy::EndReceive</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">WifiPhy</span><span class="token double-colon punctuation">::</span><span class="token function">EndReceive</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>Event<span class="token operator">></span> event<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  Time psduDuration <span class="token operator">=</span> event<span class="token operator">-></span><span class="token function">GetEndTime</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> event<span class="token operator">-></span><span class="token function">GetStartTime</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>event <span class="token operator">&lt;&lt;</span> psduDuration<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span><span class="token function">GetLastRxEndTime</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Now</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>event<span class="token operator">-></span><span class="token function">GetEndTime</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Now</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  Ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> WifiPsdu<span class="token operator">></span> psdu <span class="token operator">=</span> event<span class="token operator">-></span><span class="token function">GetPsdu</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>psdu<span class="token operator">-></span><span class="token function">GetNMpdus</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token comment">//We do not enter here for A-MPDU since this is done in WifiPhy::EndOfMpdu</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">,</span> SignalNoiseDbm<span class="token operator">></span> rxInfo <span class="token operator">=</span> <span class="token function">GetReceptionStatus</span> <span class="token punctuation">(</span>psdu<span class="token punctuation">,</span> event<span class="token punctuation">,</span> <span class="token function">NanoSeconds</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> psduDuration<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      m_signalNoise <span class="token operator">=</span> rxInfo<span class="token punctuation">.</span>second<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      m_statusPerMpdu<span class="token punctuation">.</span><span class="token function">push_back</span> <span class="token punctuation">(</span>rxInfo<span class="token punctuation">.</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token function">NotifyRxEnd</span> <span class="token punctuation">(</span>psdu<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token keyword">double</span> snr <span class="token operator">=</span> m_interference<span class="token punctuation">.</span><span class="token function">CalculateSnr</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">count</span> <span class="token punctuation">(</span>m_statusPerMpdu<span class="token punctuation">.</span><span class="token function">begin</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> m_statusPerMpdu<span class="token punctuation">.</span><span class="token function">end</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token comment">//At least one MPDU has been successfully received</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      WifiTxVector txVector <span class="token operator">=</span> event<span class="token operator">-></span><span class="token function">GetTxVector</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token function">NotifyMonitorSniffRx</span> <span class="token punctuation">(</span>psdu<span class="token punctuation">,</span> <span class="token function">GetFrequency</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> txVector<span class="token punctuation">,</span> m_signalNoise<span class="token punctuation">,</span> m_statusPerMpdu<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      m_state<span class="token operator">-></span><span class="token function">SwitchFromRxEndOk</span> <span class="token punctuation">(</span><span class="token function">Copy</span> <span class="token punctuation">(</span>psdu<span class="token punctuation">)</span><span class="token punctuation">,</span> snr<span class="token punctuation">,</span> txVector<span class="token punctuation">,</span> m_statusPerMpdu<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      m_state<span class="token operator">-></span><span class="token function">SwitchFromRxEndError</span> <span class="token punctuation">(</span><span class="token function">Copy</span> <span class="token punctuation">(</span>psdu<span class="token punctuation">)</span><span class="token punctuation">,</span> snr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>  m_interference<span class="token punctuation">.</span><span class="token function">NotifyRxEnd</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  m_currentEvent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token function">MaybeCcaBusyDuration</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">,</span> SignalNoiseDbm<span class="token operator">></span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token class-name">WifiPhy</span><span class="token double-colon punctuation">::</span><span class="token function">GetReceptionStatus</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> WifiPsdu<span class="token operator">></span> psdu<span class="token punctuation">,</span> Ptr<span class="token operator">&lt;</span>Event<span class="token operator">></span> event<span class="token punctuation">,</span> Time relativeMpduStart<span class="token punctuation">,</span> Time mpduDuration<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>psdu <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>event <span class="token operator">&lt;&lt;</span> relativeMpduStart <span class="token operator">&lt;&lt;</span> mpduDuration<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  InterferenceHelper<span class="token double-colon punctuation">::</span>SnrPer snrPer<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>  snrPer <span class="token operator">=</span> m_interference<span class="token punctuation">.</span><span class="token function">CalculatePayloadSnrPer</span> <span class="token punctuation">(</span>event<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">make_pair</span> <span class="token punctuation">(</span>relativeMpduStart<span class="token punctuation">,</span> relativeMpduStart <span class="token operator">+</span> mpduDuration<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"mode="</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>event<span class="token operator">-></span><span class="token function">GetTxVector</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetMode</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetDataRate</span> <span class="token punctuation">(</span>event<span class="token operator">-></span><span class="token function">GetTxVector</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                <span class="token string">", snr(dB)="</span> <span class="token operator">&lt;&lt;</span> <span class="token function">RatioToDb</span> <span class="token punctuation">(</span>snrPer<span class="token punctuation">.</span>snr<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">", per="</span> <span class="token operator">&lt;&lt;</span> snrPer<span class="token punctuation">.</span>per <span class="token operator">&lt;&lt;</span> <span class="token string">", size="</span> <span class="token operator">&lt;&lt;</span> psdu<span class="token operator">-></span><span class="token function">GetSize</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                <span class="token string">", relativeStart = "</span> <span class="token operator">&lt;&lt;</span> relativeMpduStart<span class="token punctuation">.</span><span class="token function">GetNanoSeconds</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ns, duration = "</span> <span class="token operator">&lt;&lt;</span> mpduDuration<span class="token punctuation">.</span><span class="token function">GetNanoSeconds</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ns"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>  <span class="token comment">// There are two error checks: PER and receive error model check.</span></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token comment">// PER check models is typical for Wi-Fi and is based on signal modulation;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token comment">// Receive error model is optional, if we have an error model and</span></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token comment">// it indicates that the packet is corrupt, drop the packet.</span></pre></td></tr><tr><td data-num="52"></td><td><pre>  SignalNoiseDbm signalNoise<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>  signalNoise<span class="token punctuation">.</span>signal <span class="token operator">=</span> <span class="token function">WToDbm</span> <span class="token punctuation">(</span>event<span class="token operator">-></span><span class="token function">GetRxPowerW</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>  signalNoise<span class="token punctuation">.</span>noise <span class="token operator">=</span> <span class="token function">WToDbm</span> <span class="token punctuation">(</span>event<span class="token operator">-></span><span class="token function">GetRxPowerW</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> snrPer<span class="token punctuation">.</span>snr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_random<span class="token operator">-></span><span class="token function">GetValue</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> snrPer<span class="token punctuation">.</span>per <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>      <span class="token operator">!</span><span class="token punctuation">(</span>m_postReceptionErrorModel <span class="token operator">&amp;&amp;</span> m_postReceptionErrorModel<span class="token operator">-></span><span class="token function">IsCorrupt</span> <span class="token punctuation">(</span>psdu<span class="token operator">-></span><span class="token function">GetPacket</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">Copy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>      <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Reception succeeded: "</span> <span class="token operator">&lt;&lt;</span> psdu<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>      <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token function">make_pair</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> signalNoise<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>      <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Reception failed: "</span> <span class="token operator">&lt;&lt;</span> psdu<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>      <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token function">make_pair</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> signalNoise<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>之后调用 <code>WifiPhyStateHelper::SwitchFromRxEndOk</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">WifiPhyStateHelper</span><span class="token double-colon punctuation">::</span><span class="token function">SwitchFromRxEndOk</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>WifiPsdu<span class="token operator">></span> psdu<span class="token punctuation">,</span> <span class="token keyword">double</span> snr<span class="token punctuation">,</span> WifiTxVector txVector<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> statusPerMpdu<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>psdu <span class="token operator">&lt;&lt;</span> snr <span class="token operator">&lt;&lt;</span> txVector <span class="token operator">&lt;&lt;</span> statusPerMpdu<span class="token punctuation">.</span><span class="token function">size</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                   std<span class="token double-colon punctuation">::</span><span class="token function">all_of</span><span class="token punctuation">(</span>statusPerMpdu<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> statusPerMpdu<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">bool</span> v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> v<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//returns true if all true</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>statusPerMpdu<span class="token punctuation">.</span><span class="token function">size</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>m_endRx <span class="token operator">==</span> <span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Now</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token function">m_rxOkTrace</span> <span class="token punctuation">(</span>psdu<span class="token operator">-></span><span class="token function">GetPacket</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> snr<span class="token punctuation">,</span> txVector<span class="token punctuation">.</span><span class="token function">GetMode</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> txVector<span class="token punctuation">.</span><span class="token function">GetPreambleType</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token function">NotifyRxEndOk</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token function">DoSwitchFromRx</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_rxOkCallback<span class="token punctuation">.</span><span class="token function">IsNull</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token function">m_rxOkCallback</span> <span class="token punctuation">(</span>psdu<span class="token punctuation">,</span> snr<span class="token punctuation">,</span> txVector<span class="token punctuation">,</span> statusPerMpdu<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>其中， <code>m_rxOkCallback</code> 是个回调函数指针，这个指针的值的设置代码如下：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">MacLow</span><span class="token double-colon punctuation">::</span><span class="token function">SetPhy</span> <span class="token punctuation">(</span><span class="token keyword">const</span> Ptr<span class="token operator">&lt;</span>WifiPhy<span class="token operator">></span> phy<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  m_phy <span class="token operator">=</span> phy<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  m_phy<span class="token operator">-></span><span class="token function">TraceConnectWithoutContext</span> <span class="token punctuation">(</span><span class="token string">"PhyRxPayloadBegin"</span><span class="token punctuation">,</span> <span class="token function">MakeCallback</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>MacLow<span class="token double-colon punctuation">::</span>RxStartIndication<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  m_phy<span class="token operator">-></span><span class="token function">SetReceiveOkCallback</span> <span class="token punctuation">(</span><span class="token function">MakeCallback</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>MacLow<span class="token double-colon punctuation">::</span>DeaggregateAmpduAndReceive<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  m_phy<span class="token operator">-></span><span class="token function">SetReceiveErrorCallback</span> <span class="token punctuation">(</span><span class="token function">MakeCallback</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>MacLow<span class="token double-colon punctuation">::</span>ReceiveError<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token function">SetupPhyMacLowListener</span> <span class="token punctuation">(</span>phy<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>因此实际调用的回调函数是 <code>MacLow::DeaggregateAmpduAndReceive</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">MacLow</span><span class="token double-colon punctuation">::</span><span class="token function">DeaggregateAmpduAndReceive</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>WifiPsdu<span class="token operator">></span> psdu<span class="token punctuation">,</span> <span class="token keyword">double</span> rxSnr<span class="token punctuation">,</span> WifiTxVector txVector<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> statusPerMpdu<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">bool</span> normalAck <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token keyword">bool</span> ampduSubframe <span class="token operator">=</span> txVector<span class="token punctuation">.</span><span class="token function">IsAggregation</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//flag indicating the packet belongs to an A-MPDU and is not a VHT/HE single MPDU</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token comment">//statusPerMpdu is empty for intermediate MPDU forwarding.</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token comment">//This function is called also once the PPDU has been fully received by the PHY,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token comment">//in that case statusPerMpdu carries the information about the received MPDUs.</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ampduSubframe <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>statusPerMpdu<span class="token punctuation">.</span><span class="token function">empty</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token comment">//We are here if a S-MPDU is received or if all MPDUs of an A-MPDU have been</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token comment">//received (but have been already forwarded up, so ReceiveOk won't be called)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>psdu<span class="token operator">-></span><span class="token function">IsAggregate</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      ampduSubframe <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token keyword">auto</span> n <span class="token operator">=</span> psdu<span class="token operator">-></span><span class="token function">begin</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token keyword">auto</span> status <span class="token operator">=</span> statusPerMpdu<span class="token punctuation">.</span><span class="token function">begin</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token function">NS_ABORT_MSG_IF</span> <span class="token punctuation">(</span>psdu<span class="token operator">-></span><span class="token function">GetNMpdus</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> statusPerMpdu<span class="token punctuation">.</span><span class="token function">size</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Should have one receive status per MPDU"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>      WifiMacHeader firsthdr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>n<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetHeader</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>firsthdr<span class="token punctuation">.</span><span class="token function">GetAddr1</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> m_self<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>          <span class="token comment">//Iterate over all MPDUs and notify reception only if status OK</span></pre></td></tr><tr><td data-num="24"></td><td><pre>          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> n <span class="token operator">!=</span> psdu<span class="token operator">-></span><span class="token function">end</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>n<span class="token punctuation">,</span> <span class="token operator">++</span>status<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>              firsthdr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>n<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetHeader</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>              <span class="token function">NS_ABORT_MSG_IF</span> <span class="token punctuation">(</span>firsthdr<span class="token punctuation">.</span><span class="token function">GetAddr1</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> m_self<span class="token punctuation">,</span> <span class="token string">"All MPDUs of A-MPDU should have the same destination address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>status<span class="token punctuation">)</span> <span class="token comment">//PER and thus CRC check succeeded</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>psdu<span class="token operator">-></span><span class="token function">IsSingle</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                      <span class="token comment">//If the MPDU is sent as a VHT/HE single MPDU (EOF=1 in A-MPDU subframe header), then the responder sends an Ack.</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                      <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Receive S-MPDU"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                      ampduSubframe <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_sendAckEvent<span class="token punctuation">.</span><span class="token function">IsRunning</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> firsthdr<span class="token punctuation">.</span><span class="token function">IsQosAck</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// Implicit BAR Ack Policy</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                      m_sendAckEvent <span class="token operator">=</span> <span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">Schedule</span> <span class="token punctuation">(</span><span class="token function">GetSifs</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                                                            <span class="token operator">&amp;</span>MacLow<span class="token double-colon punctuation">::</span>SendBlockAckAfterAmpdu<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                                                            firsthdr<span class="token punctuation">.</span><span class="token function">GetQosTid</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                                                            firsthdr<span class="token punctuation">.</span><span class="token function">GetAddr2</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                                                            firsthdr<span class="token punctuation">.</span><span class="token function">GetDuration</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                                                            txVector<span class="token punctuation">,</span> rxSnr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>firsthdr<span class="token punctuation">.</span><span class="token function">IsAck</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> firsthdr<span class="token punctuation">.</span><span class="token function">IsBlockAck</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> firsthdr<span class="token punctuation">.</span><span class="token function">IsBlockAckReq</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                      <span class="token function">ReceiveOk</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> rxSnr<span class="token punctuation">,</span> txVector<span class="token punctuation">,</span> ampduSubframe<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>firsthdr<span class="token punctuation">.</span><span class="token function">IsData</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> firsthdr<span class="token punctuation">.</span><span class="token function">IsQosData</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                      <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Deaggregate packet from "</span> <span class="token operator">&lt;&lt;</span> firsthdr<span class="token punctuation">.</span><span class="token function">GetAddr2</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" with sequence="</span> <span class="token operator">&lt;&lt;</span> firsthdr<span class="token punctuation">.</span><span class="token function">GetSequenceNumber</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                      <span class="token keyword">if</span> <span class="token punctuation">(</span>psdu<span class="token operator">-></span><span class="token function">IsSingle</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                          <span class="token function">ReceiveOk</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> rxSnr<span class="token punctuation">,</span> txVector<span class="token punctuation">,</span> ampduSubframe<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                      <span class="token keyword">if</span> <span class="token punctuation">(</span>firsthdr<span class="token punctuation">.</span><span class="token function">IsQosAck</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                          <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Normal Ack"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                          normalAck <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="64"></td><td><pre>                    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                      <span class="token function">NS_FATAL_ERROR</span> <span class="token punctuation">(</span><span class="token string">"Received A-MPDU with invalid first MPDU type"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre>                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>psdu<span class="token operator">-></span><span class="token function">IsSingle</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="69"></td><td><pre>                    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>                      <span class="token keyword">if</span> <span class="token punctuation">(</span>normalAck<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="71"></td><td><pre>                        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>                          <span class="token comment">//send BlockAck</span></pre></td></tr><tr><td data-num="73"></td><td><pre>                          <span class="token keyword">if</span> <span class="token punctuation">(</span>firsthdr<span class="token punctuation">.</span><span class="token function">IsBlockAckReq</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="74"></td><td><pre>                            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>                              <span class="token function">NS_FATAL_ERROR</span> <span class="token punctuation">(</span><span class="token string">"Sending a BlockAckReq with QosPolicy equal to Normal Ack"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>                            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>                          <span class="token keyword">uint8_t</span> tid <span class="token operator">=</span> firsthdr<span class="token punctuation">.</span><span class="token function">GetQosTid</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>                          AgreementsI it <span class="token operator">=</span> m_bAckAgreements<span class="token punctuation">.</span><span class="token function">find</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">make_pair</span> <span class="token punctuation">(</span>firsthdr<span class="token punctuation">.</span><span class="token function">GetAddr2</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>                          <span class="token keyword">if</span> <span class="token punctuation">(</span>it <span class="token operator">!=</span> m_bAckAgreements<span class="token punctuation">.</span><span class="token function">end</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="80"></td><td><pre>                            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>                              <span class="token comment">/* See section 11.5.3 in IEEE 802.11 for the definition of this timer */</span></pre></td></tr><tr><td data-num="82"></td><td><pre>                              <span class="token function">ResetBlockAckInactivityTimerIfNeeded</span> <span class="token punctuation">(</span>it<span class="token operator">-></span>second<span class="token punctuation">.</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>                              <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"rx A-MPDU/sendImmediateBlockAck from="</span> <span class="token operator">&lt;&lt;</span> firsthdr<span class="token punctuation">.</span><span class="token function">GetAddr2</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>                              <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>m_sendAckEvent<span class="token punctuation">.</span><span class="token function">IsRunning</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>                            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>                          <span class="token keyword">else</span></pre></td></tr><tr><td data-num="87"></td><td><pre>                            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>                              <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"There's not a valid agreement for this block ack request."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>                            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>                        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="97"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>      <span class="token comment">/* An MPDU has been received */</span></pre></td></tr><tr><td data-num="99"></td><td><pre>      <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span><span class="token operator">!</span>psdu<span class="token operator">-></span><span class="token function">IsAggregate</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>      <span class="token function">ReceiveOk</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>psdu<span class="token operator">-></span><span class="token function">begin</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rxSnr<span class="token punctuation">,</span> txVector<span class="token punctuation">,</span> ampduSubframe<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="102"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>ReceiveOk</code> 方法都会进入 <code>rxPacket</code> 标记位置，</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">MacLow</span><span class="token double-colon punctuation">::</span><span class="token function">ReceiveOk</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>WifiMacQueueItem<span class="token operator">></span> mpdu<span class="token punctuation">,</span> <span class="token keyword">double</span> rxSnr<span class="token punctuation">,</span> WifiTxVector txVector<span class="token punctuation">,</span> <span class="token keyword">bool</span> ampduSubframe<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>mpdu <span class="token operator">&lt;&lt;</span> rxSnr <span class="token operator">&lt;&lt;</span> txVector<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token function">m_rxCallback</span> <span class="token punctuation">(</span>mpdu<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>继续运行代码。 <code>m_rxCallback</code> 也是一个函数指针。该值的设置位置是在 <code>RegularWifiMac的构造函数里</code> ，代码：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>m_low<span class="token operator">-></span><span class="token function">SetRxCallback</span> <span class="token punctuation">(</span><span class="token function">MakeCallback</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>MacRxMiddle<span class="token double-colon punctuation">::</span>Receive<span class="token punctuation">,</span> m_rxMiddle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>所以实际调用的是 <code>MacRxMiddle::Receive</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">MacRxMiddle</span><span class="token double-colon punctuation">::</span><span class="token function">Receive</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>WifiMacQueueItem<span class="token operator">></span> mpdu<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token operator">*</span>mpdu<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">const</span> WifiMacHeader<span class="token operator">*</span> hdr <span class="token operator">=</span> <span class="token operator">&amp;</span>mpdu<span class="token operator">-></span><span class="token function">GetHeader</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  Ptr<span class="token operator">&lt;</span>Packet<span class="token operator">></span> packet <span class="token operator">=</span> mpdu<span class="token operator">-></span><span class="token function">GetPacket</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">Copy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>hdr<span class="token operator">-></span><span class="token function">IsData</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> hdr<span class="token operator">-></span><span class="token function">IsMgt</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_pcfCallback<span class="token punctuation">.</span><span class="token function">IsNull</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token function">m_pcfCallback</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  OriginatorRxStatus <span class="token operator">*</span>originator <span class="token operator">=</span> <span class="token function">Lookup</span> <span class="token punctuation">(</span>hdr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token comment">/**</span></pre></td></tr><tr><td data-num="14"></td><td><pre>   * The check below is really unneeded because it can fail in a lot of</pre></td></tr><tr><td data-num="15"></td><td><pre>   * normal cases. Specifically, it is possible for sequence numbers to</pre></td></tr><tr><td data-num="16"></td><td><pre>   * loop back to zero once they reach 0xfff0 and to go up to 0xf7f0 in</pre></td></tr><tr><td data-num="17"></td><td><pre>   * which case the check below will report the two sequence numbers to</pre></td></tr><tr><td data-num="18"></td><td><pre>   * not have the correct order relationship.</pre></td></tr><tr><td data-num="19"></td><td><pre>   * So, this check cannot be used to discard old duplicate frames. It is</pre></td></tr><tr><td data-num="20"></td><td><pre>   * thus here only for documentation purposes.</pre></td></tr><tr><td data-num="21"></td><td><pre>   */</pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">SequenceNumber16</span> <span class="token punctuation">(</span>originator<span class="token operator">-></span><span class="token function">GetLastSequenceControl</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token function">SequenceNumber16</span> <span class="token punctuation">(</span>hdr<span class="token operator">-></span><span class="token function">GetSequenceControl</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Sequence numbers have looped back. last recorded="</span> <span class="token operator">&lt;&lt;</span> originator<span class="token operator">-></span><span class="token function">GetLastSequenceControl</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                    <span class="token string">" currently seen="</span> <span class="token operator">&lt;&lt;</span> hdr<span class="token operator">-></span><span class="token function">GetSequenceControl</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token comment">//filter duplicates.</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsDuplicate</span> <span class="token punctuation">(</span>hdr<span class="token punctuation">,</span> originator<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"duplicate from="</span> <span class="token operator">&lt;&lt;</span> hdr<span class="token operator">-></span><span class="token function">GetAddr2</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                    <span class="token string">", seq="</span> <span class="token operator">&lt;&lt;</span> hdr<span class="token operator">-></span><span class="token function">GetSequenceNumber</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                    <span class="token string">", frag="</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">+</span>hdr<span class="token operator">-></span><span class="token function">GetFragmentNumber</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  Ptr<span class="token operator">&lt;</span>Packet<span class="token operator">></span> aggregate <span class="token operator">=</span> <span class="token function">HandleFragments</span> <span class="token punctuation">(</span>packet<span class="token punctuation">,</span> hdr<span class="token punctuation">,</span> originator<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>aggregate <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"forwarding data from="</span> <span class="token operator">&lt;&lt;</span> hdr<span class="token operator">-></span><span class="token function">GetAddr2</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                <span class="token string">", seq="</span> <span class="token operator">&lt;&lt;</span> hdr<span class="token operator">-></span><span class="token function">GetSequenceNumber</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                <span class="token string">", frag="</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">+</span>hdr<span class="token operator">-></span><span class="token function">GetFragmentNumber</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hdr<span class="token operator">-></span><span class="token function">GetAddr1</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsGroup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>      originator<span class="token operator">-></span><span class="token function">SetSequenceControl</span> <span class="token punctuation">(</span>hdr<span class="token operator">-></span><span class="token function">GetSequenceControl</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>aggregate <span class="token operator">==</span> packet<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>      <span class="token function">m_callback</span> <span class="token punctuation">(</span>mpdu<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>      <span class="token comment">// We could do this in all cases, but passing the received mpdu in case of</span></pre></td></tr><tr><td data-num="54"></td><td><pre>      <span class="token comment">// A-MSDUs saves us the time to deaggregate the A-MSDU in MSDUs (which are</span></pre></td></tr><tr><td data-num="55"></td><td><pre>      <span class="token comment">// kept separate in the received mpdu) and allows us to pass the originally</span></pre></td></tr><tr><td data-num="56"></td><td><pre>      <span class="token comment">// transmitted packets (i.e., with the same UID) to the receiver.</span></pre></td></tr><tr><td data-num="57"></td><td><pre>      <span class="token function">m_callback</span> <span class="token punctuation">(</span><span class="token generic-function"><span class="token function">Create</span><span class="token generic class-name"><span class="token operator">&lt;</span>WifiMacQueueItem<span class="token operator">></span></span></span> <span class="token punctuation">(</span>aggregate<span class="token punctuation">,</span> <span class="token operator">*</span>hdr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这也有一个 <code>m_callback</code> ，其设置位置 <code>RegularWifiMac的构造函数</code> ，代码为</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>m_rxMiddle<span class="token operator">-></span><span class="token function">SetForwardCallback</span> <span class="token punctuation">(</span><span class="token function">MakeCallback</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>RegularWifiMac<span class="token double-colon punctuation">::</span>Receive<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>所以实际的调用是 <code>RegularWifiMac::Receive</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">RegularWifiMac</span><span class="token double-colon punctuation">::</span><span class="token function">Receive</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>WifiMacQueueItem<span class="token operator">></span> mpdu<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>mpdu<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token keyword">const</span> WifiMacHeader<span class="token operator">*</span> hdr <span class="token operator">=</span> <span class="token operator">&amp;</span>mpdu<span class="token operator">-></span><span class="token function">GetHeader</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  Ptr<span class="token operator">&lt;</span>Packet<span class="token operator">></span> packet <span class="token operator">=</span> mpdu<span class="token operator">-></span><span class="token function">GetPacket</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">Copy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  Mac48Address to <span class="token operator">=</span> hdr<span class="token operator">-></span><span class="token function">GetAddr1</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  Mac48Address from <span class="token operator">=</span> hdr<span class="token operator">-></span><span class="token function">GetAddr2</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token comment">//We don't know how to deal with any frame that is not addressed to</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token comment">//us (and odds are there is nothing sensible we could do anyway),</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token comment">//so we ignore such frames.</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token comment">//The derived class may also do some such filtering, but it doesn't</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token comment">//hurt to have it here too as a backstop.</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>to <span class="token operator">!=</span> <span class="token function">GetAddress</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>hdr<span class="token operator">-></span><span class="token function">IsMgt</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> hdr<span class="token operator">-></span><span class="token function">IsAction</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token comment">//There is currently only any reason for Management Action</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token comment">//frames to be flying about if we are a QoS STA.</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>m_qosSupported<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>      WifiActionHeader actionHdr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      packet<span class="token operator">-></span><span class="token function">RemoveHeader</span> <span class="token punctuation">(</span>actionHdr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>      <span class="token keyword">switch</span> <span class="token punctuation">(</span>actionHdr<span class="token punctuation">.</span><span class="token function">GetCategory</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token keyword">case</span> WifiActionHeader<span class="token double-colon punctuation">::</span>BLOCK_ACK<span class="token operator">:</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>          <span class="token keyword">switch</span> <span class="token punctuation">(</span>actionHdr<span class="token punctuation">.</span><span class="token function">GetAction</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>blockAck<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token keyword">case</span> WifiActionHeader<span class="token double-colon punctuation">::</span>BLOCK_ACK_ADDBA_REQUEST<span class="token operator">:</span></pre></td></tr><tr><td data-num="38"></td><td><pre>              <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                MgtAddBaRequestHeader reqHdr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                packet<span class="token operator">-></span><span class="token function">RemoveHeader</span> <span class="token punctuation">(</span>reqHdr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>                <span class="token comment">//We've received an ADDBA Request. Our policy here is</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                <span class="token comment">//to automatically accept it, so we get the ADDBA</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                <span class="token comment">//Response on it's way immediately.</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                <span class="token function">SendAddBaResponse</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>reqHdr<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                <span class="token comment">//This frame is now completely dealt with, so we're done.</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>              <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token keyword">case</span> WifiActionHeader<span class="token double-colon punctuation">::</span>BLOCK_ACK_ADDBA_RESPONSE<span class="token operator">:</span></pre></td></tr><tr><td data-num="50"></td><td><pre>              <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                MgtAddBaResponseHeader respHdr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                packet<span class="token operator">-></span><span class="token function">RemoveHeader</span> <span class="token punctuation">(</span>respHdr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre>                <span class="token comment">//We've received an ADDBA Response. We assume that it</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                <span class="token comment">//indicates success after an ADDBA Request we have</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                <span class="token comment">//sent (we could, in principle, check this, but it</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                <span class="token comment">//seems a waste given the level of the current model)</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                <span class="token comment">//and act by locally establishing the agreement on</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                <span class="token comment">//the appropriate queue.</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                AcIndex ac <span class="token operator">=</span> <span class="token function">QosUtilsMapTidToAc</span> <span class="token punctuation">(</span>respHdr<span class="token punctuation">.</span><span class="token function">GetTid</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                m_edca<span class="token punctuation">[</span>ac<span class="token punctuation">]</span><span class="token operator">-></span><span class="token function">GotAddBaResponse</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>respHdr<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                <span class="token comment">//This frame is now completely dealt with, so we're done.</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>              <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>            <span class="token keyword">case</span> WifiActionHeader<span class="token double-colon punctuation">::</span>BLOCK_ACK_DELBA<span class="token operator">:</span></pre></td></tr><tr><td data-num="66"></td><td><pre>              <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>                MgtDelBaHeader delBaHdr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>                packet<span class="token operator">-></span><span class="token function">RemoveHeader</span> <span class="token punctuation">(</span>delBaHdr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>delBaHdr<span class="token punctuation">.</span><span class="token function">IsByOriginator</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="71"></td><td><pre>                  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>                    <span class="token comment">//This DELBA frame was sent by the originator, so</span></pre></td></tr><tr><td data-num="73"></td><td><pre>                    <span class="token comment">//this means that an ingoing established</span></pre></td></tr><tr><td data-num="74"></td><td><pre>                    <span class="token comment">//agreement exists in MacLow and we need to</span></pre></td></tr><tr><td data-num="75"></td><td><pre>                    <span class="token comment">//destroy it.</span></pre></td></tr><tr><td data-num="76"></td><td><pre>                    m_low<span class="token operator">-></span><span class="token function">DestroyBlockAckAgreement</span> <span class="token punctuation">(</span>from<span class="token punctuation">,</span> delBaHdr<span class="token punctuation">.</span><span class="token function">GetTid</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>                  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>                <span class="token keyword">else</span></pre></td></tr><tr><td data-num="79"></td><td><pre>                  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>                    <span class="token comment">//We must have been the originator. We need to</span></pre></td></tr><tr><td data-num="81"></td><td><pre>                    <span class="token comment">//tell the correct queue that the agreement has</span></pre></td></tr><tr><td data-num="82"></td><td><pre>                    <span class="token comment">//been torn down</span></pre></td></tr><tr><td data-num="83"></td><td><pre>                    AcIndex ac <span class="token operator">=</span> <span class="token function">QosUtilsMapTidToAc</span> <span class="token punctuation">(</span>delBaHdr<span class="token punctuation">.</span><span class="token function">GetTid</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>                    m_edca<span class="token punctuation">[</span>ac<span class="token punctuation">]</span><span class="token operator">-></span><span class="token function">GotDelBaFrame</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>delBaHdr<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>                  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>                <span class="token comment">//This frame is now completely dealt with, so we're done.</span></pre></td></tr><tr><td data-num="87"></td><td><pre>                <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>              <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>            <span class="token keyword">default</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="90"></td><td><pre>              <span class="token function">NS_FATAL_ERROR</span> <span class="token punctuation">(</span><span class="token string">"Unsupported Action field in Block Ack Action frame"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>              <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>        <span class="token keyword">default</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="94"></td><td><pre>          <span class="token function">NS_FATAL_ERROR</span> <span class="token punctuation">(</span><span class="token string">"Unsupported Action frame received"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>          <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>  <span class="token function">NS_FATAL_ERROR</span> <span class="token punctuation">(</span><span class="token string">"Don't know how to handle frame (type="</span> <span class="token operator">&lt;&lt;</span> hdr<span class="token operator">-></span><span class="token function">GetType</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>目前没有找到任何可行的调用方式，回看其继承关系</p><p><img data-src="http://static.jluyeyu.com/article_images/wifiMac%E7%9A%84%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB.jpg" alt="继承关系">)</p><p>我们观察到，该类下面有很多子类，大胆推测其转发是由子类各自实现的，</p><p>所以我们观察 <code>AdhocWifiMac::Receive</code> ，</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">AdhocWifiMac</span><span class="token double-colon punctuation">::</span><span class="token function">Receive</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>WifiMacQueueItem<span class="token operator">></span> mpdu<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>mpdu<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">const</span> WifiMacHeader<span class="token operator">*</span> hdr <span class="token operator">=</span> <span class="token operator">&amp;</span>mpdu<span class="token operator">-></span><span class="token function">GetHeader</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span><span class="token operator">!</span>hdr<span class="token operator">-></span><span class="token function">IsCtl</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  Mac48Address from <span class="token operator">=</span> hdr<span class="token operator">-></span><span class="token function">GetAddr2</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  Mac48Address to <span class="token operator">=</span> hdr<span class="token operator">-></span><span class="token function">GetAddr1</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_stationManager<span class="token operator">-></span><span class="token function">IsBrandNew</span> <span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token comment">//In ad hoc mode, we assume that every destination supports all the rates we support.</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">GetHtSupported</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>          m_stationManager<span class="token operator">-></span><span class="token function">AddAllSupportedMcs</span> <span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>          m_stationManager<span class="token operator">-></span><span class="token function">AddStationHtCapabilities</span> <span class="token punctuation">(</span>from<span class="token punctuation">,</span> <span class="token function">GetHtCapabilities</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">GetVhtSupported</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>          m_stationManager<span class="token operator">-></span><span class="token function">AddStationVhtCapabilities</span> <span class="token punctuation">(</span>from<span class="token punctuation">,</span> <span class="token function">GetVhtCapabilities</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">GetHeSupported</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>          m_stationManager<span class="token operator">-></span><span class="token function">AddStationHeCapabilities</span> <span class="token punctuation">(</span>from<span class="token punctuation">,</span> <span class="token function">GetHeCapabilities</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      m_stationManager<span class="token operator">-></span><span class="token function">AddAllSupportedModes</span> <span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      m_stationManager<span class="token operator">-></span><span class="token function">RecordDisassociated</span> <span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>hdr<span class="token operator">-></span><span class="token function">IsData</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>hdr<span class="token operator">-></span><span class="token function">IsQosData</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> hdr<span class="token operator">-></span><span class="token function">IsQosAmsdu</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>          <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Received A-MSDU from"</span> <span class="token operator">&lt;&lt;</span> from<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>          <span class="token function">DeaggregateAmsduAndForward</span> <span class="token punctuation">(</span>mpdu<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token keyword">else</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>          <span class="token function">ForwardUp</span> <span class="token punctuation">(</span>mpdu<span class="token operator">-></span><span class="token function">GetPacket</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">Copy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> from<span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token comment">//Invoke the receive handler of our parent class to deal with any</span></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token comment">//other frames. Specifically, this will handle Block Ack-related</span></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token comment">//Management Action frames.</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token class-name">RegularWifiMac</span><span class="token double-colon punctuation">::</span><span class="token function">Receive</span> <span class="token punctuation">(</span>mpdu<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>不出意料，发现了下一个突破口， <code>ForwardUp</code> ，并且子类调用父类的 <code>Receive</code> 方法证明了猜测是正确的。</p><p>由于子类不含该方法，所以该方法是在父类 <code>RegularWifiMac:::ForwardUp</code> 中实现</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">RegularWifiMac</span><span class="token double-colon punctuation">::</span><span class="token function">ForwardUp</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> Packet<span class="token operator">></span> packet<span class="token punctuation">,</span> Mac48Address from<span class="token punctuation">,</span> Mac48Address to<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> packet <span class="token operator">&lt;&lt;</span> from <span class="token operator">&lt;&lt;</span> to<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token function">m_forwardUp</span> <span class="token punctuation">(</span>packet<span class="token punctuation">,</span> from<span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span>       <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token function">NS_FATAL_ERROR</span> <span class="token punctuation">(</span><span class="token string">"Don't know how to handle frame (type="</span> <span class="token operator">&lt;&lt;</span> hdr<span class="token operator">-></span><span class="token function">GetType</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>很简单的方法， <code>RegularWifiMac::ForwardUp</code> 方法会继续向上层传递接收到的 packet，下面就是跟踪 <code>m_forwardUp</code> 的赋值</p><p>其赋值位置在 <code>WifiNetDevice::CompleteConfig</code> 里面</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>m_mac<span class="token operator">-></span><span class="token function">SetForwardUpCallback</span> <span class="token punctuation">(</span><span class="token function">MakeCallback</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>WifiNetDevice<span class="token double-colon punctuation">::</span>ForwardUp<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>所以最终调用的是 <code>WifiNetDevice::ForwardUp</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">WifiNetDevice</span><span class="token double-colon punctuation">::</span><span class="token function">ForwardUp</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> Packet<span class="token operator">></span> packet<span class="token punctuation">,</span> Mac48Address from<span class="token punctuation">,</span> Mac48Address to<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> packet <span class="token operator">&lt;&lt;</span> from <span class="token operator">&lt;&lt;</span> to<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  LlcSnapHeader llc<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  NetDevice<span class="token double-colon punctuation">::</span>PacketType type<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>to<span class="token punctuation">.</span><span class="token function">IsBroadcast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      type <span class="token operator">=</span> NetDevice<span class="token double-colon punctuation">::</span>PACKET_BROADCAST<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>to<span class="token punctuation">.</span><span class="token function">IsGroup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      type <span class="token operator">=</span> NetDevice<span class="token double-colon punctuation">::</span>PACKET_MULTICAST<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>to <span class="token operator">==</span> m_mac<span class="token operator">-></span><span class="token function">GetAddress</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      type <span class="token operator">=</span> NetDevice<span class="token double-colon punctuation">::</span>PACKET_HOST<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      type <span class="token operator">=</span> NetDevice<span class="token double-colon punctuation">::</span>PACKET_OTHERHOST<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>  Ptr<span class="token operator">&lt;</span>Packet<span class="token operator">></span> copy <span class="token operator">=</span> packet<span class="token operator">-></span><span class="token function">Copy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">!=</span> NetDevice<span class="token double-colon punctuation">::</span>PACKET_OTHERHOST<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      m_mac<span class="token operator">-></span><span class="token function">NotifyRx</span> <span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      copy<span class="token operator">-></span><span class="token function">RemoveHeader</span> <span class="token punctuation">(</span>llc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      <span class="token function">m_forwardUp</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> copy<span class="token punctuation">,</span> llc<span class="token punctuation">.</span><span class="token function">GetType</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      copy<span class="token operator">-></span><span class="token function">RemoveHeader</span> <span class="token punctuation">(</span>llc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_promiscRx<span class="token punctuation">.</span><span class="token function">IsNull</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      m_mac<span class="token operator">-></span><span class="token function">NotifyPromiscRx</span> <span class="token punctuation">(</span>copy<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token function">m_promiscRx</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> copy<span class="token punctuation">,</span> llc<span class="token punctuation">.</span><span class="token function">GetType</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> from<span class="token punctuation">,</span> to<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="完整流程图"><a class="anchor" href="#完整流程图">#</a> 完整流程图</h4><p><img data-src="http://static.jluyeyu.com/article_images/ns3.32%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg" alt="ns3.32wifi模块流程图"></p><div class="tags"><a href="/tags/ns3/" rel="tag"><i class="ic i-tag"></i> ns3</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2023-02-16 15:50:57" itemprop="dateModified" datetime="2023-02-16T15:50:57+08:00">2023-02-16</time> </span><span id="ns3/11.ns3 wifi模块流程源码解析/" class="item leancloud_visitors" data-flag-title="11.ns3 wifi 模块流程源码解析" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="jluyeyu 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="jluyeyu 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>jluyeyu <i class="ic i-at"><em>@</em></i>blog</li><li class="link"><strong>本文链接：</strong> <a href="http://jluyeyu.com/ns3/11.ns3%20wifi%E6%A8%A1%E5%9D%97%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" title="11.ns3 wifi 模块流程源码解析">http://jluyeyu.com/ns3/11.ns3 wifi模块流程源码解析/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/ns3/10.ns3%20%E8%B7%AF%E7%94%B1%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%AE%9E%E4%BE%8B/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;img.timelessq.com&#x2F;images&#x2F;2022&#x2F;07&#x2F;26&#x2F;601b4c1b1f50f3ceb9e8080e1957a890.jpg" title="10.ns3 路由性能测试实例"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> ns3</span><h3>10.ns3 路由性能测试实例</h3></a></div><div class="item right"><a href="/ns3/12.ns3%20wifi%E6%A8%A1%E5%9D%97%E4%BB%8ESocket%E5%88%B0WifiNetDevice/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;img.timelessq.com&#x2F;images&#x2F;2022&#x2F;07&#x2F;26&#x2F;3cff3fc776e129c36936b1cf83a34b68.jpg" title="12.ns3 wifi模块从Socket到WifiNetDevice"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> ns3</span><h3>12.ns3 wifi模块从Socket到WifiNetDevice</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#11ns3-wifi%E6%A8%A1%E5%9D%97%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">11.ns3 wifi 模块流程源码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E8%BF%87%E7%A8%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">1.1.</span> <span class="toc-text">发送过程源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E7%9A%84%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">1.1.1.</span> <span class="toc-text">发送的流程图</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E6%94%B6%E8%BF%87%E7%A8%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">接收过程源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">1.2.1.</span> <span class="toc-text">完整流程图</span></a></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/ns3/0.ns3%E6%8E%A8%E8%8D%90%E8%B5%84%E6%96%99/" rel="bookmark" title="0.ns3推荐资料">0.ns3推荐资料</a></li><li><a href="/ns3/1.ns3%E5%88%9D%E8%AF%86/" rel="bookmark" title="1.ns3初识">1.ns3初识</a></li><li><a href="/ns3/2.ns3%E5%85%B3%E9%94%AE%E6%8A%BD%E8%B1%A1/" rel="bookmark" title="2.ns3关键抽象">2.ns3关键抽象</a></li><li><a href="/ns3/3.waf%E8%BF%90%E8%A1%8C%E5%91%BD%E4%BB%A4%E4%BB%A5%E5%8F%8A%E5%91%BD%E4%BB%A4%E8%A1%8C%E8%A7%A3%E6%9E%90%E7%9A%84%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/" rel="bookmark" title="3.waf运行命令以及命令行解析的使用说明">3.waf运行命令以及命令行解析的使用说明</a></li><li><a href="/ns3/4.%E4%BB%BF%E7%9C%9F%E6%B5%81%E7%A8%8B/" rel="bookmark" title="4.仿真流程">4.仿真流程</a></li><li><a href="/ns3/5.ns3%20wifi%E6%A8%A1%E5%9E%8B/" rel="bookmark" title="5.ns3 wifi模型">5.ns3 wifi模型</a></li><li><a href="/ns3/6.ns3%20wifi%20%E6%A8%A1%E5%9E%8B%E9%85%8D%E7%BD%AE/" rel="bookmark" title="6.wifi模型扩展">6.wifi模型扩展</a></li><li><a href="/ns3/7.ns3%20%E6%8D%9F%E5%A4%B1%E6%A8%A1%E5%9E%8B%E4%BF%AE%E6%94%B9/" rel="bookmark" title="7.ns3 损失模型修改">7.ns3 损失模型修改</a></li><li><a href="/ns3/8.ns3%20wifi%E8%AE%BE%E5%A4%87%E5%AE%9A%E5%90%91%E5%8F%91%E9%80%81%E7%9A%84%E5%AE%9E%E7%8E%B0/" rel="bookmark" title="8.ns3 wifi设备定向发送的实现">8.ns3 wifi设备定向发送的实现</a></li><li><a href="/ns3/9.ns3%20Config%E7%B1%BBAPI%E8%AF%B4%E6%98%8E/" rel="bookmark" title="9.ns3 Config类API说明">9.ns3 Config类API说明</a></li><li><a href="/ns3/10.ns3%20%E8%B7%AF%E7%94%B1%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%AE%9E%E4%BE%8B/" rel="bookmark" title="10.ns3 路由性能测试实例">10.ns3 路由性能测试实例</a></li><li class="active"><a href="/ns3/11.ns3%20wifi%E6%A8%A1%E5%9D%97%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" rel="bookmark" title="11.ns3 wifi模块流程源码解析">11.ns3 wifi模块流程源码解析</a></li><li><a href="/ns3/12.ns3%20wifi%E6%A8%A1%E5%9D%97%E4%BB%8ESocket%E5%88%B0WifiNetDevice/" rel="bookmark" title="12.ns3 wifi模块从Socket到WifiNetDevice">12.ns3 wifi模块从Socket到WifiNetDevice</a></li><li><a href="/ns3/13.ns3%20Aqua-sim%20ng%E6%B0%B4%E5%A3%B0%E9%80%9A%E4%BF%A1%E6%A8%A1%E5%9D%97%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" rel="bookmark" title="13.ns3 Aqua-sim ng水声通信模块源码解析">13.ns3 Aqua-sim ng水声通信模块源码解析</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="jluyeyu" data-src="/images/avatar.jpg"><p class="name" itemprop="name">jluyeyu</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">64</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">12</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">14</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL01lbW9yeU9mTG92ZQ==" title="https:&#x2F;&#x2F;github.com&#x2F;MemoryOfLove"><i class="ic i-github"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTEyNjE0OTAxOA==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;126149018"><i class="ic i-cloud-music"></i></span> <span class="exturl item about" data-url="aHR0cHM6Ly9hYm91dC5tZS9qbHV5ZXl1" title="https:&#x2F;&#x2F;about.me&#x2F;jluyeyu"><i class="ic i-address-card"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>friends</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/ns3/10.ns3%20%E8%B7%AF%E7%94%B1%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%AE%9E%E4%BE%8B/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/ns3/12.ns3%20wifi%E6%A8%A1%E5%9D%97%E4%BB%8ESocket%E5%88%B0WifiNetDevice/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/interview/" title="分类于 interview">interview</a> <i class="ic i-angle-right"></i> <a href="/categories/interview/html/" title="分类于 html">html</a></div><span><a href="/interview/html/html%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9F%BA%E7%A1%80%E9%97%AE%E9%A2%98/" title="html的一些基础问题汇总">html的一些基础问题汇总</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/interview/" title="分类于 interview">interview</a> <i class="ic i-angle-right"></i> <a href="/categories/interview/html/" title="分类于 html">html</a></div><span><a href="/interview/html/html5%E6%9C%89%E5%93%AA%E4%BA%9B%E6%96%B0%E7%89%B9%E6%80%A7%E5%B9%B6%E7%A7%BB%E9%99%A4%E4%BA%86%E5%93%AA%E4%BA%9B%E5%85%83%E7%B4%A0/" title="html5有哪些新特性并移除了哪些元素">html5有哪些新特性并移除了哪些元素</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ns3/" title="分类于 ns3">ns3</a></div><span><a href="/ns3/1.ns3%E5%88%9D%E8%AF%86/" title="1.ns3初识">1.ns3初识</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/javascript/" title="分类于 javascript">javascript</a></div><span><a href="/javascript/GA%20tracking/" title="在 React JS 应用程序中借助Google Tag Manager实现 Google Analytics">在 React JS 应用程序中借助Google Tag Manager实现 Google Analytics</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/leetcode/" title="分类于 每日一题">每日一题</a></div><span><a href="/leetcode/264.%20%E4%B8%91%E6%95%B0/" title="264. 丑数 II">264. 丑数 II</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/css/" title="分类于 css">css</a></div><span><a href="/css/css%20background/" title="css background">css background</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/hello-blog/" title="本站说明">本站说明</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/javascript/" title="分类于 javascript">javascript</a></div><span><a href="/javascript/%E6%8A%BD%E8%B1%A1%E8%AF%AD%E6%B3%95%E6%A0%91%E5%88%9D%E8%AF%86/" title="抽象语法树ast初识">抽象语法树ast初识</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/project/" title="分类于 项目相关">项目相关</a> <i class="ic i-angle-right"></i> <a href="/categories/project/onlineResume/" title="分类于 在线简历生成">在线简历生成</a></div><span><a href="/project/onlineResume/1.%20hello%20Electron/" title="1. hello Electron">1. hello Electron</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/interview/" title="分类于 interview">interview</a> <i class="ic i-angle-right"></i> <a href="/categories/interview/html/" title="分类于 html">html</a></div><span><a href="/interview/html/%E6%B5%8F%E8%A7%88%E5%99%A8%E6%98%AF%E6%80%8E%E4%B9%88%E5%AF%B9%20HTML5%20%E7%9A%84%E7%A6%BB%E7%BA%BF%E5%82%A8%E5%AD%98%E8%B5%84%E6%BA%90%E8%BF%9B%E2%BE%8F%E7%AE%A1%E7%90%86%E5%92%8C%E5%8A%A0%E8%BD%BD%E7%9A%84%E5%91%A2/" title="浏览器是怎么对HTML5的离线储存资源进行管理和加载的呢">浏览器是怎么对HTML5的离线储存资源进行管理和加载的呢</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">jluyeyu @ jluyeyu</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">434k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">6:35</span></div><div class="powered-by"><span class="exturl" data-url="aHR0cHM6Ly9iZWlhbi5taWl0Lmdvdi5jbi8=">辽ICP备2022000405号</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"ns3/11.ns3 wifi模块流程源码解析/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script><script data-pjax>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?fd6200dc631128a08f631d890b15971b";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></body></html>