<!DOCTYPE html><html lang="zh-CN"><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-VNNQ4XB5X6"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-VNNQ4XB5X6")</script><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="blog" href="http://jluyeyu.com/rss.xml"><link rel="alternate" type="application/atom+xml" title="blog" href="http://jluyeyu.com/atom.xml"><link rel="alternate" type="application/json" title="blog" href="http://jluyeyu.com/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="ns3"><link rel="canonical" href="http://jluyeyu.com/ns3/12.ns3%20wifi%E6%A8%A1%E5%9D%97%E4%BB%8ESocket%E5%88%B0WifiNetDevice/"><title>12.ns3 wifi 模块从 Socket 到 WifiNetDevice - ns3 | jluyeyu = blog</title><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/katex@0/dist/katex.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="loading-box"><div class="car"><div class="strike"></div><div class="strike strike2"></div><div class="strike strike3"></div><div class="strike strike4"></div><div class="strike strike5"></div><div class="car-detail spoiler"></div><div class="car-detail back"></div><div class="car-detail center"></div><div class="car-detail center1"></div><div class="car-detail front"></div><div class="car-detail wheel"></div><div class="car-detail wheel wheel2"></div></div><div class="text"><span>Loading</span><span class="dots">...</span></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">12.ns3 wifi 模块从 Socket 到 WifiNetDevice</h1><div class="meta"><span class="item" title="创建时间：2022-11-09 14:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2022-11-09T14:00:00+08:00">2022-11-09</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>36k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>33 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">jluyeyu</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/c22bb7736559a7554506b05203018145.jpg"></li><li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/3cff3fc776e129c36936b1cf83a34b68.jpg"></li><li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/08e73cd8998a540ab698836447eeea91.jpg"></li><li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/dd21608b40c2387068c472909a82b3e0.jpg"></li><li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/b46094cb1b7015955b10a42dc949c5d9.jpg"></li><li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/0a6be1d1fa7827fc28504c63a5a6d653.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/ns3/" itemprop="item" rel="index" title="分类于 ns3"><span itemprop="name">ns3</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://jluyeyu.com/ns3/12.ns3%20wifi%E6%A8%A1%E5%9D%97%E4%BB%8ESocket%E5%88%B0WifiNetDevice/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="jluyeyu"><meta itemprop="description" content=", "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="blog"></span><div class="body md" itemprop="articleBody"><h2 id="12ns3-wifi模块从socket到wifinetdevice"><a class="anchor" href="#12ns3-wifi模块从socket到wifinetdevice">#</a> 12.ns3 wifi 模块从 Socket 到 WifiNetDevice</h2><p>在本节中，将从源码的角度解析 <code>ns3</code> 的 <code>wifi</code> 模块，包括一个 <code>packet</code> 是如何从一台主机的 <code>Socket</code> 到另一台主机的 <code>Socket</code> 。</p><p>PS:</p><ol><li><p>本节很长，而且很枯燥，但是对扩展 <code>ns3</code> 功能，了解 <code>ns3</code> 流程非常有帮助，请耐心观看。</p></li><li><p>本节的源码来自于 <code>ns3.32</code> , 不同版本之间有一些差异，但大致流程差不多，可以互相参考。</p></li><li><p>本节需要一定的前置知识，推荐先阅读上一节<span class="exturl" data-url="aHR0cDovL3d3dy5qbHV5ZXl1LmNvbS9uczMvMTEubnMzJTIwd2lmaSVFNiVBOCVBMSVFNSU5RCU5NyVFNiVCNSU4MSVFNyVBOCU4QiVFNiVCQSU5MCVFNyVBMCU4MSVFOCVBNyVBMyVFNiU5RSU5MC8="> 11.ns3 wifi 模块流程源码解析</span>，大致了解 <code>Packet</code> 从 <code>NetDevice</code> 到物理层之间的调用过程</p></li></ol><h3 id="发送过程分析"><a class="anchor" href="#发送过程分析">#</a> 发送过程分析</h3><p><code>Socket</code> 通信必定离不开 <code>Socket::Send</code> 函数，所以今天我们的起点就是 <code>Socket::Send</code></p><p><code>network/model/socket.h</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre>   * \brief Send data (or dummy data) to the remote host</pre></td></tr><tr><td data-num="3"></td><td><pre>   *</pre></td></tr><tr><td data-num="4"></td><td><pre>   * This function matches closely in semantics to the send() function</pre></td></tr><tr><td data-num="5"></td><td><pre>   * call in the standard C library (libc):</pre></td></tr><tr><td data-num="6"></td><td><pre>   *   ssize_t send (int s, const void *msg, size_t len, int flags);</pre></td></tr><tr><td data-num="7"></td><td><pre>   * except that the send I/O is asynchronous.  This is the</pre></td></tr><tr><td data-num="8"></td><td><pre>   * primary Send method at this low-level API and must be implemented </pre></td></tr><tr><td data-num="9"></td><td><pre>   * by subclasses.</pre></td></tr><tr><td data-num="10"></td><td><pre>   * </pre></td></tr><tr><td data-num="11"></td><td><pre>   * In a typical blocking sockets model, this call would block upon</pre></td></tr><tr><td data-num="12"></td><td><pre>   * lack of space to hold the message to be sent.  In ns-3 at this</pre></td></tr><tr><td data-num="13"></td><td><pre>   * API, the call returns immediately in such a case, but the callback</pre></td></tr><tr><td data-num="14"></td><td><pre>   * registered with SetSendCallback() is invoked when the socket</pre></td></tr><tr><td data-num="15"></td><td><pre>   * has space (when it conceptually unblocks); this is an asynchronous</pre></td></tr><tr><td data-num="16"></td><td><pre>   * I/O model for send().</pre></td></tr><tr><td data-num="17"></td><td><pre>   * </pre></td></tr><tr><td data-num="18"></td><td><pre>   * This variant of Send() uses class ns3::Packet to encapsulate</pre></td></tr><tr><td data-num="19"></td><td><pre>   * data, rather than providing a raw pointer and length field.</pre></td></tr><tr><td data-num="20"></td><td><pre>   * This allows an ns-3 application to attach tags if desired (such</pre></td></tr><tr><td data-num="21"></td><td><pre>   * as a flow ID) and may allow the simulator to avoid some data</pre></td></tr><tr><td data-num="22"></td><td><pre>   * copies.  Despite the appearance of sending Packets on a stream</pre></td></tr><tr><td data-num="23"></td><td><pre>   * socket, just think of it as a fancy byte buffer with streaming</pre></td></tr><tr><td data-num="24"></td><td><pre>   * semantics.</pre></td></tr><tr><td data-num="25"></td><td><pre>   *</pre></td></tr><tr><td data-num="26"></td><td><pre>   * If either the message buffer within the Packet is too long to pass </pre></td></tr><tr><td data-num="27"></td><td><pre>   * atomically through the underlying protocol (for datagram sockets), </pre></td></tr><tr><td data-num="28"></td><td><pre>   * or the message buffer cannot entirely fit in the transmit buffer</pre></td></tr><tr><td data-num="29"></td><td><pre>   * (for stream sockets), -1 is returned and SocketErrno is set </pre></td></tr><tr><td data-num="30"></td><td><pre>   * to ERROR_MSGSIZE.  If the packet does not fit, the caller can</pre></td></tr><tr><td data-num="31"></td><td><pre>   * split the Packet (based on information obtained from </pre></td></tr><tr><td data-num="32"></td><td><pre>   * GetTxAvailable) and reattempt to send the data.</pre></td></tr><tr><td data-num="33"></td><td><pre>   *</pre></td></tr><tr><td data-num="34"></td><td><pre>   * The flags argument is formed by or'ing one or more of the values:</pre></td></tr><tr><td data-num="35"></td><td><pre>   *        MSG_OOB        process out-of-band data </pre></td></tr><tr><td data-num="36"></td><td><pre>   *        MSG_DONTROUTE  bypass routing, use direct interface </pre></td></tr><tr><td data-num="37"></td><td><pre>   * These flags are _unsupported_ as of ns-3.1.</pre></td></tr><tr><td data-num="38"></td><td><pre>   *</pre></td></tr><tr><td data-num="39"></td><td><pre>   * \param p ns3::Packet to send</pre></td></tr><tr><td data-num="40"></td><td><pre>   * \param flags Socket control flags</pre></td></tr><tr><td data-num="41"></td><td><pre>   * \returns the number of bytes accepted for transmission if no error</pre></td></tr><tr><td data-num="42"></td><td><pre>   *          occurs, and -1 otherwise.</pre></td></tr><tr><td data-num="43"></td><td><pre>   *</pre></td></tr><tr><td data-num="44"></td><td><pre>   * \see SetSendCallback</pre></td></tr><tr><td data-num="45"></td><td><pre>   */</pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">Send</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>Packet<span class="token operator">></span> p<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> flags<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>虚函数，需要查看子类的实现</p><p><img data-src="http://static.jluyeyu.com/article_images/ns3.32%20socket%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB%E5%9B%BE.jpg" alt="Socket继承关系"></p><p>因为本人最常用的是 <code>UdpSocket</code> ，所以拿 <code>UdpSocket</code> 为例。</p><p><code>UdpSocket</code> 里不包含 <code>Send</code> 函数，所以其实现是在子类 <code>UdpSocketImpl</code> 里面</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">UdpSocketImpl</span><span class="token double-colon punctuation">::</span><span class="token function">Send</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>Packet<span class="token operator">></span> p<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> flags<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> p <span class="token operator">&lt;&lt;</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_connected<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      m_errno <span class="token operator">=</span> ERROR_NOTCONN<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token keyword">return</span> <span class="token function">DoSend</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">int</span> </pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token class-name">UdpSocketImpl</span><span class="token double-colon punctuation">::</span><span class="token function">DoSend</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>Packet<span class="token operator">></span> p<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m_endPoint <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token class-name">Ipv4Address</span><span class="token double-colon punctuation">::</span><span class="token function">IsMatchingType</span><span class="token punctuation">(</span>m_defaultAddress<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Bind</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>          <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>m_endPoint <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>          <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>m_endPoint <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m_endPoint6 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token class-name">Ipv6Address</span><span class="token double-colon punctuation">::</span><span class="token function">IsMatchingType</span><span class="token punctuation">(</span>m_defaultAddress<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Bind6</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>          <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>m_endPoint6 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>          <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>m_endPoint6 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_shutdownSend<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>      m_errno <span class="token operator">=</span> ERROR_SHUTDOWN<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Ipv4Address</span><span class="token double-colon punctuation">::</span><span class="token function">IsMatchingType</span> <span class="token punctuation">(</span>m_defaultAddress<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>      <span class="token keyword">return</span> <span class="token function">DoSendTo</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token class-name">Ipv4Address</span><span class="token double-colon punctuation">::</span><span class="token function">ConvertFrom</span> <span class="token punctuation">(</span>m_defaultAddress<span class="token punctuation">)</span><span class="token punctuation">,</span> m_defaultPort<span class="token punctuation">,</span> <span class="token function">GetIpTos</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Ipv6Address</span><span class="token double-colon punctuation">::</span><span class="token function">IsMatchingType</span> <span class="token punctuation">(</span>m_defaultAddress<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>      <span class="token keyword">return</span> <span class="token function">DoSendTo</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token class-name">Ipv6Address</span><span class="token double-colon punctuation">::</span><span class="token function">ConvertFrom</span> <span class="token punctuation">(</span>m_defaultAddress<span class="token punctuation">)</span><span class="token punctuation">,</span> m_defaultPort<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre>  m_errno <span class="token operator">=</span> ERROR_AFNOSUPPORT<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>  <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>Send</code> 方法调用 <code>DoSend</code> 方法，其中 <code>DoSend</code> 方法做了一些判断，判断 <code>socket</code> 实现已经 <code>bind</code> 和 <code>connection</code> 。</p><p><code>UdpSocketImpl::DoSend</code> 方法又调用了 <code>DoSendTo</code> 方法，分为两种情况，一种是 <code>IPV4</code> ，一种是 <code>IPV6</code> .</p><p>这里还是以 <code>Ipv4</code> 为例说明。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">UdpSocketImpl</span><span class="token double-colon punctuation">::</span><span class="token function">DoSendTo</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>Packet<span class="token operator">></span> p<span class="token punctuation">,</span> Ipv4Address dest<span class="token punctuation">,</span> <span class="token keyword">uint16_t</span> port<span class="token punctuation">,</span> <span class="token keyword">uint8_t</span> tos<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> p <span class="token operator">&lt;&lt;</span> dest <span class="token operator">&lt;&lt;</span> port <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token keyword">uint16_t</span><span class="token punctuation">)</span> tos<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_boundnetdevice<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"Bound interface number "</span> <span class="token operator">&lt;&lt;</span> m_boundnetdevice<span class="token operator">-></span><span class="token function">GetIfIndex</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_endPoint <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Bind</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>          <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>m_endPoint <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>          <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>m_endPoint <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_shutdownSend<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      m_errno <span class="token operator">=</span> ERROR_SHUTDOWN<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span><span class="token function">GetSize</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token function">GetTxAvailable</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      m_errno <span class="token operator">=</span> ERROR_MSGSIZE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token keyword">uint8_t</span> priority <span class="token operator">=</span> <span class="token function">GetPriority</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>tos<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      SocketIpTosTag ipTosTag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      ipTosTag<span class="token punctuation">.</span><span class="token function">SetTos</span> <span class="token punctuation">(</span>tos<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token comment">// This packet may already have a SocketIpTosTag (see BUG 2440)</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      p<span class="token operator">-></span><span class="token function">ReplacePacketTag</span> <span class="token punctuation">(</span>ipTosTag<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      priority <span class="token operator">=</span> <span class="token function">IpTos2Priority</span> <span class="token punctuation">(</span>tos<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>priority<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>      SocketPriorityTag priorityTag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>      priorityTag<span class="token punctuation">.</span><span class="token function">SetPriority</span> <span class="token punctuation">(</span>priority<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>      p<span class="token operator">-></span><span class="token function">ReplacePacketTag</span> <span class="token punctuation">(</span>priorityTag<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>  Ptr<span class="token operator">&lt;</span>Ipv4<span class="token operator">></span> ipv4 <span class="token operator">=</span> m_node<span class="token operator">-></span><span class="token generic-function"><span class="token function">GetObject</span><span class="token generic class-name"><span class="token operator">&lt;</span>Ipv4<span class="token operator">></span></span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token comment">// Locally override the IP TTL for this socket</span></pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token comment">// We cannot directly modify the TTL at this stage, so we set a Packet tag</span></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token comment">// The destination can be either multicast, unicast/anycast, or</span></pre></td></tr><tr><td data-num="52"></td><td><pre>  <span class="token comment">// either all-hosts broadcast or limited (subnet-directed) broadcast.</span></pre></td></tr><tr><td data-num="53"></td><td><pre>  <span class="token comment">// For the latter two broadcast types, the TTL will later be set to one</span></pre></td></tr><tr><td data-num="54"></td><td><pre>  <span class="token comment">// irrespective of what is set in these socket options.  So, this tagging</span></pre></td></tr><tr><td data-num="55"></td><td><pre>  <span class="token comment">// may end up setting the TTL of a limited broadcast packet to be</span></pre></td></tr><tr><td data-num="56"></td><td><pre>  <span class="token comment">// the same as a unicast, but it will be fixed further down the stack</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_ipMulticastTtl <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> dest<span class="token punctuation">.</span><span class="token function">IsMulticast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>      SocketIpTtlTag tag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>      tag<span class="token punctuation">.</span><span class="token function">SetTtl</span> <span class="token punctuation">(</span>m_ipMulticastTtl<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>      p<span class="token operator">-></span><span class="token function">AddPacketTag</span> <span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsManualIpTtl</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">GetIpTtl</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>dest<span class="token punctuation">.</span><span class="token function">IsMulticast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>dest<span class="token punctuation">.</span><span class="token function">IsBroadcast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>      SocketIpTtlTag tag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>      tag<span class="token punctuation">.</span><span class="token function">SetTtl</span> <span class="token punctuation">(</span><span class="token function">GetIpTtl</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>      p<span class="token operator">-></span><span class="token function">AddPacketTag</span> <span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    SocketSetDontFragmentTag tag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token keyword">bool</span> found <span class="token operator">=</span> p<span class="token operator">-></span><span class="token function">RemovePacketTag</span> <span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>found<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="73"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_mtuDiscover<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="75"></td><td><pre>          <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>            tag<span class="token punctuation">.</span><span class="token function">Enable</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token keyword">else</span></pre></td></tr><tr><td data-num="79"></td><td><pre>          <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>            tag<span class="token punctuation">.</span><span class="token function">Disable</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>        p<span class="token operator">-></span><span class="token function">AddPacketTag</span> <span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="85"></td><td><pre></pre></td></tr><tr><td data-num="86"></td><td><pre>  <span class="token comment">// Note that some systems will only send limited broadcast packets</span></pre></td></tr><tr><td data-num="87"></td><td><pre>  <span class="token comment">// out of the "default" interface; here we send it out all interfaces</span></pre></td></tr><tr><td data-num="88"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>dest<span class="token punctuation">.</span><span class="token function">IsBroadcast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_allowBroadcast<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="91"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>          m_errno <span class="token operator">=</span> ERROR_OPNOTSUPP<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>          <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>      <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"Limited broadcast start."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ipv4<span class="token operator">-></span><span class="token function">GetNInterfaces</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="97"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>          <span class="token comment">// Get the primary address</span></pre></td></tr><tr><td data-num="99"></td><td><pre>          Ipv4InterfaceAddress iaddr <span class="token operator">=</span> ipv4<span class="token operator">-></span><span class="token function">GetAddress</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>          Ipv4Address addri <span class="token operator">=</span> iaddr<span class="token punctuation">.</span><span class="token function">GetLocal</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>addri <span class="token operator">==</span> <span class="token function">Ipv4Address</span> <span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="102"></td><td><pre>            <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>          <span class="token comment">// Check if interface-bound socket</span></pre></td></tr><tr><td data-num="104"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>m_boundnetdevice<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="105"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>              <span class="token keyword">if</span> <span class="token punctuation">(</span>ipv4<span class="token operator">-></span><span class="token function">GetNetDevice</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">!=</span> m_boundnetdevice<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="107"></td><td><pre>                <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>          <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"Sending one copy from "</span> <span class="token operator">&lt;&lt;</span> addri <span class="token operator">&lt;&lt;</span> <span class="token string">" to "</span> <span class="token operator">&lt;&lt;</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>          m_udp<span class="token operator">-></span><span class="token function">Send</span> <span class="token punctuation">(</span>p<span class="token operator">-></span><span class="token function">Copy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> addri<span class="token punctuation">,</span> dest<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="111"></td><td><pre>                       m_endPoint<span class="token operator">-></span><span class="token function">GetLocalPort</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>          <span class="token function">NotifyDataSent</span> <span class="token punctuation">(</span>p<span class="token operator">-></span><span class="token function">GetSize</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="113"></td><td><pre>          <span class="token function">NotifySend</span> <span class="token punctuation">(</span><span class="token function">GetTxAvailable</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>      <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"Limited broadcast end."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>      <span class="token keyword">return</span> p<span class="token operator">-></span><span class="token function">GetSize</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m_endPoint<span class="token operator">-></span><span class="token function">GetLocalAddress</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">Ipv4Address</span><span class="token double-colon punctuation">::</span><span class="token function">GetAny</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="119"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>      m_udp<span class="token operator">-></span><span class="token function">Send</span> <span class="token punctuation">(</span>p<span class="token operator">-></span><span class="token function">Copy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> m_endPoint<span class="token operator">-></span><span class="token function">GetLocalAddress</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dest<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="121"></td><td><pre>                   m_endPoint<span class="token operator">-></span><span class="token function">GetLocalPort</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> port<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>      <span class="token function">NotifyDataSent</span> <span class="token punctuation">(</span>p<span class="token operator">-></span><span class="token function">GetSize</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>      <span class="token function">NotifySend</span> <span class="token punctuation">(</span><span class="token function">GetTxAvailable</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>      <span class="token keyword">return</span> p<span class="token operator">-></span><span class="token function">GetSize</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="125"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="126"></td><td><pre>  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ipv4<span class="token operator">-></span><span class="token function">GetRoutingProtocol</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="127"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="128"></td><td><pre>      Ipv4Header header<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="129"></td><td><pre>      header<span class="token punctuation">.</span><span class="token function">SetDestination</span> <span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="130"></td><td><pre>      header<span class="token punctuation">.</span><span class="token function">SetProtocol</span> <span class="token punctuation">(</span>UdpL4Protocol<span class="token double-colon punctuation">::</span>PROT_NUMBER<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="131"></td><td><pre>      Socket<span class="token double-colon punctuation">::</span>SocketErrno errno_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="132"></td><td><pre>      Ptr<span class="token operator">&lt;</span>Ipv4Route<span class="token operator">></span> route<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="133"></td><td><pre>      Ptr<span class="token operator">&lt;</span>NetDevice<span class="token operator">></span> oif <span class="token operator">=</span> m_boundnetdevice<span class="token punctuation">;</span> <span class="token comment">//specify non-zero if bound to a specific device</span></pre></td></tr><tr><td data-num="134"></td><td><pre>      <span class="token comment">// TBD-- we could cache the route and just check its validity</span></pre></td></tr><tr><td data-num="135"></td><td><pre>      route <span class="token operator">=</span> ipv4<span class="token operator">-></span><span class="token function">GetRoutingProtocol</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">RouteOutput</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> header<span class="token punctuation">,</span> oif<span class="token punctuation">,</span> errno_<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="136"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>route <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="137"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="138"></td><td><pre>          <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"Route exists"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="139"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_allowBroadcast<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="140"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="141"></td><td><pre>              <span class="token comment">// Here we try to route subnet-directed broadcasts</span></pre></td></tr><tr><td data-num="142"></td><td><pre>              <span class="token keyword">uint32_t</span> outputIfIndex <span class="token operator">=</span> ipv4<span class="token operator">-></span><span class="token function">GetInterfaceForDevice</span> <span class="token punctuation">(</span>route<span class="token operator">-></span><span class="token function">GetOutputDevice</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="143"></td><td><pre>              <span class="token keyword">uint32_t</span> ifNAddr <span class="token operator">=</span> ipv4<span class="token operator">-></span><span class="token function">GetNAddresses</span> <span class="token punctuation">(</span>outputIfIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="144"></td><td><pre>              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span> addrI <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> addrI <span class="token operator">&lt;</span> ifNAddr<span class="token punctuation">;</span> <span class="token operator">++</span>addrI<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="145"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="146"></td><td><pre>                  Ipv4InterfaceAddress ifAddr <span class="token operator">=</span> ipv4<span class="token operator">-></span><span class="token function">GetAddress</span> <span class="token punctuation">(</span>outputIfIndex<span class="token punctuation">,</span> addrI<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="147"></td><td><pre>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>dest <span class="token operator">==</span> ifAddr<span class="token punctuation">.</span><span class="token function">GetBroadcast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="148"></td><td><pre>                    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="149"></td><td><pre>                      m_errno <span class="token operator">=</span> ERROR_OPNOTSUPP<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="150"></td><td><pre>                      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="151"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="152"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="153"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="154"></td><td><pre></pre></td></tr><tr><td data-num="155"></td><td><pre>          header<span class="token punctuation">.</span><span class="token function">SetSource</span> <span class="token punctuation">(</span>route<span class="token operator">-></span><span class="token function">GetSource</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="156"></td><td><pre>          m_udp<span class="token operator">-></span><span class="token function">Send</span> <span class="token punctuation">(</span>p<span class="token operator">-></span><span class="token function">Copy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span><span class="token function">GetSource</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span><span class="token function">GetDestination</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="157"></td><td><pre>                       m_endPoint<span class="token operator">-></span><span class="token function">GetLocalPort</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> port<span class="token punctuation">,</span> route<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="158"></td><td><pre>          <span class="token function">NotifyDataSent</span> <span class="token punctuation">(</span>p<span class="token operator">-></span><span class="token function">GetSize</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="159"></td><td><pre>          <span class="token keyword">return</span> p<span class="token operator">-></span><span class="token function">GetSize</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="160"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="161"></td><td><pre>      <span class="token keyword">else</span> </pre></td></tr><tr><td data-num="162"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="163"></td><td><pre>          <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"No route to destination"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="164"></td><td><pre>          <span class="token function">NS_LOG_ERROR</span> <span class="token punctuation">(</span>errno_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="165"></td><td><pre>          m_errno <span class="token operator">=</span> errno_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="166"></td><td><pre>          <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="167"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="168"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="169"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="170"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="171"></td><td><pre>      <span class="token function">NS_LOG_ERROR</span> <span class="token punctuation">(</span><span class="token string">"ERROR_NOROUTETOHOST"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="172"></td><td><pre>      m_errno <span class="token operator">=</span> ERROR_NOROUTETOHOST<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="173"></td><td><pre>      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="174"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="175"></td><td><pre></pre></td></tr><tr><td data-num="176"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="177"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这里面有一个关键的步骤就是 <code>Socket</code> 发送的时候只知道目的节点 <code>dest</code> ，在传输的过程中，我们需要知道下一跳的节点 <code>next</code> 是什么？通常来说这是由配置的路由协议来决定的，这节的重点不是路由，所以我们先跳过这点，只需知道，在这时，已经找到了下一跳 <code>next</code> 。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// TBD-- we could cache the route and just check its validity</span></pre></td></tr><tr><td data-num="2"></td><td><pre>route <span class="token operator">=</span> ipv4<span class="token operator">-></span><span class="token function">GetRoutingProtocol</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">RouteOutput</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> header<span class="token punctuation">,</span> oif<span class="token punctuation">,</span> errno_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>回到函数中，我们可以看到得到 <code>next</code> 后，下一步调用的是 <code>m_udp-&gt;Send</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>m_udp<span class="token operator">-></span><span class="token function">Send</span> <span class="token punctuation">(</span>p<span class="token operator">-></span><span class="token function">Copy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span><span class="token function">GetSource</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span><span class="token function">GetDestination</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                       m_endPoint<span class="token operator">-></span><span class="token function">GetLocalPort</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> port<span class="token punctuation">,</span> route<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>其中的 <code>m_udp</code> 对象就是 <code>UdpL4Protocol</code> 类对象，所以下一步是调用的 <code>UdpL4Protocol::Send</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">UdpL4Protocol</span><span class="token double-colon punctuation">::</span><span class="token function">Send</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>Packet<span class="token operator">></span> packet<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="3"></td><td><pre>                     Ipv4Address saddr<span class="token punctuation">,</span> Ipv4Address daddr<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="4"></td><td><pre>                     <span class="token keyword">uint16_t</span> sport<span class="token punctuation">,</span> <span class="token keyword">uint16_t</span> dport<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> packet <span class="token operator">&lt;&lt;</span> saddr <span class="token operator">&lt;&lt;</span> daddr <span class="token operator">&lt;&lt;</span> sport <span class="token operator">&lt;&lt;</span> dport<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>  UdpHeader udpHeader<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token double-colon punctuation">::</span><span class="token function">ChecksumEnabled</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      udpHeader<span class="token punctuation">.</span><span class="token function">EnableChecksums</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      udpHeader<span class="token punctuation">.</span><span class="token function">InitializeChecksum</span> <span class="token punctuation">(</span>saddr<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                                    daddr<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                                    PROT_NUMBER<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  udpHeader<span class="token punctuation">.</span><span class="token function">SetDestinationPort</span> <span class="token punctuation">(</span>dport<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  udpHeader<span class="token punctuation">.</span><span class="token function">SetSourcePort</span> <span class="token punctuation">(</span>sport<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>  packet<span class="token operator">-></span><span class="token function">AddHeader</span> <span class="token punctuation">(</span>udpHeader<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token function">m_downTarget</span> <span class="token punctuation">(</span>packet<span class="token punctuation">,</span> saddr<span class="token punctuation">,</span> daddr<span class="token punctuation">,</span> PROT_NUMBER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这里 <code>UdpL4Protocol::Send</code> 方法调用了一个 <code>m_downTarget</code> 的回调地址。 <code>m_downTarget</code> 的值的设置代码如下：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * This method is called by AggregateObject and completes the aggregation</pre></td></tr><tr><td data-num="3"></td><td><pre> * by setting the node in the udp stack and link it to the ipv4 object</pre></td></tr><tr><td data-num="4"></td><td><pre> * present in the node along with the socket factory</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token class-name">UdpL4Protocol</span><span class="token double-colon punctuation">::</span><span class="token function">NotifyNewAggregate</span> <span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  Ptr<span class="token operator">&lt;</span>Node<span class="token operator">></span> node <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-></span><span class="token generic-function"><span class="token function">GetObject</span><span class="token generic class-name"><span class="token operator">&lt;</span>Node<span class="token operator">></span></span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  Ptr<span class="token operator">&lt;</span>Ipv4<span class="token operator">></span> ipv4 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-></span><span class="token generic-function"><span class="token function">GetObject</span><span class="token generic class-name"><span class="token operator">&lt;</span>Ipv4<span class="token operator">></span></span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  Ptr<span class="token operator">&lt;</span>Ipv6<span class="token operator">></span> ipv6 <span class="token operator">=</span> node<span class="token operator">-></span><span class="token generic-function"><span class="token function">GetObject</span><span class="token generic class-name"><span class="token operator">&lt;</span>Ipv6<span class="token operator">></span></span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_node <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>node <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ipv4 <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> ipv6 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          <span class="token keyword">this</span><span class="token operator">-></span><span class="token function">SetNode</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>          Ptr<span class="token operator">&lt;</span>UdpSocketFactoryImpl<span class="token operator">></span> udpFactory <span class="token operator">=</span> <span class="token generic-function"><span class="token function">CreateObject</span><span class="token generic class-name"><span class="token operator">&lt;</span>UdpSocketFactoryImpl<span class="token operator">></span></span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>          udpFactory<span class="token operator">-></span><span class="token function">SetUdp</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>          node<span class="token operator">-></span><span class="token function">AggregateObject</span> <span class="token punctuation">(</span>udpFactory<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token comment">// We set at least one of our 2 down targets to the IPv4/IPv6 send</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token comment">// functions.  Since these functions have different prototypes, we</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token comment">// need to keep track of whether we are connected to an IPv4 or</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token comment">// IPv6 lower layer and call the appropriate one.</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ipv4 <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> m_downTarget<span class="token punctuation">.</span><span class="token function">IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      ipv4<span class="token operator">-></span><span class="token function">Insert</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token keyword">this</span><span class="token operator">-></span><span class="token function">SetDownTarget</span> <span class="token punctuation">(</span><span class="token function">MakeCallback</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Ipv4<span class="token double-colon punctuation">::</span>Send<span class="token punctuation">,</span> ipv4<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ipv6 <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> m_downTarget6<span class="token punctuation">.</span><span class="token function">IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      ipv6<span class="token operator">-></span><span class="token function">Insert</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      <span class="token keyword">this</span><span class="token operator">-></span><span class="token function">SetDownTarget6</span> <span class="token punctuation">(</span><span class="token function">MakeCallback</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Ipv6<span class="token double-colon punctuation">::</span>Send<span class="token punctuation">,</span> ipv6<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token class-name">IpL4Protocol</span><span class="token double-colon punctuation">::</span><span class="token function">NotifyNewAggregate</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>所以实际调用的是 <code>Ipv4::Send</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">Send</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>Packet<span class="token operator">></span> packet<span class="token punctuation">,</span> Ipv4Address source<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                     Ipv4Address destination<span class="token punctuation">,</span> <span class="token keyword">uint8_t</span> protocol<span class="token punctuation">,</span> Ptr<span class="token operator">&lt;</span>Ipv4Route<span class="token operator">></span> route<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>是个虚函数，所以同样看其子类</p><p><img data-src="http://static.jluyeyu.com/article_images/ns3.32%20Ipv4%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB%E5%9B%BE.jpg" alt="Ipv4继承关系图"></p><p>这里我们也同样只看其中一个， <code>Ipv4L3Protocol</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Ipv4L3Protocol</span><span class="token double-colon punctuation">::</span><span class="token function">Send</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>Packet<span class="token operator">></span> packet<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="3"></td><td><pre>                      Ipv4Address source<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                      Ipv4Address destination<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                      <span class="token keyword">uint8_t</span> protocol<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                      Ptr<span class="token operator">&lt;</span>Ipv4Route<span class="token operator">></span> route<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> packet <span class="token operator">&lt;&lt;</span> source <span class="token operator">&lt;&lt;</span> destination <span class="token operator">&lt;&lt;</span> <span class="token keyword">uint32_t</span> <span class="token punctuation">(</span>protocol<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> route<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">bool</span> mayFragment <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token comment">// we need a copy of the packet with its tags in case we need to invoke recursion.</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  Ptr<span class="token operator">&lt;</span>Packet<span class="token operator">></span> pktCopyWithTags <span class="token operator">=</span> packet<span class="token operator">-></span><span class="token function">Copy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">uint8_t</span> ttl <span class="token operator">=</span> m_defaultTtl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  SocketIpTtlTag ipTtlTag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token keyword">bool</span> ipTtlTagFound <span class="token operator">=</span> packet<span class="token operator">-></span><span class="token function">RemovePacketTag</span> <span class="token punctuation">(</span>ipTtlTag<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ipTtlTagFound<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      ttl <span class="token operator">=</span> ipTtlTag<span class="token punctuation">.</span><span class="token function">GetTtl</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token keyword">uint8_t</span> tos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  SocketIpTosTag ipTosTag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token keyword">bool</span> ipTosTagFound <span class="token operator">=</span> packet<span class="token operator">-></span><span class="token function">RemovePacketTag</span> <span class="token punctuation">(</span>ipTosTag<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ipTosTagFound<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      tos <span class="token operator">=</span> ipTosTag<span class="token punctuation">.</span><span class="token function">GetTos</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token comment">// can construct the header here</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  Ipv4Header ipHeader <span class="token operator">=</span> <span class="token function">BuildHeader</span> <span class="token punctuation">(</span>source<span class="token punctuation">,</span> destination<span class="token punctuation">,</span> protocol<span class="token punctuation">,</span> packet<span class="token operator">-></span><span class="token function">GetSize</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ttl<span class="token punctuation">,</span> tos<span class="token punctuation">,</span> mayFragment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token comment">// Handle a few cases:</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token comment">// 1) packet is passed in with a route entry</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token comment">// 1a) packet is passed in with a route entry but route->GetGateway is not set (e.g., on-demand)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token comment">// 1b) packet is passed in with a route entry and valid gateway</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token comment">// 2) packet is passed without a route and packet is destined to limited broadcast address</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token comment">// 3) packet is passed without a route and packet is destined to a subnet-directed broadcast address</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token comment">// 4) packet is passed without a route, packet is not broadcast (e.g., a raw socket call, or ICMP)</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token comment">// 1) packet is passed in with route entry</span></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>      <span class="token comment">// 1a) route->GetGateway is not set (e.g., on-demand)</span></pre></td></tr><tr><td data-num="46"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>route<span class="token operator">-></span><span class="token function">GetGateway</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsInitialized</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>          <span class="token comment">// This could arise because the synchronous RouteOutput() call</span></pre></td></tr><tr><td data-num="49"></td><td><pre>          <span class="token comment">// returned to the transport protocol with a source address but</span></pre></td></tr><tr><td data-num="50"></td><td><pre>          <span class="token comment">// there was no next hop available yet (since a route may need</span></pre></td></tr><tr><td data-num="51"></td><td><pre>          <span class="token comment">// to be queried).</span></pre></td></tr><tr><td data-num="52"></td><td><pre>          <span class="token function">NS_FATAL_ERROR</span> <span class="token punctuation">(</span><span class="token string">"Ipv4L3Protocol::Send case 1a: packet passed with a route but the Gateway address is uninitialized. This case not yet implemented."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>      <span class="token comment">// 1b) with a valid gateway</span></pre></td></tr><tr><td data-num="56"></td><td><pre>      <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"Ipv4L3Protocol::Send case 1b:  passed in with route and valid gateway"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>      <span class="token keyword">int32_t</span> interface <span class="token operator">=</span> <span class="token function">GetInterfaceForDevice</span> <span class="token punctuation">(</span>route<span class="token operator">-></span><span class="token function">GetOutputDevice</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>      <span class="token function">m_sendOutgoingTrace</span> <span class="token punctuation">(</span>ipHeader<span class="token punctuation">,</span> packet<span class="token punctuation">,</span> interface<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>      <span class="token function">SendRealOut</span> <span class="token punctuation">(</span>route<span class="token punctuation">,</span> packet<span class="token operator">-></span><span class="token function">Copy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ipHeader<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre>  <span class="token comment">// 2) packet is destined to limited broadcast address or link-local multicast address</span></pre></td></tr><tr><td data-num="64"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>destination<span class="token punctuation">.</span><span class="token function">IsBroadcast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> destination<span class="token punctuation">.</span><span class="token function">IsLocalMulticast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>      <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"Ipv4L3Protocol::Send case 2:  limited broadcast - no route"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>      <span class="token keyword">uint32_t</span> ifaceIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>      <span class="token keyword">for</span> <span class="token punctuation">(</span>Ipv4InterfaceList<span class="token double-colon punctuation">::</span>iterator ifaceIter <span class="token operator">=</span> m_interfaces<span class="token punctuation">.</span><span class="token function">begin</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>           ifaceIter <span class="token operator">!=</span> m_interfaces<span class="token punctuation">.</span><span class="token function">end</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ifaceIter<span class="token operator">++</span><span class="token punctuation">,</span> ifaceIndex<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>          Ptr<span class="token operator">&lt;</span>Ipv4Interface<span class="token operator">></span> outInterface <span class="token operator">=</span> <span class="token operator">*</span>ifaceIter<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>          <span class="token comment">// ANY source matches any interface</span></pre></td></tr><tr><td data-num="73"></td><td><pre>          <span class="token keyword">bool</span> sendIt <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">IsAny</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>          <span class="token comment">// check if some specific address on outInterface matches</span></pre></td></tr><tr><td data-num="75"></td><td><pre>          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">!</span>sendIt <span class="token operator">&amp;&amp;</span> index <span class="token operator">&lt;</span> outInterface<span class="token operator">-></span><span class="token function">GetNAddresses</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="76"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>              <span class="token keyword">if</span> <span class="token punctuation">(</span>outInterface<span class="token operator">-></span><span class="token function">GetAddress</span> <span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetLocal</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> source<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="78"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>                  sendIt <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="82"></td><td><pre></pre></td></tr><tr><td data-num="83"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>sendIt<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="84"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>              <span class="token comment">// create a proxy route for this interface</span></pre></td></tr><tr><td data-num="86"></td><td><pre>              Ptr<span class="token operator">&lt;</span>Ipv4Route<span class="token operator">></span> route <span class="token operator">=</span> <span class="token generic-function"><span class="token function">Create</span><span class="token generic class-name"><span class="token operator">&lt;</span>Ipv4Route<span class="token operator">></span></span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>              route<span class="token operator">-></span><span class="token function">SetDestination</span> <span class="token punctuation">(</span>destination<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>              route<span class="token operator">-></span><span class="token function">SetGateway</span> <span class="token punctuation">(</span><span class="token class-name">Ipv4Address</span><span class="token double-colon punctuation">::</span><span class="token function">GetAny</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>              route<span class="token operator">-></span><span class="token function">SetSource</span> <span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>              route<span class="token operator">-></span><span class="token function">SetOutputDevice</span> <span class="token punctuation">(</span>outInterface<span class="token operator">-></span><span class="token function">GetDevice</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>              <span class="token function">DecreaseIdentification</span> <span class="token punctuation">(</span>source<span class="token punctuation">,</span> destination<span class="token punctuation">,</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>              <span class="token function">Send</span> <span class="token punctuation">(</span>pktCopyWithTags<span class="token punctuation">,</span> source<span class="token punctuation">,</span> destination<span class="token punctuation">,</span> protocol<span class="token punctuation">,</span> route<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="97"></td><td><pre></pre></td></tr><tr><td data-num="98"></td><td><pre>  <span class="token comment">// 3) check: packet is destined to a subnet-directed broadcast address</span></pre></td></tr><tr><td data-num="99"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span>Ipv4InterfaceList<span class="token double-colon punctuation">::</span>iterator ifaceIter <span class="token operator">=</span> m_interfaces<span class="token punctuation">.</span><span class="token function">begin</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>       ifaceIter <span class="token operator">!=</span> m_interfaces<span class="token punctuation">.</span><span class="token function">end</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ifaceIter<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="101"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>      Ptr<span class="token operator">&lt;</span>Ipv4Interface<span class="token operator">></span> outInterface <span class="token operator">=</span> <span class="token operator">*</span>ifaceIter<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>      <span class="token keyword">uint32_t</span> ifaceIndex <span class="token operator">=</span> <span class="token function">GetInterfaceForDevice</span> <span class="token punctuation">(</span>outInterface<span class="token operator">-></span><span class="token function">GetDevice</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token function">GetNAddresses</span> <span class="token punctuation">(</span>ifaceIndex<span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="105"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>          Ipv4InterfaceAddress ifAddr <span class="token operator">=</span> <span class="token function">GetAddress</span> <span class="token punctuation">(</span>ifaceIndex<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>          <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"Testing address "</span> <span class="token operator">&lt;&lt;</span> ifAddr<span class="token punctuation">.</span><span class="token function">GetLocal</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" with mask "</span> <span class="token operator">&lt;&lt;</span> ifAddr<span class="token punctuation">.</span><span class="token function">GetMask</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>destination<span class="token punctuation">.</span><span class="token function">IsSubnetDirectedBroadcast</span> <span class="token punctuation">(</span>ifAddr<span class="token punctuation">.</span><span class="token function">GetMask</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> </pre></td></tr><tr><td data-num="109"></td><td><pre>              destination<span class="token punctuation">.</span><span class="token function">CombineMask</span> <span class="token punctuation">(</span>ifAddr<span class="token punctuation">.</span><span class="token function">GetMask</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> ifAddr<span class="token punctuation">.</span><span class="token function">GetLocal</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CombineMask</span> <span class="token punctuation">(</span>ifAddr<span class="token punctuation">.</span><span class="token function">GetMask</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="110"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>              <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"Ipv4L3Protocol::Send case 3:  subnet directed bcast to "</span> <span class="token operator">&lt;&lt;</span> ifAddr<span class="token punctuation">.</span><span class="token function">GetLocal</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" - no route"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>              <span class="token comment">// create a proxy route for this interface</span></pre></td></tr><tr><td data-num="113"></td><td><pre>              Ptr<span class="token operator">&lt;</span>Ipv4Route<span class="token operator">></span> route <span class="token operator">=</span> <span class="token generic-function"><span class="token function">Create</span><span class="token generic class-name"><span class="token operator">&lt;</span>Ipv4Route<span class="token operator">></span></span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>              route<span class="token operator">-></span><span class="token function">SetDestination</span> <span class="token punctuation">(</span>destination<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>              route<span class="token operator">-></span><span class="token function">SetGateway</span> <span class="token punctuation">(</span><span class="token class-name">Ipv4Address</span><span class="token double-colon punctuation">::</span><span class="token function">GetAny</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>              route<span class="token operator">-></span><span class="token function">SetSource</span> <span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>              route<span class="token operator">-></span><span class="token function">SetOutputDevice</span> <span class="token punctuation">(</span>outInterface<span class="token operator">-></span><span class="token function">GetDevice</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>              <span class="token function">DecreaseIdentification</span> <span class="token punctuation">(</span>source<span class="token punctuation">,</span> destination<span class="token punctuation">,</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>              <span class="token function">Send</span> <span class="token punctuation">(</span>pktCopyWithTags<span class="token punctuation">,</span> source<span class="token punctuation">,</span> destination<span class="token punctuation">,</span> protocol<span class="token punctuation">,</span> route<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>              <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="124"></td><td><pre></pre></td></tr><tr><td data-num="125"></td><td><pre>  <span class="token comment">// 4) packet is not broadcast, and route is NULL (e.g., a raw socket call)</span></pre></td></tr><tr><td data-num="126"></td><td><pre>  <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"Ipv4L3Protocol::Send case 4:  not broadcast and passed in with no route "</span> <span class="token operator">&lt;&lt;</span> destination<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="127"></td><td><pre>  Socket<span class="token double-colon punctuation">::</span>SocketErrno errno_<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="128"></td><td><pre>  Ptr<span class="token operator">&lt;</span>NetDevice<span class="token operator">></span> <span class="token function">oif</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// unused for now</span></pre></td></tr><tr><td data-num="129"></td><td><pre>  Ptr<span class="token operator">&lt;</span>Ipv4Route<span class="token operator">></span> newRoute<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="130"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_routingProtocol <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="131"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="132"></td><td><pre>      newRoute <span class="token operator">=</span> m_routingProtocol<span class="token operator">-></span><span class="token function">RouteOutput</span> <span class="token punctuation">(</span>packet<span class="token punctuation">,</span> ipHeader<span class="token punctuation">,</span> oif<span class="token punctuation">,</span> errno_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="133"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="135"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="136"></td><td><pre>      <span class="token function">NS_LOG_ERROR</span> <span class="token punctuation">(</span><span class="token string">"Ipv4L3Protocol::Send: m_routingProtocol == 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="138"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>newRoute<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="139"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="140"></td><td><pre>      <span class="token function">DecreaseIdentification</span> <span class="token punctuation">(</span>source<span class="token punctuation">,</span> destination<span class="token punctuation">,</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="141"></td><td><pre>      <span class="token function">Send</span> <span class="token punctuation">(</span>pktCopyWithTags<span class="token punctuation">,</span> source<span class="token punctuation">,</span> destination<span class="token punctuation">,</span> protocol<span class="token punctuation">,</span> newRoute<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="142"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="143"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="144"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="145"></td><td><pre>      <span class="token function">NS_LOG_WARN</span> <span class="token punctuation">(</span><span class="token string">"No route to host.  Drop."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="146"></td><td><pre>      <span class="token function">m_dropTrace</span> <span class="token punctuation">(</span>ipHeader<span class="token punctuation">,</span> packet<span class="token punctuation">,</span> DROP_NO_ROUTE<span class="token punctuation">,</span> m_node<span class="token operator">-></span><span class="token generic-function"><span class="token function">GetObject</span><span class="token generic class-name"><span class="token operator">&lt;</span>Ipv4<span class="token operator">></span></span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="147"></td><td><pre>      <span class="token function">DecreaseIdentification</span> <span class="token punctuation">(</span>source<span class="token punctuation">,</span> destination<span class="token punctuation">,</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="148"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="149"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这个函数里对是否有 <code>route</code> 做了五种情况的区分。最终都会走到 <code>Ipv4L3Protocol::SendRealOut</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Ipv4L3Protocol</span><span class="token double-colon punctuation">::</span><span class="token function">SendRealOut</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>Ipv4Route<span class="token operator">></span> route<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                             Ptr<span class="token operator">&lt;</span>Packet<span class="token operator">></span> packet<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                             Ipv4Header <span class="token keyword">const</span> <span class="token operator">&amp;</span>ipHeader<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> route <span class="token operator">&lt;&lt;</span> packet <span class="token operator">&lt;&lt;</span> <span class="token operator">&amp;</span>ipHeader<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>route <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token function">NS_LOG_WARN</span> <span class="token punctuation">(</span><span class="token string">"No route to host.  Drop."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token function">m_dropTrace</span> <span class="token punctuation">(</span>ipHeader<span class="token punctuation">,</span> packet<span class="token punctuation">,</span> DROP_NO_ROUTE<span class="token punctuation">,</span> m_node<span class="token operator">-></span><span class="token generic-function"><span class="token function">GetObject</span><span class="token generic class-name"><span class="token operator">&lt;</span>Ipv4<span class="token operator">></span></span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  Ptr<span class="token operator">&lt;</span>NetDevice<span class="token operator">></span> outDev <span class="token operator">=</span> route<span class="token operator">-></span><span class="token function">GetOutputDevice</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">int32_t</span> interface <span class="token operator">=</span> <span class="token function">GetInterfaceForDevice</span> <span class="token punctuation">(</span>outDev<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>interface <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  Ptr<span class="token operator">&lt;</span>Ipv4Interface<span class="token operator">></span> outInterface <span class="token operator">=</span> <span class="token function">GetInterface</span> <span class="token punctuation">(</span>interface<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"Send via NetDevice ifIndex "</span> <span class="token operator">&lt;&lt;</span> outDev<span class="token operator">-></span><span class="token function">GetIfIndex</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" ipv4InterfaceIndex "</span> <span class="token operator">&lt;&lt;</span> interface<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>  Ipv4Address target<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  std<span class="token double-colon punctuation">::</span>string targetLabel<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token operator">-></span><span class="token function">GetGateway</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsAny</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      target <span class="token operator">=</span> ipHeader<span class="token punctuation">.</span><span class="token function">GetDestination</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      targetLabel <span class="token operator">=</span> <span class="token string">"destination"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      target <span class="token operator">=</span> route<span class="token operator">-></span><span class="token function">GetGateway</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      targetLabel <span class="token operator">=</span> <span class="token string">"gateway"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>outInterface<span class="token operator">-></span><span class="token function">IsUp</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"Send to "</span> <span class="token operator">&lt;&lt;</span> targetLabel <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span> packet<span class="token operator">-></span><span class="token function">GetSize</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> ipHeader<span class="token punctuation">.</span><span class="token function">GetSerializedSize</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> outInterface<span class="token operator">-></span><span class="token function">GetDevice</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetMtu</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>          std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>Ipv4PayloadHeaderPair<span class="token operator">></span> listFragments<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>          <span class="token function">DoFragmentation</span> <span class="token punctuation">(</span>packet<span class="token punctuation">,</span> ipHeader<span class="token punctuation">,</span> outInterface<span class="token operator">-></span><span class="token function">GetDevice</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetMtu</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> listFragments<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>          <span class="token keyword">for</span> <span class="token punctuation">(</span> std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>Ipv4PayloadHeaderPair<span class="token operator">></span><span class="token double-colon punctuation">::</span>iterator it <span class="token operator">=</span> listFragments<span class="token punctuation">.</span><span class="token function">begin</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> listFragments<span class="token punctuation">.</span><span class="token function">end</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it<span class="token operator">++</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>              <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"Sending fragment "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span><span class="token punctuation">(</span>it<span class="token operator">-></span>first<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>              <span class="token function">CallTxTrace</span> <span class="token punctuation">(</span>it<span class="token operator">-></span>second<span class="token punctuation">,</span> it<span class="token operator">-></span>first<span class="token punctuation">,</span> m_node<span class="token operator">-></span><span class="token generic-function"><span class="token function">GetObject</span><span class="token generic class-name"><span class="token operator">&lt;</span>Ipv4<span class="token operator">></span></span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> interface<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>              outInterface<span class="token operator">-></span><span class="token function">Send</span> <span class="token punctuation">(</span>it<span class="token operator">-></span>first<span class="token punctuation">,</span> it<span class="token operator">-></span>second<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>      <span class="token keyword">else</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>          <span class="token function">CallTxTrace</span> <span class="token punctuation">(</span>ipHeader<span class="token punctuation">,</span> packet<span class="token punctuation">,</span> m_node<span class="token operator">-></span><span class="token generic-function"><span class="token function">GetObject</span><span class="token generic class-name"><span class="token operator">&lt;</span>Ipv4<span class="token operator">></span></span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> interface<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>          outInterface<span class="token operator">-></span><span class="token function">Send</span> <span class="token punctuation">(</span>packet<span class="token punctuation">,</span> ipHeader<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>outInterface</code> 的类型是 <code>Ipv4Interface</code> ，所以下一步就是</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Ipv4Interface</span><span class="token double-colon punctuation">::</span><span class="token function">Send</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>Packet<span class="token operator">></span> p<span class="token punctuation">,</span> <span class="token keyword">const</span> Ipv4Header <span class="token operator">&amp;</span> hdr<span class="token punctuation">,</span> Ipv4Address dest<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>p <span class="token operator">&lt;&lt;</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IsUp</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token comment">// Check for a loopback device, if it's the case we don't pass through</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token comment">// traffic control layer</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token generic-function"><span class="token function">DynamicCast</span><span class="token generic class-name"><span class="token operator">&lt;</span>LoopbackNetDevice<span class="token operator">></span></span></span> <span class="token punctuation">(</span>m_device<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token comment">/// \todo additional checks needed here (such as whether multicast</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token comment">/// goes to loopback)?</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      p<span class="token operator">-></span><span class="token function">AddHeader</span> <span class="token punctuation">(</span>hdr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      m_device<span class="token operator">-></span><span class="token function">Send</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> m_device<span class="token operator">-></span><span class="token function">GetBroadcast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Ipv4L3Protocol<span class="token double-colon punctuation">::</span>PROT_NUMBER<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>m_tc <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token comment">// is this packet aimed at a local interface ?</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span>Ipv4InterfaceAddressListCI i <span class="token operator">=</span> m_ifaddrs<span class="token punctuation">.</span><span class="token function">begin</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">!=</span> m_ifaddrs<span class="token punctuation">.</span><span class="token function">end</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>dest <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token operator">*</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetLocal</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>          p<span class="token operator">-></span><span class="token function">AddHeader</span> <span class="token punctuation">(</span>hdr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>          m_tc<span class="token operator">-></span><span class="token function">Receive</span> <span class="token punctuation">(</span>m_device<span class="token punctuation">,</span> p<span class="token punctuation">,</span> Ipv4L3Protocol<span class="token double-colon punctuation">::</span>PROT_NUMBER<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                         m_device<span class="token operator">-></span><span class="token function">GetBroadcast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                         m_device<span class="token operator">-></span><span class="token function">GetBroadcast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                         NetDevice<span class="token double-colon punctuation">::</span>PACKET_HOST<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>          <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_device<span class="token operator">-></span><span class="token function">NeedsArp</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"Needs ARP"</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      Ptr<span class="token operator">&lt;</span>ArpL3Protocol<span class="token operator">></span> arp <span class="token operator">=</span> m_node<span class="token operator">-></span><span class="token generic-function"><span class="token function">GetObject</span><span class="token generic class-name"><span class="token operator">&lt;</span>ArpL3Protocol<span class="token operator">></span></span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>      Address hardwareDestination<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>      <span class="token keyword">bool</span> found <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>dest<span class="token punctuation">.</span><span class="token function">IsBroadcast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>          <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"All-network Broadcast"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>          hardwareDestination <span class="token operator">=</span> m_device<span class="token operator">-></span><span class="token function">GetBroadcast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>          found <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dest<span class="token punctuation">.</span><span class="token function">IsMulticast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>          <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"IsMulticast"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>          <span class="token function">NS_ASSERT_MSG</span> <span class="token punctuation">(</span>m_device<span class="token operator">-></span><span class="token function">IsMulticast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                         <span class="token string">"ArpIpv4Interface::SendTo (): Sending multicast packet over "</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                         <span class="token string">"non-multicast device"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>          hardwareDestination <span class="token operator">=</span> m_device<span class="token operator">-></span><span class="token function">GetMulticast</span> <span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>          found <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>      <span class="token keyword">else</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>          <span class="token keyword">for</span> <span class="token punctuation">(</span>Ipv4InterfaceAddressListCI i <span class="token operator">=</span> m_ifaddrs<span class="token punctuation">.</span><span class="token function">begin</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">!=</span> m_ifaddrs<span class="token punctuation">.</span><span class="token function">end</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>              <span class="token keyword">if</span> <span class="token punctuation">(</span>dest<span class="token punctuation">.</span><span class="token function">IsSubnetDirectedBroadcast</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetMask</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>                  <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"Subnetwork Broadcast"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                  hardwareDestination <span class="token operator">=</span> m_device<span class="token operator">-></span><span class="token function">GetBroadcast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>                  found <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>                  <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>found<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="71"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>              <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"ARP Lookup"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>              found <span class="token operator">=</span> arp<span class="token operator">-></span><span class="token function">Lookup</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> hdr<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> m_device<span class="token punctuation">,</span> m_cache<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hardwareDestination<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre></pre></td></tr><tr><td data-num="77"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>found<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>          <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"Address Resolved.  Send."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>          m_tc<span class="token operator">-></span><span class="token function">Send</span> <span class="token punctuation">(</span>m_device<span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">Create</span><span class="token generic class-name"><span class="token operator">&lt;</span>Ipv4QueueDiscItem<span class="token operator">></span></span></span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> hardwareDestination<span class="token punctuation">,</span> Ipv4L3Protocol<span class="token double-colon punctuation">::</span>PROT_NUMBER<span class="token punctuation">,</span> hdr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="84"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>      <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"Doesn't need ARP"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>      m_tc<span class="token operator">-></span><span class="token function">Send</span> <span class="token punctuation">(</span>m_device<span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">Create</span><span class="token generic class-name"><span class="token operator">&lt;</span>Ipv4QueueDiscItem<span class="token operator">></span></span></span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> m_device<span class="token operator">-></span><span class="token function">GetBroadcast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Ipv4L3Protocol<span class="token double-colon punctuation">::</span>PROT_NUMBER<span class="token punctuation">,</span> hdr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>m_tc</code> 类型是 <code>Ipv4Interface</code> 的 <code>Send</code> 方法会做一些判断，广播，多播、子网广播、ARP 等，处理不同。 <code>m_tc</code> 对象就是 <code>TrafficControlLayer</code> 类对象。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">TrafficControlLayer</span><span class="token double-colon punctuation">::</span><span class="token function">Send</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>NetDevice<span class="token operator">></span> device<span class="token punctuation">,</span> Ptr<span class="token operator">&lt;</span>QueueDiscItem<span class="token operator">></span> item<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> device <span class="token operator">&lt;&lt;</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Send packet to device "</span> <span class="token operator">&lt;&lt;</span> device <span class="token operator">&lt;&lt;</span> <span class="token string">" protocol number "</span> <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                item<span class="token operator">-></span><span class="token function">GetProtocol</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  Ptr<span class="token operator">&lt;</span>NetDeviceQueueInterface<span class="token operator">></span> devQueueIface<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  std<span class="token double-colon punctuation">::</span>map<span class="token operator">&lt;</span>Ptr<span class="token operator">&lt;</span>NetDevice<span class="token operator">></span><span class="token punctuation">,</span> NetDeviceInfo<span class="token operator">></span><span class="token double-colon punctuation">::</span>iterator ndi <span class="token operator">=</span> m_netDevices<span class="token punctuation">.</span><span class="token function">find</span> <span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ndi <span class="token operator">!=</span> m_netDevices<span class="token punctuation">.</span><span class="token function">end</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      devQueueIface <span class="token operator">=</span> ndi<span class="token operator">-></span>second<span class="token punctuation">.</span>m_ndqi<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">// determine the transmission queue of the device where the packet will be enqueued</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  std<span class="token double-colon punctuation">::</span>size_t txq <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>devQueueIface <span class="token operator">&amp;&amp;</span> devQueueIface<span class="token operator">-></span><span class="token function">GetNTxQueues</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      txq <span class="token operator">=</span> devQueueIface<span class="token operator">-></span><span class="token function">GetSelectQueueCallback</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token comment">// otherwise, Linux determines the queue index by using a hash function</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token comment">// and associates such index to the socket which the packet belongs to,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token comment">// so that subsequent packets of the same socket will be mapped to the</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token comment">// same tx queue (__netdev_pick_tx function in net/core/dev.c). It is</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token comment">// pointless to implement this in ns-3 because currently the multi-queue</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token comment">// devices provide a select queue callback</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span><span class="token operator">!</span>devQueueIface <span class="token operator">||</span> txq <span class="token operator">&lt;</span> devQueueIface<span class="token operator">-></span><span class="token function">GetNTxQueues</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ndi <span class="token operator">==</span> m_netDevices<span class="token punctuation">.</span><span class="token function">end</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> ndi<span class="token operator">-></span>second<span class="token punctuation">.</span>m_rootQueueDisc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token comment">// The device has no attached queue disc, thus add the header to the packet and</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token comment">// send it directly to the device if the selected queue is not stopped</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>devQueueIface <span class="token operator">||</span> <span class="token operator">!</span>devQueueIface<span class="token operator">-></span><span class="token function">GetTxQueue</span> <span class="token punctuation">(</span>txq<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">IsStopped</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>          item<span class="token operator">-></span><span class="token function">AddHeader</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>          <span class="token comment">// a single queue device makes no use of the priority tag</span></pre></td></tr><tr><td data-num="40"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>devQueueIface <span class="token operator">||</span> devQueueIface<span class="token operator">-></span><span class="token function">GetNTxQueues</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>              SocketPriorityTag priorityTag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>              item<span class="token operator">-></span><span class="token function">GetPacket</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">RemovePacketTag</span> <span class="token punctuation">(</span>priorityTag<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>          device<span class="token operator">-></span><span class="token function">Send</span> <span class="token punctuation">(</span>item<span class="token operator">-></span><span class="token function">GetPacket</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> item<span class="token operator">-></span><span class="token function">GetAddress</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> item<span class="token operator">-></span><span class="token function">GetProtocol</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>      <span class="token comment">// Enqueue the packet in the queue disc associated with the netdevice queue</span></pre></td></tr><tr><td data-num="51"></td><td><pre>      <span class="token comment">// selected for the packet and try to dequeue packets from such queue disc</span></pre></td></tr><tr><td data-num="52"></td><td><pre>      item<span class="token operator">-></span><span class="token function">SetTxQueueIndex</span> <span class="token punctuation">(</span>txq<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre>      Ptr<span class="token operator">&lt;</span>QueueDisc<span class="token operator">></span> qDisc <span class="token operator">=</span> ndi<span class="token operator">-></span>second<span class="token punctuation">.</span>m_queueDiscsToWake<span class="token punctuation">[</span>txq<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>      <span class="token function">NS_ASSERT</span> <span class="token punctuation">(</span>qDisc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>      qDisc<span class="token operator">-></span><span class="token function">Enqueue</span> <span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>      qDisc<span class="token operator">-></span><span class="token function">Run</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>TrafficControlLayer::Send</code> 方法会通过 <code>device-&gt;Send</code> 发送 <code>packet</code> 。<br>其中的 <code>device</code> 对象就是 <code>WiFiNetDevice</code> 对象。</p><p>由此，完成了 <code>packet</code> 从 <code>socket</code> 对象到 <code>netdevice</code> 的发送过程。之后就是上一节的内容了</p><h4 id="发送过程流程图"><a class="anchor" href="#发送过程流程图">#</a> 发送过程流程图</h4><p><img data-src="http://static.jluyeyu.com/article_images/Socket%E5%88%B0WifiNetDevice%E7%9A%84%E8%BF%87%E7%A8%8B.jpg" alt="发送过程流程图"></p><h3 id="接收过程分析"><a class="anchor" href="#接收过程分析">#</a> 接收过程分析</h3><p>首先回到上节描述的 <code>WifiNetDevice::ForwardUp</code> ：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">WifiNetDevice</span><span class="token double-colon punctuation">::</span><span class="token function">ForwardUp</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> Packet<span class="token operator">></span> packet<span class="token punctuation">,</span> Mac48Address from<span class="token punctuation">,</span> Mac48Address to<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> packet <span class="token operator">&lt;&lt;</span> from <span class="token operator">&lt;&lt;</span> to<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  LlcSnapHeader llc<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  NetDevice<span class="token double-colon punctuation">::</span>PacketType type<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>to<span class="token punctuation">.</span><span class="token function">IsBroadcast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      type <span class="token operator">=</span> NetDevice<span class="token double-colon punctuation">::</span>PACKET_BROADCAST<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>to<span class="token punctuation">.</span><span class="token function">IsGroup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      type <span class="token operator">=</span> NetDevice<span class="token double-colon punctuation">::</span>PACKET_MULTICAST<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>to <span class="token operator">==</span> m_mac<span class="token operator">-></span><span class="token function">GetAddress</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      type <span class="token operator">=</span> NetDevice<span class="token double-colon punctuation">::</span>PACKET_HOST<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      type <span class="token operator">=</span> NetDevice<span class="token double-colon punctuation">::</span>PACKET_OTHERHOST<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>  Ptr<span class="token operator">&lt;</span>Packet<span class="token operator">></span> copy <span class="token operator">=</span> packet<span class="token operator">-></span><span class="token function">Copy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">!=</span> NetDevice<span class="token double-colon punctuation">::</span>PACKET_OTHERHOST<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      m_mac<span class="token operator">-></span><span class="token function">NotifyRx</span> <span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      copy<span class="token operator">-></span><span class="token function">RemoveHeader</span> <span class="token punctuation">(</span>llc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      <span class="token function">m_forwardUp</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> copy<span class="token punctuation">,</span> llc<span class="token punctuation">.</span><span class="token function">GetType</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      copy<span class="token operator">-></span><span class="token function">RemoveHeader</span> <span class="token punctuation">(</span>llc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_promiscRx<span class="token punctuation">.</span><span class="token function">IsNull</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      m_mac<span class="token operator">-></span><span class="token function">NotifyPromiscRx</span> <span class="token punctuation">(</span>copy<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token function">m_promiscRx</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> copy<span class="token punctuation">,</span> llc<span class="token punctuation">.</span><span class="token function">GetType</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> from<span class="token punctuation">,</span> to<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这里主要是两个回调，一个是 <code>m_forwardUp</code> ，另一个是 <code>m_promiscRx</code> 。</p><p><code>m_forwardUp</code> 的设置是在 <code>Node.cc</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">uint32_t</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Node</span><span class="token double-colon punctuation">::</span><span class="token function">AddDevice</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>NetDevice<span class="token operator">></span> device<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> device<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">uint32_t</span> index <span class="token operator">=</span> m_devices<span class="token punctuation">.</span><span class="token function">size</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  m_devices<span class="token punctuation">.</span><span class="token function">push_back</span> <span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  device<span class="token operator">-></span><span class="token function">SetNode</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  device<span class="token operator">-></span><span class="token function">SetIfIndex</span> <span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  device<span class="token operator">-></span><span class="token function">SetReceiveCallback</span> <span class="token punctuation">(</span><span class="token function">MakeCallback</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Node<span class="token double-colon punctuation">::</span>NonPromiscReceiveFromDevice<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">ScheduleWithContext</span> <span class="token punctuation">(</span><span class="token function">GetId</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Seconds</span> <span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="11"></td><td><pre>                                  <span class="token operator">&amp;</span>NetDevice<span class="token double-colon punctuation">::</span>Initialize<span class="token punctuation">,</span> device<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token function">NotifyDeviceAdded</span> <span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">return</span> index<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>所以实际调用的是 <code>Node::NonPromiscReceiveFromDevice</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">bool</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Node</span><span class="token double-colon punctuation">::</span><span class="token function">NonPromiscReceiveFromDevice</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>NetDevice<span class="token operator">></span> device<span class="token punctuation">,</span> Ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> Packet<span class="token operator">></span> packet<span class="token punctuation">,</span> <span class="token keyword">uint16_t</span> protocol<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                                   <span class="token keyword">const</span> Address <span class="token operator">&amp;</span>from<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> device <span class="token operator">&lt;&lt;</span> packet <span class="token operator">&lt;&lt;</span> protocol <span class="token operator">&lt;&lt;</span> <span class="token operator">&amp;</span>from<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token keyword">return</span> <span class="token function">ReceiveFromDevice</span> <span class="token punctuation">(</span>device<span class="token punctuation">,</span> packet<span class="token punctuation">,</span> protocol<span class="token punctuation">,</span> from<span class="token punctuation">,</span> device<span class="token operator">-></span><span class="token function">GetAddress</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">NetDevice</span><span class="token double-colon punctuation">::</span><span class="token function">PacketType</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">bool</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token class-name">Node</span><span class="token double-colon punctuation">::</span><span class="token function">ReceiveFromDevice</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>NetDevice<span class="token operator">></span> device<span class="token punctuation">,</span> Ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> Packet<span class="token operator">></span> packet<span class="token punctuation">,</span> <span class="token keyword">uint16_t</span> protocol<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                         <span class="token keyword">const</span> Address <span class="token operator">&amp;</span>from<span class="token punctuation">,</span> <span class="token keyword">const</span> Address <span class="token operator">&amp;</span>to<span class="token punctuation">,</span> NetDevice<span class="token double-colon punctuation">::</span>PacketType packetType<span class="token punctuation">,</span> <span class="token keyword">bool</span> promiscuous<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> device <span class="token operator">&lt;&lt;</span> packet <span class="token operator">&lt;&lt;</span> protocol <span class="token operator">&lt;&lt;</span> <span class="token operator">&amp;</span>from <span class="token operator">&lt;&lt;</span> <span class="token operator">&amp;</span>to <span class="token operator">&lt;&lt;</span> packetType <span class="token operator">&lt;&lt;</span> promiscuous<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token function">NS_ASSERT_MSG</span> <span class="token punctuation">(</span><span class="token class-name">Simulator</span><span class="token double-colon punctuation">::</span><span class="token function">GetContext</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">GetId</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Received packet with erroneous context ; "</span> <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                 <span class="token string">"make sure the channels in use are correctly updating events context "</span> <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                 <span class="token string">"when transferring events from one node to another."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Node "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">GetId</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" ReceiveFromDevice:  dev "</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                        <span class="token operator">&lt;&lt;</span> device<span class="token operator">-></span><span class="token function">GetIfIndex</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" (type="</span> <span class="token operator">&lt;&lt;</span> device<span class="token operator">-></span><span class="token function">GetInstanceTypeId</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetName</span> <span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                        <span class="token operator">&lt;&lt;</span> <span class="token string">") Packet UID "</span> <span class="token operator">&lt;&lt;</span> packet<span class="token operator">-></span><span class="token function">GetUid</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">bool</span> found <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span>ProtocolHandlerList<span class="token double-colon punctuation">::</span>iterator i <span class="token operator">=</span> m_handlers<span class="token punctuation">.</span><span class="token function">begin</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>       i <span class="token operator">!=</span> m_handlers<span class="token punctuation">.</span><span class="token function">end</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token operator">-></span>device <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span></pre></td></tr><tr><td data-num="27"></td><td><pre>          <span class="token punctuation">(</span>i<span class="token operator">-></span>device <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> i<span class="token operator">-></span>device <span class="token operator">==</span> device<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token operator">-></span>protocol <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> </pre></td></tr><tr><td data-num="30"></td><td><pre>              i<span class="token operator">-></span>protocol <span class="token operator">==</span> protocol<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>              <span class="token keyword">if</span> <span class="token punctuation">(</span>promiscuous <span class="token operator">==</span> i<span class="token operator">-></span>promiscuous<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                  i<span class="token operator">-></span><span class="token function">handler</span> <span class="token punctuation">(</span>device<span class="token punctuation">,</span> packet<span class="token punctuation">,</span> protocol<span class="token punctuation">,</span> from<span class="token punctuation">,</span> to<span class="token punctuation">,</span> packetType<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                  found <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token keyword">return</span> found<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>Node::NonPromiscReceiveFromDevice</code> 方法调用 <code>Node::ReceiveFromDevice</code> 方法，方法内部会循环判断是否是合适的处理 <code>packet</code> 的协议，如果有， <code>found</code> 为 <code>true</code> ，则就有由协议来处理 <code>packet</code> 。</p><p><code>m_handlers</code> 的值是通过 <code>Node::RegisterProtocolHandler</code> 方法设置的。代码如下：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Node</span><span class="token double-colon punctuation">::</span><span class="token function">RegisterProtocolHandler</span> <span class="token punctuation">(</span>ProtocolHandler handler<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="3"></td><td><pre>                               <span class="token keyword">uint16_t</span> protocolType<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                               Ptr<span class="token operator">&lt;</span>NetDevice<span class="token operator">></span> device<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                               <span class="token keyword">bool</span> promiscuous<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">&amp;</span>handler <span class="token operator">&lt;&lt;</span> protocolType <span class="token operator">&lt;&lt;</span> device <span class="token operator">&lt;&lt;</span> promiscuous<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token operator">:</span><span class="token base-clause"><span class="token operator">:</span><span class="token class-name">ProtocolHandlerEntry</span> <span class="token class-name">entry</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  entry<span class="token punctuation">.</span>handler <span class="token operator">=</span> handler<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  entry<span class="token punctuation">.</span>protocol <span class="token operator">=</span> protocolType<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  entry<span class="token punctuation">.</span>device <span class="token operator">=</span> device<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  entry<span class="token punctuation">.</span>promiscuous <span class="token operator">=</span> promiscuous<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">// On demand enable promiscuous mode in netdevices</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>promiscuous<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>device <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>          <span class="token keyword">for</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Ptr<span class="token operator">&lt;</span>NetDevice<span class="token operator">></span> <span class="token operator">></span><span class="token double-colon punctuation">::</span>iterator i <span class="token operator">=</span> m_devices<span class="token punctuation">.</span><span class="token function">begin</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>               i <span class="token operator">!=</span> m_devices<span class="token punctuation">.</span><span class="token function">end</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>              Ptr<span class="token operator">&lt;</span>NetDevice<span class="token operator">></span> dev <span class="token operator">=</span> <span class="token operator">*</span>i<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>              dev<span class="token operator">-></span><span class="token function">SetPromiscReceiveCallback</span> <span class="token punctuation">(</span><span class="token function">MakeCallback</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Node<span class="token double-colon punctuation">::</span>PromiscReceiveFromDevice<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token keyword">else</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>          device<span class="token operator">-></span><span class="token function">SetPromiscReceiveCallback</span> <span class="token punctuation">(</span><span class="token function">MakeCallback</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Node<span class="token double-colon punctuation">::</span>PromiscReceiveFromDevice<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>  m_handlers<span class="token punctuation">.</span><span class="token function">push_back</span> <span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>通过全局搜索的话，调用 <code>Node::RegisterProtocolHandler</code> 方法的地方有很多，但总的来说都是根据配置的协议来选择的，这里我们以 <code>TrafficControlLayer::Receive</code> 为例。</p><p><img data-src="http://static.jluyeyu.com/article_images/RegisterProtocolHandler%E8%B0%83%E7%94%A8.jpg" alt="调用方式"></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">TrafficControlLayer</span><span class="token double-colon punctuation">::</span><span class="token function">Receive</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>NetDevice<span class="token operator">></span> device<span class="token punctuation">,</span> Ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> Packet<span class="token operator">></span> p<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                              <span class="token keyword">uint16_t</span> protocol<span class="token punctuation">,</span> <span class="token keyword">const</span> Address <span class="token operator">&amp;</span>from<span class="token punctuation">,</span> <span class="token keyword">const</span> Address <span class="token operator">&amp;</span>to<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                              NetDevice<span class="token double-colon punctuation">::</span>PacketType packetType<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> device <span class="token operator">&lt;&lt;</span> p <span class="token operator">&lt;&lt;</span> protocol <span class="token operator">&lt;&lt;</span> from <span class="token operator">&lt;&lt;</span> to <span class="token operator">&lt;&lt;</span> packetType<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">bool</span> found <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span>ProtocolHandlerList<span class="token double-colon punctuation">::</span>iterator i <span class="token operator">=</span> m_handlers<span class="token punctuation">.</span><span class="token function">begin</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>       i <span class="token operator">!=</span> m_handlers<span class="token punctuation">.</span><span class="token function">end</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token operator">-></span>device <span class="token operator">==</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="14"></td><td><pre>          <span class="token operator">||</span> <span class="token punctuation">(</span>i<span class="token operator">-></span>device <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> i<span class="token operator">-></span>device <span class="token operator">==</span> device<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token operator">-></span>protocol <span class="token operator">==</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="17"></td><td><pre>              <span class="token operator">||</span> i<span class="token operator">-></span>protocol <span class="token operator">==</span> protocol<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>              <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Found handler for packet "</span> <span class="token operator">&lt;&lt;</span> p <span class="token operator">&lt;&lt;</span> <span class="token string">", protocol "</span> <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                            protocol <span class="token operator">&lt;&lt;</span> <span class="token string">" and NetDevice "</span> <span class="token operator">&lt;&lt;</span> device <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                            <span class="token string">". Send packet up"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>              i<span class="token operator">-></span><span class="token function">handler</span> <span class="token punctuation">(</span>device<span class="token punctuation">,</span> p<span class="token punctuation">,</span> protocol<span class="token punctuation">,</span> from<span class="token punctuation">,</span> to<span class="token punctuation">,</span> packetType<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>              found <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token function">NS_ABORT_MSG_IF</span> <span class="token punctuation">(</span><span class="token operator">!</span>found<span class="token punctuation">,</span> <span class="token string">"Handler for protocol "</span> <span class="token operator">&lt;&lt;</span> p <span class="token operator">&lt;&lt;</span> <span class="token string">" and device "</span> <span class="token operator">&lt;&lt;</span> device <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                           <span class="token string">" not found. It isn't forwarded up; it dies here."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这里也涉及到一个 <code>m_handlers</code></p><p>其设置方式为 <code>TrafficControlLayer::RegisterProtocolHandler</code></p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">TrafficControlLayer</span><span class="token double-colon punctuation">::</span><span class="token function">RegisterProtocolHandler</span> <span class="token punctuation">(</span>Node<span class="token double-colon punctuation">::</span>ProtocolHandler handler<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                                              <span class="token keyword">uint16_t</span> protocolType<span class="token punctuation">,</span> Ptr<span class="token operator">&lt;</span>NetDevice<span class="token operator">></span> device<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> protocolType <span class="token operator">&lt;&lt;</span> device<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">ProtocolHandlerEntry</span> entry<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  entry<span class="token punctuation">.</span>handler <span class="token operator">=</span> handler<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  entry<span class="token punctuation">.</span>protocol <span class="token operator">=</span> protocolType<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  entry<span class="token punctuation">.</span>device <span class="token operator">=</span> device<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  entry<span class="token punctuation">.</span>promiscuous <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  m_handlers<span class="token punctuation">.</span><span class="token function">push_back</span> <span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Handler for NetDevice: "</span> <span class="token operator">&lt;&lt;</span> device <span class="token operator">&lt;&lt;</span> <span class="token string">" registered for protocol "</span> <span class="token operator">&lt;&lt;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                protocolType <span class="token operator">&lt;&lt;</span> <span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>同样的，我们全局搜索该调用方式</p><p>可以看出主要是这两种调用方式</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>tc<span class="token operator">-></span><span class="token function">RegisterProtocolHandler</span> <span class="token punctuation">(</span><span class="token function">MakeCallback</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Ipv4L3Protocol<span class="token double-colon punctuation">::</span>Receive<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                               Ipv4L3Protocol<span class="token double-colon punctuation">::</span>PROT_NUMBER<span class="token punctuation">,</span> device<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  tc<span class="token operator">-></span><span class="token function">RegisterProtocolHandler</span> <span class="token punctuation">(</span><span class="token function">MakeCallback</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>ArpL3Protocol<span class="token double-colon punctuation">::</span>Receive<span class="token punctuation">,</span> <span class="token function">PeekPointer</span> <span class="token punctuation">(</span><span class="token generic-function"><span class="token function">GetObject</span><span class="token generic class-name"><span class="token operator">&lt;</span>ArpL3Protocol<span class="token operator">></span></span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                               ArpL3Protocol<span class="token double-colon punctuation">::</span>PROT_NUMBER<span class="token punctuation">,</span> device<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>具体执行哪里，要看使用的协议。对于 <code>packet</code> 数据包来说，处理起来就是 <code>Ipv4L3Protocol::Receive</code> ，如果使用到了 <code>ARP</code> 协议，处理起来就是 <code>ArpL3Protocol::Receive</code> 。</p><p>这里以 <code>Ipv4L3Protocol::Receive</code> 为例说明。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Ipv4L3Protocol</span><span class="token double-colon punctuation">::</span><span class="token function">Receive</span> <span class="token punctuation">(</span> Ptr<span class="token operator">&lt;</span>NetDevice<span class="token operator">></span> device<span class="token punctuation">,</span> Ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> Packet<span class="token operator">></span> p<span class="token punctuation">,</span> <span class="token keyword">uint16_t</span> protocol<span class="token punctuation">,</span> <span class="token keyword">const</span> Address <span class="token operator">&amp;</span>from<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                          <span class="token keyword">const</span> Address <span class="token operator">&amp;</span>to<span class="token punctuation">,</span> NetDevice<span class="token double-colon punctuation">::</span>PacketType packetType<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> device <span class="token operator">&lt;&lt;</span> p <span class="token operator">&lt;&lt;</span> protocol <span class="token operator">&lt;&lt;</span> from <span class="token operator">&lt;&lt;</span> to <span class="token operator">&lt;&lt;</span> packetType<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"Packet from "</span> <span class="token operator">&lt;&lt;</span> from <span class="token operator">&lt;&lt;</span> <span class="token string">" received on node "</span> <span class="token operator">&lt;&lt;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre>                m_node<span class="token operator">-></span><span class="token function">GetId</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">int32_t</span> interface <span class="token operator">=</span> <span class="token function">GetInterfaceForDevice</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token function">NS_ASSERT_MSG</span> <span class="token punctuation">(</span>interface <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Received a packet from an interface that is not known to IPv4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  Ptr<span class="token operator">&lt;</span>Packet<span class="token operator">></span> packet <span class="token operator">=</span> p<span class="token operator">-></span><span class="token function">Copy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  Ptr<span class="token operator">&lt;</span>Ipv4Interface<span class="token operator">></span> ipv4Interface <span class="token operator">=</span> m_interfaces<span class="token punctuation">[</span>interface<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ipv4Interface<span class="token operator">-></span><span class="token function">IsUp</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token function">m_rxTrace</span> <span class="token punctuation">(</span>packet<span class="token punctuation">,</span> m_node<span class="token operator">-></span><span class="token generic-function"><span class="token function">GetObject</span><span class="token generic class-name"><span class="token operator">&lt;</span>Ipv4<span class="token operator">></span></span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> interface<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"Dropping received packet -- interface is down"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      Ipv4Header ipHeader<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      packet<span class="token operator">-></span><span class="token function">RemoveHeader</span> <span class="token punctuation">(</span>ipHeader<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token function">m_dropTrace</span> <span class="token punctuation">(</span>ipHeader<span class="token punctuation">,</span> packet<span class="token punctuation">,</span> DROP_INTERFACE_DOWN<span class="token punctuation">,</span> m_node<span class="token operator">-></span><span class="token generic-function"><span class="token function">GetObject</span><span class="token generic class-name"><span class="token operator">&lt;</span>Ipv4<span class="token operator">></span></span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> interface<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>  Ipv4Header ipHeader<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token double-colon punctuation">::</span><span class="token function">ChecksumEnabled</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      ipHeader<span class="token punctuation">.</span><span class="token function">EnableChecksum</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  packet<span class="token operator">-></span><span class="token function">RemoveHeader</span> <span class="token punctuation">(</span>ipHeader<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token comment">// Trim any residual frame padding from underlying devices</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ipHeader<span class="token punctuation">.</span><span class="token function">GetPayloadSize</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> packet<span class="token operator">-></span><span class="token function">GetSize</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>      packet<span class="token operator">-></span><span class="token function">RemoveAtEnd</span> <span class="token punctuation">(</span>packet<span class="token operator">-></span><span class="token function">GetSize</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> ipHeader<span class="token punctuation">.</span><span class="token function">GetPayloadSize</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ipHeader<span class="token punctuation">.</span><span class="token function">IsChecksumOk</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>      <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"Dropping received packet -- checksum not ok"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>      <span class="token function">m_dropTrace</span> <span class="token punctuation">(</span>ipHeader<span class="token punctuation">,</span> packet<span class="token punctuation">,</span> DROP_BAD_CHECKSUM<span class="token punctuation">,</span> m_node<span class="token operator">-></span><span class="token generic-function"><span class="token function">GetObject</span><span class="token generic class-name"><span class="token operator">&lt;</span>Ipv4<span class="token operator">></span></span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> interface<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token comment">// the packet is valid, we update the ARP cache entry (if present)</span></pre></td></tr><tr><td data-num="52"></td><td><pre>  Ptr<span class="token operator">&lt;</span>ArpCache<span class="token operator">></span> arpCache <span class="token operator">=</span> ipv4Interface<span class="token operator">-></span><span class="token function">GetArpCache</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>arpCache<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>      <span class="token comment">// case one, it's a a direct routing.</span></pre></td></tr><tr><td data-num="56"></td><td><pre>      ArpCache<span class="token double-colon punctuation">::</span>Entry <span class="token operator">*</span>entry <span class="token operator">=</span> arpCache<span class="token operator">-></span><span class="token function">Lookup</span> <span class="token punctuation">(</span>ipHeader<span class="token punctuation">.</span><span class="token function">GetSource</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token operator">-></span><span class="token function">IsAlive</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="60"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>              entry<span class="token operator">-></span><span class="token function">UpdateSeen</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>      <span class="token keyword">else</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>          <span class="token comment">// It's not in the direct routing, so it's the router, and it could have multiple IP addresses.</span></pre></td></tr><tr><td data-num="67"></td><td><pre>          <span class="token comment">// In doubt, update all of them.</span></pre></td></tr><tr><td data-num="68"></td><td><pre>          <span class="token comment">// Note: it's a confirmed behavior for Linux routers.</span></pre></td></tr><tr><td data-num="69"></td><td><pre>          std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>ArpCache<span class="token double-colon punctuation">::</span>Entry <span class="token operator">*</span><span class="token operator">></span> entryList <span class="token operator">=</span> arpCache<span class="token operator">-></span><span class="token function">LookupInverse</span> <span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>          std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>ArpCache<span class="token double-colon punctuation">::</span>Entry <span class="token operator">*</span><span class="token operator">></span><span class="token double-colon punctuation">::</span>iterator iter<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>          <span class="token keyword">for</span> <span class="token punctuation">(</span>iter <span class="token operator">=</span> entryList<span class="token punctuation">.</span><span class="token function">begin</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iter <span class="token operator">!=</span> entryList<span class="token punctuation">.</span><span class="token function">end</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iter <span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="72"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>iter<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">IsAlive</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="74"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>                  <span class="token punctuation">(</span><span class="token operator">*</span>iter<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">UpdateSeen</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="80"></td><td><pre></pre></td></tr><tr><td data-num="81"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span>SocketList<span class="token double-colon punctuation">::</span>iterator i <span class="token operator">=</span> m_sockets<span class="token punctuation">.</span><span class="token function">begin</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">!=</span> m_sockets<span class="token punctuation">.</span><span class="token function">end</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>      <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"Forwarding to raw socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="84"></td><td><pre>      Ptr<span class="token operator">&lt;</span>Ipv4RawSocketImpl<span class="token operator">></span> socket <span class="token operator">=</span> <span class="token operator">*</span>i<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>      socket<span class="token operator">-></span><span class="token function">ForwardUp</span> <span class="token punctuation">(</span>packet<span class="token punctuation">,</span> ipHeader<span class="token punctuation">,</span> ipv4Interface<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="87"></td><td><pre></pre></td></tr><tr><td data-num="88"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_enableDpd <span class="token operator">&amp;&amp;</span> ipHeader<span class="token punctuation">.</span><span class="token function">GetDestination</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsMulticast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">UpdateDuplicate</span> <span class="token punctuation">(</span>packet<span class="token punctuation">,</span> ipHeader<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>      <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"Dropping received packet -- duplicate."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>      <span class="token function">m_dropTrace</span> <span class="token punctuation">(</span>ipHeader<span class="token punctuation">,</span> packet<span class="token punctuation">,</span> DROP_DUPLICATE<span class="token punctuation">,</span> m_node<span class="token operator">-></span><span class="token generic-function"><span class="token function">GetObject</span><span class="token generic class-name"><span class="token operator">&lt;</span>Ipv4<span class="token operator">></span></span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> interface<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="94"></td><td><pre></pre></td></tr><tr><td data-num="95"></td><td><pre>  <span class="token function">NS_ASSERT_MSG</span> <span class="token punctuation">(</span>m_routingProtocol <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Need a routing protocol object to process packets"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_routingProtocol<span class="token operator">-></span><span class="token function">RouteInput</span> <span class="token punctuation">(</span>packet<span class="token punctuation">,</span> ipHeader<span class="token punctuation">,</span> device<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="97"></td><td><pre>                                      <span class="token function">MakeCallback</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Ipv4L3Protocol<span class="token double-colon punctuation">::</span>IpForward<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="98"></td><td><pre>                                      <span class="token function">MakeCallback</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Ipv4L3Protocol<span class="token double-colon punctuation">::</span>IpMulticastForward<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="99"></td><td><pre>                                      <span class="token function">MakeCallback</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Ipv4L3Protocol<span class="token double-colon punctuation">::</span>LocalDeliver<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="100"></td><td><pre>                                      <span class="token function">MakeCallback</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Ipv4L3Protocol<span class="token double-colon punctuation">::</span>RouteInputError<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="101"></td><td><pre>                                      <span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="102"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>      <span class="token function">NS_LOG_WARN</span> <span class="token punctuation">(</span><span class="token string">"No route found for forwarding packet.  Drop."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>      <span class="token function">m_dropTrace</span> <span class="token punctuation">(</span>ipHeader<span class="token punctuation">,</span> packet<span class="token punctuation">,</span> DROP_NO_ROUTE<span class="token punctuation">,</span> m_node<span class="token operator">-></span><span class="token generic-function"><span class="token function">GetObject</span><span class="token generic class-name"><span class="token operator">&lt;</span>Ipv4<span class="token operator">></span></span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> interface<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="106"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在该函数中主要分两部分，如果 <code>m_sockets</code> 不为空的话，直接 <code>socket::ForwardUp</code> ，否则通过 <code>m_routingProtocol-&gt;RouteInput</code> 交付。 <code>m_routingProtocol</code> 类型是 <code>Ipv4RoutingProtocol</code> ，我们按照 <code>Ipv4RoutingProtocol::RouteInput</code> 进行探索。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">virtual</span> <span class="token keyword">bool</span> <span class="token function">RouteInput</span>  <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> Packet<span class="token operator">></span> p<span class="token punctuation">,</span> <span class="token keyword">const</span> Ipv4Header <span class="token operator">&amp;</span>header<span class="token punctuation">,</span> Ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> NetDevice<span class="token operator">></span> idev<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="2"></td><td><pre>                            UnicastForwardCallback ucb<span class="token punctuation">,</span> MulticastForwardCallback mcb<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                            LocalDeliverCallback lcb<span class="token punctuation">,</span> ErrorCallback ecb<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>其实现方式是由子类来决定。这涉及到路由协议的部分，会在今后的章节进行介绍。</p><p>但都会调用 <code>LocalDeliverCallback lcb</code> ，即 <code>LocalDeliver</code> 方法</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Ipv4L3Protocol</span><span class="token double-colon punctuation">::</span><span class="token function">LocalDeliver</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> Packet<span class="token operator">></span> packet<span class="token punctuation">,</span> Ipv4Header <span class="token keyword">const</span><span class="token operator">&amp;</span>ip<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> iif<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> packet <span class="token operator">&lt;&lt;</span> <span class="token operator">&amp;</span>ip <span class="token operator">&lt;&lt;</span> iif<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  Ptr<span class="token operator">&lt;</span>Packet<span class="token operator">></span> p <span class="token operator">=</span> packet<span class="token operator">-></span><span class="token function">Copy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// need to pass a non-const packet up</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  Ipv4Header ipHeader <span class="token operator">=</span> ip<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>ipHeader<span class="token punctuation">.</span><span class="token function">IsLastFragment</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> ipHeader<span class="token punctuation">.</span><span class="token function">GetFragmentOffset</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"Received a fragment, processing "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>p <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token keyword">bool</span> isPacketComplete<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      isPacketComplete <span class="token operator">=</span> <span class="token function">ProcessFragment</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> ipHeader<span class="token punctuation">,</span> iif<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span> isPacketComplete <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>          <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"Got last fragment, Packet is complete "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>p <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      ipHeader<span class="token punctuation">.</span><span class="token function">SetFragmentOffset</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      ipHeader<span class="token punctuation">.</span><span class="token function">SetPayloadSize</span> <span class="token punctuation">(</span>p<span class="token operator">-></span><span class="token function">GetSize</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token function">m_localDeliverTrace</span> <span class="token punctuation">(</span>ipHeader<span class="token punctuation">,</span> p<span class="token punctuation">,</span> iif<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>  Ptr<span class="token operator">&lt;</span>IpL4Protocol<span class="token operator">></span> protocol <span class="token operator">=</span> <span class="token function">GetProtocol</span> <span class="token punctuation">(</span>ipHeader<span class="token punctuation">.</span><span class="token function">GetProtocol</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iif<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>protocol <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token comment">// we need to make a copy in the unlikely event we hit the</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token comment">// RX_ENDPOINT_UNREACH codepath</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      Ptr<span class="token operator">&lt;</span>Packet<span class="token operator">></span> copy <span class="token operator">=</span> p<span class="token operator">-></span><span class="token function">Copy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token keyword">enum</span> <span class="token class-name">IpL4Protocol</span><span class="token double-colon punctuation">::</span>RxStatus status <span class="token operator">=</span> </pre></td></tr><tr><td data-num="31"></td><td><pre>        protocol<span class="token operator">-></span><span class="token function">Receive</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> ipHeader<span class="token punctuation">,</span> <span class="token function">GetInterface</span> <span class="token punctuation">(</span>iif<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token keyword">switch</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token keyword">case</span> IpL4Protocol<span class="token double-colon punctuation">::</span>RX_OK<span class="token operator">:</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token comment">// fall through</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token keyword">case</span> IpL4Protocol<span class="token double-colon punctuation">::</span>RX_ENDPOINT_CLOSED<span class="token operator">:</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token comment">// fall through</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token keyword">case</span> IpL4Protocol<span class="token double-colon punctuation">::</span>RX_CSUM_FAILED<span class="token operator">:</span></pre></td></tr><tr><td data-num="38"></td><td><pre>          <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token keyword">case</span> IpL4Protocol<span class="token double-colon punctuation">::</span>RX_ENDPOINT_UNREACH<span class="token operator">:</span></pre></td></tr><tr><td data-num="40"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>ipHeader<span class="token punctuation">.</span><span class="token function">GetDestination</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsBroadcast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">true</span> <span class="token operator">||</span></pre></td></tr><tr><td data-num="41"></td><td><pre>              ipHeader<span class="token punctuation">.</span><span class="token function">GetDestination</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsMulticast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>              <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// Do not reply to broadcast or multicast</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>          <span class="token comment">// Another case to suppress ICMP is a subnet-directed broadcast</span></pre></td></tr><tr><td data-num="46"></td><td><pre>          <span class="token keyword">bool</span> subnetDirected <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">GetNAddresses</span> <span class="token punctuation">(</span>iif<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>              Ipv4InterfaceAddress addr <span class="token operator">=</span> <span class="token function">GetAddress</span> <span class="token punctuation">(</span>iif<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>              <span class="token keyword">if</span> <span class="token punctuation">(</span>addr<span class="token punctuation">.</span><span class="token function">GetLocal</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CombineMask</span> <span class="token punctuation">(</span>addr<span class="token punctuation">.</span><span class="token function">GetMask</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> ipHeader<span class="token punctuation">.</span><span class="token function">GetDestination</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CombineMask</span> <span class="token punctuation">(</span>addr<span class="token punctuation">.</span><span class="token function">GetMask</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                  ipHeader<span class="token punctuation">.</span><span class="token function">GetDestination</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsSubnetDirectedBroadcast</span> <span class="token punctuation">(</span>addr<span class="token punctuation">.</span><span class="token function">GetMask</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                  subnetDirected <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>subnetDirected <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="57"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>              <span class="token function">GetIcmp</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">SendDestUnreachPort</span> <span class="token punctuation">(</span>ipHeader<span class="token punctuation">,</span> copy<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>其中关键的代码如下：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>Ptr<span class="token operator">&lt;</span>IpL4Protocol<span class="token operator">></span> protocol <span class="token operator">=</span> <span class="token function">GetProtocol</span> <span class="token punctuation">(</span>ipHeader<span class="token punctuation">.</span><span class="token function">GetProtocol</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iif<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>Ptr<span class="token operator">&lt;</span>Packet<span class="token operator">></span> copy <span class="token operator">=</span> p<span class="token operator">-></span><span class="token function">Copy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">enum</span> <span class="token class-name">IpL4Protocol</span><span class="token double-colon punctuation">::</span>RxStatus status <span class="token operator">=</span> protocol<span class="token operator">-></span><span class="token function">Receive</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> ipHeader<span class="token punctuation">,</span> <span class="token function">GetInterface</span> <span class="token punctuation">(</span>iif<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>其中的 <code>protocol</code> 就是根据头部协议号决定，这里我们考虑 <code>UDP</code> 协议，那么会执行 <code>UdpL4Protocol</code> 。会执行它的 <code>Receive</code> 方法。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">enum</span> <span class="token class-name">IpL4Protocol</span><span class="token double-colon punctuation">::</span>RxStatus</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">UdpL4Protocol</span><span class="token double-colon punctuation">::</span><span class="token function">Receive</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>Packet<span class="token operator">></span> packet<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                        Ipv4Header <span class="token keyword">const</span> <span class="token operator">&amp;</span>header<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                        Ptr<span class="token operator">&lt;</span>Ipv4Interface<span class="token operator">></span> interface<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> packet <span class="token operator">&lt;&lt;</span> header<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  UdpHeader udpHeader<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token double-colon punctuation">::</span><span class="token function">ChecksumEnabled</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      udpHeader<span class="token punctuation">.</span><span class="token function">EnableChecksums</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>  udpHeader<span class="token punctuation">.</span><span class="token function">InitializeChecksum</span> <span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">GetSource</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span><span class="token function">GetDestination</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> PROT_NUMBER<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token comment">// We only peek at the header for now (instead of removing it) so that it will be intact</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token comment">// if we have to pass it to a IPv6 endpoint via:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">// </span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token comment">//   UdpL4Protocol::Receive (Ptr&lt;Packet> packet, Ipv6Address &amp;src, Ipv6Address &amp;dst, ...)</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>  packet<span class="token operator">-></span><span class="token function">PeekHeader</span> <span class="token punctuation">(</span>udpHeader<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>udpHeader<span class="token punctuation">.</span><span class="token function">IsChecksumOk</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token function">NS_LOG_INFO</span> <span class="token punctuation">(</span><span class="token string">"Bad checksum : dropping packet!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token keyword">return</span> IpL4Protocol<span class="token double-colon punctuation">::</span>RX_CSUM_FAILED<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token function">NS_LOG_DEBUG</span> <span class="token punctuation">(</span><span class="token string">"Looking up dst "</span> <span class="token operator">&lt;&lt;</span> header<span class="token punctuation">.</span><span class="token function">GetDestination</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" port "</span> <span class="token operator">&lt;&lt;</span> udpHeader<span class="token punctuation">.</span><span class="token function">GetDestinationPort</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="29"></td><td><pre>  Ipv4EndPointDemux<span class="token double-colon punctuation">::</span>EndPoints endPoints <span class="token operator">=</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    m_endPoints<span class="token operator">-></span><span class="token function">Lookup</span> <span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">GetDestination</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> udpHeader<span class="token punctuation">.</span><span class="token function">GetDestinationPort</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                         header<span class="token punctuation">.</span><span class="token function">GetSource</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> udpHeader<span class="token punctuation">.</span><span class="token function">GetSourcePort</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> interface<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>endPoints<span class="token punctuation">.</span><span class="token function">empty</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span><span class="token generic-function"><span class="token function">GetObject</span><span class="token generic class-name"><span class="token operator">&lt;</span>Ipv6L3Protocol<span class="token operator">></span></span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>          <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"  No Ipv4 endpoints matched on UdpL4Protocol, trying Ipv6 "</span><span class="token operator">&lt;&lt;</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>          Ptr<span class="token operator">&lt;</span>Ipv6Interface<span class="token operator">></span> fakeInterface<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>          Ipv6Header ipv6Header<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>          Ipv6Address src <span class="token operator">=</span> <span class="token class-name">Ipv6Address</span><span class="token double-colon punctuation">::</span><span class="token function">MakeIpv4MappedAddress</span> <span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">GetSource</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>          Ipv6Address dst <span class="token operator">=</span> <span class="token class-name">Ipv6Address</span><span class="token double-colon punctuation">::</span><span class="token function">MakeIpv4MappedAddress</span> <span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">GetDestination</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>          ipv6Header<span class="token punctuation">.</span><span class="token function">SetSourceAddress</span> <span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>          ipv6Header<span class="token punctuation">.</span><span class="token function">SetDestinationAddress</span> <span class="token punctuation">(</span>dst<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>          <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span><span class="token function">Receive</span> <span class="token punctuation">(</span>packet<span class="token punctuation">,</span> ipv6Header<span class="token punctuation">,</span> fakeInterface<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>      <span class="token function">NS_LOG_LOGIC</span> <span class="token punctuation">(</span><span class="token string">"RX_ENDPOINT_UNREACH"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>      <span class="token keyword">return</span> IpL4Protocol<span class="token double-colon punctuation">::</span>RX_ENDPOINT_UNREACH<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>  packet<span class="token operator">-></span><span class="token function">RemoveHeader</span><span class="token punctuation">(</span>udpHeader<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span>Ipv4EndPointDemux<span class="token double-colon punctuation">::</span>EndPointsI endPoint <span class="token operator">=</span> endPoints<span class="token punctuation">.</span><span class="token function">begin</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>       endPoint <span class="token operator">!=</span> endPoints<span class="token punctuation">.</span><span class="token function">end</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> endPoint<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>      <span class="token punctuation">(</span><span class="token operator">*</span>endPoint<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ForwardUp</span> <span class="token punctuation">(</span>packet<span class="token operator">-></span><span class="token function">Copy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> header<span class="token punctuation">,</span> udpHeader<span class="token punctuation">.</span><span class="token function">GetSourcePort</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="55"></td><td><pre>                              interface<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token keyword">return</span> IpL4Protocol<span class="token double-colon punctuation">::</span>RX_OK<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>其中就会执行 <code>(*endPoint)-&gt;ForwardUp</code> 。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Ipv4EndPoint</span><span class="token double-colon punctuation">::</span><span class="token function">ForwardUp</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>Packet<span class="token operator">></span> p<span class="token punctuation">,</span> <span class="token keyword">const</span> Ipv4Header<span class="token operator">&amp;</span> header<span class="token punctuation">,</span> <span class="token keyword">uint16_t</span> sport<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                         Ptr<span class="token operator">&lt;</span>Ipv4Interface<span class="token operator">></span> incomingInterface<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> p <span class="token operator">&lt;&lt;</span> <span class="token operator">&amp;</span>header <span class="token operator">&lt;&lt;</span> sport <span class="token operator">&lt;&lt;</span> incomingInterface<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_rxCallback<span class="token punctuation">.</span><span class="token function">IsNull</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token function">m_rxCallback</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> header<span class="token punctuation">,</span> sport<span class="token punctuation">,</span> incomingInterface<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这里又是一个回调，其定义如下：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">UdpSocketImpl</span><span class="token double-colon punctuation">::</span><span class="token function">FinishBind</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">bool</span> done <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_endPoint <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      m_endPoint<span class="token operator">-></span><span class="token function">SetRxCallback</span> <span class="token punctuation">(</span><span class="token function">MakeCallback</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>UdpSocketImpl<span class="token double-colon punctuation">::</span>ForwardUp<span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">Ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>UdpSocketImpl<span class="token operator">></span></span></span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      m_endPoint<span class="token operator">-></span><span class="token function">SetIcmpCallback</span> <span class="token punctuation">(</span><span class="token function">MakeCallback</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>UdpSocketImpl<span class="token double-colon punctuation">::</span>ForwardIcmp<span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">Ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>UdpSocketImpl<span class="token operator">></span></span></span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      m_endPoint<span class="token operator">-></span><span class="token function">SetDestroyCallback</span> <span class="token punctuation">(</span><span class="token function">MakeCallback</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>UdpSocketImpl<span class="token double-colon punctuation">::</span>Destroy<span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">Ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>UdpSocketImpl<span class="token operator">></span></span></span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_endPoint6 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      m_endPoint6<span class="token operator">-></span><span class="token function">SetRxCallback</span> <span class="token punctuation">(</span><span class="token function">MakeCallback</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>UdpSocketImpl<span class="token double-colon punctuation">::</span>ForwardUp6<span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">Ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>UdpSocketImpl<span class="token operator">></span></span></span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      m_endPoint6<span class="token operator">-></span><span class="token function">SetIcmpCallback</span> <span class="token punctuation">(</span><span class="token function">MakeCallback</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>UdpSocketImpl<span class="token double-colon punctuation">::</span>ForwardIcmp6<span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">Ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>UdpSocketImpl<span class="token operator">></span></span></span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      m_endPoint6<span class="token operator">-></span><span class="token function">SetDestroyCallback</span> <span class="token punctuation">(</span><span class="token function">MakeCallback</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>UdpSocketImpl<span class="token double-colon punctuation">::</span>Destroy6<span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">Ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>UdpSocketImpl<span class="token operator">></span></span></span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>m_rxCallback</code> 也就是调用 <code>UdpSocketImpl::ForwardUp</code> ：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">UdpSocketImpl</span><span class="token double-colon punctuation">::</span><span class="token function">ForwardUp</span> <span class="token punctuation">(</span>Ptr<span class="token operator">&lt;</span>Packet<span class="token operator">></span> packet<span class="token punctuation">,</span> Ipv4Header header<span class="token punctuation">,</span> <span class="token keyword">uint16_t</span> port<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                          Ptr<span class="token operator">&lt;</span>Ipv4Interface<span class="token operator">></span> incomingInterface<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> packet <span class="token operator">&lt;&lt;</span> header <span class="token operator">&lt;&lt;</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>m_shutdownRecv<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token comment">// Should check via getsockopt ()..</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsRecvPktInfo</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      Ipv4PacketInfoTag tag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      packet<span class="token operator">-></span><span class="token function">RemovePacketTag</span> <span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      tag<span class="token punctuation">.</span><span class="token function">SetRecvIf</span> <span class="token punctuation">(</span>incomingInterface<span class="token operator">-></span><span class="token function">GetDevice</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetIfIndex</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      packet<span class="token operator">-></span><span class="token function">AddPacketTag</span> <span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token comment">//Check only version 4 options</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsIpRecvTos</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      SocketIpTosTag ipTosTag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      ipTosTag<span class="token punctuation">.</span><span class="token function">SetTos</span> <span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">GetTos</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      packet<span class="token operator">-></span><span class="token function">AddPacketTag</span> <span class="token punctuation">(</span>ipTosTag<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsIpRecvTtl</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      SocketIpTtlTag ipTtlTag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      ipTtlTag<span class="token punctuation">.</span><span class="token function">SetTtl</span> <span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">GetTtl</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      packet<span class="token operator">-></span><span class="token function">AddPacketTag</span> <span class="token punctuation">(</span>ipTtlTag<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token comment">// in case the packet still has a priority tag attached, remove it</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  SocketPriorityTag priorityTag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  packet<span class="token operator">-></span><span class="token function">RemovePacketTag</span> <span class="token punctuation">(</span>priorityTag<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m_rxAvailable <span class="token operator">+</span> packet<span class="token operator">-></span><span class="token function">GetSize</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> m_rcvBufSize<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>      Address address <span class="token operator">=</span> <span class="token function">InetSocketAddress</span> <span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">GetSource</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>      m_deliveryQueue<span class="token punctuation">.</span><span class="token function">push</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">make_pair</span> <span class="token punctuation">(</span>packet<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>      m_rxAvailable <span class="token operator">+=</span> packet<span class="token operator">-></span><span class="token function">GetSize</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>      <span class="token function">NotifyDataRecv</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>      <span class="token comment">// In general, this case should not occur unless the</span></pre></td></tr><tr><td data-num="50"></td><td><pre>      <span class="token comment">// receiving application reads data from this socket slowly</span></pre></td></tr><tr><td data-num="51"></td><td><pre>      <span class="token comment">// in comparison to the arrival rate</span></pre></td></tr><tr><td data-num="52"></td><td><pre>      <span class="token comment">//</span></pre></td></tr><tr><td data-num="53"></td><td><pre>      <span class="token comment">// drop and trace packet</span></pre></td></tr><tr><td data-num="54"></td><td><pre>      <span class="token function">NS_LOG_WARN</span> <span class="token punctuation">(</span><span class="token string">"No receive buffer space available.  Drop."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>      <span class="token function">m_dropTrace</span> <span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>然后调用 <code>NotifyDataRecv</code> 来实现到上层的数据传递</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Socket</span><span class="token double-colon punctuation">::</span><span class="token function">NotifyDataRecv</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">NS_LOG_FUNCTION</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_receivedData<span class="token punctuation">.</span><span class="token function">IsNull</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token function">m_receivedData</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="完整流程图示意"><a class="anchor" href="#完整流程图示意">#</a> 完整流程图示意</h3><p><img data-src="http://static.jluyeyu.com/article_images/ns3.32%20wifi%E6%A8%A1%E5%9D%97%E6%B5%81%E7%A8%8B%E5%9B%BEsocket%E5%AE%8C%E6%95%B4%E7%89%88.jpg" alt="完整流程图"></p><div class="tags"><a href="/tags/ns3/" rel="tag"><i class="ic i-tag"></i> ns3</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2023-02-16 15:50:57" itemprop="dateModified" datetime="2023-02-16T15:50:57+08:00">2023-02-16</time> </span><span id="ns3/12.ns3 wifi模块从Socket到WifiNetDevice/" class="item leancloud_visitors" data-flag-title="12.ns3 wifi 模块从 Socket 到 WifiNetDevice" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="jluyeyu 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="jluyeyu 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>jluyeyu <i class="ic i-at"><em>@</em></i>blog</li><li class="link"><strong>本文链接：</strong> <a href="http://jluyeyu.com/ns3/12.ns3%20wifi%E6%A8%A1%E5%9D%97%E4%BB%8ESocket%E5%88%B0WifiNetDevice/" title="12.ns3 wifi 模块从 Socket 到 WifiNetDevice">http://jluyeyu.com/ns3/12.ns3 wifi模块从Socket到WifiNetDevice/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/ns3/11.ns3%20wifi%E6%A8%A1%E5%9D%97%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;img.timelessq.com&#x2F;images&#x2F;2022&#x2F;07&#x2F;26&#x2F;3cff3fc776e129c36936b1cf83a34b68.jpg" title="11.ns3 wifi模块流程源码解析"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> ns3</span><h3>11.ns3 wifi模块流程源码解析</h3></a></div><div class="item right"><a href="/ns3/13.ns3%20Aqua-sim%20ng%E6%B0%B4%E5%A3%B0%E9%80%9A%E4%BF%A1%E6%A8%A1%E5%9D%97%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;img.timelessq.com&#x2F;images&#x2F;2022&#x2F;07&#x2F;26&#x2F;0a6be1d1fa7827fc28504c63a5a6d653.jpg" title="13.ns3 Aqua-sim ng水声通信模块源码解析"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> ns3</span><h3>13.ns3 Aqua-sim ng水声通信模块源码解析</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#12ns3-wifi%E6%A8%A1%E5%9D%97%E4%BB%8Esocket%E5%88%B0wifinetdevice"><span class="toc-number">1.</span> <span class="toc-text">12.ns3 wifi 模块从 Socket 到 WifiNetDevice</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">1.1.</span> <span class="toc-text">发送过程分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E8%BF%87%E7%A8%8B%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">1.1.1.</span> <span class="toc-text">发送过程流程图</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E6%94%B6%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">接收过程分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E5%9B%BE%E7%A4%BA%E6%84%8F"><span class="toc-number">1.3.</span> <span class="toc-text">完整流程图示意</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/ns3/0.ns3%E6%8E%A8%E8%8D%90%E8%B5%84%E6%96%99/" rel="bookmark" title="0.ns3推荐资料">0.ns3推荐资料</a></li><li><a href="/ns3/1.ns3%E5%88%9D%E8%AF%86/" rel="bookmark" title="1.ns3初识">1.ns3初识</a></li><li><a href="/ns3/2.ns3%E5%85%B3%E9%94%AE%E6%8A%BD%E8%B1%A1/" rel="bookmark" title="2.ns3关键抽象">2.ns3关键抽象</a></li><li><a href="/ns3/3.waf%E8%BF%90%E8%A1%8C%E5%91%BD%E4%BB%A4%E4%BB%A5%E5%8F%8A%E5%91%BD%E4%BB%A4%E8%A1%8C%E8%A7%A3%E6%9E%90%E7%9A%84%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/" rel="bookmark" title="3.waf运行命令以及命令行解析的使用说明">3.waf运行命令以及命令行解析的使用说明</a></li><li><a href="/ns3/4.%E4%BB%BF%E7%9C%9F%E6%B5%81%E7%A8%8B/" rel="bookmark" title="4.仿真流程">4.仿真流程</a></li><li><a href="/ns3/5.ns3%20wifi%E6%A8%A1%E5%9E%8B/" rel="bookmark" title="5.ns3 wifi模型">5.ns3 wifi模型</a></li><li><a href="/ns3/6.ns3%20wifi%20%E6%A8%A1%E5%9E%8B%E9%85%8D%E7%BD%AE/" rel="bookmark" title="6.wifi模型扩展">6.wifi模型扩展</a></li><li><a href="/ns3/7.ns3%20%E6%8D%9F%E5%A4%B1%E6%A8%A1%E5%9E%8B%E4%BF%AE%E6%94%B9/" rel="bookmark" title="7.ns3 损失模型修改">7.ns3 损失模型修改</a></li><li><a href="/ns3/8.ns3%20wifi%E8%AE%BE%E5%A4%87%E5%AE%9A%E5%90%91%E5%8F%91%E9%80%81%E7%9A%84%E5%AE%9E%E7%8E%B0/" rel="bookmark" title="8.ns3 wifi设备定向发送的实现">8.ns3 wifi设备定向发送的实现</a></li><li><a href="/ns3/9.ns3%20Config%E7%B1%BBAPI%E8%AF%B4%E6%98%8E/" rel="bookmark" title="9.ns3 Config类API说明">9.ns3 Config类API说明</a></li><li><a href="/ns3/10.ns3%20%E8%B7%AF%E7%94%B1%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%AE%9E%E4%BE%8B/" rel="bookmark" title="10.ns3 路由性能测试实例">10.ns3 路由性能测试实例</a></li><li><a href="/ns3/11.ns3%20wifi%E6%A8%A1%E5%9D%97%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" rel="bookmark" title="11.ns3 wifi模块流程源码解析">11.ns3 wifi模块流程源码解析</a></li><li class="active"><a href="/ns3/12.ns3%20wifi%E6%A8%A1%E5%9D%97%E4%BB%8ESocket%E5%88%B0WifiNetDevice/" rel="bookmark" title="12.ns3 wifi模块从Socket到WifiNetDevice">12.ns3 wifi模块从Socket到WifiNetDevice</a></li><li><a href="/ns3/13.ns3%20Aqua-sim%20ng%E6%B0%B4%E5%A3%B0%E9%80%9A%E4%BF%A1%E6%A8%A1%E5%9D%97%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" rel="bookmark" title="13.ns3 Aqua-sim ng水声通信模块源码解析">13.ns3 Aqua-sim ng水声通信模块源码解析</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="jluyeyu" data-src="/images/avatar.jpg"><p class="name" itemprop="name">jluyeyu</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">67</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">12</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">14</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL01lbW9yeU9mTG92ZQ==" title="https:&#x2F;&#x2F;github.com&#x2F;MemoryOfLove"><i class="ic i-github"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTEyNjE0OTAxOA==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;126149018"><i class="ic i-cloud-music"></i></span> <span class="exturl item about" data-url="aHR0cHM6Ly9hYm91dC5tZS9qbHV5ZXl1" title="https:&#x2F;&#x2F;about.me&#x2F;jluyeyu"><i class="ic i-address-card"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>friends</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/ns3/11.ns3%20wifi%E6%A8%A1%E5%9D%97%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/ns3/13.ns3%20Aqua-sim%20ng%E6%B0%B4%E5%A3%B0%E9%80%9A%E4%BF%A1%E6%A8%A1%E5%9D%97%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/javascript/" title="分类于 javascript">javascript</a></div><span><a href="/javascript/GA%20tracking/" title="在 React JS 应用程序中借助Google Tag Manager实现 Google Analytics">在 React JS 应用程序中借助Google Tag Manager实现 Google Analytics</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/interview/" title="分类于 interview">interview</a> <i class="ic i-angle-right"></i> <a href="/categories/interview/html/" title="分类于 html">html</a></div><span><a href="/interview/html/HTTP%E7%9A%84%E5%87%A0%E7%A7%8D%E5%B8%B8%E8%A7%81%E8%AF%B7%E6%B1%82%E6%96%B9%E6%B3%95%E7%94%A8%E9%80%94/" title="HTTP的几种常见请求方法用途">HTTP的几种常见请求方法用途</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/leetcode/" title="分类于 每日一题">每日一题</a></div><span><a href="/leetcode/846.%20%E4%B8%80%E6%89%8B%E9%A1%BA%E5%AD%90/" title="846. 一手顺子">846. 一手顺子</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/css/" title="分类于 css">css</a></div><span><a href="/css/css%20background/" title="css background">css background</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/project/" title="分类于 项目相关">项目相关</a> <i class="ic i-angle-right"></i> <a href="/categories/project/onlineResume/" title="分类于 在线简历生成">在线简历生成</a></div><span><a href="/project/onlineResume/3.%20%E9%A1%B9%E7%9B%AE%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" title="3. 项目环境搭建">3. 项目环境搭建</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ns3/" title="分类于 ns3">ns3</a></div><span><a href="/ns3/13.ns3%20Aqua-sim%20ng%E6%B0%B4%E5%A3%B0%E9%80%9A%E4%BF%A1%E6%A8%A1%E5%9D%97%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" title="13.ns3 Aqua-sim ng水声通信模块源码解析">13.ns3 Aqua-sim ng水声通信模块源码解析</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ns3/" title="分类于 ns3">ns3</a></div><span><a href="/ns3/3.waf%E8%BF%90%E8%A1%8C%E5%91%BD%E4%BB%A4%E4%BB%A5%E5%8F%8A%E5%91%BD%E4%BB%A4%E8%A1%8C%E8%A7%A3%E6%9E%90%E7%9A%84%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/" title="3.waf运行命令以及命令行解析的使用说明">3.waf运行命令以及命令行解析的使用说明</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/react/" title="分类于 react">react</a></div><span><a href="/react/create-react-app%E9%85%8D%E7%BD%AEless/" title="create-react-app配置less">create-react-app配置less</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/javascript/" title="分类于 javascript">javascript</a></div><span><a href="/javascript/%E6%8E%A8%E8%8D%90%E4%B8%80%E4%B8%AA%E5%89%8D%E7%AB%AFjs%E7%BB%83%E4%B9%A0%E7%BD%91%E7%AB%99/" title="抽象语法树ast初识">抽象语法树ast初识</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/leetcode/" title="分类于 每日一题">每日一题</a></div><span><a href="/leetcode/507.%20%E5%AE%8C%E7%BE%8E%E6%95%B0/" title="507. 完美数">507. 完美数</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">jluyeyu @ jluyeyu</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">438k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">6:38</span></div><div class="powered-by"><span class="exturl" data-url="aHR0cHM6Ly9iZWlhbi5taWl0Lmdvdi5jbi8=">辽ICP备2022000405号</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"ns3/12.ns3 wifi模块从Socket到WifiNetDevice/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script><script data-pjax>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?fd6200dc631128a08f631d890b15971b";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></body></html>