{
    "version": "https://jsonfeed.org/version/1",
    "title": "blog",
    "subtitle": "",
    "icon": "http://jluyeyu.com/images/favicon.ico",
    "description": "",
    "home_page_url": "http://jluyeyu.com",
    "items": [
        {
            "id": "http://jluyeyu.com/ns3/13.ns3%20Aqua-sim%20ng%E6%B0%B4%E5%A3%B0%E9%80%9A%E4%BF%A1%E6%A8%A1%E5%9D%97%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/",
            "url": "http://jluyeyu.com/ns3/13.ns3%20Aqua-sim%20ng%E6%B0%B4%E5%A3%B0%E9%80%9A%E4%BF%A1%E6%A8%A1%E5%9D%97%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/",
            "title": "13.ns3 Aqua-sim ng水声通信模块源码解析",
            "date_published": "2022-11-14T00:00:00.000Z",
            "content_html": "<h2 id=\"13ns3-aqua-sim-ng水声通信模块源码解析\"><a class=\"anchor\" href=\"#13ns3-aqua-sim-ng水声通信模块源码解析\">#</a> 13.ns3 Aqua-sim ng 水声通信模块源码解析</h2>\n<p>在本节中，将从源码的角度解析 <code>ns3</code>  的 <code>水声通信</code> 模块，这是一个 <code>ns3</code>  的扩展模块，和无线模块一样，我们首要关注的还是 <code>Packet</code>  的发送流程。包括一个 <code>packet</code>  是如何从一台主机的 <code>NetDevice</code>  到另一台主机的 <code>NetDevice</code> 。</p>\n<p>PS:</p>\n<ol>\n<li>\n<p>本节很长，而且很枯燥，但是对扩展 <code>ns3</code>  功能，了解 <code>ns3</code>  流程非常有帮助，请耐心观看。</p>\n</li>\n<li>\n<p>本节的源码来自于 <code>ns3.27</code> , 不同版本之间有一些差异，但大致流程差不多，可以互相参考。</p>\n</li>\n</ol>\n<h3 id=\"发送过程源码分析\"><a class=\"anchor\" href=\"#发送过程源码分析\">#</a> 发送过程源码分析</h3>\n<p>首先还是从 <code>NetDevice开始</code></p>\n<p><code>src/aqua-sim-ng/model/aqua-sim-net-device.h</code> ,</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">AquaSimNetDevice</span> <span class=\"token operator\">:</span> <span class=\"token base-clause\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">NetDevice</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">public</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">AquaSimNetDevice</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token operator\">~</span><span class=\"token function\">AquaSimNetDevice</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">static</span> TypeId <span class=\"token function\">GetTypeId</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">//attach</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">ConnectLayers</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">SetPhy</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>AquaSimPhy<span class=\"token operator\">></span> phy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">SetMac</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>AquaSimMac<span class=\"token operator\">></span> mac<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span>AquaSimSync<span class=\"token operator\">></span> sync <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span>AquaSimLocalization<span class=\"token operator\">></span> loc <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">SetRouting</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>AquaSimRouting<span class=\"token operator\">></span> routing<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">SetChannel</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>AquaSimChannel<span class=\"token operator\">></span> channel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">SetChannel</span> <span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span>Ptr<span class=\"token operator\">&lt;</span>AquaSimChannel<span class=\"token operator\">></span> <span class=\"token operator\">></span> channel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//for multi-channel support</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token comment\">//void SetApp (Ptr&lt;AquaSimApp> app);</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">SetEnergyModel</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>AquaSimEnergyModel<span class=\"token operator\">></span> energyModel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>AquaSimEnergyModel<span class=\"token operator\">></span> <span class=\"token function\">GetEnergyModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">SetAttackModel</span><span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>AquaSimAttackModel<span class=\"token operator\">></span> attackModel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">SetNamedData</span><span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>NamedData<span class=\"token operator\">></span> ndn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>AquaSimPhy<span class=\"token operator\">></span> <span class=\"token function\">GetPhy</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>AquaSimMac<span class=\"token operator\">></span> <span class=\"token function\">GetMac</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>AquaSimRouting<span class=\"token operator\">></span> <span class=\"token function\">GetRouting</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token comment\">//Ptr&lt;AquaSimApp> GetApp (void);</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token comment\">//Not currently implemented</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>AquaSimChannel<span class=\"token operator\">></span> <span class=\"token function\">DoGetChannel</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> channelId<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>AquaSimChannel<span class=\"token operator\">></span> <span class=\"token function\">DoGetChannel</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>AquaSimSync<span class=\"token operator\">></span> <span class=\"token function\">GetMacSync</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>AquaSimLocalization<span class=\"token operator\">></span> <span class=\"token function\">GetMacLoc</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>AquaSimAttackModel<span class=\"token operator\">></span> <span class=\"token function\">GetAttackModel</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>NamedData<span class=\"token operator\">></span> <span class=\"token function\">GetNamedData</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">void</span> <span class=\"token function\">DoDispose</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">void</span> <span class=\"token function\">DoInitialize</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">double</span> <span class=\"token function\">GetPropSpeed</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//m/s</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">ForwardUp</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span>MobilityModel<span class=\"token operator\">></span> src<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span>MobilityModel<span class=\"token operator\">></span> dst<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">//not used.</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token comment\">//inherited functions from NetDevice class</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">void</span> <span class=\"token function\">AddLinkChangeCallback</span> <span class=\"token punctuation\">(</span>Callback<span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span> callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token keyword\">virtual</span> Address <span class=\"token function\">GetAddress</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token keyword\">virtual</span> Address <span class=\"token function\">GetBroadcast</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token keyword\">virtual</span> Ptr<span class=\"token operator\">&lt;</span>Channel<span class=\"token operator\">></span> <span class=\"token function\">GetChannel</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">uint32_t</span> <span class=\"token function\">GetIfIndex</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">uint16_t</span> <span class=\"token function\">GetMtu</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token keyword\">virtual</span> Address <span class=\"token function\">GetMulticast</span> <span class=\"token punctuation\">(</span>Ipv4Address multicastGroup<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  <span class=\"token keyword\">virtual</span> Address <span class=\"token function\">GetMulticast</span> <span class=\"token punctuation\">(</span>Ipv6Address addr<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  <span class=\"token keyword\">virtual</span> Ptr<span class=\"token operator\">&lt;</span>Node<span class=\"token operator\">></span> <span class=\"token function\">GetNode</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">IsBridge</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">IsBroadcast</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">IsLinkUp</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">IsMulticast</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">IsPointToPoint</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">NeedsArp</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">SendWithHeader</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint16_t</span> protocolNumber<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> Address <span class=\"token operator\">&amp;</span>dest<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint16_t</span> protocolNumber<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">SendFrom</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> Address <span class=\"token operator\">&amp;</span>source<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                           <span class=\"token keyword\">const</span> Address <span class=\"token operator\">&amp;</span>dest<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint16_t</span> protocolNumber<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">void</span> <span class=\"token function\">SetAddress</span> <span class=\"token punctuation\">(</span>Address address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">void</span> <span class=\"token function\">SetIfIndex</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">uint32_t</span> index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">SetMtu</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">uint16_t</span> mtu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">void</span> <span class=\"token function\">SetNode</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Node<span class=\"token operator\">></span> node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">void</span> <span class=\"token function\">SetPromiscReceiveCallback</span> <span class=\"token punctuation\">(</span>PromiscReceiveCallback cb<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">void</span> <span class=\"token function\">SetReceiveCallback</span> <span class=\"token punctuation\">(</span>ReceiveCallback cb<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">SupportsSendFrom</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  <span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>   * Taken from AquaSimNode during consolidation</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>   */</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  <span class=\"token comment\">//bool Move(void);    /*start the movement... should be handled within example*/</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>  <span class=\"token comment\">//void Start(void);</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  <span class=\"token comment\">//void CheckPosition(void);</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  <span class=\"token keyword\">inline</span> Time <span class=\"token operator\">&amp;</span><span class=\"token function\">PositionUpdateTime</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> m_positionUpdateTime<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">SetPositionUpdateTime</span><span class=\"token punctuation\">(</span>Time posUpdateTime<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> m_positionUpdateTime <span class=\"token operator\">=</span> posUpdateTime<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>  <span class=\"token comment\">//sink related attributes</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  <span class=\"token keyword\">int</span> <span class=\"token function\">ClearSinkStatus</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>  <span class=\"token keyword\">int</span> <span class=\"token function\">SetSinkStatus</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  <span class=\"token keyword\">inline</span> <span class=\"token keyword\">int</span> <span class=\"token function\">GetSinkStatus</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> m_sinkStatus<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>  <span class=\"token comment\">//VBF</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>  <span class=\"token keyword\">inline</span> <span class=\"token keyword\">double</span> <span class=\"token operator\">&amp;</span><span class=\"token function\">CX</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> m_cX<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  <span class=\"token keyword\">inline</span> <span class=\"token keyword\">double</span> <span class=\"token operator\">&amp;</span><span class=\"token function\">CY</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> m_cY<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>  <span class=\"token keyword\">inline</span> <span class=\"token keyword\">double</span> <span class=\"token operator\">&amp;</span><span class=\"token function\">CZ</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> m_cZ<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>  <span class=\"token keyword\">inline</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">FailureStatus</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> m_failureStatus<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>  <span class=\"token keyword\">inline</span> <span class=\"token keyword\">double</span> <span class=\"token function\">FailurePro</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> m_failurePro<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>  <span class=\"token keyword\">inline</span> <span class=\"token keyword\">double</span> <span class=\"token function\">FailureStatusPro</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> m_failureStatusPro<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">void</span> <span class=\"token function\">SetTransmissionStatus</span><span class=\"token punctuation\">(</span>TransStatus status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>  <span class=\"token keyword\">virtual</span> TransStatus <span class=\"token function\">GetTransmissionStatus</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>  <span class=\"token keyword\">inline</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">CarrierSense</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> m_carrierSense<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>  <span class=\"token keyword\">inline</span> <span class=\"token keyword\">void</span> <span class=\"token function\">ResetCarrierSense</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> m_carrierSense <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>  <span class=\"token keyword\">inline</span> <span class=\"token keyword\">void</span> <span class=\"token function\">SetCarrierSense</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">bool</span> f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    m_carrierSense <span class=\"token operator\">=</span> f<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>    m_carrierId <span class=\"token operator\">=</span> f<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>  <span class=\"token keyword\">inline</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">CarrierId</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> m_carrierId<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>  <span class=\"token keyword\">inline</span> <span class=\"token keyword\">void</span> <span class=\"token function\">ResetCarrierId</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> m_carrierId <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>  <span class=\"token keyword\">int</span> m_nextHop<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>  <span class=\"token keyword\">int</span> m_setHopStatus<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>  <span class=\"token keyword\">int</span> m_sinkStatus<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>  <span class=\"token keyword\">int</span> <span class=\"token function\">GetHopStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>  <span class=\"token keyword\">int</span> <span class=\"token function\">GetNextHop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>  <span class=\"token comment\">//void UpdatePosition(void);  // UpdatePosition() out of date... should be using ns3's mobility module</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>  <span class=\"token keyword\">bool</span> <span class=\"token function\">IsMoving</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>  Vector <span class=\"token function\">GetPosition</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>AquaSimEnergyModel<span class=\"token operator\">></span> <span class=\"token function\">EnergyModel</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">return</span> m_energyModel<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>  <span class=\"token keyword\">bool</span> <span class=\"token function\">IsAttacker</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>  <span class=\"token keyword\">int</span> <span class=\"token function\">TotalSentPkts</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">return</span> m_totalSentPkts<span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>  <span class=\"token keyword\">inline</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">MacEnabled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">return</span> m_macEnabled<span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>  <span class=\"token keyword\">inline</span> <span class=\"token keyword\">void</span> <span class=\"token function\">MacEnabled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">bool</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>m_macEnabled <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre></pre></td></tr><tr><td data-num=\"121\"></td><td><pre><span class=\"token keyword\">protected</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">GenerateFailure</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre></pre></td></tr><tr><td data-num=\"125\"></td><td><pre><span class=\"token keyword\">private</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">CompleteConfig</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>AquaSimPhy<span class=\"token operator\">></span> m_phy<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>AquaSimMac<span class=\"token operator\">></span> m_mac<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>AquaSimRouting<span class=\"token operator\">></span> m_routing<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>  <span class=\"token comment\">//Ptr&lt;AquaSimApp> m_app;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span>Ptr<span class=\"token operator\">&lt;</span>AquaSimChannel<span class=\"token operator\">></span> <span class=\"token operator\">></span> m_channel<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>Node<span class=\"token operator\">></span> m_node<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>UniformRandomVariable<span class=\"token operator\">></span> m_uniformRand<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>AquaSimEnergyModel<span class=\"token operator\">></span> m_energyModel<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>AquaSimSync<span class=\"token operator\">></span> m_macSync<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>AquaSimLocalization<span class=\"token operator\">></span> m_macLoc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>AquaSimAttackModel<span class=\"token operator\">></span> m_attackModel<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>NamedData<span class=\"token operator\">></span> m_ndn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>  NetDevice<span class=\"token double-colon punctuation\">::</span>ReceiveCallback m_forwardUp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>  <span class=\"token keyword\">bool</span> m_configComplete<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>  <span class=\"token keyword\">bool</span> m_attacker<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>  <span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"148\"></td><td><pre>   * From AquaSimNode</pre></td></tr><tr><td data-num=\"149\"></td><td><pre>   */</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>  TransStatus m_transStatus<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>  <span class=\"token keyword\">double</span> m_statusChangeTime<span class=\"token punctuation\">;</span>  <span class=\"token comment\">//the time when changing m_preTransStatus to m_transStatus</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>  <span class=\"token keyword\">bool</span>    m_failureStatus<span class=\"token punctuation\">;</span><span class=\"token comment\">// 1 if node fails, 0 otherwise</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>  <span class=\"token keyword\">double</span> m_failurePro<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>  <span class=\"token keyword\">double</span> m_failureStatusPro<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>  <span class=\"token comment\">//the following attributes are added by Peng Xie for RMAC and VBF</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>  <span class=\"token keyword\">double</span> m_cX<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>  <span class=\"token keyword\">double</span> m_cY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>  <span class=\"token keyword\">double</span> m_cZ<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>  <span class=\"token keyword\">bool</span> m_carrierSense<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>  <span class=\"token keyword\">bool</span> m_carrierId<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>  Time m_positionUpdateTime<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>  <span class=\"token keyword\">uint32_t</span> m_ifIndex<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>  <span class=\"token keyword\">uint16_t</span> m_mtu<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>  <span class=\"token keyword\">int</span> m_totalSentPkts<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>  <span class=\"token keyword\">bool</span> m_macEnabled<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>  <span class=\"token comment\">//XXX remove counters</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// class AquaSimNetDevice</span></pre></td></tr></table></figure><p>很明显可以看出，其是继承自 <code>NetDevice</code>  并实现了 <code>Send</code>  方法，所以和 <code>wifi</code>  一样，起始都是 <code>AquaSimNetDevice::Send</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">bool</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">AquaSimNetDevice</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span> Packet <span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> Address <span class=\"token operator\">&amp;</span>dest<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint16_t</span> protocolNumber<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> packet <span class=\"token operator\">&lt;&lt;</span> dest <span class=\"token operator\">&lt;&lt;</span> protocolNumber<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  m_totalSentPkts<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">//debugging</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  AquaSimHeader ash<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">uint32_t</span> pktSize <span class=\"token operator\">=</span> packet<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  ash<span class=\"token punctuation\">.</span><span class=\"token function\">SetSize</span><span class=\"token punctuation\">(</span>pktSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  ash<span class=\"token punctuation\">.</span><span class=\"token function\">SetSAddr</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AquaSimAddress</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ConvertFrom</span><span class=\"token punctuation\">(</span><span class=\"token function\">GetAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  ash<span class=\"token punctuation\">.</span><span class=\"token function\">SetDAddr</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AquaSimAddress</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ConvertFrom</span><span class=\"token punctuation\">(</span>dest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  packet<span class=\"token operator\">-></span><span class=\"token function\">AddHeader</span><span class=\"token punctuation\">(</span>ash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token function\">SendWithHeader</span><span class=\"token punctuation\">(</span>packet<span class=\"token punctuation\">,</span> protocolNumber<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>很简单的一个方法，调用了 <code>AquaSimNetDevice::SendWithHeader</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">bool</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">AquaSimNetDevice</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SendWithHeader</span><span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint16_t</span> protocolNumber<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    AquaSimHeader ash<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    packet<span class=\"token operator\">-></span><span class=\"token function\">RemoveHeader</span><span class=\"token punctuation\">(</span>ash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    Address dest <span class=\"token operator\">=</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetDAddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">uint32_t</span> pktSize <span class=\"token operator\">=</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">//Quick hack. Named Data should be NULL pointer if unused/unset.</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_ndn<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token keyword\">return</span> m_ndn<span class=\"token operator\">-></span><span class=\"token function\">Recv</span><span class=\"token punctuation\">(</span>packet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>m_routing<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span><span class=\"token comment\">//Note : https://www.nsnam.org/docs/release/3.24/doxygen/uan-mac-cw_8cc_source.html#l00123</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        ash<span class=\"token punctuation\">.</span><span class=\"token function\">SetNextHop</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AquaSimAddress</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">GetBroadcast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        packet<span class=\"token operator\">-></span><span class=\"token function\">AddHeader</span><span class=\"token punctuation\">(</span>ash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token function\">NS_LOG_DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Me(\"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token class-name\">AquaSimAddress</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ConvertFrom</span><span class=\"token punctuation\">(</span><span class=\"token function\">GetAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetAsInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"): Sending packet to Routing layer : \"</span> <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" bytes ; \"</span> <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetTxTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetSeconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" sec. ; Dest: \"</span> <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetDAddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetAsInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" ; Src: \"</span> <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetSAddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetAsInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" ; Next H.: \"</span> <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetNextHop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetAsInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">return</span> m_routing<span class=\"token operator\">-></span><span class=\"token function\">Recv</span><span class=\"token punctuation\">(</span>packet<span class=\"token punctuation\">,</span> dest<span class=\"token punctuation\">,</span> protocolNumber<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MacEnabled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> m_mac<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        ash<span class=\"token punctuation\">.</span><span class=\"token function\">SetNextHop</span><span class=\"token punctuation\">(</span>ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetDAddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        packet<span class=\"token operator\">-></span><span class=\"token function\">AddHeader</span><span class=\"token punctuation\">(</span>ash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token function\">NS_LOG_DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Me(\"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token class-name\">AquaSimAddress</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ConvertFrom</span><span class=\"token punctuation\">(</span><span class=\"token function\">GetAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetAsInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"): Sending packet to MAC layer : \"</span> <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" bytes ; \"</span> <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetTxTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetSeconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" sec. ; Dest: \"</span> <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetDAddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetAsInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" ; Src: \"</span> <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetSAddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetAsInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" ; Next H.: \"</span> <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetNextHop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetAsInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token keyword\">return</span> m_mac<span class=\"token operator\">-></span><span class=\"token function\">TxProcess</span><span class=\"token punctuation\">(</span>packet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_phy<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token function\">SetTransmissionStatus</span><span class=\"token punctuation\">(</span>SEND<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        ash<span class=\"token punctuation\">.</span><span class=\"token function\">SetNextHop</span><span class=\"token punctuation\">(</span>ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetDAddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>ash<span class=\"token punctuation\">.</span>m_channelSelect<span class=\"token operator\">==</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          ash<span class=\"token punctuation\">.</span><span class=\"token function\">SetTxTime</span><span class=\"token punctuation\">(</span>m_phy<span class=\"token operator\">-></span><span class=\"token function\">CalcAcousticsTxTime</span><span class=\"token punctuation\">(</span>pktSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>           ash<span class=\"token punctuation\">.</span><span class=\"token function\">SetTxTime</span><span class=\"token punctuation\">(</span>m_phy<span class=\"token operator\">-></span><span class=\"token function\">CalcOpticalTxTime</span><span class=\"token punctuation\">(</span>pktSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token function\">NS_LOG_DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Me(\"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token class-name\">AquaSimAddress</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ConvertFrom</span><span class=\"token punctuation\">(</span><span class=\"token function\">GetAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetAsInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"): Sending packet to Phy layer : \"</span> <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" bytes ; \"</span> <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetTxTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetSeconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" sec. ; Dest: \"</span> <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetDAddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetAsInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" ; Src: \"</span> <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetSAddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetAsInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" ; Next H.: \"</span> <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetNextHop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetAsInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Schedule</span><span class=\"token punctuation\">(</span>ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetTxTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>AquaSimNetDevice<span class=\"token double-colon punctuation\">::</span>SetTransmissionStatus<span class=\"token punctuation\">,</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> NIDLE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        packet<span class=\"token operator\">-></span><span class=\"token function\">AddHeader</span><span class=\"token punctuation\">(</span>ash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token comment\">//slightly awkard but for phy header Buffer</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        AquaSimPacketStamp pstamp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        packet<span class=\"token operator\">-></span><span class=\"token function\">AddHeader</span><span class=\"token punctuation\">(</span>pstamp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token keyword\">return</span> m_phy<span class=\"token operator\">-></span><span class=\"token function\">PktTransmit</span><span class=\"token punctuation\">(</span>packet<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token keyword\">else</span> <span class=\"token function\">NS_LOG_WARN</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Routing/Mac/Phy layers are not attached to this device. Can not send.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这里主要是做了三种情况的区分，</p>\n<ol>\n<li>\n<p>配置了路由协议，直接交由路由进行处理。</p>\n</li>\n<li>\n<p>没配置路由协议，但配置了 <code>MAC</code> ，由 <code>MAC</code>  进行处理。</p>\n</li>\n<li>\n<p>路由和 <code>MAC</code>  都没配置，直接交由 <code>PHY</code>  进行处理。</p>\n</li>\n</ol>\n<p>这里我们先看路由的 <code>AquaSimRouting::Recv</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*avoid instantiation since UnderwaterRouting's behavior is not defined*/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">Recv</span><span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> Address <span class=\"token operator\">&amp;</span>dest<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint16_t</span> protocolNumber<span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">//handler not implemented</span></pre></td></tr></table></figure><p>是个虚函数，具体实现方式由继承的子类，自行实现。</p>\n<p>但是只要是进行通信，最后都会调用 <code>AquaSimRouting::SendDown</code>  方法。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  * send packet p to the lower layer</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  *</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  * @param p            a packet</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  * @param next_hop    the next hop to route packet p</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  * @param delay        packet p will be sent in time of delay</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  * */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">bool</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token class-name\">AquaSimRouting</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SendDown</span><span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> p<span class=\"token punctuation\">,</span> AquaSimAddress nextHop<span class=\"token punctuation\">,</span> Time delay<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\">//cmh->uw_flag() = true;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token comment\">//cmh->addr_type() = NS_AF_INET;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> p <span class=\"token operator\">&lt;&lt;</span> nextHop <span class=\"token operator\">&lt;&lt;</span> delay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span><span class=\"token punctuation\">(</span>p <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token comment\">//add header to packet</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  AquaSimHeader header<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  p<span class=\"token operator\">-></span><span class=\"token function\">RemoveHeader</span><span class=\"token punctuation\">(</span>header<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token comment\">//NS_LOG_DEBUG(\"Pktsize=\" &lt;&lt; header.GetSize());</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>header<span class=\"token punctuation\">.</span><span class=\"token function\">GetUId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> header<span class=\"token punctuation\">.</span><span class=\"token function\">SetUId</span><span class=\"token punctuation\">(</span>p<span class=\"token operator\">-></span><span class=\"token function\">GetUid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  header<span class=\"token punctuation\">.</span><span class=\"token function\">SetDirection</span><span class=\"token punctuation\">(</span>AquaSimHeader<span class=\"token double-colon punctuation\">::</span>DOWN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  header<span class=\"token punctuation\">.</span><span class=\"token function\">SetNextHop</span><span class=\"token punctuation\">(</span>nextHop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  header<span class=\"token punctuation\">.</span><span class=\"token function\">SetSAddr</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AquaSimAddress</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ConvertFrom</span><span class=\"token punctuation\">(</span>m_device<span class=\"token operator\">-></span><span class=\"token function\">GetAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  p<span class=\"token operator\">-></span><span class=\"token function\">AddHeader</span><span class=\"token punctuation\">(</span>header<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token comment\">//send down after given delay</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    header<span class=\"token punctuation\">.</span><span class=\"token function\">Print</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>cout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token comment\">/*Note this schedule will not work, should instead call internal function once</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>   * event is executed which will internal call Mac's function directly.</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>   * This should most likely be a callback.</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  */</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token comment\">//Simulator::Schedule(delay, &amp;AquaSimMac::Recv, &amp;p);</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Schedule</span><span class=\"token punctuation\">(</span>delay<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>AquaSimRouting<span class=\"token double-colon punctuation\">::</span>SendPacket<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这里做了一个 <code>Uid</code>  校验，如果不存在，添加一个新的 <code>Uid</code> ，然后调用了 <code>AquaSimMac::TxProcess</code> ， <code>packet</code>  进入 <code>MAC</code>  层</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">AquaSimRouting</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SendPacket</span><span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> p<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> m_mac<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token function\">m_routingTxCbTrace</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>m_mac<span class=\"token operator\">-></span><span class=\"token function\">TxProcess</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token function\">NS_LOG_DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Mac recv error\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>AquaSimMac::TxProcess</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// to process the outgoing packet</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">TxProcess</span><span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> p<span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>不出意料，也是虚函数，实现由子类自己实现。</p>\n<p>这里以 <code>BroadcastMac</code>  为例</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">bool</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">AquaSimBroadcastMac</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">TxProcess</span><span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> pkt<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> pkt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  AquaSimHeader ash<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  MacHeader mach<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  pkt<span class=\"token operator\">-></span><span class=\"token function\">RemoveHeader</span><span class=\"token punctuation\">(</span>ash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  mach<span class=\"token punctuation\">.</span><span class=\"token function\">SetDA</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AquaSimAddress</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">GetBroadcast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  mach<span class=\"token punctuation\">.</span><span class=\"token function\">SetSA</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AquaSimAddress</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ConvertFrom</span><span class=\"token punctuation\">(</span>m_device<span class=\"token operator\">-></span><span class=\"token function\">GetAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> m_packetSize <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    ash<span class=\"token punctuation\">.</span><span class=\"token function\">SetSize</span><span class=\"token punctuation\">(</span>m_packetSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    ash<span class=\"token punctuation\">.</span><span class=\"token function\">SetSize</span><span class=\"token punctuation\">(</span>m_packetHeaderSize <span class=\"token operator\">+</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  ash<span class=\"token punctuation\">.</span><span class=\"token function\">SetTxTime</span><span class=\"token punctuation\">(</span><span class=\"token function\">GetTxTime</span><span class=\"token punctuation\">(</span>pkt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token keyword\">switch</span><span class=\"token punctuation\">(</span> m_device<span class=\"token operator\">-></span><span class=\"token function\">GetTransmissionStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token keyword\">case</span> SLEEP<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token function\">PowerOn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token keyword\">case</span> NIDLE<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      ash<span class=\"token punctuation\">.</span><span class=\"token function\">SetDirection</span><span class=\"token punctuation\">(</span>AquaSimHeader<span class=\"token double-colon punctuation\">::</span>DOWN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token comment\">//ash->addr_type()=NS_AF_ILINK;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token comment\">//add the sync hdr</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      pkt<span class=\"token operator\">-></span><span class=\"token function\">AddHeader</span><span class=\"token punctuation\">(</span>mach<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      pkt<span class=\"token operator\">-></span><span class=\"token function\">AddHeader</span><span class=\"token punctuation\">(</span>ash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token comment\">//Phy()->SetPhyStatus(PHY_SEND);</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      <span class=\"token function\">SendDown</span><span class=\"token punctuation\">(</span>pkt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      m_backoffCounter<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token keyword\">case</span> RECV<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      <span class=\"token keyword\">double</span> backoff<span class=\"token operator\">=</span>m_rand<span class=\"token operator\">-></span><span class=\"token function\">GetValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span>BC_BACKOFF<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"BACKOFF time:\"</span> <span class=\"token operator\">&lt;&lt;</span> backoff <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" on node:\"</span> <span class=\"token operator\">&lt;&lt;</span> m_device<span class=\"token operator\">-></span><span class=\"token function\">GetAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token comment\">//pkt->AddHeader(mach);</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      pkt<span class=\"token operator\">-></span><span class=\"token function\">AddHeader</span><span class=\"token punctuation\">(</span>ash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Schedule</span><span class=\"token punctuation\">(</span><span class=\"token function\">Seconds</span><span class=\"token punctuation\">(</span>backoff<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token operator\">&amp;</span>AquaSimBroadcastMac<span class=\"token double-colon punctuation\">::</span>BackoffHandler<span class=\"token punctuation\">,</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span>pkt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token keyword\">case</span> SEND<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      <span class=\"token keyword\">double</span> backoff<span class=\"token operator\">=</span>m_rand<span class=\"token operator\">-></span><span class=\"token function\">GetValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span>BC_BACKOFF<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"BACKOFF time:\"</span> <span class=\"token operator\">&lt;&lt;</span> backoff <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" on node:\"</span> <span class=\"token operator\">&lt;&lt;</span> m_device<span class=\"token operator\">-></span><span class=\"token function\">GetAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      <span class=\"token comment\">//pkt->AddHeader(mach);</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      pkt<span class=\"token operator\">-></span><span class=\"token function\">AddHeader</span><span class=\"token punctuation\">(</span>ash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>      <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Schedule</span><span class=\"token punctuation\">(</span><span class=\"token function\">Seconds</span><span class=\"token punctuation\">(</span>backoff<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token operator\">&amp;</span>AquaSimBroadcastMac<span class=\"token double-colon punctuation\">::</span>BackoffHandler<span class=\"token punctuation\">,</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span>pkt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>      <span class=\"token comment\">/*pkt=0;*/</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token keyword\">default</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      <span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>      * all cases have been processed above, so simply return</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      */</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">//may be bug due to Sleep/default cases</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>针对不同的状态，进行了不同的处理，如果是有冲突的话，退避一段时间，在一定次数失败之后，放弃。</p>\n<p>否则，直接 <code>SendDown(pkt)</code> ；</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">bool</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">AquaSimMac</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SendDown</span><span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> p<span class=\"token punctuation\">,</span> TransStatus afterTrans<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span><span class=\"token punctuation\">(</span>m_device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// &amp;&amp; m_phy &amp;&amp; m_rout);</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token comment\">/*  For debugging:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  std::cout &lt;&lt; \"\\nMac @SendDown check:\\n\";</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  p->Print(std::cout);</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  std::cout &lt;&lt; \"\\n\";</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  */</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token function\">m_macTxTrace</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_device<span class=\"token operator\">-></span><span class=\"token function\">GetTransmissionStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> SLEEP<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token function\">NS_LOG_DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SendDown::Sleeping, drop pkt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_device<span class=\"token operator\">-></span><span class=\"token function\">GetTransmissionStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> RECV<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SendDown::Recv, queuing pkt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token function\">SendQueuePush</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">make_pair</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> afterTrans<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      m_device<span class=\"token operator\">-></span><span class=\"token function\">SetTransmissionStatus</span><span class=\"token punctuation\">(</span>SEND<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      AquaSimHeader ash<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      p<span class=\"token operator\">-></span><span class=\"token function\">RemoveHeader</span><span class=\"token punctuation\">(</span>ash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetTxTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">IsNegative</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">SetTxTime</span><span class=\"token punctuation\">(</span><span class=\"token function\">GetTxTime</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Me(\"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token keyword\">this</span><span class=\"token operator\">-></span>m_address<span class=\"token punctuation\">.</span><span class=\"token function\">GetAsInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"): Sending packet to Phy : \"</span> <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" bytes ; \"</span> <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetTxTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetSeconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" sec. ; Dest: \"</span> <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetDAddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetAsInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" ; Src: \"</span> <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetSAddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetAsInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" ; Next H.: \"</span> <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetNextHop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetAsInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Schedule</span><span class=\"token punctuation\">(</span>ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetTxTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>AquaSimNetDevice<span class=\"token double-colon punctuation\">::</span>SetTransmissionStatus<span class=\"token punctuation\">,</span>m_device<span class=\"token punctuation\">,</span>afterTrans<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      p<span class=\"token operator\">-></span><span class=\"token function\">AddHeader</span><span class=\"token punctuation\">(</span>ash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token comment\">//slightly awkard but for phy header Buffer</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      AquaSimPacketStamp pstamp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      p<span class=\"token operator\">-></span><span class=\"token function\">AddHeader</span><span class=\"token punctuation\">(</span>pstamp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token keyword\">return</span> <span class=\"token function\">Phy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">Recv</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这里根据设备的状态决定丢弃、存入发送队列，直接发送至 <code>Phy</code> 。所以下一步是 <code>AquaSimPhy::Recv</code></p>\n<p>定义如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">virtual</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">Recv</span><span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> p<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>同样的，我们关注其子类实现</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>* we will cache the incoming packet in phy layer</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>* and send it to MAC layer after receiving the entire one</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>*/</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">bool</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token class-name\">AquaSimPhyCmn</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Recv</span><span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> p<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> p <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"at time\"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetSeconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" on node \"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token function\">GetNetDevice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token comment\">/*std::cout &lt;&lt; \"\\nPhyCmn: @Recv check:\\n\";</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  p->Print(std::cout);</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  std::cout &lt;&lt; \"\\n\";*/</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  AquaSimPacketStamp pstamp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  AquaSimHeader asHeader<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  p<span class=\"token operator\">-></span><span class=\"token function\">RemoveHeader</span><span class=\"token punctuation\">(</span>pstamp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  p<span class=\"token operator\">-></span><span class=\"token function\">PeekHeader</span><span class=\"token punctuation\">(</span>asHeader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  p<span class=\"token operator\">-></span><span class=\"token function\">AddHeader</span><span class=\"token punctuation\">(</span>pstamp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token comment\">//NS_LOG_DEBUG (\"direction=\" &lt;&lt; asHeader.GetDirection());</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>asHeader<span class=\"token punctuation\">.</span><span class=\"token function\">GetDirection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> AquaSimHeader<span class=\"token double-colon punctuation\">::</span>DOWN<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token function\">NS_LOG_DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Phy_Recv DOWN. Pkt counter(\"</span> <span class=\"token operator\">&lt;&lt;</span> outPktCounter<span class=\"token operator\">++</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\") on node(\"</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>         <span class=\"token function\">GetNetDevice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\")\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token function\">PktTransmit</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>asHeader<span class=\"token punctuation\">.</span><span class=\"token function\">GetDirection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> AquaSimHeader<span class=\"token double-colon punctuation\">::</span>UP<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token function\">NS_LOG_WARN</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Direction for pkt-flow not specified, \"</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          <span class=\"token string\">\"sending pkt up the stack on default.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token function\">NS_LOG_DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Phy_Recv UP. Pkt counter(\"</span> <span class=\"token operator\">&lt;&lt;</span> incPktCounter<span class=\"token operator\">++</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\") on node(\"</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>         <span class=\"token function\">GetNetDevice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\")\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    p <span class=\"token operator\">=</span> <span class=\"token function\">PrevalidateIncomingPkt</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      <span class=\"token comment\">//put the packet into the incoming queue</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      m_sC<span class=\"token operator\">-></span><span class=\"token function\">AddNewPacket</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这个方法分为从上 <code>(MAC)</code>  到下 <code>Channel</code>  和从下 <code>Channel</code>  到上 (MAC)</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>* pass packet p to channel</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>*/</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">bool</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token class-name\">AquaSimPhyCmn</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">PktTransmit</span><span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> p<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> channelId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  AquaSimPacketStamp pstamp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  AquaSimHeader asHeader<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  p<span class=\"token operator\">-></span><span class=\"token function\">RemoveHeader</span><span class=\"token punctuation\">(</span>pstamp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">//awkward but for universal encapsulation.</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  p<span class=\"token operator\">-></span><span class=\"token function\">PeekHeader</span><span class=\"token punctuation\">(</span>asHeader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">GetNetDevice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">FailureStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token function\">NS_LOG_WARN</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"AquaSimPhyCmn nodeId=\"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token function\">GetNetDevice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetNode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" fails!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    p <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">GetNetDevice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetTransmissionStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> SLEEP <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">!=</span> <span class=\"token function\">EM</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">EM</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetEnergy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token function\">NS_LOG_DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Unable to reach phy layer (sleep/disable)\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    p <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span><span class=\"token function\">GetNetDevice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetTransmissionStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token keyword\">case</span> SEND<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token function\">UpdateTxEnergy</span><span class=\"token punctuation\">(</span>asHeader<span class=\"token punctuation\">.</span><span class=\"token function\">GetTxTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token keyword\">case</span> NIDLE<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>     * Something went wrong here...</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token function\">NS_LOG_WARN</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"AquaSimPhyCmn node(\"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token function\">GetNetDevice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetNode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\",\"</span> <span class=\"token operator\">&lt;&lt;</span>  <span class=\"token function\">GetNetDevice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetNode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"):mac forgot to change the status at time \"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token keyword\">case</span> SLEEP<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token function\">NS_LOG_WARN</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"AquaSimPhyCmn node(\"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token function\">GetNetDevice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetNode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\") is sleeping! (dropping pkt)\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token keyword\">default</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token function\">NS_LOG_WARN</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"AquaSimPhyCmn: wrong status (dropping pkt)\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  *  Stamp the packet with the interface arguments</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  */</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  <span class=\"token function\">StampTxInfo</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  Time txSendDelay <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token operator\">-></span><span class=\"token function\">CalcAcousticsTxTime</span><span class=\"token punctuation\">(</span>asHeader<span class=\"token punctuation\">.</span><span class=\"token function\">GetSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>m_modulationName <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Schedule</span><span class=\"token punctuation\">(</span>txSendDelay<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>AquaSimNetDevice<span class=\"token double-colon punctuation\">::</span>SetTransmissionStatus<span class=\"token punctuation\">,</span> <span class=\"token function\">GetNetDevice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> NIDLE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  <span class=\"token comment\">//Simulator::Schedule(txSendDelay, &amp;AquaSimPhyCmn::SetPhyStatus, this, PHY_IDLE);</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  * here we simulate multi-channel (different frequencies),</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  * not multiple tranceiver, so we pass the packet to channel_ directly</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  * p' uw_txinfo_ carries channel frequency information</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  *</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  * NOTE channelId must be set by upper layer and AquaSimPhyCmn::Recv() should be edited accordingly.</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  */</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>  <span class=\"token function\">NotifyTx</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  <span class=\"token function\">m_txLogger</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> m_sC<span class=\"token operator\">-></span><span class=\"token function\">GetNoise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  <span class=\"token keyword\">return</span> m_channel<span class=\"token punctuation\">.</span><span class=\"token function\">at</span><span class=\"token punctuation\">(</span>channelId<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">Recv</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>调用 <code>channel-&gt;Recv</code>  接收 <code>Packet</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">bool</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">AquaSimChannel</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Recv</span><span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> p<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span>AquaSimPhy<span class=\"token operator\">></span> phy<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token comment\">/*std::cout &lt;&lt; \"\\nChannel: @Recv check:\\n\";</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  p->Print(std::cout);</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  std::cout &lt;&lt; \"\\n\";*/</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> p <span class=\"token operator\">&lt;&lt;</span> phy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span><span class=\"token punctuation\">(</span>p <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span> <span class=\"token operator\">||</span> phy <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token function\">SendUp</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span>phy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">bool</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token class-name\">AquaSimChannel</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SendUp</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> p<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span>AquaSimPhy<span class=\"token operator\">></span> tifp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token function\">NS_LOG_DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Packet:\"</span> <span class=\"token operator\">&lt;&lt;</span> p <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" Phy:\"</span> <span class=\"token operator\">&lt;&lt;</span> tifp <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" Channel:\"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>AquaSimNetDevice<span class=\"token operator\">></span> sender <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">Ptr</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>AquaSimNetDevice<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>tifp<span class=\"token operator\">-></span><span class=\"token function\">GetNetDevice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>AquaSimNetDevice<span class=\"token operator\">></span> recver<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token comment\">//std::vector&lt;Ptr&lt;AquaSimPhy> > rifp;    //must support multiple recv phy in future</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>AquaSimPhy<span class=\"token operator\">></span> rifp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token comment\">//Ptr&lt;Packet> pCopy;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  Time pDelay<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  if(!m_sorted)&#123;</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    SortLists();</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  &#125;</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  */</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>   <span class=\"token function\">NS_LOG_ERROR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"channel Packet:\"</span> <span class=\"token operator\">&lt;&lt;</span> p <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" Phy:\"</span> <span class=\"token operator\">&lt;&lt;</span> tifp <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" Channel:\"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span>PktRecvUnit<span class=\"token operator\">></span> <span class=\"token operator\">*</span> recvUnits <span class=\"token operator\">=</span> m_prop<span class=\"token operator\">-></span><span class=\"token function\">ReceivedCopies</span><span class=\"token punctuation\">(</span>sender<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">,</span> m_deviceList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  allPktCounter<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">//Debug... remove</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span>PktRecvUnit<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span>size_type i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> recvUnits<span class=\"token operator\">-></span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    allRecvPktCounter<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">//Debug .. remove</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sender <span class=\"token operator\">==</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>recvUnits<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>recver<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token comment\">//TODO remove ... this is a local addition for flooding_test.</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>FLOODING_TEST <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token function\">Distance</span><span class=\"token punctuation\">(</span>sender<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>recvUnits<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>recver<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token function\">Distance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>recvUnits<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>recver<span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>recvUnits<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>recver<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">1.25</span><span class=\"token comment\">/*arbitrary*/</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token function\">NS_LOG_DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Channel:SendUp: FloodTest(OutOfRange): sender(\"</span> <span class=\"token operator\">&lt;&lt;</span> sender<span class=\"token operator\">-></span><span class=\"token function\">GetAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\") recver:(\"</span> <span class=\"token operator\">&lt;&lt;</span>  <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>recvUnits<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>recver<span class=\"token operator\">-></span><span class=\"token function\">GetAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\") dist(\"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token function\">Distance</span><span class=\"token punctuation\">(</span>sender<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>recvUnits<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>recver<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\")\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    sentPktCounter<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//Debug... remove</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    recver <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>recvUnits<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>recver<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    pDelay <span class=\"token operator\">=</span> <span class=\"token function\">GetPropDelay</span><span class=\"token punctuation\">(</span>sender<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>recvUnits<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>recver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token comment\">//pDelay = (*recvUnits)[i].pDelay;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    rifp <span class=\"token operator\">=</span> recver<span class=\"token operator\">-></span><span class=\"token function\">GetPhy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token comment\">//rifp = recver->ifhead().lh_first;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    AquaSimPacketStamp pstamp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    AquaSimHeader asHeader<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    p<span class=\"token operator\">-></span><span class=\"token function\">RemoveHeader</span><span class=\"token punctuation\">(</span>pstamp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    p<span class=\"token operator\">-></span><span class=\"token function\">RemoveHeader</span><span class=\"token punctuation\">(</span>asHeader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    pstamp<span class=\"token punctuation\">.</span><span class=\"token function\">SetPr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>recvUnits<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>pR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    pstamp<span class=\"token punctuation\">.</span><span class=\"token function\">SetNoise</span><span class=\"token punctuation\">(</span>m_noiseGen<span class=\"token operator\">-></span><span class=\"token function\">Noise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> pDelay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token function\">GetMobilityModel</span><span class=\"token punctuation\">(</span>recver<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetPosition</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    asHeader<span class=\"token punctuation\">.</span><span class=\"token function\">SetDirection</span><span class=\"token punctuation\">(</span>AquaSimHeader<span class=\"token double-colon punctuation\">::</span>UP<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    asHeader<span class=\"token punctuation\">.</span><span class=\"token function\">SetTxTime</span><span class=\"token punctuation\">(</span>pDelay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    p<span class=\"token operator\">-></span><span class=\"token function\">AddHeader</span><span class=\"token punctuation\">(</span>asHeader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    p<span class=\"token operator\">-></span><span class=\"token function\">AddHeader</span><span class=\"token punctuation\">(</span>pstamp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>     * Send to each interface a copy, and we will filter the packet</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>     * in physical layer according to freq and modulation</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Channel. NodeS:\"</span> <span class=\"token operator\">&lt;&lt;</span> sender<span class=\"token operator\">-></span><span class=\"token function\">GetAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" NodeR:\"</span> <span class=\"token operator\">&lt;&lt;</span> recver<span class=\"token operator\">-></span><span class=\"token function\">GetAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" S.Phy:\"</span> <span class=\"token operator\">&lt;&lt;</span> sender<span class=\"token operator\">-></span><span class=\"token function\">GetPhy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" R.Phy:\"</span> <span class=\"token operator\">&lt;&lt;</span> recver<span class=\"token operator\">-></span><span class=\"token function\">GetPhy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" packet:\"</span> <span class=\"token operator\">&lt;&lt;</span> p</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>          <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" TxTime:\"</span> <span class=\"token operator\">&lt;&lt;</span> asHeader<span class=\"token punctuation\">.</span><span class=\"token function\">GetTxTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> pDelay<span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">\"packet uid \"</span><span class=\"token operator\">&lt;&lt;</span>p<span class=\"token operator\">-></span><span class=\"token function\">GetUid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">\"packet size \"</span><span class=\"token operator\">&lt;&lt;</span>p<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Schedule</span><span class=\"token punctuation\">(</span>pDelay<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>AquaSimPhy<span class=\"token double-colon punctuation\">::</span>Recv<span class=\"token punctuation\">,</span> rifp<span class=\"token punctuation\">,</span> p<span class=\"token operator\">-></span><span class=\"token function\">Copy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    <span class=\"token comment\">/* TODO in future support multiple phy with below code.</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>     *</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>     * for (std::vector&lt;Ptr&lt;AquaSimPhy> >::iterator it = rifp.begin(); it!=rifp.end(); it++) &#123;</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>     *     pCopy = p->Copy();</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>     *   Simulator::Schedule(pDelay, it, &amp;pCopy);</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>     * &#125;</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>     *</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>  p <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//smart pointer will unref automatically once out of scope</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>  <span class=\"token keyword\">delete</span> recvUnits<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>此处调用了 <code>AquaSimPhy::Recv</code> ，上传到 <code>Phy</code></p>\n<p>和之前一样，我们只关注于接收 <code>Packet</code>  部分</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>asHeader<span class=\"token punctuation\">.</span><span class=\"token function\">GetDirection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> AquaSimHeader<span class=\"token double-colon punctuation\">::</span>UP<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>      <span class=\"token function\">NS_LOG_WARN</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Direction for pkt-flow not specified, \"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>          <span class=\"token string\">\"sending pkt up the stack on default.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token function\">NS_LOG_DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Phy_Recv UP. Pkt counter(\"</span> <span class=\"token operator\">&lt;&lt;</span> incPktCounter<span class=\"token operator\">++</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\") on node(\"</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>         <span class=\"token function\">GetNetDevice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\")\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    p <span class=\"token operator\">=</span> <span class=\"token function\">PrevalidateIncomingPkt</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token comment\">//put the packet into the incoming queue</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      m_sC<span class=\"token operator\">-></span><span class=\"token function\">AddNewPacket</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这里是在 <code>m_sC</code>  进行处理，所以下一步是 <code>AquaSimSignalCache::AddNewPacket</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">AquaSimSignalCache</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">AddNewPacket</span><span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  * any packet error marked before this step means</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  * this packet is invalid and will be considered</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  * as noise to other packets only.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">// TODO is packet collision even really tested or dealt with in this class???</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  AquaSimHeader asHeader<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  p<span class=\"token operator\">-></span><span class=\"token function\">PeekHeader</span><span class=\"token punctuation\">(</span>asHeader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>IncomingPacket<span class=\"token operator\">></span> inPkt <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">CreateObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>IncomingPacket<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>          asHeader<span class=\"token punctuation\">.</span><span class=\"token function\">GetErrorFlag</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> AquaSimPacketStamp<span class=\"token double-colon punctuation\">::</span>INVALID <span class=\"token operator\">:</span> AquaSimPacketStamp<span class=\"token double-colon punctuation\">::</span>RECEPTION<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token function\">NS_LOG_DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"AddNewPacket:\"</span> <span class=\"token operator\">&lt;&lt;</span> p <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" w/ Error flag:\"</span> <span class=\"token operator\">&lt;&lt;</span> asHeader<span class=\"token punctuation\">.</span><span class=\"token function\">GetErrorFlag</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" and incomingpkt:\"</span> <span class=\"token operator\">&lt;&lt;</span> inPkt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  m_pktSubTimer<span class=\"token operator\">-></span><span class=\"token function\">AddNewSubmission</span><span class=\"token punctuation\">(</span>inPkt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  inPkt<span class=\"token operator\">-></span>next <span class=\"token operator\">=</span> m_head<span class=\"token operator\">-></span>next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  m_head<span class=\"token operator\">-></span>next <span class=\"token operator\">=</span> inPkt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  m_pktNum<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  m_totalPS <span class=\"token operator\">+=</span> m_phy<span class=\"token operator\">-></span><span class=\"token function\">EM</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetRxPower</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token function\">UpdatePacketStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>下一步是在 <code>PktSubmissionTimer::AddNewSubmission</code>  中进行处理</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">PktSubmissionTimer</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">AddNewSubmission</span><span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>IncomingPacket<span class=\"token operator\">></span> inPkt<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  AquaSimHeader asHeader<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">(</span>inPkt<span class=\"token operator\">-></span>packet<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">PeekHeader</span><span class=\"token punctuation\">(</span>asHeader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">/*Time transmissionDelay = Seconds(inPkt->packet->GetSize() * 8 *      //Byte conversion/</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                           m_sC->m_phy->GetMac()->GetEncodingEff() /</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                           m_sC->m_phy->GetMac()->GetBitRate() ); */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token comment\">/* Need to calcuate modulation here, aka how long until entire packet is received */</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  Time transmissionDelay <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>asHeader<span class=\"token punctuation\">.</span>m_channelSelect<span class=\"token operator\">==</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    transmissionDelay <span class=\"token operator\">=</span> m_sC<span class=\"token operator\">-></span>m_phy<span class=\"token operator\">-></span><span class=\"token function\">CalcAcousticsTxTime</span><span class=\"token punctuation\">(</span>asHeader<span class=\"token punctuation\">.</span><span class=\"token function\">GetSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    transmissionDelay <span class=\"token operator\">=</span> m_sC<span class=\"token operator\">-></span>m_phy<span class=\"token operator\">-></span><span class=\"token function\">CalcOpticalTxTime</span><span class=\"token punctuation\">(</span>asHeader<span class=\"token punctuation\">.</span><span class=\"token function\">GetSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"incomingPkt:\"</span> <span class=\"token operator\">&lt;&lt;</span> inPkt <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"txtime:\"</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                    asHeader<span class=\"token punctuation\">.</span><span class=\"token function\">GetTxTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" transmissionDelay:\"</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                    transmissionDelay<span class=\"token punctuation\">.</span><span class=\"token function\">ToDouble</span><span class=\"token punctuation\">(</span>Time<span class=\"token double-colon punctuation\">::</span>S<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Schedule</span><span class=\"token punctuation\">(</span>transmissionDelay<span class=\"token punctuation\">,</span><span class=\"token operator\">&amp;</span>PktSubmissionTimer<span class=\"token double-colon punctuation\">::</span>Expire<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> inPkt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token comment\">/*if (m_waitingList.empty() || m_waitingList.top().endT > transmissionDelay)</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  &#123;</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      Simulator::Schedule(transmissionDelay, &amp;PktSubmissionTimer::Expire, this);</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  &#125;</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  m_waitingList.push(PktSubmissionUnit(inPkt, transmissionDelay));</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  */</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>在计算完时延等之后，调用 <code>PktSubmissionTimer::Expire</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">PktSubmissionTimer</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Expire</span><span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>IncomingPacket<span class=\"token operator\">></span> inPkt<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token comment\">/*Ptr&lt;IncomingPacket> inPkt = m_waitingList.top().inPkt;</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  m_waitingList.pop();</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  if(!m_waitingList.empty())</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  &#123;</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    Simulator::Schedule(m_waitingList.top().endT, &amp;PktSubmissionTimer::Expire, this);</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  &#125;</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  */</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token function\">NS_LOG_DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Expire. time:\"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ToDouble</span><span class=\"token punctuation\">(</span>Time<span class=\"token double-colon punctuation\">::</span>S<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" inPkt:\"</span> <span class=\"token operator\">&lt;&lt;</span> inPkt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  m_sC<span class=\"token operator\">-></span><span class=\"token function\">SubmitPkt</span><span class=\"token punctuation\">(</span>inPkt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>然后接着调用 <code>SubmitPkt</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">AquaSimSignalCache</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SubmitPkt</span><span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>IncomingPacket<span class=\"token operator\">></span> inPkt<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> inPkt <span class=\"token operator\">&lt;&lt;</span> inPkt<span class=\"token operator\">-></span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  status <span class=\"token operator\">=</span> inPkt<span class=\"token operator\">-></span>status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> p <span class=\"token operator\">=</span> inPkt<span class=\"token operator\">-></span>packet<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token function\">DeleteIncomingPacket</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//object pointed by inPkt is deleted here</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  * modem has no idea about invalid packets, so release</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  * them here</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  */</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">==</span> AquaSimPacketStamp<span class=\"token double-colon punctuation\">::</span>INVALID<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token function\">NS_LOG_DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Packet(\"</span> <span class=\"token operator\">&lt;&lt;</span> p <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\") dropped\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    p <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    m_phy<span class=\"token operator\">-></span><span class=\"token function\">SignalCacheCallback</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>最终 <code>SendPktUp</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">AquaSimPhyCmn</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SignalCacheCallback</span><span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> p<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"PhyCmn::SignalCacheCallback: device(\"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token function\">GetNetDevice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\") p_id:\"</span> <span class=\"token operator\">&lt;&lt;</span> p<span class=\"token operator\">-></span><span class=\"token function\">GetUid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" at:\"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetSeconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token comment\">//TODO check for packet collision at signal cache before calling this</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  AquaSimHeader asHeader<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  p<span class=\"token operator\">-></span><span class=\"token function\">RemoveHeader</span><span class=\"token punctuation\">(</span>asHeader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  asHeader<span class=\"token punctuation\">.</span><span class=\"token function\">SetTxTime</span><span class=\"token punctuation\">(</span><span class=\"token function\">Seconds</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.01</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">//arbitrary processing time here</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  p<span class=\"token operator\">-></span><span class=\"token function\">AddHeader</span><span class=\"token punctuation\">(</span>asHeader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  pktRecvCounter<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//debugging...</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token function\">SendPktUp</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>SendPktUp</code>  定义如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>* send packet to upper layer, supposed to be MAC layer,</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>* but actually go to any specificed module.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>*/</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token class-name\">AquaSimPhyCmn</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SendPktUp</span><span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> p<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  AquaSimHeader ash<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  MacHeader mach<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    p<span class=\"token operator\">-></span><span class=\"token function\">RemoveHeader</span><span class=\"token punctuation\">(</span>ash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  p<span class=\"token operator\">-></span><span class=\"token function\">PeekHeader</span><span class=\"token punctuation\">(</span>mach<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  p<span class=\"token operator\">-></span><span class=\"token function\">AddHeader</span><span class=\"token punctuation\">(</span>ash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token function\">NotifyRx</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token function\">m_rxLogger</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> m_sC<span class=\"token operator\">-></span><span class=\"token function\">GetNoise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token comment\">//This can be shifted to within the switch to target specific packet types.</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">GetNetDevice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">IsAttacker</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token function\">GetNetDevice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetAttackModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">Recv</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>mach<span class=\"token punctuation\">.</span><span class=\"token function\">GetDemuxPType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token keyword\">case</span> MacHeader<span class=\"token double-colon punctuation\">::</span>UWPTYPE_OTHER<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>m_device<span class=\"token operator\">-></span><span class=\"token function\">MacEnabled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">GetMac</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">RecvProcess</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token function\">NS_LOG_DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Mac Recv error\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token keyword\">case</span> MacHeader<span class=\"token double-colon punctuation\">::</span>UWPTYPE_LOC<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token function\">GetNetDevice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetMacLoc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">Recv</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token keyword\">case</span> MacHeader<span class=\"token double-colon punctuation\">::</span>UWPTYPE_SYNC<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token function\">GetNetDevice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetMacSync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">RecvSync</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token keyword\">case</span> MacHeader<span class=\"token double-colon punctuation\">::</span>UWPTYPE_SYNC_BEACON<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token function\">GetNetDevice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetMacSync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">RecvSyncBeacon</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token keyword\">case</span> MacHeader<span class=\"token double-colon punctuation\">::</span>UWPTYPE_NDN<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token function\">GetNetDevice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetNamedData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">Recv</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token keyword\">default</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token function\">NS_LOG_DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SendPKtUp: Something went wrong.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这里分为多种 <code>Header</code> ，</p>\n<p>其中 <code>UWPTYPE_LOC</code>  是水下定位包，通过 AOA 等方式确定位置。</p>\n<p>这里普通数据包一般是直接是调用 <code>AquaSimMac::RecvProcess</code></p>\n<p>这里以广播 MAC 为例</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>this program is used to handle the received packet,</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>it should be virtual function, different class may have</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>different versions.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>*/</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">bool</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token class-name\">AquaSimBroadcastMac</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">RecvProcess</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> pkt<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token comment\">/*std::cout &lt;&lt; \"\\nBMac @RecvProcess check:\\n\";</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  pkt->Print(std::cout);</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  std::cout &lt;&lt; \"\\n\";*/</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    AquaSimHeader ash<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  MacHeader mach<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  pkt<span class=\"token operator\">-></span><span class=\"token function\">RemoveHeader</span><span class=\"token punctuation\">(</span>ash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  pkt<span class=\"token operator\">-></span><span class=\"token function\">RemoveHeader</span><span class=\"token punctuation\">(</span>mach<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    AquaSimAddress dst <span class=\"token operator\">=</span> mach<span class=\"token punctuation\">.</span><span class=\"token function\">GetDA</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token comment\">//get a packet from modem, remove the sync hdr from txtime first</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token comment\">//cmh->txtime() -= getSyncHdrLen();</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetErrorFlag</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token function\">NS_LOG_DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"BroadcastMac:RecvProcess: received corrupt packet.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        pkt<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dst <span class=\"token operator\">==</span> <span class=\"token class-name\">AquaSimAddress</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">GetBroadcast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> dst <span class=\"token operator\">==</span> <span class=\"token class-name\">AquaSimAddress</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ConvertFrom</span><span class=\"token punctuation\">(</span>m_device<span class=\"token operator\">-></span><span class=\"token function\">GetAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_packetSize <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            ash<span class=\"token punctuation\">.</span><span class=\"token function\">SetSize</span><span class=\"token punctuation\">(</span>ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> m_packetHeaderSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    pkt<span class=\"token operator\">-></span><span class=\"token function\">AddHeader</span><span class=\"token punctuation\">(</span>ash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">//leave MacHeader off since sending to upper layers</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token function\">SendUp</span><span class=\"token punctuation\">(</span>pkt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token comment\">//    printf(\"underwaterAquaSimBroadcastMac: this is neither broadcast nor my packet, just drop it\\n\");</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    pkt<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>最后调用 <code>SendUp(pkt)</code>  传到路由</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">bool</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">AquaSimMac</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SendUp</span><span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> p<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span><span class=\"token punctuation\">(</span>m_device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  AquaSimHeader ash<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  p<span class=\"token operator\">-></span><span class=\"token function\">PeekHeader</span><span class=\"token punctuation\">(</span>ash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token function\">NS_LOG_DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Me(\"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token keyword\">this</span><span class=\"token operator\">-></span>m_address<span class=\"token punctuation\">.</span><span class=\"token function\">GetAsInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"): Received packet from Phy : \"</span> <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" bytes ; \"</span> <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetTxTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetSeconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" sec. ; Dest: \"</span> <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetDAddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetAsInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" ; Src: \"</span> <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetSAddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetAsInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" ; Next H.: \"</span> <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetNextHop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetAsInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">Routing</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token function\">m_routingRxTrace</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">Routing</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">Recv</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span>ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetDAddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetDAddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token class-name\">AquaSimAddress</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ConvertFrom</span><span class=\"token punctuation\">(</span>m_device<span class=\"token operator\">-></span><span class=\"token function\">GetAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token comment\">//I am sink, no pass up implemented.</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token function\">NS_LOG_INFO</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Mac:SendUp : packet at destination node:\"</span> <span class=\"token operator\">&lt;&lt;</span> m_device<span class=\"token operator\">-></span><span class=\"token function\">GetAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token string\">\", with end-to-end delay of \"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span>ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetTimeStamp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ToDouble</span><span class=\"token punctuation\">(</span>Time<span class=\"token double-colon punctuation\">::</span>S<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token function\">m_routingRxTrace</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   <span class=\"token function\">m_routingRxTrace</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token comment\">/* if no routing layer is currently implemented */</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>m_dummyRouting<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token comment\">//Change to DOWN and send packet (mac layer wise).</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      p<span class=\"token operator\">-></span><span class=\"token function\">RemoveHeader</span><span class=\"token punctuation\">(</span>ash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      ash<span class=\"token punctuation\">.</span><span class=\"token function\">SetDirection</span><span class=\"token punctuation\">(</span>AquaSimHeader<span class=\"token double-colon punctuation\">::</span>DOWN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      p<span class=\"token operator\">-></span><span class=\"token function\">AddHeader</span><span class=\"token punctuation\">(</span>ash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">TxProcess</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token function\">NS_LOG_DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Mac recv error\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>最终路由 SendUp</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  * send packet p to the upper layer, i.e., port dmux</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  *</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  * @param p   a packet</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  * */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">bool</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token class-name\">AquaSimRouting</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SendUp</span><span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> p<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token comment\">//port_dmux->recv(p); // (Handler*)NULL</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  AquaSimHeader ash<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  p<span class=\"token operator\">-></span><span class=\"token function\">PeekHeader</span><span class=\"token punctuation\">(</span>ash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token comment\">//std::cout &lt;&lt; \"\\nRouting::SinkRecv:\" &lt;&lt; m_device->GetAddress() &lt;&lt;\",pkt#\" &lt;&lt; p->GetUid() &lt;&lt; \",ts:\" &lt;&lt; ash.GetTimeStamp().ToDouble(Time::S) &lt;&lt; \" @\" &lt;&lt; Simulator::Now().ToDouble(Time::S);</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token comment\">//std::cout &lt;&lt; (Simulator::Now()-ash.GetTimeStamp()).ToDouble(Time::S) &lt;&lt; \"\\n\";</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> p <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" : currently a dummy sendup on nodeAddr:\"</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token class-name\">AquaSimAddress</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ConvertFrom</span><span class=\"token punctuation\">(</span>m_device<span class=\"token operator\">-></span><span class=\"token function\">GetAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetAsInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  m_sendUpPktCount<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token function\">NS_LOG_INFO</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Me(\"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token class-name\">AquaSimAddress</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ConvertFrom</span><span class=\"token punctuation\">(</span>m_device<span class=\"token operator\">-></span><span class=\"token function\">GetAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetAsInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"): SendUp: \"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" bytes ; \"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>              <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetTxTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetSeconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" sec. ; Dest: \"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>              <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetDAddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetAsInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>              <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" ; Src: \"</span> <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetSAddr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetAsInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>              <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" ; Forwards: \"</span> <span class=\"token operator\">&lt;&lt;</span> ash<span class=\"token punctuation\">.</span><span class=\"token function\">GetNumForwards</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" ; Packet counter=\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>              <span class=\"token operator\">&lt;&lt;</span> m_sendUpPktCount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token comment\">/*TODO this needs to be fully implemented with the multiplexer</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          Or at least sent up for further processing</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          ie. Sync, Localization, Application driven</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    NOTE: AquaSimPhyCmn::SendPktUp()</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  */</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token function\">m_routingRxCbTrace</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这里是通过回调来继续上传</p>\n<p>流程图如下所示：</p>\n<p><img data-src=\"https://yeyu-blog.oss-cn-beijing.aliyuncs.com/article_images/ns3.32%20Aqua-sim-ng%E6%A8%A1%E5%9D%97%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg\" alt=\"Aqua-sim-ng水声模块流程图\" /></p>\n",
            "tags": [
                "ns3",
                "ns3"
            ]
        },
        {
            "id": "http://jluyeyu.com/ns3/12.ns3%20wifi%E6%A8%A1%E5%9D%97%E4%BB%8ESocket%E5%88%B0WifiNetDevice/",
            "url": "http://jluyeyu.com/ns3/12.ns3%20wifi%E6%A8%A1%E5%9D%97%E4%BB%8ESocket%E5%88%B0WifiNetDevice/",
            "title": "12.ns3 wifi模块从Socket到WifiNetDevice",
            "date_published": "2022-11-09T06:00:00.000Z",
            "content_html": "<h2 id=\"12ns3-wifi模块从socket到wifinetdevice\"><a class=\"anchor\" href=\"#12ns3-wifi模块从socket到wifinetdevice\">#</a> 12.ns3 wifi 模块从 Socket 到 WifiNetDevice</h2>\n<p>在本节中，将从源码的角度解析 <code>ns3</code>  的 <code>wifi</code>  模块，包括一个 <code>packet</code>  是如何从一台主机的 <code>Socket</code>  到另一台主机的 <code>Socket</code> 。</p>\n<p>PS:</p>\n<ol>\n<li>\n<p>本节很长，而且很枯燥，但是对扩展 <code>ns3</code>  功能，了解 <code>ns3</code>  流程非常有帮助，请耐心观看。</p>\n</li>\n<li>\n<p>本节的源码来自于 <code>ns3.32</code> , 不同版本之间有一些差异，但大致流程差不多，可以互相参考。</p>\n</li>\n<li>\n<p>本节需要一定的前置知识，推荐先阅读上一节<span class=\"exturl\" data-url=\"aHR0cDovL3d3dy5qbHV5ZXl1LmNvbS9uczMvMTEubnMzJTIwd2lmaSVFNiVBOCVBMSVFNSU5RCU5NyVFNiVCNSU4MSVFNyVBOCU4QiVFNiVCQSU5MCVFNyVBMCU4MSVFOCVBNyVBMyVFNiU5RSU5MC8=\"> 11.ns3 wifi 模块流程源码解析</span>，大致了解 <code>Packet</code>  从 <code>NetDevice</code>  到物理层之间的调用过程</p>\n</li>\n</ol>\n<h3 id=\"发送过程分析\"><a class=\"anchor\" href=\"#发送过程分析\">#</a> 发送过程分析</h3>\n<p><code>Socket</code>  通信必定离不开 <code>Socket::Send</code>  函数，所以今天我们的起点就是 <code>Socket::Send</code></p>\n<p><code>network/model/socket.h</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   * \\brief Send data (or dummy data) to the remote host</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   *</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   * This function matches closely in semantics to the send() function</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   * call in the standard C library (libc):</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   *   ssize_t send (int s, const void *msg, size_t len, int flags);</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   * except that the send I/O is asynchronous.  This is the</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   * primary Send method at this low-level API and must be implemented </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   * by subclasses.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   * </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   * In a typical blocking sockets model, this call would block upon</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   * lack of space to hold the message to be sent.  In ns-3 at this</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   * API, the call returns immediately in such a case, but the callback</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   * registered with SetSendCallback() is invoked when the socket</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   * has space (when it conceptually unblocks); this is an asynchronous</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   * I/O model for send().</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   * </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   * This variant of Send() uses class ns3::Packet to encapsulate</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   * data, rather than providing a raw pointer and length field.</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   * This allows an ns-3 application to attach tags if desired (such</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   * as a flow ID) and may allow the simulator to avoid some data</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   * copies.  Despite the appearance of sending Packets on a stream</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>   * socket, just think of it as a fancy byte buffer with streaming</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   * semantics.</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>   *</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>   * If either the message buffer within the Packet is too long to pass </pre></td></tr><tr><td data-num=\"27\"></td><td><pre>   * atomically through the underlying protocol (for datagram sockets), </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>   * or the message buffer cannot entirely fit in the transmit buffer</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>   * (for stream sockets), -1 is returned and SocketErrno is set </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>   * to ERROR_MSGSIZE.  If the packet does not fit, the caller can</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>   * split the Packet (based on information obtained from </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>   * GetTxAvailable) and reattempt to send the data.</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>   *</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>   * The flags argument is formed by or'ing one or more of the values:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>   *        MSG_OOB        process out-of-band data </pre></td></tr><tr><td data-num=\"36\"></td><td><pre>   *        MSG_DONTROUTE  bypass routing, use direct interface </pre></td></tr><tr><td data-num=\"37\"></td><td><pre>   * These flags are _unsupported_ as of ns-3.1.</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>   *</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>   * \\param p ns3::Packet to send</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>   * \\param flags Socket control flags</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>   * \\returns the number of bytes accepted for transmission if no error</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>   *          occurs, and -1 otherwise.</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>   *</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>   * \\see SetSendCallback</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>   */</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">int</span> <span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> p<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint32_t</span> flags<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>虚函数，需要查看子类的实现</p>\n<p><img data-src=\"https://yeyu-blog.oss-cn-beijing.aliyuncs.com/article_images/ns3.32%20socket%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB%E5%9B%BE.jpg\" alt=\"Socket继承关系\" /></p>\n<p>因为本人最常用的是 <code>UdpSocket</code> ，所以拿 <code>UdpSocket</code>  为例。</p>\n<p><code>UdpSocket</code>  里不包含 <code>Send</code>  函数，所以其实现是在子类 <code>UdpSocketImpl</code>  里面</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">UdpSocketImpl</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> p<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint32_t</span> flags<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> p <span class=\"token operator\">&lt;&lt;</span> flags<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>m_connected<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      m_errno <span class=\"token operator\">=</span> ERROR_NOTCONN<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token function\">DoSend</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">int</span> </pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token class-name\">UdpSocketImpl</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">DoSend</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> p<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>m_endPoint <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Ipv4Address</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">IsMatchingType</span><span class=\"token punctuation\">(</span>m_defaultAddress<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">Bind</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>m_endPoint <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>m_endPoint <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>m_endPoint6 <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Ipv6Address</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">IsMatchingType</span><span class=\"token punctuation\">(</span>m_defaultAddress<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">Bind6</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>m_endPoint6 <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>m_endPoint6 <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_shutdownSend<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      m_errno <span class=\"token operator\">=</span> ERROR_SHUTDOWN<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> </pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Ipv4Address</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">IsMatchingType</span> <span class=\"token punctuation\">(</span>m_defaultAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      <span class=\"token keyword\">return</span> <span class=\"token function\">DoSendTo</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Ipv4Address</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ConvertFrom</span> <span class=\"token punctuation\">(</span>m_defaultAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> m_defaultPort<span class=\"token punctuation\">,</span> <span class=\"token function\">GetIpTos</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Ipv6Address</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">IsMatchingType</span> <span class=\"token punctuation\">(</span>m_defaultAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      <span class=\"token keyword\">return</span> <span class=\"token function\">DoSendTo</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Ipv6Address</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ConvertFrom</span> <span class=\"token punctuation\">(</span>m_defaultAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> m_defaultPort<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  m_errno <span class=\"token operator\">=</span> ERROR_AFNOSUPPORT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  <span class=\"token keyword\">return</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>Send</code>  方法调用 <code>DoSend</code>  方法，其中 <code>DoSend</code>  方法做了一些判断，判断 <code>socket</code>  实现已经 <code>bind</code>  和 <code>connection</code> 。</p>\n<p><code>UdpSocketImpl::DoSend</code>  方法又调用了 <code>DoSendTo</code>  方法，分为两种情况，一种是 <code>IPV4</code> ，一种是 <code>IPV6</code> .</p>\n<p>这里还是以 <code>Ipv4</code>  为例说明。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">UdpSocketImpl</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">DoSendTo</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> p<span class=\"token punctuation\">,</span> Ipv4Address dest<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint16_t</span> port<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint8_t</span> tos<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> p <span class=\"token operator\">&lt;&lt;</span> dest <span class=\"token operator\">&lt;&lt;</span> port <span class=\"token operator\">&lt;&lt;</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">uint16_t</span><span class=\"token punctuation\">)</span> tos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_boundnetdevice<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Bound interface number \"</span> <span class=\"token operator\">&lt;&lt;</span> m_boundnetdevice<span class=\"token operator\">-></span><span class=\"token function\">GetIfIndex</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_endPoint <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">Bind</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>          <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>m_endPoint <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>          <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>m_endPoint <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_shutdownSend<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      m_errno <span class=\"token operator\">=</span> ERROR_SHUTDOWN<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token function\">GetTxAvailable</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      m_errno <span class=\"token operator\">=</span> ERROR_MSGSIZE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token keyword\">uint8_t</span> priority <span class=\"token operator\">=</span> <span class=\"token function\">GetPriority</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tos<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      SocketIpTosTag ipTosTag<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      ipTosTag<span class=\"token punctuation\">.</span><span class=\"token function\">SetTos</span> <span class=\"token punctuation\">(</span>tos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      <span class=\"token comment\">// This packet may already have a SocketIpTosTag (see BUG 2440)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      p<span class=\"token operator\">-></span><span class=\"token function\">ReplacePacketTag</span> <span class=\"token punctuation\">(</span>ipTosTag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      priority <span class=\"token operator\">=</span> <span class=\"token function\">IpTos2Priority</span> <span class=\"token punctuation\">(</span>tos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>priority<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      SocketPriorityTag priorityTag<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      priorityTag<span class=\"token punctuation\">.</span><span class=\"token function\">SetPriority</span> <span class=\"token punctuation\">(</span>priority<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      p<span class=\"token operator\">-></span><span class=\"token function\">ReplacePacketTag</span> <span class=\"token punctuation\">(</span>priorityTag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>Ipv4<span class=\"token operator\">></span> ipv4 <span class=\"token operator\">=</span> m_node<span class=\"token operator\">-></span><span class=\"token generic-function\"><span class=\"token function\">GetObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Ipv4<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  <span class=\"token comment\">// Locally override the IP TTL for this socket</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  <span class=\"token comment\">// We cannot directly modify the TTL at this stage, so we set a Packet tag</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  <span class=\"token comment\">// The destination can be either multicast, unicast/anycast, or</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  <span class=\"token comment\">// either all-hosts broadcast or limited (subnet-directed) broadcast.</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token comment\">// For the latter two broadcast types, the TTL will later be set to one</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  <span class=\"token comment\">// irrespective of what is set in these socket options.  So, this tagging</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  <span class=\"token comment\">// may end up setting the TTL of a limited broadcast packet to be</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  <span class=\"token comment\">// the same as a unicast, but it will be fixed further down the stack</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_ipMulticastTtl <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> dest<span class=\"token punctuation\">.</span><span class=\"token function\">IsMulticast</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>      SocketIpTtlTag tag<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      tag<span class=\"token punctuation\">.</span><span class=\"token function\">SetTtl</span> <span class=\"token punctuation\">(</span>m_ipMulticastTtl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>      p<span class=\"token operator\">-></span><span class=\"token function\">AddPacketTag</span> <span class=\"token punctuation\">(</span>tag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">IsManualIpTtl</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">GetIpTtl</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>dest<span class=\"token punctuation\">.</span><span class=\"token function\">IsMulticast</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>dest<span class=\"token punctuation\">.</span><span class=\"token function\">IsBroadcast</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>      SocketIpTtlTag tag<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>      tag<span class=\"token punctuation\">.</span><span class=\"token function\">SetTtl</span> <span class=\"token punctuation\">(</span><span class=\"token function\">GetIpTtl</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>      p<span class=\"token operator\">-></span><span class=\"token function\">AddPacketTag</span> <span class=\"token punctuation\">(</span>tag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    SocketSetDontFragmentTag tag<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    <span class=\"token keyword\">bool</span> found <span class=\"token operator\">=</span> p<span class=\"token operator\">-></span><span class=\"token function\">RemovePacketTag</span> <span class=\"token punctuation\">(</span>tag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>found<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_mtuDiscover<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>          <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>            tag<span class=\"token punctuation\">.</span><span class=\"token function\">Enable</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>            tag<span class=\"token punctuation\">.</span><span class=\"token function\">Disable</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        p<span class=\"token operator\">-></span><span class=\"token function\">AddPacketTag</span> <span class=\"token punctuation\">(</span>tag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>  <span class=\"token comment\">// Note that some systems will only send limited broadcast packets</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>  <span class=\"token comment\">// out of the \"default\" interface; here we send it out all interfaces</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dest<span class=\"token punctuation\">.</span><span class=\"token function\">IsBroadcast</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>m_allowBroadcast<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>          m_errno <span class=\"token operator\">=</span> ERROR_OPNOTSUPP<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>          <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>      <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Limited broadcast start.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">uint32_t</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> ipv4<span class=\"token operator\">-></span><span class=\"token function\">GetNInterfaces</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>          <span class=\"token comment\">// Get the primary address</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>          Ipv4InterfaceAddress iaddr <span class=\"token operator\">=</span> ipv4<span class=\"token operator\">-></span><span class=\"token function\">GetAddress</span> <span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>          Ipv4Address addri <span class=\"token operator\">=</span> iaddr<span class=\"token punctuation\">.</span><span class=\"token function\">GetLocal</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>addri <span class=\"token operator\">==</span> <span class=\"token function\">Ipv4Address</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"127.0.0.1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>            <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>          <span class=\"token comment\">// Check if interface-bound socket</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_boundnetdevice<span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"105\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ipv4<span class=\"token operator\">-></span><span class=\"token function\">GetNetDevice</span> <span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> m_boundnetdevice<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>                <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>          <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Sending one copy from \"</span> <span class=\"token operator\">&lt;&lt;</span> addri <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" to \"</span> <span class=\"token operator\">&lt;&lt;</span> dest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>          m_udp<span class=\"token operator\">-></span><span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span>p<span class=\"token operator\">-></span><span class=\"token function\">Copy</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> addri<span class=\"token punctuation\">,</span> dest<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>                       m_endPoint<span class=\"token operator\">-></span><span class=\"token function\">GetLocalPort</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> port<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>          <span class=\"token function\">NotifyDataSent</span> <span class=\"token punctuation\">(</span>p<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>          <span class=\"token function\">NotifySend</span> <span class=\"token punctuation\">(</span><span class=\"token function\">GetTxAvailable</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>      <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Limited broadcast end.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>      <span class=\"token keyword\">return</span> p<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_endPoint<span class=\"token operator\">-></span><span class=\"token function\">GetLocalAddress</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token class-name\">Ipv4Address</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">GetAny</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>      m_udp<span class=\"token operator\">-></span><span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span>p<span class=\"token operator\">-></span><span class=\"token function\">Copy</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> m_endPoint<span class=\"token operator\">-></span><span class=\"token function\">GetLocalAddress</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> dest<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>                   m_endPoint<span class=\"token operator\">-></span><span class=\"token function\">GetLocalPort</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> port<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>      <span class=\"token function\">NotifyDataSent</span> <span class=\"token punctuation\">(</span>p<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>      <span class=\"token function\">NotifySend</span> <span class=\"token punctuation\">(</span><span class=\"token function\">GetTxAvailable</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>      <span class=\"token keyword\">return</span> p<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ipv4<span class=\"token operator\">-></span><span class=\"token function\">GetRoutingProtocol</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>      Ipv4Header header<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>      header<span class=\"token punctuation\">.</span><span class=\"token function\">SetDestination</span> <span class=\"token punctuation\">(</span>dest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>      header<span class=\"token punctuation\">.</span><span class=\"token function\">SetProtocol</span> <span class=\"token punctuation\">(</span>UdpL4Protocol<span class=\"token double-colon punctuation\">::</span>PROT_NUMBER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>      Socket<span class=\"token double-colon punctuation\">::</span>SocketErrno errno_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>      Ptr<span class=\"token operator\">&lt;</span>Ipv4Route<span class=\"token operator\">></span> route<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>      Ptr<span class=\"token operator\">&lt;</span>NetDevice<span class=\"token operator\">></span> oif <span class=\"token operator\">=</span> m_boundnetdevice<span class=\"token punctuation\">;</span> <span class=\"token comment\">//specify non-zero if bound to a specific device</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>      <span class=\"token comment\">// TBD-- we could cache the route and just check its validity</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>      route <span class=\"token operator\">=</span> ipv4<span class=\"token operator\">-></span><span class=\"token function\">GetRoutingProtocol</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">RouteOutput</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> header<span class=\"token punctuation\">,</span> oif<span class=\"token punctuation\">,</span> errno_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"136\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>route <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>          <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Route exists\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>m_allowBroadcast<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>              <span class=\"token comment\">// Here we try to route subnet-directed broadcasts</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>              <span class=\"token keyword\">uint32_t</span> outputIfIndex <span class=\"token operator\">=</span> ipv4<span class=\"token operator\">-></span><span class=\"token function\">GetInterfaceForDevice</span> <span class=\"token punctuation\">(</span>route<span class=\"token operator\">-></span><span class=\"token function\">GetOutputDevice</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>              <span class=\"token keyword\">uint32_t</span> ifNAddr <span class=\"token operator\">=</span> ipv4<span class=\"token operator\">-></span><span class=\"token function\">GetNAddresses</span> <span class=\"token punctuation\">(</span>outputIfIndex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>              <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">uint32_t</span> addrI <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> addrI <span class=\"token operator\">&lt;</span> ifNAddr<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>addrI<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>                <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>                  Ipv4InterfaceAddress ifAddr <span class=\"token operator\">=</span> ipv4<span class=\"token operator\">-></span><span class=\"token function\">GetAddress</span> <span class=\"token punctuation\">(</span>outputIfIndex<span class=\"token punctuation\">,</span> addrI<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>                  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dest <span class=\"token operator\">==</span> ifAddr<span class=\"token punctuation\">.</span><span class=\"token function\">GetBroadcast</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>                    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>                      m_errno <span class=\"token operator\">=</span> ERROR_OPNOTSUPP<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>                      <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>          header<span class=\"token punctuation\">.</span><span class=\"token function\">SetSource</span> <span class=\"token punctuation\">(</span>route<span class=\"token operator\">-></span><span class=\"token function\">GetSource</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>          m_udp<span class=\"token operator\">-></span><span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span>p<span class=\"token operator\">-></span><span class=\"token function\">Copy</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> header<span class=\"token punctuation\">.</span><span class=\"token function\">GetSource</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> header<span class=\"token punctuation\">.</span><span class=\"token function\">GetDestination</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>                       m_endPoint<span class=\"token operator\">-></span><span class=\"token function\">GetLocalPort</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> port<span class=\"token punctuation\">,</span> route<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>          <span class=\"token function\">NotifyDataSent</span> <span class=\"token punctuation\">(</span>p<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>          <span class=\"token keyword\">return</span> p<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>      <span class=\"token keyword\">else</span> </pre></td></tr><tr><td data-num=\"162\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>          <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"No route to destination\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>          <span class=\"token function\">NS_LOG_ERROR</span> <span class=\"token punctuation\">(</span>errno_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>          m_errno <span class=\"token operator\">=</span> errno_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>          <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>      <span class=\"token function\">NS_LOG_ERROR</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ERROR_NOROUTETOHOST\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>      m_errno <span class=\"token operator\">=</span> ERROR_NOROUTETOHOST<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>      <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这里面有一个关键的步骤就是 <code>Socket</code>  发送的时候只知道目的节点 <code>dest</code> ，在传输的过程中，我们需要知道下一跳的节点 <code>next</code>  是什么？通常来说这是由配置的路由协议来决定的，这节的重点不是路由，所以我们先跳过这点，只需知道，在这时，已经找到了下一跳 <code>next</code> 。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// TBD-- we could cache the route and just check its validity</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>route <span class=\"token operator\">=</span> ipv4<span class=\"token operator\">-></span><span class=\"token function\">GetRoutingProtocol</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">RouteOutput</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> header<span class=\"token punctuation\">,</span> oif<span class=\"token punctuation\">,</span> errno_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>回到函数中，我们可以看到得到 <code>next</code>  后，下一步调用的是 <code>m_udp-&gt;Send</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>m_udp<span class=\"token operator\">-></span><span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span>p<span class=\"token operator\">-></span><span class=\"token function\">Copy</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> header<span class=\"token punctuation\">.</span><span class=\"token function\">GetSource</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> header<span class=\"token punctuation\">.</span><span class=\"token function\">GetDestination</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                       m_endPoint<span class=\"token operator\">-></span><span class=\"token function\">GetLocalPort</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> port<span class=\"token punctuation\">,</span> route<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>其中的 <code>m_udp</code>  对象就是 <code>UdpL4Protocol</code>  类对象，所以下一步是调用的 <code>UdpL4Protocol::Send</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">UdpL4Protocol</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                     Ipv4Address saddr<span class=\"token punctuation\">,</span> Ipv4Address daddr<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                     <span class=\"token keyword\">uint16_t</span> sport<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint16_t</span> dport<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> packet <span class=\"token operator\">&lt;&lt;</span> saddr <span class=\"token operator\">&lt;&lt;</span> daddr <span class=\"token operator\">&lt;&lt;</span> sport <span class=\"token operator\">&lt;&lt;</span> dport<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  UdpHeader udpHeader<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Node</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ChecksumEnabled</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      udpHeader<span class=\"token punctuation\">.</span><span class=\"token function\">EnableChecksums</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      udpHeader<span class=\"token punctuation\">.</span><span class=\"token function\">InitializeChecksum</span> <span class=\"token punctuation\">(</span>saddr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                                    daddr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                                    PROT_NUMBER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  udpHeader<span class=\"token punctuation\">.</span><span class=\"token function\">SetDestinationPort</span> <span class=\"token punctuation\">(</span>dport<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  udpHeader<span class=\"token punctuation\">.</span><span class=\"token function\">SetSourcePort</span> <span class=\"token punctuation\">(</span>sport<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  packet<span class=\"token operator\">-></span><span class=\"token function\">AddHeader</span> <span class=\"token punctuation\">(</span>udpHeader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token function\">m_downTarget</span> <span class=\"token punctuation\">(</span>packet<span class=\"token punctuation\">,</span> saddr<span class=\"token punctuation\">,</span> daddr<span class=\"token punctuation\">,</span> PROT_NUMBER<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这里 <code>UdpL4Protocol::Send</code>  方法调用了一个 <code>m_downTarget</code>  的回调地址。 <code>m_downTarget</code>  的值的设置代码如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * This method is called by AggregateObject and completes the aggregation</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * by setting the node in the udp stack and link it to the ipv4 object</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * present in the node along with the socket factory</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token class-name\">UdpL4Protocol</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">NotifyNewAggregate</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>Node<span class=\"token operator\">></span> node <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token operator\">-></span><span class=\"token generic-function\"><span class=\"token function\">GetObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Node<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>Ipv4<span class=\"token operator\">></span> ipv4 <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token operator\">-></span><span class=\"token generic-function\"><span class=\"token function\">GetObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Ipv4<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>Ipv6<span class=\"token operator\">></span> ipv6 <span class=\"token operator\">=</span> node<span class=\"token operator\">-></span><span class=\"token generic-function\"><span class=\"token function\">GetObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Ipv6<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_node <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>node <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>ipv4 <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> ipv6 <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>          <span class=\"token keyword\">this</span><span class=\"token operator\">-></span><span class=\"token function\">SetNode</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          Ptr<span class=\"token operator\">&lt;</span>UdpSocketFactoryImpl<span class=\"token operator\">></span> udpFactory <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">CreateObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>UdpSocketFactoryImpl<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          udpFactory<span class=\"token operator\">-></span><span class=\"token function\">SetUdp</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          node<span class=\"token operator\">-></span><span class=\"token function\">AggregateObject</span> <span class=\"token punctuation\">(</span>udpFactory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token comment\">// We set at least one of our 2 down targets to the IPv4/IPv6 send</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token comment\">// functions.  Since these functions have different prototypes, we</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token comment\">// need to keep track of whether we are connected to an IPv4 or</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token comment\">// IPv6 lower layer and call the appropriate one.</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ipv4 <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> m_downTarget<span class=\"token punctuation\">.</span><span class=\"token function\">IsNull</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      ipv4<span class=\"token operator\">-></span><span class=\"token function\">Insert</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token keyword\">this</span><span class=\"token operator\">-></span><span class=\"token function\">SetDownTarget</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Ipv4<span class=\"token double-colon punctuation\">::</span>Send<span class=\"token punctuation\">,</span> ipv4<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ipv6 <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> m_downTarget6<span class=\"token punctuation\">.</span><span class=\"token function\">IsNull</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      ipv6<span class=\"token operator\">-></span><span class=\"token function\">Insert</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token keyword\">this</span><span class=\"token operator\">-></span><span class=\"token function\">SetDownTarget6</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Ipv6<span class=\"token double-colon punctuation\">::</span>Send<span class=\"token punctuation\">,</span> ipv6<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token class-name\">IpL4Protocol</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">NotifyNewAggregate</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>所以实际调用的是 <code>Ipv4::Send</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">virtual</span> <span class=\"token keyword\">void</span> <span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span> Ipv4Address source<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                     Ipv4Address destination<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint8_t</span> protocol<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span>Ipv4Route<span class=\"token operator\">></span> route<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>是个虚函数，所以同样看其子类</p>\n<p><img data-src=\"https://yeyu-blog.oss-cn-beijing.aliyuncs.com/article_images/ns3.32%20Ipv4%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB%E5%9B%BE.jpg\" alt=\"Ipv4继承关系图\" /></p>\n<p>这里我们也同样只看其中一个， <code>Ipv4L3Protocol</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">Ipv4L3Protocol</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                      Ipv4Address source<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                      Ipv4Address destination<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                      <span class=\"token keyword\">uint8_t</span> protocol<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                      Ptr<span class=\"token operator\">&lt;</span>Ipv4Route<span class=\"token operator\">></span> route<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> packet <span class=\"token operator\">&lt;&lt;</span> source <span class=\"token operator\">&lt;&lt;</span> destination <span class=\"token operator\">&lt;&lt;</span> <span class=\"token keyword\">uint32_t</span> <span class=\"token punctuation\">(</span>protocol<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> route<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">bool</span> mayFragment <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token comment\">// we need a copy of the packet with its tags in case we need to invoke recursion.</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> pktCopyWithTags <span class=\"token operator\">=</span> packet<span class=\"token operator\">-></span><span class=\"token function\">Copy</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token keyword\">uint8_t</span> ttl <span class=\"token operator\">=</span> m_defaultTtl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  SocketIpTtlTag ipTtlTag<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token keyword\">bool</span> ipTtlTagFound <span class=\"token operator\">=</span> packet<span class=\"token operator\">-></span><span class=\"token function\">RemovePacketTag</span> <span class=\"token punctuation\">(</span>ipTtlTag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ipTtlTagFound<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      ttl <span class=\"token operator\">=</span> ipTtlTag<span class=\"token punctuation\">.</span><span class=\"token function\">GetTtl</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token keyword\">uint8_t</span> tos <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  SocketIpTosTag ipTosTag<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token keyword\">bool</span> ipTosTagFound <span class=\"token operator\">=</span> packet<span class=\"token operator\">-></span><span class=\"token function\">RemovePacketTag</span> <span class=\"token punctuation\">(</span>ipTosTag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ipTosTagFound<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      tos <span class=\"token operator\">=</span> ipTosTag<span class=\"token punctuation\">.</span><span class=\"token function\">GetTos</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token comment\">// can construct the header here</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  Ipv4Header ipHeader <span class=\"token operator\">=</span> <span class=\"token function\">BuildHeader</span> <span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span> destination<span class=\"token punctuation\">,</span> protocol<span class=\"token punctuation\">,</span> packet<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> ttl<span class=\"token punctuation\">,</span> tos<span class=\"token punctuation\">,</span> mayFragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token comment\">// Handle a few cases:</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token comment\">// 1) packet is passed in with a route entry</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token comment\">// 1a) packet is passed in with a route entry but route->GetGateway is not set (e.g., on-demand)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token comment\">// 1b) packet is passed in with a route entry and valid gateway</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token comment\">// 2) packet is passed without a route and packet is destined to limited broadcast address</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token comment\">// 3) packet is passed without a route and packet is destined to a subnet-directed broadcast address</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token comment\">// 4) packet is passed without a route, packet is not broadcast (e.g., a raw socket call, or ICMP)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token comment\">// 1) packet is passed in with route entry</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>route<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      <span class=\"token comment\">// 1a) route->GetGateway is not set (e.g., on-demand)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>route<span class=\"token operator\">-></span><span class=\"token function\">GetGateway</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">IsInitialized</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          <span class=\"token comment\">// This could arise because the synchronous RouteOutput() call</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          <span class=\"token comment\">// returned to the transport protocol with a source address but</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          <span class=\"token comment\">// there was no next hop available yet (since a route may need</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>          <span class=\"token comment\">// to be queried).</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          <span class=\"token function\">NS_FATAL_ERROR</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Ipv4L3Protocol::Send case 1a: packet passed with a route but the Gateway address is uninitialized. This case not yet implemented.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>      <span class=\"token comment\">// 1b) with a valid gateway</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Ipv4L3Protocol::Send case 1b:  passed in with route and valid gateway\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      <span class=\"token keyword\">int32_t</span> interface <span class=\"token operator\">=</span> <span class=\"token function\">GetInterfaceForDevice</span> <span class=\"token punctuation\">(</span>route<span class=\"token operator\">-></span><span class=\"token function\">GetOutputDevice</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      <span class=\"token function\">m_sendOutgoingTrace</span> <span class=\"token punctuation\">(</span>ipHeader<span class=\"token punctuation\">,</span> packet<span class=\"token punctuation\">,</span> interface<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>      <span class=\"token function\">SendRealOut</span> <span class=\"token punctuation\">(</span>route<span class=\"token punctuation\">,</span> packet<span class=\"token operator\">-></span><span class=\"token function\">Copy</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> ipHeader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  <span class=\"token comment\">// 2) packet is destined to limited broadcast address or link-local multicast address</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>destination<span class=\"token punctuation\">.</span><span class=\"token function\">IsBroadcast</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> destination<span class=\"token punctuation\">.</span><span class=\"token function\">IsLocalMulticast</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>      <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Ipv4L3Protocol::Send case 2:  limited broadcast - no route\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>      <span class=\"token keyword\">uint32_t</span> ifaceIndex <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>Ipv4InterfaceList<span class=\"token double-colon punctuation\">::</span>iterator ifaceIter <span class=\"token operator\">=</span> m_interfaces<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>           ifaceIter <span class=\"token operator\">!=</span> m_interfaces<span class=\"token punctuation\">.</span><span class=\"token function\">end</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> ifaceIter<span class=\"token operator\">++</span><span class=\"token punctuation\">,</span> ifaceIndex<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>          Ptr<span class=\"token operator\">&lt;</span>Ipv4Interface<span class=\"token operator\">></span> outInterface <span class=\"token operator\">=</span> <span class=\"token operator\">*</span>ifaceIter<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>          <span class=\"token comment\">// ANY source matches any interface</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>          <span class=\"token keyword\">bool</span> sendIt <span class=\"token operator\">=</span> source<span class=\"token punctuation\">.</span><span class=\"token function\">IsAny</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>          <span class=\"token comment\">// check if some specific address on outInterface matches</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>          <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">uint32_t</span> index <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">!</span>sendIt <span class=\"token operator\">&amp;&amp;</span> index <span class=\"token operator\">&lt;</span> outInterface<span class=\"token operator\">-></span><span class=\"token function\">GetNAddresses</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> index<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>outInterface<span class=\"token operator\">-></span><span class=\"token function\">GetAddress</span> <span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetLocal</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> source<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>                <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>                  sendIt <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sendIt<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>              <span class=\"token comment\">// create a proxy route for this interface</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>              Ptr<span class=\"token operator\">&lt;</span>Ipv4Route<span class=\"token operator\">></span> route <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Ipv4Route<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>              route<span class=\"token operator\">-></span><span class=\"token function\">SetDestination</span> <span class=\"token punctuation\">(</span>destination<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>              route<span class=\"token operator\">-></span><span class=\"token function\">SetGateway</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Ipv4Address</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">GetAny</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>              route<span class=\"token operator\">-></span><span class=\"token function\">SetSource</span> <span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>              route<span class=\"token operator\">-></span><span class=\"token function\">SetOutputDevice</span> <span class=\"token punctuation\">(</span>outInterface<span class=\"token operator\">-></span><span class=\"token function\">GetDevice</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>              <span class=\"token function\">DecreaseIdentification</span> <span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span> destination<span class=\"token punctuation\">,</span> protocol<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>              <span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span>pktCopyWithTags<span class=\"token punctuation\">,</span> source<span class=\"token punctuation\">,</span> destination<span class=\"token punctuation\">,</span> protocol<span class=\"token punctuation\">,</span> route<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>  <span class=\"token comment\">// 3) check: packet is destined to a subnet-directed broadcast address</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>Ipv4InterfaceList<span class=\"token double-colon punctuation\">::</span>iterator ifaceIter <span class=\"token operator\">=</span> m_interfaces<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>       ifaceIter <span class=\"token operator\">!=</span> m_interfaces<span class=\"token punctuation\">.</span><span class=\"token function\">end</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> ifaceIter<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>      Ptr<span class=\"token operator\">&lt;</span>Ipv4Interface<span class=\"token operator\">></span> outInterface <span class=\"token operator\">=</span> <span class=\"token operator\">*</span>ifaceIter<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>      <span class=\"token keyword\">uint32_t</span> ifaceIndex <span class=\"token operator\">=</span> <span class=\"token function\">GetInterfaceForDevice</span> <span class=\"token punctuation\">(</span>outInterface<span class=\"token operator\">-></span><span class=\"token function\">GetDevice</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">uint32_t</span> j <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> j <span class=\"token operator\">&lt;</span> <span class=\"token function\">GetNAddresses</span> <span class=\"token punctuation\">(</span>ifaceIndex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> j<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>          Ipv4InterfaceAddress ifAddr <span class=\"token operator\">=</span> <span class=\"token function\">GetAddress</span> <span class=\"token punctuation\">(</span>ifaceIndex<span class=\"token punctuation\">,</span> j<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>          <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Testing address \"</span> <span class=\"token operator\">&lt;&lt;</span> ifAddr<span class=\"token punctuation\">.</span><span class=\"token function\">GetLocal</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" with mask \"</span> <span class=\"token operator\">&lt;&lt;</span> ifAddr<span class=\"token punctuation\">.</span><span class=\"token function\">GetMask</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>destination<span class=\"token punctuation\">.</span><span class=\"token function\">IsSubnetDirectedBroadcast</span> <span class=\"token punctuation\">(</span>ifAddr<span class=\"token punctuation\">.</span><span class=\"token function\">GetMask</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> </pre></td></tr><tr><td data-num=\"109\"></td><td><pre>              destination<span class=\"token punctuation\">.</span><span class=\"token function\">CombineMask</span> <span class=\"token punctuation\">(</span>ifAddr<span class=\"token punctuation\">.</span><span class=\"token function\">GetMask</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> ifAddr<span class=\"token punctuation\">.</span><span class=\"token function\">GetLocal</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">CombineMask</span> <span class=\"token punctuation\">(</span>ifAddr<span class=\"token punctuation\">.</span><span class=\"token function\">GetMask</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>   <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>              <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Ipv4L3Protocol::Send case 3:  subnet directed bcast to \"</span> <span class=\"token operator\">&lt;&lt;</span> ifAddr<span class=\"token punctuation\">.</span><span class=\"token function\">GetLocal</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" - no route\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>              <span class=\"token comment\">// create a proxy route for this interface</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>              Ptr<span class=\"token operator\">&lt;</span>Ipv4Route<span class=\"token operator\">></span> route <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Ipv4Route<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>              route<span class=\"token operator\">-></span><span class=\"token function\">SetDestination</span> <span class=\"token punctuation\">(</span>destination<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>              route<span class=\"token operator\">-></span><span class=\"token function\">SetGateway</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Ipv4Address</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">GetAny</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>              route<span class=\"token operator\">-></span><span class=\"token function\">SetSource</span> <span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>              route<span class=\"token operator\">-></span><span class=\"token function\">SetOutputDevice</span> <span class=\"token punctuation\">(</span>outInterface<span class=\"token operator\">-></span><span class=\"token function\">GetDevice</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>              <span class=\"token function\">DecreaseIdentification</span> <span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span> destination<span class=\"token punctuation\">,</span> protocol<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>              <span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span>pktCopyWithTags<span class=\"token punctuation\">,</span> source<span class=\"token punctuation\">,</span> destination<span class=\"token punctuation\">,</span> protocol<span class=\"token punctuation\">,</span> route<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>              <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>  <span class=\"token comment\">// 4) packet is not broadcast, and route is NULL (e.g., a raw socket call)</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>  <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Ipv4L3Protocol::Send case 4:  not broadcast and passed in with no route \"</span> <span class=\"token operator\">&lt;&lt;</span> destination<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>  Socket<span class=\"token double-colon punctuation\">::</span>SocketErrno errno_<span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"128\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>NetDevice<span class=\"token operator\">></span> <span class=\"token function\">oif</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// unused for now</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>Ipv4Route<span class=\"token operator\">></span> newRoute<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_routingProtocol <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>      newRoute <span class=\"token operator\">=</span> m_routingProtocol<span class=\"token operator\">-></span><span class=\"token function\">RouteOutput</span> <span class=\"token punctuation\">(</span>packet<span class=\"token punctuation\">,</span> ipHeader<span class=\"token punctuation\">,</span> oif<span class=\"token punctuation\">,</span> errno_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>      <span class=\"token function\">NS_LOG_ERROR</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Ipv4L3Protocol::Send: m_routingProtocol == 0\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newRoute<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>      <span class=\"token function\">DecreaseIdentification</span> <span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span> destination<span class=\"token punctuation\">,</span> protocol<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>      <span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span>pktCopyWithTags<span class=\"token punctuation\">,</span> source<span class=\"token punctuation\">,</span> destination<span class=\"token punctuation\">,</span> protocol<span class=\"token punctuation\">,</span> newRoute<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>      <span class=\"token function\">NS_LOG_WARN</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"No route to host.  Drop.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>      <span class=\"token function\">m_dropTrace</span> <span class=\"token punctuation\">(</span>ipHeader<span class=\"token punctuation\">,</span> packet<span class=\"token punctuation\">,</span> DROP_NO_ROUTE<span class=\"token punctuation\">,</span> m_node<span class=\"token operator\">-></span><span class=\"token generic-function\"><span class=\"token function\">GetObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Ipv4<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>      <span class=\"token function\">DecreaseIdentification</span> <span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span> destination<span class=\"token punctuation\">,</span> protocol<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这个函数里对是否有 <code>route</code>  做了五种情况的区分。最终都会走到 <code>Ipv4L3Protocol::SendRealOut</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">Ipv4L3Protocol</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SendRealOut</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Ipv4Route<span class=\"token operator\">></span> route<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                             Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                             Ipv4Header <span class=\"token keyword\">const</span> <span class=\"token operator\">&amp;</span>ipHeader<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> route <span class=\"token operator\">&lt;&lt;</span> packet <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">&amp;</span>ipHeader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>route <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token function\">NS_LOG_WARN</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"No route to host.  Drop.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token function\">m_dropTrace</span> <span class=\"token punctuation\">(</span>ipHeader<span class=\"token punctuation\">,</span> packet<span class=\"token punctuation\">,</span> DROP_NO_ROUTE<span class=\"token punctuation\">,</span> m_node<span class=\"token operator\">-></span><span class=\"token generic-function\"><span class=\"token function\">GetObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Ipv4<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>NetDevice<span class=\"token operator\">></span> outDev <span class=\"token operator\">=</span> route<span class=\"token operator\">-></span><span class=\"token function\">GetOutputDevice</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token keyword\">int32_t</span> interface <span class=\"token operator\">=</span> <span class=\"token function\">GetInterfaceForDevice</span> <span class=\"token punctuation\">(</span>outDev<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>interface <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>Ipv4Interface<span class=\"token operator\">></span> outInterface <span class=\"token operator\">=</span> <span class=\"token function\">GetInterface</span> <span class=\"token punctuation\">(</span>interface<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Send via NetDevice ifIndex \"</span> <span class=\"token operator\">&lt;&lt;</span> outDev<span class=\"token operator\">-></span><span class=\"token function\">GetIfIndex</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" ipv4InterfaceIndex \"</span> <span class=\"token operator\">&lt;&lt;</span> interface<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  Ipv4Address target<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>string targetLabel<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>route<span class=\"token operator\">-></span><span class=\"token function\">GetGateway</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">IsAny</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      target <span class=\"token operator\">=</span> ipHeader<span class=\"token punctuation\">.</span><span class=\"token function\">GetDestination</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      targetLabel <span class=\"token operator\">=</span> <span class=\"token string\">\"destination\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      target <span class=\"token operator\">=</span> route<span class=\"token operator\">-></span><span class=\"token function\">GetGateway</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      targetLabel <span class=\"token operator\">=</span> <span class=\"token string\">\"gateway\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>outInterface<span class=\"token operator\">-></span><span class=\"token function\">IsUp</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Send to \"</span> <span class=\"token operator\">&lt;&lt;</span> targetLabel <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" \"</span> <span class=\"token operator\">&lt;&lt;</span> target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> packet<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> ipHeader<span class=\"token punctuation\">.</span><span class=\"token function\">GetSerializedSize</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> outInterface<span class=\"token operator\">-></span><span class=\"token function\">GetDevice</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetMtu</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          std<span class=\"token double-colon punctuation\">::</span>list<span class=\"token operator\">&lt;</span>Ipv4PayloadHeaderPair<span class=\"token operator\">></span> listFragments<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          <span class=\"token function\">DoFragmentation</span> <span class=\"token punctuation\">(</span>packet<span class=\"token punctuation\">,</span> ipHeader<span class=\"token punctuation\">,</span> outInterface<span class=\"token operator\">-></span><span class=\"token function\">GetDevice</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetMtu</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> listFragments<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span> std<span class=\"token double-colon punctuation\">::</span>list<span class=\"token operator\">&lt;</span>Ipv4PayloadHeaderPair<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span>iterator it <span class=\"token operator\">=</span> listFragments<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> it <span class=\"token operator\">!=</span> listFragments<span class=\"token punctuation\">.</span><span class=\"token function\">end</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> it<span class=\"token operator\">++</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>              <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Sending fragment \"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>it<span class=\"token operator\">-></span>first<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>              <span class=\"token function\">CallTxTrace</span> <span class=\"token punctuation\">(</span>it<span class=\"token operator\">-></span>second<span class=\"token punctuation\">,</span> it<span class=\"token operator\">-></span>first<span class=\"token punctuation\">,</span> m_node<span class=\"token operator\">-></span><span class=\"token generic-function\"><span class=\"token function\">GetObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Ipv4<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> interface<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>              outInterface<span class=\"token operator\">-></span><span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span>it<span class=\"token operator\">-></span>first<span class=\"token punctuation\">,</span> it<span class=\"token operator\">-></span>second<span class=\"token punctuation\">,</span> target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          <span class=\"token function\">CallTxTrace</span> <span class=\"token punctuation\">(</span>ipHeader<span class=\"token punctuation\">,</span> packet<span class=\"token punctuation\">,</span> m_node<span class=\"token operator\">-></span><span class=\"token generic-function\"><span class=\"token function\">GetObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Ipv4<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> interface<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          outInterface<span class=\"token operator\">-></span><span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span>packet<span class=\"token punctuation\">,</span> ipHeader<span class=\"token punctuation\">,</span> target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>outInterface</code>  的类型是 <code>Ipv4Interface</code> ，所以下一步就是</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">Ipv4Interface</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> p<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> Ipv4Header <span class=\"token operator\">&amp;</span> hdr<span class=\"token punctuation\">,</span> Ipv4Address dest<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">*</span>p <span class=\"token operator\">&lt;&lt;</span> dest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">IsUp</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token comment\">// Check for a loopback device, if it's the case we don't pass through</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\">// traffic control layer</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token generic-function\"><span class=\"token function\">DynamicCast</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>LoopbackNetDevice<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span>m_device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token comment\">/// \\todo additional checks needed here (such as whether multicast</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token comment\">/// goes to loopback)?</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      p<span class=\"token operator\">-></span><span class=\"token function\">AddHeader</span> <span class=\"token punctuation\">(</span>hdr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      m_device<span class=\"token operator\">-></span><span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> m_device<span class=\"token operator\">-></span><span class=\"token function\">GetBroadcast</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Ipv4L3Protocol<span class=\"token double-colon punctuation\">::</span>PROT_NUMBER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> </pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>m_tc <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token comment\">// is this packet aimed at a local interface ?</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>Ipv4InterfaceAddressListCI i <span class=\"token operator\">=</span> m_ifaddrs<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">!=</span> m_ifaddrs<span class=\"token punctuation\">.</span><span class=\"token function\">end</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dest <span class=\"token operator\">==</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetLocal</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          p<span class=\"token operator\">-></span><span class=\"token function\">AddHeader</span> <span class=\"token punctuation\">(</span>hdr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>          m_tc<span class=\"token operator\">-></span><span class=\"token function\">Receive</span> <span class=\"token punctuation\">(</span>m_device<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">,</span> Ipv4L3Protocol<span class=\"token double-colon punctuation\">::</span>PROT_NUMBER<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                         m_device<span class=\"token operator\">-></span><span class=\"token function\">GetBroadcast</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                         m_device<span class=\"token operator\">-></span><span class=\"token function\">GetBroadcast</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                         NetDevice<span class=\"token double-colon punctuation\">::</span>PACKET_HOST<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_device<span class=\"token operator\">-></span><span class=\"token function\">NeedsArp</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Needs ARP\"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" \"</span> <span class=\"token operator\">&lt;&lt;</span> dest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      Ptr<span class=\"token operator\">&lt;</span>ArpL3Protocol<span class=\"token operator\">></span> arp <span class=\"token operator\">=</span> m_node<span class=\"token operator\">-></span><span class=\"token generic-function\"><span class=\"token function\">GetObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>ArpL3Protocol<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      Address hardwareDestination<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      <span class=\"token keyword\">bool</span> found <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dest<span class=\"token punctuation\">.</span><span class=\"token function\">IsBroadcast</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"All-network Broadcast\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          hardwareDestination <span class=\"token operator\">=</span> m_device<span class=\"token operator\">-></span><span class=\"token function\">GetBroadcast</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          found <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dest<span class=\"token punctuation\">.</span><span class=\"token function\">IsMulticast</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"IsMulticast\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>          <span class=\"token function\">NS_ASSERT_MSG</span> <span class=\"token punctuation\">(</span>m_device<span class=\"token operator\">-></span><span class=\"token function\">IsMulticast</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                         <span class=\"token string\">\"ArpIpv4Interface::SendTo (): Sending multicast packet over \"</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                         <span class=\"token string\">\"non-multicast device\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>          hardwareDestination <span class=\"token operator\">=</span> m_device<span class=\"token operator\">-></span><span class=\"token function\">GetMulticast</span> <span class=\"token punctuation\">(</span>dest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>          found <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>          <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>Ipv4InterfaceAddressListCI i <span class=\"token operator\">=</span> m_ifaddrs<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">!=</span> m_ifaddrs<span class=\"token punctuation\">.</span><span class=\"token function\">end</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dest<span class=\"token punctuation\">.</span><span class=\"token function\">IsSubnetDirectedBroadcast</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetMask</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>                  <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Subnetwork Broadcast\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>                  hardwareDestination <span class=\"token operator\">=</span> m_device<span class=\"token operator\">-></span><span class=\"token function\">GetBroadcast</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>                  found <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>                  <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>found<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>              <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ARP Lookup\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>              found <span class=\"token operator\">=</span> arp<span class=\"token operator\">-></span><span class=\"token function\">Lookup</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> hdr<span class=\"token punctuation\">,</span> dest<span class=\"token punctuation\">,</span> m_device<span class=\"token punctuation\">,</span> m_cache<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>hardwareDestination<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>found<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Address Resolved.  Send.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>          m_tc<span class=\"token operator\">-></span><span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span>m_device<span class=\"token punctuation\">,</span> <span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Ipv4QueueDiscItem<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> hardwareDestination<span class=\"token punctuation\">,</span> Ipv4L3Protocol<span class=\"token double-colon punctuation\">::</span>PROT_NUMBER<span class=\"token punctuation\">,</span> hdr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>      <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Doesn't need ARP\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>      m_tc<span class=\"token operator\">-></span><span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span>m_device<span class=\"token punctuation\">,</span> <span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Ipv4QueueDiscItem<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> m_device<span class=\"token operator\">-></span><span class=\"token function\">GetBroadcast</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Ipv4L3Protocol<span class=\"token double-colon punctuation\">::</span>PROT_NUMBER<span class=\"token punctuation\">,</span> hdr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>m_tc</code>  类型是 <code>Ipv4Interface</code>  的 <code>Send</code>  方法会做一些判断，广播，多播、子网广播、ARP 等，处理不同。 <code>m_tc</code>  对象就是 <code>TrafficControlLayer</code>  类对象。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">TrafficControlLayer</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>NetDevice<span class=\"token operator\">></span> device<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span>QueueDiscItem<span class=\"token operator\">></span> item<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> device <span class=\"token operator\">&lt;&lt;</span> item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Send packet to device \"</span> <span class=\"token operator\">&lt;&lt;</span> device <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" protocol number \"</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                item<span class=\"token operator\">-></span><span class=\"token function\">GetProtocol</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>NetDeviceQueueInterface<span class=\"token operator\">></span> devQueueIface<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>map<span class=\"token operator\">&lt;</span>Ptr<span class=\"token operator\">&lt;</span>NetDevice<span class=\"token operator\">></span><span class=\"token punctuation\">,</span> NetDeviceInfo<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span>iterator ndi <span class=\"token operator\">=</span> m_netDevices<span class=\"token punctuation\">.</span><span class=\"token function\">find</span> <span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ndi <span class=\"token operator\">!=</span> m_netDevices<span class=\"token punctuation\">.</span><span class=\"token function\">end</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      devQueueIface <span class=\"token operator\">=</span> ndi<span class=\"token operator\">-></span>second<span class=\"token punctuation\">.</span>m_ndqi<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">// determine the transmission queue of the device where the packet will be enqueued</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>size_t txq <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>devQueueIface <span class=\"token operator\">&amp;&amp;</span> devQueueIface<span class=\"token operator\">-></span><span class=\"token function\">GetNTxQueues</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      txq <span class=\"token operator\">=</span> devQueueIface<span class=\"token operator\">-></span><span class=\"token function\">GetSelectQueueCallback</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token comment\">// otherwise, Linux determines the queue index by using a hash function</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      <span class=\"token comment\">// and associates such index to the socket which the packet belongs to,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token comment\">// so that subsequent packets of the same socket will be mapped to the</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token comment\">// same tx queue (__netdev_pick_tx function in net/core/dev.c). It is</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token comment\">// pointless to implement this in ns-3 because currently the multi-queue</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token comment\">// devices provide a select queue callback</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>devQueueIface <span class=\"token operator\">||</span> txq <span class=\"token operator\">&lt;</span> devQueueIface<span class=\"token operator\">-></span><span class=\"token function\">GetNTxQueues</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ndi <span class=\"token operator\">==</span> m_netDevices<span class=\"token punctuation\">.</span><span class=\"token function\">end</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> ndi<span class=\"token operator\">-></span>second<span class=\"token punctuation\">.</span>m_rootQueueDisc <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      <span class=\"token comment\">// The device has no attached queue disc, thus add the header to the packet and</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      <span class=\"token comment\">// send it directly to the device if the selected queue is not stopped</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>devQueueIface <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>devQueueIface<span class=\"token operator\">-></span><span class=\"token function\">GetTxQueue</span> <span class=\"token punctuation\">(</span>txq<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">IsStopped</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          item<span class=\"token operator\">-></span><span class=\"token function\">AddHeader</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          <span class=\"token comment\">// a single queue device makes no use of the priority tag</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>devQueueIface <span class=\"token operator\">||</span> devQueueIface<span class=\"token operator\">-></span><span class=\"token function\">GetNTxQueues</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>              SocketPriorityTag priorityTag<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>              item<span class=\"token operator\">-></span><span class=\"token function\">GetPacket</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">RemovePacketTag</span> <span class=\"token punctuation\">(</span>priorityTag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          device<span class=\"token operator\">-></span><span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span>item<span class=\"token operator\">-></span><span class=\"token function\">GetPacket</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> item<span class=\"token operator\">-></span><span class=\"token function\">GetAddress</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> item<span class=\"token operator\">-></span><span class=\"token function\">GetProtocol</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      <span class=\"token comment\">// Enqueue the packet in the queue disc associated with the netdevice queue</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token comment\">// selected for the packet and try to dequeue packets from such queue disc</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>      item<span class=\"token operator\">-></span><span class=\"token function\">SetTxQueueIndex</span> <span class=\"token punctuation\">(</span>txq<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      Ptr<span class=\"token operator\">&lt;</span>QueueDisc<span class=\"token operator\">></span> qDisc <span class=\"token operator\">=</span> ndi<span class=\"token operator\">-></span>second<span class=\"token punctuation\">.</span>m_queueDiscsToWake<span class=\"token punctuation\">[</span>txq<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>      <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>qDisc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      qDisc<span class=\"token operator\">-></span><span class=\"token function\">Enqueue</span> <span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      qDisc<span class=\"token operator\">-></span><span class=\"token function\">Run</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>TrafficControlLayer::Send</code>  方法会通过 <code>device-&gt;Send</code>  发送 <code>packet</code> 。<br />\n其中的 <code>device</code>  对象就是 <code>WiFiNetDevice</code>  对象。</p>\n<p>由此，完成了 <code>packet</code>  从 <code>socket</code>  对象到 <code>netdevice</code>  的发送过程。之后就是上一节的内容了</p>\n<h4 id=\"发送过程流程图\"><a class=\"anchor\" href=\"#发送过程流程图\">#</a> 发送过程流程图</h4>\n<p><img data-src=\"https://yeyu-blog.oss-cn-beijing.aliyuncs.com/article_images/Socket%E5%88%B0WifiNetDevice%E7%9A%84%E8%BF%87%E7%A8%8B.jpg\" alt=\"发送过程流程图\" /></p>\n<h3 id=\"接收过程分析\"><a class=\"anchor\" href=\"#接收过程分析\">#</a> 接收过程分析</h3>\n<p>首先回到上节描述的 <code>WifiNetDevice::ForwardUp</code> ：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">WifiNetDevice</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ForwardUp</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span> Mac48Address from<span class=\"token punctuation\">,</span> Mac48Address to<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> packet <span class=\"token operator\">&lt;&lt;</span> from <span class=\"token operator\">&lt;&lt;</span> to<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  LlcSnapHeader llc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  NetDevice<span class=\"token double-colon punctuation\">::</span>PacketType type<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">IsBroadcast</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      type <span class=\"token operator\">=</span> NetDevice<span class=\"token double-colon punctuation\">::</span>PACKET_BROADCAST<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">IsGroup</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      type <span class=\"token operator\">=</span> NetDevice<span class=\"token double-colon punctuation\">::</span>PACKET_MULTICAST<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>to <span class=\"token operator\">==</span> m_mac<span class=\"token operator\">-></span><span class=\"token function\">GetAddress</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      type <span class=\"token operator\">=</span> NetDevice<span class=\"token double-colon punctuation\">::</span>PACKET_HOST<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      type <span class=\"token operator\">=</span> NetDevice<span class=\"token double-colon punctuation\">::</span>PACKET_OTHERHOST<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> copy <span class=\"token operator\">=</span> packet<span class=\"token operator\">-></span><span class=\"token function\">Copy</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>type <span class=\"token operator\">!=</span> NetDevice<span class=\"token double-colon punctuation\">::</span>PACKET_OTHERHOST<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      m_mac<span class=\"token operator\">-></span><span class=\"token function\">NotifyRx</span> <span class=\"token punctuation\">(</span>packet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      copy<span class=\"token operator\">-></span><span class=\"token function\">RemoveHeader</span> <span class=\"token punctuation\">(</span>llc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token function\">m_forwardUp</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> copy<span class=\"token punctuation\">,</span> llc<span class=\"token punctuation\">.</span><span class=\"token function\">GetType</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> from<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      copy<span class=\"token operator\">-></span><span class=\"token function\">RemoveHeader</span> <span class=\"token punctuation\">(</span>llc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>m_promiscRx<span class=\"token punctuation\">.</span><span class=\"token function\">IsNull</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      m_mac<span class=\"token operator\">-></span><span class=\"token function\">NotifyPromiscRx</span> <span class=\"token punctuation\">(</span>copy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      <span class=\"token function\">m_promiscRx</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> copy<span class=\"token punctuation\">,</span> llc<span class=\"token punctuation\">.</span><span class=\"token function\">GetType</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> from<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">,</span> type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这里主要是两个回调，一个是 <code>m_forwardUp</code>  ，另一个是 <code>m_promiscRx</code> 。</p>\n<p><code>m_forwardUp</code>  的设置是在 <code>Node.cc</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">uint32_t</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">Node</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">AddDevice</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>NetDevice<span class=\"token operator\">></span> device<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">uint32_t</span> index <span class=\"token operator\">=</span> m_devices<span class=\"token punctuation\">.</span><span class=\"token function\">size</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  m_devices<span class=\"token punctuation\">.</span><span class=\"token function\">push_back</span> <span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  device<span class=\"token operator\">-></span><span class=\"token function\">SetNode</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  device<span class=\"token operator\">-></span><span class=\"token function\">SetIfIndex</span> <span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  device<span class=\"token operator\">-></span><span class=\"token function\">SetReceiveCallback</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Node<span class=\"token double-colon punctuation\">::</span>NonPromiscReceiveFromDevice<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ScheduleWithContext</span> <span class=\"token punctuation\">(</span><span class=\"token function\">GetId</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">Seconds</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                                  <span class=\"token operator\">&amp;</span>NetDevice<span class=\"token double-colon punctuation\">::</span>Initialize<span class=\"token punctuation\">,</span> device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token function\">NotifyDeviceAdded</span> <span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token keyword\">return</span> index<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>所以实际调用的是 <code>Node::NonPromiscReceiveFromDevice</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">bool</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">Node</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">NonPromiscReceiveFromDevice</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>NetDevice<span class=\"token operator\">></span> device<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint16_t</span> protocol<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                                   <span class=\"token keyword\">const</span> Address <span class=\"token operator\">&amp;</span>from<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> device <span class=\"token operator\">&lt;&lt;</span> packet <span class=\"token operator\">&lt;&lt;</span> protocol <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">&amp;</span>from<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token function\">ReceiveFromDevice</span> <span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">,</span> packet<span class=\"token punctuation\">,</span> protocol<span class=\"token punctuation\">,</span> from<span class=\"token punctuation\">,</span> device<span class=\"token operator\">-></span><span class=\"token function\">GetAddress</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NetDevice</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">PacketType</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">bool</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token class-name\">Node</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ReceiveFromDevice</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>NetDevice<span class=\"token operator\">></span> device<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint16_t</span> protocol<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                         <span class=\"token keyword\">const</span> Address <span class=\"token operator\">&amp;</span>from<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> Address <span class=\"token operator\">&amp;</span>to<span class=\"token punctuation\">,</span> NetDevice<span class=\"token double-colon punctuation\">::</span>PacketType packetType<span class=\"token punctuation\">,</span> <span class=\"token keyword\">bool</span> promiscuous<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> device <span class=\"token operator\">&lt;&lt;</span> packet <span class=\"token operator\">&lt;&lt;</span> protocol <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">&amp;</span>from <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">&amp;</span>to <span class=\"token operator\">&lt;&lt;</span> packetType <span class=\"token operator\">&lt;&lt;</span> promiscuous<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token function\">NS_ASSERT_MSG</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">GetContext</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token function\">GetId</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Received packet with erroneous context ; \"</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                 <span class=\"token string\">\"make sure the channels in use are correctly updating events context \"</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                 <span class=\"token string\">\"when transferring events from one node to another.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Node \"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token function\">GetId</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" ReceiveFromDevice:  dev \"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                        <span class=\"token operator\">&lt;&lt;</span> device<span class=\"token operator\">-></span><span class=\"token function\">GetIfIndex</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" (type=\"</span> <span class=\"token operator\">&lt;&lt;</span> device<span class=\"token operator\">-></span><span class=\"token function\">GetInstanceTypeId</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetName</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                        <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\") Packet UID \"</span> <span class=\"token operator\">&lt;&lt;</span> packet<span class=\"token operator\">-></span><span class=\"token function\">GetUid</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token keyword\">bool</span> found <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>ProtocolHandlerList<span class=\"token double-colon punctuation\">::</span>iterator i <span class=\"token operator\">=</span> m_handlers<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>       i <span class=\"token operator\">!=</span> m_handlers<span class=\"token punctuation\">.</span><span class=\"token function\">end</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>i<span class=\"token operator\">-></span>device <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          <span class=\"token punctuation\">(</span>i<span class=\"token operator\">-></span>device <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> i<span class=\"token operator\">-></span>device <span class=\"token operator\">==</span> device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>i<span class=\"token operator\">-></span>protocol <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>              i<span class=\"token operator\">-></span>protocol <span class=\"token operator\">==</span> protocol<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>promiscuous <span class=\"token operator\">==</span> i<span class=\"token operator\">-></span>promiscuous<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                  i<span class=\"token operator\">-></span><span class=\"token function\">handler</span> <span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">,</span> packet<span class=\"token punctuation\">,</span> protocol<span class=\"token punctuation\">,</span> from<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">,</span> packetType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                  found <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token keyword\">return</span> found<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>Node::NonPromiscReceiveFromDevice</code>  方法调用 <code>Node::ReceiveFromDevice</code>  方法，方法内部会循环判断是否是合适的处理 <code>packet</code>  的协议，如果有， <code>found</code>  为 <code>true</code> ，则就有由协议来处理 <code>packet</code> 。</p>\n<p><code>m_handlers</code>  的值是通过 <code>Node::RegisterProtocolHandler</code>  方法设置的。代码如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">Node</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">RegisterProtocolHandler</span> <span class=\"token punctuation\">(</span>ProtocolHandler handler<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                               <span class=\"token keyword\">uint16_t</span> protocolType<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                               Ptr<span class=\"token operator\">&lt;</span>NetDevice<span class=\"token operator\">></span> device<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                               <span class=\"token keyword\">bool</span> promiscuous<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">&amp;</span>handler <span class=\"token operator\">&lt;&lt;</span> protocolType <span class=\"token operator\">&lt;&lt;</span> device <span class=\"token operator\">&lt;&lt;</span> promiscuous<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">Node</span><span class=\"token operator\">:</span><span class=\"token base-clause\"><span class=\"token operator\">:</span><span class=\"token class-name\">ProtocolHandlerEntry</span> <span class=\"token class-name\">entry</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  entry<span class=\"token punctuation\">.</span>handler <span class=\"token operator\">=</span> handler<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  entry<span class=\"token punctuation\">.</span>protocol <span class=\"token operator\">=</span> protocolType<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  entry<span class=\"token punctuation\">.</span>device <span class=\"token operator\">=</span> device<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  entry<span class=\"token punctuation\">.</span>promiscuous <span class=\"token operator\">=</span> promiscuous<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">// On demand enable promiscuous mode in netdevices</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>promiscuous<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>device <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span>Ptr<span class=\"token operator\">&lt;</span>NetDevice<span class=\"token operator\">></span> <span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span>iterator i <span class=\"token operator\">=</span> m_devices<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>               i <span class=\"token operator\">!=</span> m_devices<span class=\"token punctuation\">.</span><span class=\"token function\">end</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>              Ptr<span class=\"token operator\">&lt;</span>NetDevice<span class=\"token operator\">></span> dev <span class=\"token operator\">=</span> <span class=\"token operator\">*</span>i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>              dev<span class=\"token operator\">-></span><span class=\"token function\">SetPromiscReceiveCallback</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Node<span class=\"token double-colon punctuation\">::</span>PromiscReceiveFromDevice<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          device<span class=\"token operator\">-></span><span class=\"token function\">SetPromiscReceiveCallback</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Node<span class=\"token double-colon punctuation\">::</span>PromiscReceiveFromDevice<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  m_handlers<span class=\"token punctuation\">.</span><span class=\"token function\">push_back</span> <span class=\"token punctuation\">(</span>entry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>通过全局搜索的话，调用 <code>Node::RegisterProtocolHandler</code>  方法的地方有很多，但总的来说都是根据配置的协议来选择的，这里我们以 <code>TrafficControlLayer::Receive</code>  为例。</p>\n<p><img data-src=\"https://yeyu-blog.oss-cn-beijing.aliyuncs.com/article_images/RegisterProtocolHandler%E8%B0%83%E7%94%A8.jpg\" alt=\"调用方式\" /></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">TrafficControlLayer</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Receive</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>NetDevice<span class=\"token operator\">></span> device<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> Packet<span class=\"token operator\">></span> p<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                              <span class=\"token keyword\">uint16_t</span> protocol<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> Address <span class=\"token operator\">&amp;</span>from<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> Address <span class=\"token operator\">&amp;</span>to<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                              NetDevice<span class=\"token double-colon punctuation\">::</span>PacketType packetType<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> device <span class=\"token operator\">&lt;&lt;</span> p <span class=\"token operator\">&lt;&lt;</span> protocol <span class=\"token operator\">&lt;&lt;</span> from <span class=\"token operator\">&lt;&lt;</span> to <span class=\"token operator\">&lt;&lt;</span> packetType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">bool</span> found <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>ProtocolHandlerList<span class=\"token double-colon punctuation\">::</span>iterator i <span class=\"token operator\">=</span> m_handlers<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>       i <span class=\"token operator\">!=</span> m_handlers<span class=\"token punctuation\">.</span><span class=\"token function\">end</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>i<span class=\"token operator\">-></span>device <span class=\"token operator\">==</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>          <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>i<span class=\"token operator\">-></span>device <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> i<span class=\"token operator\">-></span>device <span class=\"token operator\">==</span> device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>i<span class=\"token operator\">-></span>protocol <span class=\"token operator\">==</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>              <span class=\"token operator\">||</span> i<span class=\"token operator\">-></span>protocol <span class=\"token operator\">==</span> protocol<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>              <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Found handler for packet \"</span> <span class=\"token operator\">&lt;&lt;</span> p <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\", protocol \"</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                            protocol <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" and NetDevice \"</span> <span class=\"token operator\">&lt;&lt;</span> device <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                            <span class=\"token string\">\". Send packet up\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>              i<span class=\"token operator\">-></span><span class=\"token function\">handler</span> <span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">,</span> protocol<span class=\"token punctuation\">,</span> from<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">,</span> packetType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>              found <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token function\">NS_ABORT_MSG_IF</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>found<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Handler for protocol \"</span> <span class=\"token operator\">&lt;&lt;</span> p <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" and device \"</span> <span class=\"token operator\">&lt;&lt;</span> device <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                           <span class=\"token string\">\" not found. It isn't forwarded up; it dies here.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>在这里也涉及到一个 <code>m_handlers</code></p>\n<p>其设置方式为 <code>TrafficControlLayer::RegisterProtocolHandler</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">TrafficControlLayer</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">RegisterProtocolHandler</span> <span class=\"token punctuation\">(</span>Node<span class=\"token double-colon punctuation\">::</span>ProtocolHandler handler<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                                              <span class=\"token keyword\">uint16_t</span> protocolType<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span>NetDevice<span class=\"token operator\">></span> device<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> protocolType <span class=\"token operator\">&lt;&lt;</span> device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">ProtocolHandlerEntry</span> entry<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  entry<span class=\"token punctuation\">.</span>handler <span class=\"token operator\">=</span> handler<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  entry<span class=\"token punctuation\">.</span>protocol <span class=\"token operator\">=</span> protocolType<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  entry<span class=\"token punctuation\">.</span>device <span class=\"token operator\">=</span> device<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  entry<span class=\"token punctuation\">.</span>promiscuous <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  m_handlers<span class=\"token punctuation\">.</span><span class=\"token function\">push_back</span> <span class=\"token punctuation\">(</span>entry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Handler for NetDevice: \"</span> <span class=\"token operator\">&lt;&lt;</span> device <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" registered for protocol \"</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                protocolType <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\".\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>同样的，我们全局搜索该调用方式</p>\n<p>可以看出主要是这两种调用方式</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>tc<span class=\"token operator\">-></span><span class=\"token function\">RegisterProtocolHandler</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Ipv4L3Protocol<span class=\"token double-colon punctuation\">::</span>Receive<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                               Ipv4L3Protocol<span class=\"token double-colon punctuation\">::</span>PROT_NUMBER<span class=\"token punctuation\">,</span> device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  tc<span class=\"token operator\">-></span><span class=\"token function\">RegisterProtocolHandler</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>ArpL3Protocol<span class=\"token double-colon punctuation\">::</span>Receive<span class=\"token punctuation\">,</span> <span class=\"token function\">PeekPointer</span> <span class=\"token punctuation\">(</span><span class=\"token generic-function\"><span class=\"token function\">GetObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>ArpL3Protocol<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                               ArpL3Protocol<span class=\"token double-colon punctuation\">::</span>PROT_NUMBER<span class=\"token punctuation\">,</span> device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>具体执行哪里，要看使用的协议。对于 <code>packet</code>  数据包来说，处理起来就是 <code>Ipv4L3Protocol::Receive</code> ，如果使用到了 <code>ARP</code>  协议，处理起来就是 <code>ArpL3Protocol::Receive</code> 。</p>\n<p>这里以 <code>Ipv4L3Protocol::Receive</code>  为例说明。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">Ipv4L3Protocol</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Receive</span> <span class=\"token punctuation\">(</span> Ptr<span class=\"token operator\">&lt;</span>NetDevice<span class=\"token operator\">></span> device<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> Packet<span class=\"token operator\">></span> p<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint16_t</span> protocol<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> Address <span class=\"token operator\">&amp;</span>from<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                          <span class=\"token keyword\">const</span> Address <span class=\"token operator\">&amp;</span>to<span class=\"token punctuation\">,</span> NetDevice<span class=\"token double-colon punctuation\">::</span>PacketType packetType<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> device <span class=\"token operator\">&lt;&lt;</span> p <span class=\"token operator\">&lt;&lt;</span> protocol <span class=\"token operator\">&lt;&lt;</span> from <span class=\"token operator\">&lt;&lt;</span> to <span class=\"token operator\">&lt;&lt;</span> packetType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Packet from \"</span> <span class=\"token operator\">&lt;&lt;</span> from <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" received on node \"</span> <span class=\"token operator\">&lt;&lt;</span> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                m_node<span class=\"token operator\">-></span><span class=\"token function\">GetId</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">int32_t</span> interface <span class=\"token operator\">=</span> <span class=\"token function\">GetInterfaceForDevice</span><span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token function\">NS_ASSERT_MSG</span> <span class=\"token punctuation\">(</span>interface <span class=\"token operator\">!=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Received a packet from an interface that is not known to IPv4\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> packet <span class=\"token operator\">=</span> p<span class=\"token operator\">-></span><span class=\"token function\">Copy</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>Ipv4Interface<span class=\"token operator\">></span> ipv4Interface <span class=\"token operator\">=</span> m_interfaces<span class=\"token punctuation\">[</span>interface<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ipv4Interface<span class=\"token operator\">-></span><span class=\"token function\">IsUp</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token function\">m_rxTrace</span> <span class=\"token punctuation\">(</span>packet<span class=\"token punctuation\">,</span> m_node<span class=\"token operator\">-></span><span class=\"token generic-function\"><span class=\"token function\">GetObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Ipv4<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> interface<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Dropping received packet -- interface is down\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      Ipv4Header ipHeader<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      packet<span class=\"token operator\">-></span><span class=\"token function\">RemoveHeader</span> <span class=\"token punctuation\">(</span>ipHeader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token function\">m_dropTrace</span> <span class=\"token punctuation\">(</span>ipHeader<span class=\"token punctuation\">,</span> packet<span class=\"token punctuation\">,</span> DROP_INTERFACE_DOWN<span class=\"token punctuation\">,</span> m_node<span class=\"token operator\">-></span><span class=\"token generic-function\"><span class=\"token function\">GetObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Ipv4<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> interface<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  Ipv4Header ipHeader<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Node</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ChecksumEnabled</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      ipHeader<span class=\"token punctuation\">.</span><span class=\"token function\">EnableChecksum</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  packet<span class=\"token operator\">-></span><span class=\"token function\">RemoveHeader</span> <span class=\"token punctuation\">(</span>ipHeader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token comment\">// Trim any residual frame padding from underlying devices</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ipHeader<span class=\"token punctuation\">.</span><span class=\"token function\">GetPayloadSize</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> packet<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      packet<span class=\"token operator\">-></span><span class=\"token function\">RemoveAtEnd</span> <span class=\"token punctuation\">(</span>packet<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> ipHeader<span class=\"token punctuation\">.</span><span class=\"token function\">GetPayloadSize</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>ipHeader<span class=\"token punctuation\">.</span><span class=\"token function\">IsChecksumOk</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Dropping received packet -- checksum not ok\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      <span class=\"token function\">m_dropTrace</span> <span class=\"token punctuation\">(</span>ipHeader<span class=\"token punctuation\">,</span> packet<span class=\"token punctuation\">,</span> DROP_BAD_CHECKSUM<span class=\"token punctuation\">,</span> m_node<span class=\"token operator\">-></span><span class=\"token generic-function\"><span class=\"token function\">GetObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Ipv4<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> interface<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  <span class=\"token comment\">// the packet is valid, we update the ARP cache entry (if present)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>ArpCache<span class=\"token operator\">></span> arpCache <span class=\"token operator\">=</span> ipv4Interface<span class=\"token operator\">-></span><span class=\"token function\">GetArpCache</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>arpCache<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>      <span class=\"token comment\">// case one, it's a a direct routing.</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      ArpCache<span class=\"token double-colon punctuation\">::</span>Entry <span class=\"token operator\">*</span>entry <span class=\"token operator\">=</span> arpCache<span class=\"token operator\">-></span><span class=\"token function\">Lookup</span> <span class=\"token punctuation\">(</span>ipHeader<span class=\"token punctuation\">.</span><span class=\"token function\">GetSource</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>entry<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>entry<span class=\"token operator\">-></span><span class=\"token function\">IsAlive</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>              entry<span class=\"token operator\">-></span><span class=\"token function\">UpdateSeen</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>      <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>          <span class=\"token comment\">// It's not in the direct routing, so it's the router, and it could have multiple IP addresses.</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>          <span class=\"token comment\">// In doubt, update all of them.</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>          <span class=\"token comment\">// Note: it's a confirmed behavior for Linux routers.</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>          std<span class=\"token double-colon punctuation\">::</span>list<span class=\"token operator\">&lt;</span>ArpCache<span class=\"token double-colon punctuation\">::</span>Entry <span class=\"token operator\">*</span><span class=\"token operator\">></span> entryList <span class=\"token operator\">=</span> arpCache<span class=\"token operator\">-></span><span class=\"token function\">LookupInverse</span> <span class=\"token punctuation\">(</span>from<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>          std<span class=\"token double-colon punctuation\">::</span>list<span class=\"token operator\">&lt;</span>ArpCache<span class=\"token double-colon punctuation\">::</span>Entry <span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span>iterator iter<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>          <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>iter <span class=\"token operator\">=</span> entryList<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> iter <span class=\"token operator\">!=</span> entryList<span class=\"token punctuation\">.</span><span class=\"token function\">end</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> iter <span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>iter<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">IsAlive</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>                <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>                  <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>iter<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">UpdateSeen</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>SocketList<span class=\"token double-colon punctuation\">::</span>iterator i <span class=\"token operator\">=</span> m_sockets<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">!=</span> m_sockets<span class=\"token punctuation\">.</span><span class=\"token function\">end</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>      <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Forwarding to raw socket\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"84\"></td><td><pre>      Ptr<span class=\"token operator\">&lt;</span>Ipv4RawSocketImpl<span class=\"token operator\">></span> socket <span class=\"token operator\">=</span> <span class=\"token operator\">*</span>i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>      socket<span class=\"token operator\">-></span><span class=\"token function\">ForwardUp</span> <span class=\"token punctuation\">(</span>packet<span class=\"token punctuation\">,</span> ipHeader<span class=\"token punctuation\">,</span> ipv4Interface<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_enableDpd <span class=\"token operator\">&amp;&amp;</span> ipHeader<span class=\"token punctuation\">.</span><span class=\"token function\">GetDestination</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">IsMulticast</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">UpdateDuplicate</span> <span class=\"token punctuation\">(</span>packet<span class=\"token punctuation\">,</span> ipHeader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>      <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Dropping received packet -- duplicate.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>      <span class=\"token function\">m_dropTrace</span> <span class=\"token punctuation\">(</span>ipHeader<span class=\"token punctuation\">,</span> packet<span class=\"token punctuation\">,</span> DROP_DUPLICATE<span class=\"token punctuation\">,</span> m_node<span class=\"token operator\">-></span><span class=\"token generic-function\"><span class=\"token function\">GetObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Ipv4<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> interface<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>  <span class=\"token function\">NS_ASSERT_MSG</span> <span class=\"token punctuation\">(</span>m_routingProtocol <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Need a routing protocol object to process packets\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>m_routingProtocol<span class=\"token operator\">-></span><span class=\"token function\">RouteInput</span> <span class=\"token punctuation\">(</span>packet<span class=\"token punctuation\">,</span> ipHeader<span class=\"token punctuation\">,</span> device<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>                                      <span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Ipv4L3Protocol<span class=\"token double-colon punctuation\">::</span>IpForward<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>                                      <span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Ipv4L3Protocol<span class=\"token double-colon punctuation\">::</span>IpMulticastForward<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>                                      <span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Ipv4L3Protocol<span class=\"token double-colon punctuation\">::</span>LocalDeliver<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>                                      <span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Ipv4L3Protocol<span class=\"token double-colon punctuation\">::</span>RouteInputError<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>                                      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>      <span class=\"token function\">NS_LOG_WARN</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"No route found for forwarding packet.  Drop.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>      <span class=\"token function\">m_dropTrace</span> <span class=\"token punctuation\">(</span>ipHeader<span class=\"token punctuation\">,</span> packet<span class=\"token punctuation\">,</span> DROP_NO_ROUTE<span class=\"token punctuation\">,</span> m_node<span class=\"token operator\">-></span><span class=\"token generic-function\"><span class=\"token function\">GetObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Ipv4<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> interface<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>在该函数中主要分两部分，如果 <code>m_sockets</code>  不为空的话，直接 <code>socket::ForwardUp</code> ，否则通过 <code>m_routingProtocol-&gt;RouteInput</code>  交付。 <code>m_routingProtocol</code>  类型是 <code>Ipv4RoutingProtocol</code> ，我们按照 <code>Ipv4RoutingProtocol::RouteInput</code>  进行探索。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">virtual</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">RouteInput</span>  <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> Packet<span class=\"token operator\">></span> p<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> Ipv4Header <span class=\"token operator\">&amp;</span>header<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> NetDevice<span class=\"token operator\">></span> idev<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                            UnicastForwardCallback ucb<span class=\"token punctuation\">,</span> MulticastForwardCallback mcb<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                            LocalDeliverCallback lcb<span class=\"token punctuation\">,</span> ErrorCallback ecb<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>其实现方式是由子类来决定。这涉及到路由协议的部分，会在今后的章节进行介绍。</p>\n<p>但都会调用 <code>LocalDeliverCallback lcb</code> ，即 <code>LocalDeliver</code>  方法</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">Ipv4L3Protocol</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">LocalDeliver</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span> Ipv4Header <span class=\"token keyword\">const</span><span class=\"token operator\">&amp;</span>ip<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint32_t</span> iif<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> packet <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">&amp;</span>ip <span class=\"token operator\">&lt;&lt;</span> iif<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> p <span class=\"token operator\">=</span> packet<span class=\"token operator\">-></span><span class=\"token function\">Copy</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// need to pass a non-const packet up</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  Ipv4Header ipHeader <span class=\"token operator\">=</span> ip<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token operator\">!</span>ipHeader<span class=\"token punctuation\">.</span><span class=\"token function\">IsLastFragment</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> ipHeader<span class=\"token punctuation\">.</span><span class=\"token function\">GetFragmentOffset</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Received a fragment, processing \"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">*</span>p <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token keyword\">bool</span> isPacketComplete<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      isPacketComplete <span class=\"token operator\">=</span> <span class=\"token function\">ProcessFragment</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> ipHeader<span class=\"token punctuation\">,</span> iif<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> isPacketComplete <span class=\"token operator\">==</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Got last fragment, Packet is complete \"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">*</span>p <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      ipHeader<span class=\"token punctuation\">.</span><span class=\"token function\">SetFragmentOffset</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      ipHeader<span class=\"token punctuation\">.</span><span class=\"token function\">SetPayloadSize</span> <span class=\"token punctuation\">(</span>p<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token function\">m_localDeliverTrace</span> <span class=\"token punctuation\">(</span>ipHeader<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">,</span> iif<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>IpL4Protocol<span class=\"token operator\">></span> protocol <span class=\"token operator\">=</span> <span class=\"token function\">GetProtocol</span> <span class=\"token punctuation\">(</span>ipHeader<span class=\"token punctuation\">.</span><span class=\"token function\">GetProtocol</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> iif<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>protocol <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token comment\">// we need to make a copy in the unlikely event we hit the</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token comment\">// RX_ENDPOINT_UNREACH codepath</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> copy <span class=\"token operator\">=</span> p<span class=\"token operator\">-></span><span class=\"token function\">Copy</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token keyword\">enum</span> <span class=\"token class-name\">IpL4Protocol</span><span class=\"token double-colon punctuation\">::</span>RxStatus status <span class=\"token operator\">=</span> </pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        protocol<span class=\"token operator\">-></span><span class=\"token function\">Receive</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> ipHeader<span class=\"token punctuation\">,</span> <span class=\"token function\">GetInterface</span> <span class=\"token punctuation\">(</span>iif<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token keyword\">case</span> IpL4Protocol<span class=\"token double-colon punctuation\">::</span>RX_OK<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token comment\">// fall through</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token keyword\">case</span> IpL4Protocol<span class=\"token double-colon punctuation\">::</span>RX_ENDPOINT_CLOSED<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token comment\">// fall through</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token keyword\">case</span> IpL4Protocol<span class=\"token double-colon punctuation\">::</span>RX_CSUM_FAILED<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token keyword\">case</span> IpL4Protocol<span class=\"token double-colon punctuation\">::</span>RX_ENDPOINT_UNREACH<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ipHeader<span class=\"token punctuation\">.</span><span class=\"token function\">GetDestination</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">IsBroadcast</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token boolean\">true</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>              ipHeader<span class=\"token punctuation\">.</span><span class=\"token function\">GetDestination</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">IsMulticast</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>              <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Do not reply to broadcast or multicast</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          <span class=\"token comment\">// Another case to suppress ICMP is a subnet-directed broadcast</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          <span class=\"token keyword\">bool</span> subnetDirected <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">uint32_t</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token function\">GetNAddresses</span> <span class=\"token punctuation\">(</span>iif<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>              Ipv4InterfaceAddress addr <span class=\"token operator\">=</span> <span class=\"token function\">GetAddress</span> <span class=\"token punctuation\">(</span>iif<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>addr<span class=\"token punctuation\">.</span><span class=\"token function\">GetLocal</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">CombineMask</span> <span class=\"token punctuation\">(</span>addr<span class=\"token punctuation\">.</span><span class=\"token function\">GetMask</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> ipHeader<span class=\"token punctuation\">.</span><span class=\"token function\">GetDestination</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">CombineMask</span> <span class=\"token punctuation\">(</span>addr<span class=\"token punctuation\">.</span><span class=\"token function\">GetMask</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                  ipHeader<span class=\"token punctuation\">.</span><span class=\"token function\">GetDestination</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">IsSubnetDirectedBroadcast</span> <span class=\"token punctuation\">(</span>addr<span class=\"token punctuation\">.</span><span class=\"token function\">GetMask</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                  subnetDirected <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>subnetDirected <span class=\"token operator\">==</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>              <span class=\"token function\">GetIcmp</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">SendDestUnreachPort</span> <span class=\"token punctuation\">(</span>ipHeader<span class=\"token punctuation\">,</span> copy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>其中关键的代码如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Ptr<span class=\"token operator\">&lt;</span>IpL4Protocol<span class=\"token operator\">></span> protocol <span class=\"token operator\">=</span> <span class=\"token function\">GetProtocol</span> <span class=\"token punctuation\">(</span>ipHeader<span class=\"token punctuation\">.</span><span class=\"token function\">GetProtocol</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> iif<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> copy <span class=\"token operator\">=</span> p<span class=\"token operator\">-></span><span class=\"token function\">Copy</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">enum</span> <span class=\"token class-name\">IpL4Protocol</span><span class=\"token double-colon punctuation\">::</span>RxStatus status <span class=\"token operator\">=</span> protocol<span class=\"token operator\">-></span><span class=\"token function\">Receive</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> ipHeader<span class=\"token punctuation\">,</span> <span class=\"token function\">GetInterface</span> <span class=\"token punctuation\">(</span>iif<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>其中的 <code>protocol</code>  就是根据头部协议号决定，这里我们考虑 <code>UDP</code>  协议，那么会执行 <code>UdpL4Protocol</code> 。会执行它的 <code>Receive</code>  方法。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">enum</span> <span class=\"token class-name\">IpL4Protocol</span><span class=\"token double-colon punctuation\">::</span>RxStatus</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">UdpL4Protocol</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Receive</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                        Ipv4Header <span class=\"token keyword\">const</span> <span class=\"token operator\">&amp;</span>header<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                        Ptr<span class=\"token operator\">&lt;</span>Ipv4Interface<span class=\"token operator\">></span> interface<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> packet <span class=\"token operator\">&lt;&lt;</span> header<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  UdpHeader udpHeader<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Node</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ChecksumEnabled</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      udpHeader<span class=\"token punctuation\">.</span><span class=\"token function\">EnableChecksums</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  udpHeader<span class=\"token punctuation\">.</span><span class=\"token function\">InitializeChecksum</span> <span class=\"token punctuation\">(</span>header<span class=\"token punctuation\">.</span><span class=\"token function\">GetSource</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> header<span class=\"token punctuation\">.</span><span class=\"token function\">GetDestination</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> PROT_NUMBER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token comment\">// We only peek at the header for now (instead of removing it) so that it will be intact</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token comment\">// if we have to pass it to a IPv6 endpoint via:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">// </span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token comment\">//   UdpL4Protocol::Receive (Ptr&lt;Packet> packet, Ipv6Address &amp;src, Ipv6Address &amp;dst, ...)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  packet<span class=\"token operator\">-></span><span class=\"token function\">PeekHeader</span> <span class=\"token punctuation\">(</span>udpHeader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>udpHeader<span class=\"token punctuation\">.</span><span class=\"token function\">IsChecksumOk</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token function\">NS_LOG_INFO</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Bad checksum : dropping packet!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token keyword\">return</span> IpL4Protocol<span class=\"token double-colon punctuation\">::</span>RX_CSUM_FAILED<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Looking up dst \"</span> <span class=\"token operator\">&lt;&lt;</span> header<span class=\"token punctuation\">.</span><span class=\"token function\">GetDestination</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" port \"</span> <span class=\"token operator\">&lt;&lt;</span> udpHeader<span class=\"token punctuation\">.</span><span class=\"token function\">GetDestinationPort</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  Ipv4EndPointDemux<span class=\"token double-colon punctuation\">::</span>EndPoints endPoints <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    m_endPoints<span class=\"token operator\">-></span><span class=\"token function\">Lookup</span> <span class=\"token punctuation\">(</span>header<span class=\"token punctuation\">.</span><span class=\"token function\">GetDestination</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> udpHeader<span class=\"token punctuation\">.</span><span class=\"token function\">GetDestinationPort</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                         header<span class=\"token punctuation\">.</span><span class=\"token function\">GetSource</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> udpHeader<span class=\"token punctuation\">.</span><span class=\"token function\">GetSourcePort</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> interface<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>endPoints<span class=\"token punctuation\">.</span><span class=\"token function\">empty</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token operator\">-></span><span class=\"token generic-function\"><span class=\"token function\">GetObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Ipv6L3Protocol<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"  No Ipv4 endpoints matched on UdpL4Protocol, trying Ipv6 \"</span><span class=\"token operator\">&lt;&lt;</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          Ptr<span class=\"token operator\">&lt;</span>Ipv6Interface<span class=\"token operator\">></span> fakeInterface<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          Ipv6Header ipv6Header<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          Ipv6Address src <span class=\"token operator\">=</span> <span class=\"token class-name\">Ipv6Address</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">MakeIpv4MappedAddress</span> <span class=\"token punctuation\">(</span>header<span class=\"token punctuation\">.</span><span class=\"token function\">GetSource</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          Ipv6Address dst <span class=\"token operator\">=</span> <span class=\"token class-name\">Ipv6Address</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">MakeIpv4MappedAddress</span> <span class=\"token punctuation\">(</span>header<span class=\"token punctuation\">.</span><span class=\"token function\">GetDestination</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          ipv6Header<span class=\"token punctuation\">.</span><span class=\"token function\">SetSourceAddress</span> <span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          ipv6Header<span class=\"token punctuation\">.</span><span class=\"token function\">SetDestinationAddress</span> <span class=\"token punctuation\">(</span>dst<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token operator\">-></span><span class=\"token function\">Receive</span> <span class=\"token punctuation\">(</span>packet<span class=\"token punctuation\">,</span> ipv6Header<span class=\"token punctuation\">,</span> fakeInterface<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      <span class=\"token function\">NS_LOG_LOGIC</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"RX_ENDPOINT_UNREACH\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      <span class=\"token keyword\">return</span> IpL4Protocol<span class=\"token double-colon punctuation\">::</span>RX_ENDPOINT_UNREACH<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  packet<span class=\"token operator\">-></span><span class=\"token function\">RemoveHeader</span><span class=\"token punctuation\">(</span>udpHeader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>Ipv4EndPointDemux<span class=\"token double-colon punctuation\">::</span>EndPointsI endPoint <span class=\"token operator\">=</span> endPoints<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>       endPoint <span class=\"token operator\">!=</span> endPoints<span class=\"token punctuation\">.</span><span class=\"token function\">end</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> endPoint<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>endPoint<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">ForwardUp</span> <span class=\"token punctuation\">(</span>packet<span class=\"token operator\">-></span><span class=\"token function\">Copy</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> header<span class=\"token punctuation\">,</span> udpHeader<span class=\"token punctuation\">.</span><span class=\"token function\">GetSourcePort</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                              interface<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  <span class=\"token keyword\">return</span> IpL4Protocol<span class=\"token double-colon punctuation\">::</span>RX_OK<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>其中就会执行  <code>(*endPoint)-&gt;ForwardUp</code> 。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">Ipv4EndPoint</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ForwardUp</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> p<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> Ipv4Header<span class=\"token operator\">&amp;</span> header<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint16_t</span> sport<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                         Ptr<span class=\"token operator\">&lt;</span>Ipv4Interface<span class=\"token operator\">></span> incomingInterface<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> p <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">&amp;</span>header <span class=\"token operator\">&lt;&lt;</span> sport <span class=\"token operator\">&lt;&lt;</span> incomingInterface<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>m_rxCallback<span class=\"token punctuation\">.</span><span class=\"token function\">IsNull</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token function\">m_rxCallback</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> header<span class=\"token punctuation\">,</span> sport<span class=\"token punctuation\">,</span> incomingInterface<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这里又是一个回调，其定义如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">UdpSocketImpl</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">FinishBind</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">bool</span> done <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_endPoint <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      m_endPoint<span class=\"token operator\">-></span><span class=\"token function\">SetRxCallback</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>UdpSocketImpl<span class=\"token double-colon punctuation\">::</span>ForwardUp<span class=\"token punctuation\">,</span> <span class=\"token generic-function\"><span class=\"token function\">Ptr</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>UdpSocketImpl<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      m_endPoint<span class=\"token operator\">-></span><span class=\"token function\">SetIcmpCallback</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>UdpSocketImpl<span class=\"token double-colon punctuation\">::</span>ForwardIcmp<span class=\"token punctuation\">,</span> <span class=\"token generic-function\"><span class=\"token function\">Ptr</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>UdpSocketImpl<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      m_endPoint<span class=\"token operator\">-></span><span class=\"token function\">SetDestroyCallback</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>UdpSocketImpl<span class=\"token double-colon punctuation\">::</span>Destroy<span class=\"token punctuation\">,</span> <span class=\"token generic-function\"><span class=\"token function\">Ptr</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>UdpSocketImpl<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      done <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_endPoint6 <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      m_endPoint6<span class=\"token operator\">-></span><span class=\"token function\">SetRxCallback</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>UdpSocketImpl<span class=\"token double-colon punctuation\">::</span>ForwardUp6<span class=\"token punctuation\">,</span> <span class=\"token generic-function\"><span class=\"token function\">Ptr</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>UdpSocketImpl<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      m_endPoint6<span class=\"token operator\">-></span><span class=\"token function\">SetIcmpCallback</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>UdpSocketImpl<span class=\"token double-colon punctuation\">::</span>ForwardIcmp6<span class=\"token punctuation\">,</span> <span class=\"token generic-function\"><span class=\"token function\">Ptr</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>UdpSocketImpl<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      m_endPoint6<span class=\"token operator\">-></span><span class=\"token function\">SetDestroyCallback</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>UdpSocketImpl<span class=\"token double-colon punctuation\">::</span>Destroy6<span class=\"token punctuation\">,</span> <span class=\"token generic-function\"><span class=\"token function\">Ptr</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>UdpSocketImpl<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      done <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>done<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>m_rxCallback</code>  也就是调用 <code>UdpSocketImpl::ForwardUp</code> ：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">UdpSocketImpl</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ForwardUp</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span> Ipv4Header header<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint16_t</span> port<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                          Ptr<span class=\"token operator\">&lt;</span>Ipv4Interface<span class=\"token operator\">></span> incomingInterface<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> packet <span class=\"token operator\">&lt;&lt;</span> header <span class=\"token operator\">&lt;&lt;</span> port<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_shutdownRecv<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token comment\">// Should check via getsockopt ()..</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">IsRecvPktInfo</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      Ipv4PacketInfoTag tag<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      packet<span class=\"token operator\">-></span><span class=\"token function\">RemovePacketTag</span> <span class=\"token punctuation\">(</span>tag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      tag<span class=\"token punctuation\">.</span><span class=\"token function\">SetRecvIf</span> <span class=\"token punctuation\">(</span>incomingInterface<span class=\"token operator\">-></span><span class=\"token function\">GetDevice</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetIfIndex</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      packet<span class=\"token operator\">-></span><span class=\"token function\">AddPacketTag</span> <span class=\"token punctuation\">(</span>tag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token comment\">//Check only version 4 options</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">IsIpRecvTos</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      SocketIpTosTag ipTosTag<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      ipTosTag<span class=\"token punctuation\">.</span><span class=\"token function\">SetTos</span> <span class=\"token punctuation\">(</span>header<span class=\"token punctuation\">.</span><span class=\"token function\">GetTos</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      packet<span class=\"token operator\">-></span><span class=\"token function\">AddPacketTag</span> <span class=\"token punctuation\">(</span>ipTosTag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">IsIpRecvTtl</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      SocketIpTtlTag ipTtlTag<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      ipTtlTag<span class=\"token punctuation\">.</span><span class=\"token function\">SetTtl</span> <span class=\"token punctuation\">(</span>header<span class=\"token punctuation\">.</span><span class=\"token function\">GetTtl</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      packet<span class=\"token operator\">-></span><span class=\"token function\">AddPacketTag</span> <span class=\"token punctuation\">(</span>ipTtlTag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token comment\">// in case the packet still has a priority tag attached, remove it</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  SocketPriorityTag priorityTag<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  packet<span class=\"token operator\">-></span><span class=\"token function\">RemovePacketTag</span> <span class=\"token punctuation\">(</span>priorityTag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>m_rxAvailable <span class=\"token operator\">+</span> packet<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> m_rcvBufSize<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      Address address <span class=\"token operator\">=</span> <span class=\"token function\">InetSocketAddress</span> <span class=\"token punctuation\">(</span>header<span class=\"token punctuation\">.</span><span class=\"token function\">GetSource</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> port<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      m_deliveryQueue<span class=\"token punctuation\">.</span><span class=\"token function\">push</span> <span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">make_pair</span> <span class=\"token punctuation\">(</span>packet<span class=\"token punctuation\">,</span> address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      m_rxAvailable <span class=\"token operator\">+=</span> packet<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      <span class=\"token function\">NotifyDataRecv</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>      <span class=\"token comment\">// In general, this case should not occur unless the</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      <span class=\"token comment\">// receiving application reads data from this socket slowly</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token comment\">// in comparison to the arrival rate</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>      <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>      <span class=\"token comment\">// drop and trace packet</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      <span class=\"token function\">NS_LOG_WARN</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"No receive buffer space available.  Drop.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>      <span class=\"token function\">m_dropTrace</span> <span class=\"token punctuation\">(</span>packet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>然后调用 <code>NotifyDataRecv</code>  来实现到上层的数据传递</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">Socket</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">NotifyDataRecv</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>m_receivedData<span class=\"token punctuation\">.</span><span class=\"token function\">IsNull</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token function\">m_receivedData</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"完整流程图示意\"><a class=\"anchor\" href=\"#完整流程图示意\">#</a> 完整流程图示意</h3>\n<p><img data-src=\"https://yeyu-blog.oss-cn-beijing.aliyuncs.com/article_images/ns3.32%20wifi%E6%A8%A1%E5%9D%97%E6%B5%81%E7%A8%8B%E5%9B%BEsocket%E5%AE%8C%E6%95%B4%E7%89%88.jpg\" alt=\"完整流程图\" /></p>\n",
            "tags": [
                "ns3",
                "ns3"
            ]
        },
        {
            "id": "http://jluyeyu.com/ns3/11.ns3%20wifi%E6%A8%A1%E5%9D%97%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/",
            "url": "http://jluyeyu.com/ns3/11.ns3%20wifi%E6%A8%A1%E5%9D%97%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/",
            "title": "11.ns3 wifi模块流程源码解析",
            "date_published": "2022-11-08T06:00:00.000Z",
            "content_html": "<h2 id=\"11ns3-wifi模块流程源码解析\"><a class=\"anchor\" href=\"#11ns3-wifi模块流程源码解析\">#</a> 11.ns3 wifi 模块流程源码解析</h2>\n<p>在本节中，将从源码的角度解析 <code>ns3</code>  的 <code>wifi</code>  模块，包括一个 <code>packet</code>  是如何从一台主机的 <code>WifiNetDevice</code>  到另一台主机的 <code>WifiNetDevice</code> 。</p>\n<p>PS:</p>\n<ol>\n<li>\n<p>本节很长，而且很枯燥，但是对扩展 <code>ns3</code>  功能，了解 <code>ns3</code>  流程非常有帮助，请耐心观看。</p>\n</li>\n<li>\n<p>本节的源码来自于 <code>ns3.32</code> , 不同版本之间有一些差异，但大致流程差不多，可以互相参考。</p>\n</li>\n</ol>\n<h3 id=\"发送过程源码分析\"><a class=\"anchor\" href=\"#发送过程源码分析\">#</a> 发送过程源码分析</h3>\n<p>首先从发送 <code>packet</code>  开始</p>\n<p><code>src/wifi/model/wifi-net-device.cc</code> ,</p>\n<p><code>WifiNetDevice::send</code>  函数</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">bool</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">WifiNetDevice</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> Address<span class=\"token operator\">&amp;</span> dest<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint16_t</span> protocolNumber<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> packet <span class=\"token operator\">&lt;&lt;</span> dest <span class=\"token operator\">&lt;&lt;</span> protocolNumber<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Mac48Address</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">IsMatchingType</span> <span class=\"token punctuation\">(</span>dest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  Mac48Address realTo <span class=\"token operator\">=</span> <span class=\"token class-name\">Mac48Address</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ConvertFrom</span> <span class=\"token punctuation\">(</span>dest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  LlcSnapHeader llc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  llc<span class=\"token punctuation\">.</span><span class=\"token function\">SetType</span> <span class=\"token punctuation\">(</span>protocolNumber<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  packet<span class=\"token operator\">-></span><span class=\"token function\">AddHeader</span> <span class=\"token punctuation\">(</span>llc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  m_mac<span class=\"token operator\">-></span><span class=\"token function\">NotifyTx</span> <span class=\"token punctuation\">(</span>packet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  m_mac<span class=\"token operator\">-></span><span class=\"token function\">Enqueue</span> <span class=\"token punctuation\">(</span>packet<span class=\"token punctuation\">,</span> realTo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>m_mac</code>  参数的类型是 <code>Ptr&lt;WifiMac&gt;</code> ， <code>NotifyTx</code>  方法是 <code>Trace</code>  追踪发送的数据包， <code>Enqueue</code>  方法将 <code>packet</code>  加入队列。</p>\n<p>接下来就是 <code>WifiMac::Enqueue</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">virtual</span> <span class=\"token keyword\">void</span> <span class=\"token function\">Enqueue</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span> Mac48Address to<span class=\"token punctuation\">,</span> Mac48Address from<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>这是 <code>WiFiMac::Enqueue</code>  方法的声明，是一个纯虚函数，子类必须实现这个方法。</p>\n<p><code>WiFiMac</code>  的子类有：</p>\n<p><img data-src=\"https://yeyu-blog.oss-cn-beijing.aliyuncs.com/article_images/wifiMac%E7%9A%84%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB.jpg\" alt=\"WifiMac继承关系\" /></p>\n<p>接下来我们分别看一下这些子类的 <code>Enqueue</code>  分别都做了什么。</p>\n<p><code>RegularWifiMac::Enqueue</code>  期望子类重写该方法，无实质的内容。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">RegularWifiMac</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Enqueue</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                         Mac48Address to<span class=\"token punctuation\">,</span> Mac48Address from<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">//We expect RegularWifiMac subclasses which do support forwarding (e.g.,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token comment\">//AP) to override this method. Therefore, we throw a fatal error if</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token comment\">//someone tries to invoke this method on a class which has not done</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">//this.</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token function\">NS_FATAL_ERROR</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"This MAC entity (\"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\", \"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token function\">GetAddress</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                                      <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\") does not support Enqueue() with from address\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>AdhocWifiMac::Enqueue</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">AdhocWifiMac</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Enqueue</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span> Mac48Address to<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">GetQosSupported</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token comment\">//Sanity check that the TID is valid</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>tid <span class=\"token operator\">&lt;</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      m_edca<span class=\"token punctuation\">[</span><span class=\"token function\">QosUtilsMapTidToAc</span> <span class=\"token punctuation\">(</span>tid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token operator\">-></span><span class=\"token function\">Queue</span> <span class=\"token punctuation\">(</span>packet<span class=\"token punctuation\">,</span> hdr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      m_txop<span class=\"token operator\">-></span><span class=\"token function\">Queue</span> <span class=\"token punctuation\">(</span>packet<span class=\"token punctuation\">,</span> hdr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>本段最核心的代码已经摘出</p>\n<p>如果网络支持 <code>Qos</code> ，就会进入类 <code>QosTxop</code>  的 <code>Queue</code>  函数；<br />\n如果不支持 <code>Qos</code> ，就会进入 <code>Txop</code>  类的 <code>Queue</code>  函数。</p>\n<p>而 <code>QosTxop</code>  继承自 <code>Txop</code> ，并且没有重写 <code>Queue</code>  方法</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * \\brief Handle packet fragmentation and retransmissions for QoS data frames as well</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * as MSDU aggregation (A-MSDU) and block ack sessions, for a given access class.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * \\ingroup wifi</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * This class implements the packet fragmentation and retransmission policy for</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> * QoS data frames. It uses the ns3::MacLow and ns3::ChannelAccessManager helper classes</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> * to respectively send packets and decide when to send them. Packets are stored</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> * in a ns3::WifiMacQueue until they can be sent.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> * This queue contains packets for a particular access class.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> * Possibles access classes are:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre> *   - AC_VO : voice, TID = 6,7</pre></td></tr><tr><td data-num=\"14\"></td><td><pre> *   - AC_VI : video, TID = 4,5</pre></td></tr><tr><td data-num=\"15\"></td><td><pre> *   - AC_BE : best-effort, TID = 0,3</pre></td></tr><tr><td data-num=\"16\"></td><td><pre> *   - AC_BK : background, TID = 1,2</pre></td></tr><tr><td data-num=\"17\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"18\"></td><td><pre> * This class also implements block ack sessions and MSDU aggregation (A-MSDU).</pre></td></tr><tr><td data-num=\"19\"></td><td><pre> * If A-MSDU is enabled for that access class, it picks several packets from the</pre></td></tr><tr><td data-num=\"20\"></td><td><pre> * queue instead of a single one and sends the aggregated packet to ns3::MacLow.</pre></td></tr><tr><td data-num=\"21\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"22\"></td><td><pre> * The fragmentation policy currently implemented uses a simple</pre></td></tr><tr><td data-num=\"23\"></td><td><pre> * threshold: any packet bigger than this threshold is fragmented</pre></td></tr><tr><td data-num=\"24\"></td><td><pre> * in fragments whose size is smaller than the threshold.</pre></td></tr><tr><td data-num=\"25\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"26\"></td><td><pre> * The retransmission policy is also very simple: every packet is</pre></td></tr><tr><td data-num=\"27\"></td><td><pre> * retransmitted until it is either successfully transmitted or</pre></td></tr><tr><td data-num=\"28\"></td><td><pre> * it has been retransmitted up until the SSRC or SLRC thresholds.</pre></td></tr><tr><td data-num=\"29\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"30\"></td><td><pre> * The RTS/CTS policy is similar to the fragmentation policy: when</pre></td></tr><tr><td data-num=\"31\"></td><td><pre> * a packet is bigger than a threshold, the RTS/CTS protocol is used.</pre></td></tr><tr><td data-num=\"32\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">QosTxop</span> <span class=\"token operator\">:</span> <span class=\"token base-clause\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">Txop</span></span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>那么接下来就看 <code>Txop::Queue</code>  函数</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">Txop</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Queue</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> WifiMacHeader <span class=\"token operator\">&amp;</span>hdr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> packet <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">&amp;</span>hdr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">// remove the priority tag attached, if any</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  SocketPriorityTag priorityTag<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  packet<span class=\"token operator\">-></span><span class=\"token function\">RemovePacketTag</span> <span class=\"token punctuation\">(</span>priorityTag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_channelAccessManager<span class=\"token operator\">-></span><span class=\"token function\">NeedBackoffUponAccess</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token function\">GenerateBackoff</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  m_queue<span class=\"token operator\">-></span><span class=\"token function\">Enqueue</span> <span class=\"token punctuation\">(</span><span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>WifiMacQueueItem<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span>packet<span class=\"token punctuation\">,</span> hdr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token function\">StartAccessIfNeeded</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>从该方法中可以看出， <code>packet</code>  加入队列， <code>m_queue</code>  的类型为 <code>Ptr&lt;WifiMacQueue&gt;</code> ，功能就是讲 <code>packet</code>  加入队列。   <code>StartAccessIfNeeded ()</code> ; 这一行代码就会判断当前信道空闲与否，随机回退值等。</p>\n<p>接下来就是 <code>Txop::StartAccessIfNeeded</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">Txop</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">StartAccessIfNeeded</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_currentPacket <span class=\"token operator\">==</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>m_queue<span class=\"token operator\">-></span><span class=\"token function\">IsEmpty</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token function\">IsAccessRequested</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>m_low<span class=\"token operator\">-></span><span class=\"token function\">IsCfPeriod</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      m_channelAccessManager<span class=\"token operator\">-></span><span class=\"token function\">RequestAccess</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>m_currentPacket</code>  代表当前正在发送的 <code>packet</code> 。<br />\n <code>m_queue</code>  就是 <code>packet</code>  队列。<br />\n这里主要就是做了判断，然后请求获取信道权限</p>\n<p>接下来就是 <code>ChannelAccessManager::RequestAccess</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">ChannelAccessManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">RequestAccess</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Txop<span class=\"token operator\">></span> txop<span class=\"token punctuation\">,</span> <span class=\"token keyword\">bool</span> isCfPeriod<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> txop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_phy<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      m_phy<span class=\"token operator\">-></span><span class=\"token function\">NotifyChannelAccessRequested</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token comment\">//Deny access if in sleep mode or off</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_sleeping <span class=\"token operator\">||</span> m_off<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isCfPeriod<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      txop<span class=\"token operator\">-></span><span class=\"token function\">NotifyAccessRequested</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      Time delay <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MostRecent</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token function\">GetAccessGrantStart</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      m_accessTimeout <span class=\"token operator\">=</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Schedule</span> <span class=\"token punctuation\">(</span>delay<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>ChannelAccessManager<span class=\"token double-colon punctuation\">::</span>DoGrantPcfAccess<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> txop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   * EDCAF operations shall be performed at slot boundaries (Sec. 10.22.2.4 of 802.11-2016)</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>   */</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  Time accessGrantStart <span class=\"token operator\">=</span> <span class=\"token function\">GetAccessGrantStart</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>txop<span class=\"token operator\">-></span><span class=\"token function\">GetAifsn</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token function\">GetSlot</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>txop<span class=\"token operator\">-></span><span class=\"token function\">IsQosTxop</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> txop<span class=\"token operator\">-></span><span class=\"token function\">GetBackoffStart</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> accessGrantStart<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token comment\">// The backoff start time reported by the EDCAF is more recent than the last</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token comment\">// time the medium was busy plus an AIFS, hence we need to align it to the</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token comment\">// next slot boundary.</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      Time diff <span class=\"token operator\">=</span> txop<span class=\"token operator\">-></span><span class=\"token function\">GetBackoffStart</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> accessGrantStart<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      <span class=\"token keyword\">uint32_t</span> nIntSlots <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>diff <span class=\"token operator\">/</span> <span class=\"token function\">GetSlot</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetHigh</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      txop<span class=\"token operator\">-></span><span class=\"token function\">UpdateBackoffSlotsNow</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> accessGrantStart <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>nIntSlots <span class=\"token operator\">*</span> <span class=\"token function\">GetSlot</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token function\">UpdateBackoff</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>txop<span class=\"token operator\">-></span><span class=\"token function\">IsAccessRequested</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  txop<span class=\"token operator\">-></span><span class=\"token function\">NotifyAccessRequested</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token function\">DoGrantDcfAccess</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token function\">DoRestartAccessTimeoutIfNeeded</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这块的重点是 <code>ChannelAccessManager::DoGrantDcfAccess</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">ChannelAccessManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">DoGrantDcfAccess</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">uint32_t</span> k <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>Txops<span class=\"token double-colon punctuation\">::</span>iterator i <span class=\"token operator\">=</span> m_txops<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">!=</span> m_txops<span class=\"token punctuation\">.</span><span class=\"token function\">end</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> k<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      Ptr<span class=\"token operator\">&lt;</span>Txop<span class=\"token operator\">></span> txop <span class=\"token operator\">=</span> <span class=\"token operator\">*</span>i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>txop<span class=\"token operator\">-></span><span class=\"token function\">IsAccessRequested</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">GetBackoffEndFor</span> <span class=\"token punctuation\">(</span>txop<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>           * This is the first Txop we find with an expired backoff and which</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>           * needs access to the medium. i.e., it has data to send.</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>           */</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"dcf \"</span> <span class=\"token operator\">&lt;&lt;</span> k <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" needs access. backoff expired. access granted. slots=\"</span> <span class=\"token operator\">&lt;&lt;</span> txop<span class=\"token operator\">-></span><span class=\"token function\">GetBackoffSlots</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>          i<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//go to the next item in the list.</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>          k<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span>Ptr<span class=\"token operator\">&lt;</span>Txop<span class=\"token operator\">></span> <span class=\"token operator\">></span> internalCollisionTxops<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>Txops<span class=\"token double-colon punctuation\">::</span>iterator j <span class=\"token operator\">=</span> i<span class=\"token punctuation\">;</span> j <span class=\"token operator\">!=</span> m_txops<span class=\"token punctuation\">.</span><span class=\"token function\">end</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> j<span class=\"token operator\">++</span><span class=\"token punctuation\">,</span> k<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>              Ptr<span class=\"token operator\">&lt;</span>Txop<span class=\"token operator\">></span> otherTxop <span class=\"token operator\">=</span> <span class=\"token operator\">*</span>j<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>otherTxop<span class=\"token operator\">-></span><span class=\"token function\">IsAccessRequested</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                  <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">GetBackoffEndFor</span> <span class=\"token punctuation\">(</span>otherTxop<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                  <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"dcf \"</span> <span class=\"token operator\">&lt;&lt;</span> k <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" needs access. backoff expired. internal collision. slots=\"</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                                otherTxop<span class=\"token operator\">-></span><span class=\"token function\">GetBackoffSlots</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                  <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                   * all other Txops with a lower priority whose backoff</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                   * has expired and which needed access to the medium</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                   * must be notified that we did get an internal collision.</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                   */</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                  internalCollisionTxops<span class=\"token punctuation\">.</span><span class=\"token function\">push_back</span> <span class=\"token punctuation\">(</span>otherTxop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>           * Now, we notify all of these changes in one go. It is necessary to</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>           * perform first the calculations of which Txops are colliding and then</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>           * only apply the changes because applying the changes through notification</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>           * could change the global state of the manager, and, thus, could change</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>           * the result of the calculations.</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>           */</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          txop<span class=\"token operator\">-></span><span class=\"token function\">NotifyAccessGranted</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">auto</span> collidingTxop <span class=\"token operator\">:</span> internalCollisionTxops<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>              collidingTxop<span class=\"token operator\">-></span><span class=\"token function\">NotifyInternalCollision</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      i<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>在该函数中，请求完权限后又跳回到  <code>Txop:NotifyAccessGranted</code> ;</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">Txop</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">NotifyAccessGranted</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>m_accessRequested<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  m_accessRequested <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_currentPacket <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_queue<span class=\"token operator\">-></span><span class=\"token function\">IsEmpty</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"queue empty\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      Ptr<span class=\"token operator\">&lt;</span>WifiMacQueueItem<span class=\"token operator\">></span> item <span class=\"token operator\">=</span> m_queue<span class=\"token operator\">-></span><span class=\"token function\">Dequeue</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>item <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      m_currentPacket <span class=\"token operator\">=</span> item<span class=\"token operator\">-></span><span class=\"token function\">GetPacket</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      m_currentHdr <span class=\"token operator\">=</span> item<span class=\"token operator\">-></span><span class=\"token function\">GetHeader</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>m_currentPacket <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token keyword\">uint16_t</span> sequence <span class=\"token operator\">=</span> m_txMiddle<span class=\"token operator\">-></span><span class=\"token function\">GetNextSequenceNumberFor</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>m_currentHdr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      m_currentHdr<span class=\"token punctuation\">.</span><span class=\"token function\">SetSequenceNumber</span> <span class=\"token punctuation\">(</span>sequence<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      m_stationManager<span class=\"token operator\">-></span><span class=\"token function\">UpdateFragmentationThreshold</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      m_currentHdr<span class=\"token punctuation\">.</span><span class=\"token function\">SetFragmentNumber</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      m_currentHdr<span class=\"token punctuation\">.</span><span class=\"token function\">SetNoMoreFragments</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      m_currentHdr<span class=\"token punctuation\">.</span><span class=\"token function\">SetNoRetry</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      m_fragmentNumber <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"dequeued size=\"</span> <span class=\"token operator\">&lt;&lt;</span> m_currentPacket<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                    <span class=\"token string\">\", to=\"</span> <span class=\"token operator\">&lt;&lt;</span> m_currentHdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetAddr1</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                    <span class=\"token string\">\", seq=\"</span> <span class=\"token operator\">&lt;&lt;</span> m_currentHdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetSequenceControl</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_currentHdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetAddr1</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">IsGroup</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      m_currentParams<span class=\"token punctuation\">.</span><span class=\"token function\">DisableRts</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      m_currentParams<span class=\"token punctuation\">.</span><span class=\"token function\">DisableAck</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      m_currentParams<span class=\"token punctuation\">.</span><span class=\"token function\">DisableNextData</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"tx broadcast\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      <span class=\"token function\">GetLow</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">StartTransmission</span> <span class=\"token punctuation\">(</span><span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>WifiMacQueueItem<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span>m_currentPacket<span class=\"token punctuation\">,</span> m_currentHdr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                                    m_currentParams<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      m_currentParams<span class=\"token punctuation\">.</span><span class=\"token function\">EnableAck</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">NeedFragmentation</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          m_currentParams<span class=\"token punctuation\">.</span><span class=\"token function\">DisableRts</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          WifiMacHeader hdr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> fragment <span class=\"token operator\">=</span> <span class=\"token function\">GetFragmentPacket</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>hdr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">IsLastFragment</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>              <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"fragmenting last fragment size=\"</span> <span class=\"token operator\">&lt;&lt;</span> fragment<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>              m_currentParams<span class=\"token punctuation\">.</span><span class=\"token function\">DisableNextData</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>              <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"fragmenting size=\"</span> <span class=\"token operator\">&lt;&lt;</span> fragment<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>              m_currentParams<span class=\"token punctuation\">.</span><span class=\"token function\">EnableNextData</span> <span class=\"token punctuation\">(</span><span class=\"token function\">GetNextFragmentSize</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          <span class=\"token function\">GetLow</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">StartTransmission</span> <span class=\"token punctuation\">(</span><span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>WifiMacQueueItem<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">,</span> hdr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                                        m_currentParams<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          <span class=\"token keyword\">uint32_t</span> size <span class=\"token operator\">=</span> m_currentHdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetSize</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> m_currentPacket<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> WIFI_MAC_FCS_LENGTH<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_stationManager<span class=\"token operator\">-></span><span class=\"token function\">NeedRts</span> <span class=\"token punctuation\">(</span>m_currentHdr<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>m_low<span class=\"token operator\">-></span><span class=\"token function\">IsCfPeriod</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>              m_currentParams<span class=\"token punctuation\">.</span><span class=\"token function\">EnableRts</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>          <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>              m_currentParams<span class=\"token punctuation\">.</span><span class=\"token function\">DisableRts</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>          m_currentParams<span class=\"token punctuation\">.</span><span class=\"token function\">DisableNextData</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>          <span class=\"token function\">GetLow</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">StartTransmission</span> <span class=\"token punctuation\">(</span><span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>WifiMacQueueItem<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span>m_currentPacket<span class=\"token punctuation\">,</span> m_currentHdr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>                                        m_currentParams<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>上面的代码会调用 <code>Low ()-&gt;StartTransmission</code>  方法。 <code>Low ()</code>  返回的是 <code>MacLow</code>  类对象。</p>\n<p>所以下一步该调用的是 <code>MacLow::StartTransmission</code>  方法</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">MacLow</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">StartTransmission</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>WifiMacQueueItem<span class=\"token operator\">></span> mpdu<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                           MacLowTransmissionParameters params<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                           Ptr<span class=\"token operator\">&lt;</span>Txop<span class=\"token operator\">></span> txop<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">*</span>mpdu <span class=\"token operator\">&lt;&lt;</span> params <span class=\"token operator\">&lt;&lt;</span> txop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>m_cfAckInfo<span class=\"token punctuation\">.</span>expectCfAck<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_phy<span class=\"token operator\">-></span><span class=\"token function\">IsStateOff</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Cannot start TX because device is OFF\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token comment\">/* m_currentPacket is not NULL because someone started</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   * a transmission and was interrupted before one of:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   *   - ctsTimeout</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   *   - sendDataAfterCTS</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   * expired. This means that one of these timers is still</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   * running. They are all cancelled below anyway by the</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   * call to CancelAllEvents (because of at least one</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   * of these two timers) which will trigger a call to the</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   * previous listener's cancel method.</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   *</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>   * This typically happens because the high-priority</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   * QapScheduler has taken access to the channel from</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>   * one of the EDCA of the QAP.</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>   */</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  m_currentPacket <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>WifiPsdu<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span>mpdu<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token keyword\">const</span> WifiMacHeader<span class=\"token operator\">&amp;</span> hdr <span class=\"token operator\">=</span> mpdu<span class=\"token operator\">-></span><span class=\"token function\">GetHeader</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token function\">CancelAllEvents</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  m_currentTxop <span class=\"token operator\">=</span> txop<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  m_txParams <span class=\"token operator\">=</span> params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hdr<span class=\"token punctuation\">.</span><span class=\"token function\">IsCtl</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      m_currentTxVector <span class=\"token operator\">=</span> <span class=\"token function\">GetRtsTxVector</span> <span class=\"token punctuation\">(</span>mpdu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      m_currentTxVector <span class=\"token operator\">=</span> <span class=\"token function\">GetDataTxVector</span> <span class=\"token punctuation\">(</span>mpdu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token comment\">/* The packet received by this function can be any of the following:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>   * (a) a management frame dequeued from the Txop</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>   * (b) a non-QoS data frame dequeued from the Txop</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>   * (c) a non-group addressed QoS Data frame peeked or dequeued from a QosTxop</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>   * (d) a group addressed QoS data or DELBA Request frame dequeued from a QosTxop</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>   * (e) a BlockAckReq or ADDBA Request frame</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>   * (f) a fragment of non-QoS/QoS Data frame dequeued from the Txop/QosTxop</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>   */</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hdr<span class=\"token punctuation\">.</span><span class=\"token function\">IsQosData</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>hdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetAddr1</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">IsGroup</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>hdr<span class=\"token punctuation\">.</span><span class=\"token function\">IsMoreFragments</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> hdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetFragmentNumber</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>      <span class=\"token comment\">// We get here if the received packet is a non-broadcast QoS data frame</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>      <span class=\"token keyword\">uint8_t</span> tid <span class=\"token operator\">=</span> hdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetQosTid</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      Ptr<span class=\"token operator\">&lt;</span>QosTxop<span class=\"token operator\">></span> qosTxop <span class=\"token operator\">=</span> m_edca<span class=\"token punctuation\">.</span><span class=\"token function\">find</span> <span class=\"token punctuation\">(</span><span class=\"token function\">QosUtilsMapTidToAc</span> <span class=\"token punctuation\">(</span>tid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>second<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      <span class=\"token comment\">// if a TXOP limit exists, compute the remaining TXOP duration</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      Time txopLimit <span class=\"token operator\">=</span> <span class=\"token class-name\">Time</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Min</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_currentTxop<span class=\"token operator\">-></span><span class=\"token function\">GetTxopLimit</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">IsStrictlyPositive</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>          txopLimit <span class=\"token operator\">=</span> m_currentTxop<span class=\"token operator\">-></span><span class=\"token function\">GetTxopRemaining</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token function\">CalculateOverheadTxTime</span> <span class=\"token punctuation\">(</span>mpdu<span class=\"token punctuation\">,</span> m_txParams<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>txopLimit<span class=\"token punctuation\">.</span><span class=\"token function\">IsPositive</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>      <span class=\"token comment\">// QosTxop may send us a peeked frame</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>      Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> WifiMacQueueItem<span class=\"token operator\">></span> tmp <span class=\"token operator\">=</span> qosTxop<span class=\"token operator\">-></span><span class=\"token function\">PeekNextFrame</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>      <span class=\"token keyword\">bool</span> isPeeked <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>tmp <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> tmp<span class=\"token operator\">-></span><span class=\"token function\">GetPacket</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> mpdu<span class=\"token operator\">-></span><span class=\"token function\">GetPacket</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      Ptr<span class=\"token operator\">&lt;</span>WifiMacQueueItem<span class=\"token operator\">></span> newMpdu<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      <span class=\"token comment\">// If the frame has been peeked, dequeue it if it meets the size and duration constraints</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isPeeked<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>          newMpdu <span class=\"token operator\">=</span> qosTxop<span class=\"token operator\">-></span><span class=\"token function\">DequeuePeekedFrame</span> <span class=\"token punctuation\">(</span>mpdu<span class=\"token punctuation\">,</span> m_currentTxVector<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> txopLimit<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>      <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">IsWithinSizeAndTimeLimits</span> <span class=\"token punctuation\">(</span>mpdu<span class=\"token punctuation\">,</span> m_currentTxVector<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> txopLimit<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          newMpdu <span class=\"token operator\">=</span> mpdu<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newMpdu <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          <span class=\"token comment\">// if the frame has been dequeued, then there is no BA agreement with the</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>          <span class=\"token comment\">// receiver (otherwise the frame would have been peeked). Hence, the frame</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>          <span class=\"token comment\">// has been sent under Normal Ack policy, not acknowledged and now retransmitted.</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>          <span class=\"token comment\">// If we cannot send it now, let the QosTxop retransmit it again.</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>          <span class=\"token comment\">// If the frame has been just peeked, reset the current packet at QosTxop.</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isPeeked<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>              qosTxop<span class=\"token operator\">-></span><span class=\"token function\">UpdateCurrentPacket</span> <span class=\"token punctuation\">(</span><span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>WifiMacQueueItem<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">,</span> <span class=\"token function\">WifiMacHeader</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>          <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>      <span class=\"token comment\">// Update the current packet at QosTxop, given that A-MSDU aggregation may have</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>      <span class=\"token comment\">// been performed on the peeked frame</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>      qosTxop<span class=\"token operator\">-></span><span class=\"token function\">UpdateCurrentPacket</span> <span class=\"token punctuation\">(</span>newMpdu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>      <span class=\"token comment\">//Perform MPDU aggregation if possible</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>      std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span>Ptr<span class=\"token operator\">&lt;</span>WifiMacQueueItem<span class=\"token operator\">>></span> mpduList<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_mpduAggregator <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>          mpduList <span class=\"token operator\">=</span> m_mpduAggregator<span class=\"token operator\">-></span><span class=\"token function\">GetNextAmpdu</span> <span class=\"token punctuation\">(</span>newMpdu<span class=\"token punctuation\">,</span> m_currentTxVector<span class=\"token punctuation\">,</span> txopLimit<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mpduList<span class=\"token punctuation\">.</span><span class=\"token function\">size</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>          m_currentPacket <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>WifiPsdu<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span>mpduList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>          <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"tx unicast A-MPDU containing \"</span> <span class=\"token operator\">&lt;&lt;</span> mpduList<span class=\"token punctuation\">.</span><span class=\"token function\">size</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" MPDUs\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>          qosTxop<span class=\"token operator\">-></span><span class=\"token function\">SetAmpduExist</span> <span class=\"token punctuation\">(</span>hdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetAddr1</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>      <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_currentTxVector<span class=\"token punctuation\">.</span><span class=\"token function\">GetMode</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetModulationClass</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> WIFI_MOD_CLASS_VHT</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>               <span class=\"token operator\">||</span> m_currentTxVector<span class=\"token punctuation\">.</span><span class=\"token function\">GetMode</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetModulationClass</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> WIFI_MOD_CLASS_HE<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>          <span class=\"token comment\">// VHT/HE single MPDU</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>          m_currentPacket <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>WifiPsdu<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span>newMpdu<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>          <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"tx unicast S-MPDU with sequence number \"</span> <span class=\"token operator\">&lt;&lt;</span> hdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetSequenceNumber</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>          qosTxop<span class=\"token operator\">-></span><span class=\"token function\">SetAmpduExist</span> <span class=\"token punctuation\">(</span>hdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetAddr1</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>      <span class=\"token keyword\">else</span>  <span class=\"token comment\">// HT</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>          m_currentPacket <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>WifiPsdu<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span>newMpdu<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>      <span class=\"token comment\">// A QoS Txop must have an installed ack policy selector</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>      <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>qosTxop<span class=\"token operator\">-></span><span class=\"token function\">GetAckPolicySelector</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>      qosTxop<span class=\"token operator\">-></span><span class=\"token function\">GetAckPolicySelector</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">UpdateTxParams</span> <span class=\"token punctuation\">(</span>m_currentPacket<span class=\"token punctuation\">,</span> m_txParams<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>      qosTxop<span class=\"token operator\">-></span><span class=\"token function\">GetAckPolicySelector</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">SetAckPolicy</span> <span class=\"token punctuation\">(</span>m_currentPacket<span class=\"token punctuation\">,</span> m_txParams<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>  <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"startTx size=\"</span> <span class=\"token operator\">&lt;&lt;</span> m_currentPacket<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>                <span class=\"token string\">\", to=\"</span> <span class=\"token operator\">&lt;&lt;</span> m_currentPacket<span class=\"token operator\">-></span><span class=\"token function\">GetAddr1</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\", txop=\"</span> <span class=\"token operator\">&lt;&lt;</span> m_currentTxop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_txParams<span class=\"token punctuation\">.</span><span class=\"token function\">MustSendRts</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>      <span class=\"token function\">SendRtsForPacket</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>m_ctsToSelfSupported <span class=\"token operator\">||</span> m_stationManager<span class=\"token operator\">-></span><span class=\"token function\">GetUseNonErpProtection</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">NeedCtsToSelf</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>          <span class=\"token function\">SendCtsToSelf</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>      <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>          <span class=\"token function\">SendDataPacket</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>  <span class=\"token comment\">/* When this method completes, either we have taken ownership of the medium or the device switched off in the meantime. */</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>m_phy<span class=\"token operator\">-></span><span class=\"token function\">IsStateTx</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> m_phy<span class=\"token operator\">-></span><span class=\"token function\">IsStateOff</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>一般情况下，三种发送：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">SendRtsForPacket</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 发送 RTS</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">SendCtsToSelf</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 发送 CTS</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">SendDataPacket</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 发送数据</span></pre></td></tr></table></figure><p><code>RTS/CTS</code>  众所周知，主要看一下 <code>SendDatePacket</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">MacLow</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SendDataPacket</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token function\">ForwardDown</span> <span class=\"token punctuation\">(</span>m_currentPacket<span class=\"token punctuation\">,</span> m_currentTxVector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>MacLow::ForwardDown</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">MacLow</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ForwardDown</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> WifiPsdu<span class=\"token operator\">></span> psdu<span class=\"token punctuation\">,</span> WifiTxVector txVector<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> psdu <span class=\"token operator\">&lt;&lt;</span> txVector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token operator\">-></span><span class=\"token function\">GetNMpdus</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">const</span> WifiMacHeader<span class=\"token operator\">&amp;</span> hdr <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>psdu<span class=\"token operator\">-></span><span class=\"token function\">begin</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetHeader</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"send \"</span> <span class=\"token operator\">&lt;&lt;</span> hdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetTypeString</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                <span class=\"token string\">\", to=\"</span> <span class=\"token operator\">&lt;&lt;</span> hdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetAddr1</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token string\">\", size=\"</span> <span class=\"token operator\">&lt;&lt;</span> psdu<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token string\">\", mode=\"</span> <span class=\"token operator\">&lt;&lt;</span> txVector<span class=\"token punctuation\">.</span><span class=\"token function\">GetMode</span>  <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token string\">\", preamble=\"</span> <span class=\"token operator\">&lt;&lt;</span> txVector<span class=\"token punctuation\">.</span><span class=\"token function\">GetPreambleType</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token string\">\", duration=\"</span> <span class=\"token operator\">&lt;&lt;</span> hdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetDuration</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token string\">\", seq=0x\"</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>hex <span class=\"token operator\">&lt;&lt;</span> hdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetSequenceControl</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>dec<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hdr<span class=\"token punctuation\">.</span><span class=\"token function\">IsCfPoll</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> m_stationManager<span class=\"token operator\">-></span><span class=\"token function\">GetPcfSupported</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Schedule</span> <span class=\"token punctuation\">(</span><span class=\"token function\">GetPifs</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> m_phy<span class=\"token operator\">-></span><span class=\"token function\">CalculateTxDuration</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> txVector<span class=\"token punctuation\">,</span> m_phy<span class=\"token operator\">-></span><span class=\"token function\">GetPhyBand</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>MacLow<span class=\"token double-colon punctuation\">::</span>CfPollTimeout<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hdr<span class=\"token punctuation\">.</span><span class=\"token function\">IsBeacon</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> m_stationManager<span class=\"token operator\">-></span><span class=\"token function\">GetPcfSupported</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> m_lastBeacon <span class=\"token operator\">+</span> m_beaconInterval<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          m_cfpForeshortening <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> m_lastBeacon <span class=\"token operator\">-</span> m_beaconInterval<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      m_lastBeacon <span class=\"token operator\">=</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hdr<span class=\"token punctuation\">.</span><span class=\"token function\">IsCfEnd</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> m_stationManager<span class=\"token operator\">-></span><span class=\"token function\">GetPcfSupported</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      m_cfpStart <span class=\"token operator\">=</span> <span class=\"token function\">NanoSeconds</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      m_cfpForeshortening <span class=\"token operator\">=</span> <span class=\"token function\">NanoSeconds</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      m_cfAckInfo<span class=\"token punctuation\">.</span>appendCfAck <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      m_cfAckInfo<span class=\"token punctuation\">.</span>expectCfAck <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">IsCfPeriod</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> hdr<span class=\"token punctuation\">.</span><span class=\"token function\">HasData</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      m_cfAckInfo<span class=\"token punctuation\">.</span>expectCfAck <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token operator\">-></span><span class=\"token function\">IsSingle</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      txVector<span class=\"token punctuation\">.</span><span class=\"token function\">SetAggregation</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Sending S-MPDU\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token operator\">-></span><span class=\"token function\">IsAggregate</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      txVector<span class=\"token punctuation\">.</span><span class=\"token function\">SetAggregation</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Sending A-MPDU\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Sending non aggregate MPDU\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">auto</span><span class=\"token operator\">&amp;</span> mpdu <span class=\"token operator\">:</span> <span class=\"token operator\">*</span><span class=\"token function\">PeekPointer</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mpdu<span class=\"token operator\">-></span><span class=\"token function\">GetHeader</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">IsQosData</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>          <span class=\"token keyword\">auto</span> edcaIt <span class=\"token operator\">=</span> m_edca<span class=\"token punctuation\">.</span><span class=\"token function\">find</span> <span class=\"token punctuation\">(</span><span class=\"token function\">QosUtilsMapTidToAc</span> <span class=\"token punctuation\">(</span>mpdu<span class=\"token operator\">-></span><span class=\"token function\">GetHeader</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetQosTid</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          edcaIt<span class=\"token operator\">-></span>second<span class=\"token operator\">-></span><span class=\"token function\">CompleteMpduTx</span> <span class=\"token punctuation\">(</span>mpdu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  m_phy<span class=\"token operator\">-></span><span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token punctuation\">,</span> txVector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>MacLow::ForwardDown</code>  会调用 <code>m_phy</code>  对象的 <code>SendPacket</code>  方法。</p>\n<p><code>m_phy</code>  就是 <code>WifiPhy</code>  类型，代表物理层。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">WifiPhy</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> WifiPsdu<span class=\"token operator\">></span> psdu<span class=\"token punctuation\">,</span> WifiTxVector txVector<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">*</span>psdu <span class=\"token operator\">&lt;&lt;</span> txVector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">/* Transmission can happen if:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   *  - we are syncing on a packet. It is the responsibility of the</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   *    MAC layer to avoid doing this but the PHY does nothing to</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   *    prevent it.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   *  - we are idle</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   */</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>m_state<span class=\"token operator\">-></span><span class=\"token function\">IsStateTx</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>m_state<span class=\"token operator\">-></span><span class=\"token function\">IsStateSwitching</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>m_endTxEvent<span class=\"token punctuation\">.</span><span class=\"token function\">IsExpired</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>txVector<span class=\"token punctuation\">.</span><span class=\"token function\">GetNss</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token function\">GetMaxSupportedTxSpatialStreams</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token function\">NS_FATAL_ERROR</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Unsupported number of spatial streams!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_state<span class=\"token operator\">-></span><span class=\"token function\">IsStateSleep</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Dropping packet because in sleep mode\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token function\">NotifyTxDrop</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  Time txDuration <span class=\"token operator\">=</span> <span class=\"token function\">CalculateTxDuration</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> txVector<span class=\"token punctuation\">,</span> <span class=\"token function\">GetPhyBand</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>txDuration<span class=\"token punctuation\">.</span><span class=\"token function\">IsStrictlyPositive</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>m_currentEvent <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>m_currentEvent<span class=\"token operator\">-></span><span class=\"token function\">GetEndTime</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> m_state<span class=\"token operator\">-></span><span class=\"token function\">GetDelayUntilIdle</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      <span class=\"token comment\">//that packet will be noise _after_ the transmission.</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      <span class=\"token function\">MaybeCcaBusyDuration</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_currentEvent <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      <span class=\"token function\">AbortCurrentReception</span> <span class=\"token punctuation\">(</span>RECEPTION_ABORTED_BY_TX<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_powerRestricted<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Transmitting with power restriction\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Transmitting without power restriction\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_state<span class=\"token operator\">-></span><span class=\"token function\">GetState</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> WifiPhyState<span class=\"token double-colon punctuation\">::</span>OFF<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Transmission canceled because device is OFF\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  <span class=\"token keyword\">double</span> txPowerW <span class=\"token operator\">=</span> <span class=\"token function\">DbmToW</span> <span class=\"token punctuation\">(</span><span class=\"token function\">GetTxPowerForTransmission</span> <span class=\"token punctuation\">(</span>txVector<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token function\">GetTxGain</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  <span class=\"token function\">NotifyTxBegin</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token punctuation\">,</span> txPowerW<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  <span class=\"token function\">m_phyTxPsduBeginTrace</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token punctuation\">,</span> txVector<span class=\"token punctuation\">,</span> txPowerW<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  <span class=\"token function\">NotifyMonitorSniffTx</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token punctuation\">,</span> <span class=\"token function\">GetFrequency</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> txVector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  m_state<span class=\"token operator\">-></span><span class=\"token function\">SwitchToTx</span> <span class=\"token punctuation\">(</span>txDuration<span class=\"token punctuation\">,</span> psdu<span class=\"token operator\">-></span><span class=\"token function\">GetPacket</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">GetPowerDbm</span> <span class=\"token punctuation\">(</span>txVector<span class=\"token punctuation\">.</span><span class=\"token function\">GetTxPowerLevel</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> txVector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>WifiPpdu<span class=\"token operator\">></span> ppdu <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>WifiPpdu<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span>psdu<span class=\"token punctuation\">,</span> txVector<span class=\"token punctuation\">,</span> txDuration<span class=\"token punctuation\">,</span> <span class=\"token function\">GetPhyBand</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_wifiRadioEnergyModel <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> m_wifiRadioEnergyModel<span class=\"token operator\">-></span><span class=\"token function\">GetMaximumTimeInState</span> <span class=\"token punctuation\">(</span>WifiPhyState<span class=\"token double-colon punctuation\">::</span>TX<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> txDuration<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>      ppdu<span class=\"token operator\">-></span><span class=\"token function\">SetTruncatedTx</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  m_endTxEvent <span class=\"token operator\">=</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Schedule</span> <span class=\"token punctuation\">(</span>txDuration<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>WifiPhy<span class=\"token double-colon punctuation\">::</span>NotifyTxEnd<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> psdu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  <span class=\"token function\">StartTx</span> <span class=\"token punctuation\">(</span>ppdu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  m_channelAccessRequested <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  m_powerRestricted <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>在此函数中调用了 <code>WifiPhy::StartTx</code>  方法，该方法原型如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   * \\param ppdu the PPDU to send</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   */</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">void</span> <span class=\"token function\">StartTx</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>WifiPpdu<span class=\"token operator\">></span> ppdu<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>该函数是个虚函数具体实现是由其子类实现</p>\n<p><img data-src=\"https://yeyu-blog.oss-cn-beijing.aliyuncs.com/article_images/wifiPhy%E7%9A%84%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB.jpg\" alt=\"WifiPhy继承关系\" /></p>\n<p>因此这里主要看一下 <code>YansWifiPhy</code>  的 <code>StartTx</code>  方法， <code>SpectrumWifiPhy</code>  也类似。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">YansWifiPhy</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">StartTx</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>WifiPpdu<span class=\"token operator\">></span> ppdu<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> ppdu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  WifiTxVector txVector <span class=\"token operator\">=</span> ppdu<span class=\"token operator\">-></span><span class=\"token function\">GetTxVector</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Start transmission: signal power before antenna gain=\"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token function\">GetPowerDbm</span> <span class=\"token punctuation\">(</span>txVector<span class=\"token punctuation\">.</span><span class=\"token function\">GetTxPowerLevel</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"dBm\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  m_channel<span class=\"token operator\">-></span><span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> ppdu<span class=\"token punctuation\">,</span> <span class=\"token function\">GetTxPowerForTransmission</span> <span class=\"token punctuation\">(</span>txVector<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token function\">GetTxGain</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token function\">rtTx</span> <span class=\"token punctuation\">(</span>txParams<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>都是调用 <code>Channel::send</code>  方法，因此对应的就是 <code>YansWifiChannel::Send</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">YansWifiChannel</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>YansWifiPhy<span class=\"token operator\">></span> sender<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> WifiPpdu<span class=\"token operator\">></span> ppdu<span class=\"token punctuation\">,</span> <span class=\"token keyword\">double</span> txPowerDbm<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> sender <span class=\"token operator\">&lt;&lt;</span> ppdu <span class=\"token operator\">&lt;&lt;</span> txPowerDbm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>MobilityModel<span class=\"token operator\">></span> senderMobility <span class=\"token operator\">=</span> sender<span class=\"token operator\">-></span><span class=\"token function\">GetMobility</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>senderMobility <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>PhyList<span class=\"token double-colon punctuation\">::</span>const_iterator i <span class=\"token operator\">=</span> m_phyList<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">!=</span> m_phyList<span class=\"token punctuation\">.</span><span class=\"token function\">end</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sender <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          <span class=\"token comment\">//For now don't account for inter channel interference nor channel bonding</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>i<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetChannelNumber</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> sender<span class=\"token operator\">-></span><span class=\"token function\">GetChannelNumber</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>          Ptr<span class=\"token operator\">&lt;</span>MobilityModel<span class=\"token operator\">></span> receiverMobility <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>i<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetMobility</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token generic-function\"><span class=\"token function\">GetObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>MobilityModel<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>          Time delay <span class=\"token operator\">=</span> m_delay<span class=\"token operator\">-></span><span class=\"token function\">GetDelay</span> <span class=\"token punctuation\">(</span>senderMobility<span class=\"token punctuation\">,</span> receiverMobility<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          <span class=\"token keyword\">double</span> rxPowerDbm <span class=\"token operator\">=</span> m_loss<span class=\"token operator\">-></span><span class=\"token function\">CalcRxPower</span> <span class=\"token punctuation\">(</span>txPowerDbm<span class=\"token punctuation\">,</span> senderMobility<span class=\"token punctuation\">,</span> receiverMobility<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"propagation: txPower=\"</span> <span class=\"token operator\">&lt;&lt;</span> txPowerDbm <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"dbm, rxPower=\"</span> <span class=\"token operator\">&lt;&lt;</span> rxPowerDbm <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"dbm, \"</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                        <span class=\"token string\">\"distance=\"</span> <span class=\"token operator\">&lt;&lt;</span> senderMobility<span class=\"token operator\">-></span><span class=\"token function\">GetDistanceFrom</span> <span class=\"token punctuation\">(</span>receiverMobility<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"m, delay=\"</span> <span class=\"token operator\">&lt;&lt;</span> delay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          Ptr<span class=\"token operator\">&lt;</span>WifiPpdu<span class=\"token operator\">></span> copy <span class=\"token operator\">=</span> <span class=\"token function\">Copy</span> <span class=\"token punctuation\">(</span>ppdu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          Ptr<span class=\"token operator\">&lt;</span>NetDevice<span class=\"token operator\">></span> dstNetDevice <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>i<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetDevice</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          <span class=\"token keyword\">uint32_t</span> dstNode<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dstNetDevice <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              dstNode <span class=\"token operator\">=</span> <span class=\"token number\">0xffffffff</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>          <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>              dstNode <span class=\"token operator\">=</span> dstNetDevice<span class=\"token operator\">-></span><span class=\"token function\">GetNode</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetId</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ScheduleWithContext</span> <span class=\"token punctuation\">(</span>dstNode<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                                          delay<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>YansWifiChannel<span class=\"token double-colon punctuation\">::</span>Receive<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                                          <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> copy<span class=\"token punctuation\">,</span> rxPowerDbm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>在 <code>Send</code>  函数中，主要做了这样三件事</p>\n<ol>\n<li>\n<p>计算时延 <code>delay</code></p>\n</li>\n<li>\n<p>计算信号衰减</p>\n</li>\n<li>\n<p>在 <code>delay</code>  后调用回调函数 <code>YansWifiChannel::Receive</code>  接收数据包。</p>\n</li>\n</ol>\n<p>读到这里已经可以松一口气了，我们的发送过程已经结束了，让我们再回顾一下流程</p>\n<h4 id=\"发送的流程图\"><a class=\"anchor\" href=\"#发送的流程图\">#</a> 发送的流程图</h4>\n<p><img data-src=\"https://yeyu-blog.oss-cn-beijing.aliyuncs.com/article_images/wifi%E6%A8%A1%E5%9D%97%E5%8F%91%E9%80%81%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg\" alt=\"wifi模块发送流程图\" /></p>\n<p>接下来就是从 <code>Channel</code>  再将数据传回 <code>WifiNetDevice</code> 。</p>\n<h3 id=\"接收过程源码分析\"><a class=\"anchor\" href=\"#接收过程源码分析\">#</a> 接收过程源码分析</h3>\n<p>那么开始的起点，自然也还是从 <code>Channel</code>  的 <code>Recive</code> ，即 <code>YansWifiChannel::Receive</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">YansWifiChannel</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Receive</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>YansWifiPhy<span class=\"token operator\">></span> phy<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span>WifiPpdu<span class=\"token operator\">></span> ppdu<span class=\"token punctuation\">,</span> <span class=\"token keyword\">double</span> rxPowerDbm<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span>phy <span class=\"token operator\">&lt;&lt;</span> ppdu <span class=\"token operator\">&lt;&lt;</span> rxPowerDbm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">// Do no further processing if signal is too weak</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token comment\">// Current implementation assumes constant RX power over the PPDU duration</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>rxPowerDbm <span class=\"token operator\">+</span> phy<span class=\"token operator\">-></span><span class=\"token function\">GetRxGain</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> phy<span class=\"token operator\">-></span><span class=\"token function\">GetRxSensitivity</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token function\">NS_LOG_INFO</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Received signal too weak to process: \"</span> <span class=\"token operator\">&lt;&lt;</span> rxPowerDbm <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" dBm\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  phy<span class=\"token operator\">-></span><span class=\"token function\">StartReceivePreamble</span> <span class=\"token punctuation\">(</span>ppdu<span class=\"token punctuation\">,</span> <span class=\"token function\">DbmToW</span> <span class=\"token punctuation\">(</span>rxPowerDbm <span class=\"token operator\">+</span> phy<span class=\"token operator\">-></span><span class=\"token function\">GetRxGain</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>虽然这里调用的是 <code>YansWifiPhy::StartReceivePreamble</code> ，但是子类中不含该方法，所以实际调用的是</p>\n<p>父类 <code>WifiPhy</code>  的方法</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">WifiPhy</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">StartReceivePreamble</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>WifiPpdu<span class=\"token operator\">></span> ppdu<span class=\"token punctuation\">,</span> <span class=\"token keyword\">double</span> rxPowerW<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">*</span>ppdu <span class=\"token operator\">&lt;&lt;</span> rxPowerW<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  WifiTxVector txVector <span class=\"token operator\">=</span> ppdu<span class=\"token operator\">-></span><span class=\"token function\">GetTxVector</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  Time rxDuration <span class=\"token operator\">=</span> ppdu<span class=\"token operator\">-></span><span class=\"token function\">GetTxDuration</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> WifiPsdu<span class=\"token operator\">></span> psdu <span class=\"token operator\">=</span> ppdu<span class=\"token operator\">-></span><span class=\"token function\">GetPsdu</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>Event<span class=\"token operator\">></span> event <span class=\"token operator\">=</span> m_interference<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span> <span class=\"token punctuation\">(</span>ppdu<span class=\"token punctuation\">,</span> txVector<span class=\"token punctuation\">,</span> rxDuration<span class=\"token punctuation\">,</span> rxPowerW<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  Time endRx <span class=\"token operator\">=</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> rxDuration<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_state<span class=\"token operator\">-></span><span class=\"token function\">GetState</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> WifiPhyState<span class=\"token double-colon punctuation\">::</span>OFF<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Cannot start RX because device is OFF\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>endRx <span class=\"token operator\">></span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> m_state<span class=\"token operator\">-></span><span class=\"token function\">GetDelayUntilIdle</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          <span class=\"token function\">MaybeCcaBusyDuration</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ppdu<span class=\"token operator\">-></span><span class=\"token function\">IsTruncatedTx</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Packet reception stopped because transmitter has been switched off\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>endRx <span class=\"token operator\">></span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> m_state<span class=\"token operator\">-></span><span class=\"token function\">GetDelayUntilIdle</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          <span class=\"token function\">MaybeCcaBusyDuration</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>txVector<span class=\"token punctuation\">.</span><span class=\"token function\">GetModeInitialized</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token comment\">//If SetRate method was not called above when filling in txVector, this means the PHY does support the rate indicated in PHY SIG headers</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"drop packet because of unsupported RX mode\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      <span class=\"token function\">NotifyRxDrop</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token punctuation\">,</span> UNSUPPORTED_SETTINGS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>endRx <span class=\"token operator\">></span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> m_state<span class=\"token operator\">-></span><span class=\"token function\">GetDelayUntilIdle</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          <span class=\"token function\">MaybeCcaBusyDuration</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>m_state<span class=\"token operator\">-></span><span class=\"token function\">GetState</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token keyword\">case</span> WifiPhyState<span class=\"token double-colon punctuation\">::</span>SWITCHING<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"drop packet because of channel switching\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      <span class=\"token function\">NotifyRxDrop</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token punctuation\">,</span> CHANNEL_SWITCHING<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      <span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>       * Packets received on the upcoming channel are added to the event list</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>       * during the switching state. This way the medium can be correctly sensed</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>       * when the device listens to the channel for the first time after the</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>       * switching e.g. after channel switching, the channel may be sensed as</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>       * busy due to other devices' transmissions started before the end of</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>       * the switching.</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>       */</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>endRx <span class=\"token operator\">></span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> m_state<span class=\"token operator\">-></span><span class=\"token function\">GetDelayUntilIdle</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>          <span class=\"token comment\">//that packet will be noise _after_ the completion of the channel switching.</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          <span class=\"token function\">MaybeCcaBusyDuration</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token keyword\">case</span> WifiPhyState<span class=\"token double-colon punctuation\">::</span>RX<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>m_currentEvent <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_frameCaptureModel <span class=\"token operator\">!=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          <span class=\"token operator\">&amp;&amp;</span> m_frameCaptureModel<span class=\"token operator\">-></span><span class=\"token function\">IsInCaptureWindow</span> <span class=\"token punctuation\">(</span>m_timeLastPreambleDetected<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>          <span class=\"token operator\">&amp;&amp;</span> m_frameCaptureModel<span class=\"token operator\">-></span><span class=\"token function\">CaptureNewFrame</span> <span class=\"token punctuation\">(</span>m_currentEvent<span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>          <span class=\"token function\">AbortCurrentReception</span> <span class=\"token punctuation\">(</span>FRAME_CAPTURE_PACKET_SWITCH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>          <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Switch to new packet\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>          <span class=\"token function\">StartRx</span> <span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">,</span> rxPowerW<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>      <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>          <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Drop packet because already in Rx (power=\"</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>                        rxPowerW <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"W)\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          <span class=\"token function\">NotifyRxDrop</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token punctuation\">,</span> RXING<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>endRx <span class=\"token operator\">></span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> m_state<span class=\"token operator\">-></span><span class=\"token function\">GetDelayUntilIdle</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>              <span class=\"token comment\">//that packet will be noise _after_ the reception of the currently-received packet.</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>              <span class=\"token function\">MaybeCcaBusyDuration</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>    <span class=\"token keyword\">case</span> WifiPhyState<span class=\"token double-colon punctuation\">::</span>TX<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Drop packet because already in Tx (power=\"</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>                    rxPowerW <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"W)\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>      <span class=\"token function\">NotifyRxDrop</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token punctuation\">,</span> TXING<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>endRx <span class=\"token operator\">></span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> m_state<span class=\"token operator\">-></span><span class=\"token function\">GetDelayUntilIdle</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>          <span class=\"token comment\">//that packet will be noise _after_ the transmission of the currently-transmitted packet.</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>          <span class=\"token function\">MaybeCcaBusyDuration</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>    <span class=\"token keyword\">case</span> WifiPhyState<span class=\"token double-colon punctuation\">::</span>CCA_BUSY<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_currentEvent <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_frameCaptureModel <span class=\"token operator\">!=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>              <span class=\"token operator\">&amp;&amp;</span> m_frameCaptureModel<span class=\"token operator\">-></span><span class=\"token function\">IsInCaptureWindow</span> <span class=\"token punctuation\">(</span>m_timeLastPreambleDetected<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>              <span class=\"token operator\">&amp;&amp;</span> m_frameCaptureModel<span class=\"token operator\">-></span><span class=\"token function\">CaptureNewFrame</span> <span class=\"token punctuation\">(</span>m_currentEvent<span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>              <span class=\"token function\">AbortCurrentReception</span> <span class=\"token punctuation\">(</span>FRAME_CAPTURE_PACKET_SWITCH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>              <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Switch to new packet\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>              <span class=\"token function\">StartRx</span> <span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">,</span> rxPowerW<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>          <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>              <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Drop packet because already in Rx (power=\"</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>                            rxPowerW <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"W)\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>              <span class=\"token function\">NotifyRxDrop</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token punctuation\">,</span> RXING<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>endRx <span class=\"token operator\">></span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> m_state<span class=\"token operator\">-></span><span class=\"token function\">GetDelayUntilIdle</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>                <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>                  <span class=\"token comment\">//that packet will be noise _after_ the reception of the currently-received packet.</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>                  <span class=\"token function\">MaybeCcaBusyDuration</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>      <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>          <span class=\"token function\">StartRx</span> <span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">,</span> rxPowerW<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>    <span class=\"token keyword\">case</span> WifiPhyState<span class=\"token double-colon punctuation\">::</span>IDLE<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>      <span class=\"token function\">StartRx</span> <span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">,</span> rxPowerW<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>    <span class=\"token keyword\">case</span> WifiPhyState<span class=\"token double-colon punctuation\">::</span>SLEEP<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Drop packet because in sleep mode\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>      <span class=\"token function\">NotifyRxDrop</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token punctuation\">,</span> SLEEPING<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>endRx <span class=\"token operator\">></span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> m_state<span class=\"token operator\">-></span><span class=\"token function\">GetDelayUntilIdle</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>          <span class=\"token comment\">//that packet will be noise _after_ the sleep period.</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>          <span class=\"token function\">MaybeCcaBusyDuration</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>    <span class=\"token keyword\">default</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>      <span class=\"token function\">NS_FATAL_ERROR</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Invalid WifiPhy state.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>实际是根据 <code>Phy</code>  的状态采取不同的策略。</p>\n<p>如果此时可以接收的话，下一步是 <code>WifiPhy::StartRx</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">WifiPhy</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">StartRx</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Event<span class=\"token operator\">></span> event<span class=\"token punctuation\">,</span> <span class=\"token keyword\">double</span> rxPowerW<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">*</span>event <span class=\"token operator\">&lt;&lt;</span> rxPowerW<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"sync to signal (power=\"</span> <span class=\"token operator\">&lt;&lt;</span> rxPowerW <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"W)\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  m_interference<span class=\"token punctuation\">.</span><span class=\"token function\">NotifyRxStart</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//We need to notify it now so that it starts recording events</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>m_endPreambleDetectionEvent<span class=\"token punctuation\">.</span><span class=\"token function\">IsRunning</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      Time startOfPreambleDuration <span class=\"token operator\">=</span> <span class=\"token function\">GetPreambleDetectionDuration</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      Time remainingRxDuration <span class=\"token operator\">=</span> event<span class=\"token operator\">-></span><span class=\"token function\">GetDuration</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> startOfPreambleDuration<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      m_endPreambleDetectionEvent <span class=\"token operator\">=</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Schedule</span> <span class=\"token punctuation\">(</span>startOfPreambleDuration<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>WifiPhy<span class=\"token double-colon punctuation\">::</span>StartReceiveHeader<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>m_frameCaptureModel <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>rxPowerW <span class=\"token operator\">></span> m_currentEvent<span class=\"token operator\">-></span><span class=\"token function\">GetRxPowerW</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Received a stronger signal during preamble detection: drop current packet and switch to new packet\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token function\">NotifyRxDrop</span> <span class=\"token punctuation\">(</span>m_currentEvent<span class=\"token operator\">-></span><span class=\"token function\">GetPsdu</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> PREAMBLE_DETECTION_PACKET_SWITCH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      m_interference<span class=\"token punctuation\">.</span><span class=\"token function\">NotifyRxEnd</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      m_endPreambleDetectionEvent<span class=\"token punctuation\">.</span><span class=\"token function\">Cancel</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      m_interference<span class=\"token punctuation\">.</span><span class=\"token function\">NotifyRxStart</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      Time startOfPreambleDuration <span class=\"token operator\">=</span> <span class=\"token function\">GetPreambleDetectionDuration</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      Time remainingRxDuration <span class=\"token operator\">=</span> event<span class=\"token operator\">-></span><span class=\"token function\">GetDuration</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> startOfPreambleDuration<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      m_endPreambleDetectionEvent <span class=\"token operator\">=</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Schedule</span> <span class=\"token punctuation\">(</span>startOfPreambleDuration<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>WifiPhy<span class=\"token double-colon punctuation\">::</span>StartReceiveHeader<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Drop packet because RX is already decoding preamble\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token function\">NotifyRxDrop</span> <span class=\"token punctuation\">(</span>event<span class=\"token operator\">-></span><span class=\"token function\">GetPsdu</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> BUSY_DECODING_PREAMBLE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  m_currentEvent <span class=\"token operator\">=</span> event<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>接下来是 <code>WifiPhy::StartReceiveHeader</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">WifiPhy</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">StartReceiveHeader</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Event<span class=\"token operator\">></span> event<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">*</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">IsStateRx</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>m_endPhyRxEvent<span class=\"token punctuation\">.</span><span class=\"token function\">IsExpired</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>m_currentEvent <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>event<span class=\"token operator\">-></span><span class=\"token function\">GetStartTime</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> m_currentEvent<span class=\"token operator\">-></span><span class=\"token function\">GetStartTime</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>event<span class=\"token operator\">-></span><span class=\"token function\">GetEndTime</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> m_currentEvent<span class=\"token operator\">-></span><span class=\"token function\">GetEndTime</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  InterferenceHelper<span class=\"token double-colon punctuation\">::</span>SnrPer snrPer <span class=\"token operator\">=</span> m_interference<span class=\"token punctuation\">.</span><span class=\"token function\">CalculateNonHtPhyHeaderSnrPer</span> <span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">double</span> snr <span class=\"token operator\">=</span> snrPer<span class=\"token punctuation\">.</span>snr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"snr(dB)=\"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token function\">RatioToDb</span> <span class=\"token punctuation\">(</span>snrPer<span class=\"token punctuation\">.</span>snr<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\", per=\"</span> <span class=\"token operator\">&lt;&lt;</span> snrPer<span class=\"token punctuation\">.</span>per<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token function\">NS_LOG_WARN</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"snr(dB)=\"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token function\">RatioToDb</span> <span class=\"token punctuation\">(</span>snrPer<span class=\"token punctuation\">.</span>snr<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\", per=\"</span> <span class=\"token operator\">&lt;&lt;</span> snrPer<span class=\"token punctuation\">.</span>per<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>m_preambleDetectionModel <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>m_preambleDetectionModel<span class=\"token operator\">-></span><span class=\"token function\">IsPreambleDetected</span> <span class=\"token punctuation\">(</span>event<span class=\"token operator\">-></span><span class=\"token function\">GetRxPowerW</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> snr<span class=\"token punctuation\">,</span> m_channelWidth<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token function\">NotifyRxBegin</span> <span class=\"token punctuation\">(</span>event<span class=\"token operator\">-></span><span class=\"token function\">GetPsdu</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      m_timeLastPreambleDetected <span class=\"token operator\">=</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      WifiTxVector txVector <span class=\"token operator\">=</span> event<span class=\"token operator\">-></span><span class=\"token function\">GetTxVector</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>txVector<span class=\"token punctuation\">.</span><span class=\"token function\">GetMode</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetModulationClass</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> WIFI_MOD_CLASS_HT<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>txVector<span class=\"token punctuation\">.</span><span class=\"token function\">GetPreambleType</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> WIFI_PREAMBLE_HT_GF<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          <span class=\"token comment\">//No non-HT PHY header for HT GF</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          Time remainingPreambleHeaderDuration <span class=\"token operator\">=</span> <span class=\"token function\">CalculatePhyPreambleAndHeaderDuration</span> <span class=\"token punctuation\">(</span>txVector<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token function\">GetPreambleDetectionDuration</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          m_state<span class=\"token operator\">-></span><span class=\"token function\">SwitchMaybeToCcaBusy</span> <span class=\"token punctuation\">(</span>remainingPreambleHeaderDuration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          m_endPhyRxEvent <span class=\"token operator\">=</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Schedule</span> <span class=\"token punctuation\">(</span>remainingPreambleHeaderDuration<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>WifiPhy<span class=\"token double-colon punctuation\">::</span>StartReceivePayload<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          <span class=\"token comment\">//Schedule end of non-HT PHY header</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          Time remainingPreambleAndNonHtHeaderDuration <span class=\"token operator\">=</span> <span class=\"token function\">GetPhyPreambleDuration</span> <span class=\"token punctuation\">(</span>txVector<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token function\">GetPhyHeaderDuration</span> <span class=\"token punctuation\">(</span>txVector<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token function\">GetPreambleDetectionDuration</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          m_state<span class=\"token operator\">-></span><span class=\"token function\">SwitchMaybeToCcaBusy</span> <span class=\"token punctuation\">(</span>remainingPreambleAndNonHtHeaderDuration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          m_endPhyRxEvent <span class=\"token operator\">=</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Schedule</span> <span class=\"token punctuation\">(</span>remainingPreambleAndNonHtHeaderDuration<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>WifiPhy<span class=\"token double-colon punctuation\">::</span>ContinueReceiveHeader<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Drop packet because PHY preamble detection failed\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      <span class=\"token function\">NS_LOG_WARN</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Drop packet because PHY preamble detection failed\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      <span class=\"token function\">NotifyRxDrop</span> <span class=\"token punctuation\">(</span>event<span class=\"token operator\">-></span><span class=\"token function\">GetPsdu</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> PREAMBLE_DETECT_FAILURE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      m_interference<span class=\"token punctuation\">.</span><span class=\"token function\">NotifyRxEnd</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      m_currentEvent <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      <span class=\"token comment\">// Like CCA-SD, CCA-ED is governed by the 4μs CCA window to flag CCA-BUSY</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      <span class=\"token comment\">// for any received signal greater than the CCA-ED threshold.</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>event<span class=\"token operator\">-></span><span class=\"token function\">GetEndTime</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> m_state<span class=\"token operator\">-></span><span class=\"token function\">GetDelayUntilIdle</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          <span class=\"token function\">MaybeCcaBusyDuration</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>之后是 <code>WifiPhy::StartReceivePayload</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">WifiPhy</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">StartReceivePayload</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Event<span class=\"token operator\">></span> event<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">*</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>m_endPhyRxEvent<span class=\"token punctuation\">.</span><span class=\"token function\">IsExpired</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>m_endRxEvent<span class=\"token punctuation\">.</span><span class=\"token function\">IsExpired</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  WifiTxVector txVector <span class=\"token operator\">=</span> event<span class=\"token operator\">-></span><span class=\"token function\">GetTxVector</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  WifiMode txMode <span class=\"token operator\">=</span> txVector<span class=\"token punctuation\">.</span><span class=\"token function\">GetMode</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">bool</span> canReceivePayload<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>txMode<span class=\"token punctuation\">.</span><span class=\"token function\">GetModulationClass</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> WIFI_MOD_CLASS_HT<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      InterferenceHelper<span class=\"token double-colon punctuation\">::</span>SnrPer snrPer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      snrPer <span class=\"token operator\">=</span> m_interference<span class=\"token punctuation\">.</span><span class=\"token function\">CalculateHtPhyHeaderSnrPer</span> <span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"snr(dB)=\"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token function\">RatioToDb</span> <span class=\"token punctuation\">(</span>snrPer<span class=\"token punctuation\">.</span>snr<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\", per=\"</span> <span class=\"token operator\">&lt;&lt;</span> snrPer<span class=\"token punctuation\">.</span>per<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      canReceivePayload <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>m_random<span class=\"token operator\">-></span><span class=\"token function\">GetValue</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> snrPer<span class=\"token punctuation\">.</span>per<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token comment\">//If we are here, this means non-HT PHY header was already successfully received</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      canReceivePayload <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  Time payloadDuration <span class=\"token operator\">=</span> event<span class=\"token operator\">-></span><span class=\"token function\">GetEndTime</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> event<span class=\"token operator\">-></span><span class=\"token function\">GetStartTime</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token function\">CalculatePhyPreambleAndHeaderDuration</span> <span class=\"token punctuation\">(</span>txVector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>canReceivePayload<span class=\"token punctuation\">)</span> <span class=\"token comment\">//PHY reception succeeded</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>txVector<span class=\"token punctuation\">.</span><span class=\"token function\">GetNss</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token function\">GetMaxSupportedRxSpatialStreams</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Packet reception could not be started because not enough RX antennas\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          <span class=\"token function\">NotifyRxDrop</span> <span class=\"token punctuation\">(</span>event<span class=\"token operator\">-></span><span class=\"token function\">GetPsdu</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> UNSUPPORTED_SETTINGS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>txVector<span class=\"token punctuation\">.</span><span class=\"token function\">GetChannelWidth</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">40</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>txVector<span class=\"token punctuation\">.</span><span class=\"token function\">GetChannelWidth</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token function\">GetChannelWidth</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Packet reception could not be started because not enough channel width\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          <span class=\"token function\">NotifyRxDrop</span> <span class=\"token punctuation\">(</span>event<span class=\"token operator\">-></span><span class=\"token function\">GetPsdu</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> UNSUPPORTED_SETTINGS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">IsModeSupported</span> <span class=\"token punctuation\">(</span>txMode<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token function\">IsMcsSupported</span> <span class=\"token punctuation\">(</span>txMode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Drop packet because it was sent using an unsupported mode (\"</span> <span class=\"token operator\">&lt;&lt;</span> txMode <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\")\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          <span class=\"token function\">NotifyRxDrop</span> <span class=\"token punctuation\">(</span>event<span class=\"token operator\">-></span><span class=\"token function\">GetPsdu</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> UNSUPPORTED_SETTINGS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          m_statusPerMpdu<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>event<span class=\"token operator\">-></span><span class=\"token function\">GetPsdu</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetNMpdus</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              <span class=\"token function\">ScheduleEndOfMpdus</span> <span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          m_state<span class=\"token operator\">-></span><span class=\"token function\">SwitchToRx</span> <span class=\"token punctuation\">(</span>payloadDuration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          m_endRxEvent <span class=\"token operator\">=</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Schedule</span> <span class=\"token punctuation\">(</span>payloadDuration<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>WifiPhy<span class=\"token double-colon punctuation\">::</span>EndReceive<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Receiving PSDU\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          <span class=\"token function\">m_phyRxPayloadBeginTrace</span> <span class=\"token punctuation\">(</span>txVector<span class=\"token punctuation\">,</span> payloadDuration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//this callback (equivalent to PHY-RXSTART primitive) is triggered only if headers have been correctly decoded and that the mode within is supported</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>txMode<span class=\"token punctuation\">.</span><span class=\"token function\">GetModulationClass</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> WIFI_MOD_CLASS_HE<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>              HePreambleParameters params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>              params<span class=\"token punctuation\">.</span>rssiW <span class=\"token operator\">=</span> event<span class=\"token operator\">-></span><span class=\"token function\">GetRxPowerW</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>              params<span class=\"token punctuation\">.</span>bssColor <span class=\"token operator\">=</span> event<span class=\"token operator\">-></span><span class=\"token function\">GetTxVector</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetBssColor</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>              <span class=\"token function\">NotifyEndOfHePreamble</span> <span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>          <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  <span class=\"token keyword\">else</span> <span class=\"token comment\">//PHY reception failed</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Drop packet because HT PHY header reception failed\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>      <span class=\"token function\">NotifyRxDrop</span> <span class=\"token punctuation\">(</span>event<span class=\"token operator\">-></span><span class=\"token function\">GetPsdu</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> SIG_A_FAILURE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  m_endRxEvent <span class=\"token operator\">=</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Schedule</span> <span class=\"token punctuation\">(</span>payloadDuration<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>WifiPhy<span class=\"token double-colon punctuation\">::</span>ResetReceive<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>然后结束后调用 <code>WifiPhy::EndReceive</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">WifiPhy</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">EndReceive</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Event<span class=\"token operator\">></span> event<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  Time psduDuration <span class=\"token operator\">=</span> event<span class=\"token operator\">-></span><span class=\"token function\">GetEndTime</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> event<span class=\"token operator\">-></span><span class=\"token function\">GetStartTime</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">*</span>event <span class=\"token operator\">&lt;&lt;</span> psduDuration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span><span class=\"token function\">GetLastRxEndTime</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>event<span class=\"token operator\">-></span><span class=\"token function\">GetEndTime</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> WifiPsdu<span class=\"token operator\">></span> psdu <span class=\"token operator\">=</span> event<span class=\"token operator\">-></span><span class=\"token function\">GetPsdu</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token operator\">-></span><span class=\"token function\">GetNMpdus</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token comment\">//We do not enter here for A-MPDU since this is done in WifiPhy::EndOfMpdu</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      std<span class=\"token double-colon punctuation\">::</span>pair<span class=\"token operator\">&lt;</span><span class=\"token keyword\">bool</span><span class=\"token punctuation\">,</span> SignalNoiseDbm<span class=\"token operator\">></span> rxInfo <span class=\"token operator\">=</span> <span class=\"token function\">GetReceptionStatus</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">,</span> <span class=\"token function\">NanoSeconds</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> psduDuration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      m_signalNoise <span class=\"token operator\">=</span> rxInfo<span class=\"token punctuation\">.</span>second<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      m_statusPerMpdu<span class=\"token punctuation\">.</span><span class=\"token function\">push_back</span> <span class=\"token punctuation\">(</span>rxInfo<span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token function\">NotifyRxEnd</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token keyword\">double</span> snr <span class=\"token operator\">=</span> m_interference<span class=\"token punctuation\">.</span><span class=\"token function\">CalculateSnr</span> <span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">count</span> <span class=\"token punctuation\">(</span>m_statusPerMpdu<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> m_statusPerMpdu<span class=\"token punctuation\">.</span><span class=\"token function\">end</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token comment\">//At least one MPDU has been successfully received</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      WifiTxVector txVector <span class=\"token operator\">=</span> event<span class=\"token operator\">-></span><span class=\"token function\">GetTxVector</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token function\">NotifyMonitorSniffRx</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token punctuation\">,</span> <span class=\"token function\">GetFrequency</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> txVector<span class=\"token punctuation\">,</span> m_signalNoise<span class=\"token punctuation\">,</span> m_statusPerMpdu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      m_state<span class=\"token operator\">-></span><span class=\"token function\">SwitchFromRxEndOk</span> <span class=\"token punctuation\">(</span><span class=\"token function\">Copy</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> snr<span class=\"token punctuation\">,</span> txVector<span class=\"token punctuation\">,</span> m_statusPerMpdu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      m_state<span class=\"token operator\">-></span><span class=\"token function\">SwitchFromRxEndError</span> <span class=\"token punctuation\">(</span><span class=\"token function\">Copy</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> snr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  m_interference<span class=\"token punctuation\">.</span><span class=\"token function\">NotifyRxEnd</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  m_currentEvent <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token function\">MaybeCcaBusyDuration</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>std<span class=\"token double-colon punctuation\">::</span>pair<span class=\"token operator\">&lt;</span><span class=\"token keyword\">bool</span><span class=\"token punctuation\">,</span> SignalNoiseDbm<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token class-name\">WifiPhy</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">GetReceptionStatus</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> WifiPsdu<span class=\"token operator\">></span> psdu<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span>Event<span class=\"token operator\">></span> event<span class=\"token punctuation\">,</span> Time relativeMpduStart<span class=\"token punctuation\">,</span> Time mpduDuration<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">*</span>psdu <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">*</span>event <span class=\"token operator\">&lt;&lt;</span> relativeMpduStart <span class=\"token operator\">&lt;&lt;</span> mpduDuration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  InterferenceHelper<span class=\"token double-colon punctuation\">::</span>SnrPer snrPer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  snrPer <span class=\"token operator\">=</span> m_interference<span class=\"token punctuation\">.</span><span class=\"token function\">CalculatePayloadSnrPer</span> <span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">,</span> std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">make_pair</span> <span class=\"token punctuation\">(</span>relativeMpduStart<span class=\"token punctuation\">,</span> relativeMpduStart <span class=\"token operator\">+</span> mpduDuration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"mode=\"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token punctuation\">(</span>event<span class=\"token operator\">-></span><span class=\"token function\">GetTxVector</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetMode</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetDataRate</span> <span class=\"token punctuation\">(</span>event<span class=\"token operator\">-></span><span class=\"token function\">GetTxVector</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                <span class=\"token string\">\", snr(dB)=\"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token function\">RatioToDb</span> <span class=\"token punctuation\">(</span>snrPer<span class=\"token punctuation\">.</span>snr<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\", per=\"</span> <span class=\"token operator\">&lt;&lt;</span> snrPer<span class=\"token punctuation\">.</span>per <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\", size=\"</span> <span class=\"token operator\">&lt;&lt;</span> psdu<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                <span class=\"token string\">\", relativeStart = \"</span> <span class=\"token operator\">&lt;&lt;</span> relativeMpduStart<span class=\"token punctuation\">.</span><span class=\"token function\">GetNanoSeconds</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"ns, duration = \"</span> <span class=\"token operator\">&lt;&lt;</span> mpduDuration<span class=\"token punctuation\">.</span><span class=\"token function\">GetNanoSeconds</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"ns\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  <span class=\"token comment\">// There are two error checks: PER and receive error model check.</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  <span class=\"token comment\">// PER check models is typical for Wi-Fi and is based on signal modulation;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  <span class=\"token comment\">// Receive error model is optional, if we have an error model and</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  <span class=\"token comment\">// it indicates that the packet is corrupt, drop the packet.</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  SignalNoiseDbm signalNoise<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  signalNoise<span class=\"token punctuation\">.</span>signal <span class=\"token operator\">=</span> <span class=\"token function\">WToDbm</span> <span class=\"token punctuation\">(</span>event<span class=\"token operator\">-></span><span class=\"token function\">GetRxPowerW</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  signalNoise<span class=\"token punctuation\">.</span>noise <span class=\"token operator\">=</span> <span class=\"token function\">WToDbm</span> <span class=\"token punctuation\">(</span>event<span class=\"token operator\">-></span><span class=\"token function\">GetRxPowerW</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> snrPer<span class=\"token punctuation\">.</span>snr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_random<span class=\"token operator\">-></span><span class=\"token function\">GetValue</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> snrPer<span class=\"token punctuation\">.</span>per <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>m_postReceptionErrorModel <span class=\"token operator\">&amp;&amp;</span> m_postReceptionErrorModel<span class=\"token operator\">-></span><span class=\"token function\">IsCorrupt</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token operator\">-></span><span class=\"token function\">GetPacket</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">Copy</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Reception succeeded: \"</span> <span class=\"token operator\">&lt;&lt;</span> psdu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>      <span class=\"token keyword\">return</span> std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">make_pair</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> signalNoise<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Reception failed: \"</span> <span class=\"token operator\">&lt;&lt;</span> psdu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>      <span class=\"token keyword\">return</span> std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">make_pair</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> signalNoise<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>之后调用 <code>WifiPhyStateHelper::SwitchFromRxEndOk</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">WifiPhyStateHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SwitchFromRxEndOk</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>WifiPsdu<span class=\"token operator\">></span> psdu<span class=\"token punctuation\">,</span> <span class=\"token keyword\">double</span> snr<span class=\"token punctuation\">,</span> WifiTxVector txVector<span class=\"token punctuation\">,</span> std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span><span class=\"token keyword\">bool</span><span class=\"token operator\">></span> statusPerMpdu<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">*</span>psdu <span class=\"token operator\">&lt;&lt;</span> snr <span class=\"token operator\">&lt;&lt;</span> txVector <span class=\"token operator\">&lt;&lt;</span> statusPerMpdu<span class=\"token punctuation\">.</span><span class=\"token function\">size</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                   std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">all_of</span><span class=\"token punctuation\">(</span>statusPerMpdu<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> statusPerMpdu<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">bool</span> v<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> v<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//returns true if all true</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>statusPerMpdu<span class=\"token punctuation\">.</span><span class=\"token function\">size</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>m_endRx <span class=\"token operator\">==</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token function\">m_rxOkTrace</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token operator\">-></span><span class=\"token function\">GetPacket</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> snr<span class=\"token punctuation\">,</span> txVector<span class=\"token punctuation\">.</span><span class=\"token function\">GetMode</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> txVector<span class=\"token punctuation\">.</span><span class=\"token function\">GetPreambleType</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token function\">NotifyRxEndOk</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token function\">DoSwitchFromRx</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>m_rxOkCallback<span class=\"token punctuation\">.</span><span class=\"token function\">IsNull</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token function\">m_rxOkCallback</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token punctuation\">,</span> snr<span class=\"token punctuation\">,</span> txVector<span class=\"token punctuation\">,</span> statusPerMpdu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>其中， <code>m_rxOkCallback</code>  是个回调函数指针，这个指针的值的设置代码如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">MacLow</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SetPhy</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> Ptr<span class=\"token operator\">&lt;</span>WifiPhy<span class=\"token operator\">></span> phy<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  m_phy <span class=\"token operator\">=</span> phy<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  m_phy<span class=\"token operator\">-></span><span class=\"token function\">TraceConnectWithoutContext</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"PhyRxPayloadBegin\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>MacLow<span class=\"token double-colon punctuation\">::</span>RxStartIndication<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  m_phy<span class=\"token operator\">-></span><span class=\"token function\">SetReceiveOkCallback</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>MacLow<span class=\"token double-colon punctuation\">::</span>DeaggregateAmpduAndReceive<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  m_phy<span class=\"token operator\">-></span><span class=\"token function\">SetReceiveErrorCallback</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>MacLow<span class=\"token double-colon punctuation\">::</span>ReceiveError<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token function\">SetupPhyMacLowListener</span> <span class=\"token punctuation\">(</span>phy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>因此实际调用的回调函数是 <code>MacLow::DeaggregateAmpduAndReceive</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">MacLow</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">DeaggregateAmpduAndReceive</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>WifiPsdu<span class=\"token operator\">></span> psdu<span class=\"token punctuation\">,</span> <span class=\"token keyword\">double</span> rxSnr<span class=\"token punctuation\">,</span> WifiTxVector txVector<span class=\"token punctuation\">,</span> std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span><span class=\"token keyword\">bool</span><span class=\"token operator\">></span> statusPerMpdu<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">bool</span> normalAck <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">bool</span> ampduSubframe <span class=\"token operator\">=</span> txVector<span class=\"token punctuation\">.</span><span class=\"token function\">IsAggregation</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//flag indicating the packet belongs to an A-MPDU and is not a VHT/HE single MPDU</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token comment\">//statusPerMpdu is empty for intermediate MPDU forwarding.</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">//This function is called also once the PPDU has been fully received by the PHY,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token comment\">//in that case statusPerMpdu carries the information about the received MPDUs.</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ampduSubframe <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>statusPerMpdu<span class=\"token punctuation\">.</span><span class=\"token function\">empty</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token comment\">//We are here if a S-MPDU is received or if all MPDUs of an A-MPDU have been</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token comment\">//received (but have been already forwarded up, so ReceiveOk won't be called)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token operator\">-></span><span class=\"token function\">IsAggregate</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      ampduSubframe <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token keyword\">auto</span> n <span class=\"token operator\">=</span> psdu<span class=\"token operator\">-></span><span class=\"token function\">begin</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token keyword\">auto</span> status <span class=\"token operator\">=</span> statusPerMpdu<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token function\">NS_ABORT_MSG_IF</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token operator\">-></span><span class=\"token function\">GetNMpdus</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> statusPerMpdu<span class=\"token punctuation\">.</span><span class=\"token function\">size</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Should have one receive status per MPDU\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      WifiMacHeader firsthdr <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>n<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetHeader</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>firsthdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetAddr1</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> m_self<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          <span class=\"token comment\">//Iterate over all MPDUs and notify reception only if status OK</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span> n <span class=\"token operator\">!=</span> psdu<span class=\"token operator\">-></span><span class=\"token function\">end</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>n<span class=\"token punctuation\">,</span> <span class=\"token operator\">++</span>status<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>              firsthdr <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>n<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetHeader</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              <span class=\"token function\">NS_ABORT_MSG_IF</span> <span class=\"token punctuation\">(</span>firsthdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetAddr1</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> m_self<span class=\"token punctuation\">,</span> <span class=\"token string\">\"All MPDUs of A-MPDU should have the same destination address\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>status<span class=\"token punctuation\">)</span> <span class=\"token comment\">//PER and thus CRC check succeeded</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token operator\">-></span><span class=\"token function\">IsSingle</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                      <span class=\"token comment\">//If the MPDU is sent as a VHT/HE single MPDU (EOF=1 in A-MPDU subframe header), then the responder sends an Ack.</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                      <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Receive S-MPDU\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                      ampduSubframe <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>m_sendAckEvent<span class=\"token punctuation\">.</span><span class=\"token function\">IsRunning</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> firsthdr<span class=\"token punctuation\">.</span><span class=\"token function\">IsQosAck</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// Implicit BAR Ack Policy</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                      m_sendAckEvent <span class=\"token operator\">=</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Schedule</span> <span class=\"token punctuation\">(</span><span class=\"token function\">GetSifs</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                                                            <span class=\"token operator\">&amp;</span>MacLow<span class=\"token double-colon punctuation\">::</span>SendBlockAckAfterAmpdu<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                                                            firsthdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetQosTid</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                                                            firsthdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetAddr2</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                                                            firsthdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetDuration</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                                                            txVector<span class=\"token punctuation\">,</span> rxSnr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>firsthdr<span class=\"token punctuation\">.</span><span class=\"token function\">IsAck</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> firsthdr<span class=\"token punctuation\">.</span><span class=\"token function\">IsBlockAck</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> firsthdr<span class=\"token punctuation\">.</span><span class=\"token function\">IsBlockAckReq</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                      <span class=\"token function\">ReceiveOk</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> rxSnr<span class=\"token punctuation\">,</span> txVector<span class=\"token punctuation\">,</span> ampduSubframe<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>firsthdr<span class=\"token punctuation\">.</span><span class=\"token function\">IsData</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> firsthdr<span class=\"token punctuation\">.</span><span class=\"token function\">IsQosData</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                      <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Deaggregate packet from \"</span> <span class=\"token operator\">&lt;&lt;</span> firsthdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetAddr2</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" with sequence=\"</span> <span class=\"token operator\">&lt;&lt;</span> firsthdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetSequenceNumber</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>psdu<span class=\"token operator\">-></span><span class=\"token function\">IsSingle</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                          <span class=\"token function\">ReceiveOk</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> rxSnr<span class=\"token punctuation\">,</span> txVector<span class=\"token punctuation\">,</span> ampduSubframe<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>firsthdr<span class=\"token punctuation\">.</span><span class=\"token function\">IsQosAck</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                          <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Normal Ack\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                          normalAck <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>                    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>                      <span class=\"token function\">NS_FATAL_ERROR</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Received A-MPDU with invalid first MPDU type\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>                  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>psdu<span class=\"token operator\">-></span><span class=\"token function\">IsSingle</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>                    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>                      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>normalAck<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>                        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>                          <span class=\"token comment\">//send BlockAck</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>                          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>firsthdr<span class=\"token punctuation\">.</span><span class=\"token function\">IsBlockAckReq</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>                            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>                              <span class=\"token function\">NS_FATAL_ERROR</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Sending a BlockAckReq with QosPolicy equal to Normal Ack\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>                            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>                          <span class=\"token keyword\">uint8_t</span> tid <span class=\"token operator\">=</span> firsthdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetQosTid</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>                          AgreementsI it <span class=\"token operator\">=</span> m_bAckAgreements<span class=\"token punctuation\">.</span><span class=\"token function\">find</span> <span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">make_pair</span> <span class=\"token punctuation\">(</span>firsthdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetAddr2</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> tid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>                          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>it <span class=\"token operator\">!=</span> m_bAckAgreements<span class=\"token punctuation\">.</span><span class=\"token function\">end</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>                            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>                              <span class=\"token comment\">/* See section 11.5.3 in IEEE 802.11 for the definition of this timer */</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>                              <span class=\"token function\">ResetBlockAckInactivityTimerIfNeeded</span> <span class=\"token punctuation\">(</span>it<span class=\"token operator\">-></span>second<span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>                              <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"rx A-MPDU/sendImmediateBlockAck from=\"</span> <span class=\"token operator\">&lt;&lt;</span> firsthdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetAddr2</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>                              <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>m_sendAckEvent<span class=\"token punctuation\">.</span><span class=\"token function\">IsRunning</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>                            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>                          <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>                            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>                              <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"There's not a valid agreement for this block ack request.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>                            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>      <span class=\"token comment\">/* An MPDU has been received */</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>      <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>psdu<span class=\"token operator\">-></span><span class=\"token function\">IsAggregate</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>      <span class=\"token function\">ReceiveOk</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>psdu<span class=\"token operator\">-></span><span class=\"token function\">begin</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> rxSnr<span class=\"token punctuation\">,</span> txVector<span class=\"token punctuation\">,</span> ampduSubframe<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>ReceiveOk </code> 方法都会进入 <code>rxPacket</code>  标记位置，</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">MacLow</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ReceiveOk</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>WifiMacQueueItem<span class=\"token operator\">></span> mpdu<span class=\"token punctuation\">,</span> <span class=\"token keyword\">double</span> rxSnr<span class=\"token punctuation\">,</span> WifiTxVector txVector<span class=\"token punctuation\">,</span> <span class=\"token keyword\">bool</span> ampduSubframe<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">*</span>mpdu <span class=\"token operator\">&lt;&lt;</span> rxSnr <span class=\"token operator\">&lt;&lt;</span> txVector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token function\">m_rxCallback</span> <span class=\"token punctuation\">(</span>mpdu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>继续运行代码。 <code>m_rxCallback</code>  也是一个函数指针。该值的设置位置是在 <code>RegularWifiMac的构造函数里</code> ，代码：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>m_low<span class=\"token operator\">-></span><span class=\"token function\">SetRxCallback</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>MacRxMiddle<span class=\"token double-colon punctuation\">::</span>Receive<span class=\"token punctuation\">,</span> m_rxMiddle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>所以实际调用的是 <code>MacRxMiddle::Receive</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">MacRxMiddle</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Receive</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>WifiMacQueueItem<span class=\"token operator\">></span> mpdu<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>mpdu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">const</span> WifiMacHeader<span class=\"token operator\">*</span> hdr <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>mpdu<span class=\"token operator\">-></span><span class=\"token function\">GetHeader</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> packet <span class=\"token operator\">=</span> mpdu<span class=\"token operator\">-></span><span class=\"token function\">GetPacket</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">Copy</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>hdr<span class=\"token operator\">-></span><span class=\"token function\">IsData</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> hdr<span class=\"token operator\">-></span><span class=\"token function\">IsMgt</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>m_pcfCallback<span class=\"token punctuation\">.</span><span class=\"token function\">IsNull</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token function\">m_pcfCallback</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  OriginatorRxStatus <span class=\"token operator\">*</span>originator <span class=\"token operator\">=</span> <span class=\"token function\">Lookup</span> <span class=\"token punctuation\">(</span>hdr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   * The check below is really unneeded because it can fail in a lot of</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   * normal cases. Specifically, it is possible for sequence numbers to</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   * loop back to zero once they reach 0xfff0 and to go up to 0xf7f0 in</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   * which case the check below will report the two sequence numbers to</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   * not have the correct order relationship.</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   * So, this check cannot be used to discard old duplicate frames. It is</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   * thus here only for documentation purposes.</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   */</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token function\">SequenceNumber16</span> <span class=\"token punctuation\">(</span>originator<span class=\"token operator\">-></span><span class=\"token function\">GetLastSequenceControl</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token function\">SequenceNumber16</span> <span class=\"token punctuation\">(</span>hdr<span class=\"token operator\">-></span><span class=\"token function\">GetSequenceControl</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Sequence numbers have looped back. last recorded=\"</span> <span class=\"token operator\">&lt;&lt;</span> originator<span class=\"token operator\">-></span><span class=\"token function\">GetLastSequenceControl</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                    <span class=\"token string\">\" currently seen=\"</span> <span class=\"token operator\">&lt;&lt;</span> hdr<span class=\"token operator\">-></span><span class=\"token function\">GetSequenceControl</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token comment\">//filter duplicates.</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">IsDuplicate</span> <span class=\"token punctuation\">(</span>hdr<span class=\"token punctuation\">,</span> originator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"duplicate from=\"</span> <span class=\"token operator\">&lt;&lt;</span> hdr<span class=\"token operator\">-></span><span class=\"token function\">GetAddr2</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                    <span class=\"token string\">\", seq=\"</span> <span class=\"token operator\">&lt;&lt;</span> hdr<span class=\"token operator\">-></span><span class=\"token function\">GetSequenceNumber</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                    <span class=\"token string\">\", frag=\"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">+</span>hdr<span class=\"token operator\">-></span><span class=\"token function\">GetFragmentNumber</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> aggregate <span class=\"token operator\">=</span> <span class=\"token function\">HandleFragments</span> <span class=\"token punctuation\">(</span>packet<span class=\"token punctuation\">,</span> hdr<span class=\"token punctuation\">,</span> originator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>aggregate <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"forwarding data from=\"</span> <span class=\"token operator\">&lt;&lt;</span> hdr<span class=\"token operator\">-></span><span class=\"token function\">GetAddr2</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                <span class=\"token string\">\", seq=\"</span> <span class=\"token operator\">&lt;&lt;</span> hdr<span class=\"token operator\">-></span><span class=\"token function\">GetSequenceNumber</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                <span class=\"token string\">\", frag=\"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">+</span>hdr<span class=\"token operator\">-></span><span class=\"token function\">GetFragmentNumber</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>hdr<span class=\"token operator\">-></span><span class=\"token function\">GetAddr1</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">IsGroup</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      originator<span class=\"token operator\">-></span><span class=\"token function\">SetSequenceControl</span> <span class=\"token punctuation\">(</span>hdr<span class=\"token operator\">-></span><span class=\"token function\">GetSequenceControl</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>aggregate <span class=\"token operator\">==</span> packet<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>      <span class=\"token function\">m_callback</span> <span class=\"token punctuation\">(</span>mpdu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>      <span class=\"token comment\">// We could do this in all cases, but passing the received mpdu in case of</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      <span class=\"token comment\">// A-MSDUs saves us the time to deaggregate the A-MSDU in MSDUs (which are</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>      <span class=\"token comment\">// kept separate in the received mpdu) and allows us to pass the originally</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      <span class=\"token comment\">// transmitted packets (i.e., with the same UID) to the receiver.</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      <span class=\"token function\">m_callback</span> <span class=\"token punctuation\">(</span><span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>WifiMacQueueItem<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span>aggregate<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>hdr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这也有一个 <code>m_callback</code> ，其设置位置 <code>RegularWifiMac的构造函数</code> ，代码为</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>m_rxMiddle<span class=\"token operator\">-></span><span class=\"token function\">SetForwardCallback</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>RegularWifiMac<span class=\"token double-colon punctuation\">::</span>Receive<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>所以实际的调用是 <code>RegularWifiMac::Receive</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">RegularWifiMac</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Receive</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>WifiMacQueueItem<span class=\"token operator\">></span> mpdu<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">*</span>mpdu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">const</span> WifiMacHeader<span class=\"token operator\">*</span> hdr <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>mpdu<span class=\"token operator\">-></span><span class=\"token function\">GetHeader</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> packet <span class=\"token operator\">=</span> mpdu<span class=\"token operator\">-></span><span class=\"token function\">GetPacket</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">Copy</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  Mac48Address to <span class=\"token operator\">=</span> hdr<span class=\"token operator\">-></span><span class=\"token function\">GetAddr1</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  Mac48Address from <span class=\"token operator\">=</span> hdr<span class=\"token operator\">-></span><span class=\"token function\">GetAddr2</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\">//We don't know how to deal with any frame that is not addressed to</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token comment\">//us (and odds are there is nothing sensible we could do anyway),</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token comment\">//so we ignore such frames.</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token comment\">//The derived class may also do some such filtering, but it doesn't</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token comment\">//hurt to have it here too as a backstop.</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>to <span class=\"token operator\">!=</span> <span class=\"token function\">GetAddress</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hdr<span class=\"token operator\">-></span><span class=\"token function\">IsMgt</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> hdr<span class=\"token operator\">-></span><span class=\"token function\">IsAction</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token comment\">//There is currently only any reason for Management Action</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token comment\">//frames to be flying about if we are a QoS STA.</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>m_qosSupported<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      WifiActionHeader actionHdr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      packet<span class=\"token operator\">-></span><span class=\"token function\">RemoveHeader</span> <span class=\"token punctuation\">(</span>actionHdr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>actionHdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetCategory</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token keyword\">case</span> WifiActionHeader<span class=\"token double-colon punctuation\">::</span>BLOCK_ACK<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>actionHdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetAction</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>blockAck<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            <span class=\"token keyword\">case</span> WifiActionHeader<span class=\"token double-colon punctuation\">::</span>BLOCK_ACK_ADDBA_REQUEST<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>              <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                MgtAddBaRequestHeader reqHdr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                packet<span class=\"token operator\">-></span><span class=\"token function\">RemoveHeader</span> <span class=\"token punctuation\">(</span>reqHdr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                <span class=\"token comment\">//We've received an ADDBA Request. Our policy here is</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                <span class=\"token comment\">//to automatically accept it, so we get the ADDBA</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                <span class=\"token comment\">//Response on it's way immediately.</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                <span class=\"token function\">SendAddBaResponse</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>reqHdr<span class=\"token punctuation\">,</span> from<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                <span class=\"token comment\">//This frame is now completely dealt with, so we're done.</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            <span class=\"token keyword\">case</span> WifiActionHeader<span class=\"token double-colon punctuation\">::</span>BLOCK_ACK_ADDBA_RESPONSE<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>              <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                MgtAddBaResponseHeader respHdr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                packet<span class=\"token operator\">-></span><span class=\"token function\">RemoveHeader</span> <span class=\"token punctuation\">(</span>respHdr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                <span class=\"token comment\">//We've received an ADDBA Response. We assume that it</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                <span class=\"token comment\">//indicates success after an ADDBA Request we have</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                <span class=\"token comment\">//sent (we could, in principle, check this, but it</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                <span class=\"token comment\">//seems a waste given the level of the current model)</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                <span class=\"token comment\">//and act by locally establishing the agreement on</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                <span class=\"token comment\">//the appropriate queue.</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                AcIndex ac <span class=\"token operator\">=</span> <span class=\"token function\">QosUtilsMapTidToAc</span> <span class=\"token punctuation\">(</span>respHdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetTid</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                m_edca<span class=\"token punctuation\">[</span>ac<span class=\"token punctuation\">]</span><span class=\"token operator\">-></span><span class=\"token function\">GotAddBaResponse</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>respHdr<span class=\"token punctuation\">,</span> from<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                <span class=\"token comment\">//This frame is now completely dealt with, so we're done.</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>            <span class=\"token keyword\">case</span> WifiActionHeader<span class=\"token double-colon punctuation\">::</span>BLOCK_ACK_DELBA<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>              <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>                MgtDelBaHeader delBaHdr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>                packet<span class=\"token operator\">-></span><span class=\"token function\">RemoveHeader</span> <span class=\"token punctuation\">(</span>delBaHdr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>delBaHdr<span class=\"token punctuation\">.</span><span class=\"token function\">IsByOriginator</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>                  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>                    <span class=\"token comment\">//This DELBA frame was sent by the originator, so</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>                    <span class=\"token comment\">//this means that an ingoing established</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>                    <span class=\"token comment\">//agreement exists in MacLow and we need to</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>                    <span class=\"token comment\">//destroy it.</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>                    m_low<span class=\"token operator\">-></span><span class=\"token function\">DestroyBlockAckAgreement</span> <span class=\"token punctuation\">(</span>from<span class=\"token punctuation\">,</span> delBaHdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetTid</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>                  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>                <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>                  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>                    <span class=\"token comment\">//We must have been the originator. We need to</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>                    <span class=\"token comment\">//tell the correct queue that the agreement has</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>                    <span class=\"token comment\">//been torn down</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>                    AcIndex ac <span class=\"token operator\">=</span> <span class=\"token function\">QosUtilsMapTidToAc</span> <span class=\"token punctuation\">(</span>delBaHdr<span class=\"token punctuation\">.</span><span class=\"token function\">GetTid</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>                    m_edca<span class=\"token punctuation\">[</span>ac<span class=\"token punctuation\">]</span><span class=\"token operator\">-></span><span class=\"token function\">GotDelBaFrame</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>delBaHdr<span class=\"token punctuation\">,</span> from<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>                  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>                <span class=\"token comment\">//This frame is now completely dealt with, so we're done.</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>                <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>            <span class=\"token keyword\">default</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>              <span class=\"token function\">NS_FATAL_ERROR</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Unsupported Action field in Block Ack Action frame\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>              <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        <span class=\"token keyword\">default</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>          <span class=\"token function\">NS_FATAL_ERROR</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Unsupported Action frame received\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>          <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>  <span class=\"token function\">NS_FATAL_ERROR</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Don't know how to handle frame (type=\"</span> <span class=\"token operator\">&lt;&lt;</span> hdr<span class=\"token operator\">-></span><span class=\"token function\">GetType</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>目前没有找到任何可行的调用方式，回看其继承关系</p>\n<p><img data-src=\"https://yeyu-blog.oss-cn-beijing.aliyuncs.com/article_images/wifiMac%E7%9A%84%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB.jpg\" alt=\"继承关系\" />)</p>\n<p>我们观察到，该类下面有很多子类，大胆推测其转发是由子类各自实现的，</p>\n<p>所以我们观察 <code>AdhocWifiMac::Receive</code> ，</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">AdhocWifiMac</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Receive</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>WifiMacQueueItem<span class=\"token operator\">></span> mpdu<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">*</span>mpdu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">const</span> WifiMacHeader<span class=\"token operator\">*</span> hdr <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>mpdu<span class=\"token operator\">-></span><span class=\"token function\">GetHeader</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>hdr<span class=\"token operator\">-></span><span class=\"token function\">IsCtl</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  Mac48Address from <span class=\"token operator\">=</span> hdr<span class=\"token operator\">-></span><span class=\"token function\">GetAddr2</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  Mac48Address to <span class=\"token operator\">=</span> hdr<span class=\"token operator\">-></span><span class=\"token function\">GetAddr1</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_stationManager<span class=\"token operator\">-></span><span class=\"token function\">IsBrandNew</span> <span class=\"token punctuation\">(</span>from<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token comment\">//In ad hoc mode, we assume that every destination supports all the rates we support.</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">GetHtSupported</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>          m_stationManager<span class=\"token operator\">-></span><span class=\"token function\">AddAllSupportedMcs</span> <span class=\"token punctuation\">(</span>from<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          m_stationManager<span class=\"token operator\">-></span><span class=\"token function\">AddStationHtCapabilities</span> <span class=\"token punctuation\">(</span>from<span class=\"token punctuation\">,</span> <span class=\"token function\">GetHtCapabilities</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">GetVhtSupported</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          m_stationManager<span class=\"token operator\">-></span><span class=\"token function\">AddStationVhtCapabilities</span> <span class=\"token punctuation\">(</span>from<span class=\"token punctuation\">,</span> <span class=\"token function\">GetVhtCapabilities</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">GetHeSupported</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          m_stationManager<span class=\"token operator\">-></span><span class=\"token function\">AddStationHeCapabilities</span> <span class=\"token punctuation\">(</span>from<span class=\"token punctuation\">,</span> <span class=\"token function\">GetHeCapabilities</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      m_stationManager<span class=\"token operator\">-></span><span class=\"token function\">AddAllSupportedModes</span> <span class=\"token punctuation\">(</span>from<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      m_stationManager<span class=\"token operator\">-></span><span class=\"token function\">RecordDisassociated</span> <span class=\"token punctuation\">(</span>from<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hdr<span class=\"token operator\">-></span><span class=\"token function\">IsData</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hdr<span class=\"token operator\">-></span><span class=\"token function\">IsQosData</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> hdr<span class=\"token operator\">-></span><span class=\"token function\">IsQosAmsdu</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Received A-MSDU from\"</span> <span class=\"token operator\">&lt;&lt;</span> from<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          <span class=\"token function\">DeaggregateAmsduAndForward</span> <span class=\"token punctuation\">(</span>mpdu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          <span class=\"token function\">ForwardUp</span> <span class=\"token punctuation\">(</span>mpdu<span class=\"token operator\">-></span><span class=\"token function\">GetPacket</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">Copy</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> from<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token comment\">//Invoke the receive handler of our parent class to deal with any</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token comment\">//other frames. Specifically, this will handle Block Ack-related</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token comment\">//Management Action frames.</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  <span class=\"token class-name\">RegularWifiMac</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Receive</span> <span class=\"token punctuation\">(</span>mpdu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>不出意料，发现了下一个突破口， <code>ForwardUp</code> ，并且子类调用父类的 <code>Receive</code>  方法证明了猜测是正确的。</p>\n<p>由于子类不含该方法，所以该方法是在父类 <code>RegularWifiMac:::ForwardUp</code>  中实现</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">RegularWifiMac</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ForwardUp</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span> Mac48Address from<span class=\"token punctuation\">,</span> Mac48Address to<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> packet <span class=\"token operator\">&lt;&lt;</span> from <span class=\"token operator\">&lt;&lt;</span> to<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token function\">m_forwardUp</span> <span class=\"token punctuation\">(</span>packet<span class=\"token punctuation\">,</span> from<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span>       <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token function\">NS_FATAL_ERROR</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Don't know how to handle frame (type=\"</span> <span class=\"token operator\">&lt;&lt;</span> hdr<span class=\"token operator\">-></span><span class=\"token function\">GetType</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>很简单的方法， <code>RegularWifiMac::ForwardUp</code>  方法会继续向上层传递接收到的 packet，下面就是跟踪 <code>m_forwardUp</code>  的赋值</p>\n<p>其赋值位置在 <code>WifiNetDevice::CompleteConfig</code>  里面</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>m_mac<span class=\"token operator\">-></span><span class=\"token function\">SetForwardUpCallback</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>WifiNetDevice<span class=\"token double-colon punctuation\">::</span>ForwardUp<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>所以最终调用的是 <code>WifiNetDevice::ForwardUp</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">WifiNetDevice</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ForwardUp</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span> Mac48Address from<span class=\"token punctuation\">,</span> Mac48Address to<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> packet <span class=\"token operator\">&lt;&lt;</span> from <span class=\"token operator\">&lt;&lt;</span> to<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  LlcSnapHeader llc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  NetDevice<span class=\"token double-colon punctuation\">::</span>PacketType type<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">IsBroadcast</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      type <span class=\"token operator\">=</span> NetDevice<span class=\"token double-colon punctuation\">::</span>PACKET_BROADCAST<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">IsGroup</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      type <span class=\"token operator\">=</span> NetDevice<span class=\"token double-colon punctuation\">::</span>PACKET_MULTICAST<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>to <span class=\"token operator\">==</span> m_mac<span class=\"token operator\">-></span><span class=\"token function\">GetAddress</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      type <span class=\"token operator\">=</span> NetDevice<span class=\"token double-colon punctuation\">::</span>PACKET_HOST<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      type <span class=\"token operator\">=</span> NetDevice<span class=\"token double-colon punctuation\">::</span>PACKET_OTHERHOST<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>Packet<span class=\"token operator\">></span> copy <span class=\"token operator\">=</span> packet<span class=\"token operator\">-></span><span class=\"token function\">Copy</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>type <span class=\"token operator\">!=</span> NetDevice<span class=\"token double-colon punctuation\">::</span>PACKET_OTHERHOST<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      m_mac<span class=\"token operator\">-></span><span class=\"token function\">NotifyRx</span> <span class=\"token punctuation\">(</span>packet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      copy<span class=\"token operator\">-></span><span class=\"token function\">RemoveHeader</span> <span class=\"token punctuation\">(</span>llc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token function\">m_forwardUp</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> copy<span class=\"token punctuation\">,</span> llc<span class=\"token punctuation\">.</span><span class=\"token function\">GetType</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> from<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      copy<span class=\"token operator\">-></span><span class=\"token function\">RemoveHeader</span> <span class=\"token punctuation\">(</span>llc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>m_promiscRx<span class=\"token punctuation\">.</span><span class=\"token function\">IsNull</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      m_mac<span class=\"token operator\">-></span><span class=\"token function\">NotifyPromiscRx</span> <span class=\"token punctuation\">(</span>copy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      <span class=\"token function\">m_promiscRx</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> copy<span class=\"token punctuation\">,</span> llc<span class=\"token punctuation\">.</span><span class=\"token function\">GetType</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> from<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">,</span> type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"完整流程图\"><a class=\"anchor\" href=\"#完整流程图\">#</a> 完整流程图</h4>\n<p><img data-src=\"https://yeyu-blog.oss-cn-beijing.aliyuncs.com/article_images/ns3.32%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg\" alt=\"ns3.32wifi模块流程图\" /></p>\n",
            "tags": [
                "ns3",
                "ns3"
            ]
        },
        {
            "id": "http://jluyeyu.com/ns3/10.ns3%20%E8%B7%AF%E7%94%B1%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%AE%9E%E4%BE%8B/",
            "url": "http://jluyeyu.com/ns3/10.ns3%20%E8%B7%AF%E7%94%B1%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%AE%9E%E4%BE%8B/",
            "title": "10.ns3 路由性能测试实例",
            "date_published": "2022-11-02T06:00:00.000Z",
            "content_html": "<h2 id=\"10ns3-路由性能测试实例md\"><a class=\"anchor\" href=\"#10ns3-路由性能测试实例md\">#</a> 10.ns3 <span class=\"exturl\" data-url=\"aHR0cDovL3huLS1mc3EyNzBhcnNkcTZxMmpqMHlyaTJyMzBkLm1k\">路由性能测试实例.md</span></h2>\n<p>在本节中，将介绍 <code>ns3</code>  中路由仿真，从路由选择到绘图出结果的一系列流程。</p>\n<p>PS：只是本人实验的一系列步骤，不一定是最优做法，但也是一套完整的流程吧，有更好的流程可以互相交流。</p>\n<h3 id=\"路由性能好坏的评判标准\"><a class=\"anchor\" href=\"#路由性能好坏的评判标准\">#</a> 路由性能好坏的评判标准</h3>\n<p>通常来说描述一个路由，我们会从 <code>吞吐量，时延，能耗，丢包率，交付率，平均路径长度</code> 等因素来描述路由的好坏。</p>\n<p><code>吞吐量</code> 指的是在单位时间内通过某个网络的实际的数据量。是对实际网络到底有多少数据率在信道上传输。</p>\n<p><code>时延</code> 指的是数据从信源发送到信宿所需的时间。</p>\n<p><code>交付率</code> 指的是发送过程中信宿实际接收的数据包 / 总共发送的数据包。</p>\n<p><code>丢包率</code> 是 1 - 交付率</p>\n<p><code>能耗</code> 指的是一段时间内消耗的能量</p>\n<p><code>路径长度</code> 指的是路由的跳数</p>\n<h3 id=\"仿真模拟\"><a class=\"anchor\" href=\"#仿真模拟\">#</a> 仿真模拟</h3>\n<p>为了获取节点收发包的情况，我们需要跟踪设备收发包的情况，这就需要用到 <code>Config</code>  来进行跟踪，</p>\n<p>对于 <code>onOffHelper</code>  和 <code>PacketSink</code>  做收发端的情况下，我们可以采用 <code>/NodeList/*/ApplicationList/*/$ns3::PacketSink/Rx</code>  作为 <code>tracking</code>  的地址。</p>\n<p>即通过如下方法来绑定 <code>ReceivePacket</code>  作为回调函数</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ConnectWithoutContext</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/NodeList/*/ApplicationList/*/$ns3::PacketSink/Rx\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">MakeCallback</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>OrrpExample<span class=\"token double-colon punctuation\">::</span>ReceivePacket<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>而在 <code>ReceivePacket</code>  中，我们又可以通过</p>\n<p>类似如下的方法收集已接收的 <code>packet</code>  信息</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">OrrpExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ReceivePacket</span><span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> Address <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> tmp<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token function\">Seconds</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        tmpTotal <span class=\"token operator\">+=</span> packet<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> tmp<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token function\">Seconds</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> tmp<span class=\"token punctuation\">.</span><span class=\"token function\">GetSeconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"S throughoutput = \"</span> <span class=\"token operator\">&lt;&lt;</span> tmpTotal <span class=\"token operator\">*</span> <span class=\"token number\">8</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1e6</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Mbit\"</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            std<span class=\"token double-colon punctuation\">::</span>ostringstream ostrStream<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            ostrStream <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"./result/\"</span> <span class=\"token operator\">&lt;&lt;</span> m_protocolName <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Test/\"</span> <span class=\"token operator\">&lt;&lt;</span> m_protocolName <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Test-size-\"</span> <span class=\"token operator\">&lt;&lt;</span> size <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-seed-\"</span> <span class=\"token operator\">&lt;&lt;</span> seed <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-nodesLocationType-\"</span> <span class=\"token operator\">&lt;&lt;</span> nodesLocationType <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-nodesMove-\"</span> <span class=\"token operator\">&lt;&lt;</span> nodesMove <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-width-\"</span> <span class=\"token operator\">&lt;&lt;</span> width <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-step-\"</span> <span class=\"token operator\">&lt;&lt;</span> step <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-log\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            std<span class=\"token double-colon punctuation\">::</span>ofstream <span class=\"token function\">file</span><span class=\"token punctuation\">(</span>ostrStream<span class=\"token punctuation\">.</span><span class=\"token function\">str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> std<span class=\"token double-colon punctuation\">::</span>ios<span class=\"token double-colon punctuation\">::</span>app <span class=\"token operator\">|</span> std<span class=\"token double-colon punctuation\">::</span>ios<span class=\"token double-colon punctuation\">::</span>out<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            file <span class=\"token operator\">&lt;&lt;</span> tmp<span class=\"token punctuation\">.</span><span class=\"token function\">GetSeconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" \"</span> <span class=\"token operator\">&lt;&lt;</span> sendSeq<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> packet<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">8</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1e6</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" \"</span> <span class=\"token operator\">&lt;&lt;</span> bytesTotal <span class=\"token operator\">*</span> <span class=\"token number\">8</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1e6</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" \"</span> <span class=\"token operator\">&lt;&lt;</span> tmpTotal <span class=\"token operator\">*</span> <span class=\"token number\">8</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1e6</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            file<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            tmp <span class=\"token operator\">+=</span> <span class=\"token function\">Seconds</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            tmpTotal <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        tmpTotal <span class=\"token operator\">+=</span> packet<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span><span class=\"token keyword\">uint32_t</span><span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span>iterator iter<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    iter <span class=\"token operator\">=</span> <span class=\"token function\">find</span><span class=\"token punctuation\">(</span>sendSeq<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> sendSeq<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> packet<span class=\"token operator\">-></span><span class=\"token function\">GetUid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">int</span> index <span class=\"token operator\">=</span> iter <span class=\"token operator\">-</span> sendSeq<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    bytesTotal <span class=\"token operator\">+=</span> packet<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    packetsReceived <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    m_delayEstimation<span class=\"token punctuation\">.</span><span class=\"token function\">RecordRx</span><span class=\"token punctuation\">(</span>packet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    m_delay <span class=\"token operator\">+=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> sendTime<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetSeconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    m_jitter <span class=\"token operator\">+=</span> m_delayEstimation<span class=\"token punctuation\">.</span><span class=\"token function\">GetLastJitter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>first_pkt<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        m_firstRx <span class=\"token operator\">=</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        first_pkt <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    m_lastRx <span class=\"token operator\">=</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>并在仿真的最后，调用自定义的 <code>ReportStatistics</code>  进行最后的分析，并存储结果到本地文件</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token operator\">*</span>argv<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    OrrpExample test<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>test<span class=\"token punctuation\">.</span><span class=\"token function\">Configure</span><span class=\"token punctuation\">(</span>argc<span class=\"token punctuation\">,</span> argv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token function\">NS_FATAL_ERROR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Configuration failed. Aborted.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    test<span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    test<span class=\"token punctuation\">.</span><span class=\"token function\">ReportStatistics</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    test<span class=\"token punctuation\">.</span><span class=\"token function\">Report</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>cout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">OrrpExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ReportStatistics</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">double</span> Dt <span class=\"token operator\">=</span> m_lastRx<span class=\"token punctuation\">.</span><span class=\"token function\">GetSeconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> m_firstRx<span class=\"token punctuation\">.</span><span class=\"token function\">GetSeconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">double</span> kbs <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>bytesTotal <span class=\"token operator\">*</span> <span class=\"token number\">8.0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>Dt <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    bytesTotal <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>ofstream <span class=\"token function\">out</span><span class=\"token punctuation\">(</span>m_CSVfileName<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> std<span class=\"token double-colon punctuation\">::</span>ios<span class=\"token double-colon punctuation\">::</span>app<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">int</span> m_nSinks <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    out <span class=\"token operator\">&lt;&lt;</span> kbs <span class=\"token operator\">/</span> m_nSinks <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\",\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token operator\">&lt;&lt;</span> packetsReceived <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\",\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token operator\">&lt;&lt;</span> packetsTx <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\",\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token operator\">&lt;&lt;</span> packetsReceived <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span><span class=\"token punctuation\">)</span>packetsTx <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\",\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token operator\">&lt;&lt;</span> m_delay <span class=\"token operator\">/</span> packetsReceived <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\",\"</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token operator\">&lt;&lt;</span> m_jitter <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>packetsReceived <span class=\"token operator\">*</span> <span class=\"token number\">1000000000.0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\",\"</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token comment\">//   &lt;&lt; routingPkts &lt;&lt; \",\"</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token comment\">//    &lt;&lt; m_nSinks &lt;&lt; \",\"</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token comment\">//    &lt;&lt; m_nWifis &lt;&lt; \",\"</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token comment\">//    &lt;&lt; m_protocolName &lt;&lt; \",\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token comment\">//   &lt;&lt; m_txrange &lt;&lt; \"\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"吞吐量 \"</span> <span class=\"token operator\">&lt;&lt;</span> kbs <span class=\"token operator\">/</span> m_nSinks <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" kbps ,\"</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>              <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"收包数\"</span> <span class=\"token operator\">&lt;&lt;</span> packetsReceived <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\",\"</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>              <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"发包数\"</span> <span class=\"token operator\">&lt;&lt;</span> packetsTx <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\",\"</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>              <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"交付率\"</span> <span class=\"token operator\">&lt;&lt;</span> packetsReceived <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span><span class=\"token punctuation\">)</span>packetsTx <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\",\"</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>              <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"时延\"</span> <span class=\"token operator\">&lt;&lt;</span> m_delay <span class=\"token operator\">/</span> packetsReceived <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\",\"</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>              <span class=\"token operator\">&lt;&lt;</span> m_jitter <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>packetsReceived <span class=\"token operator\">*</span> <span class=\"token number\">1000000000.0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\",\"</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>              <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>ostringstream ostrStream<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    ostrStream <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"./result/\"</span> <span class=\"token operator\">&lt;&lt;</span> m_protocolName <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Test/\"</span> <span class=\"token operator\">&lt;&lt;</span> m_protocolName <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Test-size-\"</span> <span class=\"token operator\">&lt;&lt;</span> size <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-seed-\"</span> <span class=\"token operator\">&lt;&lt;</span> seed <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-nodesLocationType-\"</span> <span class=\"token operator\">&lt;&lt;</span> nodesLocationType <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-nodesMove-\"</span> <span class=\"token operator\">&lt;&lt;</span> nodesMove <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-width-\"</span> <span class=\"token operator\">&lt;&lt;</span> width <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-step-\"</span> <span class=\"token operator\">&lt;&lt;</span> step <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-delay-log\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>ofstream <span class=\"token function\">file</span><span class=\"token punctuation\">(</span>ostrStream<span class=\"token punctuation\">.</span><span class=\"token function\">str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> std<span class=\"token double-colon punctuation\">::</span>ios<span class=\"token double-colon punctuation\">::</span>app <span class=\"token operator\">|</span> std<span class=\"token double-colon punctuation\">::</span>ios<span class=\"token double-colon punctuation\">::</span>out<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    file <span class=\"token operator\">&lt;&lt;</span> packetsReceived <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span><span class=\"token punctuation\">)</span>packetsTx <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" \"</span> <span class=\"token operator\">&lt;&lt;</span> m_delay <span class=\"token operator\">/</span> packetsReceived <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" \"</span> <span class=\"token operator\">&lt;&lt;</span> kbs <span class=\"token operator\">/</span> m_nSinks <span class=\"token operator\">/</span> <span class=\"token number\">1e3</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    file<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    out<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    packetsReceived <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    packetsTx <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    m_delay <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    m_jitter <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    <span class=\"token comment\">// routingPkts = 0;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>同理我们也可以计算点到点实时的吞吐量</p>\n<p>通过添加 <code>Simulator::Schedule (Seconds (6.0), &amp;OrrpExample::CalculateThroughput,this,endTime);</code>  来调用 <code>CalculateThroughput</code>  来计算实时的吞吐量</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">OrrpExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">CalculateThroughput</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> endTime<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>ostringstream ostrStream<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    ostrStream <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"./result/orrpTest/orrpTest-size-\"</span> <span class=\"token operator\">&lt;&lt;</span> size <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-seed-\"</span> <span class=\"token operator\">&lt;&lt;</span> seed <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-nodesLocationType-\"</span> <span class=\"token operator\">&lt;&lt;</span> nodesLocationType <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-nodesMove-\"</span> <span class=\"token operator\">&lt;&lt;</span> nodesMove <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-width-\"</span> <span class=\"token operator\">&lt;&lt;</span> width <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-step-\"</span> <span class=\"token operator\">&lt;&lt;</span> step <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-log\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>ofstream file<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    file<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span>ostrStream<span class=\"token punctuation\">.</span><span class=\"token function\">str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> std<span class=\"token double-colon punctuation\">::</span>ios_base<span class=\"token double-colon punctuation\">::</span>app<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    Time now <span class=\"token operator\">=</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">double</span> cur <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>sink<span class=\"token operator\">-></span><span class=\"token function\">GetTotalRx</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> lastTotalRx<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span><span class=\"token punctuation\">)</span><span class=\"token number\">8</span> <span class=\"token operator\">/</span> <span class=\"token number\">1e6</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">double</span> TotalRx <span class=\"token operator\">=</span> sink<span class=\"token operator\">-></span><span class=\"token function\">GetTotalRx</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span><span class=\"token punctuation\">)</span><span class=\"token number\">8</span> <span class=\"token operator\">/</span> <span class=\"token number\">1e6</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">double</span> TotalTx <span class=\"token operator\">=</span> source<span class=\"token operator\">-></span><span class=\"token function\">GetTotalTx</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span><span class=\"token punctuation\">)</span><span class=\"token number\">8</span> <span class=\"token operator\">/</span> <span class=\"token number\">1e6</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    file <span class=\"token operator\">&lt;&lt;</span> now<span class=\"token punctuation\">.</span><span class=\"token function\">GetSeconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" \"</span> <span class=\"token operator\">&lt;&lt;</span> TotalTx <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" \"</span> <span class=\"token operator\">&lt;&lt;</span> TotalRx <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" \"</span> <span class=\"token operator\">&lt;&lt;</span> cur <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token comment\">//  std::cout&lt;&lt;now.GetSeconds () &lt;&lt; \"s 发送数据: \\t\" &lt;&lt;\"send:\"&lt;&lt;source->GetTotalTx ()* (double) 8 / 1e6&lt;&lt;\"Mbit\"&lt;&lt;std::endl;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token comment\">//  std::cout&lt;&lt;now.GetSeconds () &lt;&lt; \"s 接收数据: \\t\" &lt;&lt;\"receive:\"&lt;&lt;sink->GetTotalRx ()* (double) 8 / 1e6&lt;&lt;\"Mbit\"&lt;&lt;std::endl;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> now<span class=\"token punctuation\">.</span><span class=\"token function\">GetSeconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"s吞吐量: \\t\"</span> <span class=\"token operator\">&lt;&lt;</span> cur <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" Mbit/s\"</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span> <span class=\"token comment\">// throughput</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                                                                                     <span class=\"token comment\">// std::cout &lt;&lt; now.GetSeconds () &lt;&lt; cur &lt;&lt; std::endl;//throughput</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    lastTotalRx <span class=\"token operator\">=</span> sink<span class=\"token operator\">-></span><span class=\"token function\">GetTotalRx</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    file<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>now <span class=\"token operator\">&lt;</span> <span class=\"token function\">Seconds</span><span class=\"token punctuation\">(</span>endTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token comment\">//  Simulator::Schedule (MilliSeconds (100), &amp;OrrpExample::CalculateThroughput,this,endTime);</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Schedule</span><span class=\"token punctuation\">(</span><span class=\"token function\">Seconds</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>OrrpExample<span class=\"token double-colon punctuation\">::</span>CalculateThroughput<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> endTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>详细代码如下所示</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;vector></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;iostream></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;cmath></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/aodv-module.h\"</span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/orrp-module.h\"</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/orrp2d-helper.h\"</span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/core-module.h\"</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/network-module.h\"</span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/internet-module.h\"</span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/mobility-module.h\"</span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/point-to-point-module.h\"</span></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/v4ping-helper.h\"</span></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/optical-helper.h\"</span></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/applications-module.h\"</span></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">// add by yeyu</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/MyPropagationLossModel.h\"</span></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/stats-module.h\"</span></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/netanim-module.h\"</span></span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;sstream></span></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;string></span></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">using</span> <span class=\"token keyword\">namespace</span> ns3<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">//********************* stats result******************//</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">// 输出结果</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">//  void ReportStatistics ();</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">// send callback</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">TxPacket</span><span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> Packet<span class=\"token operator\">></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">// 打印进度</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">PrintProgress</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> TotalTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">// 接收回调</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\">// void ReceivePacket (Ptr&lt;const Packet> packet, const Address &amp;);</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token keyword\">uint32_t</span> <span class=\"token function\">bytesTotal</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token keyword\">uint32_t</span> <span class=\"token function\">bytesReceivedTotal</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token keyword\">uint32_t</span> <span class=\"token function\">packetsReceived</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token keyword\">uint32_t</span> <span class=\"token function\">packetsTx</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>DelayJitterEstimation m_delayEstimation<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token keyword\">double</span> <span class=\"token function\">m_delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token keyword\">uint64_t</span> <span class=\"token function\">m_jitter</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token keyword\">bool</span> <span class=\"token function\">first_pkt</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>std<span class=\"token double-colon punctuation\">::</span>string <span class=\"token function\">m_CSVfileName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"orrpTest-routing-output\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>Time m_firstRx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>Time m_lastRx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>Time tmp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token keyword\">uint32_t</span> <span class=\"token function\">tmpTotal</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span>Time<span class=\"token operator\">></span> sendTime<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span><span class=\"token keyword\">uint32_t</span><span class=\"token operator\">></span> sendSeq<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token comment\">//********************* stats result******************//</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token comment\">// 接收端应用</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>Ptr<span class=\"token operator\">&lt;</span>PacketSink<span class=\"token operator\">></span> sink<span class=\"token punctuation\">;</span> <span class=\"token comment\">/* Pointer to the packet sink application */</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token comment\">// 发送端应用</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>Ptr<span class=\"token operator\">&lt;</span>OnOffApplication<span class=\"token operator\">></span> source<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token keyword\">uint64_t</span> lastTotalRx <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">/* The value of the last total received bytes */</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">OrrpExample</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token keyword\">public</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token function\">OrrpExample</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token keyword\">bool</span> <span class=\"token function\">Configure</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token operator\">*</span>argv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>     * Report results</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>     * \\param os the output stream</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">Report</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>ostream <span class=\"token operator\">&amp;</span>os<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">printRoute</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> showTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">CalculateThroughput</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> endTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">PhyRxOkTrace</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>string context<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span> <span class=\"token keyword\">double</span> snr<span class=\"token punctuation\">,</span> WifiMode mode<span class=\"token punctuation\">,</span> <span class=\"token keyword\">enum</span> <span class=\"token class-name\">WifiPreamble</span> preamble<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">DevTxTrace</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>string context<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">DevRxTrace</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>string context<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">ReceivePacket</span><span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> Address <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">ReportStatistics</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">energyChanged</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> oldValue<span class=\"token punctuation\">,</span> <span class=\"token keyword\">double</span> newValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre></pre></td></tr><tr><td data-num=\"80\"></td><td><pre><span class=\"token keyword\">private</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>    <span class=\"token comment\">// parameters</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    <span class=\"token comment\">/// 节点数量</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    <span class=\"token keyword\">uint32_t</span> size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>    <span class=\"token comment\">/// 采用网格布局时节点的距离</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>    <span class=\"token keyword\">double</span> step<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>    <span class=\"token comment\">/// 仿真总时间 (s)</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>    <span class=\"token keyword\">double</span> totalTime<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    <span class=\"token comment\">/// Write per-device PCAP traces if true</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    <span class=\"token keyword\">bool</span> pcap<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    <span class=\"token comment\">/// 是否打印路由表</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    <span class=\"token keyword\">bool</span> printRoutes<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>    <span class=\"token keyword\">bool</span> nodesMove<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>    <span class=\"token keyword\">double</span> m_energyCost<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>    <span class=\"token keyword\">double</span> m_energyInit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>    <span class=\"token comment\">// 节点布局方式 (0: 网格布局；1: 矩形随机布局)</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    <span class=\"token keyword\">int</span> nodesLocationType<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    <span class=\"token comment\">// 随机</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>    <span class=\"token keyword\">int</span> seed<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>    <span class=\"token keyword\">int</span> width<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>    <span class=\"token comment\">// yeyu</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>    WifiHelper wifi<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span>Ptr<span class=\"token operator\">&lt;</span>WifiPhy<span class=\"token operator\">>></span> m_phyVector<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>string m_protocolName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>    <span class=\"token keyword\">int</span> m_routingProtocol<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    NodeContainer nodes<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>    NetDeviceContainer devices<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>    Ipv4InterfaceContainer interfaces<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre></pre></td></tr><tr><td data-num=\"112\"></td><td><pre><span class=\"token keyword\">private</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">CreateNodes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">CreateDevices</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">InstallInternetStack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">InstallApplications</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre></pre></td></tr><tr><td data-num=\"122\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">OrrpExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ReceivePacket</span><span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> Address <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> tmp<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token function\">Seconds</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>        tmpTotal <span class=\"token operator\">+=</span> packet<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>    <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> tmp<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token function\">Seconds</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>            std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> tmp<span class=\"token punctuation\">.</span><span class=\"token function\">GetSeconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"S throughoutput = \"</span> <span class=\"token operator\">&lt;&lt;</span> tmpTotal <span class=\"token operator\">*</span> <span class=\"token number\">8</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1e6</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Mbit\"</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>            std<span class=\"token double-colon punctuation\">::</span>ostringstream ostrStream<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>            ostrStream <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"./result/\"</span> <span class=\"token operator\">&lt;&lt;</span> m_protocolName <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Test/\"</span> <span class=\"token operator\">&lt;&lt;</span> m_protocolName <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Test-size-\"</span> <span class=\"token operator\">&lt;&lt;</span> size <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-seed-\"</span> <span class=\"token operator\">&lt;&lt;</span> seed <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-nodesLocationType-\"</span> <span class=\"token operator\">&lt;&lt;</span> nodesLocationType <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-nodesMove-\"</span> <span class=\"token operator\">&lt;&lt;</span> nodesMove <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-width-\"</span> <span class=\"token operator\">&lt;&lt;</span> width <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-step-\"</span> <span class=\"token operator\">&lt;&lt;</span> step <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-log\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>            std<span class=\"token double-colon punctuation\">::</span>ofstream <span class=\"token function\">file</span><span class=\"token punctuation\">(</span>ostrStream<span class=\"token punctuation\">.</span><span class=\"token function\">str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> std<span class=\"token double-colon punctuation\">::</span>ios<span class=\"token double-colon punctuation\">::</span>app <span class=\"token operator\">|</span> std<span class=\"token double-colon punctuation\">::</span>ios<span class=\"token double-colon punctuation\">::</span>out<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>            file <span class=\"token operator\">&lt;&lt;</span> tmp<span class=\"token punctuation\">.</span><span class=\"token function\">GetSeconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" \"</span> <span class=\"token operator\">&lt;&lt;</span> sendSeq<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> packet<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">8</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1e6</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" \"</span> <span class=\"token operator\">&lt;&lt;</span> bytesTotal <span class=\"token operator\">*</span> <span class=\"token number\">8</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1e6</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" \"</span> <span class=\"token operator\">&lt;&lt;</span> tmpTotal <span class=\"token operator\">*</span> <span class=\"token number\">8</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1e6</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>            file<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>            tmp <span class=\"token operator\">+=</span> <span class=\"token function\">Seconds</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>            tmpTotal <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>        tmpTotal <span class=\"token operator\">+=</span> packet<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span><span class=\"token keyword\">uint32_t</span><span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span>iterator iter<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>    iter <span class=\"token operator\">=</span> <span class=\"token function\">find</span><span class=\"token punctuation\">(</span>sendSeq<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> sendSeq<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> packet<span class=\"token operator\">-></span><span class=\"token function\">GetUid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>    <span class=\"token keyword\">int</span> index <span class=\"token operator\">=</span> iter <span class=\"token operator\">-</span> sendSeq<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>    bytesTotal <span class=\"token operator\">+=</span> packet<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>    packetsReceived <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>    m_delayEstimation<span class=\"token punctuation\">.</span><span class=\"token function\">RecordRx</span><span class=\"token punctuation\">(</span>packet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>    <span class=\"token comment\">//          m_delay += m_delayEstimation.GetLastDelay().GetNanoSeconds();</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>    m_delay <span class=\"token operator\">+=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> sendTime<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetSeconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>    m_jitter <span class=\"token operator\">+=</span> m_delayEstimation<span class=\"token punctuation\">.</span><span class=\"token function\">GetLastJitter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>    <span class=\"token comment\">//          std::cout&lt;&lt;tmp.GetSeconds()&lt;&lt;\"s \"&lt;&lt;tmpTotal&lt;&lt;\"Byte \"&lt;&lt;Simulator::Now().GetSeconds()&lt;&lt;\"uid:\"&lt;&lt;packet->GetUid()&lt;&lt;\" received packet delay=\"&lt;&lt;(Simulator::Now()-sendTime[index]).GetSeconds()&lt;&lt;\"s size= \"&lt;&lt;packet->GetSize ()&lt;&lt;std::endl;</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>first_pkt<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>        m_firstRx <span class=\"token operator\">=</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>        first_pkt <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>    m_lastRx <span class=\"token operator\">=</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre></pre></td></tr><tr><td data-num=\"166\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">TxPacket</span><span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> Packet<span class=\"token operator\">></span> pkt<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>    <span class=\"token comment\">// trace packet</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>    packetsTx <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>    m_delayEstimation<span class=\"token punctuation\">.</span><span class=\"token function\">PrepareTx</span><span class=\"token punctuation\">(</span>pkt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>    sendSeq<span class=\"token punctuation\">.</span><span class=\"token function\">push_back</span><span class=\"token punctuation\">(</span>pkt<span class=\"token operator\">-></span><span class=\"token function\">GetUid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>    sendTime<span class=\"token punctuation\">.</span><span class=\"token function\">push_back</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>    <span class=\"token comment\">//    std::cout&lt;&lt;Simulator::Now().GetSeconds()&lt;&lt;\"uid:\"&lt;&lt;pkt->GetUid()&lt;&lt;\" send\"&lt;&lt;std::endl;</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre></pre></td></tr><tr><td data-num=\"176\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">PrintProgress</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> TotalTime<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>    <span class=\"token keyword\">double</span> now <span class=\"token operator\">=</span> <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetSeconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>    <span class=\"token function\">NS_LOG_UNCOND</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Progress Completed .. \"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token punctuation\">(</span>now <span class=\"token operator\">/</span> TotalTime<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">100</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"%\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>    <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Schedule</span><span class=\"token punctuation\">(</span><span class=\"token function\">Seconds</span><span class=\"token punctuation\">(</span>TotalTime <span class=\"token operator\">/</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>PrintProgress<span class=\"token punctuation\">,</span> TotalTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre></pre></td></tr><tr><td data-num=\"183\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">OrrpExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ReportStatistics</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>    <span class=\"token keyword\">double</span> Dt <span class=\"token operator\">=</span> m_lastRx<span class=\"token punctuation\">.</span><span class=\"token function\">GetSeconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> m_firstRx<span class=\"token punctuation\">.</span><span class=\"token function\">GetSeconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>    <span class=\"token keyword\">double</span> kbs <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>bytesTotal <span class=\"token operator\">*</span> <span class=\"token number\">8.0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>Dt <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>    bytesTotal <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>ofstream <span class=\"token function\">out</span><span class=\"token punctuation\">(</span>m_CSVfileName<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> std<span class=\"token double-colon punctuation\">::</span>ios<span class=\"token double-colon punctuation\">::</span>app<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>    <span class=\"token keyword\">int</span> m_nSinks <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>    out <span class=\"token operator\">&lt;&lt;</span> kbs <span class=\"token operator\">/</span> m_nSinks <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\",\"</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>        <span class=\"token operator\">&lt;&lt;</span> packetsReceived <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\",\"</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>        <span class=\"token operator\">&lt;&lt;</span> packetsTx <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\",\"</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>        <span class=\"token operator\">&lt;&lt;</span> packetsReceived <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span><span class=\"token punctuation\">)</span>packetsTx <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\",\"</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>        <span class=\"token operator\">&lt;&lt;</span> m_delay <span class=\"token operator\">/</span> packetsReceived <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\",\"</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre>        <span class=\"token operator\">&lt;&lt;</span> m_jitter <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>packetsReceived <span class=\"token operator\">*</span> <span class=\"token number\">1000000000.0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\",\"</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>        <span class=\"token comment\">//   &lt;&lt; routingPkts &lt;&lt; \",\"</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>        <span class=\"token comment\">//    &lt;&lt; m_nSinks &lt;&lt; \",\"</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>        <span class=\"token comment\">//    &lt;&lt; m_nWifis &lt;&lt; \",\"</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>        <span class=\"token comment\">//    &lt;&lt; m_protocolName &lt;&lt; \",\"</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre>        <span class=\"token comment\">//   &lt;&lt; m_txrange &lt;&lt; \"\"</span></pre></td></tr><tr><td data-num=\"202\"></td><td><pre>        <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre></pre></td></tr><tr><td data-num=\"204\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"吞吐量 \"</span> <span class=\"token operator\">&lt;&lt;</span> kbs <span class=\"token operator\">/</span> m_nSinks <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" kbps ,\"</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre>              <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"收包数\"</span> <span class=\"token operator\">&lt;&lt;</span> packetsReceived <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\",\"</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre>              <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"发包数\"</span> <span class=\"token operator\">&lt;&lt;</span> packetsTx <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\",\"</span></pre></td></tr><tr><td data-num=\"207\"></td><td><pre>              <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"交付率\"</span> <span class=\"token operator\">&lt;&lt;</span> packetsReceived <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span><span class=\"token punctuation\">)</span>packetsTx <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\",\"</span></pre></td></tr><tr><td data-num=\"208\"></td><td><pre>              <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"时延\"</span> <span class=\"token operator\">&lt;&lt;</span> m_delay <span class=\"token operator\">/</span> packetsReceived <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\",\"</span></pre></td></tr><tr><td data-num=\"209\"></td><td><pre>              <span class=\"token operator\">&lt;&lt;</span> m_jitter <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>packetsReceived <span class=\"token operator\">*</span> <span class=\"token number\">1000000000.0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\",\"</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre>              <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre></pre></td></tr><tr><td data-num=\"212\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>ostringstream ostrStream<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"213\"></td><td><pre>    ostrStream <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"./result/\"</span> <span class=\"token operator\">&lt;&lt;</span> m_protocolName <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Test/\"</span> <span class=\"token operator\">&lt;&lt;</span> m_protocolName <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Test-size-\"</span> <span class=\"token operator\">&lt;&lt;</span> size <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-seed-\"</span> <span class=\"token operator\">&lt;&lt;</span> seed <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-nodesLocationType-\"</span> <span class=\"token operator\">&lt;&lt;</span> nodesLocationType <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-nodesMove-\"</span> <span class=\"token operator\">&lt;&lt;</span> nodesMove <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-width-\"</span> <span class=\"token operator\">&lt;&lt;</span> width <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-step-\"</span> <span class=\"token operator\">&lt;&lt;</span> step <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-delay-log\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"214\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>ofstream <span class=\"token function\">file</span><span class=\"token punctuation\">(</span>ostrStream<span class=\"token punctuation\">.</span><span class=\"token function\">str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> std<span class=\"token double-colon punctuation\">::</span>ios<span class=\"token double-colon punctuation\">::</span>app <span class=\"token operator\">|</span> std<span class=\"token double-colon punctuation\">::</span>ios<span class=\"token double-colon punctuation\">::</span>out<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"215\"></td><td><pre>    file <span class=\"token operator\">&lt;&lt;</span> packetsReceived <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span><span class=\"token punctuation\">)</span>packetsTx <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" \"</span> <span class=\"token operator\">&lt;&lt;</span> m_delay <span class=\"token operator\">/</span> packetsReceived <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" \"</span> <span class=\"token operator\">&lt;&lt;</span> kbs <span class=\"token operator\">/</span> m_nSinks <span class=\"token operator\">/</span> <span class=\"token number\">1e3</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"216\"></td><td><pre></pre></td></tr><tr><td data-num=\"217\"></td><td><pre>    file<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre></pre></td></tr><tr><td data-num=\"219\"></td><td><pre>    out<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre>    packetsReceived <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"221\"></td><td><pre>    packetsTx <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"222\"></td><td><pre>    m_delay <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"223\"></td><td><pre>    m_jitter <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"224\"></td><td><pre>    <span class=\"token comment\">// routingPkts = 0;</span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"226\"></td><td><pre></pre></td></tr><tr><td data-num=\"227\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token operator\">*</span>argv<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"228\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"229\"></td><td><pre>    OrrpExample test<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"230\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>test<span class=\"token punctuation\">.</span><span class=\"token function\">Configure</span><span class=\"token punctuation\">(</span>argc<span class=\"token punctuation\">,</span> argv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"231\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"232\"></td><td><pre>        <span class=\"token function\">NS_FATAL_ERROR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Configuration failed. Aborted.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"233\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"234\"></td><td><pre></pre></td></tr><tr><td data-num=\"235\"></td><td><pre>    test<span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"236\"></td><td><pre>    test<span class=\"token punctuation\">.</span><span class=\"token function\">ReportStatistics</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"237\"></td><td><pre>    test<span class=\"token punctuation\">.</span><span class=\"token function\">Report</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>cout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"238\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"239\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"240\"></td><td><pre></pre></td></tr><tr><td data-num=\"241\"></td><td><pre><span class=\"token comment\">//-----------------------------------------------------------------------------</span></pre></td></tr><tr><td data-num=\"242\"></td><td><pre><span class=\"token class-name\">OrrpExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">OrrpExample</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token number\">30</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"243\"></td><td><pre>                             <span class=\"token function\">step</span><span class=\"token punctuation\">(</span><span class=\"token number\">40</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"244\"></td><td><pre>                             <span class=\"token function\">totalTime</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"245\"></td><td><pre>                             <span class=\"token function\">pcap</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"246\"></td><td><pre>                             <span class=\"token function\">printRoutes</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"247\"></td><td><pre>                             <span class=\"token function\">seed</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"248\"></td><td><pre>                             <span class=\"token function\">width</span><span class=\"token punctuation\">(</span>size <span class=\"token operator\">/</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"249\"></td><td><pre>                             <span class=\"token function\">nodesMove</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"250\"></td><td><pre>                             <span class=\"token function\">nodesLocationType</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"251\"></td><td><pre>                             <span class=\"token function\">m_energyInit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"252\"></td><td><pre>                             <span class=\"token function\">m_energyCost</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"253\"></td><td><pre>                             <span class=\"token function\">m_routingProtocol</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"254\"></td><td><pre>                             <span class=\"token function\">m_protocolName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"aodv\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"255\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"256\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"257\"></td><td><pre></pre></td></tr><tr><td data-num=\"258\"></td><td><pre><span class=\"token keyword\">bool</span> <span class=\"token class-name\">OrrpExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Configure</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token operator\">*</span>argv<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"259\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"260\"></td><td><pre>    <span class=\"token comment\">// Enable ORRP logs by default. Comment this if too noisy</span></pre></td></tr><tr><td data-num=\"261\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"262\"></td><td><pre>    <span class=\"token comment\">//   LogComponentEnable(\"OrrpNeighbors\", LOG_LEVEL_WARN);</span></pre></td></tr><tr><td data-num=\"263\"></td><td><pre>    <span class=\"token comment\">//   LogComponentEnable(\"OrrpNeighbors\", LOG_LEVEL_WARN);</span></pre></td></tr><tr><td data-num=\"264\"></td><td><pre>    <span class=\"token comment\">//   LogComponentEnable(\"OrrpRoutingTable\", LOG_LEVEL_WARN);</span></pre></td></tr><tr><td data-num=\"265\"></td><td><pre>    <span class=\"token function\">LogComponentEnable</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Orrp2dRoutingProtocol\"</span><span class=\"token punctuation\">,</span> LOG_LEVEL_ERROR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"266\"></td><td><pre>    <span class=\"token function\">LogComponentEnable</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Orrp2dNeighbors\"</span><span class=\"token punctuation\">,</span> LOG_LEVEL_ERROR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"267\"></td><td><pre>    <span class=\"token comment\">//   LogComponentEnable(\"OrrpRoutingProtocol\", LOG_LEVEL_ALL);</span></pre></td></tr><tr><td data-num=\"268\"></td><td><pre>    <span class=\"token comment\">//  LogComponentEnable(\"BasicEnergySource\", LOG_LEVEL_ALL);</span></pre></td></tr><tr><td data-num=\"269\"></td><td><pre></pre></td></tr><tr><td data-num=\"270\"></td><td><pre>    <span class=\"token comment\">//  LogComponentEnable(\"MyLossModel\",LOG_LEVEL_ALL);</span></pre></td></tr><tr><td data-num=\"271\"></td><td><pre>    <span class=\"token comment\">//  LogComponentEnable(\"YansWifiChannel\",LOG_LEVEL_ALL);</span></pre></td></tr><tr><td data-num=\"272\"></td><td><pre>    <span class=\"token comment\">//  LogComponentEnable(\"MyPacketSink\",LOG_LEVEL_ALL);</span></pre></td></tr><tr><td data-num=\"273\"></td><td><pre>    <span class=\"token comment\">//  LogComponentEnable(\"OrrpRoutingProtocol\",LOG_LEVEL_ALL);</span></pre></td></tr><tr><td data-num=\"274\"></td><td><pre></pre></td></tr><tr><td data-num=\"275\"></td><td><pre>    CommandLine <span class=\"token function\">cmd</span><span class=\"token punctuation\">(</span><span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"276\"></td><td><pre></pre></td></tr><tr><td data-num=\"277\"></td><td><pre>    cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pcap\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Write PCAP traces.\"</span><span class=\"token punctuation\">,</span> pcap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"278\"></td><td><pre>    cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"printRoutes\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Print routing table dumps.\"</span><span class=\"token punctuation\">,</span> printRoutes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"279\"></td><td><pre>    cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"size\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Number of nodes.\"</span><span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"280\"></td><td><pre>    cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"time\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Simulation time, s.\"</span><span class=\"token punctuation\">,</span> totalTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"281\"></td><td><pre>    cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"route\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"routing protocol name\"</span><span class=\"token punctuation\">,</span> m_routingProtocol<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"282\"></td><td><pre>    cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"step\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Grid step, m\"</span><span class=\"token punctuation\">,</span> step<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"283\"></td><td><pre>    cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"seed\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"seed\"</span><span class=\"token punctuation\">,</span> seed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"284\"></td><td><pre>    cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"width\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"grid width\"</span><span class=\"token punctuation\">,</span> width<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"285\"></td><td><pre>    cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"nodesMove\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"nodes move?\"</span><span class=\"token punctuation\">,</span> nodesMove<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"286\"></td><td><pre>    cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"nodesLocationType\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"the type of nodes location\"</span><span class=\"token punctuation\">,</span> nodesLocationType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"287\"></td><td><pre>    cmd<span class=\"token punctuation\">.</span><span class=\"token function\">Parse</span><span class=\"token punctuation\">(</span>argc<span class=\"token punctuation\">,</span> argv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"288\"></td><td><pre>    <span class=\"token class-name\">SeedManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SetSeed</span><span class=\"token punctuation\">(</span>seed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"289\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"290\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"291\"></td><td><pre></pre></td></tr><tr><td data-num=\"292\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">OrrpExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">PhyRxOkTrace</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>string context<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span> <span class=\"token keyword\">double</span> snr<span class=\"token punctuation\">,</span> WifiMode mode<span class=\"token punctuation\">,</span> <span class=\"token keyword\">enum</span> <span class=\"token class-name\">WifiPreamble</span> preamble<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"293\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"294\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"PHYRXOK mode=\"</span> <span class=\"token operator\">&lt;&lt;</span> mode <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" snr=\"</span> <span class=\"token operator\">&lt;&lt;</span> snr <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" PacketSize= \"</span> <span class=\"token operator\">&lt;&lt;</span> packet<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"295\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"296\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">OrrpExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">DevTxTrace</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>string context<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> Packet<span class=\"token operator\">></span> p<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"297\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"298\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" TX p size = \"</span> <span class=\"token operator\">&lt;&lt;</span> p<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"299\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"300\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">OrrpExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">DevRxTrace</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>string context<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> Packet<span class=\"token operator\">></span> p<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"301\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"302\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" RX p size = : \"</span> <span class=\"token operator\">&lt;&lt;</span> p<span class=\"token operator\">-></span><span class=\"token function\">GetSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"303\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"304\"></td><td><pre></pre></td></tr><tr><td data-num=\"305\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">OrrpExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"306\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"307\"></td><td><pre>    <span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SetDefault</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::WifiRemoteStationManager::RtsCtsThreshold\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">UintegerValue</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// enable rts cts all the time.</span></pre></td></tr><tr><td data-num=\"308\"></td><td><pre></pre></td></tr><tr><td data-num=\"309\"></td><td><pre>    <span class=\"token function\">CreateNodes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"310\"></td><td><pre>    <span class=\"token function\">CreateDevices</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"311\"></td><td><pre>    <span class=\"token comment\">//  Config::Connect (\"/NodeList/*/DeviceList/*/Phy/State/RxOk\", MakeCallback (&amp;OrrpExample::PhyRxOkTrace,this));</span></pre></td></tr><tr><td data-num=\"312\"></td><td><pre>    <span class=\"token comment\">//  Config::Connect (\"/NodeList/*/DeviceList/*/Mac/MacRx\", MakeCallback (&amp;OrrpExample::DevRxTrace,this));</span></pre></td></tr><tr><td data-num=\"313\"></td><td><pre>    <span class=\"token comment\">//  Config::Connect (\"/NodeList/*/DeviceList/*/Mac/MacTx\", MakeCallback (&amp;OrrpExample::DevTxTrace,this));</span></pre></td></tr><tr><td data-num=\"314\"></td><td><pre></pre></td></tr><tr><td data-num=\"315\"></td><td><pre>    <span class=\"token function\">InstallInternetStack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"316\"></td><td><pre>    <span class=\"token function\">InstallApplications</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"317\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Starting simulation for \"</span> <span class=\"token operator\">&lt;&lt;</span> totalTime <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" s ...\\n\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"318\"></td><td><pre></pre></td></tr><tr><td data-num=\"319\"></td><td><pre>    <span class=\"token comment\">// 动画显示</span></pre></td></tr><tr><td data-num=\"320\"></td><td><pre>    AnimationInterface <span class=\"token function\">anim</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2dTest.xml\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"321\"></td><td><pre>    anim<span class=\"token punctuation\">.</span><span class=\"token function\">SetMaxPktsPerTraceFile</span><span class=\"token punctuation\">(</span><span class=\"token number\">99999999999999</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"322\"></td><td><pre>    anim<span class=\"token punctuation\">.</span><span class=\"token function\">EnableIpv4RouteTracking</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2dTest.route\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">Seconds</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">Seconds</span><span class=\"token punctuation\">(</span>totalTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">Seconds</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"323\"></td><td><pre>    <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Stop</span><span class=\"token punctuation\">(</span><span class=\"token function\">Seconds</span><span class=\"token punctuation\">(</span>totalTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"324\"></td><td><pre></pre></td></tr><tr><td data-num=\"325\"></td><td><pre>    <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"326\"></td><td><pre>    <span class=\"token comment\">//  Config::Connect (\"/NodeList/*/DeviceList/*/Phy/State/RxOk\", MakeCallback (&amp;OrrpExample::PhyRxOkTrace2,this));</span></pre></td></tr><tr><td data-num=\"327\"></td><td><pre>    <span class=\"token comment\">//  Config::Connect (\"/NodeList/*/DeviceList/*/Phy/State/RxOk\", MakeCallback (&amp;PhyRxOkTrace));</span></pre></td></tr><tr><td data-num=\"328\"></td><td><pre>    <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Destroy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"329\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"330\"></td><td><pre></pre></td></tr><tr><td data-num=\"331\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">OrrpExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Report</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>ostream <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"332\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"333\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"334\"></td><td><pre></pre></td></tr><tr><td data-num=\"335\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">OrrpExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">CreateNodes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"336\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"337\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Creating \"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span><span class=\"token punctuation\">)</span>size <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" nodes \"</span> <span class=\"token operator\">&lt;&lt;</span> step <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" m apart.\\n\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"338\"></td><td><pre>    nodes<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"339\"></td><td><pre>    <span class=\"token comment\">// Name nodes</span></pre></td></tr><tr><td data-num=\"340\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">uint32_t</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> size<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"341\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"342\"></td><td><pre>        std<span class=\"token double-colon punctuation\">::</span>ostringstream os<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"343\"></td><td><pre>        os <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"node-\"</span> <span class=\"token operator\">&lt;&lt;</span> i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"344\"></td><td><pre>        <span class=\"token class-name\">Names</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span>os<span class=\"token punctuation\">.</span><span class=\"token function\">str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> nodes<span class=\"token punctuation\">.</span><span class=\"token function\">Get</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"345\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"346\"></td><td><pre>    <span class=\"token comment\">// Create static grid</span></pre></td></tr><tr><td data-num=\"347\"></td><td><pre>    MobilityHelper mobility<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"348\"></td><td><pre>    <span class=\"token comment\">// 节点是否移动</span></pre></td></tr><tr><td data-num=\"349\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nodesMove<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"350\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"351\"></td><td><pre>        mobility<span class=\"token punctuation\">.</span><span class=\"token function\">SetMobilityModel</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::RandomWalk2dMobilityModel\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"352\"></td><td><pre>                                  <span class=\"token string\">\"Mode\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">StringValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Time\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"353\"></td><td><pre>                                  <span class=\"token string\">\"Direction\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">StringValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::UniformRandomVariable[Min=0.0|Max=6.283184]\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"354\"></td><td><pre>                                  <span class=\"token comment\">//                          \"Time\", StringValue(\"0.5s\"),</span></pre></td></tr><tr><td data-num=\"355\"></td><td><pre>                                  <span class=\"token string\">\"Speed\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">StringValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::UniformRandomVariable[Min=0.0|Max=4.0]\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"356\"></td><td><pre>                                  <span class=\"token comment\">//                           \"Speed\", StringValue(\"ns3::ConstantRandomVariable[Constant=5.0]\"),</span></pre></td></tr><tr><td data-num=\"357\"></td><td><pre>                                  <span class=\"token string\">\"Bounds\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">StringValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"0|1000|0|1000\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"358\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"359\"></td><td><pre>    <span class=\"token comment\">// 节点初始部署位置</span></pre></td></tr><tr><td data-num=\"360\"></td><td><pre>    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>nodesLocationType<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"361\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"362\"></td><td><pre>    <span class=\"token keyword\">case</span> <span class=\"token number\">0</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"363\"></td><td><pre>        mobility<span class=\"token punctuation\">.</span><span class=\"token function\">SetPositionAllocator</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::GridPositionAllocator\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"364\"></td><td><pre>                                      <span class=\"token string\">\"MinX\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">DoubleValue</span><span class=\"token punctuation\">(</span><span class=\"token number\">100.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"365\"></td><td><pre>                                      <span class=\"token string\">\"MinY\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">DoubleValue</span><span class=\"token punctuation\">(</span><span class=\"token number\">100.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"366\"></td><td><pre>                                      <span class=\"token string\">\"DeltaX\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">DoubleValue</span><span class=\"token punctuation\">(</span>step<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"367\"></td><td><pre>                                      <span class=\"token string\">\"DeltaY\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">DoubleValue</span><span class=\"token punctuation\">(</span>step<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"368\"></td><td><pre>                                      <span class=\"token string\">\"GridWidth\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">UintegerValue</span><span class=\"token punctuation\">(</span>width<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"369\"></td><td><pre>                                      <span class=\"token string\">\"LayoutType\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">StringValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"RowFirst\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"370\"></td><td><pre>        std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"采用网格布局 width = \"</span> <span class=\"token operator\">&lt;&lt;</span> width <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"371\"></td><td><pre></pre></td></tr><tr><td data-num=\"372\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"373\"></td><td><pre>    <span class=\"token keyword\">case</span> <span class=\"token number\">1</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"374\"></td><td><pre>        <span class=\"token keyword\">double</span> tmp <span class=\"token operator\">=</span> <span class=\"token number\">200</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"375\"></td><td><pre>        <span class=\"token comment\">// 设置节点部署在 200*200 米随机位置</span></pre></td></tr><tr><td data-num=\"376\"></td><td><pre>        mobility<span class=\"token punctuation\">.</span><span class=\"token function\">SetPositionAllocator</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::RandomBoxPositionAllocator\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"377\"></td><td><pre>                                      <span class=\"token string\">\"X\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">StringValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::UniformRandomVariable[Min=0.0|Max=200.0]\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"378\"></td><td><pre>                                      <span class=\"token string\">\"Y\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">StringValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::UniformRandomVariable[Min=0.0|Max=200.0]\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"379\"></td><td><pre>                                      <span class=\"token string\">\"Z\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">StringValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::UniformRandomVariable[Min=0.0|Max=0.0]\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"380\"></td><td><pre>        std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"采用200*200随机2维部署\"</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"381\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"382\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"383\"></td><td><pre>    mobility<span class=\"token punctuation\">.</span><span class=\"token function\">Install</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"384\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"385\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">singleDirectionSend</span><span class=\"token punctuation\">(</span>WifiHelper wifi<span class=\"token punctuation\">,</span> <span class=\"token keyword\">double</span> transmitDirectAngel<span class=\"token punctuation\">,</span> <span class=\"token keyword\">double</span> theta<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"386\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"387\"></td><td><pre></pre></td></tr><tr><td data-num=\"388\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span>Ptr<span class=\"token operator\">&lt;</span>WifiPhy<span class=\"token operator\">>></span> m_phyVector <span class=\"token operator\">=</span> wifi<span class=\"token punctuation\">.</span><span class=\"token function\">getPhyVector</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"389\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">uint32_t</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> m_phyVector<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"390\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"391\"></td><td><pre>        m_phyVector<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">-></span><span class=\"token function\">setTransmitMode</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"392\"></td><td><pre>        m_phyVector<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">-></span><span class=\"token function\">setTransmitDirectAngel</span><span class=\"token punctuation\">(</span>transmitDirectAngel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"393\"></td><td><pre>        m_phyVector<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">-></span><span class=\"token function\">setTheta</span><span class=\"token punctuation\">(</span>theta<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"394\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"395\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"396\"></td><td><pre></pre></td></tr><tr><td data-num=\"397\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">fourDirectionSend</span><span class=\"token punctuation\">(</span>WifiHelper wifi<span class=\"token punctuation\">,</span> <span class=\"token keyword\">double</span> pianzhuanAngel<span class=\"token punctuation\">,</span> <span class=\"token keyword\">double</span> angel<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"398\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"399\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span>Ptr<span class=\"token operator\">&lt;</span>WifiPhy<span class=\"token operator\">>></span> m_phyVector <span class=\"token operator\">=</span> wifi<span class=\"token punctuation\">.</span><span class=\"token function\">getPhyVector</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"400\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">uint32_t</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> m_phyVector<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"401\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"402\"></td><td><pre>        m_phyVector<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">-></span><span class=\"token function\">setTransmitDirectAngel</span><span class=\"token punctuation\">(</span>pianzhuanAngel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"403\"></td><td><pre>        m_phyVector<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">-></span><span class=\"token function\">setTheta</span><span class=\"token punctuation\">(</span>angel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"404\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"405\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"406\"></td><td><pre></pre></td></tr><tr><td data-num=\"407\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">twoDirectionSend</span><span class=\"token punctuation\">(</span>WifiHelper wifi<span class=\"token punctuation\">,</span> <span class=\"token keyword\">double</span> transmitDirectAngel<span class=\"token punctuation\">,</span> <span class=\"token keyword\">double</span> angel<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"408\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"409\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span>Ptr<span class=\"token operator\">&lt;</span>WifiPhy<span class=\"token operator\">>></span> m_phyVector <span class=\"token operator\">=</span> wifi<span class=\"token punctuation\">.</span><span class=\"token function\">getPhyVector</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"410\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">uint32_t</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> m_phyVector<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"411\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"412\"></td><td><pre>        m_phyVector<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">-></span><span class=\"token function\">setTransmitMode</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"413\"></td><td><pre>        m_phyVector<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">-></span><span class=\"token function\">setTransmitDirectAngel</span><span class=\"token punctuation\">(</span>transmitDirectAngel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"414\"></td><td><pre>        m_phyVector<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">-></span><span class=\"token function\">setTheta</span><span class=\"token punctuation\">(</span>angel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"415\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"416\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"417\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">OrrpExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">CreateDevices</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"418\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"419\"></td><td><pre>    WifiMacHelper wifiMac<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"420\"></td><td><pre>    wifiMac<span class=\"token punctuation\">.</span><span class=\"token function\">SetType</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::AdhocWifiMac\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"421\"></td><td><pre>    OpticalPhyHelper opticalPhy <span class=\"token operator\">=</span> <span class=\"token class-name\">OpticalPhyHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Default</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"422\"></td><td><pre>    OpticalChannelHelper opticalChannel <span class=\"token operator\">=</span> <span class=\"token class-name\">OpticalChannelHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Default</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"423\"></td><td><pre>    <span class=\"token comment\">// add loss</span></pre></td></tr><tr><td data-num=\"424\"></td><td><pre>    <span class=\"token comment\">//   Ptr&lt;MyPropagationLossModel> lossModel=CreateObject&lt;MyPropagationLossModel>();</span></pre></td></tr><tr><td data-num=\"425\"></td><td><pre>    <span class=\"token comment\">//   lossModel->SetCLamada(0.151);</span></pre></td></tr><tr><td data-num=\"426\"></td><td><pre>    <span class=\"token comment\">//  Ptr&lt;YansWifiChannel> myChannel=wifiChannel.Create();</span></pre></td></tr><tr><td data-num=\"427\"></td><td><pre>    <span class=\"token comment\">//   myChannel->SetPropagationLossModel(lossModel);</span></pre></td></tr><tr><td data-num=\"428\"></td><td><pre>    opticalPhy<span class=\"token punctuation\">.</span><span class=\"token function\">SetChannel</span><span class=\"token punctuation\">(</span>opticalChannel<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"429\"></td><td><pre></pre></td></tr><tr><td data-num=\"430\"></td><td><pre>    opticalPhy<span class=\"token punctuation\">.</span><span class=\"token function\">Set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"TxPowerStart\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">DoubleValue</span><span class=\"token punctuation\">(</span><span class=\"token number\">16.0206</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"431\"></td><td><pre>    opticalPhy<span class=\"token punctuation\">.</span><span class=\"token function\">Set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"TxPowerEnd\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">DoubleValue</span><span class=\"token punctuation\">(</span><span class=\"token number\">16.0206</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"432\"></td><td><pre>    opticalPhy<span class=\"token punctuation\">.</span><span class=\"token function\">Set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"TxPowerLevels\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">UintegerValue</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"433\"></td><td><pre>    <span class=\"token comment\">//  opticalPhy.Set(\"TxGain\", DoubleValue(1));</span></pre></td></tr><tr><td data-num=\"434\"></td><td><pre>    <span class=\"token comment\">//  opticalPhy.Set(\"RxGain\", DoubleValue(1));</span></pre></td></tr><tr><td data-num=\"435\"></td><td><pre>    <span class=\"token comment\">//  opticalPhy.Set(\"RxSensitivity\", DoubleValue(-96));</span></pre></td></tr><tr><td data-num=\"436\"></td><td><pre>    <span class=\"token comment\">//  opticalPhy.Set(\"CcaEdThreshold\", DoubleValue(-99));</span></pre></td></tr><tr><td data-num=\"437\"></td><td><pre>    <span class=\"token comment\">// wifi.SetRemoteStationManager (\"ns3::ConstantRateWifiManager\", \"DataMode\", StringValue (\"OfdmRate6Mbps\"), \"RtsCtsThreshold\", UintegerValue (0));</span></pre></td></tr><tr><td data-num=\"438\"></td><td><pre>    <span class=\"token comment\">//  wifi.SetRemoteStationManager (\"ns3::MinstrelHtWifiManager\");</span></pre></td></tr><tr><td data-num=\"439\"></td><td><pre>    devices <span class=\"token operator\">=</span> wifi<span class=\"token punctuation\">.</span><span class=\"token function\">Install</span><span class=\"token punctuation\">(</span>opticalPhy<span class=\"token punctuation\">,</span> wifiMac<span class=\"token punctuation\">,</span> nodes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"440\"></td><td><pre></pre></td></tr><tr><td data-num=\"441\"></td><td><pre>    <span class=\"token comment\">// create trace file</span></pre></td></tr><tr><td data-num=\"442\"></td><td><pre>    <span class=\"token comment\">//   AsciiTraceHelper ascii;</span></pre></td></tr><tr><td data-num=\"443\"></td><td><pre>    <span class=\"token comment\">//   wifiPhy.EnableAscii(ascii.CreateFileStream (\"orrp.tr\"),nodes);</span></pre></td></tr><tr><td data-num=\"444\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"445\"></td><td><pre></pre></td></tr><tr><td data-num=\"446\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">OrrpExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">printRoute</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> showTime<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"447\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"448\"></td><td><pre>    Ptr<span class=\"token operator\">&lt;</span>OutputStreamWrapper<span class=\"token operator\">></span> routingStream <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>OutputStreamWrapper<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ArouteTest.routes\"</span><span class=\"token punctuation\">,</span> std<span class=\"token double-colon punctuation\">::</span>ios<span class=\"token double-colon punctuation\">::</span>out<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"449\"></td><td><pre>    orrp<span class=\"token punctuation\">.</span><span class=\"token function\">PrintRoutingTableAllAt</span><span class=\"token punctuation\">(</span><span class=\"token function\">Seconds</span><span class=\"token punctuation\">(</span>showTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> routingStream<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"450\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"451\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">OrrpExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">InstallInternetStack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"452\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"453\"></td><td><pre>    <span class=\"token comment\">// you can configure ORRP attributes here using orrp.Set(name, value)</span></pre></td></tr><tr><td data-num=\"454\"></td><td><pre>    InternetStackHelper stack<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"455\"></td><td><pre></pre></td></tr><tr><td data-num=\"456\"></td><td><pre>    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>m_routingProtocol<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"457\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"458\"></td><td><pre>    <span class=\"token keyword\">case</span> <span class=\"token number\">2</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"459\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"460\"></td><td><pre>        Orrp2dHelper orrp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"461\"></td><td><pre>        std<span class=\"token double-colon punctuation\">::</span>ostringstream os<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"462\"></td><td><pre>        os <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"10.0.0.\"</span> <span class=\"token operator\">&lt;&lt;</span> size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"463\"></td><td><pre>        orrp<span class=\"token punctuation\">.</span>m_dst <span class=\"token operator\">=</span> <span class=\"token function\">Ipv4Address</span><span class=\"token punctuation\">(</span>os<span class=\"token punctuation\">.</span><span class=\"token function\">str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"464\"></td><td><pre>        orrp<span class=\"token punctuation\">.</span>m_origin <span class=\"token operator\">=</span> <span class=\"token function\">Ipv4Address</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"10.0.0.1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"465\"></td><td><pre>        stack<span class=\"token punctuation\">.</span><span class=\"token function\">SetRoutingHelper</span><span class=\"token punctuation\">(</span>orrp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// has effect on the next Install ()</span></pre></td></tr><tr><td data-num=\"466\"></td><td><pre>        m_protocolName <span class=\"token operator\">=</span> <span class=\"token string\">\"orrp2d\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"467\"></td><td><pre>        std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"used orrp2d routing proto\"</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"468\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>printRoutes<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"469\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"470\"></td><td><pre>            Ptr<span class=\"token operator\">&lt;</span>OutputStreamWrapper<span class=\"token operator\">></span> routingStream <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>OutputStreamWrapper<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2dTest.routes\"</span><span class=\"token punctuation\">,</span> std<span class=\"token double-colon punctuation\">::</span>ios<span class=\"token double-colon punctuation\">::</span>out<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"471\"></td><td><pre>            orrp<span class=\"token punctuation\">.</span><span class=\"token function\">PrintRoutingTableAllAt</span><span class=\"token punctuation\">(</span><span class=\"token function\">Seconds</span><span class=\"token punctuation\">(</span>totalTime <span class=\"token operator\">-</span> <span class=\"token number\">0.2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> routingStream<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"472\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"473\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"474\"></td><td><pre>    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"475\"></td><td><pre></pre></td></tr><tr><td data-num=\"476\"></td><td><pre>    <span class=\"token keyword\">case</span> <span class=\"token number\">1</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"477\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"478\"></td><td><pre>        OrrpHelper orrp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"479\"></td><td><pre>        stack<span class=\"token punctuation\">.</span><span class=\"token function\">SetRoutingHelper</span><span class=\"token punctuation\">(</span>orrp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// has effect on the next Install ()</span></pre></td></tr><tr><td data-num=\"480\"></td><td><pre>        m_protocolName <span class=\"token operator\">=</span> <span class=\"token string\">\"orrp\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"481\"></td><td><pre>        std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"used orrp routing proto\"</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"482\"></td><td><pre></pre></td></tr><tr><td data-num=\"483\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>printRoutes<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"484\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"485\"></td><td><pre>            Ptr<span class=\"token operator\">&lt;</span>OutputStreamWrapper<span class=\"token operator\">></span> routingStream <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>OutputStreamWrapper<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"orrpTest.routes\"</span><span class=\"token punctuation\">,</span> std<span class=\"token double-colon punctuation\">::</span>ios<span class=\"token double-colon punctuation\">::</span>out<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"486\"></td><td><pre>            orrp<span class=\"token punctuation\">.</span><span class=\"token function\">PrintRoutingTableAllAt</span><span class=\"token punctuation\">(</span><span class=\"token function\">Seconds</span><span class=\"token punctuation\">(</span>totalTime <span class=\"token operator\">-</span> <span class=\"token number\">0.2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> routingStream<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"487\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"488\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"489\"></td><td><pre>    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"490\"></td><td><pre>    <span class=\"token keyword\">case</span> <span class=\"token number\">0</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"491\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"492\"></td><td><pre>        AodvHelper aodv<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"493\"></td><td><pre>        stack<span class=\"token punctuation\">.</span><span class=\"token function\">SetRoutingHelper</span><span class=\"token punctuation\">(</span>aodv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// has effect on the next Install ()</span></pre></td></tr><tr><td data-num=\"494\"></td><td><pre>        m_protocolName <span class=\"token operator\">=</span> <span class=\"token string\">\"aodv\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"495\"></td><td><pre>        std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"used aodv routing proto\"</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"496\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>printRoutes<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"497\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"498\"></td><td><pre>            Ptr<span class=\"token operator\">&lt;</span>OutputStreamWrapper<span class=\"token operator\">></span> routingStream <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>OutputStreamWrapper<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"aodvTest.routes\"</span><span class=\"token punctuation\">,</span> std<span class=\"token double-colon punctuation\">::</span>ios<span class=\"token double-colon punctuation\">::</span>out<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"499\"></td><td><pre>            aodv<span class=\"token punctuation\">.</span><span class=\"token function\">PrintRoutingTableAllAt</span><span class=\"token punctuation\">(</span><span class=\"token function\">Seconds</span><span class=\"token punctuation\">(</span>totalTime <span class=\"token operator\">-</span> <span class=\"token number\">0.2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> routingStream<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"500\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"501\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"502\"></td><td><pre>    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"503\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"504\"></td><td><pre></pre></td></tr><tr><td data-num=\"505\"></td><td><pre>    <span class=\"token comment\">//  OrrpHelper orrp;</span></pre></td></tr><tr><td data-num=\"506\"></td><td><pre>    <span class=\"token comment\">//  stack.SetRoutingHelper (orrp); // has effect on the next Install ()</span></pre></td></tr><tr><td data-num=\"507\"></td><td><pre>    stack<span class=\"token punctuation\">.</span><span class=\"token function\">Install</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"508\"></td><td><pre>    Ipv4AddressHelper address<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"509\"></td><td><pre>    address<span class=\"token punctuation\">.</span><span class=\"token function\">SetBase</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"10.0.0.0\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"255.0.0.0\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"510\"></td><td><pre>    interfaces <span class=\"token operator\">=</span> address<span class=\"token punctuation\">.</span><span class=\"token function\">Assign</span><span class=\"token punctuation\">(</span>devices<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"511\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"512\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">OrrpExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">CalculateThroughput</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> endTime<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"513\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"514\"></td><td><pre>    <span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"515\"></td><td><pre>   std::ostringstream ostrStream;</pre></td></tr><tr><td data-num=\"516\"></td><td><pre>   ostrStream &lt;&lt; \"./result/orrpTest/orrpTest-size-\"&lt;&lt;size&lt;&lt;\"-seed-\"&lt;&lt;seed&lt;&lt;\"-nodesLocationType-\"&lt;&lt;nodesLocationType&lt;&lt;\"-nodesMove-\"&lt;&lt;nodesMove&lt;&lt;\"-width-\"&lt;&lt;width&lt;&lt;\"-step-\"&lt;&lt;step&lt;&lt;\"-log\";</pre></td></tr><tr><td data-num=\"517\"></td><td><pre>    std::ofstream file;</pre></td></tr><tr><td data-num=\"518\"></td><td><pre>    file.open (ostrStream.str (),std::ios_base::app);</pre></td></tr><tr><td data-num=\"519\"></td><td><pre>    Time now = Simulator::Now ();</pre></td></tr><tr><td data-num=\"520\"></td><td><pre>    double cur = (sink->GetTotalRx () - lastTotalRx) * (double) 8 / 1e6;</pre></td></tr><tr><td data-num=\"521\"></td><td><pre>    double TotalRx=sink->GetTotalRx ()* (double) 8 / 1e6;</pre></td></tr><tr><td data-num=\"522\"></td><td><pre>    double TotalTx=source->GetTotalTx ()* (double) 8 / 1e6;</pre></td></tr><tr><td data-num=\"523\"></td><td><pre>    file&lt;&lt;now.GetSeconds ()&lt;&lt;\"\"&lt;&lt;TotalTx&lt;&lt;\" \"&lt;&lt;TotalRx&lt;&lt;\" \"&lt;&lt;cur&lt;&lt;\"\\n\";</pre></td></tr><tr><td data-num=\"524\"></td><td><pre></pre></td></tr><tr><td data-num=\"525\"></td><td><pre>  //  std::cout&lt;&lt;now.GetSeconds () &lt;&lt; \"s 发送数据: \\t\" &lt;&lt;\"send:\"&lt;&lt;source->GetTotalTx ()* (double) 8 / 1e6&lt;&lt;\"Mbit\"&lt;&lt;std::endl;</pre></td></tr><tr><td data-num=\"526\"></td><td><pre>  //  std::cout&lt;&lt;now.GetSeconds () &lt;&lt; \"s 接收数据: \\t\" &lt;&lt;\"receive:\"&lt;&lt;sink->GetTotalRx ()* (double) 8 / 1e6&lt;&lt;\"Mbit\"&lt;&lt;std::endl;</pre></td></tr><tr><td data-num=\"527\"></td><td><pre>    std::cout &lt;&lt; now.GetSeconds () &lt;&lt; \"s 吞吐量: \\t\" &lt;&lt; cur &lt;&lt; \"Mbit/s\" &lt;&lt; std::endl;//throughput</pre></td></tr><tr><td data-num=\"528\"></td><td><pre>     //std::cout &lt;&lt; now.GetSeconds () &lt;&lt; cur &lt;&lt; std::endl;//throughput</pre></td></tr><tr><td data-num=\"529\"></td><td><pre>    lastTotalRx = sink->GetTotalRx ();</pre></td></tr><tr><td data-num=\"530\"></td><td><pre>    file.close ();</pre></td></tr><tr><td data-num=\"531\"></td><td><pre>    if (now&lt;Seconds (endTime))</pre></td></tr><tr><td data-num=\"532\"></td><td><pre>      //  Simulator::Schedule (MilliSeconds (100), &amp;OrrpExample::CalculateThroughput,this,endTime);</pre></td></tr><tr><td data-num=\"533\"></td><td><pre>        Simulator::Schedule (Seconds (1), &amp;OrrpExample::CalculateThroughput,this,endTime);</pre></td></tr><tr><td data-num=\"534\"></td><td><pre>        */</span></pre></td></tr><tr><td data-num=\"535\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"536\"></td><td><pre></pre></td></tr><tr><td data-num=\"537\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">writeData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"538\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"539\"></td><td><pre>    <span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"540\"></td><td><pre>      std::vector&lt;Time> sendTime=source->getSendTimeList ();</pre></td></tr><tr><td data-num=\"541\"></td><td><pre>      std::vector&lt;Time> receiveTime=sink->getReceiveTimeList ();</pre></td></tr><tr><td data-num=\"542\"></td><td><pre>      std::vector&lt;uint32_t> sendSeq=source->getSendSeqList ();</pre></td></tr><tr><td data-num=\"543\"></td><td><pre>      std::vector&lt;uint32_t> receiveSeq=sink->getReceiveSeqList ();</pre></td></tr><tr><td data-num=\"544\"></td><td><pre>      Time now = Simulator::Now ();</pre></td></tr><tr><td data-num=\"545\"></td><td><pre>      double TotalRx=sink->GetTotalRx ()* (double) 8 / 1e6;</pre></td></tr><tr><td data-num=\"546\"></td><td><pre>      double TotalTx=source->GetTotalTx ()* (double) 8 / 1e6;</pre></td></tr><tr><td data-num=\"547\"></td><td><pre>      double avgThroughput=TotalRx/(sendTime [sendTime.size ()-1]-sendTime [0]).GetSeconds ();</pre></td></tr><tr><td data-num=\"548\"></td><td><pre>      std::vector&lt;Time> delayList;</pre></td></tr><tr><td data-num=\"549\"></td><td><pre>      delayList.insert (delayList.begin (),sendTime.size (),Time ());</pre></td></tr><tr><td data-num=\"550\"></td><td><pre>      Time totalDelay=Time ();</pre></td></tr><tr><td data-num=\"551\"></td><td><pre>      for (uint32_t i=0;i&lt;receiveTime.size ();i++)&#123;</pre></td></tr><tr><td data-num=\"552\"></td><td><pre>          int seq=receiveSeq [i];</pre></td></tr><tr><td data-num=\"553\"></td><td><pre>          delayList [seq]=receiveTime [i]-sendTime [seq];</pre></td></tr><tr><td data-num=\"554\"></td><td><pre>          std::cout&lt;&lt;\"序列号:\"&lt;&lt;seq&lt;&lt;\"的包时延是\"&lt;&lt;delayList [seq].GetSeconds ()&lt;&lt;\"S\"&lt;&lt;std::endl;</pre></td></tr><tr><td data-num=\"555\"></td><td><pre>          totalDelay+=delayList [seq];</pre></td></tr><tr><td data-num=\"556\"></td><td><pre>      &#125;</pre></td></tr><tr><td data-num=\"557\"></td><td><pre>      //output to file</pre></td></tr><tr><td data-num=\"558\"></td><td><pre>      std::ofstream file;</pre></td></tr><tr><td data-num=\"559\"></td><td><pre>      file.open (\"./result/orrpTest/orrpTest-delay-log\",std::ios_base::app);</pre></td></tr><tr><td data-num=\"560\"></td><td><pre>      file&lt;&lt;(double) receiveTime.size ()/sendTime.size ()&lt;&lt;\"\"&lt;&lt;(totalDelay/receiveTime.size ()).GetSeconds ()&lt;&lt;\" \"&lt;&lt;avgThroughput&lt;&lt;\"\\n\";</pre></td></tr><tr><td data-num=\"561\"></td><td><pre></pre></td></tr><tr><td data-num=\"562\"></td><td><pre>      std::cout&lt;&lt;\"丢包率:\"&lt;&lt;1-(double) receiveTime.size ()/sendTime.size ()&lt;&lt;std::endl;</pre></td></tr><tr><td data-num=\"563\"></td><td><pre>      std::cout&lt;&lt;\"平均时延:\"&lt;&lt;(totalDelay/receiveTime.size ()).GetSeconds ()&lt;&lt;std::endl;</pre></td></tr><tr><td data-num=\"564\"></td><td><pre>      std::cout&lt;&lt;\"平均吞吐量:\"&lt;&lt;avgThroughput&lt;&lt;std::endl;</pre></td></tr><tr><td data-num=\"565\"></td><td><pre>      */</span></pre></td></tr><tr><td data-num=\"566\"></td><td><pre></pre></td></tr><tr><td data-num=\"567\"></td><td><pre>    <span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"568\"></td><td><pre>      std::cout&lt;&lt;\"数据包发送和接收时间\"&lt;&lt;std::endl;</pre></td></tr><tr><td data-num=\"569\"></td><td><pre>      for (uint32_t i = 0; i &lt; sendTime.size (); i++)</pre></td></tr><tr><td data-num=\"570\"></td><td><pre>       &#123;</pre></td></tr><tr><td data-num=\"571\"></td><td><pre>          std::cout&lt;&lt;sendTime [i].GetSeconds ()&lt;&lt;\"S 发送了一个数据包\"&lt;&lt;\"序列号是\"&lt;&lt;sendSeq [i]&lt;&lt;std::endl;</pre></td></tr><tr><td data-num=\"572\"></td><td><pre>       &#125;</pre></td></tr><tr><td data-num=\"573\"></td><td><pre>      for (uint32_t i = 0; i &lt; receiveTime.size (); i++)&#123;</pre></td></tr><tr><td data-num=\"574\"></td><td><pre>              std::cout&lt;&lt;receiveTime [i].GetSeconds ()&lt;&lt;\"S 接收了一个数据包\"&lt;&lt;\"序列号是\"&lt;&lt;receiveSeq [i]&lt;&lt;std::endl;</pre></td></tr><tr><td data-num=\"575\"></td><td><pre>      &#125;</pre></td></tr><tr><td data-num=\"576\"></td><td><pre>      */</span></pre></td></tr><tr><td data-num=\"577\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"578\"></td><td><pre></pre></td></tr><tr><td data-num=\"579\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">OrrpExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">InstallApplications</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"580\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"581\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>string dataRate <span class=\"token operator\">=</span> <span class=\"token string\">\"1Mbps\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// size of packet, 5/8*1024*1024/1472</span></pre></td></tr><tr><td data-num=\"582\"></td><td><pre>    <span class=\"token comment\">//  std::string dataRate = \"1Mbps\";</span></pre></td></tr><tr><td data-num=\"583\"></td><td><pre>    PacketSinkHelper <span class=\"token function\">sinkHelper</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::UdpSocketFactory\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">InetSocketAddress</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Ipv4Address</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">GetAny</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">9</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"584\"></td><td><pre>    <span class=\"token comment\">//  sinkHelper.SetAttribute(\"EnableSeqTsSizeHeader\",BooleanValue (true));</span></pre></td></tr><tr><td data-num=\"585\"></td><td><pre></pre></td></tr><tr><td data-num=\"586\"></td><td><pre>    <span class=\"token comment\">// 目的节点 ->sinkApp</span></pre></td></tr><tr><td data-num=\"587\"></td><td><pre>    ApplicationContainer sinkApp <span class=\"token operator\">=</span> sinkHelper<span class=\"token punctuation\">.</span><span class=\"token function\">Install</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">.</span><span class=\"token function\">Get</span><span class=\"token punctuation\">(</span>size <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"588\"></td><td><pre>    sink <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">StaticCast</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>PacketSink<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>sinkApp<span class=\"token punctuation\">.</span><span class=\"token function\">Get</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"589\"></td><td><pre></pre></td></tr><tr><td data-num=\"590\"></td><td><pre>    Address remoteAddress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"591\"></td><td><pre>    remoteAddress <span class=\"token operator\">=</span> <span class=\"token function\">InetSocketAddress</span><span class=\"token punctuation\">(</span>interfaces<span class=\"token punctuation\">.</span><span class=\"token function\">GetAddress</span><span class=\"token punctuation\">(</span>size <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">9</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"592\"></td><td><pre>    <span class=\"token comment\">/* Install TCP/UDP Transmitter on the station */</span></pre></td></tr><tr><td data-num=\"593\"></td><td><pre>    OnOffHelper <span class=\"token function\">sourceHelper</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::UdpSocketFactory\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">Address</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"594\"></td><td><pre>    <span class=\"token comment\">//  OnOffHelper sourceHelper (\"ns3::UdpSocketFactory\", (InetSocketAddress (interfaces.GetAddress (size-1), 9)));</span></pre></td></tr><tr><td data-num=\"595\"></td><td><pre>    sourceHelper<span class=\"token punctuation\">.</span><span class=\"token function\">SetAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Remote\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">AddressValue</span><span class=\"token punctuation\">(</span>remoteAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"596\"></td><td><pre>    sourceHelper<span class=\"token punctuation\">.</span><span class=\"token function\">SetAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"PacketSize\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">UintegerValue</span><span class=\"token punctuation\">(</span><span class=\"token number\">256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"597\"></td><td><pre>    sourceHelper<span class=\"token punctuation\">.</span><span class=\"token function\">SetAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"OnTime\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">StringValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::ConstantRandomVariable[Constant=1]\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"598\"></td><td><pre>    sourceHelper<span class=\"token punctuation\">.</span><span class=\"token function\">SetAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"OffTime\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">StringValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::ConstantRandomVariable[Constant=0]\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"599\"></td><td><pre>    sourceHelper<span class=\"token punctuation\">.</span><span class=\"token function\">SetAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DataRate\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">DataRateValue</span><span class=\"token punctuation\">(</span><span class=\"token function\">DataRate</span><span class=\"token punctuation\">(</span>dataRate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"600\"></td><td><pre>    sourceHelper<span class=\"token punctuation\">.</span><span class=\"token function\">SetAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"EnableSeqTsSizeHeader\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">BooleanValue</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"601\"></td><td><pre>    <span class=\"token comment\">// 发送节点 ->sourceHelperApp</span></pre></td></tr><tr><td data-num=\"602\"></td><td><pre>    ApplicationContainer sourceApp <span class=\"token operator\">=</span> sourceHelper<span class=\"token punctuation\">.</span><span class=\"token function\">Install</span><span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">.</span><span class=\"token function\">Get</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"603\"></td><td><pre>    sourceApp<span class=\"token punctuation\">.</span><span class=\"token function\">Get</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">TraceConnectWithoutContext</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Tx\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">MakeCallback</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>TxPacket<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"604\"></td><td><pre></pre></td></tr><tr><td data-num=\"605\"></td><td><pre>    source <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">StaticCast</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>OnOffApplication<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>sourceApp<span class=\"token punctuation\">.</span><span class=\"token function\">Get</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"606\"></td><td><pre></pre></td></tr><tr><td data-num=\"607\"></td><td><pre>    <span class=\"token comment\">// 接收应用启动时间</span></pre></td></tr><tr><td data-num=\"608\"></td><td><pre>    sinkApp<span class=\"token punctuation\">.</span><span class=\"token function\">Start</span><span class=\"token punctuation\">(</span><span class=\"token function\">Seconds</span><span class=\"token punctuation\">(</span><span class=\"token number\">3.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"609\"></td><td><pre>    <span class=\"token comment\">// 发送应用启动时间</span></pre></td></tr><tr><td data-num=\"610\"></td><td><pre>    sourceApp<span class=\"token punctuation\">.</span><span class=\"token function\">Start</span><span class=\"token punctuation\">(</span><span class=\"token function\">Seconds</span><span class=\"token punctuation\">(</span><span class=\"token number\">3.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"611\"></td><td><pre></pre></td></tr><tr><td data-num=\"612\"></td><td><pre>    <span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ConnectWithoutContext</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/NodeList/*/ApplicationList/*/$ns3::PacketSink/Rx\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">MakeCallback</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>OrrpExample<span class=\"token double-colon punctuation\">::</span>ReceivePacket<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"613\"></td><td><pre>    <span class=\"token comment\">// progress</span></pre></td></tr><tr><td data-num=\"614\"></td><td><pre>    <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Schedule</span><span class=\"token punctuation\">(</span><span class=\"token function\">Seconds</span><span class=\"token punctuation\">(</span>totalTime <span class=\"token operator\">/</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>PrintProgress<span class=\"token punctuation\">,</span> totalTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"615\"></td><td><pre></pre></td></tr><tr><td data-num=\"616\"></td><td><pre>    <span class=\"token comment\">//  Simulator::Schedule (Seconds (6.0), &amp;OrrpExample::CalculateThroughput,this,totalTime-0.5);</span></pre></td></tr><tr><td data-num=\"617\"></td><td><pre>    <span class=\"token comment\">//  Simulator::Schedule(Seconds(totalTime)-Seconds(0.1),&amp;writeData);</span></pre></td></tr><tr><td data-num=\"618\"></td><td><pre>    sinkApp<span class=\"token punctuation\">.</span><span class=\"token function\">Stop</span><span class=\"token punctuation\">(</span><span class=\"token function\">Seconds</span><span class=\"token punctuation\">(</span>totalTime<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token function\">Seconds</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"619\"></td><td><pre>    sourceApp<span class=\"token punctuation\">.</span><span class=\"token function\">Stop</span><span class=\"token punctuation\">(</span><span class=\"token function\">Seconds</span><span class=\"token punctuation\">(</span>totalTime<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token function\">Seconds</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"620\"></td><td><pre>    <span class=\"token comment\">//  printRoute(1.02017);</span></pre></td></tr><tr><td data-num=\"621\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"结果分析\"><a class=\"anchor\" href=\"#结果分析\">#</a> 结果分析</h3>\n<p>从上述的代码也可以看出 <code>ns3</code>  的仿真结果可以输出到文件，所以我们可以对文件进行操作，获取想要的结果并生成对应的图像</p>\n<h4 id=\"gawk统计\"><a class=\"anchor\" href=\"#gawk统计\">#</a> gawk 统计</h4>\n<p>我们可以通过 <code>gawk</code>  来统计文件中数据的均值以做分析。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> fillName <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'&#123;if($8!=\"-nan\")&#123;sum+=$5;size=$2+2;n+=1;delay+=$6;cost+=$7;path+=$8&#125;&#125; END &#123;print \"Pdr=\",sum/n,\"reachable =\",n/NR,\"energyCost=\",cost*size/n,\"avgCost=\",cost/n,\"pathLength=\",path/n,\"delay=\",delay/n,\"\\n\",sum/n,\"\\t\",n/NR,\"\\t\",cost*size/n,\"\\t\",cost/n\"\\t\",path/n,\"\\t\",delay/n&#125;'</span></pre></td></tr></table></figure><p>事实上同样的场景需要做多次，所以我们可以通过 <code>shell</code>  来进行 <code>seed</code>  等变量的改变，然后通过另一个 <code>shell</code>  脚本进行统计</p>\n<p>运行脚本例子如下所示：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token shebang important\">#!/bin/bash</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token assign-left variable\">NODES</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">75</span> <span class=\"token number\">100</span> <span class=\"token number\">125</span> <span class=\"token number\">150</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">INTERFACE</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">12</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">ROUTEPROTO</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span> <span class=\"token number\">4</span> <span class=\"token number\">0</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">SEEDS</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">seq</span> <span class=\"token number\">500</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">NODESMOVE</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">RANGE</span><span class=\"token operator\">=</span><span class=\"token number\">250</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">NODESLOCATIONTYPE</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">TRIALS</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token assign-left variable\">TOTALTIMES</span><span class=\"token operator\">=</span><span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">LD_LIBRARY_PATH</span><span class=\"token operator\">=</span><span class=\"token variable\">$LD_LIBRARY_PATH</span>:bin/</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">interNum</span> <span class=\"token keyword\">in</span> <span class=\"token variable\">$&#123;INTERFACE<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span>&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">nodeMove</span> <span class=\"token keyword\">in</span> <span class=\"token variable\">$&#123;NODESMOVE<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span>&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">range</span> <span class=\"token keyword\">in</span> <span class=\"token variable\">$&#123;RANGE<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span>&#125;</span> </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>          <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">size</span> <span class=\"token keyword\">in</span> <span class=\"token variable\">$&#123;NODES<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span>&#125;</span> </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">proto</span> <span class=\"token keyword\">in</span> <span class=\"token variable\">$&#123;ROUTEPROTO<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span>&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                <span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">seed</span> <span class=\"token keyword\">in</span> <span class=\"token variable\">$&#123;SEEDS<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span>&#125;</span> </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                    ./waf -v --run <span class=\"token string\">\"25dTest --nodeSize=<span class=\"token variable\">$size</span> --nodesMove=<span class=\"token variable\">$nodeMove</span> --nodesLocationType=<span class=\"token variable\">$NODESLOCATIONTYPE</span>  --seed=<span class=\"token variable\">$seed</span> --time=<span class=\"token variable\">$TOTALTIMES</span> --range=<span class=\"token variable\">$range</span> --route=<span class=\"token variable\">$proto</span> --interfaceNum=<span class=\"token variable\">$interNum</span>\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                      <span class=\"token builtin class-name\">echo</span> a task has <span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token comment\">#            sleep $TOTALTIMES</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                 <span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>             <span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            <span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token keyword\">done</span></pre></td></tr></table></figure><p>awk 统计例子如下所示：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token shebang important\">#!/bin/bash</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token assign-left variable\">NODES</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">75</span> <span class=\"token number\">100</span> <span class=\"token number\">125</span> <span class=\"token number\">150</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">INTERFACE</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">RANGE</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">TOTALTIMES</span><span class=\"token operator\">=</span><span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">ROUTEPROTO</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">LD_LIBRARY_PATH</span><span class=\"token operator\">=</span><span class=\"token variable\">$LD_LIBRARY_PATH</span>:bin/</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token variable\">$1</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\"><span class=\"token environment constant\">IFS</span></span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">echo</span> -en <span class=\"token string\">\"<span class=\"token entity\" title=\"\\n\">\\n</span><span class=\"token entity\" title=\"\\b\">\\b</span>\"</span><span class=\"token variable\">)</span></span><span class=\"token comment\">#注意这里 \\n 前面没有空格</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">interNum</span> <span class=\"token keyword\">in</span> <span class=\"token variable\">$&#123;INTERFACE<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span>&#125;</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">range</span> <span class=\"token keyword\">in</span> <span class=\"token variable\">$&#123;RANGE<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span>&#125;</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">size</span> <span class=\"token keyword\">in</span> <span class=\"token variable\">$&#123;NODES<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span>&#125;</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">proto</span> <span class=\"token keyword\">in</span> <span class=\"token variable\">$&#123;ROUTEPROTO<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span>&#125;</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                <span class=\"token assign-left variable\">pname</span><span class=\"token operator\">=</span><span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token keyword\">case</span> <span class=\"token variable\">$proto</span> <span class=\"token keyword\">in</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                    <span class=\"token assign-left variable\">pname</span><span class=\"token operator\">=</span><span class=\"token string\">\"VBF实验结果\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                    <span class=\"token assign-left variable\">resFile</span><span class=\"token operator\">=</span><span class=\"token string\">\"VBF\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                    <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                    <span class=\"token assign-left variable\">pname</span><span class=\"token operator\">=</span><span class=\"token string\">\"CORRP实验结果\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                    <span class=\"token assign-left variable\">resFile</span><span class=\"token operator\">=</span><span class=\"token string\">\"CORRP\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                    <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                    <span class=\"token assign-left variable\">pname</span><span class=\"token operator\">=</span><span class=\"token string\">\"HH VBF实验结果\"</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                    <span class=\"token assign-left variable\">resFile</span><span class=\"token operator\">=</span><span class=\"token string\">\"HH-VBF\"</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                    <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                <span class=\"token number\">3</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                    <span class=\"token assign-left variable\">pname</span><span class=\"token operator\">=</span><span class=\"token string\">\"o orrp实验结果\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                    <span class=\"token assign-left variable\">resFile</span><span class=\"token operator\">=</span><span class=\"token string\">\"ORRP\"</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                    <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                <span class=\"token number\">4</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                    <span class=\"token assign-left variable\">pname</span><span class=\"token operator\">=</span><span class=\"token string\">\"vorrp实验结果\"</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                    <span class=\"token assign-left variable\">resFile</span><span class=\"token operator\">=</span><span class=\"token string\">\"VORR\"</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                    <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                <span class=\"token number\">5</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                    <span class=\"token assign-left variable\">pname</span><span class=\"token operator\">=</span><span class=\"token string\">\"R-orrp实验结果\"</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                    <span class=\"token assign-left variable\">resFile</span><span class=\"token operator\">=</span><span class=\"token string\">\"RORR\"</span>                   </pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                    <span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                <span class=\"token keyword\">esac</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                <span class=\"token comment\">#echo $RANGE\"m 范围 -\"$size\"节点 -\"$interNum\"interfaceNum-\"$TOTALTIMES\"S\"--$pname</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                <span class=\"token comment\">#cat $RANGE\"m 范围 -\"$size\"节点 -\"$interNum\"interfaceNum-\"$TOTALTIMES\"S\"--$&#123;pname&#125; | awk '&#123;if ($8!=\"-nan\")&#123;sum+=$5;size=$2+2;n+=1;delay+=$6;cost+=$7;path+=$8&#125;&#125; END &#123;print \"Pdr=\",sum/n,\"reachable =\",n/NR,\"energyCost=\",cost*size/n,\"avgCost=\",cost/n,\"pathLength=\",path/n,\"delay=\",delay/n,\"\\n\",sum/n,\"\\t\",n/NR,\"\\t\",cost*size/n,\"\\t\",cost/n\"\\t\",path/n,\"\\t\",delay/n&#125;'</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                <span class=\"token function\">cat</span> <span class=\"token variable\">$RANGE</span><span class=\"token string\">\"m范围-\"</span><span class=\"token variable\">$size</span><span class=\"token string\">\"节点-\"</span><span class=\"token variable\">$interNum</span><span class=\"token string\">\"interfaceNum-\"</span><span class=\"token variable\">$TOTALTIMES</span><span class=\"token string\">\"S\"</span>--<span class=\"token variable\">$&#123;pname&#125;</span> <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'&#123;if($8!=\"-nan\")&#123;sum+=$5;size=$2+2;n+=1;delay+=$6;cost+=$7;path+=$8&#125;&#125; END &#123;print size-2,\"\\t\",sum/n,\"\\t\",n/NR,\"\\t\",cost*size/n,\"\\t\",cost/n\"\\t\",path/n,\"\\t\",delay/n&#125;'</span><span class=\"token operator\">>></span><span class=\"token variable\">$&#123;resFile&#125;</span>.txt</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                <span class=\"token comment\">#echo a task has done</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                <span class=\"token builtin class-name\">echo</span> a task has <span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            <span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token assign-left variable\"><span class=\"token environment constant\">IFS</span></span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">echo</span> -en <span class=\"token string\">\" <span class=\"token entity\" title=\"\\n\">\\n</span><span class=\"token entity\" title=\"\\t\">\\t</span>\"</span><span class=\"token variable\">)</span></span><span class=\"token comment\">#注意这里 \\n 前面有个空格</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"end\"</span></pre></td></tr></table></figure><h4 id=\"gnuplot绘制结果图\"><a class=\"anchor\" href=\"#gnuplot绘制结果图\">#</a> gnuplot 绘制结果图</h4>\n<p>我们可以采用类似于这样的脚本来绘制图像</p>\n<pre><code>set style line 80 lt rgb &quot;#000000&quot; lw 5\nset style line 81 lt 0  # dashed\nset style line 81 lt rgb &quot;#000000&quot;  # grey\nset grid back linestyle 81\nset ytics 0.1\nset xtics 5\nset style line 1 lt rgb &quot;#00A000&quot; lw 2 pt 9 pointsize 2\nset style line 2 lt rgb &quot;#A00000&quot; lw 2 pt 11 pointsize 2\nset style line 3 lt rgb &quot;#5060D0&quot; lw 2 pt 1 pointsize 2\nset style line 4 lt rgb &quot;#F25900&quot; lw 2 pt 2 pointsize 2\nset style line 5 lt rgb &quot;#A00000&quot; lw 1 pt 8 pointsize 2\nset style line 6 lt rgb &quot;#00A000&quot; lw 1 pt 2 pointsize 2\nset style line 7 lt rgb &quot;#5060D0&quot; lw 1 pt 4 pointsize 2\nset style line 8 lt rgb &quot;#F25900&quot; lw 1 pt 6 pointsize 2\n\n\n#set output &quot;.pdf&quot;\nset xlabel &quot;Numbers of nodes&quot; font &quot;,20&quot;\nset ylabel &quot;Packet delivery ratio(%)&quot; font &quot;,20&quot; offset 1.5,0,0\nset key at 85,0.4 font &quot;,20&quot; height 0.9 width 0.5 spacing 1\nset key box \nset xrange [40:90]\nset yrange [0:1]\nplot  &quot;0.5-20-15-orrp2d.txt&quot; u 1:2 title &quot;RR&quot; w lp ls 2, &quot;0.5-20-15-o-orrp.txt&quot; u 1:2 title &quot;ORRP&quot; w lp ls 1,  &quot;0.5-20-15-R-ORR.txt&quot; u 1:2 title &quot;  R-ORR&quot; w lp ls 7, &quot;v-orrp.txt&quot; u 1:2 title &quot;  V-ORR&quot; w lp ls 8\nset terminal postscript eps color solid linewidth 2 &quot;Helvetica&quot; 20\nset output &quot;pdr.eps&quot;\nreplot\nset output\n</code></pre>\n<p><img data-src=\"https://yeyu-blog.oss-cn-beijing.aliyuncs.com/article_images/gnuplot%E7%BB%98%E5%9B%BE%E4%BE%8B%E5%AD%90.jpg\" alt=\"绘图例子\" /></p>\n",
            "tags": [
                "ns3",
                "ns3"
            ]
        },
        {
            "id": "http://jluyeyu.com/ns3/9.ns3%20Config%E7%B1%BBAPI%E8%AF%B4%E6%98%8E/",
            "url": "http://jluyeyu.com/ns3/9.ns3%20Config%E7%B1%BBAPI%E8%AF%B4%E6%98%8E/",
            "title": "9.ns3 Config类API说明",
            "date_published": "2022-11-02T04:00:00.000Z",
            "content_html": "<h2 id=\"9ns3-config类api说明\"><a class=\"anchor\" href=\"#9ns3-config类api说明\">#</a> 9.ns3 Config 类 API 说明</h2>\n<p>在本节中，将介绍 <code>ns3</code>  中 <code>Config</code>  类的使用， <code>它可以用来配置仿真参数和跟踪，在统计结果方面十分有用</code></p>\n<p>源文件位置：<br />\n <code>src/core/model/config.h</code> <br />\n <code>config.cc</code></p>\n<h3 id=\"函数原型\"><a class=\"anchor\" href=\"#函数原型\">#</a> 函数原型</h3>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span>    ns3<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Connect</span> <span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>string path<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> CallbackBase <span class=\"token operator\">&amp;</span>cb<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>此函数将尝试查找与输入路径匹配的所有跟踪源，然后将输入回调连接到它们，以使回调在跟踪事件通知时接收到一个额外的上下文字符串。</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">void</span>    ns3<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ConnectWithoutContext</span> <span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>string path<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> CallbackBase <span class=\"token operator\">&amp;</span>cb<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>此函数将尝试查找与输入路径匹配的所有跟踪源，然后将输入回调连接到它们。</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">void</span>    ns3<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Disconnect</span> <span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>string path<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> CallbackBase <span class=\"token operator\">&amp;</span>cb<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>此函数撤消Config <span class=\"token double-colon punctuation\">::</span> ConnectWithContext的工作。</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">void</span>    ns3<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">DisconnectWithoutContext</span> <span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>string path<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> CallbackBase <span class=\"token operator\">&amp;</span>cb<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>此函数撤消Config <span class=\"token double-colon punctuation\">::</span> Connect的工作。</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>Ptr<span class=\"token operator\">&lt;</span> Object <span class=\"token operator\">></span>   ns3<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">GetRootNamespaceObject</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">uint32_t</span> i<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>请求的根命名空间对象</pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token keyword\">uint32_t</span>    ns3<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">GetRootNamespaceObjectN</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>注册的根命名空间对象的数量。</pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>Config<span class=\"token double-colon punctuation\">::</span>MatchContainer  ns3<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">LookupMatches</span> <span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>string path<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>包含与输入路径匹配的所有对象的容器。</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token keyword\">void</span>    ns3<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">RegisterRootNamespaceObject</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span> Object <span class=\"token operator\">></span> obj<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>每个根对象在路径匹配期间用作Config <span class=\"token double-colon punctuation\">::</span> Connect和Config <span class=\"token double-colon punctuation\">::</span> Set的路径的根。</pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token keyword\">void</span>    ns3<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Reset</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    Reset the initial value of every attribute as well as the value of </pre></td></tr><tr><td data-num=\"35\"></td><td><pre>       every global to what they were before any call to SetDefault <span class=\"token operator\">and</span> SetGlobal<span class=\"token punctuation\">.</span> </pre></td></tr><tr><td data-num=\"36\"></td><td><pre>将每个属性的初始值以及每个全局的值重置为在调用SetDefault和SetGlobal之前的值。</pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token keyword\">void</span>    ns3<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Set</span> <span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>string path<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> AttributeValue <span class=\"token operator\">&amp;</span>value<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>此函数将尝试查找与输入路径匹配的属性，然后将其值设置为输入值。</pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token keyword\">void</span>    ns3<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SetDefault</span> <span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>string name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> AttributeValue <span class=\"token operator\">&amp;</span>value<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>此方法覆盖匹配属性的初始值。 此方法不能失败：如果输入属性名称或值无效，它将崩溃。</pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token keyword\">bool</span>    ns3<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SetDefaultFailSafe</span> <span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>string name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> AttributeValue <span class=\"token operator\">&amp;</span>value<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>如果值设置成功，则为<span class=\"token boolean\">true</span>，否则为<span class=\"token boolean\">false</span>。</pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token keyword\">void</span>    ns3<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SetGlobal</span> <span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>string name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> AttributeValue <span class=\"token operator\">&amp;</span>value<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>此方法等同于GlobalValue <span class=\"token double-colon punctuation\">::</span> Bind</pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token keyword\">bool</span>    ns3<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SetGlobalFailSafe</span> <span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>string name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> AttributeValue <span class=\"token operator\">&amp;</span>value<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>如果可以设置GlobalValue，则为<span class=\"token boolean\">true</span>。</pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token keyword\">void</span>    ns3<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">UnregisterRootNamespaceObject</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span> Object <span class=\"token operator\">></span> obj<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>此函数撤消Config <span class=\"token double-colon punctuation\">::</span> RegisterRootNamespaceObject的工作。</pre></td></tr></table></figure><h3 id=\"用法实例\"><a class=\"anchor\" href=\"#用法实例\">#</a> 用法实例</h3>\n<h4 id=\"connect函数的用法\"><a class=\"anchor\" href=\"#connect函数的用法\">#</a> Connect 函数的用法：</h4>\n<p>第二个参数是回调函数，回调函数的参数根据第一个参数的属性来设置。需要注意的是，第二个参数所设置的回调函数，其第一个参数是 string 类型的 context。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Connect</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"/NodeList/*/DeviceList/*/Mac/MacTx\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>DevTxTrace<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Connect</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"/NodeList/*/DeviceList/*/Mac/MacRx\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>DevRxTrace<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Connect</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"/NodeList/*/DeviceList/*/Phy/State/RxOk\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>PhyRxOkTrace<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Connect</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"/NodeList/*/DeviceList/*/Phy/State/RxError\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>PhyRxErrorTrace<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Connect</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"/NodeList/*/DeviceList/*/Phy/State/Tx\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>PhyTxTrace<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Connect</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"/NodeList/*/DeviceList/*/Phy/State/State\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>PhyStateTrace<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token function\">DevTxTrace</span> <span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>string context<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> Packet<span class=\"token operator\">></span> p<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>g_verbose<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" TX p: \"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">*</span>p <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token function\">DevRxTrace</span> <span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>string context<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> Packet<span class=\"token operator\">></span> p<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>g_verbose<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" RX p: \"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">*</span>p <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token function\">PhyRxOkTrace</span> <span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>string context<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span> <span class=\"token keyword\">double</span> snr<span class=\"token punctuation\">,</span> WifiMode mode<span class=\"token punctuation\">,</span> <span class=\"token keyword\">enum</span> <span class=\"token class-name\">WifiPreamble</span> preamble<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>g_verbose<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"PHYRXOK mode=\"</span> <span class=\"token operator\">&lt;&lt;</span> mode <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" snr=\"</span> <span class=\"token operator\">&lt;&lt;</span> snr <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" \"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">*</span>packet <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"connectwithoutcontext的用法\"><a class=\"anchor\" href=\"#connectwithoutcontext的用法\">#</a> ConnectWithoutContext 的用法：</h4>\n<p>第二个参数是回调函数，参数的设置依赖与第一个参数设置的属性。与 Connect 函数不同的是，这里的回调函数的第一个参数没有 string 类型的 context。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ConnectWithoutContext</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"/NodeList/0/DeviceList/*/Phy/MonitorSnifferRx\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>MonitorSniffRx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">MonitorSniffRx</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> Packet<span class=\"token operator\">></span> packet<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint16_t</span> channelFreqMhz<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                     <span class=\"token keyword\">uint16_t</span> channelNumber<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint32_t</span> rate<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                     WifiPreamble preamble<span class=\"token punctuation\">,</span> WifiTxVector txVector<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                     <span class=\"token keyword\">struct</span> <span class=\"token class-name\">mpduInfo</span> aMpdu<span class=\"token punctuation\">,</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">signalNoiseDbm</span> signalNoise<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  g_samples<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  g_signalDbmAvg <span class=\"token operator\">+=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>signalNoise<span class=\"token punctuation\">.</span>signal <span class=\"token operator\">-</span> g_signalDbmAvg<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> g_samples<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  g_noiseDbmAvg <span class=\"token operator\">+=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>signalNoise<span class=\"token punctuation\">.</span>noise <span class=\"token operator\">-</span> g_noiseDbmAvg<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> g_samples<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  g_rate <span class=\"token operator\">=</span> rate<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  g_channelNumber <span class=\"token operator\">=</span> channelNumber<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"setglobal的用法\"><a class=\"anchor\" href=\"#setglobal的用法\">#</a> SetGlobal 的用法：</h4>\n<p>这与 SetGlobalFailSafe 函数的用法类似。设置全局值。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SetGlobal</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"SimulatorImplementationType\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">StringValue</span> <span class=\"token punctuation\">(</span>m_simulatorType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"setdefault函数的用法\"><a class=\"anchor\" href=\"#setdefault函数的用法\">#</a> SetDefault 函数的用法：</h4>\n<p>这与 SetDefaultFailSafe 函数用法类似。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SetDefault</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::WifiRemoteStationManager::RtsCtsThreshold\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">StringValue</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"0\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token comment\">// disable fragmentation</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SetDefault</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::WifiRemoteStationManager::FragmentationThreshold\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">StringValue</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"2200\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"set函数的用法\"><a class=\"anchor\" href=\"#set函数的用法\">#</a> Set 函数的用法：</h4>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Set</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"/NodeList/*/DeviceList/*/$ns3::WifiNetDevice/Mac/Slot\"</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>              <span class=\"token function\">TimeValue</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MicroSeconds</span> <span class=\"token punctuation\">(</span>slot<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Set</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"/NodeList/*/DeviceList/*/$ns3::WifiNetDevice/Mac/Sifs\"</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>              <span class=\"token function\">TimeValue</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MicroSeconds</span> <span class=\"token punctuation\">(</span>sifs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Set</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"/NodeList/*/DeviceList/*/$ns3::WifiNetDevice/Mac/AckTimeout\"</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>              <span class=\"token function\">TimeValue</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MicroSeconds</span> <span class=\"token punctuation\">(</span>ackTimeout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Set</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"/NodeList/*/DeviceList/*/$ns3::WifiNetDevice/Mac/CtsTimeout\"</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>              <span class=\"token function\">TimeValue</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MicroSeconds</span> <span class=\"token punctuation\">(</span>ctsTimeout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Set</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"/NodeList/*/DeviceList/*/$ns3::WifiNetDevice/Mac/Rifs\"</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>              <span class=\"token function\">TimeValue</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MicroSeconds</span> <span class=\"token punctuation\">(</span>rifs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Set</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"/NodeList/*/DeviceList/*/$ns3::WifiNetDevice/Mac/BasicBlockAckTimeout\"</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>             <span class=\"token function\">TimeValue</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MicroSeconds</span> <span class=\"token punctuation\">(</span>basicBlockAckTimeout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Set</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"/NodeList/*/DeviceList/*/$ns3::WifiNetDevice/Mac/CompressedBlockAckTimeout\"</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>             <span class=\"token function\">TimeValue</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MicroSeconds</span> <span class=\"token punctuation\">(</span>compressedBlockAckTimeout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure>",
            "tags": [
                "ns3",
                "ns3"
            ]
        },
        {
            "id": "http://jluyeyu.com/ns3/8.ns3%20wifi%E8%AE%BE%E5%A4%87%E5%AE%9A%E5%90%91%E5%8F%91%E9%80%81%E7%9A%84%E5%AE%9E%E7%8E%B0/",
            "url": "http://jluyeyu.com/ns3/8.ns3%20wifi%E8%AE%BE%E5%A4%87%E5%AE%9A%E5%90%91%E5%8F%91%E9%80%81%E7%9A%84%E5%AE%9E%E7%8E%B0/",
            "title": "8.ns3 wifi设备定向发送的实现",
            "date_published": "2022-11-02T02:00:00.000Z",
            "content_html": "<h2 id=\"8ns3-wifi设备定向发送的实现\"><a class=\"anchor\" href=\"#8ns3-wifi设备定向发送的实现\">#</a> 8.ns3 wifi 设备定向发送的实现</h2>\n<p>在本节中，将介绍 <code>ns3</code>  中 wifi 设备定向发送的实现方案</p>\n<h3 id=\"起因\"><a class=\"anchor\" href=\"#起因\">#</a> 起因</h3>\n<p>由于研究需求，需要用到节点具有定向发送，全向接收的功能，但 ns3 自带的功能没有定向实现，所以就写了一种定向的实现方法。</p>\n<h3 id=\"修改思路\"><a class=\"anchor\" href=\"#修改思路\">#</a> 修改思路</h3>\n<p>第一想法是修改天线模块的代码，使其完成定向的功能，但是看了以下源码，感觉实现难度较大，修改比较困难，故 <code>pass</code>  了<br />\n第二想法是修改物理层或者数据链路层，在节点收到数据包时，底层判断发送节点的位置与接收节点的位置，只接收从指定方向传来的数据包，从而实现定向接收的功能。</p>\n<p>于是就开始找数据发送的函数，与数据接收的处理函数，<br />\n最终发现在 <code>yans-wifi-channel.cc</code>  里发现有 <code>send</code>  函数和 <code>receive</code>  函数<br />\n <code>yans-wifi-channel.cc</code> :</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token class-name\">YansWifiChannel</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>YansWifiPhy<span class=\"token operator\">></span> sender<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> WifiPpdu<span class=\"token operator\">></span> ppdu<span class=\"token punctuation\">,</span> <span class=\"token keyword\">double</span> txPowerDbm<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> sender <span class=\"token operator\">&lt;&lt;</span> ppdu <span class=\"token operator\">&lt;&lt;</span> txPowerDbm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   Ptr<span class=\"token operator\">&lt;</span>MobilityModel<span class=\"token operator\">></span> senderMobility <span class=\"token operator\">=</span> sender<span class=\"token operator\">-></span><span class=\"token function\">GetMobility</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>senderMobility <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>PhyList<span class=\"token double-colon punctuation\">::</span>const_iterator i <span class=\"token operator\">=</span> m_phyList<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">!=</span> m_phyList<span class=\"token punctuation\">.</span><span class=\"token function\">end</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>     <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>       <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sender <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>         <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>           <span class=\"token comment\">//For now don't account for inter channel interference nor channel bonding</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>           <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>i<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetChannelNumber</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> sender<span class=\"token operator\">-></span><span class=\"token function\">GetChannelNumber</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>             <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>               <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>             <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>           Ptr<span class=\"token operator\">&lt;</span>MobilityModel<span class=\"token operator\">></span> receiverMobility <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>i<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetMobility</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token generic-function\"><span class=\"token function\">GetObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>MobilityModel<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>           Time delay <span class=\"token operator\">=</span> m_delay<span class=\"token operator\">-></span><span class=\"token function\">GetDelay</span> <span class=\"token punctuation\">(</span>senderMobility<span class=\"token punctuation\">,</span> receiverMobility<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>           <span class=\"token keyword\">double</span> rxPowerDbm <span class=\"token operator\">=</span> m_loss<span class=\"token operator\">-></span><span class=\"token function\">CalcRxPower</span> <span class=\"token punctuation\">(</span>txPowerDbm<span class=\"token punctuation\">,</span> senderMobility<span class=\"token punctuation\">,</span> receiverMobility<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>           <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"propagation: txPower=\"</span> <span class=\"token operator\">&lt;&lt;</span> txPowerDbm <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"dbm, rxPower=\"</span> <span class=\"token operator\">&lt;&lt;</span> rxPowerDbm <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"dbm, \"</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                         <span class=\"token string\">\"distance=\"</span> <span class=\"token operator\">&lt;&lt;</span> senderMobility<span class=\"token operator\">-></span><span class=\"token function\">GetDistanceFrom</span> <span class=\"token punctuation\">(</span>receiverMobility<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"m, delay=\"</span> <span class=\"token operator\">&lt;&lt;</span> delay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>           Ptr<span class=\"token operator\">&lt;</span>WifiPpdu<span class=\"token operator\">></span> copy <span class=\"token operator\">=</span> <span class=\"token function\">Copy</span> <span class=\"token punctuation\">(</span>ppdu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>           Ptr<span class=\"token operator\">&lt;</span>NetDevice<span class=\"token operator\">></span> dstNetDevice <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>i<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetDevice</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>           <span class=\"token keyword\">uint32_t</span> dstNode<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>           <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dstNetDevice <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>             <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>               dstNode <span class=\"token operator\">=</span> <span class=\"token number\">0xffffffff</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>             <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>           <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>             <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>               dstNode <span class=\"token operator\">=</span> dstNetDevice<span class=\"token operator\">-></span><span class=\"token function\">GetNode</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetId</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>             <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>           <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ScheduleWithContext</span> <span class=\"token punctuation\">(</span>dstNode<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                                           delay<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>YansWifiChannel<span class=\"token double-colon punctuation\">::</span>Receive<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                                           <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> copy<span class=\"token punctuation\">,</span> rxPowerDbm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>         <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>     <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre> <span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre> <span class=\"token class-name\">YansWifiChannel</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Receive</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>YansWifiPhy<span class=\"token operator\">></span> phy<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span>WifiPpdu<span class=\"token operator\">></span> ppdu<span class=\"token punctuation\">,</span> <span class=\"token keyword\">double</span> rxPowerDbm<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>   <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span>phy <span class=\"token operator\">&lt;&lt;</span> ppdu <span class=\"token operator\">&lt;&lt;</span> rxPowerDbm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>   <span class=\"token comment\">// Do no further processing if signal is too weak</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>   <span class=\"token comment\">// Current implementation assumes constant RX power over the PPDU duration</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>   <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>rxPowerDbm <span class=\"token operator\">+</span> phy<span class=\"token operator\">-></span><span class=\"token function\">GetRxGain</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> phy<span class=\"token operator\">-></span><span class=\"token function\">GetRxSensitivity</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>     <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>       <span class=\"token function\">NS_LOG_INFO</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Received signal too weak to process: \"</span> <span class=\"token operator\">&lt;&lt;</span> rxPowerDbm <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" dBm\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>       <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>     <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>   RxPowerWattPerChannelBand rxPowerW<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>   rxPowerW<span class=\"token punctuation\">.</span><span class=\"token function\">insert</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">make_pair</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token function\">DbmToW</span> <span class=\"token punctuation\">(</span>rxPowerDbm <span class=\"token operator\">+</span> phy<span class=\"token operator\">-></span><span class=\"token function\">GetRxGain</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//dummy band for YANS</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>   phy<span class=\"token operator\">-></span><span class=\"token function\">StartReceivePreamble</span> <span class=\"token punctuation\">(</span>ppdu<span class=\"token punctuation\">,</span> rxPowerW<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>阅读源码可以发现， <code>ns3</code>  中发送数据包的流程如下，遍历与发送数据包的节点物理层 ( <code>YanWifiPhy</code> ) 相连的节点。根据每个邻居节点与发送节点之间的距离和衰减模型中定义的公式来计算衰减。然后回调 <code>receive</code>  函数，来判断衰减后是否可以被接收。这为我们的想法提供了很好的条件。因为发送和接收节点的位置信息是可以由 <code>MobilityModel</code>  得到的，而控制是否接收该数据包，也可以通过修改衰减或者之间控制是否进行回调来解决。</p>\n<h3 id=\"第一版代码\"><a class=\"anchor\" href=\"#第一版代码\">#</a> 第一版代码</h3>\n<p>所以自然而然的，第一版定向天线的代码就出来了<br />\n只需要在 send 函数里，计算以下发送节点与接收节点之间形成的方向向量与自定义的坐标轴之间的夹角，然后，控制指定方向内的向量衰竭结果不变，其余方向的衰减结果减去一个大值即可。即通过衰减来实现其他方向的节点无法收到数据</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">YansWifiChannel</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Send</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>YansWifiPhy<span class=\"token operator\">></span> sender<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> WifiPpdu<span class=\"token operator\">></span> ppdu<span class=\"token punctuation\">,</span> <span class=\"token keyword\">double</span> txPowerDbm<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">NS_LOG_FUNCTION</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">&lt;&lt;</span> sender <span class=\"token operator\">&lt;&lt;</span> ppdu <span class=\"token operator\">&lt;&lt;</span> txPowerDbm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>MobilityModel<span class=\"token operator\">></span> senderMobility <span class=\"token operator\">=</span> sender<span class=\"token operator\">-></span><span class=\"token function\">GetMobility</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token function\">NS_ASSERT</span> <span class=\"token punctuation\">(</span>senderMobility <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>PhyList<span class=\"token double-colon punctuation\">::</span>const_iterator i <span class=\"token operator\">=</span> m_phyList<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">!=</span> m_phyList<span class=\"token punctuation\">.</span><span class=\"token function\">end</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sender <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          <span class=\"token comment\">//For now don't account for inter channel interference nor channel bonding</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>i<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetChannelNumber</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> sender<span class=\"token operator\">-></span><span class=\"token function\">GetChannelNumber</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>          Ptr<span class=\"token operator\">&lt;</span>MobilityModel<span class=\"token operator\">></span> receiverMobility <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>i<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetMobility</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token generic-function\"><span class=\"token function\">GetObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>MobilityModel<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>          Time delay <span class=\"token operator\">=</span> m_delay<span class=\"token operator\">-></span><span class=\"token function\">GetDelay</span> <span class=\"token punctuation\">(</span>senderMobility<span class=\"token punctuation\">,</span> receiverMobility<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          <span class=\"token keyword\">double</span> rxPowerDbm <span class=\"token operator\">=</span> m_loss<span class=\"token operator\">-></span><span class=\"token function\">CalcRxPower</span> <span class=\"token punctuation\">(</span>txPowerDbm<span class=\"token punctuation\">,</span> senderMobility<span class=\"token punctuation\">,</span> receiverMobility<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"propagation: txPower=\"</span> <span class=\"token operator\">&lt;&lt;</span> txPowerDbm <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"dbm, rxPower=\"</span> <span class=\"token operator\">&lt;&lt;</span> rxPowerDbm <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"dbm, \"</span> <span class=\"token operator\">&lt;&lt;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                        <span class=\"token string\">\"distance=\"</span> <span class=\"token operator\">&lt;&lt;</span> senderMobility<span class=\"token operator\">-></span><span class=\"token function\">GetDistanceFrom</span> <span class=\"token punctuation\">(</span>receiverMobility<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"m, delay=\"</span> <span class=\"token operator\">&lt;&lt;</span> delay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          <span class=\"token comment\">//motified by yeyu</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          <span class=\"token comment\">// 发送节点的位置</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          Vector sendVector<span class=\"token operator\">=</span>senderMobility<span class=\"token operator\">-></span><span class=\"token function\">GetPosition</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          Vector sendVelocityVector<span class=\"token operator\">=</span>senderMobility<span class=\"token operator\">-></span><span class=\"token function\">GetVelocity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          <span class=\"token comment\">// 接收节点的位置</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          Vector receiverVector<span class=\"token operator\">=</span>receiverMobility<span class=\"token operator\">-></span><span class=\"token function\">GetPosition</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          Vector receiverVelocityVector<span class=\"token operator\">=</span>receiverMobility<span class=\"token operator\">-></span><span class=\"token function\">GetVelocity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>          <span class=\"token function\">NS_LOG_INFO</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"发送节点坐标:\"</span><span class=\"token operator\">&lt;&lt;</span>sendVector<span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">\"  速度矢量:\"</span><span class=\"token operator\">&lt;&lt;</span>sendVelocityVector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          <span class=\"token function\">NS_LOG_INFO</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"接收节点坐标:\"</span><span class=\"token operator\">&lt;&lt;</span>receiverVector<span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">\"  速度矢量:\"</span><span class=\"token operator\">&lt;&lt;</span>receiverVelocityVector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>         <span class=\"token comment\">// double angel=atan(receiverVector.x-sendVector.x,receiverVector.y-sendVector.y);</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>         <span class=\"token keyword\">double</span> tan<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>receiverVector<span class=\"token punctuation\">.</span>y<span class=\"token operator\">-</span>sendVector<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token punctuation\">(</span>receiverVector<span class=\"token punctuation\">.</span>x<span class=\"token operator\">-</span>sendVector<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          <span class=\"token keyword\">double</span> angel<span class=\"token operator\">=</span><span class=\"token function\">atan</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>receiverVector<span class=\"token punctuation\">.</span>y<span class=\"token operator\">-</span>sendVector<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token punctuation\">(</span>receiverVector<span class=\"token punctuation\">.</span>x<span class=\"token operator\">-</span>sendVector<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          angel<span class=\"token operator\">=</span>angel<span class=\"token operator\">*</span><span class=\"token number\">180</span><span class=\"token operator\">/</span>M_PI<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>angel<span class=\"token operator\">&lt;</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            angel<span class=\"token operator\">=</span>angel<span class=\"token operator\">+</span><span class=\"token number\">360</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          <span class=\"token keyword\">double</span> angelLimit<span class=\"token operator\">=</span>sender<span class=\"token operator\">-></span><span class=\"token function\">getAngel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          <span class=\"token keyword\">int</span> canSend<span class=\"token operator\">=</span><span class=\"token function\">NondirectionalLoss</span><span class=\"token punctuation\">(</span>angel<span class=\"token punctuation\">,</span>angelLimit<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          <span class=\"token function\">NS_LOG_INFO</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tan:\"</span><span class=\"token operator\">&lt;&lt;</span>tan<span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">\" angel: \"</span><span class=\"token operator\">&lt;&lt;</span>angel<span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">\" canSend:\"</span><span class=\"token operator\">&lt;&lt;</span>canSend<span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"angel limit:\"</span><span class=\"token operator\">&lt;&lt;</span> angelLimit<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          <span class=\"token comment\">// 上下左右，每个方向 2*theta 度的接收角 (theta&lt;45)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>         <span class=\"token comment\">// rxPowerDbm=rxPowerDbm-NondirectionalLoss(angel,5);</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>canSend<span class=\"token operator\">!=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            <span class=\"token function\">NS_LOG_INFO</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"不在指定方向内，跳过\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          <span class=\"token comment\">//motified by yeyu</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          Ptr<span class=\"token operator\">&lt;</span>WifiPpdu<span class=\"token operator\">></span> copy <span class=\"token operator\">=</span> <span class=\"token function\">Copy</span> <span class=\"token punctuation\">(</span>ppdu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          Ptr<span class=\"token operator\">&lt;</span>NetDevice<span class=\"token operator\">></span> dstNetDevice <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>i<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetDevice</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>          <span class=\"token keyword\">uint32_t</span> dstNode<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dstNetDevice <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>              dstNode <span class=\"token operator\">=</span> <span class=\"token number\">0xffffffff</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>          <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>              dstNode <span class=\"token operator\">=</span> dstNetDevice<span class=\"token operator\">-></span><span class=\"token function\">GetNode</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetId</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ScheduleWithContext</span> <span class=\"token punctuation\">(</span>dstNode<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                                          delay<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>YansWifiChannel<span class=\"token double-colon punctuation\">::</span>Receive<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                                          <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> copy<span class=\"token punctuation\">,</span> rxPowerDbm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>其中  <code>NondirectionalLoss</code>  是自定义的控制接收角度的函数，规定向下为 0 度，逆时针方向增长，angel 范围 0-360 度，theta 是上下左右四个方向接收角度的一半</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">NondirectionalLoss</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> angel<span class=\"token punctuation\">,</span><span class=\"token keyword\">double</span> theta<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>theta<span class=\"token operator\">&lt;</span>angel <span class=\"token operator\">&amp;&amp;</span> angel <span class=\"token operator\">&lt;</span><span class=\"token number\">90</span><span class=\"token operator\">-</span>theta<span class=\"token punctuation\">)</span><span class=\"token function\">or</span><span class=\"token punctuation\">(</span><span class=\"token number\">90</span><span class=\"token operator\">+</span>theta<span class=\"token operator\">&lt;</span>angel <span class=\"token operator\">&amp;&amp;</span> angel<span class=\"token operator\">&lt;</span><span class=\"token number\">180</span><span class=\"token operator\">-</span>theta<span class=\"token punctuation\">)</span><span class=\"token function\">or</span><span class=\"token punctuation\">(</span><span class=\"token number\">180</span><span class=\"token operator\">+</span>theta<span class=\"token operator\">&lt;</span>angel <span class=\"token operator\">&amp;&amp;</span> angel<span class=\"token operator\">&lt;</span><span class=\"token number\">270</span><span class=\"token operator\">-</span>theta<span class=\"token punctuation\">)</span><span class=\"token function\">or</span><span class=\"token punctuation\">(</span><span class=\"token number\">270</span><span class=\"token operator\">+</span>theta<span class=\"token operator\">&lt;</span>angel <span class=\"token operator\">&amp;&amp;</span> angel<span class=\"token operator\">&lt;</span><span class=\"token number\">360</span><span class=\"token operator\">-</span>theta<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token number\">999999</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这样修改完之后，确实可以定向发送，但是存在一个问题，所有的节点都是这样。没法单独设置单个节点。显然不能满足需求。于是接下来需要进一步修改。</p>\n<h3 id=\"改进方案\"><a class=\"anchor\" href=\"#改进方案\">#</a> 改进方案</h3>\n<p>观察 send 函数，可以发现它是遍历 <code>YansWifiPhy</code> , 大胆猜测，每个节点都有与之对应的 <code>YansWifiPhy</code> 。经过验证确实如此。<br />\n那么下面的任务就简单了，修改 <code>YansWifiPhy</code>  的源码，添加几个自定义的变量，对外提供对应的 <code>get,set</code>  函数。就可以修改指定节点的发送范围。</p>\n<p>但是又出现了新的问题，如何获得单个节点的 <code>YansWifiPhy</code>  呢？<br />\n由于 <code>ns3</code>  封装的很好，不提供对单个节点 <code>YansWifiPhy</code>  的访问。<br />\n一个想法是找到绑定 <code>node</code>  与 <code>YansWifiPhy</code>  的地方，自己提供对外访问的方法。<br />\n于是就找到了 <code>YansWifiHelper</code> , 从源码可以看出，就是这了，每个 <code>node</code>  都有与之对应的 <code>YansWifiPhyHelper</code> 。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Ptr<span class=\"token operator\">&lt;</span>WifiPhy<span class=\"token operator\">></span> <span class=\"token class-name\">YansWifiPhyHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Create</span> <span class=\"token punctuation\">(</span>Ptr<span class=\"token operator\">&lt;</span>Node<span class=\"token operator\">></span> node<span class=\"token punctuation\">,</span> Ptr<span class=\"token operator\">&lt;</span>NetDevice<span class=\"token operator\">></span> device<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>YansWifiPhy<span class=\"token operator\">></span> phy <span class=\"token operator\">=</span> m_phy<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>YansWifiPhy<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>ErrorRateModel<span class=\"token operator\">></span> error <span class=\"token operator\">=</span> m_errorRateModel<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>ErrorRateModel<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  phy<span class=\"token operator\">-></span><span class=\"token function\">SetErrorRateModel</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_frameCaptureModel<span class=\"token punctuation\">.</span><span class=\"token function\">IsTypeIdSet</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      Ptr<span class=\"token operator\">&lt;</span>FrameCaptureModel<span class=\"token operator\">></span> capture <span class=\"token operator\">=</span> m_frameCaptureModel<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>FrameCaptureModel<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      phy<span class=\"token operator\">-></span><span class=\"token function\">SetFrameCaptureModel</span> <span class=\"token punctuation\">(</span>capture<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_preambleDetectionModel<span class=\"token punctuation\">.</span><span class=\"token function\">IsTypeIdSet</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      Ptr<span class=\"token operator\">&lt;</span>PreambleDetectionModel<span class=\"token operator\">></span> capture <span class=\"token operator\">=</span> m_preambleDetectionModel<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>PreambleDetectionModel<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      phy<span class=\"token operator\">-></span><span class=\"token function\">SetPreambleDetectionModel</span> <span class=\"token punctuation\">(</span>capture<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  phy<span class=\"token operator\">-></span><span class=\"token function\">SetChannel</span> <span class=\"token punctuation\">(</span>m_channel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  phy<span class=\"token operator\">-></span><span class=\"token function\">SetDevice</span> <span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token keyword\">return</span> phy<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>那么接下来的事情就很简单了，在 <code>YansWifiHelper</code>  里添加一个存储 <code>YansWifiPhy</code>  的 <code>vector</code> , 在 <code>send</code>  函数里将获得的 <code>YansWifiPhy</code>  添加到 <code>vector</code>  里，对外提供 <code>get方法</code> 。<br />\n理论上这样就可以了。但是事情并不像想象中的那么简单。<br />\n这样改完之后，并没有什么效果<br />\n经过一番查找。最后发现， <code>YansWifiHelper</code>  是继承 <code>WifiHelper</code>  的， <code>YansWifiHelper</code>  中的 <code>Create</code>  方法是由 <code>WifiHelper</code>  中的 <code>install</code>  方法调用的，并且返回的是 <code>YansWifyPhy</code>  的父类 <code>WifiPhy</code> 。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NetDeviceContainer</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">WifiHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Install</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> WifiPhyHelper <span class=\"token operator\">&amp;</span>phyHelper<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                     <span class=\"token keyword\">const</span> WifiMacHelper <span class=\"token operator\">&amp;</span>macHelper<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                     NodeContainer<span class=\"token double-colon punctuation\">::</span>Iterator first<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                     NodeContainer<span class=\"token double-colon punctuation\">::</span>Iterator last<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  NetDeviceContainer devices<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>NodeContainer<span class=\"token double-colon punctuation\">::</span>Iterator i <span class=\"token operator\">=</span> first<span class=\"token punctuation\">;</span> i <span class=\"token operator\">!=</span> last<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      Ptr<span class=\"token operator\">&lt;</span>Node<span class=\"token operator\">></span> node <span class=\"token operator\">=</span> <span class=\"token operator\">*</span>i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      Ptr<span class=\"token operator\">&lt;</span>WifiNetDevice<span class=\"token operator\">></span> device <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">CreateObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>WifiNetDevice<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token keyword\">auto</span> it <span class=\"token operator\">=</span> wifiStandards<span class=\"token punctuation\">.</span><span class=\"token function\">find</span> <span class=\"token punctuation\">(</span>m_standard<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>it <span class=\"token operator\">==</span> wifiStandards<span class=\"token punctuation\">.</span><span class=\"token function\">end</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          <span class=\"token function\">NS_FATAL_ERROR</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Selected standard is not defined!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          <span class=\"token keyword\">return</span> devices<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>it<span class=\"token operator\">-></span>second<span class=\"token punctuation\">.</span>phyStandard <span class=\"token operator\">>=</span> WIFI_PHY_STANDARD_80211n<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          Ptr<span class=\"token operator\">&lt;</span>HtConfiguration<span class=\"token operator\">></span> htConfiguration <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">CreateObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>HtConfiguration<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          device<span class=\"token operator\">-></span><span class=\"token function\">SetHtConfiguration</span> <span class=\"token punctuation\">(</span>htConfiguration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>it<span class=\"token operator\">-></span>second<span class=\"token punctuation\">.</span>phyStandard <span class=\"token operator\">>=</span> WIFI_PHY_STANDARD_80211ac<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>it<span class=\"token operator\">-></span>second<span class=\"token punctuation\">.</span>phyBand <span class=\"token operator\">!=</span> WIFI_PHY_BAND_2_4GHZ<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          Ptr<span class=\"token operator\">&lt;</span>VhtConfiguration<span class=\"token operator\">></span> vhtConfiguration <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">CreateObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>VhtConfiguration<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          device<span class=\"token operator\">-></span><span class=\"token function\">SetVhtConfiguration</span> <span class=\"token punctuation\">(</span>vhtConfiguration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>it<span class=\"token operator\">-></span>second<span class=\"token punctuation\">.</span>phyStandard <span class=\"token operator\">>=</span> WIFI_PHY_STANDARD_80211ax<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          Ptr<span class=\"token operator\">&lt;</span>HeConfiguration<span class=\"token operator\">></span> heConfiguration <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">CreateObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>HeConfiguration<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>          device<span class=\"token operator\">-></span><span class=\"token function\">SetHeConfiguration</span> <span class=\"token punctuation\">(</span>heConfiguration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      Ptr<span class=\"token operator\">&lt;</span>WifiRemoteStationManager<span class=\"token operator\">></span> manager <span class=\"token operator\">=</span> m_stationManager<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>WifiRemoteStationManager<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      Ptr<span class=\"token operator\">&lt;</span>WifiMac<span class=\"token operator\">></span> mac <span class=\"token operator\">=</span> macHelper<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span> <span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      Ptr<span class=\"token operator\">&lt;</span>WifiPhy<span class=\"token operator\">></span> phy <span class=\"token operator\">=</span> phyHelper<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">,</span> device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      <span class=\"token comment\">//add by yeyu</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      m_phyVector<span class=\"token punctuation\">.</span><span class=\"token function\">push_back</span><span class=\"token punctuation\">(</span>phy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token comment\">//add by yeyu</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      mac<span class=\"token operator\">-></span><span class=\"token function\">SetAddress</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Mac48Address</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Allocate</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      mac<span class=\"token operator\">-></span><span class=\"token function\">ConfigureStandard</span> <span class=\"token punctuation\">(</span>m_standard<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      phy<span class=\"token operator\">-></span><span class=\"token function\">ConfigureStandardAndBand</span> <span class=\"token punctuation\">(</span>it<span class=\"token operator\">-></span>second<span class=\"token punctuation\">.</span>phyStandard<span class=\"token punctuation\">,</span> it<span class=\"token operator\">-></span>second<span class=\"token punctuation\">.</span>phyBand<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      device<span class=\"token operator\">-></span><span class=\"token function\">SetMac</span> <span class=\"token punctuation\">(</span>mac<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      device<span class=\"token operator\">-></span><span class=\"token function\">SetPhy</span> <span class=\"token punctuation\">(</span>phy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      device<span class=\"token operator\">-></span><span class=\"token function\">SetRemoteStationManager</span> <span class=\"token punctuation\">(</span>manager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      node<span class=\"token operator\">-></span><span class=\"token function\">AddDevice</span> <span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>it<span class=\"token operator\">-></span>second<span class=\"token punctuation\">.</span>phyStandard <span class=\"token operator\">>=</span> WIFI_PHY_STANDARD_80211ax<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>m_obssPdAlgorithm<span class=\"token punctuation\">.</span><span class=\"token function\">IsTypeIdSet</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          Ptr<span class=\"token operator\">&lt;</span>ObssPdAlgorithm<span class=\"token operator\">></span> obssPdAlgorithm <span class=\"token operator\">=</span> m_obssPdAlgorithm<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>ObssPdAlgorithm<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          device<span class=\"token operator\">-></span><span class=\"token function\">AggregateObject</span> <span class=\"token punctuation\">(</span>obssPdAlgorithm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          obssPdAlgorithm<span class=\"token operator\">-></span><span class=\"token function\">ConnectWifiNetDevice</span> <span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>      devices<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span> <span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>      <span class=\"token function\">NS_LOG_DEBUG</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"node=\"</span> <span class=\"token operator\">&lt;&lt;</span> node <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\", mob=\"</span> <span class=\"token operator\">&lt;&lt;</span> node<span class=\"token operator\">-></span><span class=\"token generic-function\"><span class=\"token function\">GetObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>MobilityModel<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      <span class=\"token comment\">// Aggregate a NetDeviceQueueInterface object if a RegularWifiMac is installed</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>      Ptr<span class=\"token operator\">&lt;</span>RegularWifiMac<span class=\"token operator\">></span> rmac <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">DynamicCast</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>RegularWifiMac<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span>mac<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>rmac<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>          Ptr<span class=\"token operator\">&lt;</span>NetDeviceQueueInterface<span class=\"token operator\">></span> ndqi<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          BooleanValue qosSupported<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>          PointerValue ptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          Ptr<span class=\"token operator\">&lt;</span>WifiMacQueue<span class=\"token operator\">></span> wmq<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          Ptr<span class=\"token operator\">&lt;</span>WifiAckPolicySelector<span class=\"token operator\">></span> ackSelector<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          rmac<span class=\"token operator\">-></span><span class=\"token function\">GetAttributeFailSafe</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"QosSupported\"</span><span class=\"token punctuation\">,</span> qosSupported<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>qosSupported<span class=\"token punctuation\">.</span><span class=\"token function\">Get</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>              ndqi <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">CreateObjectWithAttributes</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>NetDeviceQueueInterface<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"NTxQueues\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>                                                                          <span class=\"token function\">UintegerValue</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>              rmac<span class=\"token operator\">-></span><span class=\"token function\">GetAttributeFailSafe</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"BE_Txop\"</span><span class=\"token punctuation\">,</span> ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>              ackSelector <span class=\"token operator\">=</span> m_ackPolicySelector<span class=\"token punctuation\">[</span>AC_BE<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>WifiAckPolicySelector<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>              ackSelector<span class=\"token operator\">-></span><span class=\"token function\">SetQosTxop</span> <span class=\"token punctuation\">(</span>ptr<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">Get</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>QosTxop<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>              ptr<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">Get</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>QosTxop<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">SetAckPolicySelector</span> <span class=\"token punctuation\">(</span>ackSelector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>              wmq <span class=\"token operator\">=</span> ptr<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">Get</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>QosTxop<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetWifiMacQueue</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>              ndqi<span class=\"token operator\">-></span><span class=\"token function\">GetTxQueue</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">ConnectQueueTraces</span> <span class=\"token punctuation\">(</span>wmq<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>              rmac<span class=\"token operator\">-></span><span class=\"token function\">GetAttributeFailSafe</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"BK_Txop\"</span><span class=\"token punctuation\">,</span> ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>              ackSelector <span class=\"token operator\">=</span> m_ackPolicySelector<span class=\"token punctuation\">[</span>AC_BK<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>WifiAckPolicySelector<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>              ackSelector<span class=\"token operator\">-></span><span class=\"token function\">SetQosTxop</span> <span class=\"token punctuation\">(</span>ptr<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">Get</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>QosTxop<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>              ptr<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">Get</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>QosTxop<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">SetAckPolicySelector</span> <span class=\"token punctuation\">(</span>ackSelector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>              wmq <span class=\"token operator\">=</span> ptr<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">Get</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>QosTxop<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetWifiMacQueue</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>              ndqi<span class=\"token operator\">-></span><span class=\"token function\">GetTxQueue</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">ConnectQueueTraces</span> <span class=\"token punctuation\">(</span>wmq<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>              rmac<span class=\"token operator\">-></span><span class=\"token function\">GetAttributeFailSafe</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"VI_Txop\"</span><span class=\"token punctuation\">,</span> ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>              ackSelector <span class=\"token operator\">=</span> m_ackPolicySelector<span class=\"token punctuation\">[</span>AC_VI<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>WifiAckPolicySelector<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>              ackSelector<span class=\"token operator\">-></span><span class=\"token function\">SetQosTxop</span> <span class=\"token punctuation\">(</span>ptr<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">Get</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>QosTxop<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>              ptr<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">Get</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>QosTxop<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">SetAckPolicySelector</span> <span class=\"token punctuation\">(</span>ackSelector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>              wmq <span class=\"token operator\">=</span> ptr<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">Get</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>QosTxop<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetWifiMacQueue</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>              ndqi<span class=\"token operator\">-></span><span class=\"token function\">GetTxQueue</span> <span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">ConnectQueueTraces</span> <span class=\"token punctuation\">(</span>wmq<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>              rmac<span class=\"token operator\">-></span><span class=\"token function\">GetAttributeFailSafe</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"VO_Txop\"</span><span class=\"token punctuation\">,</span> ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>              ackSelector <span class=\"token operator\">=</span> m_ackPolicySelector<span class=\"token punctuation\">[</span>AC_VO<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>WifiAckPolicySelector<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>              ackSelector<span class=\"token operator\">-></span><span class=\"token function\">SetQosTxop</span> <span class=\"token punctuation\">(</span>ptr<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">Get</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>QosTxop<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>              ptr<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">Get</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>QosTxop<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">SetAckPolicySelector</span> <span class=\"token punctuation\">(</span>ackSelector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>              wmq <span class=\"token operator\">=</span> ptr<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">Get</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>QosTxop<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetWifiMacQueue</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>              ndqi<span class=\"token operator\">-></span><span class=\"token function\">GetTxQueue</span> <span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">ConnectQueueTraces</span> <span class=\"token punctuation\">(</span>wmq<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>              ndqi<span class=\"token operator\">-></span><span class=\"token function\">SetSelectQueueCallback</span> <span class=\"token punctuation\">(</span>m_selectQueueCallback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>          <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>              ndqi <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">CreateObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>NetDeviceQueueInterface<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>              rmac<span class=\"token operator\">-></span><span class=\"token function\">GetAttributeFailSafe</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Txop\"</span><span class=\"token punctuation\">,</span> ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>              wmq <span class=\"token operator\">=</span> ptr<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">Get</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Txop<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetWifiMacQueue</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>              ndqi<span class=\"token operator\">-></span><span class=\"token function\">GetTxQueue</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">ConnectQueueTraces</span> <span class=\"token punctuation\">(</span>wmq<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>          device<span class=\"token operator\">-></span><span class=\"token function\">AggregateObject</span> <span class=\"token punctuation\">(</span>ndqi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>  <span class=\"token keyword\">return</span> devices<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>那么现在就很简单了，直接修改 <code>WifiPhy</code> , <code>WifiHelper</code> <br />\n <code>WifiPhy.h</code>  中添加下面代码</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   *motified by yeyu</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   */</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token comment\">//0&lt;m_angel&lt;45</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token keyword\">double</span> m_angel<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token keyword\">void</span> <span class=\"token function\">setAngel</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> angel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   <span class=\"token keyword\">double</span> <span class=\"token function\">getAngel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token comment\">//motified by yeyu</span></pre></td></tr></table></figure><p><code>WifiPhy.cc</code>  中添加下面代码</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//add by yeyu</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">WifiPhy</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">setAngel</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> angel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    m_angel<span class=\"token operator\">=</span>angel<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">double</span> <span class=\"token class-name\">WifiPhy</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getAngel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">return</span> m_angel<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">//add by yeyu</span></pre></td></tr></table></figure><p><code>WifiHelper.h</code>  中添加下面代码</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//add by yeyu</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;vector></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">//add by yeyu</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   *add by yeyu,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   * 存储节点与 Ptr&lt;WiFiPhy > 的对应关系</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   */</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">mutable</span> std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span>Ptr<span class=\"token operator\">&lt;</span>WifiPhy<span class=\"token operator\">>></span> m_phyVector<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><code>WifiHelper.cc</code>  中添加下面代码</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">//add by yeyu</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span>Ptr<span class=\"token operator\">&lt;</span>WifiPhy<span class=\"token operator\">>></span> <span class=\"token class-name\">WifiHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getPhyVector</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">return</span> m_phyVector<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">//add by yeyu</span></pre></td></tr></table></figure><p><code>WifiHelper.cc</code>  中的 send 函数修改如下</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NetDeviceContainer</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">WifiHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Install</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> WifiPhyHelper <span class=\"token operator\">&amp;</span>phyHelper<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                     <span class=\"token keyword\">const</span> WifiMacHelper <span class=\"token operator\">&amp;</span>macHelper<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                     NodeContainer<span class=\"token double-colon punctuation\">::</span>Iterator first<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                     NodeContainer<span class=\"token double-colon punctuation\">::</span>Iterator last<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token operator\">*</span><span class=\"token comment\">// 上面默认代码</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token comment\">//add by yeyu</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      m_phyVector<span class=\"token punctuation\">.</span><span class=\"token function\">push_back</span><span class=\"token punctuation\">(</span>phy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token comment\">//add by yeyu</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token operator\">*</span><span class=\"token comment\">// 下面是默认代码</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>再加上 <code>YansWifiChannel</code>  里 <code>send</code>  函数里的修改，即可以实现自己想要的定向发送功能</p>\n",
            "tags": [
                "ns3",
                "ns3"
            ]
        },
        {
            "id": "http://jluyeyu.com/ns3/7.ns3%20%E6%8D%9F%E5%A4%B1%E6%A8%A1%E5%9E%8B%E4%BF%AE%E6%94%B9/",
            "url": "http://jluyeyu.com/ns3/7.ns3%20%E6%8D%9F%E5%A4%B1%E6%A8%A1%E5%9E%8B%E4%BF%AE%E6%94%B9/",
            "title": "7.ns3 损失模型修改",
            "date_published": "2022-11-02T00:18:52.000Z",
            "content_html": "<h2 id=\"7ns3-损失模型修改\"><a class=\"anchor\" href=\"#7ns3-损失模型修改\">#</a> 7.ns3 损失模型修改</h2>\n<p>在本节中，将介绍 <code>ns3</code>  中 wifi 损失模型模型修改 / 新增所需的一些内容，</p>\n<h3 id=\"代码\"><a class=\"anchor\" href=\"#代码\">#</a> 代码</h3>\n<p>信道损失模型的源码位置如下</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ns-3.xx/src/propagation/model</pre></td></tr></table></figure><p>可以将自己的定义的信道损失模型添加到该路径，更改 <code>wscript</code>  文件，然后重新 <code>build</code>  一下 <code>ns3</code></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>./waf build</pre></td></tr></table></figure><p (4\\pi=\"\" d)^2L=\"\">主要更改<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>D</mi><mi>o</mi><mi>C</mi><mi>a</mi><mi>l</mi><mi>c</mi><mi>R</mi><mi>x</mi><mi>P</mi><mi>o</mi><mi>w</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding=\"application/x-tex\">DoCalcRxPower</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"mord mathnormal\">x</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span></span></span></span> 函数即可<br />\n无线默认的损失模型是P_r=\\frac{P_tG_tG_r\\lambda^2}</p>\n<ul>\n<li>Gt: tx gain (unit-less)</li>\n<li>Gr: rx gain (unit-less)</li>\n<li>Pt: tx power (W)</li>\n<li>d: distance (m)</li>\n<li>L: system loss</li>\n<li>lambda: wavelength (m)<br />\n 我改成了水下光学传播损耗模型中的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>P</mi><mi>r</mi></msub><mo>=</mo><msub><mi>P</mi><mi>t</mi></msub><msup><mi>e</mi><mrow><mo>−</mo><mi>c</mi><mo stretchy=\"false\">(</mo><mi>λ</mi><mo stretchy=\"false\">)</mo><mi>d</mi></mrow></msup><msub><mi>η</mi><mi>r</mi></msub><msub><mi>η</mi><mi>t</mi></msub></mrow><annotation encoding=\"application/x-tex\">P_r=P_te^{-c(\\lambda)d}\\eta_r\\eta_t</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0824399999999998em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2805559999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord mathnormal\">e</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8879999999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">−</span><span class=\"mord mathnormal mtight\">c</span><span class=\"mopen mtight\">(</span><span class=\"mord mathnormal mtight\">λ</span><span class=\"mclose mtight\">)</span><span class=\"mord mathnormal mtight\">d</span></span></span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">η</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">η</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2805559999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span><br />\n<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>η</mi><mi>r</mi></msub><mo separator=\"true\">,</mo><msub><mi>η</mi><mi>t</mi></msub><mtext>表示发射机的发射效率和接收机的接收效率</mtext></mrow><annotation encoding=\"application/x-tex\">\\eta_r,\\eta_t表示发射机的发射效率和接收机的接收效率</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8777699999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">η</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">η</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2805559999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord cjk_fallback\">表</span><span class=\"mord cjk_fallback\">示</span><span class=\"mord cjk_fallback\">发</span><span class=\"mord cjk_fallback\">射</span><span class=\"mord cjk_fallback\">机</span><span class=\"mord cjk_fallback\">的</span><span class=\"mord cjk_fallback\">发</span><span class=\"mord cjk_fallback\">射</span><span class=\"mord cjk_fallback\">效</span><span class=\"mord cjk_fallback\">率</span><span class=\"mord cjk_fallback\">和</span><span class=\"mord cjk_fallback\">接</span><span class=\"mord cjk_fallback\">收</span><span class=\"mord cjk_fallback\">机</span><span class=\"mord cjk_fallback\">的</span><span class=\"mord cjk_fallback\">接</span><span class=\"mord cjk_fallback\">收</span><span class=\"mord cjk_fallback\">效</span><span class=\"mord cjk_fallback\">率</span></span></span></span><br />\n<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi><mo stretchy=\"false\">(</mo><mi>λ</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">c(\\lambda)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">λ</span><span class=\"mclose\">)</span></span></span></span> 表示海水的衰减系数</li>\n</ul>\n<p>以下是我定义的损失模型<br />\n <code>MyPropagationLossModel.h</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*************************************************************************</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    > File Name: myLossModel.h</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    > Author: yeyu</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    > Mail: 554377661@qq.com </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    > Created Time: Sun 17 Jan 2021 01:20:27 AM PST</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> ************************************************************************/</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/propagation-loss-model.h\"</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/propagation-cache.h\"</span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">namespace</span> ns3 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">MyPropagationLossModel</span> <span class=\"token operator\">:</span> <span class=\"token base-clause\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">PropagationLossModel</span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">private</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> <span class=\"token comment\">//m_cLamada 海水的总衰减系数</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre> <span class=\"token keyword\">double</span> m_cLamada<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre> <span class=\"token comment\">//m_nt 表示通信系统中发射机的发射效率，m_nr 表示通信系统中接收机的接收效率。</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre> <span class=\"token keyword\">double</span> m_nt<span class=\"token punctuation\">,</span>m_nr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">public</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   * \\brief Get the type ID.</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   * \\return the object TypeId</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   */</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token keyword\">static</span> TypeId <span class=\"token function\">GetTypeId</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token function\">MyPropagationLossModel</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token comment\">// 设置发送接收效率 (&lt;=1)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">SetSendReceiveEfficiency</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> nt<span class=\"token punctuation\">,</span><span class=\"token keyword\">double</span> nr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token comment\">//get 发送接收效率</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token keyword\">double</span> <span class=\"token function\">GetReceiveEfficiency</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token keyword\">double</span> <span class=\"token function\">GetSendEfficiency</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  * set CLamada</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  */</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">SetCLamada</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> cLamada<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  * get CLamada</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  */</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token keyword\">double</span> <span class=\"token function\">GetCLamada</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>   * \\param frequency (Hz)</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>   *</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>   * Set the carrier frequency used in the Friis model </pre></td></tr><tr><td data-num=\"46\"></td><td><pre>   * calculation.</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>   */</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">SetFrequency</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> frequency<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>   * \\param systemLoss (dimension-less)</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>   *</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>   * Set the system loss used by the Friis propagation model.</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>   */</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">SetSystemLoss</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> systemLoss<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>   * \\param minLoss the minimum loss (dB)</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>   *</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>   * no matter how short the distance, the total propagation loss (in</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>   * dB) will always be greater or equal than this value </pre></td></tr><tr><td data-num=\"61\"></td><td><pre>   */</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">SetMinLoss</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> minLoss<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>   * \\return the minimum loss.</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>   */</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  <span class=\"token keyword\">double</span> <span class=\"token function\">GetMinLoss</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>   * \\returns the current frequency (Hz)</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>   */</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>  <span class=\"token keyword\">double</span> <span class=\"token function\">GetFrequency</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>   * \\returns the current system loss (dimension-less)</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>   */</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  <span class=\"token keyword\">double</span> <span class=\"token function\">GetSystemLoss</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre></pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token keyword\">private</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>  <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>   * \\brief Copy constructor</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>   *</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>   * Defined and unimplemented to avoid misuse</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>   */</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  <span class=\"token function\">MyPropagationLossModel</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> MyPropagationLossModel <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>  <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>   * \\brief Copy constructor</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>   *</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>   * Defined and unimplemented to avoid misuse</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>   * \\returns</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>   */</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>  MyPropagationLossModel <span class=\"token operator\">&amp;</span> <span class=\"token keyword\">operator</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> MyPropagationLossModel <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">double</span> <span class=\"token function\">DoCalcRxPower</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> txPowerDbm<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>                                Ptr<span class=\"token operator\">&lt;</span>MobilityModel<span class=\"token operator\">></span> a<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>                                Ptr<span class=\"token operator\">&lt;</span>MobilityModel<span class=\"token operator\">></span> b<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>  <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">int64_t</span> <span class=\"token function\">DoAssignStreams</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int64_t</span> stream<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>  <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>   * Transforms a Dbm value to Watt</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>   * \\param dbm the Dbm value</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>   * \\return the Watts</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>   */</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>  <span class=\"token keyword\">double</span> <span class=\"token function\">DbmToW</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> dbm<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>  <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>   * Transforms a Watt value to Dbm</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>   * \\param w the Watt value</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>   * \\return the Dbm</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>   */</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>  <span class=\"token keyword\">double</span> <span class=\"token function\">DbmFromW</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> w<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>  <span class=\"token keyword\">double</span> m_lambda<span class=\"token punctuation\">;</span>        <span class=\"token comment\">//!&lt; the carrier wavelength</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>  <span class=\"token keyword\">double</span> m_frequency<span class=\"token punctuation\">;</span>     <span class=\"token comment\">//!&lt; the carrier frequency</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>  <span class=\"token keyword\">double</span> m_systemLoss<span class=\"token punctuation\">;</span>    <span class=\"token comment\">//!&lt; the system loss</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>  <span class=\"token keyword\">double</span> m_minLoss<span class=\"token punctuation\">;</span>       <span class=\"token comment\">//!&lt; the minimum loss</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token comment\">//end of namespace ns3</span></pre></td></tr></table></figure><p><code>MyPropagationLossModel.cc</code>  的具体实现</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"MyPropagationLossModel.h\"</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/log.h\"</span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/mobility-model.h\"</span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/boolean.h\"</span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/double.h\"</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/string.h\"</span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/pointer.h\"</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;cmath></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">namespace</span> ns3 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token function\">NS_LOG_COMPONENT_DEFINE</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"MyLossModel\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token function\">NS_OBJECT_ENSURE_REGISTERED</span> <span class=\"token punctuation\">(</span>MyPropagationLossModel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>TypeId</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token class-name\">MyPropagationLossModel</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">GetTypeId</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token keyword\">static</span> TypeId tid <span class=\"token operator\">=</span> <span class=\"token function\">TypeId</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::MyPropagationLossModel\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">SetParent</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>PropagationLossModel<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token function\">SetGroupName</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Propagation\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">AddConstructor</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>MyPropagationLossModel<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token function\">AddAttribute</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Frequency\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                    <span class=\"token string\">\"The carrier frequency (in Hz) at which propagation occurs  (default is 5.15 GHz).\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                   <span class=\"token function\">DoubleValue</span> <span class=\"token punctuation\">(</span><span class=\"token number\">5.150e9</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                   <span class=\"token function\">MakeDoubleAccessor</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>MyPropagationLossModel<span class=\"token double-colon punctuation\">::</span>SetFrequency<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                                       <span class=\"token operator\">&amp;</span>MyPropagationLossModel<span class=\"token double-colon punctuation\">::</span>GetFrequency<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                   <span class=\"token generic-function\"><span class=\"token function\">MakeDoubleChecker</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token keyword\">double</span><span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token function\">AddAttribute</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"SystemLoss\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"The system loss\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                   <span class=\"token function\">DoubleValue</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                   <span class=\"token function\">MakeDoubleAccessor</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>MyPropagationLossModel<span class=\"token double-colon punctuation\">::</span>m_systemLoss<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                    <span class=\"token generic-function\"><span class=\"token function\">MakeDoubleChecker</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token keyword\">double</span><span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token function\">AddAttribute</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"MinLoss\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                   <span class=\"token string\">\"The minimum value (dB) of the total loss, used at short ranges. Note: \"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                   <span class=\"token function\">DoubleValue</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                   <span class=\"token function\">MakeDoubleAccessor</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>MyPropagationLossModel<span class=\"token double-colon punctuation\">::</span>SetMinLoss<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                                       <span class=\"token operator\">&amp;</span>MyPropagationLossModel<span class=\"token double-colon punctuation\">::</span>GetMinLoss<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                    <span class=\"token generic-function\"><span class=\"token function\">MakeDoubleChecker</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token keyword\">double</span><span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    .AddAttribute(\"CLamada\",</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                  \"CLamada is a double value\",</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                  DoubleValue(0.056),</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                  MakeDoubleAccessor (&amp;MyPropagationLossModel::m_cLamada,</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                      &amp;MyPropagationLossModel::GetCLamada),</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                  MakeDoubleChecker&lt;double> ()</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            )</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            */</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  <span class=\"token keyword\">return</span> tid<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token class-name\">MyPropagationLossModel</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">MyPropagationLossModel</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    m_cLamada<span class=\"token operator\">=</span><span class=\"token number\">0.056</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    m_nr<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    m_nt<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  <span class=\"token comment\">// 设置发送接收效率 (&lt;=1)</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">MyPropagationLossModel</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SetSendReceiveEfficiency</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> nt<span class=\"token punctuation\">,</span><span class=\"token keyword\">double</span> nr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    m_nt<span class=\"token operator\">=</span>nt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    m_nr<span class=\"token operator\">=</span>nr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token keyword\">double</span> <span class=\"token class-name\">MyPropagationLossModel</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">GetSendEfficiency</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    <span class=\"token keyword\">return</span> m_nt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token keyword\">double</span> <span class=\"token class-name\">MyPropagationLossModel</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">GetReceiveEfficiency</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token keyword\">return</span> m_nr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>  * set CLamada</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  */</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">MyPropagationLossModel</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SetCLamada</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> cLamada<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    m_cLamada<span class=\"token operator\">=</span>cLamada<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>  * get CLamada</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  */</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre><span class=\"token keyword\">double</span> <span class=\"token class-name\">MyPropagationLossModel</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">GetCLamada</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>    <span class=\"token keyword\">return</span> m_cLamada<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre></pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre><span class=\"token class-name\">MyPropagationLossModel</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SetSystemLoss</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> systemLoss<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>  m_systemLoss <span class=\"token operator\">=</span> systemLoss<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre><span class=\"token keyword\">double</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre><span class=\"token class-name\">MyPropagationLossModel</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">GetSystemLoss</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>  <span class=\"token keyword\">return</span> m_systemLoss<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre><span class=\"token class-name\">MyPropagationLossModel</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SetMinLoss</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> minLoss<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>  m_minLoss <span class=\"token operator\">=</span> minLoss<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre><span class=\"token keyword\">double</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre><span class=\"token class-name\">MyPropagationLossModel</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">GetMinLoss</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>  <span class=\"token keyword\">return</span> m_minLoss<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre></pre></td></tr><tr><td data-num=\"104\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre><span class=\"token class-name\">MyPropagationLossModel</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SetFrequency</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> frequency<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>  m_frequency <span class=\"token operator\">=</span> frequency<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>  <span class=\"token keyword\">static</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">double</span> C <span class=\"token operator\">=</span> <span class=\"token number\">299792458.0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// speed of light in vacuum</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>  m_lambda <span class=\"token operator\">=</span> C <span class=\"token operator\">/</span> frequency<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre></pre></td></tr><tr><td data-num=\"112\"></td><td><pre><span class=\"token keyword\">double</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre><span class=\"token class-name\">MyPropagationLossModel</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">GetFrequency</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>  <span class=\"token keyword\">return</span> m_frequency<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre></pre></td></tr><tr><td data-num=\"118\"></td><td><pre><span class=\"token keyword\">double</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre><span class=\"token class-name\">MyPropagationLossModel</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">DbmToW</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> dbm<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>  <span class=\"token keyword\">double</span> mw <span class=\"token operator\">=</span> std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">pow</span> <span class=\"token punctuation\">(</span><span class=\"token number\">10.0</span><span class=\"token punctuation\">,</span>dbm<span class=\"token operator\">/</span><span class=\"token number\">10.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>  <span class=\"token keyword\">return</span> mw <span class=\"token operator\">/</span> <span class=\"token number\">1000.0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre></pre></td></tr><tr><td data-num=\"125\"></td><td><pre><span class=\"token keyword\">double</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre><span class=\"token class-name\">MyPropagationLossModel</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">DbmFromW</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> w<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>  <span class=\"token keyword\">double</span> dbm <span class=\"token operator\">=</span> std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">log10</span> <span class=\"token punctuation\">(</span>w <span class=\"token operator\">*</span> <span class=\"token number\">1000.0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">10.0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>  <span class=\"token keyword\">return</span> dbm<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre></pre></td></tr><tr><td data-num=\"132\"></td><td><pre><span class=\"token keyword\">double</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre><span class=\"token class-name\">MyPropagationLossModel</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">DoCalcRxPower</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> txPowerDbm<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>                                          Ptr<span class=\"token operator\">&lt;</span>MobilityModel<span class=\"token operator\">></span> a<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>                                          Ptr<span class=\"token operator\">&lt;</span>MobilityModel<span class=\"token operator\">></span> b<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>  <span class=\"token function\">NS_LOG_WARN</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"this a test model\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre></pre></td></tr><tr><td data-num=\"139\"></td><td><pre></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>  <span class=\"token keyword\">double</span> distance <span class=\"token operator\">=</span> a<span class=\"token operator\">-></span><span class=\"token function\">GetDistanceFrom</span> <span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>distance <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>      <span class=\"token keyword\">return</span> txPowerDbm <span class=\"token operator\">-</span> m_minLoss<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>  <span class=\"token keyword\">double</span> myLossDb<span class=\"token operator\">=</span><span class=\"token operator\">-</span><span class=\"token number\">10</span> <span class=\"token operator\">*</span> <span class=\"token function\">log10</span> <span class=\"token punctuation\">(</span><span class=\"token function\">pow</span><span class=\"token punctuation\">(</span>M_E<span class=\"token punctuation\">,</span><span class=\"token operator\">-</span>m_cLamada<span class=\"token operator\">*</span>distance<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre></pre></td></tr><tr><td data-num=\"147\"></td><td><pre><span class=\"token comment\">//NS_LOG_WARN (\"distance=\" &lt;&lt; distance&lt;&lt; \"m, loss=\" &lt;&lt; myLossDb &lt;&lt;\"dB\");</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre><span class=\"token comment\">//return txPowerDbm - std::max (myLossDb, m_minLoss);</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>  <span class=\"token keyword\">double</span> tmp<span class=\"token operator\">=</span>txPowerDbm <span class=\"token operator\">-</span> std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">max</span> <span class=\"token punctuation\">(</span>myLossDb<span class=\"token punctuation\">,</span> m_minLoss<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>  <span class=\"token function\">NS_LOG_WARN</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"发射dbm=\"</span><span class=\"token operator\">&lt;&lt;</span>txPowerDbm <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">\", distance=\"</span> <span class=\"token operator\">&lt;&lt;</span>distance<span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"m, loss=\"</span> <span class=\"token operator\">&lt;&lt;</span> myLossDb <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">\"dB\"</span><span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">\" 实际损失为:\"</span><span class=\"token operator\">&lt;&lt;</span> tmp<span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">\"dB\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>  <span class=\"token keyword\">return</span> tmp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre></pre></td></tr><tr><td data-num=\"153\"></td><td><pre></pre></td></tr><tr><td data-num=\"154\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre></pre></td></tr><tr><td data-num=\"156\"></td><td><pre><span class=\"token keyword\">int64_t</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre><span class=\"token class-name\">MyPropagationLossModel</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">DoAssignStreams</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int64_t</span> stream<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre></pre></td></tr><tr><td data-num=\"162\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>使用方法<br />\n修改 <code>wscript</code>  文件，将 <code>MyPropagationLossModel.h</code>  和 <code>MyPropagationLossModel.cc</code>  添加到对应的位置<br />\n然后重新编译</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 先导入已经编译好的头文件</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/MyPropagationLossModel.h\"</span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/applications-module.h\"</span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  WifiMacHelper wifiMac<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  wifiMac<span class=\"token punctuation\">.</span><span class=\"token function\">SetType</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::AdhocWifiMac\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  YansWifiPhyHelper wifiPhy <span class=\"token operator\">=</span> <span class=\"token class-name\">YansWifiPhyHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Default</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  YansWifiChannelHelper wifiChannel<span class=\"token operator\">=</span><span class=\"token class-name\">YansWifiChannelHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Default</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>MyPropagationLossModel<span class=\"token operator\">></span> lossModel<span class=\"token operator\">=</span><span class=\"token generic-function\"><span class=\"token function\">CreateObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>MyPropagationLossModel<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  lossModel<span class=\"token operator\">-></span><span class=\"token function\">SetCLamada</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.398</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"clamada:%f\\n\"</span><span class=\"token punctuation\">,</span>lossModel<span class=\"token operator\">-></span><span class=\"token function\">GetCLamada</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>YansWifiChannel<span class=\"token operator\">></span> myChannel<span class=\"token operator\">=</span>wifiChannel<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  myChannel<span class=\"token operator\">-></span><span class=\"token function\">SetPropagationLossModel</span><span class=\"token punctuation\">(</span>lossModel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  wifiPhy<span class=\"token punctuation\">.</span><span class=\"token function\">SetChannel</span> <span class=\"token punctuation\">(</span>myChannel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>结果展示<br />\n最后的结果都是 dbm，之前写错了，一直没改 ==<br />\n<img data-src=\"https://leanote.com/api/file/getImage?fileId=600ed99bab6441511b000340\" alt=\"图片标题\" /></p>\n",
            "tags": [
                "ns3",
                "ns3"
            ]
        },
        {
            "id": "http://jluyeyu.com/ns3/6.ns3%20wifi%20%E6%A8%A1%E5%9E%8B%E9%85%8D%E7%BD%AE/",
            "url": "http://jluyeyu.com/ns3/6.ns3%20wifi%20%E6%A8%A1%E5%9E%8B%E9%85%8D%E7%BD%AE/",
            "title": "6.wifi模型扩展",
            "date_published": "2022-11-01T07:18:52.000Z",
            "content_html": "<h2 id=\"6ns3-wifi模型配置\"><a class=\"anchor\" href=\"#6ns3-wifi模型配置\">#</a> 6.ns3 wifi 模型配置</h2>\n<p>在本节中，将介绍 <code>ns3</code>  中 wifi 模型扩展所需的一些内容，</p>\n<h3 id=\"using-the-wifinetdevice\"><a class=\"anchor\" href=\"#using-the-wifinetdevice\">#</a> Using the WifiNetDevice</h3>\n<p>使用底层 <code>ns3 API</code>  添加一个 <code>WifiNetDevice</code>  到节点上，必须创建一个 <code>WifiNetDevice</code>  实例，和许多构成的对象，以一种合适的方式绑定在一起（ <code>WifiNetDevice</code>  为未来的可扩展性，在某种程度上已经非常模块化）。在底层 api，这需要大约 20 行代码（ <code>ns3::WifiHelper::Install,ns3::YansWifiPhyHelper::Create</code> ）。一个信道 <code>WifiChannel</code>  必须被创建，也包含了一些构成的对象（请看 <code>ns3::YansWifiChannelHelper::Create</code> ）。</p>\n<p>然而，一些可用的帮助类可以使用，如果愿意使用默认值的话，添加设备和信道只用几行代码就能完成。当然也可以使用额外的 <code>api</code>  允许通过属性系统来改变默认值。</p>\n<p>接下来，我们描述创建一个 <code>WifiNetDevice</code>  从底层 <code>(WifiChannel)</code>  到设备层 <code>(WifiNetDevice)</code>  的通常的步骤。</p>\n<p>为了创建一个 <code>WifiNetDevice</code> ，用户主要需要配置五步：</p>\n<ol>\n<li>配置 <code>WifiChannel:WifiChannel</code>  关系到信号在相同的信道上从一个设备到另一个设备。 <code>WifiChannel</code>  主要的配置是传播损耗模型和传播延时模型。</li>\n<li>配置 <code>WifiPhy</code> ： <code>WifiPhy</code>  关系到从 <code>WifiChannel</code>  发送和接收无线信号。这里， <code>WifiPhy</code>  依赖于接收的信号的强度和噪声决定每一帧是否被成功解码。所以， <code>WifiPhy</code>  的主要配置是误码率模型，该模型就是最后计算基于信号的成功解码帧的概率。</li>\n<li>配置 <code>WifiMac</code> ：这一步更多的是与 <code>the architecture and device level</code>  有关。用户配置 <code>wifi architecture</code> （例如 <code>adhoc or ap-sta</code> ）和是否支持 <code>Qos（802.11e），HT（802.11n），VHT（802.11ac）</code> 特性。</li>\n<li>创建 <code>WifiDevice</code> : 在这一步，用户配置期望的 <code>wifi</code>  标准（例如 <code>802.11b,802.11g,802.11a,802.11n or 802.11ac</code> ）和速率控制算法。</li>\n<li>配置 <code>mobility</code> : 最后， <code>mobility</code>  模型通常需要在 <code>WifiNetDevice</code>  可用之前配置。</li>\n</ol>\n<h4 id=\"yanswifichannelhelper\"><a class=\"anchor\" href=\"#yanswifichannelhelper\">#</a> YansWifiChannelHelper</h4>\n<p><code>YansWifiChannelHelper</code>  具有一个不同寻常的名字。读者可能会疑惑为什么使用这样的名字。该模型是从 <code>yans simulator</code>  提取出来的，名字也是引用自它。该帮助类可以创建一个带有默认传播损耗模型 <code>（PropagationLoss）</code> 和传播延时模型 <code>（PropagationDelay）</code> 的 <code>WifiChannel</code> 。</p>\n<p>用户所使用的经典代码如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>YansWifiChannelHelper wifiChannelHelper <span class=\"token operator\">=</span> <span class=\"token class-name\">YansWifiChannelHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Default</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    Ptr<span class=\"token operator\">&lt;</span>WifiChannel<span class=\"token operator\">></span> wifiChannel <span class=\"token operator\">=</span> wifiChannelHelper<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>特别的是，默认的信道模型使用的是 3 的指数的信道模型，所用的传播时延等于一个常数值，就是光速 <code>（ns3::ConstantSpeedPropagationDelayModel）</code> ，所用的传播损耗是基于一个默认的 <code>log distance model(ns3::LogDistancePropagationLossModel)</code> 。请注意，默认的 <code>log distance model is configured with a reference loss of 46.6777 dB at reference distance of 1m</code> 。 <code>The reference loss of 46.6777 dB was calculated using Friis propagation loss model at 5.15 GHz</code> . <code>The reference loss</code>  模型如果使用 <code>802.11b,802.11g,802.11n</code>  (由于它们工作在 <code>2.4GHZ</code> ) 必须被改变。</p>\n<p>注意上面在创建一个帮助对象和一个实际的仿真对象的区别。在 <code>ns3</code>  中，帮助对象（仅仅用于帮助 APP）是在栈（它们可以使用 new 操作符创建和使用 deleted 销毁）中创建的。然而，实际的 <code>ns3</code>  对象继承自 <code>ns3::Object</code>  类，并且分配一个智能指针。</p>\n<p>下面的两个方法在配置 <code>YansWifiChannelHelper</code>  是有用的：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>• YansWifiChannelHelper<span class=\"token double-colon punctuation\">::</span>AddPropagationLoss adds a PropagationLossModel to a chain of PropagationLossModel</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>• YansWifiChannelHelper<span class=\"token double-colon punctuation\">::</span>SetPropagationDelay sets a PropagationDelayModel</pre></td></tr></table></figure><h4 id=\"yanswifiphyhelper\"><a class=\"anchor\" href=\"#yanswifiphyhelper\">#</a> YansWifiPhyHelper</h4>\n<p>物理层设备（基类 <code>ns3::WifiPhy</code> ）在 <code>ns3</code>  中是与 <code>ns3::WifiChannel</code>  相连接的。我们需要为 <code>YansWifiChannel</code>  创建合适的 <code>WifiPhy</code>  对象。这里 <code>YansWifiPhyHelper</code>  就可以胜任这个工作。</p>\n<p><code>YansWifiPhyHelper</code>  类配置了一个对象工厂来创建一个 <code>YansWifiPhy</code>  实例，并添加一些其他的对象到该实例中，包括可能补充的 <code>ErrorRateModel</code>  误码率模型和指向 <code>MobilityModel</code>  移动模型的指针。典型的用户代码如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>YansWifiPhyHelper wifiPhyHelper <span class=\"token operator\">=</span> <span class=\"token class-name\">YansWifiPhyHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Default</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    wifiPhyHelper<span class=\"token punctuation\">.</span><span class=\"token function\">SetChannel</span> <span class=\"token punctuation\">(</span>wifiChannel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><code>YansWifiPhyHelper</code>  默认配置 <code>NistErrorRateModel（ns3::NistErrorRateModel）</code> 误码率模型。你可以使用 <code>YansWifiPhyHelper::SetErrorRateModel</code>  方法更改误码率模型。</p>\n<p>可选的是，如果 <code>pcap</code>  跟踪记录是需要的话，用户可以使用下面的代码使得 <code>pcap</code>  跟踪可用：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">YansWifiPhyHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SetPcapDataLinkType</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">enum</span> <span class=\"token class-name\">SupportedPcapDataLinkTypes</span> dlt<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    ns3支持<span class=\"token number\">802.11</span>的RadioTap和Prism轨迹扩展。</pre></td></tr></table></figure><p>注意，我们还没有实际创建一个 <code>WifiPhy</code>  对象；我们只是准备了告诉 <code>YansWifiPhyHelper</code>  与之连接的信道。 <code>Phy</code>  对象会在下一步创建。</p>\n<p><code>802.11n/ac PHY</code>  层可以使用长 <code>800ns</code>  或者短 <code>400ns</code>  的 <code>OFDM guard intervals</code> 。为了配置这个参数，可以使用下面的一行的代码（这个例子中，使用的是 <code>short guard interval</code>  的支持）：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>wifiPhyHelper<span class=\"token punctuation\">.</span><span class=\"token function\">Set</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ShortGuardEnabled\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">BooleanValue</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>更多的是， <code>802.11</code>  提供了一种可选的模式 <code>（GreenField mode）</code> 来减少 <code>preamble durations</code> （前沿持续时间），并且这也是唯一一种与 <code>802.11n</code>  设备兼容的模式。可以使用下面的代码启用这种模式：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>wifiPhyHelper<span class=\"token punctuation\">.</span><span class=\"token function\">Set</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"GreenfieldEnabled\"</span><span class=\"token punctuation\">,</span><span class=\"token function\">BooleanValue</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><code>802.11nPHY</code>  层可以支持 20（默认）或者 40MHZ 信道带宽， <code>802.11ac PHY</code>  层可以使用 20，40，80（默认），160MHZ 信道带宽。由于信道带宽值被 <code>WifiHelper::SetStandard</code>  重写，可以使用下面 <code>Config::Set</code>  代码在安装后进行配置：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>WifiHelper wifi <span class=\"token operator\">=</span> <span class=\"token class-name\">WifiHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Default</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    wifi<span class=\"token punctuation\">.</span><span class=\"token function\">SetStandard</span> <span class=\"token punctuation\">(</span>WIFI_PHY_STANDARD_80211ac<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    wifi<span class=\"token punctuation\">.</span><span class=\"token function\">SetRemoteStationManager</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::ConstantRateWifiManager\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"DataMode\"</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                                  <span class=\"token function\">StringValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"VHtMcs9\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ControlMode\"</span><span class=\"token punctuation\">,</span><span class=\"token function\">StringValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"VHtMcs9\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    VhtWifiMacHelper mac <span class=\"token operator\">=</span> <span class=\"token class-name\">VhtWifiMacHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Default</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">//Install PHY and MAC</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    Ssid ssid <span class=\"token operator\">=</span> <span class=\"token function\">Ssid</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3-wifi\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    mac<span class=\"token punctuation\">.</span><span class=\"token function\">SetType</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::StaWifiMac\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token string\">\"Ssid\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">SsidValue</span> <span class=\"token punctuation\">(</span>ssid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token string\">\"ActiveProbing\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">BooleanValue</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    NetDeviceContainer staDevice<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    staDevice <span class=\"token operator\">=</span> wifi<span class=\"token punctuation\">.</span><span class=\"token function\">Install</span> <span class=\"token punctuation\">(</span>phy<span class=\"token punctuation\">,</span> mac<span class=\"token punctuation\">,</span> wifiStaNode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    mac<span class=\"token punctuation\">.</span><span class=\"token function\">SetType</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::ApWifiMac\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token string\">\"Ssid\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">SsidValue</span> <span class=\"token punctuation\">(</span>ssid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    NetDeviceContainer apDevice<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    apDevice <span class=\"token operator\">=</span> wifi<span class=\"token punctuation\">.</span><span class=\"token function\">Install</span> <span class=\"token punctuation\">(</span>phy<span class=\"token punctuation\">,</span> mac<span class=\"token punctuation\">,</span> wifiApNode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">//Once install is done, we overwrite the channel width value</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token comment\">//(一旦安装之后，我们可以重写信道带宽)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Set</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"/NodeList/*/DeviceList/*/$ns3::WifiNetDevice/Phy/ChannelWidth\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">UintegerValue</span> <span class=\"token punctuation\">(</span><span class=\"token number\">160</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"wifimachelper\"><a class=\"anchor\" href=\"#wifimachelper\">#</a> WifiMacHelper</h4>\n<p>下一步是配置 MAC 模型。我们使用 <code>WifiMacHelper</code>  来完成。 <code>WifiMacHelper</code>  可以完成 <code>MAC low</code>  模型和 <code>MAC high</code>  模型。用户必须决定采用哪种模型： <code>802.11/WMM-style Qos</code> ， <code>802.11n-style Hight throughput（HT）</code> ， <code>802.11ac-style Very High throughput（VHT）</code></p>\n<h5 id=\"nqoswifimachelper-and-qoswifimachelper\"><a class=\"anchor\" href=\"#nqoswifimachelper-and-qoswifimachelper\">#</a> NqosWifiMacHelper and QosWifiMacHelper</h5>\n<p><code>ns3::NqosWifiMacHelper</code>  和 <code>ns3::QosWifiMacHelper</code>  均可以配置一个对象工厂来创建一个 <code>ns3::WifiMac</code>  实例。它们用来配置像 MAC 类型的参数。<br />\n前者 <code>ns3::NqosWifiMacHelper</code>  不支持以下类型的 MAC 实例的创建： <code>802.11e/WMM-style QoS，802.11n-style High throughput (HT)，802.11ac-style Very High throughput (VHT)</code> 。<br />\n例如下面的用户代码配置了一个不支持 <code>QOs</code>  和 <code>HT</code>  的 <code>MAC</code>  类型实例，并且没有 <code>AP</code> ，仅有 <code>STA</code>  的一个基础设施网络， <code>SSID</code>  设置为 <code>ns-3-ssid</code> :</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NqosWifiMacHelper wifiMacHelper <span class=\"token operator\">=</span> <span class=\"token class-name\">NqosWifiMacHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Default</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    Ssid ssid <span class=\"token operator\">=</span> <span class=\"token function\">Ssid</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns-3-ssid\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    wifiMacHelper<span class=\"token punctuation\">.</span><span class=\"token function\">SetType</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::StaWifiMac\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token string\">\"Ssid\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">SsidValue</span> <span class=\"token punctuation\">(</span>ssid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token string\">\"ActiveProbing\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">BooleanValue</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>可以使用ns3<span class=\"token double-colon punctuation\">::</span>QosWifiMacHelper来代替ns3<span class=\"token double-colon punctuation\">::</span>NqosWifiMacHelper来创建一个支持Qos的MAC实例。</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>下面的代码使用ns3<span class=\"token double-colon punctuation\">::</span>QosWifiMacHelper创建了一个支持Qos的AP：</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>QosWifiMacHelper wifiMacHelper <span class=\"token operator\">=</span> <span class=\"token class-name\">QosWifiMacHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Default</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    wifiMacHelper<span class=\"token punctuation\">.</span><span class=\"token function\">SetType</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::ApWifiMac\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token string\">\"Ssid\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">SsidValue</span> <span class=\"token punctuation\">(</span>ssid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token string\">\"BeaconGeneration\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">BooleanValue</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token string\">\"BeaconInterval\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">TimeValue</span> <span class=\"token punctuation\">(</span><span class=\"token function\">Seconds</span> <span class=\"token punctuation\">(</span><span class=\"token number\">2.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>支持 Qos 的 MAC 模型可以工作在流量属于四种不同访问策略下： <code>AC_VO</code>  语音流， <code>AC_VI</code>  视频流， <code>AC_BE</code>  尽最大努力流， <code>AC_BK</code>  后台流。为了使 <code>MAC</code>  为 <code>MSDU</code>  决定一个合适的 <code>AC</code> ，转发到这些 <code>MAC</code>  层的包应该被使用一个 <code>TID（traffic id）</code> 的 <code>ns3::QosTag</code>  标记，否则该包将被属于 <code>AC_BE</code>  策略。</p>\n<p>为了创建一个 <code>ad-hoc MAC</code>  实例，简单的使用 <code>ns3::AdhocWifiMac</code>  代替 <code>ns3::StaWifiMac</code>  和 <code>ns3::ApWifiMac</code>  即可。</p>\n<h5 id=\"htwifimachelper\"><a class=\"anchor\" href=\"#htwifimachelper\">#</a> HtWifiMacHelper</h5>\n<p><code>ns3::HtWifiMacHelper</code>  配置一个对象工厂来创建一个 <code>ns3::WifiMac</code>  实例。它用于支持创建 <code>802.11n-style High throughput (HT)</code>  和支持 <code>QoS</code>  类型的 <code>MAC</code>  实例。特别的，该对象也可以用来设置：</p>\n<figure class=\"highlight tex\"><figcaption data-lang=\"TeX\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>1. 为了使用802.11n MSDU聚合特性，为特定的访问策略AC设置MSDU聚合</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>2. 可以设置像threshold（阈值）（块ACK机制应该被使用的包的数量）的块ACK参数和闲置超时。</pre></td></tr></table></figure><p>例如，下面的代码配置了一个 <code>HT MAC</code> ，不支持 <code>AP</code> ，支持 <code>STA</code> ， <code>QOS</code>  保证，聚合 <code>AC_VO</code> , 和 <code>AC_BE</code>  的块 <code>ACK</code> ，这样的基础设施网络，它的 <code>AP</code>  的 <code>SSID</code>  为 <code>ns-3-ssid</code> ：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>HtWifiMacHelper wifiMacHelper <span class=\"token operator\">=</span> <span class=\"token class-name\">HtWifiMacHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Default</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    Ssid ssid <span class=\"token operator\">=</span> <span class=\"token function\">Ssid</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns-3-ssid\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    wifiMacHelper<span class=\"token punctuation\">.</span><span class=\"token function\">SetType</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::StaWifiMac\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                <span class=\"token string\">\"Ssid\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">SsidValue</span> <span class=\"token punctuation\">(</span>ssid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                <span class=\"token string\">\"ActiveProbing\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">BooleanValue</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    wifiMacHelper<span class=\"token punctuation\">.</span><span class=\"token function\">SetMsduAggregatorForAc</span> <span class=\"token punctuation\">(</span>AC_VO<span class=\"token punctuation\">,</span> <span class=\"token string\">\"ns3::MsduStandardAggregator\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                    <span class=\"token string\">\"MaxAmsduSize\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">UintegerValue</span> <span class=\"token punctuation\">(</span><span class=\"token number\">3839</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    wifiMacHelper<span class=\"token punctuation\">.</span><span class=\"token function\">SetBlockAckThresholdForAc</span> <span class=\"token punctuation\">(</span>AC_BE<span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    wifiMacHelper<span class=\"token punctuation\">.</span><span class=\"token function\">SetBlockAckInactivityTimeoutForAc</span> <span class=\"token punctuation\">(</span>AC_BE<span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>这个对象也可以使用 <code>ns3::QosWifiMacHelper</code>  以相同的方式进行设置。</p>\n<h5 id=\"vhtwifimachelper\"><a class=\"anchor\" href=\"#vhtwifimachelper\">#</a> VhtWifiMacHelper</h5>\n<p><code>ns3::VhtWifiMacHelper</code>  配置一个对象工厂来创建一个 <code>ns3::WifiMac</code>  实例。用于支持创建以下类型的 <code>MAC</code>  实例： <code>802.11ac-style Very High throughput (VHT)</code>  和支持  <code>QoS</code>  保证。这个对象与 <code>HtWifiMacHelper</code>  很相似。</p>\n<h4 id=\"wifihelper\"><a class=\"anchor\" href=\"#wifihelper\">#</a> WifiHelper</h4>\n<p>我们现在准备创建 <code>WifiNetDevices</code> . 首先，让我们创建一个默认设置的 <code>WifiHelper</code> ：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>WifiHelper wifiHelper <span class=\"token operator\">=</span> <span class=\"token class-name\">WifiHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Default</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>这一步都做了什么呢？它默认设置 <code>802.11a WIFI</code>  标准，和设置 <code>ns3::ArfWifiManager</code>  作为 <code>RemoteStationManager</code> 。你可以通过调用 <code>WifiHelper::SetRemoteStationManager</code>  方法改变 <code>RemoteStationManager</code> 。为了改变采用的 <code>wifi</code>  标准，可以调用 <code>WifiHelper::SetStandard</code>  方法来设置想要的标准。</p>\n<p>现在，让我们使用上面所描述的对象 <code>wifiPhyHelper</code>  和 <code>wifiMacHelper</code> ，安装到在一系列节点 <code>c</code>  上的 <code>WifiNetDevices</code> ：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>NetDeviceContainer wifiContainer <span class=\"token operator\">=</span> <span class=\"token class-name\">WifiHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Install</span> <span class=\"token punctuation\">(</span>wifiPhyHelper<span class=\"token punctuation\">,</span> wifiMacHelper<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>这样就创建了一个 WifiNetDevice，它包含 WifiRemoteStationManager,WifiMac,WifiPhy（连接到匹配的 WifiChannel 上的）。<br />\nWifiHelper::SetStandard 方法设置了定义在已选的标准版本中的可变的默认的定时参数，可重写已经存在的或者已经配置过的值。为了改变已经给 WifiHelper::SetStandard 重写的参数，应该在安装后使用 Config::Set 来配置：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>WifiHelper wifi <span class=\"token operator\">=</span> <span class=\"token class-name\">WifiHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Default</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    wifi<span class=\"token punctuation\">.</span><span class=\"token function\">SetStandard</span> <span class=\"token punctuation\">(</span>WIFI_PHY_STANDARD_80211n_2_4GHZ<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    wifi<span class=\"token punctuation\">.</span><span class=\"token function\">SetRemoteStationManager</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::ConstantRateWifiManager\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"DataMode\"</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                                  <span class=\"token function\">StringValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"HtMcs7\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ControlMode\"</span><span class=\"token punctuation\">,</span><span class=\"token function\">StringValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"HtMcs7\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    HtWifiMacHelper mac <span class=\"token operator\">=</span> <span class=\"token class-name\">HtWifiMacHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Default</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">//Install PHY and MAC</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    Ssid ssid <span class=\"token operator\">=</span> <span class=\"token function\">Ssid</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3-wifi\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    mac<span class=\"token punctuation\">.</span><span class=\"token function\">SetType</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::StaWifiMac\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token string\">\"Ssid\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">SsidValue</span> <span class=\"token punctuation\">(</span>ssid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token string\">\"ActiveProbing\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">BooleanValue</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    NetDeviceContainer staDevice<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    staDevice <span class=\"token operator\">=</span> wifi<span class=\"token punctuation\">.</span><span class=\"token function\">Install</span> <span class=\"token punctuation\">(</span>phy<span class=\"token punctuation\">,</span> mac<span class=\"token punctuation\">,</span> wifiStaNode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    mac<span class=\"token punctuation\">.</span><span class=\"token function\">SetType</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::ApWifiMac\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token string\">\"Ssid\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">SsidValue</span> <span class=\"token punctuation\">(</span>ssid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    NetDeviceContainer apDevice<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    apDevice <span class=\"token operator\">=</span> wifi<span class=\"token punctuation\">.</span><span class=\"token function\">Install</span> <span class=\"token punctuation\">(</span>phy<span class=\"token punctuation\">,</span> mac<span class=\"token punctuation\">,</span> wifiApNode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">//Once install is done, we overwrite the standard timing values</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Set</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"/NodeList/*/DeviceList/*/$ns3::WifiNetDevice/Mac/Slot\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">TimeValue</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MicroSeconds</span> <span class=\"token punctuation\">(</span>slot<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Set</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"/NodeList/*/DeviceList/*/$ns3::WifiNetDevice/Mac/Sifs\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">TimeValue</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MicroSeconds</span> <span class=\"token punctuation\">(</span>sifs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Set</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"/NodeList/*/DeviceList/*/$ns3::WifiNetDevice/Mac/AckTimeout\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">TimeValue</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MicroSeconds</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Set</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"/NodeList/*/DeviceList/*/$ns3::WifiNetDevice/Mac/CtsTimeout\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">TimeValue</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MicroSeconds</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Set</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"/NodeList/*/DeviceList/*/$ns3::WifiNetDevice/Mac/Rifs\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">TimeValue</span> <span class=\"token punctuation\">(</span><span class=\"token function\">MicroSeconds</span> <span class=\"token punctuation\">(</span>rifs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Set</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"/NodeList/*/DeviceList/*/$ns3::WifiNetDevice/Mac/BasicBlockAckTimeout\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">TimeValue</span> <span class=\"token punctuation\">(</span>Micr</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token class-name\">Config</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Set</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"/NodeList/*/DeviceList/*/$ns3::WifiNetDevice/Mac/CompressedBlockAckTimeout\"</span><span class=\"token punctuation\">,</span> TimeValue</pre></td></tr></table></figure><p>有许多 ns3 属性可以被上面的 <code>helpers</code>  对象使用来改变默认的行为，例子脚本程序展示了如何改变默认行为。</p>\n<h5 id=\"mobility-configuration\"><a class=\"anchor\" href=\"#mobility-configuration\">#</a> Mobility configuration</h5>\n<p>最后，一个移动模型必须在 <code>wifi device</code>  上进行配置。移动模型被用于计算传播损耗和传播时延。在下一节中提供了两个例子。用户可以引用 <code>Mobility</code>  模块一章获取更多细节。</p>\n<h5 id=\"example-configuration\"><a class=\"anchor\" href=\"#example-configuration\">#</a> Example configuration</h5>\n<p><code>ns3</code>  提供了两个典型的配置 <code>wifi</code>  网络的例子程序 - 一个例子程序使用 <code>adhoc</code>  网络，一个例子程序使用基础设施网络。两个例子程序在 <code>examples/wireless</code>  目录（ <code>wifi-simple-adhoc.cc</code>  和  <code>wifi-simple-infra.cc</code> ）。鼓励用户学习 <code>examples/wireless</code>  目录下的例子。</p>\n<h5 id=\"adhoc-wifinetdevice-configuration\"><a class=\"anchor\" href=\"#adhoc-wifinetdevice-configuration\">#</a> AdHoc WifiNetDevice configuration</h5>\n<p>在这个例子中，我们创建了两个 adhoc 节点，配置了 <code>802.11a wifi</code>  设备。我们使用 <code>ns3::ConstantSpeedPropagationDelayModel</code>  作为传播延时模型，使用带有 3 的指数的 <code>ns3::LogDistancePropagationLossModel</code>  作为传播损耗模型。两个设备都配置 12Mbps 固定速率的 <code>ConstantRateWifiManager</code> 。最后，我们使用 <code>ns3::ListPositionAllocator</code>  手动放置节点位置：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>std<span class=\"token double-colon punctuation\">::</span>string <span class=\"token function\">phyMode</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"OfdmRate12Mbps\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    NodeContainer c<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    c<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span> <span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    WifiHelper wifi<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    wifi<span class=\"token punctuation\">.</span><span class=\"token function\">SetStandard</span> <span class=\"token punctuation\">(</span>WIFI_PHY_STANDARD_80211a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    YansWifiPhyHelper wifiPhy <span class=\"token operator\">=</span> <span class=\"token class-name\">YansWifiPhyHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Default</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">// ns-3 supports RadioTap and Prism tracing extensions for 802.11</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    wifiPhy<span class=\"token punctuation\">.</span><span class=\"token function\">SetPcapDataLinkType</span> <span class=\"token punctuation\">(</span>YansWifiPhyHelper<span class=\"token double-colon punctuation\">::</span>DLT_IEEE802_11_RADIO<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    YansWifiChannelHelper wifiChannel<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    wifiChannel<span class=\"token punctuation\">.</span><span class=\"token function\">SetPropagationDelay</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::ConstantSpeedPropagationDelayModel\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    wifiChannel<span class=\"token punctuation\">.</span><span class=\"token function\">AddPropagationLoss</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::LogDistancePropagationLossModel\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token string\">\"Exponent\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">DoubleValue</span> <span class=\"token punctuation\">(</span><span class=\"token number\">3.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    wifiPhy<span class=\"token punctuation\">.</span><span class=\"token function\">SetChannel</span> <span class=\"token punctuation\">(</span>wifiChannel<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token comment\">// Add a non-QoS upper mac, and disable rate control (i.e. ConstantRateWifiManager)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    NqosWifiMacHelper wifiMac <span class=\"token operator\">=</span> <span class=\"token class-name\">NqosWifiMacHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Default</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    wifi<span class=\"token punctuation\">.</span><span class=\"token function\">SetRemoteStationManager</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::ConstantRateWifiManager\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                    <span class=\"token string\">\"DataMode\"</span><span class=\"token punctuation\">,</span><span class=\"token function\">StringValue</span> <span class=\"token punctuation\">(</span>phyMode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                    <span class=\"token string\">\"ControlMode\"</span><span class=\"token punctuation\">,</span><span class=\"token function\">StringValue</span> <span class=\"token punctuation\">(</span>phyMode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token comment\">// Set it to adhoc mode</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    wifiMac<span class=\"token punctuation\">.</span><span class=\"token function\">SetType</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::AdhocWifiMac\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    NetDeviceContainer devices <span class=\"token operator\">=</span> wifi<span class=\"token punctuation\">.</span><span class=\"token function\">Install</span> <span class=\"token punctuation\">(</span>wifiPhy<span class=\"token punctuation\">,</span> wifiMac<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token comment\">// Configure mobility</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    MobilityHelper mobility<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    Ptr<span class=\"token operator\">&lt;</span>ListPositionAllocator<span class=\"token operator\">></span> positionAlloc <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">CreateObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>ListPositionAllocator<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    positionAlloc<span class=\"token operator\">-></span><span class=\"token function\">Add</span> <span class=\"token punctuation\">(</span><span class=\"token function\">Vector</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    positionAlloc<span class=\"token operator\">-></span><span class=\"token function\">Add</span> <span class=\"token punctuation\">(</span><span class=\"token function\">Vector</span> <span class=\"token punctuation\">(</span><span class=\"token number\">5.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    mobility<span class=\"token punctuation\">.</span><span class=\"token function\">SetPositionAllocator</span> <span class=\"token punctuation\">(</span>positionAlloc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    mobility<span class=\"token punctuation\">.</span><span class=\"token function\">SetMobilityModel</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::ConstantPositionMobilityModel\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    mobility<span class=\"token punctuation\">.</span><span class=\"token function\">Install</span> <span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token comment\">// other set up (e.g. InternetStack, Application)Infrastructure (access point and clients) </span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\">//  WifiNetDevice configuration</span></pre></td></tr></table></figure><p>这是一个典型的代码，展示了用户如何配置一个接入点 AP 和一系列客户端。在这个例子中，我们创建一个接入点和两个客户端。每一个节点配置 <code>802.11 b wifi</code>  设备：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>std<span class=\"token double-colon punctuation\">::</span>string <span class=\"token function\">phyMode</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"DsssRate1Mbps\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    NodeContainer ap<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    ap<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    NodeContainer sta<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    sta<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span> <span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    WifiHelper wifi<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    wifi<span class=\"token punctuation\">.</span><span class=\"token function\">SetStandard</span> <span class=\"token punctuation\">(</span>WIFI_PHY_STANDARD_80211b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    YansWifiPhyHelper wifiPhy <span class=\"token operator\">=</span> <span class=\"token class-name\">YansWifiPhyHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Default</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">// ns-3 supports RadioTap and Prism tracing extensions for 802.11</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    wifiPhy<span class=\"token punctuation\">.</span><span class=\"token function\">SetPcapDataLinkType</span> <span class=\"token punctuation\">(</span>YansWifiPhyHelper<span class=\"token double-colon punctuation\">::</span>DLT_IEEE802_11_RADIO<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    YansWifiChannelHelper wifiChannel<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">// reference loss must be changed since 802.11b is operating at 2.4GHz</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    wifiChannel<span class=\"token punctuation\">.</span><span class=\"token function\">SetPropagationDelay</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::ConstantSpeedPropagationDelayModel\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    wifiChannel<span class=\"token punctuation\">.</span><span class=\"token function\">AddPropagationLoss</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::LogDistancePropagationLossModel\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                    <span class=\"token string\">\"Exponent\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">DoubleValue</span> <span class=\"token punctuation\">(</span><span class=\"token number\">3.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                    <span class=\"token string\">\"ReferenceLoss\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">DoubleValue</span> <span class=\"token punctuation\">(</span><span class=\"token number\">40.0459</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    wifiPhy<span class=\"token punctuation\">.</span><span class=\"token function\">SetChannel</span> <span class=\"token punctuation\">(</span>wifiChannel<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token comment\">// Add a non-QoS upper mac, and disable rate control</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    NqosWifiMacHelper wifiMac <span class=\"token operator\">=</span> <span class=\"token class-name\">NqosWifiMacHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Default</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    wifi<span class=\"token punctuation\">.</span><span class=\"token function\">SetRemoteStationManager</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::ConstantRateWifiManager\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                    <span class=\"token string\">\"DataMode\"</span><span class=\"token punctuation\">,</span><span class=\"token function\">StringValue</span> <span class=\"token punctuation\">(</span>phyMode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                    <span class=\"token string\">\"ControlMode\"</span><span class=\"token punctuation\">,</span><span class=\"token function\">StringValue</span> <span class=\"token punctuation\">(</span>phyMode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token comment\">// Setup the rest of the upper mac</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    Ssid ssid <span class=\"token operator\">=</span> <span class=\"token function\">Ssid</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"wifi-default\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token comment\">// setup ap.</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    wifiMac<span class=\"token punctuation\">.</span><span class=\"token function\">SetType</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::ApWifiMac\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            <span class=\"token string\">\"Ssid\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">SsidValue</span> <span class=\"token punctuation\">(</span>ssid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    NetDeviceContainer apDevice <span class=\"token operator\">=</span> wifi<span class=\"token punctuation\">.</span><span class=\"token function\">Install</span> <span class=\"token punctuation\">(</span>wifiPhy<span class=\"token punctuation\">,</span> wifiMac<span class=\"token punctuation\">,</span> ap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    NetDeviceContainer devices <span class=\"token operator\">=</span> apDevice<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token comment\">// setup sta.</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    wifiMac<span class=\"token punctuation\">.</span><span class=\"token function\">SetType</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::StaWifiMac\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            <span class=\"token string\">\"Ssid\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">SsidValue</span> <span class=\"token punctuation\">(</span>ssid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            <span class=\"token string\">\"ActiveProbing\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">BooleanValue</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    NetDeviceContainer staDevice <span class=\"token operator\">=</span> wifi<span class=\"token punctuation\">.</span><span class=\"token function\">Install</span> <span class=\"token punctuation\">(</span>wifiPhy<span class=\"token punctuation\">,</span> wifiMac<span class=\"token punctuation\">,</span> sta<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    devices<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span> <span class=\"token punctuation\">(</span>staDevice<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token comment\">// Configure mobility</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    MobilityHelper mobility<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    Ptr<span class=\"token operator\">&lt;</span>ListPositionAllocator<span class=\"token operator\">></span> positionAlloc <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">CreateObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>ListPositionAllocator<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    positionAlloc<span class=\"token operator\">-></span><span class=\"token function\">Add</span> <span class=\"token punctuation\">(</span><span class=\"token function\">Vector</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    positionAlloc<span class=\"token operator\">-></span><span class=\"token function\">Add</span> <span class=\"token punctuation\">(</span><span class=\"token function\">Vector</span> <span class=\"token punctuation\">(</span><span class=\"token number\">5.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    positionAlloc<span class=\"token operator\">-></span><span class=\"token function\">Add</span> <span class=\"token punctuation\">(</span><span class=\"token function\">Vector</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    mobility<span class=\"token punctuation\">.</span><span class=\"token function\">SetPositionAllocator</span> <span class=\"token punctuation\">(</span>positionAlloc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    mobility<span class=\"token punctuation\">.</span><span class=\"token function\">SetMobilityModel</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::ConstantPositionMobilityModel\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    mobility<span class=\"token punctuation\">.</span><span class=\"token function\">Install</span> <span class=\"token punctuation\">(</span>ap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    mobility<span class=\"token punctuation\">.</span><span class=\"token function\">Install</span> <span class=\"token punctuation\">(</span>sta<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token comment\">// other set up (e.g. InternetStack, Application)</span></pre></td></tr></table></figure>",
            "tags": [
                "ns3",
                "ns3"
            ]
        },
        {
            "id": "http://jluyeyu.com/ns3/5.ns3%20wifi%E6%A8%A1%E5%9E%8B/",
            "url": "http://jluyeyu.com/ns3/5.ns3%20wifi%E6%A8%A1%E5%9E%8B/",
            "title": "5.ns3 wifi模型",
            "date_published": "2022-11-01T02:18:52.000Z",
            "content_html": "<h2 id=\"5ns3-wifi模型文档\"><a class=\"anchor\" href=\"#5ns3-wifi模型文档\">#</a> 5.ns3 wifi 模型文档</h2>\n<p>在本节中，将介绍 <code>ns3</code>  中 wifi 模型，</p>\n<h3 id=\"design-documentation\"><a class=\"anchor\" href=\"#design-documentation\">#</a> Design Documentation</h3>\n<p>ns3 节点 ( <code>nodes</code> ) 能够包含一系列网络设备（ <code>NetDevice</code> ）对象，就像实际的计算机包含单独的接口卡一样，例如，以太网卡，WiFi，蓝牙等。通过添加 <code>WifiNetDevice</code>  对象到 ns3 的节点（ <code>nodes</code> ）中，它就可以创建基于 <code>802.11</code>  的基础设施和 <code>adhoc</code>  网络模型。</p>\n<h4 id=\"overview-of-the-model\"><a class=\"anchor\" href=\"#overview-of-the-model\">#</a> Overview of the model</h4>\n<p><code>WifiNetDevice</code>  模型是一个基于 <code>IEEE 802.11</code>  标准的无线网络接口控制器。我们将会更加详细的看到它的细节，但只是简略的细节，ns3 提供了 <code>802.11</code>  模型的这些方面：</p>\n<pre><code>基本的802.11 DCF（Distributed coordination function）基础设施和adhoc模式\n802.11a 802.11b 802.11g 802.11n(包括2.4和5GHz带宽) 和802.11ac物理层\n延伸与802.11n的MSDU aggregation and MPDU aggregation ，同时支持两种聚合的结合\n延伸于802.11e的QoS-based EDCA and queueing\n使用不同的传播损耗模型和传播延迟模型的能力，请参见章（Propagation）传播获取更多细节\n不同的速率控制算法，包括Aarf,Arf,Cara,Onoe,Rraa,ConstantRate,Minstrel\n802.11s(mesh),该协议在其他章节有描述\n</code></pre>\n<p>在 <code>ns3</code>  中提供的一系列 <code>802.11</code>  模型提供了一个精确的 <code>802.11</code>  规范的 <code>MAC</code>  层，并提供了 <code>802.11a/b/g/n/ac</code>  规范的不那么慢的 <code>PHY</code>  层模型。</p>\n<p>在 <code>ns3</code> ，节点可以在不同的信道上有不同的 <code>WifiNetDevices</code> ，同时 <code>WifiNetDevices</code>  可以与其他的设备类型共存；这消除了在 <code>ns2</code>  中结构的限制。然而，现在，还不存在交叉信道干扰或耦合的模型。</p>\n<p><code>WifiNetDevices</code>  的源码在目录 <code>src/wifi</code>  下。</p>\n<p>代码的实现是模块化的，大约提供了四个级别的模型：</p>\n<pre><code>    1.PHY layer models\n    2.MAC low models: they implement DCF and EDCAF\n    3.MAC high models:they implement the MAC-level beacon generation, probing, and association state machines\n    4.可以被MAC low models使用的Rate control algorithms\n</code></pre>\n<p>下面，我们介绍每一层的概述。关于更多的细节稍候会讨论。</p>\n<p><strong>MAC high models</strong></p>\n<p>现在已有三个 <code>MAC high models</code> ，该模型提供了三个无线拓扑元素 ( <code>non-mesh,mesh equivalent</code> , 都是 <code>ns3::RegularWifiMac</code>  的子类，不再这里讨论它)： <code>Access Point(AP)(ns3::ApWifiMac),non-AP Station(STA)(ns3::StaWifiMac)</code> , 和独立于基础服务设备的 <code>STA（ns3::AdhocWifiMac）</code> .</p>\n<p>三种模型中最简单的是 <code>ns3::AdhocWifiMac</code> , 它实现了无任何种类的信标的产生，探测和关联的 <code>WIFI MAC</code> 。</p>\n<pre><code>     The ns3::StaWifiMac class implements an active probing and association state machine that handles automatic re-association whenever too many beacons are missed. Finally, ns3::ApWifiMac implements an AP that generates periodic beacons, and that accepts every attempt to associate.\n</code></pre>\n<p>这三种 <code>MAC high models</code>  共享同一个父类 <code>ns3::RegularWifiMac</code> , 它暴露出 <code>MAC</code>  配置的几个属性： <code>QosSupported</code>  属性，允许配置 <code>802.11e/WMM-STYPE QOS</code>  支持； <code>HtSupported</code>  属性，允许配置 <code>802.11n</code>  高吞吐量形式； <code>VhtSupported</code>  属性，允许配置 <code>802.11ac</code>  更高吞吐量样式支持。</p>\n<p><strong>MAC low layer</strong></p>\n<p><code>MAC low layer</code>  分为以下三个组件：</p>\n<pre><code>1. ns3::MacLow 该类管理 RTS/CTS/DATA/ACK交互。\n2. ns3::DcfManager和ns3::DcfState,实现了DCF和EDCAF功能。\n3. ns3::DcaTxop和ns3::EdcaTxopN,用于处理在需要的情况下的包队列，包分组，包重传等。The ns3::DcaTxop object is used high MACs that are not QoS-enabled,and for transmission of frames (e.g., of type Management) that the standard says should access the medium using the DCF. ns3::EdcaTxopN is is used by QoS-enabled high MACs and also performs 802.11n-style MSDU aggregation.\n</code></pre>\n<p><strong>Rate control algorithms</strong></p>\n<p>有几种 <code>MAC low layer</code>  使用的 <code>rate control algorithms</code> 。完整的可以使用的速率控制算法将会在一个单独的一节中提供。</p>\n<p><strong>PHY layer models</strong></p>\n<p><code>PHY</code>  层是在 <code>ns3::WifiPhy</code>  类中单独实现的。物理层模型的实现的完整的描述是在论文： <code>Yet Another Network Simulator</code>  中，基于 802.11b 的可用的结果的验证报告在 <code>techinical report</code>  中。</p>\n<h4 id=\"the-wifichannel-and-wifiphy-models\"><a class=\"anchor\" href=\"#the-wifichannel-and-wifiphy-models\">#</a> The WifiChannel and WifiPhy models</h4>\n<p>无线信道 <code>wifichannel</code>  可以使用一组 <code>ns3::WifiNetDevice</code>  网络接口连接在一起。 <code>ns3::WifiPhy</code>  对象是在 <code>wifinetdevice</code>  中的，用于接收从信道接收的数据比特。对于信道的传播模型，可以使用传播模块 <code>Propagation</code> 。<br />\n本节总结了误码率计算的描述，该误码率在论文中把在 802.11a 协议中的前向纠错考虑了进去，并描述了一个包是否被成功接收所实现的算法。请参阅 <code>Yet Another Network Simulator</code>  的更多细节。</p>\n<p>PHY 层的状态会是下面五种其中的一种：</p>\n<ol>\n<li>TX： <code>the PHY is currently transmitting a signal on behalf of its associated MAC</code> （phy 层正在发送与之关联的 MAC 的信号）</li>\n<li>RX： <code>the PHY is synchronized on a signal and is waiting until it has received its last bit to forward it to the MAC.</code> （ <code>phy</code>  已经同步了信号，正在等待止到接收到最后一个比特位，然后转发到 MAC 层）</li>\n<li>IDLE： <code>the PHY is not in the TX, RX, or CCA BUSY states</code> .（PHY 层空闲）</li>\n<li>CCA Busy： <code>the PHY is not in TX or RX state but the measured energy is higher than the energy detection threshold</code> .（PHY 不在 TX，RX 状态，但是测得的能量高于能量探测阈值）</li>\n<li>SLEEP： <code>the PHY is in a power save mode and cannot send nor receive frames</code> .（PHY 处于节能状态，不发送也不接收）</li>\n</ol>\n<p>当 <code>PHY</code>  不是 <code>IDLE</code>  状态时（也就是说，另外的更早的包已经在接收器中同步了，或者他自己在发送数据），一个新的包的第一个比特位被接收，此时，接收的包将被丢弃。否则，如果 <code>PHY</code>  处于 <code>IDLE</code>  或者 <code>CCA Busy</code>  状态，我们计算这个新的信号的第一位比特的接收能量，并于能量探测阈值进行比较 <code>（as defined by the Clear Channel Assessment function mode 1）</code> 。如果包的能量高， <code>PHY</code>  则转移状态到 <code>RX</code> ，并且当包的最后一个比特位被接收时发起一个事件。否则， <code>PHY</code>  停留在 IDLE 或者 <code>CCA Busy</code>  状态，并丢弃这个包。</p>\n<p><strong>WifiChannel configuration</strong></p>\n<p><code>WifiChannel</code>  的实现使用了传播损耗模型和传播延时模型，这两个模型在 <code>ns3</code>  的 <code>Propagation</code>  模块中有提供。</p>\n<h4 id=\"the-mac-model\"><a class=\"anchor\" href=\"#the-mac-model\">#</a> The MAC model</h4>\n<p><code>802.11</code>  分布式协调功能（ <code>DCF</code> ）是用来计算当授予访问传输介质的时候。如果我们使用一个经过每一个时隙的周期性的定时器，那么实现 DCF 将会特别的容易，</p>\n<p>DCF 程序的回退在【ieee80211】的 9.2.5.2 节中描述的。</p>\n<ol>\n<li>无论由物理层或者虚拟 CS 机制所指示的发现媒质忙，回退程序应为 STA 调用来传送一个帧。</li>\n<li>即使没有另外传输任务在当前队列中，A backoff procedure shall be performed immediately after the end of every transmission with the More Frag-ments bit set to 0 of an MPDU of type Data, Management, or Control with subtype PS-Poll</li>\n</ol>\n<p>总之，如果队列空，一个新到的包应该在信道感知空闲 DIFS 后，马上被传输。如果队列不空，并且在一个成功的 MPDU 之后没有更多的分组，节点应该开始回退定时器。</p>\n<p>一些用户观察到，802.11MAC 与空队列的空闲信道将会马上发送达到该模型的第一帧，而无须等待 DIFS 或者回退，并想知道这是否合规。根据协议标准， <code>The backoff procedure shall be invoked for a STA to transfer a frame when finding the medium busy as indicated by either the physical or virtual CS mechanism.</code>  因此在这种情况下，媒介并不能发现在当前忙，站点将会马上传输。</p>\n<p>更高层的 MAC 功能的实现是在一系列 C++ 类中，功能：</p>\n<pre><code>• packet fragmentation and defragmentation,\n• use of the RTS/CTS protocol,\n• rate control algorithm,\n• connection and disconnection to and from an Access Point,\n• the MAC transmission queue,\n• beacon generation,\n• MSDU aggregation,\n• etc.\n</code></pre>\n<h4 id=\"rate-control-algorithms\"><a class=\"anchor\" href=\"#rate-control-algorithms\">#</a> Rate control algorithms</h4>\n<p>多种速率控制算法在 <code>ns3</code>  中是可用的。一些速率控制算法是用在真实设备中的实际算法；其他一些算法是在文献中找到的。下面的速率控制算法是在 <code>MAC low layer</code>  中使用的：</p>\n<p>真实设备中的算法有：</p>\n<pre><code>ArfWifiManager(WifiHelper的默认算法)【Automatic Rate Fallback(ARF) algorithm 自动速率回退算法 1997年】\nOnoeWifiManager\nConstantRateWifiManager\nMinstrelWifiManager\n文献中的算法：\nIdealWifiManager\nAarfWifiManager【2004年】\nAmrrWifiManager\nCaraWifiManager\nRraaWifiManager【2006年】\nAarfcdWifiManager\nParfWifiManager\nAparfWifiManager\n</code></pre>\n<p><strong>ConstantRateWifiManager</strong></p>\n<p>该算法对每一个包使用相同的传输模式。用户可以设置对于所有 <code>unicast</code>  包的期望的 <code>DataMode</code>  和所有 <code>request</code>  控制包的 <code>ControlMode</code>  (例如 <code>RTS</code> ).</p>\n<p>控制响应帧（比如 <code>CTS，ACK</code> ）的传输参数的选择规则在 <code>802.11</code>  标准中是相当清晰的。 <code>ns3</code>  遵从了这样的标准和从一系列正常速率或者强制性速率选择作为控制响应帧的速率的选择性。这就意味着，即使 <code>ConstantRateWifiManager</code>  被使用，控制响应帧也可能使用不同的速率进行发送。</p>\n<p><code>ConstantRateWifiManager</code>  的 <code>ControlMode</code>  属性仅仅别用与 <code>RTS</code>  帧。 <code>CTS</code>  和 <code>ACK</code>  帧的速率是根据 <code>802.11</code>  标准进行选择的。然而，用户仍然可以手动添加 <code>WifiMode</code>  到基本的速率中，这将允许控制响应帧以其他的速率进行发送。请参考 <code>project wiki</code>  进一步了解这是如何实现的。</p>\n<pre><code>可用的属性有：\nDataMode：（默认WifiMode::OfdmRate6Mbps）specify a mode for all non-unicast packets\nControlMode：（默认WifiMode::OfdmRate6Mbps）specify a mode for all ‘request’ control packets\n</code></pre>\n<p><strong>IdealWifiManager</strong></p>\n<p>这个速率控制算法根据前一个包的发送的信噪比 <code>SNR</code>  来选择最好的模式。考虑节点 A 发送单播包到节点 B。当 B 成功接收到从 A 发送的包时，B 记录所接受的包的 <code>SNR</code>  到 <code>ns3::SnrTag</code> , 然后，添加标签到 ACK 并返回给 A。通过这样做，A 能够了解发送到 B 的包的信噪比 <code>SNR</code> ，并使用一种带宽之外的机制（因此算法名字就是 <code>ideal</code> ）。然后 A 使用 <code>SNR</code>  从一个一系列 SNR 阈值中选择一个传输模式，而这个阈值是从目标 BER 和特定模式的 SNR/BER 曲线构建的。<br />\n可以的属性有：<br />\n <code>BerThreshold</code> （默认 10e-6）： <code>The maximum Bit Error Rate that is used to calculate the SNR threshold for each mode</code> . 最大误码率，用于计算每种模式的 SNR 阈值。</p>\n<p><strong>MinstrelWifiManager</strong></p>\n<p>该算法是源于 <code>madwifi</code>  工程的速率控制算法。它是 <code>Linux</code>  内核默认的速率控制算法。<br />\n <code>Minstre</code> l 跟踪每个成功发送可用速率帧的概率。然后通过乘以速率的概率计算期望的吞吐量。这种方法被选择用于确保不会选择最低速率而趋向于最高速率（尽管最低速率具有更高的概率）。<br />\n在 <code>monstre</code> l 中，大致 10% 的传输是在所谓的 <code>lookaround rate</code>  发送的。 <code>lookaround rate</code>  的目标就是迫使 <code>minstrel</code>  尝试使用比当前速率更高的速率。</p>\n<p><code>IEEE 802.11</code>  标准在物理层支持利用多种速率进行传输，但是并未规定速率选择策略。速率自适应的速率选择算法核心是及时获取能够实时反映信道状态的信息。<br />\n目前获取信道信息的方法主要有两大类：</p>\n<pre><code>1. 信道物理信息直接获取。 比如获取信噪比SNR，接受信号强度，误码率BER\n2. 基于统计的方法.\n</code></pre>\n<p>目前的速率自适应可分为以下 4 类：</p>\n<ol>\n<li>\n<p>利用传送帧连续的成功和失败次数来估计信道质量。比如 ARF 算法，如果连续没有收到两个 ACK，则降低一档速率，发送下面的数据并启动一个定时器；如果连续收到 10 个帧或者定时器时间到，则提高发送速率。缺点：连续成功或失败的次数很难及时适应信道的快速变化。</p>\n</li>\n<li>\n<p>利用物理层指标 (如 SNIR,RSS) 估计信道质量。缺点：已有文献证明 SNIR,RSS 等指标和丢帧率并没有很强的对应关系，而且基于跨层的设计思想在实际应用中存在困难。</p>\n</li>\n<li>\n<p>每隔一段时间以不同速率发送一个或者一些试探帧，用来估计不同数量在信道中的表现。这种方法提高了对其他速率的实时估计能力，但是因为不能发送过多的试探帧，导致个别试探帧的成败决定了速率选择，容易造成误判。如 <code>SampleRate</code> 。</p>\n</li>\n<li>\n<p>利用近一段时间的数据帧的统计特征来决定发送速率。比如 <code>RRAA</code> 。 <code>RRAA</code>  在一段时间（窗口）内统计丢帧率等信息，并将其与相应的门限进行比较。这种方法屏蔽了因为随机丢帧而导致的误判，如果窗口选择合适，能够对信道变化作出及时反应。</p>\n</li>\n</ol>\n<p>内容来源：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW5rLmppYW5zaHUuY29tP3Q9aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZm9yc2lueS9hcnRpY2xlL2RldGFpbHMvNDgwNTc4Mw==\">http://blog.csdn.net/forsiny/article/details/4805783</span></p>\n",
            "tags": [
                "ns3",
                "ns3"
            ]
        },
        {
            "id": "http://jluyeyu.com/ns3/4.%E4%BB%BF%E7%9C%9F%E6%B5%81%E7%A8%8B/",
            "url": "http://jluyeyu.com/ns3/4.%E4%BB%BF%E7%9C%9F%E6%B5%81%E7%A8%8B/",
            "title": "4.仿真流程",
            "date_published": "2022-10-29T02:18:52.000Z",
            "content_html": "<h2 id=\"4仿真流程\"><a class=\"anchor\" href=\"#4仿真流程\">#</a> 4. 仿真流程</h2>\n<p>在本节中，将介绍 <code>ns3</code>  中仿真的流程，</p>\n<h3 id=\"基本流程\"><a class=\"anchor\" href=\"#基本流程\">#</a> 基本流程</h3>\n<p>使用 <code>ns3</code>  仿真时，一般经过以下 4 个步骤。</p>\n<h4 id=\"1-选择或开发相应的模块\"><a class=\"anchor\" href=\"#1-选择或开发相应的模块\">#</a> 1. 选择或开发相应的模块</h4>\n<p>根据实际仿真对象和仿真场景选择相应的仿真模块：如有线网或还是无线网 ( <code>Wi-Fi</code> )，节点移动性 <code>mobility</code> ，能量 <code>energy</code> , 路由协议，应用程序 <code>application</code>  等，若是没有相应模块，那就需要自己编写 (在后续章节中讲述)。</p>\n<h4 id=\"2编写网络仿真脚本\"><a class=\"anchor\" href=\"#2编写网络仿真脚本\">#</a> 2. 编写网络仿真脚本</h4>\n<p>若是有了相应的模块，那么我们就可以搭建网络仿真环境，ns-3 仿真脚本支持 2 种语言：C<ins> 和 Python，两种语言接口的 API 接口是一样的，但是部分 API 可能没有 Python 的接口。所以，仿真主要还是采用 C</ins> 进行编写。</p>\n<p>编写 ns-3 仿真脚本的大体过程如下【具体的例子查看 <code>examples/tutorial/</code>  下面 的示例，后面也会分析一些】：</p>\n<ul>\n<li>\n<p><strong>生成节点</strong>：ns-3 中节点相当于一个空的计算机外壳，我们需要根据需求给这个计算机安装网络所需要的软硬件，如网卡、应用程序、协议栈等。</p>\n</li>\n<li>\n<p><strong>安装网卡设备</strong>：不同的网络类型有不同的网络设备，从而提供不同的通信、物理层和 MAC 层，如 <code>CSMA WI-FI WIMAX</code>  和 <code>point-to-point</code>  等。</p>\n</li>\n<li>\n<p><strong>安装协议栈</strong>： <code>ns-3</code>  网络中一般是 <code>TCP/IP</code>  协议栈，依据网络选择具体协议，如是 <code>UDP</code>  还是 <code>TCP</code> ，选择何种不同的路由协议（ <code>OLSR</code>   <code>AODV</code>  和 <code>Global</code>  等）并为其配置相应的 IP 地址， <code>ns3</code>  既支持 <code>IPv4</code>  也支持 <code>IPv6</code>  。</p>\n</li>\n<li>\n<p><strong>安装应用层协议</strong>：依据选择的传输层协议选择相应的应用层协议，但是有时需要自己编写应用层产生数据流量的代码。</p>\n</li>\n<li>\n<p>其他配置：如节点是否移动，是否需要能量管理等</p>\n</li>\n<li>\n<p><strong>启动仿真</strong>：整个网络场景配置完毕，启动仿真</p>\n</li>\n</ul>\n<h4 id=\"3仿真结果分析\"><a class=\"anchor\" href=\"#3仿真结果分析\">#</a> 3. 仿真结果分析</h4>\n<p>仿真结果一般有两种：一种是网络场景，二是网络数据。网络场景如节点拓扑结构、移动模型等，一般通过可视化界面（ <code>PyViz</code>  或者 <code>NetAnim</code> ）可直接观测到。网络数据可以在可视化界面进行简单统计，此外还可以通过专门的统计框架 <code>status</code>  或者自行通过 <code>ns3</code>  提供的追踪框架收集、统计和分析相应的网络数据，如数据分组的延迟、网络流量、分组丢失和节点消息缓存队列的等，<strong> 但是上述统计结果对于一些新的开源模块可能不一定有用，所以更推荐的是采用 track 自行分析。</strong>。</p>\n<h4 id=\"4依据仿真结果调整网络配置参数或者修改源代码\"><a class=\"anchor\" href=\"#4依据仿真结果调整网络配置参数或者修改源代码\">#</a> 4. 依据仿真结果调整网络配置参数或者修改源代码。</h4>\n<h3 id=\"例子\"><a class=\"anchor\" href=\"#例子\">#</a> 例子</h3>\n<p>为了更好的展示上述流程，样例代码是 <code>aodv</code>  的实例代码，位于 <code>ns-3.xx/src/aodv/examples</code></p>\n<p>完整代码如下所示：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;iostream></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;cmath></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/aodv-module.h\"</span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/core-module.h\"</span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/network-module.h\"</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/internet-module.h\"</span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/mobility-module.h\"</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/point-to-point-module.h\"</span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/v4ping-helper.h\"</span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/yans-wifi-helper.h\"</span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">using</span> <span class=\"token keyword\">namespace</span> ns3<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"15\"></td><td><pre> * \\ingroup aodv-examples</pre></td></tr><tr><td data-num=\"16\"></td><td><pre> * \\ingroup examples</pre></td></tr><tr><td data-num=\"17\"></td><td><pre> * \\brief Test script.</pre></td></tr><tr><td data-num=\"18\"></td><td><pre> * </pre></td></tr><tr><td data-num=\"19\"></td><td><pre> * This script creates 1-dimensional grid topology and then ping last node from the first one:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre> * </pre></td></tr><tr><td data-num=\"21\"></td><td><pre> * [10.0.0.1] &lt;-- step --> [10.0.0.2] &lt;-- step --> [10.0.0.3] &lt;-- step --> [10.0.0.4]</pre></td></tr><tr><td data-num=\"22\"></td><td><pre> * </pre></td></tr><tr><td data-num=\"23\"></td><td><pre> * ping 10.0.0.4</pre></td></tr><tr><td data-num=\"24\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"25\"></td><td><pre> * When 1/3 of simulation time has elapsed, one of the nodes is moved out of</pre></td></tr><tr><td data-num=\"26\"></td><td><pre> * range, thereby breaking the topology.  By default, this will result in</pre></td></tr><tr><td data-num=\"27\"></td><td><pre> * only 34 of 100 pings being received.  If the step size is reduced</pre></td></tr><tr><td data-num=\"28\"></td><td><pre> * to cover the gap, then all pings can be received.</pre></td></tr><tr><td data-num=\"29\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">AodvExample</span> </pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token keyword\">public</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token function\">AodvExample</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>   * \\brief Configure script parameters</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>   * \\param argc is the command line argument count</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>   * \\param argv is the command line arguments</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>   * \\return true on successful configuration</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  */</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token keyword\">bool</span> <span class=\"token function\">Configure</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token operator\">*</span>argv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token comment\">/// Run simulation</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">Run</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>   * Report results</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>   * \\param os the output stream</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>   */</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">Report</span> <span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>ostream <span class=\"token operator\">&amp;</span> os<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token keyword\">private</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  <span class=\"token comment\">// parameters</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  <span class=\"token comment\">/// Number of nodes</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token keyword\">uint32_t</span> size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  <span class=\"token comment\">/// Distance between nodes, meters</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  <span class=\"token keyword\">double</span> step<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  <span class=\"token comment\">/// Simulation time, seconds</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  <span class=\"token keyword\">double</span> totalTime<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  <span class=\"token comment\">/// Write per-device PCAP traces if true</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  <span class=\"token keyword\">bool</span> pcap<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  <span class=\"token comment\">/// Print routes if true</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  <span class=\"token keyword\">bool</span> printRoutes<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  <span class=\"token comment\">// network</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  <span class=\"token comment\">/// nodes used in the example</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  NodeContainer nodes<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  <span class=\"token comment\">/// devices used in the example</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  NetDeviceContainer devices<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  <span class=\"token comment\">/// interfaces used in the example</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  Ipv4InterfaceContainer interfaces<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token keyword\">private</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>  <span class=\"token comment\">/// Create the nodes</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">CreateNodes</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  <span class=\"token comment\">/// Create the devices</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">CreateDevices</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  <span class=\"token comment\">/// Create the network</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">InstallInternetStack</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  <span class=\"token comment\">/// Create the simulation applications</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">InstallApplications</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre></pre></td></tr><tr><td data-num=\"82\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token operator\">*</span>argv<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  AodvExample test<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>test<span class=\"token punctuation\">.</span><span class=\"token function\">Configure</span> <span class=\"token punctuation\">(</span>argc<span class=\"token punctuation\">,</span> argv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>    <span class=\"token function\">NS_FATAL_ERROR</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Configuration failed. Aborted.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>  test<span class=\"token punctuation\">.</span><span class=\"token function\">Run</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>  test<span class=\"token punctuation\">.</span><span class=\"token function\">Report</span> <span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>cout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre></pre></td></tr><tr><td data-num=\"93\"></td><td><pre><span class=\"token comment\">//-----------------------------------------------------------------------------</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre><span class=\"token class-name\">AodvExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">AodvExample</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>  <span class=\"token function\">size</span> <span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>  <span class=\"token function\">step</span> <span class=\"token punctuation\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>  <span class=\"token function\">totalTime</span> <span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>  <span class=\"token function\">pcap</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>  <span class=\"token function\">printRoutes</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre></pre></td></tr><tr><td data-num=\"103\"></td><td><pre><span class=\"token keyword\">bool</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre><span class=\"token class-name\">AodvExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Configure</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token operator\">*</span>argv<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>  <span class=\"token comment\">// Enable AODV logs by default. Comment this if too noisy</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>  <span class=\"token comment\">// LogComponentEnable(\"AodvRoutingProtocol\", LOG_LEVEL_ALL);</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>  <span class=\"token class-name\">SeedManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">SetSeed</span> <span class=\"token punctuation\">(</span><span class=\"token number\">12345</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>  CommandLine <span class=\"token function\">cmd</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>  cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"pcap\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Write PCAP traces.\"</span><span class=\"token punctuation\">,</span> pcap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>  cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"printRoutes\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Print routing table dumps.\"</span><span class=\"token punctuation\">,</span> printRoutes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>  cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"size\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Number of nodes.\"</span><span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>  cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"time\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Simulation time, s.\"</span><span class=\"token punctuation\">,</span> totalTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>  cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"step\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Grid step, m\"</span><span class=\"token punctuation\">,</span> step<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>  cmd<span class=\"token punctuation\">.</span><span class=\"token function\">Parse</span> <span class=\"token punctuation\">(</span>argc<span class=\"token punctuation\">,</span> argv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre></pre></td></tr><tr><td data-num=\"122\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre><span class=\"token class-name\">AodvExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Run</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre><span class=\"token comment\">//  Config::SetDefault (\"ns3::WifiRemoteStationManager::RtsCtsThreshold\", UintegerValue (1)); // enable rts cts all the time.</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>  <span class=\"token function\">CreateNodes</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>  <span class=\"token function\">CreateDevices</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>  <span class=\"token function\">InstallInternetStack</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>  <span class=\"token function\">InstallApplications</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Starting simulation for \"</span> <span class=\"token operator\">&lt;&lt;</span> totalTime <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" s ...\\n\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>  <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Stop</span> <span class=\"token punctuation\">(</span><span class=\"token function\">Seconds</span> <span class=\"token punctuation\">(</span>totalTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>  <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Run</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>  <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Destroy</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre></pre></td></tr><tr><td data-num=\"138\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre><span class=\"token class-name\">AodvExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Report</span> <span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>ostream <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre><span class=\"token punctuation\">&#123;</span> </pre></td></tr><tr><td data-num=\"141\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre></pre></td></tr><tr><td data-num=\"143\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre><span class=\"token class-name\">AodvExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">CreateNodes</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Creating \"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span><span class=\"token punctuation\">)</span>size <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" nodes \"</span> <span class=\"token operator\">&lt;&lt;</span> step <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" m apart.\\n\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>  nodes<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span> <span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>  <span class=\"token comment\">// Name nodes</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">uint32_t</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> size<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>      std<span class=\"token double-colon punctuation\">::</span>ostringstream os<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>      os <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"node-\"</span> <span class=\"token operator\">&lt;&lt;</span> i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>      <span class=\"token class-name\">Names</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Add</span> <span class=\"token punctuation\">(</span>os<span class=\"token punctuation\">.</span><span class=\"token function\">str</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> nodes<span class=\"token punctuation\">.</span><span class=\"token function\">Get</span> <span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>  <span class=\"token comment\">// Create static grid</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>  MobilityHelper mobility<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>  mobility<span class=\"token punctuation\">.</span><span class=\"token function\">SetPositionAllocator</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::GridPositionAllocator\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>                                 <span class=\"token string\">\"MinX\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">DoubleValue</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>                                 <span class=\"token string\">\"MinY\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">DoubleValue</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>                                 <span class=\"token string\">\"DeltaX\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">DoubleValue</span> <span class=\"token punctuation\">(</span>step<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>                                 <span class=\"token string\">\"DeltaY\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">DoubleValue</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>                                 <span class=\"token string\">\"GridWidth\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">UintegerValue</span> <span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>                                 <span class=\"token string\">\"LayoutType\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">StringValue</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"RowFirst\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>  mobility<span class=\"token punctuation\">.</span><span class=\"token function\">SetMobilityModel</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::ConstantPositionMobilityModel\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>  mobility<span class=\"token punctuation\">.</span><span class=\"token function\">Install</span> <span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre></pre></td></tr><tr><td data-num=\"168\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre><span class=\"token class-name\">AodvExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">CreateDevices</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>  WifiMacHelper wifiMac<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>  wifiMac<span class=\"token punctuation\">.</span><span class=\"token function\">SetType</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::AdhocWifiMac\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>  YansWifiPhyHelper wifiPhy <span class=\"token operator\">=</span> <span class=\"token class-name\">YansWifiPhyHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Default</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>  YansWifiChannelHelper wifiChannel <span class=\"token operator\">=</span> <span class=\"token class-name\">YansWifiChannelHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Default</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>  wifiPhy<span class=\"token punctuation\">.</span><span class=\"token function\">SetChannel</span> <span class=\"token punctuation\">(</span>wifiChannel<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>  WifiHelper wifi<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>  wifi<span class=\"token punctuation\">.</span><span class=\"token function\">SetRemoteStationManager</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::ConstantRateWifiManager\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"DataMode\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">StringValue</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"OfdmRate6Mbps\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"RtsCtsThreshold\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">UintegerValue</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>  devices <span class=\"token operator\">=</span> wifi<span class=\"token punctuation\">.</span><span class=\"token function\">Install</span> <span class=\"token punctuation\">(</span>wifiPhy<span class=\"token punctuation\">,</span> wifiMac<span class=\"token punctuation\">,</span> nodes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"179\"></td><td><pre></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pcap<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>      wifiPhy<span class=\"token punctuation\">.</span><span class=\"token function\">EnablePcapAll</span> <span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">string</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"aodv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre></pre></td></tr><tr><td data-num=\"186\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre><span class=\"token class-name\">AodvExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">InstallInternetStack</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>  AodvHelper aodv<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>  <span class=\"token comment\">// you can configure AODV attributes here using aodv.Set(name, value)</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>  InternetStackHelper stack<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>  stack<span class=\"token punctuation\">.</span><span class=\"token function\">SetRoutingHelper</span> <span class=\"token punctuation\">(</span>aodv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// has effect on the next Install ()</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>  stack<span class=\"token punctuation\">.</span><span class=\"token function\">Install</span> <span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>  Ipv4AddressHelper address<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>  address<span class=\"token punctuation\">.</span><span class=\"token function\">SetBase</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"10.0.0.0\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"255.0.0.0\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre>  interfaces <span class=\"token operator\">=</span> address<span class=\"token punctuation\">.</span><span class=\"token function\">Assign</span> <span class=\"token punctuation\">(</span>devices<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>printRoutes<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>      Ptr<span class=\"token operator\">&lt;</span>OutputStreamWrapper<span class=\"token operator\">></span> routingStream <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>OutputStreamWrapper<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"aodv.routes\"</span><span class=\"token punctuation\">,</span> std<span class=\"token double-colon punctuation\">::</span>ios<span class=\"token double-colon punctuation\">::</span>out<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre>      aodv<span class=\"token punctuation\">.</span><span class=\"token function\">PrintRoutingTableAllAt</span> <span class=\"token punctuation\">(</span><span class=\"token function\">Seconds</span> <span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> routingStream<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"202\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre></pre></td></tr><tr><td data-num=\"205\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre><span class=\"token class-name\">AodvExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">InstallApplications</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"207\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"208\"></td><td><pre>  V4PingHelper <span class=\"token function\">ping</span> <span class=\"token punctuation\">(</span>interfaces<span class=\"token punctuation\">.</span><span class=\"token function\">GetAddress</span> <span class=\"token punctuation\">(</span>size <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"209\"></td><td><pre>  ping<span class=\"token punctuation\">.</span><span class=\"token function\">SetAttribute</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Verbose\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">BooleanValue</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre></pre></td></tr><tr><td data-num=\"211\"></td><td><pre>  ApplicationContainer p <span class=\"token operator\">=</span> ping<span class=\"token punctuation\">.</span><span class=\"token function\">Install</span> <span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">.</span><span class=\"token function\">Get</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"212\"></td><td><pre>  p<span class=\"token punctuation\">.</span><span class=\"token function\">Start</span> <span class=\"token punctuation\">(</span><span class=\"token function\">Seconds</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"213\"></td><td><pre>  p<span class=\"token punctuation\">.</span><span class=\"token function\">Stop</span> <span class=\"token punctuation\">(</span><span class=\"token function\">Seconds</span> <span class=\"token punctuation\">(</span>totalTime<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token function\">Seconds</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.001</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"214\"></td><td><pre></pre></td></tr><tr><td data-num=\"215\"></td><td><pre>  <span class=\"token comment\">// move node away</span></pre></td></tr><tr><td data-num=\"216\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>Node<span class=\"token operator\">></span> node <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">.</span><span class=\"token function\">Get</span> <span class=\"token punctuation\">(</span>size<span class=\"token operator\">/</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"217\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>MobilityModel<span class=\"token operator\">></span> mob <span class=\"token operator\">=</span> node<span class=\"token operator\">-></span><span class=\"token generic-function\"><span class=\"token function\">GetObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>MobilityModel<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre>  <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Schedule</span> <span class=\"token punctuation\">(</span><span class=\"token function\">Seconds</span> <span class=\"token punctuation\">(</span>totalTime<span class=\"token operator\">/</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>MobilityModel<span class=\"token double-colon punctuation\">::</span>SetPosition<span class=\"token punctuation\">,</span> mob<span class=\"token punctuation\">,</span> <span class=\"token function\">Vector</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1e5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1e5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1e5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"219\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>从上述代码 <code>run</code>  函数中也可以很清晰的看出，实际上总共就分为几个步骤.</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">AodvExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Run</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token function\">CreateNodes</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 创建节点</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">CreateDevices</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 创建设备</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token function\">InstallInternetStack</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 安装协议栈</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token function\">InstallApplications</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 设置应用</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Starting simulation for \"</span> <span class=\"token operator\">&lt;&lt;</span> totalTime <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" s ...\\n\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Stop</span> <span class=\"token punctuation\">(</span><span class=\"token function\">Seconds</span> <span class=\"token punctuation\">(</span>totalTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Run</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Destroy</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"1创建节点过程\"><a class=\"anchor\" href=\"#1创建节点过程\">#</a> 1. 创建节点过程</h4>\n<p>创建了 <code>size</code>  个节点，并编号命名，</p>\n<p>然后节点采用了 <code>Grid</code>  布局，(0,0) 点开始，</p>\n<p>然后设置节点静止不动。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">AodvExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">CreateNodes</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Creating \"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span><span class=\"token punctuation\">)</span>size <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" nodes \"</span> <span class=\"token operator\">&lt;&lt;</span> step <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" m apart.\\n\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  nodes<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span> <span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">// Name nodes</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">uint32_t</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> size<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      std<span class=\"token double-colon punctuation\">::</span>ostringstream os<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      os <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"node-\"</span> <span class=\"token operator\">&lt;&lt;</span> i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token class-name\">Names</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Add</span> <span class=\"token punctuation\">(</span>os<span class=\"token punctuation\">.</span><span class=\"token function\">str</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> nodes<span class=\"token punctuation\">.</span><span class=\"token function\">Get</span> <span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token comment\">// Create static grid</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  MobilityHelper mobility<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  mobility<span class=\"token punctuation\">.</span><span class=\"token function\">SetPositionAllocator</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::GridPositionAllocator\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                                 <span class=\"token string\">\"MinX\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">DoubleValue</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                                 <span class=\"token string\">\"MinY\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">DoubleValue</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                                 <span class=\"token string\">\"DeltaX\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">DoubleValue</span> <span class=\"token punctuation\">(</span>step<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                                 <span class=\"token string\">\"DeltaY\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">DoubleValue</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                                 <span class=\"token string\">\"GridWidth\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">UintegerValue</span> <span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                                 <span class=\"token string\">\"LayoutType\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">StringValue</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"RowFirst\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  mobility<span class=\"token punctuation\">.</span><span class=\"token function\">SetMobilityModel</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::ConstantPositionMobilityModel\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  mobility<span class=\"token punctuation\">.</span><span class=\"token function\">Install</span> <span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"2创建设备\"><a class=\"anchor\" href=\"#2创建设备\">#</a> 2. 创建设备</h4>\n<p>设置了 wifi 信道，wifi 的速率，pcap 设置一般没什么用，需要第三方软件分析可以采用。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">AodvExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">CreateDevices</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  WifiMacHelper wifiMac<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  wifiMac<span class=\"token punctuation\">.</span><span class=\"token function\">SetType</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::AdhocWifiMac\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  YansWifiPhyHelper wifiPhy <span class=\"token operator\">=</span> <span class=\"token class-name\">YansWifiPhyHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Default</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  YansWifiChannelHelper wifiChannel <span class=\"token operator\">=</span> <span class=\"token class-name\">YansWifiChannelHelper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Default</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  wifiPhy<span class=\"token punctuation\">.</span><span class=\"token function\">SetChannel</span> <span class=\"token punctuation\">(</span>wifiChannel<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  WifiHelper wifi<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  wifi<span class=\"token punctuation\">.</span><span class=\"token function\">SetRemoteStationManager</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"ns3::ConstantRateWifiManager\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"DataMode\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">StringValue</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"OfdmRate6Mbps\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"RtsCtsThreshold\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">UintegerValue</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  devices <span class=\"token operator\">=</span> wifi<span class=\"token punctuation\">.</span><span class=\"token function\">Install</span> <span class=\"token punctuation\">(</span>wifiPhy<span class=\"token punctuation\">,</span> wifiMac<span class=\"token punctuation\">,</span> nodes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pcap<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      wifiPhy<span class=\"token punctuation\">.</span><span class=\"token function\">EnablePcapAll</span> <span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">string</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"aodv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"3安装协议栈\"><a class=\"anchor\" href=\"#3安装协议栈\">#</a> 3. 安装协议栈</h4>\n<p>路由选择了 <code>aodv</code>  路由协议，设置了节点的 <code>Ipv4</code>  地址，设置是否需要打印路由表。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">AodvExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">InstallInternetStack</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  AodvHelper aodv<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token comment\">// you can configure AODV attributes here using aodv.Set(name, value)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  InternetStackHelper stack<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  stack<span class=\"token punctuation\">.</span><span class=\"token function\">SetRoutingHelper</span> <span class=\"token punctuation\">(</span>aodv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// has effect on the next Install ()</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  stack<span class=\"token punctuation\">.</span><span class=\"token function\">Install</span> <span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  Ipv4AddressHelper address<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  address<span class=\"token punctuation\">.</span><span class=\"token function\">SetBase</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"10.0.0.0\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"255.0.0.0\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  interfaces <span class=\"token operator\">=</span> address<span class=\"token punctuation\">.</span><span class=\"token function\">Assign</span> <span class=\"token punctuation\">(</span>devices<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>printRoutes<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      Ptr<span class=\"token operator\">&lt;</span>OutputStreamWrapper<span class=\"token operator\">></span> routingStream <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>OutputStreamWrapper<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"aodv.routes\"</span><span class=\"token punctuation\">,</span> std<span class=\"token double-colon punctuation\">::</span>ios<span class=\"token double-colon punctuation\">::</span>out<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      aodv<span class=\"token punctuation\">.</span><span class=\"token function\">PrintRoutingTableAllAt</span> <span class=\"token punctuation\">(</span><span class=\"token function\">Seconds</span> <span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> routingStream<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"4设置应用\"><a class=\"anchor\" href=\"#4设置应用\">#</a> 4. 设置应用</h4>\n<p>设置了 <code>ping</code>  的应用程序，正常测网络性能，用的是 <code>OnOffHelper</code>  或者直接 <code>socket</code>  测试。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">AodvExample</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">InstallApplications</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  V4PingHelper <span class=\"token function\">ping</span> <span class=\"token punctuation\">(</span>interfaces<span class=\"token punctuation\">.</span><span class=\"token function\">GetAddress</span> <span class=\"token punctuation\">(</span>size <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  ping<span class=\"token punctuation\">.</span><span class=\"token function\">SetAttribute</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Verbose\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">BooleanValue</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  ApplicationContainer p <span class=\"token operator\">=</span> ping<span class=\"token punctuation\">.</span><span class=\"token function\">Install</span> <span class=\"token punctuation\">(</span>nodes<span class=\"token punctuation\">.</span><span class=\"token function\">Get</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  p<span class=\"token punctuation\">.</span><span class=\"token function\">Start</span> <span class=\"token punctuation\">(</span><span class=\"token function\">Seconds</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  p<span class=\"token punctuation\">.</span><span class=\"token function\">Stop</span> <span class=\"token punctuation\">(</span><span class=\"token function\">Seconds</span> <span class=\"token punctuation\">(</span>totalTime<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token function\">Seconds</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.001</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token comment\">// move node away</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>Node<span class=\"token operator\">></span> node <span class=\"token operator\">=</span> nodes<span class=\"token punctuation\">.</span><span class=\"token function\">Get</span> <span class=\"token punctuation\">(</span>size<span class=\"token operator\">/</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  Ptr<span class=\"token operator\">&lt;</span>MobilityModel<span class=\"token operator\">></span> mob <span class=\"token operator\">=</span> node<span class=\"token operator\">-></span><span class=\"token generic-function\"><span class=\"token function\">GetObject</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>MobilityModel<span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token class-name\">Simulator</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Schedule</span> <span class=\"token punctuation\">(</span><span class=\"token function\">Seconds</span> <span class=\"token punctuation\">(</span>totalTime<span class=\"token operator\">/</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>MobilityModel<span class=\"token double-colon punctuation\">::</span>SetPosition<span class=\"token punctuation\">,</span> mob<span class=\"token punctuation\">,</span> <span class=\"token function\">Vector</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1e5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1e5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1e5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": [
                "ns3",
                "ns3"
            ]
        },
        {
            "id": "http://jluyeyu.com/ns3/3.waf%E8%BF%90%E8%A1%8C%E5%91%BD%E4%BB%A4%E4%BB%A5%E5%8F%8A%E5%91%BD%E4%BB%A4%E8%A1%8C%E8%A7%A3%E6%9E%90%E7%9A%84%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/",
            "url": "http://jluyeyu.com/ns3/3.waf%E8%BF%90%E8%A1%8C%E5%91%BD%E4%BB%A4%E4%BB%A5%E5%8F%8A%E5%91%BD%E4%BB%A4%E8%A1%8C%E8%A7%A3%E6%9E%90%E7%9A%84%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/",
            "title": "3.waf运行命令以及命令行解析的使用说明",
            "date_published": "2022-10-27T11:00:52.000Z",
            "content_html": "<h2 id=\"3waf运行命令以及命令行解析的使用说明\"><a class=\"anchor\" href=\"#3waf运行命令以及命令行解析的使用说明\">#</a> 3.waf 运行命令以及命令行解析的使用说明</h2>\n<p>在本节中，将介绍 <code>ns3</code>  中 <code>waf</code>  运行命令，及命令行解析</p>\n<h3 id=\"介绍\"><a class=\"anchor\" href=\"#介绍\">#</a> 介绍</h3>\n<p><code>ns3</code>  使用了  <code>waf</code>  编译系统，在 <code>ubuntu</code>  环境下，打开终端，输入：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>./waf --help</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>waf <span class=\"token punctuation\">[</span>command<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>options<span class=\"token punctuation\">]</span></pre></td></tr></table></figure><p>即会出现大量的关于 waf 的命令行命令以及参数信息。</p>\n<p>命令行模式下运行程序，可设置参数。<br />\n参数设置有两行类型参数。一种是程序中的参数（<strong>程序参数</strong>），另一种是<strong>普通参数</strong>。</p>\n<p>例如：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>./waf --run <span class=\"token string\">\"wifi-simple-learn-tcptest --help\"</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>./waf --run <span class=\"token string\">\"code [Program Arguments] [General Arguments]\"</span></pre></td></tr></table></figure><p><strong>程序参数</strong></p>\n<p>这种参数通过在代码中设置的，通过 CommandLine 类完成解析，并设置参数的值。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Program Arguments:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    --phyMode:            Wifi Phy mode <span class=\"token punctuation\">[</span>OfdmRate6Mbps<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    --delta:              <span class=\"token function\">time</span> offset <span class=\"token punctuation\">(</span>microseconds<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> interfering signal <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    --PpacketSize:        size of application packet sent <span class=\"token punctuation\">[</span><span class=\"token number\">1000</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    --IpacketSize:        size of interfering packet sent <span class=\"token punctuation\">[</span><span class=\"token number\">1000</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    --verbose:            turn on all WifiNetDevice log components <span class=\"token punctuation\">[</span>false<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    --packetEnablePrint:  turn on print packet info <span class=\"token punctuation\">[</span>false<span class=\"token punctuation\">]</span></pre></td></tr></table></figure><p>以上参数是在 <code>wifi-simple-learn-tcptest-debug</code>  代码文件中设置的，以上输出信息，<br />\n包含三部分：命令行参数名，参数说明，以及 [] 中括号中给出的参数默认值。</p>\n<p>用法：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>./waf --run <span class=\"token string\">\"examples/wireless/wifi-simple-learn-tcptest --packetEnablePrint=true\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>./waf --run <span class=\"token string\">\"examples/wireless/wifi-simple-learn-tcptest --packetEnablePrint=false\"</span><span class=\"token punctuation\">(</span>这样的设置，等于默认值<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p><strong>通用参数</strong></p>\n<p>这种参数用法：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>./waf --run <span class=\"token string\">\"examples/wireless/wifi-simple-learn-tcptest --PrintHelp\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>./waf --run <span class=\"token string\">\"examples/wireless/wifi-simple-learn-tcptest --PrintGroups\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>//以wifi示例</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>./waf --run <span class=\"token string\">\"examples/wireless/wifi-simple-learn-tcptest --PrintGroup=wifi\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>./waf --run <span class=\"token string\">\"examples/wireless/wifi-simple-learn-tcptest --PrintTypeIds\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>//与PrintHelp相同</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>./waf --run <span class=\"token string\">\"examples/wireless/wifi-simple-learn-tcptest --help\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>//以ns3::AdhocWifiMac示例</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>./waf --run <span class=\"token string\">\"examples/wireless/wifi-simple-learn-tcptest --PrintAttributes=ns3::AdhocWifiMac\"</span></pre></td></tr></table></figure><p>通用参数有:</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>--PrintGlobals:              Print the list of globals.     打印输出可以设置的全局变量</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>--PrintGroups:               Print the list of groups.      打印输出当前程序依赖的模块。</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                                                                这些模块是在脚本配置文件中对当前程序的配置模块。</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>--PrintGroup<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>group<span class=\"token punctuation\">]</span>:        Print all TypeIds of group.    打印输出指定模块的全部TypeId。</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>--PrintTypeIds:              Print all TypeIds.             打印所有TypeId</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>--PrintAttributes<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>typeid<span class=\"token punctuation\">]</span>:  Print all attributes of typeid.打印指定TypeId的属性</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>--PrintHelp:                 Print this <span class=\"token builtin class-name\">help</span> message.       打印帮助信息</pre></td></tr></table></figure><h3 id=\"用法步骤\"><a class=\"anchor\" href=\"#用法步骤\">#</a> 用法步骤</h3>\n<p>第一步：<br />\n在代码中使用 Command 类，定义程序参数，并解析。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>CommandLine cmd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>cmd<span class=\"token punctuation\">.</span><span class=\"token function\">Usage</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"CommandLine example program.\\n\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>             <span class=\"token string\">\"\\n\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>             <span class=\"token string\">\"This little program demonstrates how to use CommandLine.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"intArg\"</span><span class=\"token punctuation\">,</span>  <span class=\"token string\">\"an int argument\"</span><span class=\"token punctuation\">,</span>       intArg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"boolArg\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"a bool argument\"</span><span class=\"token punctuation\">,</span>       boolArg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"strArg\"</span><span class=\"token punctuation\">,</span>  <span class=\"token string\">\"a string argument\"</span><span class=\"token punctuation\">,</span>     strArg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"anti\"</span><span class=\"token punctuation\">,</span>    attrPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"cbArg\"</span><span class=\"token punctuation\">,</span>   <span class=\"token string\">\"a string via callback\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span>SetCbArg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>cmd<span class=\"token punctuation\">.</span><span class=\"token function\">Parse</span> <span class=\"token punctuation\">(</span>argc<span class=\"token punctuation\">,</span> argv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><code>Usage</code>  函数，输出参数信息。</p>\n<p><code>AddValue</code>  函数，有三个参数：<br />\n第一个参数：定义在命令行使用的字符串<br />\n第二个参数：对变量意义说明<br />\n第三个参数：将命令行设置的值，设置到对应的变量。</p>\n<p><code>Parse</code>  函数完成解析命令行参数。</p>\n<p>第二步：</p>\n<p>在命令行使用 <code>AddValue</code>  函数的第一个参数字符串，设置变量对应的值。<br />\n例如：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>./waf --run<span class=\"token operator\">=</span><span class=\"token string\">\"command-line-example --intArg=2 --boolArg --strArg=Hello --cbArg=World --help\"</span></pre></td></tr></table></figure><h3 id=\"说明\"><a class=\"anchor\" href=\"#说明\">#</a> 说明</h3>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">CommandLine</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">AddValue</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> std<span class=\"token double-colon punctuation\">::</span>string <span class=\"token operator\">&amp;</span>name<span class=\"token punctuation\">,</span><span class=\"token keyword\">const</span> std<span class=\"token double-colon punctuation\">::</span>string <span class=\"token operator\">&amp;</span>help<span class=\"token punctuation\">,</span>Callback<span class=\"token operator\">&lt;</span><span class=\"token keyword\">bool</span><span class=\"token punctuation\">,</span> std<span class=\"token double-colon punctuation\">::</span>string<span class=\"token operator\">></span> callback<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">CommandLine</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">AddValue</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> std<span class=\"token double-colon punctuation\">::</span>string <span class=\"token operator\">&amp;</span>name<span class=\"token punctuation\">,</span><span class=\"token keyword\">const</span> std<span class=\"token double-colon punctuation\">::</span>string <span class=\"token operator\">&amp;</span>attributePath<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">CommandLine</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">AddValue</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> std<span class=\"token double-colon punctuation\">::</span>string <span class=\"token operator\">&amp;</span>name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> std<span class=\"token double-colon punctuation\">::</span>string <span class=\"token operator\">&amp;</span>help<span class=\"token punctuation\">,</span>T <span class=\"token operator\">&amp;</span>value<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p><code>CommandLine</code>  类有这三个 <code>AddValue</code>  的函数可以添加，对参数值进行设定。</p>\n<p>第一个函数：对指定的参数设置回调函数。</p>\n<p>第二个函数：对指定的值参数设置属性。这里面的属性参数一般都是 <code>ns3</code>  本身的属性参数。</p>\n<p>第三个函数：对指定的参数设置值。最简单的一种参数值设置。</p>\n<p>示例代码：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> std<span class=\"token double-colon punctuation\">::</span>string attrClass <span class=\"token operator\">=</span> <span class=\"token string\">\"ns3::RandomVariableStream\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">const</span> std<span class=\"token double-colon punctuation\">::</span>string attrName  <span class=\"token operator\">=</span> <span class=\"token string\">\"Antithetic\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">const</span> std<span class=\"token double-colon punctuation\">::</span>string attrPath  <span class=\"token operator\">=</span> attrClass <span class=\"token operator\">+</span> <span class=\"token string\">\"::\"</span> <span class=\"token operator\">+</span> attrName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">// Cache the initial values.  Normally one wouldn't do this,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token comment\">// but we want to demonstrate that CommandLine has changed them.</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token keyword\">int</span> intDef <span class=\"token operator\">=</span> intArg<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token keyword\">bool</span> boolDef <span class=\"token operator\">=</span> boolArg<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">const</span> std<span class=\"token double-colon punctuation\">::</span>string strDef <span class=\"token operator\">=</span> strArg<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">const</span> std<span class=\"token double-colon punctuation\">::</span>string cbDef  <span class=\"token operator\">=</span> g_cbArg<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\">// Look up default value for attribute</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">const</span> TypeId tid <span class=\"token operator\">=</span> <span class=\"token class-name\">TypeId</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">LookupByName</span> <span class=\"token punctuation\">(</span>attrClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>string attrDef<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">TypeId</span><span class=\"token operator\">:</span><span class=\"token base-clause\"><span class=\"token operator\">:</span><span class=\"token class-name\">AttributeInformation</span> <span class=\"token class-name\">info</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    tid<span class=\"token punctuation\">.</span><span class=\"token function\">LookupAttributeByName</span> <span class=\"token punctuation\">(</span>attrName<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>info<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    attrDef <span class=\"token operator\">=</span> info<span class=\"token punctuation\">.</span>originalInitialValue<span class=\"token operator\">-></span><span class=\"token function\">SerializeToString</span> <span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">.</span>checker<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  CommandLine cmd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  cmd<span class=\"token punctuation\">.</span><span class=\"token function\">Usage</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"CommandLine example program.\\n\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>             <span class=\"token string\">\"\\n\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>             <span class=\"token string\">\"This little program demonstrates how to use CommandLine.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"intArg\"</span><span class=\"token punctuation\">,</span>  <span class=\"token string\">\"an int argument\"</span><span class=\"token punctuation\">,</span>       intArg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"boolArg\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"a bool argument\"</span><span class=\"token punctuation\">,</span>       boolArg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token comment\">// 对参数值设定</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"strArg\"</span><span class=\"token punctuation\">,</span>  <span class=\"token string\">\"a string argument\"</span><span class=\"token punctuation\">,</span>     strArg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token comment\">// 对路径属性进行设置</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"anti\"</span><span class=\"token punctuation\">,</span>    attrPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token comment\">// 对参数设置回调函数</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"cbArg\"</span><span class=\"token punctuation\">,</span>   <span class=\"token string\">\"a string via callback\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span>SetCbArg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><hr />\n<h3 id=\"实例\"><a class=\"anchor\" href=\"#实例\">#</a> 实例：</h3>\n<p>例如代码：（代码位置：/core/examples/command-line-example.cc）</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;iostream></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;iomanip></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;string></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"ns3/core-module.h\"</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">using</span> <span class=\"token keyword\">namespace</span> ns3<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>std<span class=\"token double-colon punctuation\">::</span>string g_cbArg <span class=\"token operator\">=</span> <span class=\"token string\">\"cbArg default\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">bool</span> <span class=\"token function\">SetCbArg</span> <span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>string val<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  g_cbArg <span class=\"token operator\">=</span> val<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token keyword\">int</span>         intArg  <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token keyword\">bool</span>        boolArg <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>string strArg  <span class=\"token operator\">=</span> <span class=\"token string\">\"strArg default\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token comment\">// Attribute path</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token keyword\">const</span> std<span class=\"token double-colon punctuation\">::</span>string attrClass <span class=\"token operator\">=</span> <span class=\"token string\">\"ns3::RandomVariableStream\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token keyword\">const</span> std<span class=\"token double-colon punctuation\">::</span>string attrName  <span class=\"token operator\">=</span> <span class=\"token string\">\"Antithetic\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token keyword\">const</span> std<span class=\"token double-colon punctuation\">::</span>string attrPath  <span class=\"token operator\">=</span> attrClass <span class=\"token operator\">+</span> <span class=\"token string\">\"::\"</span> <span class=\"token operator\">+</span> attrName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token keyword\">int</span> intDef <span class=\"token operator\">=</span> intArg<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token keyword\">bool</span> boolDef <span class=\"token operator\">=</span> boolArg<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token keyword\">const</span> std<span class=\"token double-colon punctuation\">::</span>string strDef <span class=\"token operator\">=</span> strArg<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token keyword\">const</span> std<span class=\"token double-colon punctuation\">::</span>string cbDef  <span class=\"token operator\">=</span> g_cbArg<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token comment\">// Look up default value for attribute</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token keyword\">const</span> TypeId tid <span class=\"token operator\">=</span> <span class=\"token class-name\">TypeId</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">LookupByName</span> <span class=\"token punctuation\">(</span>attrClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>string attrDef<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">TypeId</span><span class=\"token operator\">:</span><span class=\"token base-clause\"><span class=\"token operator\">:</span><span class=\"token class-name\">AttributeInformation</span> <span class=\"token class-name\">info</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    tid<span class=\"token punctuation\">.</span><span class=\"token function\">LookupAttributeByName</span> <span class=\"token punctuation\">(</span>attrName<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>info<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    attrDef <span class=\"token operator\">=</span> info<span class=\"token punctuation\">.</span>originalInitialValue<span class=\"token operator\">-></span><span class=\"token function\">SerializeToString</span> <span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">.</span>checker<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  CommandLine cmd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  cmd<span class=\"token punctuation\">.</span><span class=\"token function\">Usage</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"CommandLine example program.\\n\"</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>             <span class=\"token string\">\"\\n\"</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>             <span class=\"token string\">\"This little program demonstrates how to use CommandLine.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"intArg\"</span><span class=\"token punctuation\">,</span>  <span class=\"token string\">\"an int argument\"</span><span class=\"token punctuation\">,</span>       intArg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"boolArg\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"a bool argument\"</span><span class=\"token punctuation\">,</span>       boolArg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"strArg\"</span><span class=\"token punctuation\">,</span>  <span class=\"token string\">\"a string argument\"</span><span class=\"token punctuation\">,</span>     strArg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"anti\"</span><span class=\"token punctuation\">,</span>    attrPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  cmd<span class=\"token punctuation\">.</span><span class=\"token function\">AddValue</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"cbArg\"</span><span class=\"token punctuation\">,</span>   <span class=\"token string\">\"a string via callback\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">MakeCallback</span> <span class=\"token punctuation\">(</span>SetCbArg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  cmd<span class=\"token punctuation\">.</span><span class=\"token function\">Parse</span> <span class=\"token punctuation\">(</span>argc<span class=\"token punctuation\">,</span> argv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  <span class=\"token comment\">// 输出初始值：</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> cmd<span class=\"token punctuation\">.</span><span class=\"token function\">GetName</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\":\"</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Initial values:\"</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>left <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">setw</span> <span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"intArg:\"</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>            <span class=\"token operator\">&lt;&lt;</span>                    intDef</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">setw</span> <span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span>              <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"boolArg:\"</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>            <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>boolalpha  <span class=\"token operator\">&lt;&lt;</span> boolDef  <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>noboolalpha</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>            <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">setw</span> <span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span>              <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"strArg:\"</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>            <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\"\"</span>            <span class=\"token operator\">&lt;&lt;</span> strDef   <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\"\"</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>            <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">setw</span> <span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span>              <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"anti:\"</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\"\"</span>            <span class=\"token operator\">&lt;&lt;</span> attrDef  <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\"\"</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>            <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">setw</span> <span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span>              <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"cbArg:\"</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>            <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\"\"</span>            <span class=\"token operator\">&lt;&lt;</span> cbDef    <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\"\"</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>            <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  <span class=\"token comment\">// 输出最终值：</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Final values:\"</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>left <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">setw</span> <span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"intArg:\"</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>            <span class=\"token operator\">&lt;&lt;</span>                    intArg</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>            <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">setw</span> <span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span>              <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"boolArg:\"</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>            <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>boolalpha  <span class=\"token operator\">&lt;&lt;</span> boolArg</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>            <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>noboolalpha</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>            <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">setw</span> <span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span>              <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"strArg:\"</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>            <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\"\"</span>            <span class=\"token operator\">&lt;&lt;</span> strArg   <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\"\"</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>            <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>  <span class=\"token comment\">// Look up new default value for attribute</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">TypeId</span><span class=\"token operator\">:</span><span class=\"token base-clause\"><span class=\"token operator\">:</span><span class=\"token class-name\">AttributeInformation</span> <span class=\"token class-name\">info</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    tid<span class=\"token punctuation\">.</span><span class=\"token function\">LookupAttributeByName</span> <span class=\"token punctuation\">(</span>attrName<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>info<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">setw</span> <span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span>            <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"anti:\"</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>              <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\"\"</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>              <span class=\"token operator\">&lt;&lt;</span> info<span class=\"token punctuation\">.</span>initialValue<span class=\"token operator\">-></span><span class=\"token function\">SerializeToString</span> <span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">.</span>checker<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>              <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\"\"</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>              <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">setw</span> <span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span>              <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"cbArg:\"</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>            <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\"\"</span>            <span class=\"token operator\">&lt;&lt;</span> g_cbArg  <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\"\"</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>            <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>命令行运行代码：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>./waf --run<span class=\"token operator\">=</span><span class=\"token string\">\"command-line-example\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>./waf --run<span class=\"token operator\">=</span><span class=\"token string\">\"command-line-example --intArg=2 --boolArg --strArg=Hello --cbArg=World\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>./waf --run<span class=\"token operator\">=</span><span class=\"token string\">\"command-line-example --help\"</span></pre></td></tr></table></figure><p>第一行命令，不加参数运行代码</p>\n<p>第二行命令，加程序参数运行代码，其中 intArg=2，strArg=Hello，cbArg=World&quot;</p>\n<p>第三行命令，加通用参数运行代码</p>\n",
            "tags": [
                "ns3",
                "ns3"
            ]
        },
        {
            "id": "http://jluyeyu.com/ns3/2.ns3%E5%85%B3%E9%94%AE%E6%8A%BD%E8%B1%A1/",
            "url": "http://jluyeyu.com/ns3/2.ns3%E5%85%B3%E9%94%AE%E6%8A%BD%E8%B1%A1/",
            "title": "2.ns3关键抽象",
            "date_published": "2022-10-27T07:00:52.000Z",
            "content_html": "<h2 id=\"2ns3关键抽象\"><a class=\"anchor\" href=\"#2ns3关键抽象\">#</a> 2.ns3 关键抽象</h2>\n<p>在本节中，我们将总结一些在网络中常用的，但在 <code>ns3</code>  中有特定含义的术语。</p>\n<h3 id=\"node\"><a class=\"anchor\" href=\"#node\">#</a> Node</h3>\n<p>一个连接到网络的计算设备被称为主机，有时也被称为终端系统。因为 <code>ns3</code>  是一个网络模拟器，在 <code>ns3</code>  中，基本的计算设备抽象被称为 <code>Node</code> 。 <code>C++</code>  中由 <code>Node</code>  类实现。Node 类提供了管理模拟中计算设备的表示方法。人们会添加一些协议，如应用程序、协议栈和外围卡及其相关的驱动程序，以使计算机能够进行有用的工作。我们在 <code>ns-3</code>  中使用同样的基本模型。</p>\n<h3 id=\"application\"><a class=\"anchor\" href=\"#application\">#</a> Application</h3>\n<p><code>Application</code>  是指可以完成某成某些活动的用户程序。 <code>Application</code>  附着在 <code>Node</code>  上，用来模拟该应用运行在一个节点上的场景。在 <code>ns3</code>  中，应用被抽象为一个基类即 <code>Application</code>  类。目录位于 <code>ns-3.xx/src/applications</code>  下。后续自己创建 <code>customized application</code> , 都需要继承这个类。</p>\n<h3 id=\"channel\"><a class=\"anchor\" href=\"#channel\">#</a> Channel</h3>\n<p>通常把网络中数据流流过的媒介称为信道。当你把网线插入到路由器时，就是通过信道将计算机与以太网连接。在 ns3 的模拟环境中，你可以把节点连接到代表数据交换信道的对象上。在这里，基本的通信子网这一抽象概念被称为信道，使用 <code>Channel</code>  类描述。一个信道实例可以模拟一条简单的点对点，也可以模拟一个复杂的巨型以太网交换机，甚至是无线网络中充满障碍物的三维空间，同样的我们也可以自定义新的 <code>Channel</code> 。</p>\n<h3 id=\"netdevice\"><a class=\"anchor\" href=\"#netdevice\">#</a> NetDevice</h3>\n<p>计算机需要通过网络设备才能连接到网络上，如网卡（硬件设备）。而网卡需要软件驱动才能知道从何处取得需要发送至网络中的数据，以及将从网络中获取到的数据发送至计算机的哪个位置。</p>\n<p>​ 在 <code>ns3</code>  中，网络设备这一抽象概念相当于硬件设备和软件驱动的综合。 <code>ns3</code>  仿真环境中，网络设备安装在节点上，使得节点通过信道和其他节点通信。像真实计算机一样，一个节点可以通过多个网络设备同时连接到多条信道上。网络设备使用 <code>NetDevice</code>  类描述， <code>NetDevice</code>  类提供管理连接其他节点和信道对象的各种方法，并且允许开发者以面向对象的方法来自定义。几个特定的网络设备有： <code>CsmaNetDevice</code> 、 <code>PointToPointNetDevice</code>  和 <code>Wi-FiNetDevice</code> 。正如以太网卡被设计在以太网中工作一样， <code>CamsNetDevice</code>  被设计在 CSMA 信道中工作，而 <code>PointToPointNetDevice</code>  在 <code>PointToPoint</code>  信道中工作， <code>Wi-FiNetDevice</code>  在 Wi-Fi 信道中工作。</p>\n<h3 id=\"topology-helpers\"><a class=\"anchor\" href=\"#topology-helpers\">#</a> Topology Helpers</h3>\n<p>如同现实网络中的主机都默认装有内置网卡一样，把网络设备连接到节点、信道、配置 IP 地址等在 ns3 是很普遍的任务，那么干脆提供 “拓扑生成器” 来使这个工作变得尽可能的容易。举例来说：创建一个网络设备，配置一个 MAC 地址，把此网络设备装载到节点上，设置节点的协议栈以及连接网络设备到一个信道，这些事情都需要许多分立的 ns-3 核心操作。而当需要把许多设备连接到多点信道，在网际间将单个网络设备进行连接时，则需要对 ns-3 核心进行更多的分立操作。此时提供拓扑生成器来整合这些大量分立的步骤，使其成为一个简单易用的操作。</p>\n<p>​ 很明显， <code>Helper</code>  类可以极大地方便用户。例如 <code>TopologyReaderHelper</code>  类可以使得更容易配置和使用通用的 <code>TopologyReader</code> 。再如类 <code>InternetStackHelper</code>  是一个安装 <code>PointToPointHelper</code>  对象和点到点网络设备的网络协议栈的拓扑生成器，它会为每一个节点容器中的节点安装一个网络协议栈（如 TCP、UDP 和 IP 等）。</p>\n",
            "tags": [
                "ns3",
                "ns3"
            ]
        },
        {
            "id": "http://jluyeyu.com/ns3/1.ns3%E5%88%9D%E8%AF%86/",
            "url": "http://jluyeyu.com/ns3/1.ns3%E5%88%9D%E8%AF%86/",
            "title": "1.ns3初识",
            "date_published": "2022-10-23T09:00:52.000Z",
            "content_html": "<h2 id=\"1ns3初识\"><a class=\"anchor\" href=\"#1ns3初识\">#</a> 1.ns3 初识</h2>\n<h3 id=\"背景\"><a class=\"anchor\" href=\"#背景\">#</a> 背景</h3>\n<p><code>ns3</code>  是一个<strong>离散事件驱动的网络模拟器</strong>，意在满足学术和教学要求。它是由 C++/Python 编写的开源项目，主要运行平台是 GUL/Linux（如 Ubuntu 等）。对于 Windows 系统，可以通过安装虚拟机来运行。  NS3 主要用来模拟计算机网络，可以在模拟现实世界中的各种类型的网络通信。</p>\n<h3 id=\"安装\"><a class=\"anchor\" href=\"#安装\">#</a> 安装</h3>\n<h4 id=\"1环境\"><a class=\"anchor\" href=\"#1环境\">#</a> 1. 环境</h4>\n<p>系统：Ubuntu18.04<br />\n 版本：ns3.xx（实例用的 3.31，推荐 3.27）</p>\n<h4 id=\"2换源\"><a class=\"anchor\" href=\"#2换源\">#</a> 2. 换源</h4>\n<p>将源换成国内的源，比较好，之前用的自带的源，安装可视化的模块时死活装不上，换成国内的源之后，装上了。所以推荐换华为的源<br />\n System setting-&gt;software&amp;update<br />\n<img data-src=\"https://leanote.com/api/file/getImage?fileId=5fb0ddf8ab644104210000f3\" alt=\"图片标题\" /></p>\n<h4 id=\"3安装一些包\"><a class=\"anchor\" href=\"#3安装一些包\">#</a> 3. 安装一些包</h4>\n<p>将下面的代码拷贝到 download.sh 中，批下载</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>gedit download.sh</pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#python 环境</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> gcc g++ python python3 python3-dev</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#安装 Netanim animator 关联库</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> qt5-default mercurial</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#安装 ns-3-pyviz visualizer 关联库</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> gir1.2-goocanvas-2.0 python-gi python-gi-cairo python-pygraphviz python3-gi python3-gi-cairo python3-pygraphviz gir1.2-gtk-3.0 ipython ipython3  </pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#其他关联库</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> openmpi-bin openmpi-common openmpi-doc libopenmpi-dev </pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> gdb valgrind uncrustify</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> python3-sphinx dia gsl-bin libgsl-dev libgsl23 libgslcblas0 tcpdump sqlite sqlite3 libsqlite3-dev libxml2 libxml2-dev</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> libgtk2.0-0 libgtk2.0-dev vtun lxc uml-utilities libboost-signals-dev libboost-filesystem-dev</pre></td></tr></table></figure><p><span class=\"exturl\" data-url=\"aHR0cDovL3huLS1kb3dubG9hZC1sbzl3eTM2Yy5zaA==\">运行 download.sh</span></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sh</span> download.sh</pre></td></tr></table></figure><h4 id=\"4下载ns-3源码\"><a class=\"anchor\" href=\"#4下载ns-3源码\">#</a> 4. 下载 ns-3 源码</h4>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">mkdir</span> workspace</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">cd</span> workspace</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">wget</span> https://www.nsnam.org/release/ns-allinone-3.31.tar.bz2 </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">tar</span> xjf ns-allinone-3.31.tar.bz2</pre></td></tr></table></figure><h4 id=\"5编译ns-3\"><a class=\"anchor\" href=\"#5编译ns-3\">#</a> 5. 编译 ns-3</h4>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> ns-allinone-3.31/ns-3.31/</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>./waf clean</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>./waf configure --build-profile<span class=\"token operator\">=</span>debug --enable-examples --enable-tests</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>./waf</pre></td></tr></table></figure><h4 id=\"6测试\"><a class=\"anchor\" href=\"#6测试\">#</a> 6. 测试</h4>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>./test.py -c core</pre></td></tr></table></figure><p><img data-src=\"https://leanote.com/api/file/getImage?fileId=5fb0ba5cab6441020a00009d\" alt=\"图片标题\" /></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>./waf --run hello-simulator</pre></td></tr></table></figure><p><img data-src=\"https://leanote.com/api/file/getImage?fileId=5fb0ba8fab6441020a0000aa\" alt=\"图片标题\" /></p>\n",
            "tags": [
                "ns3",
                "ns3"
            ]
        },
        {
            "id": "http://jluyeyu.com/ns3/0.ns3%E6%8E%A8%E8%8D%90%E8%B5%84%E6%96%99/",
            "url": "http://jluyeyu.com/ns3/0.ns3%E6%8E%A8%E8%8D%90%E8%B5%84%E6%96%99/",
            "title": "0.ns3推荐资料",
            "date_published": "2022-10-22T07:00:52.000Z",
            "content_html": "<h2 id=\"0ns3推荐资料\"><a class=\"anchor\" href=\"#0ns3推荐资料\">#</a> 0.ns3 推荐资料</h2>\n<h3 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h3>\n<p>随着 2008 年 6 月 <code>ns3</code>  第一个稳定版本的但是，在学术界研究和使用 <code>ns3</code>  的文献逐年增多，然而当前介绍 <code>ns3</code>  的资料确非常少，甚至很多都还是停留在 <code>first.cc</code>  的运行。为了记录下学习 <code>ns3</code>  的过程和分享一些经验吧，写了这样一个专题。希望能有所帮助。</p>\n<h3 id=\"资料\"><a class=\"anchor\" href=\"#资料\">#</a> 资料</h3>\n<ol>\n<li>\n<p>NS3 官方文档，非常适合查看 <code>ns3</code>  的 api<br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubnNuYW0ub3JnL3JlbGVhc2VzL25zLTMtMzcvZG9jdW1lbnRhdGlvbi8=\">Documentation | ns-3</span></p>\n</li>\n<li>\n<p>相关博客<br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC84ZDQxOWRhZTFmOWY=\"> ns3 系列博客</span>，讲述了一些常见模块代码层面上的一些内容。</p>\n</li>\n<li>\n<p>中文书籍，入门用的，很杂但内容不深<br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly95ZXl1LWJsb2cub3NzLWNuLWJlaWppbmcuYWxpeXVuY3MuY29tL3NoYXJlL05TLTMlRTclQkQlOTElRTclQkIlOUMlRTYlQTglQTElRTYlOEIlOUYlRTUlOTklQTglRTUlOUYlQkElRTclQTElODAlRTQlQjglOEUlRTUlQkElOTQlRTclOTQlQTgucGRm\"> ns3 网络模拟器基础及应用</span></p>\n</li>\n<li>\n<p>ns3 强化学习模块</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3Rrbi10dWIvbnMzLWd5bQ==\">GitHub - tkn-tub/ns3-gym: ns3-gym - The Playground for Reinforcement Learning in Networking Research</span></p>\n</li>\n<li>\n<p>ns3 日志模块</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vbG92ZW1vMTMxNC9hcmNoaXZlLzIwMTEvMDIvMjEvMTk1OTUwMS5odG1s\">日志模块</span></p>\n</li>\n</ol>\n",
            "tags": [
                "ns3",
                "ns3"
            ]
        },
        {
            "id": "http://jluyeyu.com/javascript/%E6%8E%A8%E8%8D%90%E6%89%8B%E5%86%99%E9%A2%98%E7%9B%AE%E7%BB%83%E4%B9%A0%E7%BD%91%E7%AB%99/",
            "url": "http://jluyeyu.com/javascript/%E6%8E%A8%E8%8D%90%E6%89%8B%E5%86%99%E9%A2%98%E7%9B%AE%E7%BB%83%E4%B9%A0%E7%BD%91%E7%AB%99/",
            "title": "推荐一个前端js练习网站",
            "date_published": "2022-10-21T02:00:00.000Z",
            "content_html": "<h2 id=\"推荐一个前端js练习网站\"><a class=\"anchor\" href=\"#推荐一个前端js练习网站\">#</a> 推荐一个前端 js 练习网站</h2>\n<h3 id=\"1-背景\"><a class=\"anchor\" href=\"#1-背景\">#</a> 1. 背景</h3>\n<p>通常面试的时候，面试官会提一些 <code>JavaScript</code>  手写的面试题，主要是为了考察面试者 <code>JavaScript</code>  基础的掌握程度。这些题目一般包含一些常用 api 或者功能的简单实现。练习的时候虽然也能写出来，但是因为并不能确定是否满足所有情况，对于正确性无法确定。</p>\n<p>基于上述背景，推荐一个很好用的前端 js 练习网站<span class=\"exturl\" data-url=\"aHR0cHM6Ly9iaWdmcm9udGVuZC5kZXYvcHJvYmxlbQ==\"> Front-End Interview Coding Problems | BFE.dev - prepare for Front-End job interviews.</span></p>\n<h3 id=\"2介绍\"><a class=\"anchor\" href=\"#2介绍\">#</a> 2. 介绍</h3>\n<p>该网站包含 175 道题，大部分是前端 <code>CSS</code>  和 <code>JavaScript</code>  题目，题目质量感觉不错。</p>\n<p><img data-src=\"https://yeyu-blog.oss-cn-beijing.aliyuncs.com/article_images/js-question-all.jpg\" alt=\"题目列表\" /></p>\n<p>和 leetcode 一样，每道题目都包含多个用例，所有用例通过就算完成。也包含讨论区等，可以查看各位 dalao 的写法。</p>\n<p><img data-src=\"https://yeyu-blog.oss-cn-beijing.aliyuncs.com/article_images/js-promise.all.jpg\" alt=\"编写环境展示\" /></p>\n<h3 id=\"3总结\"><a class=\"anchor\" href=\"#3总结\">#</a> 3. 总结</h3>\n<p>这是一个非常好的网站，十分适合新手练习和熟悉常用 api 的写法。</p>\n",
            "tags": [
                "javascript",
                "javascript"
            ]
        },
        {
            "id": "http://jluyeyu.com/hello-blog/",
            "url": "http://jluyeyu.com/hello-blog/",
            "title": "本站说明",
            "date_published": "2022-10-21T01:51:50.462Z",
            "content_html": "<p>​\t本网站主要是分享前端的知识，包括 leetcode 算法题、面试经验、javascript、html、css、前端小技巧、常见框架 (vue、react)、第三方库等使用，也会分享一些自己的学习成长过程、和项目学习经验，以上。</p>\n<p><img data-src=\"https://yeyu-blog.oss-cn-beijing.aliyuncs.com/headicons/m8.jpg\" alt=\"图1\" /></p>\n",
            "tags": []
        },
        {
            "id": "http://jluyeyu.com/javascript/GA%20tracking/",
            "url": "http://jluyeyu.com/javascript/GA%20tracking/",
            "title": "在 React JS 应用程序中借助Google Tag Manager实现 Google Analytics",
            "date_published": "2022-07-10T10:34:52.000Z",
            "content_html": "<h1 id=\"在-react-js-应用程序中借助google-tag-manager实现-google-analytics\"><a class=\"anchor\" href=\"#在-react-js-应用程序中借助google-tag-manager实现-google-analytics\">#</a> 在 React JS 应用程序中借助 Google Tag Manager 实现 Google Analytics</h1>\n<h2 id=\"背景\"><a class=\"anchor\" href=\"#背景\">#</a> 背景</h2>\n<p>几乎每个网站都会统计自身的浏览状况：日 IP、PV、跳出率、转换率、浏览者属性等等。了解这些数据有助于更好地改进服务。 <code>Google Analytics</code>  是一个非常好用的用户活动追踪工具，可以满足大多数需求，接下来会介绍一些如何在 <code>React JS</code>  应用程序中实现  <code>Google Analytics(GA)</code>  和  <code>Google Tag Manager(GTM)</code> 。</p>\n<h2 id=\"介绍\"><a class=\"anchor\" href=\"#介绍\">#</a> 介绍</h2>\n<h3 id=\"gtm\"><a class=\"anchor\" href=\"#gtm\">#</a> GTM</h3>\n<p><code>GTM</code>  是谷歌开发的跟踪代码管理器，可以在平台上添加和更新代码，用于转化跟踪、网站分析、再营销等用途。其优点是灵活性，无需修改项目源代码就可以部署更新，<br />\n并且网站统计分析的代码可以统一管理，可以添加 js,html, 图片等模板，与第三方工具高度集成 (其中就包括 <code>GA</code> ), 方便调试。</p>\n<p>个人感觉在跟踪的过程中起到的是中介的作用，数据从本地代码先经过 <code>GTM</code>  再传到 <code>GA</code></p>\n<h3 id=\"ga\"><a class=\"anchor\" href=\"#ga\">#</a> GA</h3>\n<p><code>GA</code>  是谷歌提供的一种网络分析服务，用于跟踪和报告网站流量，目前是谷歌营销平台品牌内的一个平台</p>\n<h2 id=\"使用\"><a class=\"anchor\" href=\"#使用\">#</a> 使用</h2>\n<h3 id=\"1-将-gtm-容器添加到应用程序中\"><a class=\"anchor\" href=\"#1-将-gtm-容器添加到应用程序中\">#</a> 1. 将 GTM 容器添加到应用程序中</h3>\n<ul>\n<li>方法一：通过 <code>Package</code>  添加 <code>GTM Container Code</code>  (推荐)</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">npm</span> i react-gtm-module</pre></td></tr></table></figure><p>要使用此方法初始化  <code>GTM</code> ，我们需要在  <code>app.js</code>  中引入该包并提供 <code>GTM ID</code> 。</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> TagManager <span class=\"token keyword\">from</span> <span class=\"token string\">\"react-gtm-module\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> tagManagerArgs <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  gtmId<span class=\"token operator\">:</span> <span class=\"token string\">\"&lt;YOUR GTM ID>\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>TagManager<span class=\"token punctuation\">.</span><span class=\"token function\">initialize</span><span class=\"token punctuation\">(</span>tagManagerArgs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ul>\n<li>方法二<br />\n将此代码粘贴到 <code>index.html</code>  中 &lt;head&gt; 靠前位置，</li>\n</ul>\n<figure class=\"highlight html\"><figcaption data-lang=\"HTML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">&lt;!-- Google Tag Manager --></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\"></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">w<span class=\"token punctuation\">,</span> d<span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">,</span> l<span class=\"token punctuation\">,</span> i</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    w<span class=\"token punctuation\">[</span>l<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> w<span class=\"token punctuation\">[</span>l<span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    w<span class=\"token punctuation\">[</span>l<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"gtm.start\"</span><span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> event<span class=\"token operator\">:</span> <span class=\"token string\">\"gtm.js\"</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">var</span> f <span class=\"token operator\">=</span> d<span class=\"token punctuation\">.</span><span class=\"token function\">getElementsByTagName</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      j <span class=\"token operator\">=</span> d<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      dl <span class=\"token operator\">=</span> l <span class=\"token operator\">!=</span> <span class=\"token string\">\"dataLayer\"</span> <span class=\"token operator\">?</span> <span class=\"token string\">\"&amp;l=\"</span> <span class=\"token operator\">+</span> l <span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    j<span class=\"token punctuation\">.</span>async <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    j<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> <span class=\"token string\">\"https://www.googletagmanager.com/gtm.js?id=\"</span> <span class=\"token operator\">+</span> i <span class=\"token operator\">+</span> dl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    f<span class=\"token punctuation\">.</span>parentNode<span class=\"token punctuation\">.</span><span class=\"token function\">insertBefore</span><span class=\"token punctuation\">(</span>j<span class=\"token punctuation\">,</span> f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">,</span> document<span class=\"token punctuation\">,</span> <span class=\"token string\">\"script\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"dataLayer\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"&lt;YOUR GTM ID>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">&lt;!-- End Google Tag Manager --></span></pre></td></tr></table></figure><p>然后在 <code>&lt;body&gt;</code>  中粘贴此代码：</p>\n<figure class=\"highlight html\"><figcaption data-lang=\"HTML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">&lt;!-- 谷歌标签管理器 (noscript) --></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>noscript</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>iframe</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span> https://www.googletagmanager.com/ns.html?id= &lt;YOUR GTM ID><span class=\"token punctuation\">\"</span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token attr-name\">height</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>0<span class=\"token punctuation\">\"</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token attr-name\">width</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>0<span class=\"token punctuation\">\"</span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token special-attr\"><span class=\"token attr-name\">style</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token value css language-css\"><span class=\"token property\">display</span><span class=\"token punctuation\">:</span>none<span class=\"token punctuation\">;</span><span class=\"token property\">visibility</span><span class=\"token punctuation\">:</span>hidden</span><span class=\"token punctuation\">\"</span></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>iframe</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>noscript</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">&lt;!-- 结束 Google Tag Manager (noscript) --></span></pre></td></tr></table></figure><p>例子如下:</p>\n<figure class=\"highlight html\"><figcaption data-lang=\"HTML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">html</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span> <span class=\"token attr-name\">lang</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>en<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">charset</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>utf-8<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>link</span> <span class=\"token attr-name\">rel</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>icon<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>%PUBLIC_URL%/favicon.ico<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>viewport<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>width=device-width, initial-scale=1<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>theme-color<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>#000000<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>description<span class=\"token punctuation\">\"</span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Web site created using create-react-app<span class=\"token punctuation\">\"</span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>link</span> <span class=\"token attr-name\">rel</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>apple-touch-icon<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>%PUBLIC_URL%/logo192.png<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>link</span> <span class=\"token attr-name\">rel</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>manifest<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>%PUBLIC_URL%/manifest.json<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">></span></span>React App<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token comment\">&lt;!-- Google Tag Manager --></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\"></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">w<span class=\"token punctuation\">,</span> d<span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">,</span> l<span class=\"token punctuation\">,</span> i</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        w<span class=\"token punctuation\">[</span>l<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> w<span class=\"token punctuation\">[</span>l<span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        w<span class=\"token punctuation\">[</span>l<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"gtm.start\"</span><span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> event<span class=\"token operator\">:</span> <span class=\"token string\">\"gtm.js\"</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">var</span> f <span class=\"token operator\">=</span> d<span class=\"token punctuation\">.</span><span class=\"token function\">getElementsByTagName</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          j <span class=\"token operator\">=</span> d<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          dl <span class=\"token operator\">=</span> l <span class=\"token operator\">!=</span> <span class=\"token string\">\"dataLayer\"</span> <span class=\"token operator\">?</span> <span class=\"token string\">\"&amp;l=\"</span> <span class=\"token operator\">+</span> l <span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        j<span class=\"token punctuation\">.</span>async <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        j<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> <span class=\"token string\">\"https://www.googletagmanager.com/gtm.js?id=\"</span> <span class=\"token operator\">+</span> i <span class=\"token operator\">+</span> dl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        f<span class=\"token punctuation\">.</span>parentNode<span class=\"token punctuation\">.</span><span class=\"token function\">insertBefore</span><span class=\"token punctuation\">(</span>j<span class=\"token punctuation\">,</span> f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">,</span> document<span class=\"token punctuation\">,</span> <span class=\"token string\">\"script\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"dataLayer\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"&lt;YOUR GTM ID>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token comment\">&lt;!-- End Google Tag Manager --></span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\">&lt;!-- Google Tag Manager (noscript) --></span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>noscript</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>iframe</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://www.googletagmanager.com/ns.html?id=&lt;YOUR GTM ID><span class=\"token punctuation\">\"</span></span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token attr-name\">height</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>0<span class=\"token punctuation\">\"</span></span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token attr-name\">width</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>0<span class=\"token punctuation\">\"</span></span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token special-attr\"><span class=\"token attr-name\">style</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token value css language-css\"><span class=\"token property\">display</span><span class=\"token punctuation\">:</span>none<span class=\"token punctuation\">;</span><span class=\"token property\">visibility</span><span class=\"token punctuation\">:</span>hidden</span><span class=\"token punctuation\">\"</span></span></span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>iframe</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>noscript</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token comment\">&lt;!-- End Google Tag Manager (noscript) --></span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>noscript</span><span class=\"token punctuation\">></span></span>You need to enable JavaScript to run this app.<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>noscript</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>root<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><p>验证是否成功：<br />\n可以直接在开发者工具 &gt; 网络，搜索是否存在 gtm 相关的数据<br />\n<img data-src=\"https://yeyu-blog.oss-cn-beijing.aliyuncs.com/others/%E6%96%B0%E5%BB%BA%E6%96%87%E4%BB%B6%E5%A4%B9%20%283%29/gtm%E9%85%8D%E7%BD%AE.png\" alt=\"\" /></p>\n<h3 id=\"添加-datalayer-数据事件\"><a class=\"anchor\" href=\"#添加-datalayer-数据事件\">#</a> 添加 dataLayer 数据 / 事件</h3>\n<p>在合适的地点添加类似如下的代码即可</p>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>TagManager<span class=\"token punctuation\">.</span><span class=\"token function\">dataLayer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  dataLayer<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    event<span class=\"token operator\">:</span> <span class=\"token string\">\"your event\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    userActionProps<span class=\"token operator\">:</span> <span class=\"token string\">\"your value\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>验证方法是在控制台输出 dataLayer<br />\n<img data-src=\"https://miro.medium.com/max/1400/0*Z5lmp18jGPRzt3hC.png\" alt=\"事件验证\" /></p>\n<h3 id=\"2-设置-gtm-的变量触发器代码\"><a class=\"anchor\" href=\"#2-设置-gtm-的变量触发器代码\">#</a> 2. 设置  <code>GTM</code>  的变量 / 触发器 / 代码</h3>\n<p>首先设置数据层的变量，该变量应该和 dataLayer 设置时名称是一样的。<br />\n<img data-src=\"https://yeyu-blog.oss-cn-beijing.aliyuncs.com/others/%E6%96%B0%E5%BB%BA%E6%96%87%E4%BB%B6%E5%A4%B9%20%283%29/gtm%E5%8F%98%E9%87%8F%E8%AE%BE%E7%BD%AE.png\" alt=\"\" /></p>\n<p>然后设置触发器</p>\n<p><img data-src=\"https://yeyu-blog.oss-cn-beijing.aliyuncs.com/others/%E6%96%B0%E5%BB%BA%E6%96%87%E4%BB%B6%E5%A4%B9%20%283%29/gtm%E8%A7%A6%E5%8F%91%E5%99%A8%E9%85%8D%E7%BD%AE.png\" alt=\"\" /></p>\n<p>之后设置 tag 和 GA 进行关联，可以选择 GA4 配置和 GA4 事件</p>\n<p><img data-src=\"https://yeyu-blog.oss-cn-beijing.aliyuncs.com/others/%E6%96%B0%E5%BB%BA%E6%96%87%E4%BB%B6%E5%A4%B9%20%283%29/gtm%20GA4%E4%BB%A3%E7%A0%81%E7%B1%BB%E5%9E%8B%E9%85%8D%E7%BD%AE.png\" alt=\"\" /></p>\n<p>输入 id-&gt;GA 数据流的 ID，和触发条件的事件。</p>\n<p><img data-src=\"https://yeyu-blog.oss-cn-beijing.aliyuncs.com/others/%E6%96%B0%E5%BB%BA%E6%96%87%E4%BB%B6%E5%A4%B9%20%283%29/gtm%20GA4%E9%85%8D%E7%BD%AE.png\" alt=\"\" /></p>\n<p>然后配置 GA4 事件，该事件触发时，GA 会接受到事件</p>\n<p><img data-src=\"https://yeyu-blog.oss-cn-beijing.aliyuncs.com/others/%E6%96%B0%E5%BB%BA%E6%96%87%E4%BB%B6%E5%A4%B9%20%283%29/gtm%20GA4%E4%BA%8B%E4%BB%B6%E9%85%8D%E7%BD%AE.png\" alt=\"\" /></p>\n",
            "tags": [
                "javascript",
                "javascript"
            ]
        },
        {
            "id": "http://jluyeyu.com/react/react%E8%87%AA%E5%AE%9A%E4%B9%89hook/",
            "url": "http://jluyeyu.com/react/react%E8%87%AA%E5%AE%9A%E4%B9%89hook/",
            "title": "react自定义hook",
            "date_published": "2022-06-13T12:20:52.000Z",
            "content_html": "<h1 id=\"react自定义hook\"><a class=\"anchor\" href=\"#react自定义hook\">#</a> react 自定义 hook</h1>\n<h3 id=\"1-什么是自定义hook\"><a class=\"anchor\" href=\"#1-什么是自定义hook\">#</a> 1. 什么是自定义 hook</h3>\n<p>自定义 Hook 是一个函数，其名称以 “use” 开头，函数内部可以调用其他的 Hook。</p>\n<p><code>函数名</code> ：以 “use” 开头，比如 useState。为什么要以 “use” 开头。这是因为，如果不以 “use” 开头的话，无法判断这个函数是否包含对其内部 Hook 的调用，React 将无法自动检查这个自定义 Hook 是否违反了 Hook 的规则。</p>\n<p><code>参数</code> ：并没有特殊要求，只是 React 官网中有提到过，可以接收另一个 Hook 的返回值作为参数，实现在多个 Hook 之间传递信息的功能。</p>\n<p><code>函数内部</code> ：在函数内部可以调用其他的 Hook，但是要遵循两个规则：</p>\n<ul>\n<li>\n<p>只在最顶层使用 Hook ，不要在循环，条件或嵌套函数中调用 Hook，这是因为 React 是靠 Hook 调用的顺序来知道哪个 state 对于哪个 useState 的。</p>\n</li>\n<li>\n<p>自定义 hooks 由 React 内置的 hook 或其他的自定义 hook 组成。因此一个自定义 hook 本质是一个或多个 hook 构成的新组合。如果一个自定义 hook 没有使用任何的内部 hook，那它就不是一个自定义 hook，也不应该以 &quot;use&quot; 为前缀。</p>\n</li>\n</ul>\n<h3 id=\"2-使用场景\"><a class=\"anchor\" href=\"#2-使用场景\">#</a> 2. 使用场景</h3>\n<p>让组件的通用逻辑复用更简单，可以把包含状态和事件处理的所有实现细节，移动到这个自定义 hook 中。另外，这个自定义 hook 返回一个数组，包含状态和一些更新状态函数。</p>\n<h3 id=\"3-如何使用\"><a class=\"anchor\" href=\"#3-如何使用\">#</a> 3. 如何使用</h3>\n<p>自定义 hook 是定义在一个 js 或 ts 文件中，最后用 export 导出，故用 import 引入使用：</p>\n<p>React 提供了多个内部 Hook，在自定义 Hook 的内部，一般都是利用内部 Hook，进行组装和扩展，来自定义各种功能的 Hook。<br />\n其中比较常见使用的 hooks 是<br />\n <code>useState</code> , <code>useRef</code> , <code>useEffect/useLayoutEffect</code> 。</p>\n<p>而从一个自定义 hook 中需要返回多个值时最佳的做法是返回一个数组，并利用数组进行解构。</p>\n<h3 id=\"4-案例\"><a class=\"anchor\" href=\"#4-案例\">#</a> 4. 案例</h3>\n<p>实现一个检测 React 组件外部点击事件的 <code>useOutsideClick</code> ，其使用方式大致如下所示</p>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">App</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleClickOutside</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">//dosomething</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">const</span> ref <span class=\"token operator\">=</span> <span class=\"token function\">useOutsideClick</span><span class=\"token punctuation\">(</span>handleClickOutside<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleClick</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">//dosomething</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token operator\">&lt;</span>button ref<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>ref<span class=\"token punctuation\">&#125;</span> type<span class=\"token operator\">=</span><span class=\"token string\">\"button\"</span> onClick<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>handleClick<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        Count<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>count<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>button<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>从上述的使用方式上，可以首先写出如下的代码，输入 <code>callback</code> ，输出一个 <code>ref</code></p>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"><span>t</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">useOutsideClick</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">callback</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">const</span> ref <span class=\"token operator\">=</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token comment\">// 具体代码</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">return</span> ref<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>由于这个 <code>hook</code>  主要是处理点击事件的，所以首先需要添加点击事件，并且在销毁时移除添加的事件，为了能监听所有的点击事件，是在 document 上添加。</p>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"><span>t</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">useOutsideClick</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">callback</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">const</span> ref <span class=\"token operator\">=</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  React<span class=\"token punctuation\">.</span><span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleClick</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    document<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'click'</span><span class=\"token punctuation\">,</span> handleClick<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      document<span class=\"token punctuation\">.</span><span class=\"token function\">removeEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'click'</span><span class=\"token punctuation\">,</span> handleClick<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">return</span> ref<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>目前版本所有点击都会触发 <code>callback</code> ，所以接下来就是过滤掉自身触发的 <code>onclick</code>  事件。</p>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"><span>t</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">useOutsideClick</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">callback</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">const</span> ref <span class=\"token operator\">=</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  React<span class=\"token punctuation\">.</span><span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleClick</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ref<span class=\"token punctuation\">.</span>current <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>ref<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    document<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'click'</span><span class=\"token punctuation\">,</span> handleClick<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      document<span class=\"token punctuation\">.</span><span class=\"token function\">removeEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'click'</span><span class=\"token punctuation\">,</span> handleClick<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>ref<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token keyword\">return</span> ref<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>上述的代码已经满足了要求，但是还有一点可以改进的，就是可能某些场景下，存在一个触发事件的边界，即外部可以通过 <code>stopPropagation</code>  来停止事件的传播。如下所示：</p>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"><span>t</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">App</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleClickOutside</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">//dosomething</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">const</span> ref <span class=\"token operator\">=</span> <span class=\"token function\">useOutsideClick</span><span class=\"token punctuation\">(</span>handleClickOutside<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleClick</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">//dosomething</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleHeaderClick</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">// do something</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    event<span class=\"token punctuation\">.</span><span class=\"token function\">stopPropagation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token operator\">&lt;</span>div onClick<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>handleHeaderClick<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token operator\">&lt;</span>button ref<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>ref<span class=\"token punctuation\">&#125;</span> type<span class=\"token operator\">=</span><span class=\"token string\">\"button\"</span> onClick<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>handleClick<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        Count<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>count<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>button<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>目前的版本并不适用与当前情况，因为事件中途停止冒泡了，所以无法触发在 <code>document</code>  上的 <code>callback</code></p>\n<p>为了实现上述功能，可以将冒泡阶段的事件处理放在捕获阶段进行处理。</p>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"><span>t</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">useOutsideClick</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">callback</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">const</span> ref <span class=\"token operator\">=</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  React<span class=\"token punctuation\">.</span><span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleClick</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ref<span class=\"token punctuation\">.</span>current <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>ref<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    document<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'click'</span><span class=\"token punctuation\">,</span> handleClick<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      document<span class=\"token punctuation\">.</span><span class=\"token function\">removeEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'click'</span><span class=\"token punctuation\">,</span> handleClick<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>ref<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token keyword\">return</span> ref<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"5-参考\"><a class=\"anchor\" href=\"#5-参考\">#</a> 5. 参考</h3>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucm9iaW53aWVydWNoLmRlL3JlYWN0LWhvb2stZGV0ZWN0LWNsaWNrLW91dHNpZGUtY29tcG9uZW50Lw==\">React Hook: Detect click outside of Component</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucm9iaW53aWVydWNoLmRlL3JlYWN0LXVzZWxvY2Fsc3RvcmFnZS1ob29rLw==\">React Hook: Using the Local Storage</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucm9iaW53aWVydWNoLmRlL3JlYWN0LWN1c3RvbS1ob29rLWNoZWNrLWlmLW92ZXJmbG93Lw==\">React Hook: Check if Overflow</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucm9iaW53aWVydWNoLmRlL3JlYWN0LWhvb2stc2Nyb2xsLWRpcmVjdGlvbi8=\">React Hook: Get Scroll Direction</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucm9iaW53aWVydWNoLmRlL3JlYWN0LWhvb2stc2Nyb2xsYmFyLXdpZHRoLw==\">React Hook: Get Scrollbar Width</span></li>\n</ul>\n",
            "tags": [
                "react",
                "react"
            ]
        },
        {
            "id": "http://jluyeyu.com/javascript/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93/",
            "url": "http://jluyeyu.com/javascript/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93/",
            "title": "服务端渲染",
            "date_published": "2022-03-17T09:25:52.000Z",
            "content_html": "<h4 id=\"js中的事件委托\"><a class=\"anchor\" href=\"#js中的事件委托\">#</a> js 中的事件委托</h4>\n<h2 id=\"服务端渲染与客户端渲染\"><a class=\"anchor\" href=\"#服务端渲染与客户端渲染\">#</a> 服务端渲染与客户端渲染</h2>\n<h3 id=\"概念\"><a class=\"anchor\" href=\"#概念\">#</a> 概念：</h3>\n<ol>\n<li><strong>服务端渲染 (SSR):</strong></li>\n</ol>\n<p>​\t在服务器端完成把数据和模板转换成最终的  <code>HTML</code>  文件，然后浏览器接收到这个文件，就可以直接解析展示。</p>\n<ol start=\"2\">\n<li><strong>客户端渲染 (CSR)</strong></li>\n</ol>\n<p>​\t一个网页是由  <code>JS</code>  在客户端渲染出来的，而不是服务器直接返回回来的。</p>\n<h3 id=\"服务端渲染优缺点\"><a class=\"anchor\" href=\"#服务端渲染优缺点\">#</a> 服务端渲染优缺点</h3>\n<h4 id=\"优点\"><a class=\"anchor\" href=\"#优点\">#</a> 优点：</h4>\n<ul>\n<li>不占用前端的资源，前端耗时少，尤其是移动端，也可以更省电。</li>\n<li>有利于 SEO。因为在后端有完整的 html 页面，所以爬虫更容易爬取获得信息</li>\n<li>使用服务器页面缓存，这样就可以减少数据库查询浪费的时间了，且对于数据变化不大的页面非常高效 。</li>\n</ul>\n<h4 id=\"缺点\"><a class=\"anchor\" href=\"#缺点\">#</a> 缺点：</h4>\n<ul>\n<li>不利于前后端分离，开发效率低。</li>\n<li>占用服务器端资源，对 html 的解析，对前端来说加快了速度，但是加大了服务器的压力。</li>\n</ul>\n<h3 id=\"客户端渲染优缺点\"><a class=\"anchor\" href=\"#客户端渲染优缺点\">#</a> 客户端渲染优缺点</h3>\n<h4 id=\"优点-2\"><a class=\"anchor\" href=\"#优点-2\">#</a> 优点：</h4>\n<ul>\n<li>不占用前端的资源，前端耗时少，尤其是移动端，也可以更省电。</li>\n<li>有利于 SEO。因为在后端有完整的 html 页面，所以爬虫更容易爬取获得信息</li>\n<li>使用服务器页面缓存，这样就可以减少数据库查询浪费的时间了，且对于数据变化不大的页面非常高效 。</li>\n</ul>\n<h4 id=\"缺点-2\"><a class=\"anchor\" href=\"#缺点-2\">#</a> 缺点：</h4>\n<ul>\n<li>前后端分离，开发效率高。</li>\n<li>用户体验更好，网站做成 SPA（单页面应用）或者部分内容做成 SPA，当用户点击时，不会形成频繁的跳转。</li>\n</ul>\n",
            "tags": [
                "javascript",
                "javascript"
            ]
        },
        {
            "id": "http://jluyeyu.com/javascript/%E4%BA%8B%E4%BB%B6%E5%A7%94%E6%89%98/",
            "url": "http://jluyeyu.com/javascript/%E4%BA%8B%E4%BB%B6%E5%A7%94%E6%89%98/",
            "title": "事件委托",
            "date_published": "2022-03-13T09:25:52.000Z",
            "content_html": "<h4 id=\"js中的事件委托\"><a class=\"anchor\" href=\"#js中的事件委托\">#</a> js 中的事件委托</h4>\n<p>​\t那什么叫事件委托呢？它还有一个名字叫事件代理， <code>JavaScript</code>  高级程序设计上讲：事件委托就是利用事件冒泡，只指定一个事件处理程序，就可以管理某一类型的所有事件。那这是什么意思呢？网上的各位大牛们讲事件委托基本上都用了同一个例子，就是取快递来解释这个现象，我仔细揣摩了一下，这个例子还真是恰当，我就不去想别的例子来解释了，借花献佛，我摘过来，大家认真领会一下事件委托到底是一个什么原理：</p>\n<p>​\t有三个同事预计会在周一收到快递。为签收快递，有两种办法：一是三个人在公司门口等快递；二是委托给前台 MM 代为签收。现实当中，我们大都采用委托的方案（公司也不会容忍那么多员工站在门口就为了等快递）。前台收到快递后，她会判断收件人是谁，然后按照收件人的要求签收，甚至代为付款。这种方案还有一个优势，那就是即使公司里来了新员工（不管多少），前台也会在收到寄给新员工的快递后核实并代为签收。</p>\n<p>​\t这里其实还有 2 层意思的：</p>\n<ul>\n<li>\n<p>第一，现在委托前台的同事是可以代为签收的，即程序中的现有的 <code>dom</code>  节点是有事件的；</p>\n</li>\n<li>\n<p>第二，新员工也是可以被前台代为签收的，即程序中新添加的 <code>dom</code>  节点也是有事件的。</p>\n</li>\n</ul>\n<h4 id=\"为什么要用事件委托\"><a class=\"anchor\" href=\"#为什么要用事件委托\">#</a> 为什么要用事件委托：</h4>\n<p>一般来说， <code>dom</code>  需要有事件处理程序，我们都会直接给它设事件处理程序就好了，那如果是很多的 <code>dom</code>  需要添加事件处理呢？比如我们有 100 个 <code>li</code> ，每个 <code>li</code>  都有相同的 <code>click</code>  点击事件，可能我们会用 <code>for</code>  循环的方法，来遍历所有的 <code>li</code> ，然后给它们添加事件，那这么做会存在什么影响呢？</p>\n<p>在 JavaScript 中，添加到页面上的事件处理程序数量将直接关系到页面的整体运行性能，因为需要不断的与 <code>dom</code>  节点进行交互，访问 <code>dom</code>  的次数越多，引起浏览器重绘与重排的次数也就越多，就会延长整个页面的交互就绪时间，这就是为什么性能优化的主要思想之一就是减少 <code>dom</code>  操作的原因；如果要用事件委托，就会将所有的操作放到 <code>js</code>  程序里面，与 <code>dom</code>  的操作就只需要交互一次，这样就能大大的减少与 <code>dom</code>  的交互次数，提高性能；</p>\n<p>每个函数都是一个对象，是对象就会占用内存，对象越多，内存占用率就越大，自然性能就越差了（内存不够用，是硬伤，哈哈），比如上面的 100 个 <code>li</code> ，就要占用 100 个内存空间，如果是 1000 个，10000 个呢，那只能说呵呵了，如果用事件委托，那么我们就可以只对它的父级（如果只有一个父级）这一个对象进行操作，这样我们就需要一个内存空间就够了，是不是省了很多，自然性能就会更好。</p>\n<h4 id=\"事件委托的原理\"><a class=\"anchor\" href=\"#事件委托的原理\">#</a> 事件委托的原理：</h4>\n<p>事件委托是利用事件的冒泡原理来实现的，何为事件冒泡呢？就是事件从最深的节点开始，然后逐步向上传播事件，举个例子：页面上有这么一个节点树， <code>div&gt;ul&gt;li&gt;a</code> ; 比如给最里面的 <code>a</code>  加一个 <code>click</code>  点击事件，那么这个事件就会一层一层的往外执行，执行顺序 <code>a&gt;li&gt;ul&gt;div</code> ，有这样一个机制，那么我们给最外面的 <code>div</code>  加点击事件，那么里面的 <code>ul，li，a</code>  做点击事件的时候，都会冒泡到最外层的 <code>div</code>  上，所以都会触发，这就是事件委托，委托它们父级代为执行事件。</p>\n<h4 id=\"事件委托怎么实现\"><a class=\"anchor\" href=\"#事件委托怎么实现\">#</a> 事件委托怎么实现：</h4>\n<p>终于到了本文的核心部分了，哈哈，在介绍事件委托的方法之前，我们先来看一段一般方法的例子：</p>\n<p>子节点实现相同的功能：</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">&lt;</span>ul id<span class=\"token operator\">=</span><span class=\"token string\">\"ul1\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token operator\">&lt;</span>li<span class=\"token operator\">></span><span class=\"token number\">111</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>li<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token operator\">&lt;</span>li<span class=\"token operator\">></span><span class=\"token number\">222</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>li<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token operator\">&lt;</span>li<span class=\"token operator\">></span><span class=\"token number\">333</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>li<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token operator\">&lt;</span>li<span class=\"token operator\">></span><span class=\"token number\">444</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>li<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>ul<span class=\"token operator\">></span></pre></td></tr></table></figure><p>实现功能是点击 <code>li</code> ，弹出 123：</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>window<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">var</span> oUl <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ul1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">var</span> aLi <span class=\"token operator\">=</span> oUl<span class=\"token punctuation\">.</span><span class=\"token function\">getElementsByTagName</span><span class=\"token punctuation\">(</span><span class=\"token string\">'li'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;</span>aLi<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        aLi<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onclick</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token number\">123</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>上面的代码的意思很简单，相信很多人都是这么实现的，我们看看有多少次的 <code>dom</code>  操作，首先要找到 <code>ul</code> ，然后遍历 <code>li</code> ，然后点击 <code>li</code>  的时候，又要找一次目标的 <code>li</code>  的位置，才能执行最后的操作，每次点击都要找一次 <code>li</code> ；</p>\n<p>那么我们用事件委托的方式做又会怎么样呢？</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>window<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">var</span> oUl <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ul1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   oUl<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onclick</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token number\">123</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这里用父级 ul 做事件处理，当 li 被点击时，由于冒泡原理，事件就会冒泡到 ul 上，因为 ul 上有点击事件，所以事件就会触发，当然，这里当点击 ul 的时候，也是会触发的，那么问题就来了，如果我想让事件代理的效果跟直接给节点的事件效果一样怎么办，比如说只有点击 li 才会触发，不怕，我们有绝招：</p>\n<p><code>Event</code>  对象提供了一个属性叫 <code>target</code> ，可以返回事件的目标节点，我们成为事件源，也就是说， <code>target</code>  就可以表示为当前的事件操作的 <code>dom</code> ，但是不是真正操作 <code>dom</code> ，当然，这个是有兼容性的，标准浏览器用 ev.target，IE 浏览器用 event.srcElement，此时只是获取了当前节点的位置，并不知道是什么节点名称，这里我们用 <code>nodeName</code>  来获取具体是什么标签名，这个返回的是一个大写的，我们需要转成小写再做比较（习惯问题）：</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>window<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>　　<span class=\"token keyword\">var</span> oUl <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ul1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>　　oUl<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onclick</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ev</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>　　　　<span class=\"token keyword\">var</span> ev <span class=\"token operator\">=</span> ev <span class=\"token operator\">||</span> window<span class=\"token punctuation\">.</span>event<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>　　　　<span class=\"token keyword\">var</span> target <span class=\"token operator\">=</span> ev<span class=\"token punctuation\">.</span>target <span class=\"token operator\">||</span> ev<span class=\"token punctuation\">.</span>srcElement<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>　　　　<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">.</span>nodeName<span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token string\">'li'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>　 　　　　　　 <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token number\">123</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>　　　　　　　  <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">.</span>innerHTML<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>　　　　<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>　　<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这样改下就只有点击 <code>li</code>  会触发事件了，且每次只执行一次 <code>dom</code>  操作，如果 <code>li</code>  数量很多的话，将大大减少 <code>dom</code>  的操作，优化的性能可想而知！</p>\n<p>上面的例子是说 <code>li</code>  操作的是同样的效果，要是每个 <code>li</code>  被点击的效果都不一样，那么用事件委托还有用吗？</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">&lt;</span>div id<span class=\"token operator\">=</span><span class=\"token string\">\"box\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        <span class=\"token operator\">&lt;</span>input type<span class=\"token operator\">=</span><span class=\"token string\">\"button\"</span> id<span class=\"token operator\">=</span><span class=\"token string\">\"add\"</span> value<span class=\"token operator\">=</span><span class=\"token string\">\"添加\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token operator\">&lt;</span>input type<span class=\"token operator\">=</span><span class=\"token string\">\"button\"</span> id<span class=\"token operator\">=</span><span class=\"token string\">\"remove\"</span> value<span class=\"token operator\">=</span><span class=\"token string\">\"删除\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token operator\">&lt;</span>input type<span class=\"token operator\">=</span><span class=\"token string\">\"button\"</span> id<span class=\"token operator\">=</span><span class=\"token string\">\"move\"</span> value<span class=\"token operator\">=</span><span class=\"token string\">\"移动\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token operator\">&lt;</span>input type<span class=\"token operator\">=</span><span class=\"token string\">\"button\"</span> id<span class=\"token operator\">=</span><span class=\"token string\">\"select\"</span> value<span class=\"token operator\">=</span><span class=\"token string\">\"选择\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span></pre></td></tr></table></figure><figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>window<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>            <span class=\"token keyword\">var</span> Add <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"add\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            <span class=\"token keyword\">var</span> Remove <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"remove\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token keyword\">var</span> Move <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"move\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token keyword\">var</span> Select <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"select\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            Add<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onclick</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'添加'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            Remove<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onclick</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'删除'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            Move<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onclick</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'移动'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            Select<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onclick</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'选择'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>上面实现的效果我就不多说了，很简单，4 个按钮，点击每一个做不同的操作，那么至少需要 4 次 <code>dom</code>  操作，如果用事件委托，能进行优化吗？</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>window<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>            <span class=\"token keyword\">var</span> oBox <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"box\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            oBox<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onclick</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ev</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                <span class=\"token keyword\">var</span> ev <span class=\"token operator\">=</span> ev <span class=\"token operator\">||</span> window<span class=\"token punctuation\">.</span>event<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                <span class=\"token keyword\">var</span> target <span class=\"token operator\">=</span> ev<span class=\"token punctuation\">.</span>target <span class=\"token operator\">||</span> ev<span class=\"token punctuation\">.</span>srcElement<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">.</span>nodeName<span class=\"token punctuation\">.</span><span class=\"token function\">toLocaleLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token string\">'input'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                    <span class=\"token keyword\">switch</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                        <span class=\"token keyword\">case</span> <span class=\"token string\">'add'</span> <span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                            <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'添加'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                        <span class=\"token keyword\">case</span> <span class=\"token string\">'remove'</span> <span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                            <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'删除'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                        <span class=\"token keyword\">case</span> <span class=\"token string\">'move'</span> <span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                            <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'移动'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                        <span class=\"token keyword\">case</span> <span class=\"token string\">'select'</span> <span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                            <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'选择'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            </pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>用事件委托就可以只用一次 <code>dom</code>  操作就能完成所有的效果，比上面的性能肯定是要好一些的</p>\n<p>现在讲的都是 <code>document</code>  加载完成的现有 <code>dom</code>  节点下的操作，那么如果是新增的节点，新增的节点会有事件吗？也就是说，一个新员工来了，他能收到快递吗？</p>\n<p>看一下正常的添加节点的方法：</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">&lt;</span>input type<span class=\"token operator\">=</span><span class=\"token string\">\"button\"</span> name<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span> id<span class=\"token operator\">=</span><span class=\"token string\">\"btn\"</span> value<span class=\"token operator\">=</span><span class=\"token string\">\"添加\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token operator\">&lt;</span>ul id<span class=\"token operator\">=</span><span class=\"token string\">\"ul1\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token operator\">&lt;</span>li<span class=\"token operator\">></span><span class=\"token number\">111</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>li<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token operator\">&lt;</span>li<span class=\"token operator\">></span><span class=\"token number\">222</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>li<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token operator\">&lt;</span>li<span class=\"token operator\">></span><span class=\"token number\">333</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>li<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token operator\">&lt;</span>li<span class=\"token operator\">></span><span class=\"token number\">444</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>li<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>ul<span class=\"token operator\">></span></pre></td></tr></table></figure><p>现在是移入 <code>li</code> ， <code>li</code>  变红，移出 <code>li</code> ， <code>li</code>  变白，这么一个效果，然后点击按钮，可以向 <code>ul</code>  中添加一个 <code>li</code>  子节点</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>window<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>            <span class=\"token keyword\">var</span> oBtn <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"btn\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            <span class=\"token keyword\">var</span> oUl <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ul1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token keyword\">var</span> aLi <span class=\"token operator\">=</span> oUl<span class=\"token punctuation\">.</span><span class=\"token function\">getElementsByTagName</span><span class=\"token punctuation\">(</span><span class=\"token string\">'li'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token keyword\">var</span> num <span class=\"token operator\">=</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token comment\">// 鼠标移入变红，移出变白</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">&lt;</span>aLi<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                aLi<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onmouseover</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>background <span class=\"token operator\">=</span> <span class=\"token string\">'red'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                aLi<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onmouseout</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>background <span class=\"token operator\">=</span> <span class=\"token string\">'#fff'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token comment\">// 添加新节点</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            oBtn<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onclick</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                num<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token keyword\">var</span> oLi <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'li'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                oLi<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> <span class=\"token number\">111</span><span class=\"token operator\">*</span>num<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                oUl<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>oLi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这是一般的做法，但是你会发现，新增的 <code>li</code>  是没有事件的，说明添加子节点的时候，事件没有一起添加进去，这不是我们想要的结果，那怎么做呢？一般的解决方案会是这样，将 for 循环用一个函数包起来，命名为 <code>mHover</code> ，如下：</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>window<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>            <span class=\"token keyword\">var</span> oBtn <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"btn\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            <span class=\"token keyword\">var</span> oUl <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ul1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token keyword\">var</span> aLi <span class=\"token operator\">=</span> oUl<span class=\"token punctuation\">.</span><span class=\"token function\">getElementsByTagName</span><span class=\"token punctuation\">(</span><span class=\"token string\">'li'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token keyword\">var</span> num <span class=\"token operator\">=</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token keyword\">function</span> <span class=\"token function\">mHover</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                <span class=\"token comment\">// 鼠标移入变红，移出变白</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">&lt;</span>aLi<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                    aLi<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onmouseover</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>background <span class=\"token operator\">=</span> <span class=\"token string\">'red'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                    aLi<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onmouseout</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>background <span class=\"token operator\">=</span> <span class=\"token string\">'#fff'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token function\">mHover</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token comment\">// 添加新节点</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            oBtn<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onclick</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                num<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                <span class=\"token keyword\">var</span> oLi <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'li'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                oLi<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> <span class=\"token number\">111</span><span class=\"token operator\">*</span>num<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                oUl<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>oLi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token function\">mHover</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>虽然功能实现了，看着还挺好，但实际上无疑是又增加了一个 <code>dom</code>  操作，在优化性能方面是不可取的，那么有事件委托的方式，能做到优化吗？</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>window<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>            <span class=\"token keyword\">var</span> oBtn <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"btn\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            <span class=\"token keyword\">var</span> oUl <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ul1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token keyword\">var</span> aLi <span class=\"token operator\">=</span> oUl<span class=\"token punctuation\">.</span><span class=\"token function\">getElementsByTagName</span><span class=\"token punctuation\">(</span><span class=\"token string\">'li'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token keyword\">var</span> num <span class=\"token operator\">=</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token comment\">// 事件委托，添加的子元素也有事件</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            oUl<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onmouseover</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ev</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                <span class=\"token keyword\">var</span> ev <span class=\"token operator\">=</span> ev <span class=\"token operator\">||</span> window<span class=\"token punctuation\">.</span>event<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                <span class=\"token keyword\">var</span> target <span class=\"token operator\">=</span> ev<span class=\"token punctuation\">.</span>target <span class=\"token operator\">||</span> ev<span class=\"token punctuation\">.</span>srcElement<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">.</span>nodeName<span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token string\">'li'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                    target<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>background <span class=\"token operator\">=</span> <span class=\"token string\">\"red\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            oUl<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onmouseout</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ev</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                <span class=\"token keyword\">var</span> ev <span class=\"token operator\">=</span> ev <span class=\"token operator\">||</span> window<span class=\"token punctuation\">.</span>event<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token keyword\">var</span> target <span class=\"token operator\">=</span> ev<span class=\"token punctuation\">.</span>target <span class=\"token operator\">||</span> ev<span class=\"token punctuation\">.</span>srcElement<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">.</span>nodeName<span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token string\">'li'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                    target<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>background <span class=\"token operator\">=</span> <span class=\"token string\">\"#fff\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            </pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token comment\">// 添加新节点</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            oBtn<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onclick</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                num<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                <span class=\"token keyword\">var</span> oLi <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'li'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                oLi<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> <span class=\"token number\">111</span><span class=\"token operator\">*</span>num<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                oUl<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>oLi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>看，上面是用事件委托的方式，新添加的子元素是带有事件效果的，我们可以发现，当用事件委托的时候，根本就不需要去遍历元素的子节点，只需要给父级元素添加事件就好了，其他的都是在 <code>js</code>  里面的执行，这样可以大大的减少 <code>dom</code>  操作，这才是事件委托的精髓所在。</p>\n",
            "tags": [
                "javascript",
                "javascript"
            ]
        }
    ]
}